<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Notify</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@700&display=swap" rel="stylesheet">
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-poppins { font-family: 'Poppins', sans-serif; }
        @media (max-width: 768px) {
            #sidebar {
                transition: transform 0.3s ease-in-out;
            }
        }
        .sidebar-item {
            transition: background-color 0.2s, color 0.2s;
        }
        .sidebar-item.active {
            background-color: #eff6ff; /* blue-50 */
            color: #2563eb; /* blue-600 */
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 antialiased">

    <!-- Loading Spinner -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
    </div>

    <div class="min-h-screen flex">
        <!-- Sidebar -->
        <aside id="sidebar" class="bg-white w-64 flex-shrink-0 border-r border-gray-200 flex flex-col fixed inset-y-0 left-0 z-30 md:relative md:translate-x-0 transform -translate-x-full">
            <!-- Logo -->
            <div class="flex items-center justify-center h-16 border-b">
                <a href="index.html" class="flex items-center space-x-3">
                    <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                    <h1 class="text-xl font-bold text-gray-800">Notify</h1>
                </a>
            </div>
            <!-- Class List -->
            <nav id="class-list" class="flex-1 p-4 space-y-1 overflow-y-auto">
                <h2 class="px-2 mb-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">My Classes</h2>
                <p id="no-classes-sidebar" class="px-2 text-sm text-gray-500">You haven't joined any classes yet.</p>
            </nav>
            <!-- User Info & Logout -->
            <div class="p-4 border-t mt-auto">
                <div id="user-info" class="text-sm">
                    <p class="font-semibold text-gray-800 truncate" id="user-display-name">Loading...</p>
                    <p class="text-gray-500 truncate" id="user-email">...</p>
                </div>
                <button id="logout-btn" class="w-full mt-4 text-left font-poppins bg-gray-100 text-gray-700 font-bold py-2 px-4 rounded-lg border border-gray-200 hover:bg-gray-200 transition-colors duration-150">
                    Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col">
            <!-- Top Bar for Mobile -->
            <header class="bg-white border-b border-gray-200 shadow-sm flex items-center justify-between p-4 md:hidden">
                <button id="menu-toggle" class="text-gray-600 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
                 <a href="index.html" class="flex items-center space-x-3">
                    <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                    <h1 class="text-xl font-bold text-gray-800">Notify</h1>
                </a>
                <button id="logout-btn-mobile" class="font-poppins bg-gray-100 text-gray-700 font-bold py-1 px-3 rounded-lg border border-gray-200 hover:bg-gray-200 text-sm">
                    Logout
                </button>
            </header>

            <div class="p-4 sm:p-6 lg:p-8 flex-1">
                <!-- Invitations Section -->
                <div id="invitations-container" class="hidden space-y-3 mb-6"></div>

                <!-- Teacher: No classes view -->
                <div id="teacher-no-class-view" class="hidden text-center bg-white p-12 rounded-lg shadow">
                    <h2 class="text-2xl font-bold text-gray-800">Welcome to your Dashboard!</h2>
                    <p class="mt-2 text-gray-600">Create your first class to get started.</p>
                    <div class="mt-6 flex flex-col sm:flex-row justify-center items-center gap-4">
                        <button id="create-class-btn" class="w-full sm:w-auto flex items-center justify-center gap-2 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors duration-150">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            Create a Class
                        </button>
                        <button id="import-gclass-btn" class="w-full sm:w-auto flex items-center justify-center gap-2 bg-white text-gray-700 font-bold py-3 px-6 rounded-lg border hover:bg-gray-50 transition-colors duration-150">
                            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="#4285f4" d="M32 448h448V64H32v384z"/><path fill="#fff" d="M336 261.7v-35.4h-29.4v-29.4h-35.3v29.4h-29.4v35.4h29.4v29.3h35.3v-29.3z"/><path fill="#1e8e3e" d="M194.2 320h123.5v-29.4H194.2z"/><path fill="#fcc934" d="M256 192.4a35.3 35.3 0 100-70.6 35.3 35.3 0 000 70.6z"/></svg>
                            Import from Google Classroom
                        </button>
                    </div>
                </div>

                <!-- Student: No classes view -->
                <div id="student-no-class-view" class="hidden text-center bg-white p-12 rounded-lg shadow">
                    <h2 class="text-2xl font-bold text-gray-800">Welcome, Student!</h2>
                    <p class="mt-2 text-gray-600">Join your first class using a code from your teacher.</p>
                    <div class="mt-6">
                        <button id="join-class-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-colors duration-150">Join a Class</button>
                    </div>
                </div>

                <!-- Main dashboard view when a class is selected -->
                <div id="class-dashboard-view" class="hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4">
                        <h2 id="class-view-name" class="text-3xl font-bold text-gray-900"></h2>
                        <div id="teacher-join-code-container" class="hidden mt-4 md:mt-0 flex items-center gap-2 bg-white p-2 rounded-lg border">
                            <span class="text-sm text-gray-500">Join Code:</span>
                            <span id="class-join-code" class="font-mono font-bold text-lg text-gray-800 tracking-widest"></span>
                            <button id="refresh-code-btn" title="Refresh code (once per day)" class="text-gray-400 hover:text-blue-600 disabled:text-gray-300 disabled:cursor-not-allowed">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M20 4s-1-1-3-1-4 2-4 2-1-3-4-3-4 2-4 2"></path></svg>
                            </button>
                        </div>
                    </div>
                    <div id="class-content-area" class="bg-white p-6 rounded-lg shadow">
                        <p class="text-gray-500">This is where the main class interaction will happen.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="create-class-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-40 hidden"><div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md"><h3 class="text-2xl font-bold mb-4">Create New Class</h3><form id="create-class-form"><label for="class-name-input" class="block text-sm font-medium text-gray-700">Class Name</label><input type="text" id="class-name-input" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"><div class="mt-6 flex justify-end space-x-3"><button type="button" class="cancel-modal-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button><button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Create</button></div></form></div></div>
    <div id="join-class-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-40 hidden"><div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md"><h3 class="text-2xl font-bold mb-4">Join a Class</h3><form id="join-class-form"><label for="join-code-input" class="block text-sm font-medium text-gray-700">Enter 8-Digit Code</label><input type="text" id="join-code-input" required maxlength="8" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 font-mono tracking-widest text-center text-lg"><p id="join-error-msg" class="text-red-500 text-sm mt-2 hidden"></p><div class="mt-6 flex justify-end space-x-3"><button type="button" class="cancel-modal-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button><button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Join</button></div></form></div></div>
    <div id="import-gclass-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-40 hidden"><div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg"><h3 class="text-2xl font-bold mb-4">Import from Google Classroom</h3><div id="gclass-courses-list" class="max-h-96 overflow-y-auto space-y-2"></div><div class="mt-6 flex justify-end"><button type="button" class="cancel-modal-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button></div></div></div>
    <div id="post-invite-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-40 hidden"><div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg"><h3 class="text-2xl font-bold mb-4">Post Invite to Google Classroom</h3><form id="post-invite-form"><label for="post-title-input" class="block text-sm font-medium text-gray-700">Title</label><input type="text" id="post-title-input" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"><label for="post-description-input" class="block text-sm font-medium text-gray-700 mt-4">Description</label><textarea id="post-description-input" rows="4" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea><div class="mt-6 flex justify-end space-x-3"><button type="button" class="cancel-modal-btn bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Skip</button><button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Post to Classroom</button></div></form></div></div>
    <div id="alert-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden"><div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm text-center"><p id="alert-message" class="text-lg"></p><button id="alert-ok-btn" class="mt-6 bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">OK</button></div></div>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Firebase and App State
            let auth, db, user, userData;
            let currentClassId = null;
            let gapiInitialized = false;
            let googleUser = null;

            // DOM Elements
            const loadingOverlay = document.getElementById('loading-overlay');
            const sidebar = document.getElementById('sidebar');
            const menuToggle = document.getElementById('menu-toggle');
            
            // Views
            const teacherNoClassView = document.getElementById('teacher-no-class-view');
            const studentNoClassView = document.getElementById('student-no-class-view');
            const classDashboardView = document.getElementById('class-dashboard-view');
            const invitationsContainer = document.getElementById('invitations-container');

            // Modals
            const createClassModal = document.getElementById('create-class-modal');
            const joinClassModal = document.getElementById('join-class-modal');
            const importGClassModal = document.getElementById('import-gclass-modal');
            const postInviteModal = document.getElementById('post-invite-modal');
            const alertModal = document.getElementById('alert-modal');
            
            // --- INITIALIZATION ---
            function initializeApp() {
                if (typeof firebase === 'undefined' || typeof firebaseConfig === 'undefined') {
                    console.error("Firebase config is missing.");
                    showAlert("Error: Cannot connect to services.");
                    return;
                }
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();

                auth.onAuthStateChanged(handleAuthStateChanged);
            }

            async function handleAuthStateChanged(firebaseUser) {
                if (firebaseUser) {
                    user = firebaseUser;
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (!userDoc.exists) {
                        console.error("User document not found. Redirecting to login.");
                        window.location.href = 'login.html';
                        return;
                    }
                    userData = { id: user.uid, ...userDoc.data() };
                    
                    setupDashboard();
                } else {
                    console.log("No user logged in. Redirecting...");
                    window.location.href = 'login.html';
                }
            }
            
            async function setupDashboard() {
                updateUserInfoUI();
                setupEventListeners();
                fetchAndDisplayClasses();
                // Potentially fetch and display invitations for students
                loadingOverlay.classList.add('hidden');
            }

            // --- UI RENDERING ---
            function updateUserInfoUI() {
                document.getElementById('user-display-name').textContent = userData.username;
                document.getElementById('user-email').textContent = user.email;
            }

            function fetchAndDisplayClasses() {
                const query = userData.role === 'teacher' 
                    ? db.collection('classes').where('teacherId', '==', user.uid)
                    : db.collection('classes').where('students', 'array-contains', user.uid);
                
                query.onSnapshot(snapshot => {
                    const classListNav = document.getElementById('class-list');
                    // Clear existing but preserve header
                    while(classListNav.children.length > 1) {
                        if(classListNav.lastChild.id !== 'no-classes-sidebar') {
                             classListNav.removeChild(classListNav.lastChild);
                        } else {
                            break;
                        }
                    }

                    document.getElementById('no-classes-sidebar').classList.toggle('hidden', !snapshot.empty);
                    
                    if(snapshot.empty) {
                        showInitialView();
                    } else {
                        snapshot.docs.forEach((doc, index) => {
                            const classData = { id: doc.id, ...doc.data() };
                            const classItem = createClassSidebarItem(classData);
                            classListNav.appendChild(classItem);
                            if(index === 0 && !currentClassId) {
                                selectClass(classData.id);
                            }
                        });
                    }
                });
            }

            function createClassSidebarItem(classData) {
                const item = document.createElement('a');
                item.href = '#';
                item.textContent = classData.name;
                item.dataset.classId = classData.id;
                item.className = 'sidebar-item block px-2 py-2 text-sm text-gray-700 rounded-md hover:bg-gray-100';
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    selectClass(classData.id);
                });
                return item;
            }

            function showInitialView() {
                classDashboardView.classList.add('hidden');
                teacherNoClassView.classList.toggle('hidden', userData.role !== 'teacher');
                studentNoClassView.classList.toggle('hidden', userData.role !== 'student');
            }

            async function selectClass(classId) {
                currentClassId = classId;
                // Highlight in sidebar
                document.querySelectorAll('.sidebar-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.classId === classId);
                });

                const classDoc = await db.collection('classes').doc(classId).get();
                if (!classDoc.exists) return;
                const classData = classDoc.data();

                // Update main view
                document.getElementById('class-view-name').textContent = classData.name;
                
                if (userData.role === 'teacher') {
                    const codeContainer = document.getElementById('teacher-join-code-container');
                    codeContainer.classList.remove('hidden');
                    document.getElementById('class-join-code').textContent = classData.joinCode || 'N/A';
                    // Add logic for refreshing code if needed
                }

                teacherNoClassView.classList.add('hidden');
                studentNoClassView.classList.add('hidden');
                classDashboardView.classList.remove('hidden');
            }

            // --- EVENT LISTENERS ---
            function setupEventListeners() {
                // Modals
                document.querySelectorAll('.cancel-modal-btn').forEach(btn => btn.addEventListener('click', closeAllModals));
                document.getElementById('create-class-btn')?.addEventListener('click', () => createClassModal.classList.remove('hidden'));
                document.getElementById('join-class-btn')?.addEventListener('click', () => joinClassModal.classList.remove('hidden'));
                document.getElementById('import-gclass-btn')?.addEventListener('click', handleGoogleImportClick);
                document.getElementById('alert-ok-btn').addEventListener('click', () => alertModal.classList.add('hidden'));

                // Forms
                document.getElementById('create-class-form').addEventListener('submit', handleCreateClass);
                
                // Sidebar & Logout
                menuToggle.addEventListener('click', () => sidebar.classList.toggle('-translate-x-full'));
                document.getElementById('logout-btn').addEventListener('click', signOut);
                document.getElementById('logout-btn-mobile').addEventListener('click', signOut);
            }

            // --- CORE FUNCTIONALITY ---
            function signOut() {
                auth.signOut().catch(err => console.error("Logout error", err));
            }
            
            async function handleCreateClass(e) {
                e.preventDefault();
                const className = document.getElementById('class-name-input').value.trim();
                if(!className) return;

                const newClass = {
                    name: className,
                    teacherId: user.uid,
                    students: [],
                    joinCode: generateJoinCode(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                    await db.collection('classes').add(newClass);
                    closeAllModals();
                    document.getElementById('create-class-form').reset();
                } catch (error) {
                    console.error("Error creating class: ", error);
                    showAlert("Failed to create class.");
                }
            }

            function generateJoinCode() {
                return Math.random().toString(36).substring(2, 10).toUpperCase();
            }

            function showAlert(message) {
                document.getElementById('alert-message').textContent = message;
                alertModal.classList.remove('hidden');
            }
            
            function closeAllModals() {
                document.querySelectorAll('.fixed.inset-0').forEach(modal => modal.classList.add('hidden'));
                loadingOverlay.classList.add('hidden'); // Also hide loading
            }
            
            // --- GOOGLE CLASSROOM INTEGRATION ---
            async function handleGoogleImportClick() {
                loadingOverlay.classList.remove('hidden');
                if (!gapiInitialized) {
                    try {
                        const secretsDoc = await db.collection('secrets').doc('wUTBTbjuNLueOfhgHXEE').get();
                        if (!secretsDoc.exists) throw new Error("API Key not found");
                        const apiKey = secretsDoc.data().GoogleClassroomAPIKey;
                        const CLIENT_ID = "YOUR_OAUTH_CLIENT_ID.apps.googleusercontent.com"; // REPLACE THIS
                        const SCOPES = 'https://www.googleapis.com/auth/classroom.courses.readonly https://www.googleapis.com/auth/classroom.announcements';
                        
                        await new Promise((resolve, reject) => gapi.load('client:auth2', resolve, reject));
                        await gapi.client.init({ apiKey, clientId: CLIENT_ID, scope: SCOPES, discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/classroom/v1/rest"] });
                        gapiInitialized = true;
                    } catch(err) {
                        console.error("GAPI Init Error:", err);
                        showAlert("Could not connect to Google Classroom.");
                        loadingOverlay.classList.add('hidden');
                        return;
                    }
                }
                
                const googleAuth = gapi.auth2.getAuthInstance();
                if (!googleAuth.isSignedIn.get()) {
                    googleUser = await googleAuth.signIn();
                } else {
                    googleUser = googleAuth.currentUser.get();
                }

                listGoogleCourses();
            }

            async function listGoogleCourses() {
                try {
                    const response = await gapi.client.classroom.courses.list({ teacherId: 'me', courseStates: 'ACTIVE' });
                    const courses = response.result.courses || [];
                    const listContainer = document.getElementById('gclass-courses-list');
                    listContainer.innerHTML = ''; // Clear previous list

                    if (courses.length === 0) {
                        listContainer.innerHTML = '<p class="text-gray-500">No active Google Classroom courses found.</p>';
                    } else {
                        courses.forEach(course => {
                            const courseDiv = document.createElement('div');
                            courseDiv.className = 'p-3 border rounded-md flex justify-between items-center';
                            courseDiv.innerHTML = `<span class="font-semibold">${course.name}</span>`;
                            const importBtn = document.createElement('button');
                            importBtn.textContent = 'Import';
                            importBtn.className = 'bg-blue-500 text-white py-1 px-3 rounded-md text-sm hover:bg-blue-600';
                            importBtn.onclick = () => handleImportAndPost(course);
                            courseDiv.appendChild(importBtn);
                            listContainer.appendChild(courseDiv);
                        });
                    }
                    loadingOverlay.classList.add('hidden');
                    importGClassModal.classList.remove('hidden');
                } catch(err) {
                    console.error("Error listing courses:", err);
                    showAlert("Failed to load your Google Classroom courses.");
                    loadingOverlay.classList.add('hidden');
                }
            }

            async function handleImportAndPost(gclassCourse) {
                // This is a simplified import. A real one would handle students, etc.
                const className = gclassCourse.name;
                const newNotifyClass = {
                    name: className,
                    teacherId: user.uid,
                    students: [],
                    joinCode: generateJoinCode(),
                    googleClassroomId: gclassCourse.id, // Link to GClass
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                try {
                    const docRef = await db.collection('classes').add(newNotifyClass);
                    closeAllModals();
                    
                    // Now show post modal
                    const inviteLink = `${window.location.origin}/invite.html?classId=${docRef.id}`;
                    document.getElementById('post-title-input').value = `Join our Notify class for "${className}"`;
                    document.getElementById('post-description-input').value = `Hi everyone,\n\nPlease join our companion class on Notify to ask for help during lessons. Click the link below to accept the invitation.\n\nThank you!`;
                    postInviteModal.classList.remove('hidden');
                    
                    document.getElementById('post-invite-form').onsubmit = async (e) => {
                        e.preventDefault();
                        loadingOverlay.classList.remove('hidden');
                        
                        const title = document.getElementById('post-title-input').value;
                        const description = document.getElementById('post-description-input').value;

                        try {
                            await gapi.client.classroom.courses.announcements.create({
                                courseId: gclassCourse.id,
                                resource: {
                                    text: description,
                                    materials: [{ link: { url: inviteLink, title: title } }]
                                }
                            });
                            showAlert("Invitation posted to Google Classroom!");
                        } catch(err) {
                            console.error("Error posting to classroom:", err);
                            showAlert("Failed to post invite. Please check permissions.");
                        } finally {
                           closeAllModals();
                        }
                    };
                } catch (err) {
                    console.error("Error creating class from GClass:", err);
                    showAlert("Failed to import the class.");
                }
            }


            // --- START APP ---
            initializeApp();
        });
    </script>
</body>
</html>

