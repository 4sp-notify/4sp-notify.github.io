<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
Â  <title>4SP - DASHBOARD</title>
Â  <link rel="stylesheet" href="../css/style.css" />
Â  <style>
Â  Â  /* --- Dashboard Layout --- */
Â  Â  body.dashboard-page {
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  min-height: 100vh;
Â  Â  Â  margin: 0;
Â  Â  Â  font-family: 'PrimaryFont', sans-serif;
Â  Â  }
Â  Â  .dashboard-container {
Â  Â  Â  display: flex;
Â  Â  Â  flex: 1;
Â  Â  }

Â  Â  /* --- Sidebar --- */
Â  Â  .sidebar {
Â  Â  Â  width: 200px;
Â  Â  Â  background: linear-gradient(180deg, #333 0%, #2a2a2a 100%);
Â  Â  Â  color: #fff;
Â  Â  Â  padding: 20px 10px;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  border-right: 1px solid #444;
Â  Â  Â  transition: width 0.5s ease-in-out;
Â  Â  Â  position: relative;
Â  Â  Â  box-shadow: 2px 0 10px rgba(0,0,0,0.1);
Â  Â  }
Â  Â  .sidebar.collapsed {
Â  Â  Â  width: 85px;
Â  Â  }
Â  Â  #toggleSidebar {
Â  Â  Â  position: absolute;
Â  Â  Â  top: 10px;
Â  Â  Â  left: 50%;
Â  Â  Â  transform: translateX(-50%);
Â  Â  Â  background: none;
Â  Â  Â  border: none;
Â  Â  Â  color: #fff;
Â  Â  Â  font-size: 1.2em;
Â  Â  Â  cursor: pointer;
Â  Â  Â  padding: 4px;
Â  Â  Â  transition: transform 0.5s ease-in-out;
Â  Â  }
Â  Â  .sidebar.collapsed #toggleSidebar {
Â  Â  Â  transform: translateX(-50%) rotate(180deg);
Â  Â  }
Â  Â  .sidebar nav ul {
Â  Â  Â  list-style: none;
Â  Â  Â  padding: 0;
Â  Â  Â  margin: 60px 0 0;
Â  Â  }
Â  Â  .sidebar nav li {
Â  Â  Â  margin-bottom: 10px;
Â  Â  }
Â  Â  .sidebar nav a {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  padding: 12px 15px;
Â  Â  Â  color: #fff;
Â  Â  Â  text-decoration: none;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  font-family: 'PrimaryFont', sans-serif;
Â  Â  Â  text-transform: uppercase;
Â  Â  Â  position: relative;
Â  Â  Â  overflow: hidden;
Â  Â  }
Â  Â  .sidebar nav a::before {
Â  Â  Â  content: '';
Â  Â  Â  position: absolute;
Â  Â  Â  top: 0;
Â  Â  Â  left: -100%;
Â  Â  Â  width: 100%;
Â  Â  Â  height: 100%;
Â  Â  Â  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
Â  Â  Â  transition: left 0.5s;
Â  Â  }
Â  Â  .sidebar nav a:hover::before {
Â  Â  Â  left: 100%;
Â  Â  }
Â  Â  .sidebar nav a.active,
Â  Â  .sidebar nav a:hover {
Â  Â  Â  background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
Â  Â  Â  transform: translateX(5px);
Â  Â  }
Â  Â  .sidebar nav a .icon {
Â  Â  Â  font-size: 1.2em;
Â  Â  Â  width: 24px;
Â  Â  Â  text-align: center;
Â  Â  }
Â  Â  .sidebar nav a .label {
Â  Â  Â  margin-left: 10px;
Â  Â  Â  white-space: nowrap;
Â  Â  }
Â  Â  .sidebar.collapsed nav a {
Â  Â  Â  justify-content: center;
Â  Â  Â  padding: 10px 0;
Â  Â  }
Â  Â  .sidebar.collapsed nav a .label {
Â  Â  Â  display: none;
Â  Â  }
Â  Â  .user-info {
Â  Â  Â  text-align: center;
Â  Â  Â  margin: 60px 0 30px;
Â  Â  Â  border-bottom: 1px solid #555;
Â  Â  Â  padding-bottom: 20px;
Â  Â  Â  overflow: visible;
Â  Â  }
Â  Â  .marquee-container {
Â  Â  Â  overflow: hidden;
Â  Â  Â  white-space: nowrap;
Â  Â  Â  position: relative;
Â  Â  Â  width: 100%;
Â  Â  Â  height: 1.8em;
Â  Â  Â  line-height: 1.8em;
Â  Â  }
Â  Â  .marquee-content {
Â  Â  Â  display: inline-block;
Â  Â  Â  padding-left: 100%;
Â  Â  Â  transform: translateX(0);
Â  Â  Â  animation: none;
Â  Â  Â  line-height: 1.8em;
Â  Â  }
Â  Â  .marquee-active {
Â  Â  Â  animation: scroll-left 12s linear infinite;
Â  Â  }
Â  Â  .sidebar.collapsed .marquee-active {
Â  Â  Â  animation-duration: 20s;
Â  Â  }
Â  Â  @keyframes scroll-left {
Â  Â  Â  0% { transform: translateX(0); }
Â  Â  Â  100% { transform: translateX(-100%); }
Â  Â  }
Â  Â  .user-info .username {
Â  Â  Â  font-family: 'PrimaryFont', sans-serif;
Â  Â  Â  font-size: 1.3em;
Â  Â  Â  margin-bottom: 8px;
Â  Â  Â  line-height: 0.2em;
Â  Â  Â  font-weight: bold;
Â  Â  }
Â  Â  .user-info .email {
Â  Â  Â  font-family: 'SecondaryFont', sans-serif;
Â  Â  Â  font-size: 0.9em;
Â  Â  Â  color: #bbb;
Â  Â  }

Â  Â  /* --- Main Content & Controls --- */
Â  Â  .main-content {
Â  Â  Â  flex: 1;
Â  Â  Â  padding: 40px;
Â  Â  Â  background: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
Â  Â  Â  overflow-y: auto;
Â  Â  Â  position: relative;
Â  Â  }
Â  Â  .dashboard-header {
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  align-items: center;
Â  Â  Â  margin-bottom: 40px;
Â  Â  Â  background: white;
Â  Â  Â  padding: 20px 30px;
Â  Â  Â  border-radius: 15px;
Â  Â  Â  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
Â  Â  Â  border: 1px solid rgba(103, 32, 189, 0.1);
Â  Â  }
Â  Â  .dashboard-title {
Â  Â  Â  margin: 0;
Â  Â  Â  font-size: 2.2em;
Â  Â  Â  font-weight: bold;
Â  Â  Â  background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
Â  Â  Â  -webkit-background-clip: text;
Â  Â  Â  -webkit-text-fill-color: transparent;
Â  Â  Â  background-clip: text;
Â  Â  }
Â  Â  .dashboard-controls {
Â  Â  Â  display: flex;
Â  Â  Â  gap: 15px;
Â  Â  Â  align-items: center;
Â  Â  }

Â  Â  /* --- Dashboard Grid & Cards --- */
Â  Â  .dashboard-grid {
Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  grid-template-columns: 1fr;Â 
Â  Â  Â  Â  gap: 20px;
Â  Â  Â  Â  position: relative;
Â  Â  }
Â  Â  @media (min-width: 768px) {
Â  Â  Â  Â  .dashboard-grid {
Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
Â  Â  Â  Â  }
Â  Â  }
Â  Â  @media (min-width: 1200px) {
Â  Â  Â  Â  .dashboard-grid {
Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(6, 1fr);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  .dashboard-card {
Â  Â  Â  background: white;
Â  Â  Â  border-radius: 20px;
Â  Â  Â  padding: 20px;
Â  Â  Â  box-shadow: 0 6px 30px rgba(0,0,0,0.08);
Â  Â  Â  border: 1px solid rgba(103, 32, 189, 0.1);
Â  Â  Â  position: relative;
Â  Â  Â  user-select: none;
Â  Â  Â  z-index: 2;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  overflow: hidden;
Â  Â  Â  transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
Â  Â  Â  min-height: 200px;
Â  Â  }
Â  Â Â 
Â  Â  /* Default span for cards on smaller grids or when type not specified for 6-col */
Â  Â  .dashboard-card {
Â  Â  Â  Â  grid-column: span 1;Â 
Â  Â  }
Â  Â Â 
Â  Â  @media (min-width: 768px) and (max-width: 1199px) { /* For auto-fit on medium screens */
Â  Â  Â  Â  .dashboard-card[data-card-type="medium"],
Â  Â  Â  Â  .dashboard-card[data-card-type="small"],
Â  Â  Â  Â  .dashboard-card[data-card-type="full"] {
Â  Â  Â  Â  Â  Â  grid-column: auto / span 1; /* Each card takes one of the auto-fitted columns */
Â  Â  Â  Â  }
Â  Â  }

Â  Â  @media (min-width: 1200px) { /* Spans for the 6-column grid */
Â  Â  Â  Â  .dashboard-card[data-card-type="medium"] {
Â  Â  Â  Â  Â  Â  grid-column: span 3;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .dashboard-card[data-card-type="small"] {
Â  Â  Â  Â  Â  Â  grid-column: span 2;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .dashboard-card[data-card-type="full"] {Â 
Â  Â  Â  Â  Â  Â  grid-column: span 6;
Â  Â  Â  Â  }
Â  Â  }

Â  Â  .dashboard-card[data-template-id="weather_large_widget"] {
Â  Â  Â  Â  padding-top: 10px;
Â  Â  }

Â  Â  .dashboard-card::before {
Â  Â  Â  content: '';
Â  Â  Â  position: absolute;
Â  Â  Â  top: 0;
Â  Â  Â  left: -100%;
Â  Â  Â  width: 100%;
Â  Â  Â  height: 100%;
Â  Â  Â  background: linear-gradient(90deg, transparent, rgba(103, 32, 189, 0.05), transparent);
Â  Â  Â  transition: left 0.6s ease;
Â  Â  Â  z-index: -1;
Â  Â  }
Â  Â  .dashboard-card:hover::before {
Â  Â  Â  left: 100%;
Â  Â  }
Â  Â  .dashboard-card:hover {
Â  Â  Â  transform: translateY(-8px) scale(1.02);
Â  Â  Â  box-shadow: 0 15px 40px rgba(103, 32, 189, 0.15);
Â  Â  Â  border-color: rgba(103, 32, 189, 0.3);
Â  Â  }

Â  Â  .card-header {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  padding-bottom: 12px;
Â  Â  Â  border-bottom: 1px solid rgba(103, 32, 189, 0.1);
Â  Â  Â  justify-content: flex-start;
Â  Â  Â  flex-shrink: 0;
Â  Â  Â  position: relative;
Â  Â  }
Â  Â  .card-icon {
Â  Â  Â  font-size: 2em;
Â  Â  Â  margin-right: 12px;
Â  Â  Â  background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
Â  Â  Â  -webkit-background-clip: text;
Â  Â  Â  -webkit-text-fill-color: transparent;
Â  Â  Â  filter: drop-shadow(0 2px 4px rgba(103, 32, 189, 0.2));
Â  Â  }
Â  Â  .card-title {
Â  Â  Â  font-size: 1.3em;
Â  Â  Â  font-weight: bold;
Â  Â  Â  margin: 0;
Â  Â  Â  color: #333;
Â  Â  Â  flex-grow: 1;
Â  Â  Â  white-space: nowrap;
Â  Â  Â  overflow: hidden;
Â  Â  Â  text-overflow: ellipsis;
Â  Â  }

Â  Â  /* Weather Refresh Button specific styles */
Â  Â  .weather-refresh-btn {
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  top: 8px; /* Adjusted from 10px to align with new size */
Â  Â  Â  Â  right: 40px; /* Adjusted to make space for settings button */
Â  Â  Â  Â  background: rgba(103, 32, 189, 0.08); /* Slight background for visibility */
Â  Â  Â  Â  border: none;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  padding: 8px; /* Increased padding for bigger button */
Â  Â  Â  Â  line-height: 1;
Â  Â  Â  Â  display: inline-flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  border-radius: 12px; /* Border radius of 12px */
Â  Â  Â  Â  z-index: 5;
Â  Â  Â  Â  transition: background-color 0.2s ease, transform 0.2s ease;
Â  Â  Â  Â  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
Â  Â  }
Â  Â  .weather-refresh-btn img {
Â  Â  Â  Â  width: 22px; /* Bigger icon */
Â  Â  Â  Â  height: 22px; /* Bigger icon */
Â  Â  Â  Â  display: block;
Â  Â  Â  Â  /* Initial state of image transform */
Â  Â  Â  Â  transform: rotate(0deg);Â 
Â  Â  Â  Â  transition: none; /* No transition on the img itself, only animations */
Â  Â  }
Â  Â  .weather-refresh-btn:hover {
Â  Â  Â  Â  background-color: rgba(103, 32, 189, 0.15);
Â  Â  Â  Â  transform: translateY(-2px);
Â  Â  }
Â  Â  .weather-refresh-btn:disabled {
Â  Â  Â  Â  cursor: not-allowed;
Â  Â  Â  Â  opacity: 0.6; /* Maintain some opacity */
Â  Â  Â  Â  background-color: rgba(103, 32, 189, 0.08); /* Keep a subtle background when disabled */
Â  Â  Â  Â  transform: translateY(0); /* No hover effect when disabled */
Â  Â  }

Â  Â  /* Keyframe for spinning icon */
Â  Â  @keyframes spin-clockwise {
Â  Â  Â  Â  0% { transform: rotate(0deg); }
Â  Â  Â  Â  100% { transform: rotate(360deg); }
Â  Â  }

Â  Â  /* Keyframe for icon spinning back to initial position */
Â  Â  @keyframes spin-counter-clockwise {
Â  Â  Â  Â  from { transform: rotate(360deg); } /* Start from 360 degrees, effectively current rotated state */
Â  Â  Â  Â  to { transform: rotate(0deg); }Â  Â  /* End at 0 degrees */
Â  Â  }

Â  Â  /* Apply continuous spin animation to the IMAGE inside the button when refreshing */
Â  Â  .weather-refresh-btn.refreshing img {
Â  Â  Â  Â  animation: spin-clockwise 0.8s linear infinite;Â 
Â  Â  }
Â  Â Â 
Â  Â  /* Apply spin-back animation to the IMAGE inside the button when done loading */
Â  Â  .weather-refresh-btn.spin-back img {
Â  Â  Â  Â  animation: spin-counter-clockwise 0.5s ease-out forwards;Â 
Â  Â  }

    /* Weather Settings Button */
    .weather-settings-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(103, 32, 189, 0.08);
        border: none;
        cursor: pointer;
        padding: 8px;
        line-height: 1;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        z-index: 5;
        transition: background-color 0.2s ease, transform 0.2s ease;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .weather-settings-btn:hover {
        background-color: rgba(103, 32, 189, 0.15);
        transform: translateY(-2px);
    }
    .weather-settings-btn img {
        width: 22px;
        height: 22px;
        display: block;
    }

    /* Weather Settings Menu */
    .weather-settings-menu {
        position: absolute;
        top: 50px; /* Below the header */
        right: 8px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        padding: 15px;
        z-index: 10;
        min-width: 250px;
        display: none; /* Hidden by default */
        flex-direction: column;
        gap: 12px;
        transform: translateY(-10px);
        opacity: 0;
        transition: transform 0.2s ease-out, opacity 0.2s ease-out;
    }

    .weather-settings-menu.open {
        display: flex;
        transform: translateY(0);
        opacity: 1;
    }

    .weather-settings-menu label {
        font-size: 0.9em;
        color: #555;
        font-weight: 600;
        margin-bottom: 5px;
        display: block;
    }

    .weather-settings-menu .unit-toggle-container {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }

    .weather-settings-menu button {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #f0f0f0;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.2s ease;
        font-weight: 500;
        color: #555;
    }

    .weather-settings-menu button.active {
        background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
        color: white;
        border-color: #6720bd;
        box-shadow: 0 2px 8px rgba(103, 32, 189, 0.2);
    }

    .weather-settings-menu button:hover:not(.active) {
        background-color: #e8e8e8;
        border-color: #c0c0c0;
    }

    .weather-settings-menu .location-search-input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 0.9em;
        box-sizing: border-box; /* Include padding in width */
    }

    .weather-settings-menu .location-search-input:focus {
        outline: none;
        border-color: #6720bd;
        box-shadow: 0 0 0 2px rgba(103, 32, 189, 0.2);
    }

    /* Google Places Autocomplete styles (adjust as needed for integration) */
    .pac-container {
        font-family: 'PrimaryFont', sans-serif;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10001; /* Ensure it's above the modal */
    }

    .pac-item {
        padding: 10px 15px;
        font-size: 0.9em;
        color: #333;
        border-bottom: 1px solid #eee;
        cursor: pointer;
    }

    .pac-item:hover {
        background-color: #f5f5f5;
    }

    .pac-item-query {
        font-weight: 600;
    }

    .pac-item-selected {
        background-color: #e9e9e9;
    }


Â  Â  .card-content-inner {
Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  overflow-y: auto;
Â  Â  }

Â  Â  /* Specific Widget Styles */
Â  Â  .weather-large-content {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  height: 100%;
Â  Â  }
Â  Â  .current-weather-layout {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  gap: 15px;
Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  padding-bottom: 10px;
Â  Â  Â  Â  border-bottom: 1px solid rgba(103, 32, 189, 0.08);
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  box-sizing: border-box;
Â  Â  }
Â  Â  .weather-icon-large {
Â  Â  Â  Â  font-size: 3.2em;
Â  Â  Â  Â  color: #6720bd;
Â  Â  Â  Â  flex-shrink: 0;
Â  Â  }
Â  Â  .current-weather-main-info {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  align-items: flex-start;
Â  Â  Â  Â  flex-grow: 1; /* Allows this section to take available space */
Â  Â  }
Â  Â  .temp-large {
Â  Â  Â  Â  font-size: 2.3em;
Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  color: #333;
Â  Â  Â  Â  line-height: 1.1;
Â  Â  }
Â  Â  .condition-large {
Â  Â  Â  Â  font-size: 0.95em;
Â  Â  Â  Â  color: #555;
Â  Â  }
Â  Â  .current-weather-details-aside {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  align-items: flex-end; /* Align details to the right */
Â  Â  Â  Â  font-size: 0.75em;
Â  Â  Â  Â  color: #777;
Â  Â  Â  Â  line-height: 1.4;
Â  Â  Â  Â  flex-shrink: 0;
Â  Â  Â  Â  padding-left: 12px;
Â  Â  Â  Â  border-left: 1px solid rgba(103, 32, 189, 0.1);
Â  Â  Â  Â  text-align: right; /* Ensure text inside is right-aligned */
Â  Â  }
Â  Â  .current-weather-details-aside p {
Â  Â  Â  Â  margin: 0px 0;
Â  Â  }

Â  Â  .forecast-large {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  Â  justify-content: space-around;
Â  Â  Â  Â  gap: 5px;
Â  Â  Â  Â  padding: 6px 0px;
Â  Â  Â  Â  margin-bottom: 8px;
Â  Â  }
Â  Â  .forecast-day {
Â  Â  Â  Â  flex: 0 1 auto;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  padding: 8px 4px; /* Increased padding */
Â  Â  Â  Â  background-color: #ffffff; /* White background */
Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  min-width: 58.5px; /* Slightly larger min-width */
Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  border: 1.25px solid rgba(103, 32, 189, 0.2); /* Stronger border */
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  transition: all 0.2s ease; /* All transition for smoother hover */
Â  Â  Â  Â  height: 82.5px; /* Slightly taller */
Â  Â  Â  Â  box-shadow: 0 2px 8px rgba(0,0,0,0.05); /* Subtle shadow */
Â  Â  }
Â  Â  .forecast-day:hover {
Â  Â  Â  Â  background-color: rgba(103, 32, 189, 0.1);
Â  Â  Â  Â  transform: translateY(-3px); /* Lift effect on hover */
Â  Â  Â  Â  box-shadow: 0 5px 15px rgba(103, 32, 189, 0.1); /* More pronounced shadow */
Â  Â  }
Â  Â  .forecast-day .day-name { font-size: 0.75em; font-weight: 600; color: #555; margin-bottom: 4px; } /* Slightly larger font */
Â  Â  .forecast-day .icon {Â 
Â  Â  Â  Â  font-size: 1.6em; /* Bigger icon */
Â  Â  Â  Â  color: #6720bd; margin-bottom: 4px; line-height:1;Â 
Â  Â  Â  Â  filter: drop-shadow(0 1px 2px rgba(103, 32, 189, 0.1)); /* Icon shadow */
Â  Â  }
Â  Â  .forecast-day .temps {Â 
Â  Â  Â  Â  font-size: 0.8em; /* Slightly larger temperature font */
Â  Â  Â  Â  color: #333;Â 
Â  Â  Â  Â  font-weight: 500;
Â  Â  }

Â  Â  /* Clock Widget */
Â  Â  .clock-display {
Â  Â  Â  Â  font-size: 2.5em;
Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  color: #333;
Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  margin-bottom: 5px;
Â  Â  }
Â  Â  .date-display {
Â  Â  Â  Â  font-size: 1em;
Â  Â  Â  Â  color: #666;
Â  Â  Â  Â  text-align: left;
Â  Â  }
Â  Â  .additional-time-info {
Â  Â  Â  Â  font-size: 0.85em;
Â  Â  Â  Â  color: #777;
Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  line-height: 1.3;
Â  Â  }
Â  Â  .additional-time-info span {
Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  padding: 0 5px;
Â  Â  }
Â  Â  .additional-time-info span:first-child {
Â  Â  Â  Â  padding-left: 0;
Â  Â  }

Â  Â  /* Stopwatch & Timer Widget */
Â  Â  .stopwatch-display, .timer-display-value {
Â  Â  Â  Â  font-size: 2.2em;
Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  color: #6720bd;
Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  letter-spacing: 1px;
Â  Â  Â  Â  font-family: 'PrimaryFont', sans-serif; /* Reverted for user preference */
Â  Â  Â  Â  /* For jitter: if PrimaryFont is not monospace, jitter may occur.
Â  Â  Â  Â  Â  Â  Consider 'monospace, Courier New, Courier' for number stability. */
Â  Â  }
Â  Â  .timer-inputs { display: flex; justify-content: center; gap: 5px; margin-bottom: 15px; }
Â  Â  .timer-inputs input {
Â  Â  Â  Â  width: 50px;
Â  Â  Â  Â  padding: 8px;
Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  font-size: 1em;
Â  Â  Â  Â  font-family: 'PrimaryFont', sans-serif;
Â  Â  }
Â  Â  .controls-flex { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;}
Â  Â  .controls-flex button {
Â  Â  Â  Â  background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
Â  Â  Â  Â  color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer;
Â  Â  Â  Â  font-family: 'PrimaryFont', sans-serif; font-weight: 600; transition: all 0.2s ease;
Â  Â  }
Â  Â  .controls-flex button:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(103, 32, 189, 0.3); }
Â  Â  .controls-flex button[data-action="stop"], .controls-flex button[data-action="pause"] { background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); }
Â  Â  .controls-flex button[data-action="reset"] { background: linear-gradient(135deg, #6c757d 0%, #495057 100%); }

Â  Â  /* Quick Actions Widget - New List Style */
Â  Â  .quick-actions-list {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  gap: 10px; /* Space between action items */
Â  Â  }
Â  Â  .quick-actions-list button {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  padding: 12px 15px;
Â  Â  Â  Â  background-color: #f8f9fa;
Â  Â  Â  Â  border: 1px solid #e9ecef;
Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  font-family: 'PrimaryFont', sans-serif;
Â  Â  Â  Â  font-size: 1.1em;
Â  Â  Â  Â  text-transform: uppercase;
Â  Â  Â  Â  color: #495057;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  transition: all 0.2s ease;
Â  Â  Â  Â  height: 42.5px;
Â  Â  }
Â  Â  .quick-actions-list button:hover {
Â  Â  Â  Â  background-color: #e9ecef;
Â  Â  Â  Â  border-color: #dee2e6;
Â  Â  Â  Â  transform: translateY(-1px);
Â  Â  Â  Â  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
Â  Â  }
Â  Â  .quick-actions-list button .icon {
Â  Â  Â  Â  font-size: 1.5em;
Â  Â  Â  Â  margin-right: 12px;
Â  Â  Â  Â  color: #6720bd;
Â  Â  }
Â  Â  .quick-actions-list button .text {
Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  font-weight: 500;
Â  Â  }
Â  Â  .quick-actions-list button .arrow {
Â  Â  Â  Â  font-size: 1.2em;
Â  Â  Â  Â  color: #adb5bd;
Â  Â  }


Â  Â  /* Forecast Detail Modal Styles with Animation */
Â  Â  .modal {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  z-index: 10000;
Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  overflow: auto;
Â  Â  Â  Â  background-color: rgba(0,0,0,0.6);
Â  Â  Â  Â  font-family: 'PrimaryFont', sans-serif;
Â  Â  Â  Â  visibility: hidden;
Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  transition: opacity 0.25s ease-out, visibility 0s linear 0.25s;
Â  Â  }
Â  Â  .modal.modal-open {
Â  Â  Â  Â  visibility: visible;
Â  Â  Â  Â  opacity: 1;
Â  Â  Â  Â  transition: opacity 0.25s ease-out, visibility 0s linear 0s;
Â  Â  }
Â  Â  .modal-content {
Â  Â  Â  Â  background-color: #fefefe;
Â  Â  Â  Â  padding: 30px; /* Increased padding */
Â  Â  Â  Â  border: 1px solid #bbb;
Â  Â  Â  Â  width: 90%;
Â  Â  Â  Â  max-width: 500px; /* Slightly increased max-width */
Â  Â  Â  Â  border-radius: 18px; /* More rounded corners */
Â  Â  Â  Â  box-shadow: 0 8px 30px rgba(0,0,0,0.25); /* Stronger shadow */
Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  color: #333;
Â  Â  Â  Â  transform: scale(0.9); /* Slightly more pronounced initial scale */
Â  Â  Â  Â  transition: transform 0.3s ease-out; /* Smoother transition */
Â  Â  Â  Â  display: flex; /* Flexbox for internal layout */
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  gap: 15px; /* Space between sections */
Â  Â  }
Â  Â  .modal.modal-open .modal-content {
Â  Â  Â  Â  transform: scale(1);
Â  Â  }
Â  Â  .modal-close-btn {
Â  Â  Â  Â  color: #aaa;
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  top: 15px; /* Adjusted position */
Â  Â  Â  Â  right: 18px; /* Adjusted position */
Â  Â  Â  Â  font-size: 30px; /* Larger close button */
Â  Â  Â  Â  font-weight: 300; /* Lighter weight */
Â  Â  Â  Â  background: none;
Â  Â  Â  Â  border: none;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  line-height: 1;
Â  Â  Â  Â  transition: color 0.2s ease;
Â  Â  }
Â  Â  .modal-close-btn:hover,
Â  Â  .modal-close-btn:focus {
Â  Â  Â  Â  color: #6720bd; /* Purple on hover */
Â  Â  Â  Â  text-decoration: none;
Â  Â  }

Â  Â  .modal-header-section {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  border-bottom: 1px solid rgba(103, 32, 189, 0.1); /* Subtle separator */
Â  Â  Â  Â  padding-bottom: 15px;
Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  }

Â  Â  .modal-header-section h3 {
Â  Â  Â  Â  margin: 0 0 8px 0; /* Adjusted margin */
Â  Â  Â  Â  color: #6720bd;
Â  Â  Â  Â  font-size: 1.8em; /* Larger title */
Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  text-align: center;
Â  Â  }
Â  Â  .modal-header-section .date-subtitle {
Â  Â  Â  Â  font-size: 1.1em; /* Slightly larger subtitle */
Â  Â  Â  Â  color: #555;
Â  Â  Â  Â  font-weight: normal;
Â  Â  Â  Â  margin: 0;
Â  Â  }

Â  Â  .modal-current-weather-summary {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  justify-content: center; /* Center horizontally */
Â  Â  Â  Â  gap: 20px; /* More space between elements */
Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  }

Â  Â  .modal-icon-large {
Â  Â  Â  Â  font-size: 4em; /* Much larger icon */
Â  Â  Â  Â  color: #6720bd;
Â  Â  Â  Â  text-shadow: 0 3px 8px rgba(103, 32, 189, 0.2); /* More prominent shadow */
Â  Â  }

Â  Â  .modal-temp-and-desc {
Â  Â  Â  Â  text-align: left; /* Align text to the left within its container */
Â  Â  }
Â  Â  .modal-temp-and-desc .modal-temp-display {
Â  Â  Â  Â  font-size: 2.8em; /* Larger temperature */
Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  color: #333;
Â  Â  Â  Â  line-height: 1;
Â  Â  Â  Â  margin-bottom: 5px;
Â  Â  }
Â  Â  .modal-temp-and-desc #modalWeatherDesc {
Â  Â  Â  Â  font-size: 1.2em; /* Larger description */
Â  Â  Â  Â  font-weight: 500;
Â  Â  Â  Â  color: #666;
Â  Â  }

Â  Â  .modal-details-grid {
Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Responsive grid */
Â  Â  Â  Â  gap: 10px 20px; /* Row and column gap */
Â  Â  }

Â  Â  .modal-details-grid p {
Â  Â  Â  Â  font-size: 0.9em; /* Slightly larger detail text */
Â  Â  Â  Â  line-height: 1.5;
Â  Â  Â  Â  margin: 0; /* Remove default paragraph margins */
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  gap: 8px; /* Space between icon and text */
Â  Â  Â  Â  color: #444;
Â  Â  }

Â  Â  .modal-details-grid p strong {
Â  Â  Â  Â  color: #222;
Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  gap: 5px;
Â  Â  }

Â  Â  .modal-details-grid .detail-icon {
Â  Â  Â  Â  font-size: 1.1em; /* Icon size for details */
Â  Â  Â  Â  color: #8a2be2; /* Purple tone for icons */
Â  Â  }

Â  Â  /* --- Responsive Design --- */
Â  Â  @media (max-width: 1199px) and (min-width: 768px) {
Â  Â  Â  Â  .dashboard-card[data-card-type="medium"],
Â  Â  Â  Â  .dashboard-card[data-card-type="small"],
Â  Â  Â  Â  .dashboard-card[data-card-type="full"] {
Â  Â  Â  Â  Â  Â  /* All cards take 1fr of the auto-fit columns */
Â  Â  Â  Â  }
Â  Â  }

Â  Â  @media (max-width: 767px) {
Â  Â  Â  .dashboard-grid {
Â  Â  Â  Â  grid-template-columns: 1fr;
Â  Â  Â  }
Â  Â  Â  .dashboard-card {
Â  Â  Â  Â  grid-column: span 1 / auto !important;
Â  Â  Â  }
Â  Â  Â  .current-weather-layout {
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  align-items: flex-start;
Â  Â  Â  }
Â  Â  Â  .current-weather-details-aside {
Â  Â  Â  Â  padding-left: 0;
Â  Â  Â  Â  margin-left: 0;
Â  Â  Â  Â  border-left: none;
Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  align-items: flex-start; /* Align to left on small screens */
Â  Â  Â  }
Â  Â  Â  .dashboard-header {
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  gap: 15px;
Â  Â  Â  Â  text-align: center;
Â  Â  Â  }
Â  Â  Â  .main-content {
Â  Â  Â  Â  padding: 20px;
Â  Â  Â  }
Â  Â  Â  .weather-icon-large { font-size: 3em; }
Â  Â  Â  .temp-large { font-size: 2.2em; }
Â  Â  Â  .clock-display { font-size: 2em; }
Â  Â  Â  .date-display { font-size: 0.9em; }
Â  Â  Â  .additional-time-info { font-size: 0.75em; margin-top: 8px;}
Â  Â  Â  .stopwatch-display, .timer-display-value { font-size: 1.8em;}
Â  Â  Â  .quick-actions-list button { font-size: 0.9em; padding: 10px 12px;} /* Adjusted for new Quick Actions */
Â  Â  Â  .quick-actions-list button .icon { font-size: 1.3em; margin-right: 10px;} /* Adjusted for new Quick Actions */

Â  Â  Â  /* Modal on small screens */
Â  Â  Â  .modal-content {
Â  Â  Â  Â  width: 95%; /* Wider on small screens */
Â  Â  Â  Â  padding: 20px; /* Reduced padding */
Â  Â  Â  }
Â  Â  Â  .modal-header-section h3 { font-size: 1.5em; }
Â  Â  Â  .modal-header-section .date-subtitle { font-size: 1em; }
Â  Â  Â  .modal-current-weather-summary {
Â  Â  Â  Â  Â  flex-direction: column; /* Stack elements vertically */
Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  gap: 10px;
Â  Â  Â  }
Â  Â  Â  .modal-temp-and-desc {
Â  Â  Â  Â  Â  text-align: center; /* Center text within this section */
Â  Â  Â  }
Â  Â  Â  .modal-icon-large { font-size: 3.5em; }
Â  Â  Â  .modal-temp-and-desc .modal-temp-display { font-size: 2.5em; }
Â  Â  Â  .modal-temp-and-desc #modalWeatherDesc { font-size: 1.1em; }
Â  Â  Â  .modal-details-grid {
Â  Â  Â  Â  Â  grid-template-columns: 1fr; /* Single column on small screens */
Â  Â  Â  Â  Â  gap: 8px; /* Smaller gap */
Â  Â  Â  }
Â  Â  }

Â  Â  /* --- Animation Classes --- */
Â  Â  .fade-in {
Â  Â  Â  animation: fadeIn 0.6s ease-out;
Â  Â  }
Â  Â  @keyframes fadeIn {
Â  Â  Â  from { opacity: 0; transform: translateY(20px); }
Â  Â  Â  to { opacity: 1; transform: translateY(0); }
Â  Â  }
Â  Â  .slide-in {
Â  Â  Â  animation: slideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
Â  Â  }
Â  Â  @keyframes slideIn {
Â  Â  Â  from { transform: translateX(-100%); opacity: 0; }
Â  Â  Â  to { transform: translateX(0); opacity: 1; }
Â  Â  }
Â  </style>
</head>

<body class="dashboard-page">
Â  <header class="main-header light-bg">
Â  Â  <div class="container">
Â  Â  Â  <div class="logo">
Â  Â  Â  Â  <a href="../index.html">
Â  Â  Â  Â  Â  <img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer" />
Â  Â  Â  Â  </a>
Â  Â  Â  </div>
Â  Â  Â  <div class="auth-buttons">
Â  Â  Â  Â  <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button>
Â  Â  Â  Â  <button id="logoutBtn" class="btn btn-login">LOG OUT</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </header>

Â  <div class="dashboard-container">
Â  Â  <aside class="sidebar slide-in" id="sidebar">
Â  Â  Â  <button id="toggleSidebar">â˜°</button>
Â  Â  Â  <div class="user-info">
Â  Â  Â  Â  <div class="marquee-container">
Â  Â  Â  Â  Â  <span id="userName" class="marquee-content username">Loadingâ€¦</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="marquee-container">
Â  Â  Â  Â  Â  <span id="userEmail" class="marquee-content email">Loadingâ€¦</span>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <nav>
Â  Â  Â  Â  <ul>
Â  Â  Â  Â  Â  <li><a href="dashboard.html" class="active"><span class="icon">ğŸ </span><span class="label">Dashboard</span></a></li>
Â  Â  Â  Â  Â  <li><a href="proxies.html"><span class="icon">ğŸ›¡ï¸</span><span class="label">Proxies</span></a></li>
Â  Â  Â  Â  Â  <li><a href="soundboard.html"><span class="icon">ğŸµ</span><span class="label">Soundboard</span></a></li>
Â  Â  Â  Â  Â  <li><a href="games.html"><span class="icon">ğŸ®</span><span class="label">Games</span></a></li>
Â  Â  Â  Â  Â  <li><a href="others.html"><span class="icon">âœ¨</span><span class="label">Others</span></a></li>
Â  Â  Â  Â  Â  <li><a href="settings.html"><span class="icon">âš™ï¸</span><span class="label">Settings</span></a></li>
Â  Â  Â  Â  Â  <li><a href="#" id="signOutLink"><span class="icon">ğŸ”’</span><span class="label">LOG OUT</span></a></li>
Â  Â  Â  Â  </ul>
Â  Â  Â  </nav>
Â  Â  </aside>

Â  Â  <main class="main-content fade-in">
Â  Â  Â  <div class="dashboard-header">
Â  Â  Â  Â  <h2 class="dashboard-title">Dashboard</h2>
Â  Â  Â  Â  <div class="dashboard-controls">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="dashboard-grid" id="dashboardGrid">
Â  Â  Â  Â  </div>

Â  Â  </main>
Â  </div>

Â  <div id="forecastDetailModal" class="modal">
Â  Â  <div class="modal-content">
Â  Â  Â  Â  <button class="modal-close-btn">&times;</button>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="modal-header-section">
Â  Â  Â  Â  Â  Â  <h3 id="modalDayDate">Day, Date</h3>
Â  Â  Â  Â  Â  Â  <p class="date-subtitle" id="modalFullDateSubtitle"></p>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="modal-current-weather-summary">
Â  Â  Â  Â  Â  Â  <span id="modalWeatherIcon" class="modal-icon-large">â“</span>
Â  Â  Â  Â  Â  Â  <div class="modal-temp-and-desc">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="modal-temp-display">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="modalMaxTemp">--</span> / <span id="modalMinTemp">--</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="modalWeatherDesc">Description</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="modal-details-grid">
Â  Â  Â  Â  Â  Â  <p><strong><span class="detail-icon">ğŸŒ¡ï¸</span>Feels Like:</strong> <span id="modalFeelsLike">--</span></p>
Â  Â  Â  Â  Â  Â  <p><strong><span class="detail-icon">ğŸ’§</span>Humidity:</strong> <span id="modalHumidity">--</span>%</p>
Â  Â  Â  Â  Â  Â  <p><strong><span class="detail-icon">ğŸŒ§ï¸</span>Precipitation:</strong> <span id="modalPrecipSum">--</span> mm</p>
Â  Â  Â  Â  Â  Â  <p><strong><span class="detail-icon">â˜”</span>Precip. Chance:</strong> <span id="modalPrecipProb">--</span>%</p>
Â  Â  Â  Â  Â  Â  <p><strong><span class="detail-icon">ğŸ’¨</span>Max Wind:</strong> <span id="modalWindSpeed">--</span></p>
Â  Â  Â  Â  Â  Â  <p><strong><span class="detail-icon">ğŸ§­</span>Wind Direction:</strong> <span id="modalWindDirection">--</span></p>
Â  Â  Â  Â  Â  Â  <p><strong><span class="detail-icon">â˜€ï¸</span>Sunrise:</strong> <span id="modalSunriseTime">--:--</span></p>
Â  Â  Â  Â  Â  Â  <p><strong><span class="detail-icon">ğŸŒ‡</span>Sunset:</strong> <span id="modalSunsetTime">--:--</span></p>
Â  Â  Â  Â  Â  Â  <p><strong><span class="detail-icon">ğŸ’¡</span>Daylight:</strong> <span id="modalDaylightDuration">--</span></p>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places"></script>
Â  <script src="../firebase-config.js"></script>
Â  <script>
Â  Â  // --- Globals & Firebase Refs ---
Â  Â  const dbRef = () =>
Â  Â  Â  firebase.auth().currentUser
Â  Â  Â  Â  ? firebase.firestore().collection('users').doc(firebase.auth().currentUser.uid)
Â  Â  Â  Â  : null;

Â  Â  // --- DOM Elements ---
Â  Â  const marqueeEls = document.querySelectorAll('.marquee-content');
Â  Â  const dashboardGrid = document.getElementById('dashboardGrid');
Â  Â  const userNameEl = document.getElementById('userName');

Â  Â  const WMO_CODES = {
Â  Â  Â  0: { description: "Clear sky", icon: "â˜€ï¸" }, 1: { description: "Mainly clear", icon: "ğŸŒ¤ï¸" },
Â  Â  Â  2: { description: "Partly cloudy", icon: "ğŸŒ¥ï¸" }, 3: { description: "Overcast", icon: "â˜ï¸" },
Â  Â  Â  45: { description: "Fog", icon: "ğŸŒ«ï¸" }, 48: { description: "Depositing rime fog", icon: "ğŸŒ«ï¸" },
Â  Â  Â  51: { description: "Light drizzle", icon: "ğŸŒ¦ï¸" }, 53: { description: "Moderate drizzle", icon: "ğŸŒ¦ï¸" },
Â  Â  Â  55: { description: "Dense drizzle", icon: "ğŸŒ¦ï¸" }, 56: { description: "Light freezing drizzle", icon: "ğŸŒ¨ï¸" },
Â  Â  Â  57: { description: "Dense freezing drizzle", icon: "ğŸŒ¨ï¸" }, 61: { description: "Slight rain", icon: "ğŸŒ§ï¸" },
Â  Â  Â  63: { description: "Moderate rain", icon: "ğŸŒ§ï¸" }, 65: { description: "Heavy rain", icon: "ğŸŒ§ï¸" },
Â  Â  Â  66: { description: "Light freezing rain", icon: "ğŸŒ¨ï¸" }, 67: { description: "Heavy freezing rain", icon: "ğŸŒ¨ï¸" },
Â  Â  Â  71: { description: "Slight snow fall", icon: "â„ï¸" }, 73: { description: "Moderate snow fall", icon: "â„ï¸" },
Â  Â  Â  75: { description: "Heavy snow fall", icon: "â„ï¸" }, 77: { description: "Snow grains", icon: "â„ï¸" },
Â  Â  Â  80: { description: "Slight rain showers", icon: "ğŸŒ¦ï¸" }, 81: { description: "Moderate rain showers", icon: "ğŸŒ¦ï¸" },
Â  Â  Â  82: { description: "Violent rain showers", icon: "â›ˆï¸" }, 85: { description: "Slight snow showers", icon: "ğŸŒ¨ï¸" },
Â  Â  Â  86: { description: "Heavy snow showers", icon: "ğŸŒ¨ï¸" }, 95: { description: "Thunderstorm", icon: "â›ˆï¸" },
Â  Â  Â  96: { description: "Thunderstorm with slight hail", icon: "â›ˆï¸" }, 99: { description: "Thunderstorm with heavy hail", icon: "â›ˆï¸" },
Â  Â  };

Â  Â  // --- Modal Elements & Functions ---
Â  Â  const forecastModal = document.getElementById('forecastDetailModal');
Â  Â  const modalCloseBtn = document.querySelector('.modal-close-btn');

Â  Â  if (modalCloseBtn && forecastModal) {
Â  Â  Â  modalCloseBtn.onclick = function() {
Â  Â  Â  Â  forecastModal.classList.remove('modal-open');
Â  Â  Â  }
Â  Â  }
Â  Â  if (forecastModal) {
Â  Â  Â  Â  window.onclick = function(event) {
Â  Â  Â  Â  Â  if (event.target == forecastModal) {
Â  Â  Â  Â  Â  Â  forecastModal.classList.remove('modal-open');
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function formatModalTime(isoString, timeZone) {
Â  Â  Â  Â  if (!isoString || isoString === 'N/A') return 'N/A';
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const date = new Date(isoString);
Â  Â  Â  Â  Â  Â  return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', timeZone: timeZone, hour12: true });
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  console.error("Error formatting modal time:", e);
Â  Â  Â  Â  Â  Â  return 'N/A';
Â  Â  Â  Â  }
Â  Â  }
Â  Â  function formatDaylightDuration(totalSeconds) {
Â  Â  Â  Â  if (totalSeconds === null || totalSeconds === undefined || totalSeconds === 'N/A' || isNaN(totalSeconds)) return 'N/A';
Â  Â  Â  Â  const hours = Math.floor(totalSeconds / 3600);
Â  Â  Â  Â  const minutes = Math.floor((totalSeconds % 3600) / 60);
Â  Â  Â  Â  return `${hours}h ${minutes}m`;
Â  Â  }

Â  Â  function degreesToCardinal(degrees) {
Â  Â  Â  Â  if (degrees === null || degrees === undefined || degrees === 'N/A' || isNaN(degrees)) return 'N/A';
Â  Â  Â  Â  const val = Math.floor((degrees / 22.5) + 0.5);
Â  Â  Â  Â  const arr = ["N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE", "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW"];
Â  Â  Â  Â  return arr[(val % 16)];
Â  Â  }

Â  Â  async function fetchCityName(lat, lon) {
Â  Â  Â  Â  const nominatimUrl = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&zoom=10&addressdetails=1`;
Â  Â  Â  Â  const fallbackLabel = `Lat: ${parseFloat(lat).toFixed(2)}, Lon: ${parseFloat(lon).toFixed(2)}`;
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const response = await fetch(nominatimUrl);
Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  console.warn(`Nominatim API error: ${response.status}`);
Â  Â  Â  Â  Â  Â  Â  Â  return fallbackLabel;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  Â  Â  if (data && data.address) {
Â  Â  Â  Â  Â  Â  Â  Â  const addr = data.address;
Â  Â  Â  Â  Â  Â  Â  Â  const city = addr.city || addr.town || addr.village || addr.hamlet || '';
Â  Â  Â  Â  Â  Â  Â  Â  const state = addr.state || '';
Â  Â  Â  Â  Â  Â  Â  Â  const country = addr.country || '';
Â  Â  Â  Â  Â  Â  Â  Â  if (city && state && (country === "United States" || country === "USA")) return `${city}, ${state}`;
Â  Â  Â  Â  Â  Â  Â  Â  if (city && country) return `${city}, ${country}`;
Â  Â  Â  Â  Â  Â  Â  Â  if (city) return city;
Â  Â  Â  Â  Â  Â  Â  Â  if (country) return country;
Â  Â  Â  Â  Â  Â  Â  Â  return fallbackLabel;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return fallbackLabel;
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Error fetching city name:", error);
Â  Â  Â  Â  Â  Â  return fallbackLabel;
Â  Â  Â  Â  }
Â  Â  }


Â  Â  function openForecastModal(dayData, dailyTimeZone, displayUnits, speedSuffixUnit, currentApparentTemp, currentHumidity) {
Â  Â  Â  Â  if (!forecastModal) return;

Â  Â  Â  Â  const { dateStr, weatherCode, tempMax, tempMin, precipSum, precipProb, windSpeedMax, sunrise, sunset, daylightDuration, windDirection } = dayData;
Â  Â  Â  Â  const tempSuffix = displayUnits === 'metric' ? 'Â°C' : 'Â°F';

Â  Â  Â  Â  const parts = dateStr.split('-').map(s => parseInt(s, 10));
Â  Â  Â  Â  const utcDateForModal = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2], 12, 0, 0));
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Main Title (Day of Week, Month Day, Year)
Â  Â  Â  Â  document.getElementById('modalDayDate').textContent = utcDateForModal.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: dailyTimeZone });

Â  Â  Â  Â  // Subtitle (Full Date without weekday, to avoid redundancy)
Â  Â  Â  Â  document.getElementById('modalFullDateSubtitle').textContent = utcDateForModal.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric', timeZone: dailyTimeZone });


Â  Â  Â  Â  const codeInfo = WMO_CODES[weatherCode] || { description: "Unknown", icon: "â“" };
Â  Â  Â  Â  document.getElementById('modalWeatherIcon').textContent = codeInfo.icon;
Â  Â  Â  Â  document.getElementById('modalWeatherDesc').textContent = codeInfo.description;

Â  Â  Â  Â  document.getElementById('modalMaxTemp').textContent = `${Math.round(tempMax)}${tempSuffix}`;
Â  Â  Â  Â  document.getElementById('modalMinTemp').textContent = `${Math.round(tempMin)}${tempSuffix}`;
Â  Â  Â  Â  document.getElementById('modalPrecipSum').textContent = `${precipSum !== 'N/A' && precipSum !== null ? precipSum : '--'}`;
Â  Â  Â  Â  document.getElementById('modalPrecipProb').textContent = `${precipProb !== 'N/A' && precipProb !== null ? precipProb : '--'}`;
Â  Â  Â  Â  document.getElementById('modalWindSpeed').textContent = `${windSpeedMax !== 'N/A' && windSpeedMax !== null ? Math.round(windSpeedMax) : '--'} ${speedSuffixUnit}`;
Â  Â  Â  Â  document.getElementById('modalWindDirection').textContent = degreesToCardinal(windDirection);
Â  Â  Â  Â  document.getElementById('modalDaylightDuration').textContent = formatDaylightDuration(daylightDuration);
Â  Â  Â  Â  document.getElementById('modalSunriseTime').textContent = formatModalTime(sunrise, dailyTimeZone);
Â  Â  Â  Â  document.getElementById('modalSunsetTime').textContent = formatModalTime(sunset, dailyTimeZone);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Update new fields for feels like and humidity from current data
Â  Â  Â  Â  document.getElementById('modalFeelsLike').textContent = `${currentApparentTemp !== null ? Math.round(currentApparentTemp) : '--'}${tempSuffix}`;
Â  Â  Â  Â  document.getElementById('modalHumidity').textContent = `${currentHumidity !== null ? currentHumidity : '--'}`;

Â  Â  Â  Â  forecastModal.classList.add('modal-open');
Â  Â  }


Â  Â  // --- Card Templates ---
Â  Â  const availableCardTemplates = [
Â  Â  Â  {
Â  Â  Â  Â  templateId: 'weather_large_widget', title: 'Weather Forecast', icon: 'ğŸŒ¦ï¸', type: 'medium',
Â  Â  Â  Â  config: {
Â  Â  Â  Â  Â  Â  location_label: 'Massillon, OH', latitude: '40.7909', longitude: '-81.5218', units: 'imperial'
Â  Â  Â  Â  },
Â  Â  Â  Â  contentGenerator: function(config) {
Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  <div class="weather-large-content">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="current-weather-layout">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="weather-icon-large">â³</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="current-weather-main-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="temp-large">--Â°</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="condition-large">Loading...</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="current-weather-details-aside">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Feels like: <span class="feels-like-value">--Â°</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Humidity: <span class="humidity-value">--%</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Wind: <span class="wind-value">--</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Location: <span class="location-large">${config.location_label || 'N/A'}</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="forecast-large"></div>
                <div class="weather-settings-menu" style="display: none;">
                    <label>Units:</label>
                    <div class="unit-toggle-container">
                        <button class="unit-toggle-btn" data-unit="imperial">Â°F / mph</button>
                        <button class="unit-toggle-btn" data-unit="metric">Â°C / km/h</button>
                    </div>
                    <label for="locationSearchInput">Custom Location:</label>
                    <input type="text" id="locationSearchInput" class="location-search-input" placeholder="Enter city or address">
                </div>
Â  Â  Â  Â  Â  Â  Â  Â  <small style="text-align:center; display:block; margin-top:auto; color:#aaa; font-size:0.7em;">Weather by Open-Meteo.com</small>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  },
Â  Â  Â  Â  onMount: async (cardElement, config) => {
Â  Â  Â  Â  Â  const forecastEl = cardElement.querySelector('.forecast-large');
Â  Â  Â  Â  Â  const currentIconEl = cardElement.querySelector('.weather-icon-large');
Â  Â  Â  Â  Â  const currentTempEl = cardElement.querySelector('.temp-large');
Â  Â  Â  Â  Â  const currentConditionEl = cardElement.querySelector('.condition-large');
Â  Â  Â  Â  Â  const feelsLikeValueEl = cardElement.querySelector('.feels-like-value');
Â  Â  Â  Â  Â  const humidityValueEl = cardElement.querySelector('.humidity-value');
Â  Â  Â  Â  Â  const windValueEl = cardElement.querySelector('.wind-value');
Â  Â  Â  Â  Â  const locationDisplayEl = cardElement.querySelector('.location-large');

Â  Â  Â  Â  Â  const refreshBtn = cardElement.querySelector('.weather-refresh-btn');
Â  Â  Â  Â  Â  const refreshImg = refreshBtn ? refreshBtn.querySelector('img') : null; // Get the image element

            // Weather settings elements
            const settingsBtn = cardElement.querySelector('.weather-settings-btn');
            const settingsMenu = cardElement.querySelector('.weather-settings-menu');
            const unitToggleBtns = cardElement.querySelectorAll('.unit-toggle-btn');
            const locationSearchInput = cardElement.querySelector('#locationSearchInput');

Â  Â  Â  Â  Â  let fullDailyForecastData = null;
Â  Â  Â  Â  Â  let currentApparentTemp = null;
Â  Â  Â  Â  Â  let currentHumidity = null;
            let currentCoords = { latitude: config.latitude, longitude: config.longitude };
            let currentUnits = config.units;
            let currentLocationLabel = config.location_label;

Â  Â  Â  Â  Â  const displayErrorInCard = (message) => {
Â  Â  Â  Â  Â  Â  currentConditionEl.textContent = message; currentIconEl.textContent = 'âš ï¸'; currentTempEl.textContent = '--Â°';
Â  Â  Â  Â  Â  Â  if(feelsLikeValueEl) feelsLikeValueEl.textContent = '--Â°';
Â  Â  Â  Â  Â  Â  if(humidityValueEl) humidityValueEl.textContent = '--%';
Â  Â  Â  Â  Â  Â  if(windValueEl) windValueEl.textContent = '--';
Â  Â  Â  Â  Â  Â  if(locationDisplayEl) locationDisplayEl.textContent = "Error";
Â  Â  Â  Â  Â  Â  forecastEl.innerHTML = `<p style="color:red; text-align:center; font-size:0.9em;">${message}</p>`;
Â  Â  Â  Â  Â  Â  if (refreshBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  refreshBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  if (refreshImg) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  refreshImg.classList.remove('refreshing'); // Stop icon spin
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  refreshBtn.classList.add('spin-back'); // Trigger button's class for img spin-back
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  refreshImg.addEventListener('animationend', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  refreshBtn.classList.remove('spin-back'); // Remove from button
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  refreshImg.style.transform = ''; // Reset img transform
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, { once: true });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  };

            // Function to save weather widget configuration to Firebase
            const saveWeatherConfig = async () => {
                const user = firebase.auth().currentUser;
                if (!user) {
                    console.warn("User not logged in, cannot save weather config.");
                    return;
                }
                const userDocRef = firebase.firestore().collection('users').doc(user.uid);
                try {
                    // Fetch existing dashboard_layout
                    const doc = await userDocRef.get();
                    let dashboardLayout = doc.exists && doc.data().dashboard_layout ? doc.data().dashboard_layout : [];
                    
                    // Find and update the weather widget config
                    let weatherWidgetIndex = dashboardLayout.findIndex(widget => widget.templateId === 'weather_large_widget');

                    if (weatherWidgetIndex !== -1) {
                        dashboardLayout[weatherWidgetIndex].config = {
                            location_label: currentLocationLabel,
                            latitude: currentCoords.latitude,
                            longitude: currentCoords.longitude,
                            units: currentUnits
                        };
                    } else {
                        // If for some reason the weather widget isn't in layout, add it.
                        // This case should ideally not happen if setupFixedDashboardLayout always includes it.
                        dashboardLayout.push({
                            templateId: 'weather_large_widget',
                            config: {
                                location_label: currentLocationLabel,
                                latitude: currentCoords.latitude,
                                longitude: currentCoords.longitude,
                                units: currentUnits
                            }
                        });
                    }

                    await userDocRef.update({ dashboard_layout: dashboardLayout });
                    console.log("Weather widget config saved to Firebase.");
                    showNotification("Weather settings saved!", "success", 2000);
                } catch (error) {
                    console.error("Error saving weather config to Firebase:", error);
                    showNotification("Failed to save settings.", "error", 2000);
                }
            };

            // Function to load weather widget configuration from Firebase
            const loadWeatherConfig = async () => {
                const user = firebase.auth().currentUser;
                if (!user) {
                    console.warn("User not logged in, cannot load weather config.");
                    return null;
                }
                const userDocRef = firebase.firestore().collection('users').doc(user.uid);
                try {
                    const doc = await userDocRef.get();
                    if (doc.exists && doc.data().dashboard_layout) {
                        const weatherWidget = doc.data().dashboard_layout.find(widget => widget.templateId === 'weather_large_widget');
                        if (weatherWidget && weatherWidget.config) {
                            return weatherWidget.config;
                        }
                    }
                } catch (error) {
                    console.error("Error loading weather config from Firebase:", error);
                }
                return null;
            };

Â  Â  Â  Â  Â  async function actualFetchAndDisplayWeather(lat, lon, units, locationLabel) {
Â  Â  Â  Â  Â  Â  if (refreshBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  refreshBtn.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  refreshBtn.classList.remove('spin-back'); // Remove previous spin-back from button
Â  Â  Â  Â  Â  Â  Â  Â  if (refreshImg) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  refreshImg.classList.remove('spin-back'); // Remove previous spin-back from image
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  refreshImg.classList.add('refreshing'); // Start icon spinning
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  currentIconEl.textContent = 'â³';
Â  Â  Â  Â  Â  Â  currentConditionEl.textContent = 'Fetching...';

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  const tempUnitParam = units === 'metric' ? 'celsius' : 'fahrenheit';
Â  Â  Â  Â  Â  Â  Â  const windSpeedUnitParam = units === 'metric' ? 'kmh' : 'mph';
Â  Â  Â  Â  Â  Â  Â  const dailyParams = "weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum,precipitation_probability_max,wind_speed_10m_max,sunrise,sunset,daylight_duration,wind_direction_10m_dominant";
Â  Â  Â  Â  Â  Â  Â  const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m&daily=${dailyParams}&temperature_unit=${tempUnitParam}&wind_speed_unit=${windSpeedUnitParam}&timezone=auto&forecast_days=7`;
Â  Â  Â  Â  Â  Â  Â  const response = await fetch(apiUrl);
Â  Â  Â  Â  Â  Â  Â  if (!response.ok) throw new Error(`API Error: ${response.status}`);
Â  Â  Â  Â  Â  Â  Â  const data = await response.json();

Â  Â  Â  Â  Â  Â  Â  const cw = data.current;
Â  Â  Â  Â  Â  Â  Â  const cwCodeInfo = WMO_CODES[cw.weather_code] || { description: "Unknown", icon: "â“" };
Â  Â  Â  Â  Â  Â  Â  const tempSuffix = units === 'metric' ? 'Â°C' : 'Â°F';
Â  Â  Â  Â  Â  Â  Â  const speedSuffix = units === 'metric' ? 'km/h' : 'mph';

Â  Â  Â  Â  Â  Â  Â  currentTempEl.textContent = `${Math.round(cw.temperature_2m)}${tempSuffix}`;
Â  Â  Â  Â  Â  Â  Â  currentIconEl.textContent = cwCodeInfo.icon;
Â  Â  Â  Â  Â  Â  Â  currentConditionEl.textContent = cwCodeInfo.description;
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  currentApparentTemp = cw.apparent_temperature; // Store for modal
Â  Â  Â  Â  Â  Â  Â  currentHumidity = cw.relative_humidity_2m; // Store for modal

Â  Â  Â  Â  Â  Â  Â  if (feelsLikeValueEl) feelsLikeValueEl.textContent = `${Math.round(currentApparentTemp)}${tempSuffix}`;
Â  Â  Â  Â  Â  Â  Â  if (humidityValueEl) humidityValueEl.textContent = `${currentHumidity}%`;
Â  Â  Â  Â  Â  Â  Â  if (windValueEl) windValueEl.textContent = `${Math.round(cw.wind_speed_10m)}${speedSuffix}`;
Â  Â  Â  Â  Â  Â  Â  if (locationDisplayEl) locationDisplayEl.textContent = locationLabel;

Â  Â  Â  Â  Â  Â  Â  forecastEl.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  fullDailyForecastData = data.daily;

Â  Â  Â  Â  Â  Â  Â  if (fullDailyForecastData && fullDailyForecastData.time && fullDailyForecastData.time.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 0; i < fullDailyForecastData.time.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  const dayCodeInfo = WMO_CODES[fullDailyForecastData.weather_code[i]] || { description: "Unknown", icon: "â“" };
Â  Â  Â  Â  Â  Â  Â  Â  Â  const dayDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  dayDiv.classList.add('forecast-day');
Â  Â  Â  Â  Â  Â  Â  Â  Â  dayDiv.dataset.dayIndex = i;

Â  Â  Â  Â  Â  Â  Â  Â  Â  const currentDayDateString = fullDailyForecastData.time[i];
Â  Â  Â  Â  Â  Â  Â  Â  Â  const parts = currentDayDateString.split('-').map(s => parseInt(s, 10));
Â  Â  Â  Â  Â  Â  Â  Â  Â  const utcDateForForecastDay = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2], 12, 0, 0));
Â  Â  Â  Â  Â  Â  Â  Â  Â  const dayName = i === 0 ? "Today" : utcDateForForecastDay.toLocaleDateString(undefined, { weekday: 'short', timeZone: data.timezone });

Â  Â  Â  Â  Â  Â  Â  Â  Â  dayDiv.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="day-name">${dayName}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="icon">${dayCodeInfo.icon}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="temps">${Math.round(fullDailyForecastData.temperature_2m_max[i])}Â°/${Math.round(fullDailyForecastData.temperature_2m_min[i])}Â°</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  dayDiv.addEventListener('click', function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dayIndex = parseInt(this.dataset.dayIndex);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (fullDailyForecastData) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const daySpecificData = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dateStr: fullDailyForecastData.time[dayIndex],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  weatherCode: fullDailyForecastData.weather_code[dayIndex],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tempMax: fullDailyForecastData.temperature_2m_max[dayIndex],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tempMin: fullDailyForecastData.temperature_2m_min[dayIndex],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  precipSum: fullDailyForecastData.precipitation_sum ? fullDailyForecastData.precipitation_sum[dayIndex] : 'N/A',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  precipProb: fullDailyForecastData.precipitation_probability_max ? fullDailyForecastData.precipitation_probability_max[dayIndex] : 'N/A',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  windSpeedMax: fullDailyForecastData.wind_speed_10m_max ? fullDailyForecastData.wind_speed_10m_max[dayIndex] : 'N/A',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sunrise: fullDailyForecastData.sunrise ? fullDailyForecastData.sunrise[dayIndex] : 'N/A',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sunset: fullDailyForecastData.sunset ? fullDailyForecastData.sunset[dayIndex] : 'N/A',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  daylightDuration: fullDailyForecastData.daylight_duration ? fullDailyForecastData.daylight_duration[dayIndex] : 'N/A',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  windDirection: fullDailyForecastData.wind_direction_10m_dominant ? fullDailyForecastData.wind_direction_10m_dominant[dayIndex] : 'N/A'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  openForecastModal(daySpecificData, data.timezone, units, speedSuffix, currentApparentTemp, currentHumidity);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  forecastEl.appendChild(dayDiv);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  forecastEl.innerHTML = "<p>No forecast data available.</p>";
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  console.error("Weather API fetch error:", error);
Â  Â  Â  Â  Â  Â  Â  displayErrorInCard(error.message || "Could not fetch weather.");
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  if (refreshBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  refreshBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (refreshImg) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  refreshImg.classList.remove('refreshing'); // Stop icon spinning
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  refreshBtn.classList.add('spin-back'); // Add class to button to trigger img spin-back
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  refreshImg.addEventListener('animationend', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  refreshBtn.classList.remove('spin-back'); // Remove from button when img animation finishes
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  refreshImg.style.transform = ''; // Reset img transform after animation
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, { once: true });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  async function updateWeather() {
                // Use current values for location and units
                const lat = currentCoords.latitude;
                const lon = currentCoords.longitude;
                const units = currentUnits;
                const label = currentLocationLabel;

Â  Â  Â  Â  Â  Â  currentIconEl.textContent = 'ğŸ“';
Â  Â  Â  Â  Â  Â  currentConditionEl.textContent = 'Locating...';
Â  Â  Â  Â  Â  Â  if (locationDisplayEl) locationDisplayEl.textContent = 'Acquiring location...';

                // If default location or custom location is set, use that
                if (lat && lon) {
                    await actualFetchAndDisplayWeather(lat, lon, units, label);
                } else if (navigator.geolocation) {
                    // Otherwise, try to use geolocation
Â  Â  Â  Â  Â  Â  Â  navigator.geolocation.getCurrentPosition(
Â  Â  Â  Â  Â  Â  Â  Â  async (position) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  const newLat = position.coords.latitude;
Â  Â  Â  Â  Â  Â  Â  Â  Â  const newLon = position.coords.longitude;
Â  Â  Â  Â  Â  Â  Â  Â  Â  const cityNameLabel = await fetchCityName(newLat, newLon);
                    currentCoords = { latitude: newLat.toString(), longitude: newLon.toString() };
                    currentLocationLabel = cityNameLabel;
Â  Â  Â  Â  Â  Â  Â  Â  Â  await actualFetchAndDisplayWeather(currentCoords.latitude, currentCoords.longitude, currentUnits, currentLocationLabel);
                    saveWeatherConfig(); // Save newly detected geo-location
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  async (error) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn(`Geolocation error (${error.code}): ${error.message}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  showNotification(`Geolocation failed: ${error.message}. Using saved location.`, 'error', 4000);
                    // Fallback to initial config values if geolocation fails
Â  Â  Â  Â  Â  Â  Â  Â  Â  await actualFetchAndDisplayWeather(config.latitude, config.longitude, config.units, config.location_label);
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  { timeout: 10000, enableHighAccuracy: false }
Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  showNotification("Geolocation not available. Using saved location.", "info", 4000);
Â  Â  Â  Â  Â  Â  Â  await actualFetchAndDisplayWeather(config.latitude, config.longitude, config.units, config.location_label);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }

            // Initialize Google Places Autocomplete
            const initAutocomplete = () => {
                if (typeof google === 'undefined' || typeof google.maps === 'undefined' || typeof google.maps.places === 'undefined') {
                    console.warn("Google Maps Places library not loaded. Retrying...");
                    setTimeout(initAutocomplete, 500); // Retry after 500ms
                    return;
                }
                const autocomplete = new google.maps.places.Autocomplete(locationSearchInput, {
                    types: ['(cities)'], // Restrict to cities or broader geographical areas
                    fields: ['geometry', 'formatted_address', 'name']
                });

                autocomplete.addListener('place_changed', () => {
                    const place = autocomplete.getPlace();
                    if (!place.geometry) {
                        showNotification("No details available for input: '" + place.name + "'", "error");
                        return;
                    }

                    const newLat = place.geometry.location.lat();
                    const newLon = place.geometry.location.lng();
                    const newLabel = place.formatted_address || place.name;
                    
                    currentCoords = { latitude: newLat.toString(), longitude: newLon.toString() };
                    currentLocationLabel = newLabel;
                    updateWeather(); // Fetch weather for the new location
                    saveWeatherConfig(); // Save the new location to Firebase
                    settingsMenu.classList.remove('open'); // Close menu after selection
                });
            };
            // Call initAutocomplete once Google Maps API is loaded
            window.addEventListener('load', initAutocomplete);


            // Event Listeners for Weather Settings
            if (settingsBtn) {
                settingsBtn.addEventListener('click', (event) => {
                    event.stopPropagation(); // Prevent card hover effect / other clicks
                    settingsMenu.classList.toggle('open');
                });
            }

            // Close settings menu if clicking outside
            document.addEventListener('click', (event) => {
                const isClickInside = cardElement.contains(event.target);
                if (settingsMenu && !isClickInside && settingsMenu.classList.contains('open')) {
                    settingsMenu.classList.remove('open');
                }
            });


            unitToggleBtns.forEach(button => {
                button.addEventListener('click', () => {
                    const selectedUnit = button.dataset.unit;
                    if (selectedUnit !== currentUnits) {
                        currentUnits = selectedUnit;
                        unitToggleBtns.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        updateWeather(); // Fetch weather with new units
                        saveWeatherConfig(); // Save the new unit preference
                    }
                });
            });

            // Set initial active unit button
            unitToggleBtns.forEach(btn => {
                if (btn.dataset.unit === currentUnits) {
                    btn.classList.add('active');
                }
            });

Â  Â  Â  Â  Â  if (refreshBtn) {
Â  Â  Â  Â  Â  Â  refreshBtn.addEventListener('click', updateWeather);
Â  Â  Â  Â  Â  }

            // Initial load of config and weather
            const initialConfig = await loadWeatherConfig();
            if (initialConfig) {
                currentCoords = { latitude: initialConfig.latitude, longitude: initialConfig.longitude };
                currentUnits = initialConfig.units;
                currentLocationLabel = initialConfig.location_label;
                // Update unit buttons based on loaded config
                unitToggleBtns.forEach(btn => {
                    if (btn.dataset.unit === currentUnits) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            } else {
                // If no config found, save the default one
                saveWeatherConfig();
            }

Â  Â  Â  Â  Â  updateWeather();
Â  Â  Â  Â  Â  setInterval(updateWeather, 30 * 60 * 1000);
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  templateId: 'clock_widget', title: 'Current Time', icon: 'ğŸ•’', type: 'medium',
Â  Â  Â  Â  contentGenerator: () => `
Â  Â  Â  Â  Â  Â  <div class="clock-display" id="clockTime">00:00:00</div>
Â  Â  Â  Â  Â  Â  <div class="date-display" id="clockDate">Monday, January 1, 2024</div>
Â  Â  Â  Â  Â  Â  <div class="additional-time-info">
Â  Â  Â  Â  Â  Â  Â  Â  <span id="clockDayOfYear">Day: ---</span> | <span id="clockWeekNum">Week: --</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `,
Â  Â  Â  Â  onMount: (cardElement) => {
Â  Â  Â  Â  Â  const timeEl = cardElement.querySelector('#clockTime');
Â  Â  Â  Â  Â  const dateEl = cardElement.querySelector('#clockDate');
Â  Â  Â  Â  Â  const dayOfYearEl = cardElement.querySelector('#clockDayOfYear');
Â  Â  Â  Â  Â  const weekNumEl = cardElement.querySelector('#clockWeekNum');

Â  Â  Â  Â  Â  function updateClock() {
Â  Â  Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  Â  Â  timeEl.textContent = now.toLocaleTimeString();
Â  Â  Â  Â  Â  Â  dateEl.textContent = now.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

Â  Â  Â  Â  Â  Â  const start = new Date(now.getFullYear(), 0, 0);
Â  Â  Â  Â  Â  Â  const diff = (now - start) + ((start.getTimezoneOffset() - now.getTimezoneOffset()) * 60 * 1000);
Â  Â  Â  Â  Â  Â  const oneDay = 1000 * 60 * 60 * 24;
Â  Â  Â  Â  Â  Â  const dayOfYear = Math.floor(diff / oneDay);
Â  Â  Â  Â  Â  Â  if (dayOfYearEl) dayOfYearEl.textContent = `Day: ${dayOfYear}`;

Â  Â  Â  Â  Â  Â  const tempDate = new Date(now.valueOf());
Â  Â  Â  Â  Â  Â  tempDate.setDate(tempDate.getDate() + 3 - (tempDate.getDay() + 6) % 7);
Â  Â  Â  Â  Â  Â  const week1 = new Date(tempDate.getFullYear(), 0, 4);
Â  Â  Â  Â  Â  Â  const weekNumber = 1 + Math.round(((tempDate.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
Â  Â  Â  Â  Â  Â  if (weekNumEl) weekNumEl.textContent = `Week: ${weekNumber}`;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  updateClock();
Â  Â  Â  Â  Â  setInterval(updateClock, 1000);
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  templateId: 'stopwatch_widget', title: 'Stopwatch', icon: 'â±ï¸', type: 'small',
Â  Â  Â  Â  contentGenerator: () => `
Â  Â  Â  Â  Â  Â  <div class="stopwatch-display">00:00:00.00</div>
Â  Â  Â  Â  Â  Â  <div class="controls-flex">
Â  Â  Â  Â  Â  Â  Â  Â  <button data-action="start">Start</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button data-action="stop" style="display:none;">Stop</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button data-action="reset">Reset</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `,
Â  Â  Â  Â  onMount: (cardElement) => {
Â  Â  Â  Â  Â  Â  const display = cardElement.querySelector('.stopwatch-display');
Â  Â  Â  Â  Â  Â  const startBtn = cardElement.querySelector('button[data-action="start"]');
Â  Â  Â  Â  Â  Â  const stopBtn = cardElement.querySelector('button[data-action="stop"]');
Â  Â  Â  Â  Â  Â  const resetBtn = cardElement.querySelector('button[data-action="reset"]');
Â  Â  Â  Â  Â  Â  let startTime = null, intervalId = null, elapsedTime = 0;
Â  Â  Â  Â  Â  Â  function formatTime(ms) {
Â  Â  Â  Â  Â  Â  Â  Â  const totalSeconds = Math.floor(ms / 1000);
Â  Â  Â  Â  Â  Â  Â  Â  const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
Â  Â  Â  Â  Â  Â  Â  Â  const minutes = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
Â  Â  Â  Â  Â  Â  Â  Â  const seconds = (totalSeconds % 60).toString().padStart(2, '0');
Â  Â  Â  Â  Â  Â  Â  Â  const centiseconds = Math.floor((ms % 1000) / 10).toString().padStart(2, '0');
Â  Â  Â  Â  Â  Â  Â  Â  return `${hours}:${minutes}:${seconds}.${centiseconds}`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  function updateDisplay() {
Â  Â  Â  Â  Â  Â  Â  Â  display.textContent = formatTime(elapsedTime + (startTime ? (Date.now() - startTime) : 0));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  startBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!intervalId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startTime = Date.now();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  intervalId = setInterval(updateDisplay, 33);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startBtn.style.display = 'none'; stopBtn.style.display = 'inline-block';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  stopBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (intervalId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(intervalId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  elapsedTime += (Date.now() - startTime);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  intervalId = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startTime = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateDisplay();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startBtn.style.display = 'inline-block'; stopBtn.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  resetBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (intervalId) { clearInterval(intervalId); intervalId = null; }
Â  Â  Â  Â  Â  Â  Â  Â  elapsedTime = 0;
Â  Â  Â  Â  Â  Â  Â  Â  startTime = null;
Â  Â  Â  Â  Â  Â  Â  Â  updateDisplay();
Â  Â  Â  Â  Â  Â  Â  Â  startBtn.style.display = 'inline-block'; stopBtn.style.display = 'none';
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  display.textContent = formatTime(0);
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  templateId: 'timer_widget', title: 'Timer', icon: 'â²ï¸', type: 'small',
Â  Â  Â  Â  contentGenerator: () => `
Â  Â  Â  Â  Â  Â  <div class="timer-inputs">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="timer-h" placeholder="HH" min="0" value="0"> :
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="timer-m" placeholder="MM" min="0" max="59" value="5"> :
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="timer-s" placeholder="SS" min="0" max="59" value="0">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="timer-display-value">00:05:00.00</div>
Â  Â  Â  Â  Â  Â  <div class="controls-flex">
Â  Â  Â  Â  Â  Â  Â  Â  <button data-action="start">Start</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button data-action="pause" style="display:none;">Pause</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button data-action="reset">Reset</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `,
Â  Â  Â  Â  onMount: (cardElement) => {
Â  Â  Â  Â  Â  Â  const hInput = cardElement.querySelector('#timer-h');
Â  Â  Â  Â  Â  Â  const mInput = cardElement.querySelector('#timer-m');
Â  Â  Â  Â  Â  Â  const sInput = cardElement.querySelector('#timer-s');
Â  Â  Â  Â  Â  Â  const display = cardElement.querySelector('.timer-display-value');
Â  Â  Â  Â  Â  Â  const startBtn = cardElement.querySelector('button[data-action="start"]');
Â  Â  Â  Â  Â  Â  const pauseBtn = cardElement.querySelector('button[data-action="pause"]');
Â  Â  Â  Â  Â  Â  const resetBtn = cardElement.querySelector('button[data-action="reset"]');
Â  Â  Â  Â  Â  Â  let intervalId, targetTime, remainingTime = 0;
Â  Â  Â  Â  Â  Â  let initialH = 0, initialM = 5, initialS = 0;

Â  Â  Â  Â  Â  Â  function formatTime(ms) {
Â  Â  Â  Â  Â  Â  Â  Â  if (ms < 0) ms = 0;
Â  Â  Â  Â  Â  Â  Â  Â  const totalSeconds = Math.floor(ms / 1000);
Â  Â  Â  Â  Â  Â  Â  Â  const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
Â  Â  Â  Â  Â  Â  Â  Â  const minutes = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
Â  Â  Â  Â  Â  Â  Â  Â  const seconds = (totalSeconds % 60).toString().padStart(2, '0');
Â  Â  Â  Â  Â  Â  Â  Â  const centiseconds = Math.floor((ms % 1000) / 10).toString().padStart(2, '0');
Â  Â  Â  Â  Â  Â  Â  Â  return `${hours}:${minutes}:${seconds}.${centiseconds}`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function parseInputsToMs() {
Â  Â  Â  Â  Â  Â  Â  Â  const h = parseInt(hInput.value) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  const m = parseInt(mInput.value) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  const s = parseInt(sInput.value) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  return (h * 3600 + m * 60 + s) * 1000;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  function updateInputDisplay() {
Â  Â  Â  Â  Â  Â  Â  Â  display.textContent = formatTime(parseInputsToMs());
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  [hInput, mInput, sInput].forEach(input => {
Â  Â  Â  Â  Â  Â  Â  Â  input.addEventListener('input', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!intervalId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  remainingTime = parseInputsToMs();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateInputDisplay();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  input.addEventListener('blur', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (input.id === 'timer-m' || input.id === 'timer-s') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (parseInt(input.value) > 59) input.value = 59;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (parseInt(input.value) < 0) input.value = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (input.id === 'timer-h') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (parseInt(input.value) < 0) input.value = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!intervalId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  remainingTime = parseInputsToMs();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateInputDisplay();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  function startTimer() {
Â  Â  Â  Â  Â  Â  Â  Â  if (intervalId) clearInterval(intervalId);
Â  Â  Â  Â  Â  Â  Â  Â  if(remainingTime <= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  remainingTime = parseInputsToMs();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (remainingTime <= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showNotification("Please set a timer duration.", "info");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  targetTime = Date.now() + remainingTime;
Â  Â  Â  Â  Â  Â  Â  Â  intervalId = setInterval(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  remainingTime = targetTime - Date.now();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (remainingTime <= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(intervalId); intervalId = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  remainingTime = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  display.textContent = formatTime(0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showNotification('Timer Finished!', 'success');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try { new Audio('https://interactive-examples.mdn.mozilla.net/media/cc0-audio/bell-ringing-01.mp3').play(); } catch(e) { console.warn("Audio notification failed", e); }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startBtn.style.display = 'inline-block'; pauseBtn.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  [hInput, mInput, sInput].forEach(inp => inp.disabled = false);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  display.textContent = formatTime(remainingTime);
Â  Â  Â  Â  Â  Â  Â  Â  }, 33);
Â  Â  Â  Â  Â  Â  Â  Â  startBtn.style.display = 'none'; pauseBtn.style.display = 'inline-block';
Â  Â  Â  Â  Â  Â  Â  Â  [hInput, mInput, sInput].forEach(inp => inp.disabled = true);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  startBtn.addEventListener('click', startTimer);
Â  Â  Â  Â  Â  Â  pauseBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (intervalId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(intervalId); intervalId = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startBtn.style.display = 'inline-block'; pauseBtn.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  [hInput, mInput, sInput].forEach(inp => inp.disabled = false);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  resetBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (intervalId) { clearInterval(intervalId); intervalId = null; }
Â  Â  Â  Â  Â  Â  Â  Â  hInput.value = initialH; mInput.value = initialM; sInput.value = initialS;
Â  Â  Â  Â  Â  Â  Â  Â  remainingTime = parseInputsToMs();
Â  Â  Â  Â  Â  Â  Â  Â  updateInputDisplay();
Â  Â  Â  Â  Â  Â  Â  Â  startBtn.style.display = 'inline-block'; pauseBtn.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  [hInput, mInput, sInput].forEach(inp => inp.disabled = false);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  hInput.value = initialH; mInput.value = initialM; sInput.value = initialS;
Â  Â  Â  Â  Â  Â  remainingTime = parseInputsToMs();
Â  Â  Â  Â  Â  Â  updateInputDisplay();
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  templateId: 'quick_actions_widget', title: 'Quick Actions', icon: 'âš¡', type: 'small', // Changed to 'small'
Â  Â  Â  Â  contentGenerator: () => `
Â  Â  Â  Â  Â  Â  <div class="quick-actions-list">
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="window.location.href='proxies.html'">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="icon">ğŸ›¡ï¸</span> <span class="text">Proxy</span> <span class="arrow">â†’</span>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="window.location.href='games.html'">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="icon">ğŸ®</span> <span class="text">Games</span> <span class="arrow">â†’</span>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="window.location.href='soundboard.html'">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="icon">ğŸµ</span> <span class="text">Soundboard</span> <span class="arrow">â†’</span>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="window.location.href='settings.html'">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="icon">âš™ï¸</span> <span class="text">Settings</span> <span class="arrow">â†’</span>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `,
Â  Â  Â  Â  onMount: () => {}
Â  Â  Â  }
Â  Â  ];

Â  Â  // --- Authentication & Initial Load ---
Â  Â  firebase.auth().onAuthStateChanged(async user => {
Â  Â  Â  if (!user) {
Â  Â  Â  Â  return location.href = '../login.html';
Â  Â  Â  }
Â  Â  Â  document.getElementById('userEmail').textContent = user.email;
Â  Â  Â  try {
Â  Â  Â  Â  const userDocRef = dbRef();
Â  Â  Â  Â  if (!userDocRef) return;
Â  Â  Â  Â  const doc = await userDocRef.get();
Â  Â  Â  Â  const userData = doc.exists ? doc.data() : {};
Â  Â  Â  Â  userNameEl.textContent = userData.username || user.displayName || 'Welcome User';
Â  Â  Â  Â  setupFixedDashboardLayout();
Â  Â  Â  Â  updateMarquees();
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  document.querySelectorAll('.dashboard-card').forEach((card, index) => {
Â  Â  Â  Â  Â  Â  card.style.animationDelay = `${index * 0.08}s`;
Â  Â  Â  Â  Â  Â  card.classList.add('fade-in');
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }, 100);
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Error loading user data:', error);
Â  Â  Â  Â  setupFixedDashboardLayout();
Â  Â  Â  }
Â  Â  });

Â  Â  function updateMarquees() {
Â  Â  Â  marqueeEls.forEach(el => {
Â  Â  Â  Â  el.classList.remove('marquee-active');
Â  Â  Â  Â  void el.offsetWidth;
Â  Â  Â  Â  el.classList.add('marquee-active');
Â  Â  Â  });
Â  Â  }

Â  Â  function createCardDOMElement(template) {
Â  Â  Â  const newCard = document.createElement('div');
Â  Â  Â  newCard.classList.add('dashboard-card');
Â  Â  Â  newCard.dataset.id = `${template.templateId}_${Date.now()}`;
Â  Â  Â  newCard.dataset.templateId = template.templateId;
Â  Â  Â  newCard.dataset.cardType = template.type || 'full';
Â  Â  Â  const header = document.createElement('div');
Â  Â  Â  header.classList.add('card-header');
Â  Â  Â  const iconEl = document.createElement('div');
Â  Â  Â  iconEl.classList.add('card-icon');
Â  Â  Â  iconEl.textContent = template.icon;
Â  Â  Â  const titleEl = document.createElement('h4');
Â  Â  Â  titleEl.classList.add('card-title');
Â  Â  Â  titleEl.textContent = template.title;
Â  Â  Â  header.appendChild(iconEl);
Â  Â  Â  header.appendChild(titleEl);

Â  Â  Â  if (template.templateId === 'weather_large_widget') {
            // Settings button
            const settingsButton = document.createElement('button');
            settingsButton.className = 'weather-settings-btn';
            settingsButton.title = 'Weather Settings';
            const settingsImg = document.createElement('img');
            settingsImg.src = '../images/settings-icon.png'; // Assuming you have a settings icon
            settingsImg.alt = 'Settings';
            settingsButton.appendChild(settingsImg);
            header.appendChild(settingsButton);

Â  Â  Â  Â  const refreshButton = document.createElement('button');
Â  Â  Â  Â  refreshButton.className = 'weather-refresh-btn';
Â  Â  Â  Â  refreshButton.title = 'Refresh Weather & Location';
Â  Â  Â  Â Â 
Â  Â  Â  Â  const refreshImg = document.createElement('img');
Â  Â  Â  Â  refreshImg.src = '../images/refresh-dark.png';
Â  Â  Â  Â  refreshImg.alt = 'Refresh';
Â  Â  Â  Â  refreshButton.appendChild(refreshImg);
Â  Â  Â  Â  header.appendChild(refreshButton);
Â  Â  Â  }
Â  Â  Â  const contentWrapper = document.createElement('div');
Â  Â  Â  contentWrapper.classList.add('card-content-inner');
Â  Â  Â  contentWrapper.innerHTML = template.contentGenerator(template.config || {});
Â  Â  Â  newCard.appendChild(header);
Â  Â  Â  newCard.appendChild(contentWrapper);
Â  Â  Â Â 
Â  Â  Â  // Wrap onMount in a try-catch for robustness
Â  Â  Â  if (template.onMount && typeof template.onMount === 'function') {
Â  Â  Â  Â  const cardId = newCard.dataset.templateId;
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  template.onMount(newCard, template.config || {});
Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  console.error(`Error during onMount for card ${cardId}:`, e);
Â  Â  Â  Â  Â  Â  // Display an error message inside the card if mounting fails
Â  Â  Â  Â  Â  Â  const contentInner = newCard.querySelector('.card-content-inner');
Â  Â  Â  Â  Â  Â  if (contentInner) {
Â  Â  Â  Â  Â  Â  Â  Â  contentInner.innerHTML = `<p style="color: red; text-align: center; padding: 20px;">Failed to load widget content.<br>Check console for details.</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  contentInner.style.display = 'block'; // Ensure it's visible if contentGenerator set display: flex etc.
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }, 0);
Â  Â  Â  }
Â  Â  Â  return newCard;
Â  Â  }

Â  Â  function addCardToDashboard(templateId) {
Â  Â  Â  const template = availableCardTemplates.find(t => t.templateId === templateId);
Â  Â  Â  if (!template) {
Â  Â  Â  Â  console.warn(`Template ${templateId} not found.`);
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  const cardDom = createCardDOMElement(template);
Â  Â  Â  dashboardGrid.appendChild(cardDom);
Â  Â  }

Â  Â  function setupFixedDashboardLayout() {
Â  Â  Â  Â  dashboardGrid.innerHTML = ''; // Clear existing cards
Â  Â  Â  Â  addCardToDashboard('weather_large_widget');
Â  Â  Â  Â  addCardToDashboard('clock_widget');
Â  Â  Â  Â  addCardToDashboard('stopwatch_widget');
Â  Â  Â  Â  addCardToDashboard('timer_widget');
Â  Â  Â  Â  addCardToDashboard('quick_actions_widget');
Â  Â  }

Â  Â  function showNotification(message, type = 'info', duration = 3000) {
Â  Â  Â  const notification = document.createElement('div');
Â  Â  Â  notification.className = `notification ${type}`;
Â  Â  Â  notification.textContent = message;
Â  Â  Â  Object.assign(notification.style, {
Â  Â  Â  Â  position: 'fixed', bottom: '20px', right: '20px', padding: '12px 20px',
Â  Â  Â  Â  borderRadius: '8px', color: 'white', fontWeight: '600', zIndex: '10000',
Â  Â  Â  Â  transform: 'translateY(150%)', transition: 'transform 0.4s ease-in-out, background 0.3s',
Â  Â  Â  Â  boxShadow: '0 4px 12px rgba(0,0,0,0.15)'
Â  Â  Â  });
Â  Â  Â  const colors = {
Â  Â  Â  Â  success: 'linear-gradient(135deg, #28a745, #20c997)',
Â  Â  Â  Â  error: 'linear-gradient(135deg, #dc3545, #e83e8c)',
Â  Â  Â  Â  info: 'linear-gradient(135deg, #6720bd, #8a2be2)'
Â  Â  Â  };
Â  Â  Â  notification.style.background = colors[type] || colors.info;
Â  Â  Â  document.body.appendChild(notification);
Â  Â  Â  setTimeout(() => { notification.style.transform = 'translateY(0)'; }, 100);
Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  notification.style.transform = 'translateY(150%)';
Â  Â  Â  Â  setTimeout(() => { if (document.body.contains(notification)) document.body.removeChild(notification); }, 400);
Â  Â  Â  }, duration);
Â  Â  }

Â  Â  window.addEventListener('resize', () => { setTimeout(updateMarquees, 300); });
Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  document.documentElement.style.scrollBehavior = 'smooth';
Â  Â  });

Â  Â  const handleLogout = () => {
Â  Â  Â  firebase.auth().signOut().then(() => (location.href = '../login.html')).catch(error => console.error('Logout error:', error));
Â  Â  };
Â  Â  document.getElementById('logoutBtn').onclick = handleLogout;
Â  Â  document.getElementById('signOutLink').onclick = handleLogout;

Â  Â  const toggleSidebarBtn = document.getElementById('toggleSidebar');
Â  Â  const sidebar = document.getElementById('sidebar');
Â  Â  toggleSidebarBtn.addEventListener('click', () => {
Â  Â  Â  sidebar.classList.toggle('collapsed');
Â  Â  Â  setTimeout(updateMarquees, 550);
Â  Â  });
Â  </script>
</body>
</html>
