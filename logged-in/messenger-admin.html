<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4SP - MESSENGER</title>
    <link rel="stylesheet" href="../css/style.css"> 
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <script defer src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

    <style>
        :root {
            --v4-bg-gradient: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
            --v4-card-bg: #fff;
            --v4-text-primary: #333;
            --v4-text-secondary: #555;
            --v4-purple-accent: #6720bd;
            --v4-purple-accent-darker: #5a1aa8;
            --v4-purple-gradient: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            --v4-border-light: #ddd;
            --v4-border-softer: #eee;
            --v4-input-bg: #f8f9fa;
            --v4-input-border: #ccc;
            --v4-font-primary: 'PrimaryFont', sans-serif;
            --v4-font-secondary: 'SecondaryFont', sans-serif;
            --navbar-height: 60px;
        }
        .hidden { display: none !important; }
        
        /* Hide body by default to prevent flash of unauthenticated content */
        body { display: none; }

        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
            font-family: var(--v4-font-primary);
            background: var(--v4-bg-gradient);
            color: var(--v4-text-primary);
        }

        /* New Navbar Styles */
        .navbar {
            height: var(--navbar-height);
            background: #2a2a2a;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1001; 
            box-sizing: border-box;
            flex-shrink: 0; /* Prevent navbar from shrinking */
        }
        .navbar-brand {
            font-size: 1.5em;
            font-weight: bold;
        }
        .navbar-user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        #user-email-display {
            font-size: 0.9em;
            color: #ccc;
        }
        .btn-logout {
            background: var(--v4-purple-accent);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
            font-family: var(--v4-font-primary);
        }
        .btn-logout:hover {
            background: var(--v4-purple-accent-darker);
        }


        .messenger-container-wrapper { 
            display: flex; 
            flex-grow: 1; /* Allow wrapper to fill remaining space */
            min-height: 0; /* Critical for flex-grow to work with scrollable children */
        }

        /* Contacts Menu */
        .contacts-menu {
            width: 280px;
            flex-shrink: 0;
            background: linear-gradient(180deg, #333 0%, #2a2a2a 100%);
            color: #fff;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #444;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .contacts-header { 
            padding: 20px 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid #444;
            flex-shrink: 0;
        }
        .contacts-header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #settingsBtn, #addContactBtn { background: none; border: 1px solid #fff; color: #fff; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
        #addContactBtn img { width: 16px; height: 16px; transform: rotate(45deg); }
        #settingsBtn img { 
            width: 18px; 
            height: 18px; 
            filter: invert(1) brightness(2) saturate(0);
        }
        #settingsBtn:hover, #addContactBtn:hover { background: var(--v4-purple-accent); border-color: var(--v4-purple-accent); }
        
        .contacts-list-container {
            flex-grow: 1;
            min-height: 0; 
            display: flex;
            flex-direction: column;
        }

        #contactsList { list-style: none; padding: 15px; margin: 0; overflow-y: auto; flex-grow: 1;}
        .contact-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-radius: 8px; margin-bottom: 8px; background-color: rgba(255,255,255,0.05); cursor: pointer; transition: background-color 0.2s; }
        .contact-item:hover { background-color: rgba(255,255,255,0.1); }
        .contact-info { flex-grow: 1; min-width: 0; }
        .contact-actions { display: flex; gap: 5px; }
        .contact-btn { background: rgba(255,255,255,0.2); border: none; color: #fff; padding: 5px; border-radius: 5px; cursor: pointer; transition: background 0.2s; font-size: 0.9em; }
        .contact-btn:hover { background: rgba(255,255,255,0.4); }

        .contacts-footer {
            padding: 15px;
            border-top: 1px solid #444;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
        }
        .contact-search-container {
            display: flex;
            align-items: center;
        }
        #contactSearchInput {
            width: 140px; 
            padding: 8px 12px;
            border-radius: 6px 0 0 6px;
            border: 1px solid #555;
            border-right: none;
            background: #2a2a2a;
            color: #fff;
            font-size: 0.9em;
        }
        #contactSearchInput::placeholder { color: #888; }
        #contactSortSelect {
            padding: 8px;
            border-radius: 0 6px 6px 0;
            border: 1px solid #555;
            background: #2a2a2a;
            color: #fff;
            cursor: pointer;
        }


        .main-messenger-content { 
            flex: 1; 
            padding: 30px; 
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
            overflow-y: auto;
        }
        .messenger-header { display: flex; justify-content: space-between; align-items: center; background: var(--v4-card-bg); padding: 20px 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .messenger-title { font-size: 2.2em; font-weight: bold; background: var(--v4-purple-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        
        .chat-window { display: flex; flex-direction: column; flex-grow: 1; background: var(--v4-card-bg); border-radius: 15px; box-shadow: 0 6px 30px rgba(0,0,0,0.08); overflow: hidden; min-height: 0; }
        #messages { flex-grow: 1; padding: 20px; overflow-y: auto; background: var(--v4-input-bg); }
        .message { margin-bottom: 12px; }
        .message .sender { font-weight: bold; color: var(--v4-purple-accent); }
        .message.system { color: var(--v4-text-secondary); font-style: italic; }
        
        .input-area { display: flex; gap: 10px; padding: 20px; border-top: 1px solid var(--v4-border-softer); background: #fff; }
        #message-input { flex-grow: 1; padding: 14px; border: 1px solid var(--v4-input-border); border-radius: 10px; background: var(--v4-input-bg); font-family: var(--v4-font-secondary); font-size: 1em; }
        #message-input:focus { box-shadow: 0 0 0 3px rgba(103, 32, 189, 0.3); border-color: var(--v4-purple-accent); outline: none; }

        .btn-primary { background: var(--v4-purple-gradient); color: white; border: none; padding: 14px 24px; border-radius: 10px; font-family: var(--v4-font-primary); text-transform: uppercase; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn-primary:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(103, 32, 189, 0.4); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
        .btn-cancel { background: #6c757d; color: white; border: none; padding: 14px 24px; border-radius: 10px; font-family: var(--v4-font-primary); text-transform: uppercase; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn-cancel:hover { background: #5a6268; transform: translateY(-3px); box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4); }
        .btn-leave { background: linear-gradient(135deg, #dc3545, #c82333); color: white; border: none; padding: 10px 18px; border-radius: 10px; font-family: var(--v4-font-primary); text-transform: uppercase; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn-leave:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4); }

        .status-bar { display: flex; justify-content: space-between; align-items: center; background: var(--v4-card-bg); padding: 15px 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .status-info, .connection-info { font-size: 0.9em; color: var(--v4-text-secondary); }
        #my-id { font-weight: bold; color: var(--v4-text-primary); cursor: pointer; }
        #connection-status.connected { cursor: pointer; font-weight: bold; }

        /* Marquee styles */
        .marquee-container { overflow: hidden; white-space: nowrap; position: relative; width: 100%; }
        .marquee-content-wrapper { display: inline-block; will-change: transform; }
        .marquee-content-wrapper.is-scrolling { animation: marquee-scroll 10s linear infinite; }
        .marquee-content-wrapper > span { display: inline-block; padding-right: 2em; }
        @keyframes marquee-scroll { from { transform: translateX(0); } to { transform: translateX(-50%); } }

        /* Modal */
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 2000; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; display: flex; align-items: center; justify-content: center; }
        .modal-backdrop.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background: var(--v4-card-bg); width: 90%; max-width: 500px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); display: flex; flex-direction: column; max-height: 90vh; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-backdrop.visible .modal-content { transform: scale(1); }
        .modal-header { padding: 20px 25px; border-bottom: 1px solid var(--v4-border-softer); position: relative; }
        .modal-header h2 { margin: 0; font-size: 1.5em; color: var(--v4-text-primary); }
        .modal-body { flex-grow: 1; overflow-y: auto; padding: 25px; }
        .modal-body .form-group { margin-bottom: 20px; }
        .modal-body label { font-weight: bold; color: var(--v4-text-secondary); margin-bottom: 8px; display: block; }
        .modal-body input[type="text"] { width: 100%; padding: 12px; border: 1px solid var(--v4-input-border); border-radius: 8px; background: var(--v4-input-bg); font-family: var(--v4-font-secondary); font-size: 1em; box-sizing: border-box; }
        .modal-footer { padding: 15px 25px; border-top: 1px solid var(--v4-border-softer); display: flex; justify-content: flex-end; align-items: center; gap: 10px; }
        .close-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; cursor: pointer; padding: 5px; line-height: 0; }
        .close-btn img { width: 20px; height: 20px; filter: invert(80%) sepia(0%) saturate(0%) hue-rotate(0deg) brightness(100%) contrast(100%); transition: filter 0.3s ease; }
        .close-btn:hover img { filter: invert(10%) sepia(10%) saturate(0%) hue-rotate(240deg) brightness(100%) contrast(100%); }

        /* Settings Modal Specifics */
        #blocked-ids-list {
            list-style: none;
            padding: 0;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--v4-border-light);
            border-radius: 8px;
        }
        .blocked-id-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid var(--v4-border-softer);
        }
        .blocked-id-item:last-child { border-bottom: none; }
        .unblock-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            font-size: 0.8em;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">4SP Messenger</div>
        <div class="navbar-user-info">
            <span id="user-email-display">Loading...</span>
            <button id="logout-button" class="btn-logout">Logout</button>
        </div>
    </nav>

    <div class="messenger-container-wrapper">
        <aside class="contacts-menu">
            <div class="contacts-header">
                <h3>Contacts</h3>
                <div class="contacts-header-actions">
                    <button id="settingsBtn" title="Settings"><img src="../images/gear-dark.png" alt="Settings"></button>
                    <button id="addContactBtn" title="Add New Contact"><img src="../images/cross-white.png" alt="Add"></button>
                </div>
            </div>
            <div class="contacts-list-container">
                <ul id="contactsList"></ul>
            </div>
            <div class="contacts-footer">
                <div class="contact-search-container">
                    <input type="text" id="contactSearchInput" placeholder="Search...">
                    <select id="contactSortSelect">
                        <option value="name">Sort by Name</option>
                        <option value="id">Sort by ID</option>
                    </select>
                </div>
            </div>
        </aside>

        <main class="main-messenger-content">
            <div class="messenger-header">
                <h2 class="messenger-title">MESSENGER üí¨</h2>
                <button id="leave-chat-btn" class="btn-leave hidden">Leave Chat</button>
            </div>
            
            <div class="status-bar">
                <div class="status-info">Your ID: <strong id="my-id" title="Click to see full ID">Generating...</strong></div>
                <div class="connection-info">Status: <strong id="connection-status">Initializing...</strong></div>
            </div>

            <div class="chat-window">
                <div id="messages"></div>
                <div class="input-area">
                    <input type="text" id="message-input" placeholder="Type a message... (Press Enter to send)">
                    <button id="send-button" class="btn-primary">Send</button>
                </div>
            </div>
        </main>
    </div>

    <div id="contactModal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header"> 
                <h2 id="contactModalTitle">Add New Contact</h2> 
                <button id="closeContactModalBtn" class="close-btn"><img src="../images/cross-white.png" alt="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="contactIdInput">
                <div class="form-group"> <label for="contactNicknameInput">Nickname</label> <input type="text" id="contactNicknameInput" maxlength="20" placeholder="e.g., Best Friend"> </div>
                <div class="form-group"> <label for="contactPeerIdInput">Peer ID</label> <input type="text" id="contactPeerIdInput" maxlength="30" placeholder="Enter their 18-digit code"> </div>
            </div>
            <div class="modal-footer"> 
                <button id="cancelContactModalBtn" class="btn-cancel">Cancel</button>
                <button id="saveContactBtn" class="btn-primary">Save Contact</button> 
            </div>
        </div>
    </div>
    <div id="settingsModal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settings</h2>
                <button id="closeSettingsModalBtn" class="close-btn"><img src="../images/cross-white.png" alt="Close"></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="blockIdInput">Block a Peer ID</label>
                    <input type="text" id="blockIdInput" placeholder="Enter Peer ID to block">
                </div>
                <button id="addBlockBtn" class="btn-primary" style="width: 100%;">Block ID</button>
                <h4 style="margin-top: 30px; margin-bottom: 10px; color: var(--v4-text-secondary);">Blocked IDs</h4>
                <ul id="blocked-ids-list"></ul>
            </div>
            <div class="modal-footer">
                <button id="doneSettingsBtn" class="btn-primary">Done</button>
            </div>
        </div>
    </div>
    <div id="fullIdModal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header"> 
                <h2>Your Shareable ID</h2> 
                <button id="closeIdModalBtn" class="close-btn"><img src="../images/cross-white.png" alt="Close"></button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <p>Share this code with a friend to connect:</p>
                <input type="text" id="fullIdDisplay" readonly style="font-size: 1.2em; text-align: center; cursor: copy;" title="Click to copy">
            </div>
            <div class="modal-footer"> 
                <button id="copyIdBtn" class="btn-primary">Copy ID</button>
            </div>
        </div>
    </div>
    <div id="peerInfoModal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header"> 
                <h2 id="peerInfoTitle">Peer Information</h2> 
                <button id="closePeerInfoModalBtn" class="close-btn"><img src="../images/cross-white.png" alt="Close"></button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <p id="peerInfoDescription"></p>
                <input type="text" id="peerInfoIdDisplay" readonly style="font-size: 1.2em; text-align: center; cursor: copy;" title="Click to copy">
            </div>
            <div class="modal-footer"> 
                 <button id="copyPeerIdBtn" class="btn-primary">Copy ID</button>
            </div>
        </div>
    </div>


    <script>
    // This function contains all the original messenger app logic.
    // It will only be called after Firebase confirms the user is authorized.
    function startMessengerApp() {
        
        function initializeMarquees() {
            document.querySelectorAll('.contact-item .marquee-container').forEach(container => {
                const wrapper = container.querySelector('.marquee-content-wrapper');
                if (!wrapper) return;
                const firstSpan = wrapper.querySelector('span');
                if (!firstSpan) return;
                
                if (wrapper.children.length > 1) {
                    wrapper.removeChild(wrapper.lastChild);
                }
                wrapper.classList.remove('is-scrolling');

                const needsScrolling = firstSpan.scrollWidth > container.clientWidth;
                
                if (needsScrolling) {
                    const secondSpan = firstSpan.cloneNode(true);
                    wrapper.appendChild(secondSpan);
                    wrapper.classList.add('is-scrolling');
                }
            });
        }

        // --- DOM Element References ---
        const myIdSpan = document.getElementById('my-id');
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const connectionStatusSpan = document.getElementById('connection-status');
        const contactsList = document.getElementById('contactsList');
        const leaveChatBtn = document.getElementById('leave-chat-btn');
        const contactSearchInput = document.getElementById('contactSearchInput');
        const contactSortSelect = document.getElementById('contactSortSelect');
        const contactModal = document.getElementById('contactModal');
        const settingsModal = document.getElementById('settingsModal');
        const fullIdModal = document.getElementById('fullIdModal');
        const peerInfoModal = document.getElementById('peerInfoModal');
        const fullIdDisplay = document.getElementById('fullIdDisplay');
        let peer = null;
        let conn = null;
        let localPeerId = null;
        let isLocalDisconnect = false;
        const CONTACTS_STORAGE_KEY = '4sp-messenger-contacts';
        const BLOCKED_IDS_STORAGE_KEY = '4sp-messenger-blocked-ids';

        function getBlockedIds() {
            return JSON.parse(localStorage.getItem(BLOCKED_IDS_STORAGE_KEY) || '[]');
        }
        function saveBlockedIds(ids) {
            localStorage.setItem(BLOCKED_IDS_STORAGE_KEY, JSON.stringify(ids));
            renderBlockedIds();
        }
        function blockId(idToBlock) {
            if (!idToBlock || idToBlock.trim() === '') return;
            let blockedIds = getBlockedIds();
            if (!blockedIds.includes(idToBlock)) {
                blockedIds.push(idToBlock);
                saveBlockedIds(blockedIds);
            }
        }
        function unblockId(idToUnblock) {
            let blockedIds = getBlockedIds();
            blockedIds = blockedIds.filter(id => id !== idToUnblock);
            saveBlockedIds(blockedIds);
        }
        function renderBlockedIds() {
            const list = document.getElementById('blocked-ids-list');
            const blockedIds = getBlockedIds();
            list.innerHTML = '';
            if (blockedIds.length === 0) {
                list.innerHTML = `<li class="blocked-id-item" style="justify-content:center; color:#888;">No IDs blocked.</li>`;
            } else {
                blockedIds.forEach(id => {
                    const li = document.createElement('li');
                    li.className = 'blocked-id-item';
                    li.innerHTML = `<span>${id}</span><button class="unblock-btn" data-id="${id}">Unblock</button>`;
                    list.appendChild(li);
                });
            }
        }
        function generateId() {
            const chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 18; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        function initializePeer() {
            const userId = localStorage.getItem('4sp-messenger-id') || generateId();
            peer = new Peer(userId, {});
            peer.on('open', id => {
                console.log('My peer ID is: ' + id);
                localPeerId = id;
                localStorage.setItem('4sp-messenger-id', id);
                myIdSpan.textContent = `${id.substring(0, 8)}...`;
                fullIdDisplay.value = id;
                updateUiState('disconnected');
            });
            peer.on('connection', newConnection => {
                const blockedIds = getBlockedIds();
                if (blockedIds.includes(newConnection.peer)) {
                    newConnection.on('open', () => {
                        newConnection.send({ type: 'blocked', message: `User ${localPeerId} has blocked you.` });
                        setTimeout(() => newConnection.close(), 500);
                    });
                    return;
                }
                if (conn && conn.open) {
                    newConnection.close();
                    return;
                }
                conn = newConnection;
                setupConnectionEvents(conn);
            });
            peer.on('error', err => {
                console.error('PeerJS Error:', err);
                addMessage('System', `Error: ${err.message}`);
                if (err.type === 'peer-unavailable' || err.type === 'network') {
                    addMessage('System', `Could not connect. Friend may be offline or their ID is incorrect.`);
                    updateUiState('disconnected');
                }
            });
        }
        function getPeerName(peerId) {
            const contact = getContacts().find(c => c.peerId === peerId);
            return contact ? contact.nickname : `Peer (${peerId.substring(0, 6)}...)`;
        }
        function setupConnectionEvents(connection) {
            connection.on('open', () => {
                const peerName = getPeerName(connection.peer);
                updateUiState('connected', peerName);
                addMessage('System', `You are now connected to ${peerName}.`);
            });
            connection.on('data', data => {
                if (typeof data === 'object' && data.type === 'blocked') {
                    addMessage('System', data.message);
                    disconnect();
                    return;
                }
                const senderName = getPeerName(connection.peer);
                addMessage(senderName, data);
            });
            connection.on('close', () => {
                const peerName = getPeerName(connection.peer);
                clearMessages();
                if (isLocalDisconnect) {
                    addMessage('System', 'You have disconnected.');
                    isLocalDisconnect = false;
                } else {
                    addMessage('System', `${peerName} has disconnected.`);
                }
                addMessage('System', 'Welcome back! Ready for a new chat.');
                conn = null;
                updateUiState('disconnected');
            });
        }
        function connectToPeer(peerId) {
            if (!peerId || peerId.trim() === '') {
                addMessage('System', 'Invalid or empty Peer ID provided.');
                return;
            }
            if (peerId === localPeerId) {
                addMessage('System', "You can't connect to yourself!");
                return;
            }
            if (conn) {
                conn.close();
            }
            clearMessages();
            const peerName = getPeerName(peerId);
            updateUiState('connecting', peerName);
            conn = peer.connect(peerId);
            setupConnectionEvents(conn);
        }
        function disconnect() {
            if (conn) {
                isLocalDisconnect = true;
                conn.close();
            }
        }
        function updateUiState(state, peerName = '') {
            sendButton.disabled = state !== 'connected';
            messageInput.disabled = state !== 'connected';
            leaveChatBtn.classList.toggle('hidden', state !== 'connected');
            connectionStatusSpan.classList.remove('connected');
            switch (state) {
                case 'connected':
                    connectionStatusSpan.textContent = `Connected to ${peerName}`;
                    connectionStatusSpan.classList.add('connected');
                    break;
                case 'connecting':
                    connectionStatusSpan.textContent = `Connecting to ${peerName}...`;
                    break;
                case 'disconnected':
                default:
                    connectionStatusSpan.textContent = 'Ready to connect';
                    break;
            }
        }
        function addMessage(sender, message) {
            const messageEl = document.createElement('div');
            messageEl.classList.add('message');
            const senderEl = document.createElement('span');
            senderEl.classList.add('sender');
            senderEl.textContent = `${sender}: `;
            const contentEl = document.createTextNode(message);
            if (sender === 'System') {
                messageEl.classList.add('system');
                messageEl.appendChild(contentEl);
            } else {
                messageEl.appendChild(senderEl);
                messageEl.appendChild(contentEl);
            }
            messagesDiv.appendChild(messageEl);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        function clearMessages() {
            messagesDiv.innerHTML = '';
        }
        function getContacts() {
            return JSON.parse(localStorage.getItem(CONTACTS_STORAGE_KEY) || '[]');
        }
        function saveContacts(contacts) {
            localStorage.setItem(CONTACTS_STORAGE_KEY, JSON.stringify(contacts));
            renderContacts();
        }
        function renderContacts() {
            let contacts = getContacts();
            const searchTerm = contactSearchInput.value.toLowerCase();
            const sortType = contactSortSelect.value;
            if (searchTerm) {
                contacts = contacts.filter(contact =>
                    contact.nickname.toLowerCase().includes(searchTerm) ||
                    contact.peerId.toLowerCase().includes(searchTerm)
                );
            }
            contacts.sort((a, b) => {
                if (sortType === 'name') {
                    return a.nickname.localeCompare(b.nickname);
                } else {
                    return a.peerId.localeCompare(b.peerId);
                }
            });
            contactsList.innerHTML = '';
            if (contacts.length === 0) {
                contactsList.innerHTML = `<li style="text-align:center; font-size: 0.9em; color: #aaa; padding: 10px 0;">No contacts found.</li>`;
            } else {
                contacts.forEach(contact => {
                    const li = document.createElement('li');
                    li.className = 'contact-item';
                    li.innerHTML = `<div class="contact-info marquee-container"><div class="marquee-content-wrapper"><span class="contact-name">${contact.nickname}</span></div></div><div class="contact-actions"><button class="contact-btn chat" title="Chat with ${contact.nickname}">üí¨</button><button class="contact-btn edit" title="Edit ${contact.nickname}">‚úèÔ∏è</button><button class="contact-btn delete" title="Delete ${contact.nickname}">üóëÔ∏è</button></div>`;
                    li.querySelector('.chat').addEventListener('click', (e) => { e.stopPropagation(); connectToPeer(contact.peerId); });
                    li.querySelector('.edit').addEventListener('click', (e) => { e.stopPropagation(); openContactModal(contact.id); });
                    li.querySelector('.delete').addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (confirm(`Are you sure you want to delete ${contact.nickname}?`)) {
                            deleteContact(contact.id);
                        }
                    });
                    li.addEventListener('click', (e) => {
                        if (e.target.closest('.contact-actions')) return;
                        openPeerInfoModal(contact.nickname, contact.peerId, true);
                    });
                    contactsList.appendChild(li);
                });
            }
            initializeMarquees();
        }
        function saveContact() {
            const id = document.getElementById('contactIdInput').value;
            const nickname = document.getElementById('contactNicknameInput').value.trim();
            const peerId = document.getElementById('contactPeerIdInput').value.trim();
            if (!nickname || !peerId) {
                alert('Both Nickname and Peer ID are required.');
                return;
            }
            let contacts = getContacts();
            if (id) {
                const contact = contacts.find(c => c.id === id);
                if (contact) {
                    contact.nickname = nickname;
                    contact.peerId = peerId;
                }
            } else {
                contacts.push({ id: Date.now().toString(), nickname, peerId });
            }
            saveContacts(contacts);
            closeContactModal();
        }
        function deleteContact(id) {
            let contacts = getContacts();
            contacts = contacts.filter(c => c.id !== id);
            saveContacts(contacts);
        }
        function openContactModal(id = null) {
            const title = document.getElementById('contactModalTitle');
            const idInput = document.getElementById('contactIdInput');
            const nicknameInput = document.getElementById('contactNicknameInput');
            const peerIdInput = document.getElementById('contactPeerIdInput');
            if (id) {
                const contact = getContacts().find(c => c.id === id);
                if (contact) {
                    title.textContent = 'Edit Contact';
                    idInput.value = contact.id;
                    nicknameInput.value = contact.nickname;
                    peerIdInput.value = contact.peerId;
                }
            } else {
                title.textContent = 'Add New Contact';
                idInput.value = '';
                nicknameInput.value = '';
                peerIdInput.value = '';
            }
            contactModal.classList.add('visible');
        }
        function closeContactModal() { contactModal.classList.remove('visible'); }
        function openFullIdModal() { fullIdModal.classList.add('visible'); }
        function closeFullIdModal() { fullIdModal.classList.remove('visible'); }
        function openPeerInfoModal(name, peerId, isSavedContact = false) {
            document.getElementById('peerInfoTitle').textContent = isSavedContact ? 'Contact Information' : 'Connected Peer Information';
            document.getElementById('peerInfoDescription').textContent = `The Peer ID for ${name} is:`;
            document.getElementById('peerInfoIdDisplay').value = peerId;
            peerInfoModal.classList.add('visible');
        }
        function closePeerInfoModal() { peerInfoModal.classList.remove('visible'); }
        function openSettingsModal() {
            renderBlockedIds();
            settingsModal.classList.add('visible');
        }
        function closeSettingsModal() { settingsModal.classList.remove('visible'); }
        sendButton.addEventListener('click', () => {
            if (conn && conn.open) {
                const msg = messageInput.value;
                if (msg) {
                    conn.send(msg);
                    addMessage('You', msg);
                    messageInput.value = '';
                }
            } else {
                addMessage('System', 'You must be connected to send a message.');
            }
        });
        messageInput.addEventListener('keyup', e => { if (e.key === 'Enter') { sendButton.click(); } });
        leaveChatBtn.addEventListener('click', disconnect);
        myIdSpan.addEventListener('click', openFullIdModal);
        connectionStatusSpan.addEventListener('click', () => {
            if (conn && conn.open) {
                const peerName = getPeerName(conn.peer);
                openPeerInfoModal(peerName, conn.peer);
            }
        });
        document.getElementById('addContactBtn').addEventListener('click', () => openContactModal());
        document.getElementById('saveContactBtn').addEventListener('click', saveContact);
        document.getElementById('closeContactModalBtn').addEventListener('click', closeContactModal);
        document.getElementById('cancelContactModalBtn').addEventListener('click', closeContactModal);
        document.getElementById('closeIdModalBtn').addEventListener('click', closeFullIdModal);
        document.getElementById('copyIdBtn').addEventListener('click', () => {
            navigator.clipboard.writeText(fullIdDisplay.value).then(() => {
                alert('ID copied to clipboard!');
                closeFullIdModal();
            });
        });
        fullIdDisplay.addEventListener('click', () => {
            navigator.clipboard.writeText(fullIdDisplay.value).then(() => alert('ID copied to clipboard!'));
        });
        document.getElementById('closePeerInfoModalBtn').addEventListener('click', closePeerInfoModal);
        document.getElementById('copyPeerIdBtn').addEventListener('click', () => {
            const idToCopy = document.getElementById('peerInfoIdDisplay').value;
            navigator.clipboard.writeText(idToCopy).then(() => {
                alert('Peer ID copied to clipboard!');
                closePeerInfoModal();
            });
        });
        document.getElementById('settingsBtn').addEventListener('click', openSettingsModal);
        document.getElementById('closeSettingsModalBtn').addEventListener('click', closeSettingsModal);
        document.getElementById('doneSettingsBtn').addEventListener('click', closeSettingsModal);
        document.getElementById('addBlockBtn').addEventListener('click', () => {
            const idInput = document.getElementById('blockIdInput');
            blockId(idInput.value.trim());
            idInput.value = '';
        });
        document.getElementById('blocked-ids-list').addEventListener('click', (e) => {
            if (e.target.classList.contains('unblock-btn')) {
                unblockId(e.target.dataset.id);
            }
        });
        contactSearchInput.addEventListener('input', renderContacts);
        contactSortSelect.addEventListener('change', renderContacts);
        function initializeApp() {
            initializePeer();
            renderContacts();
            addMessage('System', 'Welcome! Connect to a friend to start chatting.');
        }
        initializeApp();
    }

    // --- Firebase Authentication Logic ---
    // This script runs on page load to check the user's login status.
    document.addEventListener('DOMContentLoaded', () => {
        try {
            // IMPORTANT: Replace with your actual Firebase project configuration
            const firebaseConfig = {
                apiKey: "YOUR_API_KEY",
                authDomain: "YOUR_AUTH_DOMAIN",
                projectId: "YOUR_PROJECT_ID",
                storageBucket: "YOUR_STORAGE_BUCKET",
                messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
                appId: "YOUR_APP_ID"
            };

            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const authorizedEmails = ['4simpleproblems@gmail.com', 'belkwy30@minerva.sparcc.org'];

            auth.onAuthStateChanged(user => {
                if (user) {
                    // User is signed in. Check if they are authorized.
                    const userEmail = user.email;
                    if (authorizedEmails.includes(userEmail)) {
                        // User is authorized. Show the page and start the app.
                        document.body.style.display = 'flex';
                        document.body.style.flexDirection = 'column';
                        document.getElementById('user-email-display').textContent = userEmail;
                        startMessengerApp(); // This initializes all the messenger features.
                    } else {
                        // User is signed in but not authorized. Redirect.
                        window.location.href = '../logged-in/others.html';
                    }
                } else {
                    // No user is signed in. Redirect to the login page.
                    // Assuming your login page is at '../index.html' or similar.
                    window.location.href = '../index.html'; 
                }
            });

            // Set up the logout button listener
            document.getElementById('logout-button').addEventListener('click', () => {
                auth.signOut().catch(error => {
                    console.error('Sign out error', error);
                });
                // onAuthStateChanged will automatically handle the redirect after sign-out.
            });

        } catch (error) {
            console.error("Firebase initialization error:", error);
            document.body.innerHTML = 'Error initializing application. Please check the console.';
            document.body.style.display = 'block';
        }
    });

    </script>
</body>
</html>
