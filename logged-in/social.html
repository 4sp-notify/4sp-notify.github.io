<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Social Platform</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <style>
        /* ---
        /* --- SECTION 1: GENERAL & BASE STYLES
        /* --- This section combines common styles from your original files and adds new base styles for the social platform.
        /* --- */

        /* Base Page Layout */
        :root {
            --primary-color: #6720bd;
            --secondary-color: #8a2be2;
            --background-light: #f0f2f5;
            --background-dark: #e8eaf0;
            --text-dark: #2c3e50;
            --text-light: #555;
            --white-color: #ffffff;
            --border-color: #e0e0e0;
            --shadow-light: rgba(0, 0, 0, 0.06);
            --shadow-dark: rgba(0, 0, 0, 0.1);
            --danger-color: #dc3545;
            --success-color: #28a745;
            --info-color: #17a2b8;
        }

        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, var(--background-light) 0%, var(--background-dark) 100%);
            color: var(--text-dark);
        }

        /* General Header */
        .main-header {
            background: var(--white-color);
            padding: 0 20px;
            box-shadow: 0 2px 5px var(--shadow-dark);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            height: 60px;
        }

        .logo-container .logo-text {
            font-size: 1.5em;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* ---
        /* --- SECTION 2: NEW NAVIGATION MENU
        /* --- This replaces the old sidebar with a clean, horizontal navigation bar.
        /* --- */
        .main-nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            gap: 5px;
        }

        .main-nav a, .nav-dropdown-btn {
            display: block;
            padding: 10px 15px;
            text-decoration: none;
            color: var(--text-light);
            font-weight: 500;
            border-radius: 8px;
            transition: background-color 0.3s, color 0.3s;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1em;
            font-family: 'Roboto', sans-serif;
        }

        .main-nav a:hover, .nav-dropdown-btn:hover {
            background-color: var(--background-light);
            color: var(--primary-color);
        }

        .main-nav a.active {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: var(--white-color);
            box-shadow: 0 2px 8px rgba(103, 32, 189, 0.3);
        }

        /* Dropdown Menu for "Apps" */
        .nav-dropdown {
            position: relative;
        }

        .nav-dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: var(--white-color);
            min-width: 180px;
            box-shadow: 0 8px 16px var(--shadow-dark);
            border-radius: 8px;
            padding: 5px 0;
            z-index: 1;
        }
        
        .nav-dropdown-content a {
            color: var(--text-dark);
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            text-align: left;
        }

        .nav-dropdown:hover .nav-dropdown-content {
            display: block;
        }

        /* User Auth Area */
        .user-auth-area {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        #authContainer .username-display {
            font-weight: 500;
            color: var(--text-dark);
        }

        #logoutBtn {
            background-color: var(--primary-color);
            color: var(--white-color);
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #logoutBtn:hover {
            background-color: var(--secondary-color);
        }
        
        #loginContainer button {
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }
        #loginBtn { background-color: transparent; color: var(--primary-color); }
        #signupBtn { background-color: var(--primary-color); color: var(--white-color); }

        /* Main Content Area */
        .main-content {
            flex: 1;
            padding: 25px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }

        .view {
            display: none; /* All views are hidden by default */
            animation: fadeInView 0.5s ease-in-out;
        }
        
        .view.active {
            display: block; /* The active view is shown */
        }

        @keyframes fadeInView {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ---
        /* --- SECTION 3: SHARED & REUSABLE COMPONENTS
        /* --- Styles for cards, buttons, forms, and modals that are used across multiple views.
        /* --- */

        /* General Card Style */
        .card {
            background: var(--white-color);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 20px var(--shadow-light);
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }
        
        .card-header h2, .card-header h3 {
            margin: 0;
            font-size: 1.5em;
            color: var(--text-dark);
        }
        
        /* General List Style */
        .item-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            border-radius: 10px;
            transition: background-color 0.2s;
            border-bottom: 1px solid var(--border-color);
        }
        .list-item:last-child {
            border-bottom: none;
        }

        .list-item:hover {
            background-color: var(--background-light);
        }
        
        .list-item-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .list-item-info .item-name {
            font-weight: 500;
        }
        .list-item-info .item-details {
            font-size: 0.9em;
            color: var(--text-light);
        }

        .list-item-actions {
            display: flex;
            gap: 10px;
        }
        
        /* General Button Styles */
        .btn {
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-primary { background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(103, 32, 189, 0.25); }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-icon { background: transparent; border: 1px solid var(--border-color); color: var(--text-light); width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .btn-icon:hover { background-color: var(--background-light); }

        /* General Form Styles */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #3d475c; }
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group input[type="url"],
        .form-group input[type="search"],
        .form-group select,
        .form-group textarea {
            background-color: #f7f9fc;
            border: 1px solid #d9dde6;
            border-radius: 8px;
            padding: 12px;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-group textarea { resize: vertical; min-height: 120px; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.15);
            outline: none;
        }

        /* General Modal Styles */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            justify-content: center; align-items: center;
            z-index: 2000; animation: fadeInView 0.3s; padding: 15px;
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 15px;
            width: 100%; max-width: 550px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            position: relative; max-height: 90vh; overflow-y: auto;
        }
        .modal-close-btn {
            position: absolute; top: 15px; right: 15px; background: none; border: none;
            font-size: 1.8em; cursor: pointer; color: #888; line-height: 1;
        }
        .modal-header { border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; }
        .modal-title { margin: 0; font-size: 1.5em; }
        .modal-footer { margin-top: 25px; display: flex; justify-content: flex-end; gap: 10px; }

        /* Status Messages */
        .status-msg {
            padding: 12px 15px; margin-top: 15px; border-radius: 8px; text-align: center;
            display: none; border: 1px solid transparent;
        }
        .status-success { background-color: #d4edda; color: #155724; border-color: #c3e6cb;}
        .status-error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb;}


        /* ---
        /* --- SECTION 4: SOCIAL FEATURES & CHAT STYLES
        /* --- This contains all new CSS for the Friends, Chat, and Settings views.
        /* --- */
        
        /* Friends View */
        .friends-layout {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .friends-tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 20px;
        }
        .friends-tabs .tab-btn {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1.1em;
            font-weight: 500;
            color: var(--text-light);
            border-bottom: 3px solid transparent;
            margin-bottom: -2px; /* Align with container border */
        }
        .friends-tabs .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        /* Chat View */
        .chat-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            height: calc(100vh - 120px); /* Full height minus header and padding */
            gap: 20px;
        }
        .chat-list-panel {
            display: flex;
            flex-direction: column;
        }
        .chat-list {
            flex-grow: 1;
            overflow-y: auto;
        }
        .chat-item {
            display: flex;
            align-items: center;
            padding: 15px;
            cursor: pointer;
            border-radius: 10px;
            gap: 10px;
        }
        .chat-item.active {
            background-color: var(--secondary-color) !important;
            color: white;
        }
        .chat-item.active .chat-last-message { color: #f0f0f0; }
        .chat-item:hover {
            background-color: var(--background-light);
        }
        .chat-name { font-weight: 500; }
        .chat-last-message { font-size: 0.9em; color: var(--text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        
        .chat-window-panel {
            display: flex;
            flex-direction: column;
        }
        .chat-window-placeholder {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            text-align: center;
            color: var(--text-light);
        }
        .chat-window-placeholder i { font-size: 4em; margin-bottom: 20px; color: var(--border-color); }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column-reverse; /* Shows latest messages at the bottom */
        }
        .messages-container { display: flex; flex-direction: column; gap: 15px; }

        .message-bubble {
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 70%;
            line-height: 1.4;
        }
        .message-bubble .sender-name { font-size: 0.8em; font-weight: 700; margin-bottom: 4px; }
        
        .message-sent {
            background-color: var(--primary-color);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message-received {
            background-color: #E5E5EA;
            color: black;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .chat-input-area {
            display: flex;
            padding: 15px;
            border-top: 1px solid var(--border-color);
            gap: 10px;
        }
        #messageInput {
            flex-grow: 1;
            border-radius: 20px;
        }
        #sendMessageBtn {
            border-radius: 50%;
            width: 44px;
            height: 44px;
            padding: 0;
            flex-shrink: 0;
        }

        /* Settings View */
        .settings-layout {
            max-width: 800px;
            margin: auto;
        }

        /* ---
        /* --- SECTION 5: PORTED APP STYLES
        /* --- These are the specific styles from your `requests`, `notes`, and `countdown` files,
        /* --- adapted to fit within the new platform's structure.
        /* --- */

        /* Requests App Styles */
        #requests-view .requests-controls { display: flex; gap: 15px; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
        #requests-view .request-item {
            border: 1px solid #e0e0e0; border-radius: 10px; padding: 15px; background: #fdfdfd; display: flex;
            gap: 15px; transition: all 0.2s; position: relative;
        }
        #requests-view .request-item:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        #requests-view .vote-section { display: flex; flex-direction:column; align-items: center; justify-content: center; gap: 5px; flex-shrink: 0; min-width: 60px; }
        #requests-view .vote-btn { background: none; border: none; font-size: 1.4em; cursor: pointer; color: #aaa; transition: all 0.2s ease; padding: 5px; }
        #requests-view .upvote-btn:hover { color: var(--success-color); transform: scale(1.2); }
        #requests-view .downvote-btn:hover { color: var(--danger-color); transform: scale(1.2); }
        #requests-view .upvote-btn.voted { color: var(--success-color); }
        #requests-view .downvote-btn.voted { color: var(--danger-color); }
        #requests-view .request-content { width: 100%; overflow: hidden; }
        #requests-view .request-title { font-size: 1.15em; font-weight: 600; margin: 5px 0 8px 0; }
        #requests-view .request-type-badge { padding: 4px 8px; border-radius: 8px; font-size: 0.8em; font-weight: bold; color: white; }
        .badge-sound { background: linear-gradient(135deg, #5f72bd 0%, #967adc 100%); }
        .badge-feature { background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%); }
        .badge-issue { background: linear-gradient(135deg, #f5515f 0%, #a1051d 100%); }

        /* Notes App Styles */
        #notes-view .notes-container { display: flex; flex-direction: column; flex-grow: 1; gap: 20px; }
        #notesTextArea { width: 100%; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1em; resize: vertical; min-height: 300px; box-sizing: border-box; }
        #notes-view .cloud-saves-list li { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #f0f0f0; }

        /* Countdown App Styles */
        #countdowns-view .active-countdown-wrapper { text-align: center; }
        #countdowns-view #activeCountdownNameDisplay { font-size: 1.8em; margin-bottom: 20px; color: var(--text-dark); }
        #countdowns-view .timer-display { 
            padding: 20px; border-radius: 8px; background: #f0f2f5; font-family: 'Roboto', sans-serif; 
            font-size: 1.5em; color: var(--primary-color); font-weight: 700; text-align: center;
            display: flex; flex-wrap: wrap; justify-content: center; gap: 15px;
        }
        #countdowns-view .timer-display .time-unit { display: inline-block; }
        #countdowns-view .timer-display .time-label { font-size: 0.5em; margin-left: 3px; opacity: 0.7; }

    </style>
</head>
<body>

    <header class="main-header">
        <div class="header-container">
            <div class="logo-container">
                <a href="#" class="logo-text">SocialFire</a>
            </div>
            <nav id="mainNav" class="main-nav" style="display: none;">
                <ul>
                    <li><a href="#" data-view="chats-view">Chats</a></li>
                    <li><a href="#" data-view="friends-view">Friends</a></li>
                    <li class="nav-dropdown">
                        <button class="nav-dropdown-btn">Apps <i class="fa-solid fa-chevron-down fa-xs"></i></button>
                        <div class="nav-dropdown-content">
                            <a href="#" data-view="requests-view">Requests</a>
                            <a href="#" data-view="notes-view">Notes</a>
                            <a href="#" data-view="countdowns-view">Countdowns</a>
                        </div>
                    </li>
                    <li><a href="#" data-view="settings-view">Settings</a></li>
                </ul>
            </nav>
            <div class="user-auth-area">
                <div id="authContainer"></div>
            </div>
        </div>
    </header>

    <main class="main-content">
        
        <div id="welcome-view" class="view active">
            <div class="card" style="text-align: center;">
                <h2>Welcome to SocialFire</h2>
                <p>A social platform built with Firebase.</p>
                <p>Please log in or sign up to continue.</p>
                <div id="loginContainer" style="display:flex; justify-content:center; gap: 10px; margin-top:20px;">
                     <button id="loginBtn" class="btn btn-secondary">Login</button>
                     <button id="signupBtn" class="btn btn-primary">Sign Up</button>
                </div>
            </div>
        </div>
        
        <div id="chats-view" class="view">
            <div class="chat-layout card">
                <div class="chat-list-panel">
                    <div class="card-header" style="padding:0 0 15px 0;">
                        <h3>Conversations</h3>
                        <button id="newChatBtn" class="btn-icon" title="New Chat"><i class="fa-solid fa-plus"></i></button>
                    </div>
                    <div id="chatList" class="chat-list">
                        </div>
                </div>
                <div id="chatWindow" class="chat-window-panel">
                     <div class="chat-window-placeholder">
                        <i class="fa-regular fa-comments"></i>
                        <h3>Select a conversation</h3>
                        <p>Choose a chat from the left to start messaging.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="friends-view" class="view">
            <div class="card">
                <div class="friends-tabs">
                    <button class="tab-btn active" data-tab="my-friends">My Friends</button>
                    <button class="tab-btn" data-tab="pending-requests">Pending Requests</button>
                    <button class="tab-btn" data-tab="find-users">Find Users</button>
                </div>
                <div id="friendsTabContent">
                    </div>
            </div>
        </div>

        <div id="settings-view" class="view">
            <div class="settings-layout">
                <div class="card">
                    <h3>Profile Settings</h3>
                    <div class="form-group">
                        <label for="usernameInput">Username</label>
                        <input type="text" id="usernameInput" placeholder="Enter your public username">
                    </div>
                    <button id="saveUsernameBtn" class="btn btn-primary">Save Username</button>
                    <div id="settingsStatus" class="status-msg"></div>
                </div>
                <div class="card">
                    <h3>Blocked Users</h3>
                    <ul id="blockedUsersList" class="item-list">
                        </ul>
                </div>
            </div>
        </div>

        <div id="requests-view" class="view">
            <div class="card">
                <div class="card-header">
                    <h2>Feature & Sound Requests</h2>
                    <button id="createRequestBtn" class="btn btn-primary">Create Request</button>
                </div>
                <div class="requests-controls">
                    <input type="search" id="requestSearchBar" placeholder="Search requests..." class="form-group">
                    <select id="sortRequests" class="form-group">
                        <option value="newest">Newest First</option>
                        <option value="top">Most Upvotes</option>
                        <option value="oldest">Oldest First</option>
                    </select>
                </div>
                <ul id="requestsList" class="item-list" style="display:flex; flex-direction:column; gap:15px;">
                    </ul>
            </div>
        </div>

        <div id="notes-view" class="view">
             <div class="card">
                <div class="card-header">
                    <h3>My Notes</h3>
                    <div class="notes-controls" style="display:flex; gap:10px;">
                        <input type="text" id="cloudSaveName" placeholder="Save name..." style="width:auto;">
                        <button id="saveCloudBtn" class="btn btn-primary">Save to Cloud</button>
                    </div>
                </div>
                <textarea id="notesTextArea" placeholder="Start typing... Your notes are saved automatically in your browser."></textarea>
                <div class="card-header" style="margin-top:20px;">
                    <h3>Cloud Saves</h3>
                </div>
                <ul id="cloudSavesList" class="item-list"></ul>
            </div>
        </div>

        <div id="countdowns-view" class="view">
            <div class="card">
                <div class="card-header">
                    <h3>My Countdowns</h3>
                    <button id="addCountdownBtn" class="btn btn-primary">âœ¨ Add New Countdown</button>
                </div>
                 <div class="active-countdown-wrapper card" style="margin-top:20px; background:var(--background-light);">
                    <h3 id="activeCountdownNameDisplay">No countdown selected</h3>
                    <div class="timer-display" id="timerDisplay">Select or create a countdown.</div>
                </div>
                <ul id="countdownList" class="item-list" style="margin-top:20px;">
                     </ul>
            </div>
        </div>
        
    </main>
    
    <div id="auth-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <div class="modal-header">
                <h3 id="auth-modal-title" class="modal-title">Login</h3>
            </div>
            <form id="auth-form">
                <div id="username-field" class="form-group" style="display: none;">
                    <label for="auth-username">Username</label>
                    <input type="text" id="auth-username" placeholder="Choose a public username" required>
                </div>
                <div class="form-group">
                    <label for="auth-email">Email</label>
                    <input type="email" id="auth-email" required>
                </div>
                <div class="form-group">
                    <label for="auth-password">Password</label>
                    <input type="password" id="auth-password" required>
                </div>
                <div class="modal-footer">
                    <button type="submit" id="auth-submit-btn" class="btn btn-primary">Login</button>
                </div>
                <div id="auth-status" class="status-msg"></div>
            </form>
        </div>
    </div>
    
    <div id="request-form-modal" class="modal-overlay">
         <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <div class="modal-header"><h3 class="modal-title">Create a New Submission</h3></div>
            <form id="requestForm">
                <div class="form-group">
                    <label for="requestType">Submission Category</label>
                    <select id="requestType" required><option value="" disabled selected>Choose...</option><option value="sound">Sound Request</option><option value="feature">Feature Request</option><option value="issue">Issue Report</option></select>
                </div>
                <div class="form-group">
                    <label for="requestTitleForm">Title</label>
                    <input type="text" id="requestTitleForm" placeholder="A brief summary..." required maxlength="40">
                </div>
                <div class="form-group">
                    <label for="requestDescriptionForm">Details</label>
                    <textarea id="requestDescriptionForm" placeholder="Be descriptive..." required maxlength="450" rows="5"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Submit Request</button>
                </div>
            </form>
        </div>
    </div>
    
     <div id="countdown-form-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn">&times;</button>
            <div class="modal-header"><h3 id="countdownModalTitle" class="modal-title">Add Countdown</h3></div>
            <form id="countdownForm">
                <div class="form-group">
                    <label for="countdownNameInput">Name:</label>
                    <input type="text" id="countdownNameInput" required>
                </div>
                 <div class="form-group">
                    <label for="dateTimePicker">Target Date & Time:</label>
                    <input type="text" id="dateTimePicker" placeholder="Select date..." required>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>
        /*
        *
        * PLEASE CONFIGURE YOUR FIREBASE SETTINGS HERE
        * This placeholder is from the original files. Replace it with your actual Firebase config.
        *
        */
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        /* ---
        /* --- SECTION 6: CORE PLATFORM LOGIC
        /* --- This section handles authentication, navigation, and global state.
        /* --- */

        // --- Global State & DOM Elements ---
        let currentUser = null;
        let currentUserProfile = {};
        let friends = [];
        let blockedUids = [];
        let activeChatId = null;
        let chatListeners = {}; // To store unsubscribe functions for chats

        // DOM Elements
        const mainNav = document.getElementById('mainNav');
        const authContainer = document.getElementById('authContainer');
        const loginContainer = document.getElementById('loginContainer');
        const views = document.querySelectorAll('.view');

        // --- Authentication ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                // Fetch user profile
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                    currentUserProfile = userDoc.data();
                } else {
                    // This is a new user, profile might not be created yet.
                    currentUserProfile = { email: user.email, username: user.email.split('@')[0] };
                }

                // Setup UI for logged-in user
                authContainer.innerHTML = `<span class="username-display">Welcome, ${currentUserProfile.username}</span><button id="logoutBtn" class="btn">Logout</button>`;
                loginContainer.style.display = 'none';
                mainNav.style.display = 'flex';
                document.getElementById('logoutBtn').addEventListener('click', () => auth.signOut());
                
                // Show the default view (e.g., chats) and hide welcome view
                navigateTo('chats-view');
                
                // Initialize core data listeners
                initializeDataListeners();
                
            } else {
                currentUser = null;
                currentUserProfile = {};
                
                // Cleanup listeners
                Object.values(chatListeners).forEach(unsubscribe => unsubscribe());
                chatListeners = {};

                // Setup UI for logged-out user
                authContainer.innerHTML = '';
                loginContainer.style.display = 'flex';
                document.getElementById('loginBtn').addEventListener('click', () => openAuthModal(false));
                document.getElementById('signupBtn').addEventListener('click', () => openAuthModal(true));
                mainNav.style.display = 'none';

                navigateTo('welcome-view');
            }
        });

        async function initializeDataListeners() {
            // Add listeners for friends, blocked users, chats etc. here
            // For example:
            db.collection('users').doc(currentUser.uid).collection('friends').onSnapshot(snapshot => {
                friends = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // If on friends view, refresh it
                if (document.getElementById('friends-view').classList.contains('active')) {
                    renderFriendsList();
                }
            });

            db.collection('users').doc(currentUser.uid).collection('blocked').onSnapshot(snapshot => {
                blockedUids = snapshot.docs.map(doc => doc.id);
            });
            
            // Listener for all chats the user is a part of
            db.collection('chats').where('participants', 'array-contains', currentUser.uid).onSnapshot(snapshot => {
                const chatList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data()}));
                renderChatList(chatList);
            });
        }
        
        // --- Navigation ---
        mainNav.addEventListener('click', (e) => {
            if (e.target.tagName === 'A' && e.target.dataset.view) {
                e.preventDefault();
                navigateTo(e.target.dataset.view);
            }
        });

        function navigateTo(viewId) {
            views.forEach(view => {
                view.classList.toggle('active', view.id === viewId);
            });
            document.querySelectorAll('#mainNav a').forEach(a => {
                a.classList.toggle('active', a.dataset.view === viewId);
            });

            // Call initialization function for the view if it exists
            switch (viewId) {
                case 'friends-view':
                    initFriendsView();
                    break;
                case 'settings-view':
                    initSettingsView();
                    break;
                case 'requests-view':
                    initRequestsApp();
                    break;
                case 'notes-view':
                    initNotesApp();
                    break;
                case 'countdowns-view':
                    initCountdownsApp();
                    break;
            }
        }
        
        // --- Modal Logic ---
        function setupModal(modalId, openBtnId, formId, submitHandler) {
            const modal = document.getElementById(modalId);
            const openBtn = document.getElementById(openBtnId);
            const form = document.getElementById(formId);

            if (openBtn) openBtn.addEventListener('click', () => modal.style.display = 'flex');
            
            modal.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay') || e.target.classList.contains('modal-close-btn')) {
                    modal.style.display = 'none';
                }
            });
            
            if(form && submitHandler) {
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    submitHandler(e);
                });
            }
        }
        
        // Auth Modal
        const authModal = document.getElementById('auth-modal');
        const authForm = document.getElementById('auth-form');
        const authTitle = document.getElementById('auth-modal-title');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const authUsernameField = document.getElementById('username-field');
        const authStatus = document.getElementById('auth-status');
        let isSignup = false;

        function openAuthModal(isSignupMode) {
            isSignup = isSignupMode;
            authForm.reset();
            authStatus.style.display = 'none';
            authTitle.textContent = isSignup ? 'Sign Up' : 'Login';
            authSubmitBtn.textContent = isSignup ? 'Sign Up' : 'Login';
            authUsernameField.style.display = isSignup ? 'block' : 'none';
            authModal.style.display = 'flex';
        }
        
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const username = document.getElementById('auth-username').value;
            
            authStatus.style.display = 'none';
            
            try {
                if (isSignup) {
                    if (!username) {
                        authStatus.textContent = 'Please enter a username.';
                        authStatus.className = 'status-msg status-error';
                        authStatus.style.display = 'block';
                        return;
                    }
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    // Create user document in Firestore
                    await db.collection('users').doc(userCredential.user.uid).set({
                        username: username,
                        email: email,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                }
                authModal.style.display = 'none';
            } catch (error) {
                authStatus.textContent = error.message;
                authStatus.className = 'status-msg status-error';
                authStatus.style.display = 'block';
            }
        });
        setupModal('auth-modal');
        

        /* ---
        /* --- SECTION 7: SOCIAL FEATURES LOGIC
        /* --- All functions related to Friends, Blocking, and Chat.
        /* --- Firestore Structure Expected:
        /* ---    - users/{uid} -> {username, email, ...}
        /* ---    - users/{uid}/friends/{friend_uid} -> { ... }
        /* ---    - users/{uid}/friendRequests/{sender_uid} -> { ... }
        /* ---    - users/{uid}/blocked/{blocked_uid} -> { ... }
        /* ---    - chats/{chatId} -> { participants: [uid1, uid2], isGroup: bool, lastMessage... }
        /* ---    - chats/{chatId}/messages/{messageId} -> { senderId, text, timestamp }
        /* --- */
        
        // --- Friends Logic ---
        const friendsTabContent = document.getElementById('friendsTabContent');

        function initFriendsView() {
            document.querySelector('.friends-tabs').addEventListener('click', (e) => {
                if (e.target.classList.contains('tab-btn')) {
                    document.querySelectorAll('.friends-tabs .tab-btn').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    renderFriendsTab(e.target.dataset.tab);
                }
            });
            // Initial render
            renderFriendsTab('my-friends');
        }

        function renderFriendsTab(tabName) {
            switch(tabName) {
                case 'my-friends':
                    renderFriendsList();
                    break;
                case 'pending-requests':
                    renderPendingRequests();
                    break;
                case 'find-users':
                    renderFindUsers();
                    break;
            }
        }

        async function renderFriendsList() {
            const friendDocs = await db.collection('users').doc(currentUser.uid).collection('friends').get();
            let html = '<h3>My Friends</h3><ul class="item-list">';
            if (friendDocs.empty) {
                html += '<li>You have no friends yet.</li>';
            } else {
                 for (const doc of friendDocs.docs) {
                    const friendProfile = await db.collection('users').doc(doc.id).get();
                    const friendData = friendProfile.data();
                    html += `
                        <li class="list-item">
                            <div class="list-item-info">
                                <span class="item-name">${friendData.username}</span>
                            </div>
                            <div class="list-item-actions">
                                <button class="btn btn-secondary btn-sm" onclick="startChat('${doc.id}')">Message</button>
                                <button class="btn btn-danger btn-sm" onclick="unfriendUser('${doc.id}')">Unfriend</button>
                            </div>
                        </li>`;
                }
            }
            html += '</ul>';
            friendsTabContent.innerHTML = html;
        }

        async function renderPendingRequests() {
            // Logic to fetch and display pending friend requests
            friendsTabContent.innerHTML = '<h3>Pending Requests</h3><p>Not yet implemented.</p>';
        }

        function renderFindUsers() {
            friendsTabContent.innerHTML = `
                <h3>Find Users</h3>
                <div class="form-group">
                    <input type="search" id="userSearchInput" placeholder="Search by username...">
                </div>
                <ul id="userSearchResults" class="item-list"></ul>
            `;
            const searchInput = document.getElementById('userSearchInput');
            searchInput.addEventListener('keyup', async (e) => {
                const query = e.target.value.toLowerCase();
                if(query.length < 3) return;
                
                const usersRef = db.collection('users');
                const snapshot = await usersRef.where('username', '>=', query).where('username', '<=', query + '\uf8ff').get();
                
                let resultsHtml = '';
                snapshot.forEach(doc => {
                    if(doc.id === currentUser.uid) return; // Don't show self
                    const userData = doc.data();
                    resultsHtml += `
                        <li class="list-item">
                            <div class="list-item-info"><span class="item-name">${userData.username}</span></div>
                            <div class="list-item-actions">
                                <button class="btn btn-success btn-sm" onclick="sendFriendRequest('${doc.id}')">Add Friend</button>
                            </div>
                        </li>`;
                });
                 document.getElementById('userSearchResults').innerHTML = resultsHtml || '<li>No users found.</li>';
            });
        }
        
        async function sendFriendRequest(recipientId) {
            alert(`Friend request sent to user ${recipientId}. (Not fully implemented)`);
        }
        
        // --- Chat Logic ---
        const chatListEl = document.getElementById('chatList');
        const chatWindowEl = document.getElementById('chatWindow');

        function renderChatList(chats) {
            let html = '';
            if (!chats.length) {
                chatListEl.innerHTML = '<li style="padding:15px; color:#777;">No conversations.</li>';
                return;
            }
            chats.forEach(async chat => {
                 // For 1-on-1 chats, find the other user's name
                let chatName = chat.groupName || 'Chat';
                if (!chat.isGroup) {
                    const otherUserId = chat.participants.find(p => p !== currentUser.uid);
                    if(otherUserId){
                        const userDoc = await db.collection('users').doc(otherUserId).get();
                        chatName = userDoc.exists ? userDoc.data().username : 'User';
                    }
                }

                html += `
                    <div class="chat-item" data-chat-id="${chat.id}">
                         <div style="flex-grow:1; overflow:hidden;">
                            <div class="chat-name">${chatName}</div>
                            <div class="chat-last-message">${chat.lastMessage?.text || 'No messages yet'}</div>
                         </div>
                    </div>`;
            });
            chatListEl.innerHTML = html;
        }

        chatListEl.addEventListener('click', (e) => {
            const chatItem = e.target.closest('.chat-item');
            if(chatItem) {
                const chatId = chatItem.dataset.chatId;
                openChat(chatId);
            }
        });

        function openChat(chatId) {
            activeChatId = chatId;
            // Highlight active chat
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.toggle('active', item.dataset.chatId === chatId);
            });
            
            // Unsubscribe from previous chat listener
            if (chatListeners[activeChatId]) chatListeners[activeChatId]();

            // Set up chat window
            chatWindowEl.innerHTML = `
                <div class="card-header" style="padding:0 15px 15px 15px;">
                    <h3 id="chat-window-title">Loading...</h3>
                </div>
                <div class="chat-messages"><div class="messages-container"></div></div>
                <div class="chat-input-area">
                    <input type="text" id="messageInput" class="form-group" placeholder="Type a message...">
                    <button id="sendMessageBtn" class="btn btn-primary"><i class="fa-solid fa-paper-plane"></i></button>
                </div>`;
            
            document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if(e.key === 'Enter') sendMessage();
            });
            
            // Listen for new messages
            const messagesRef = db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp', 'desc');
            chatListeners[chatId] = messagesRef.onSnapshot(snapshot => {
                const messagesContainer = chatWindowEl.querySelector('.messages-container');
                messagesContainer.innerHTML = '';
                snapshot.forEach(doc => {
                    renderMessage(doc.data(), messagesContainer);
                });
            });

            // Set chat title
            db.collection('chats').doc(chatId).get().then(async doc => {
                const chat = doc.data();
                let chatName = chat.groupName || 'Chat';
                if (!chat.isGroup) {
                    const otherUserId = chat.participants.find(p => p !== currentUser.uid);
                    if(otherUserId){
                         const userDoc = await db.collection('users').doc(otherUserId).get();
                         chatName = userDoc.exists ? userDoc.data().username : 'User';
                    }
                }
                document.getElementById('chat-window-title').textContent = chatName;
            });
        }
        
        async function renderMessage(msg, container) {
            const senderProfile = await db.collection('users').doc(msg.senderId).get();
            const senderName = senderProfile.exists ? senderProfile.data().username : "User";
            const bubble = document.createElement('div');
            bubble.classList.add('message-bubble');
            bubble.classList.toggle('message-sent', msg.senderId === currentUser.uid);
            bubble.classList.toggle('message-received', msg.senderId !== currentUser.uid);
            bubble.innerHTML = `
                <div class="sender-name">${senderName}</div>
                ${msg.text}
            `;
            container.appendChild(bubble);
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if(!text || !activeChatId) return;

            const messagesRef = db.collection('chats').doc(activeChatId).collection('messages');
            messagesRef.add({
                text: text,
                senderId: currentUser.uid,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Update last message on chat document for previews
            db.collection('chats').doc(activeChatId).update({
                lastMessage: {
                    text: text,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }
            });

            input.value = '';
            input.focus();
        }
        
        // --- Settings Logic ---
        function initSettingsView() {
            document.getElementById('usernameInput').value = currentUserProfile.username || '';
            document.getElementById('saveUsernameBtn').addEventListener('click', async () => {
                const newUsername = document.getElementById('usernameInput').value.trim();
                if(newUsername && newUsername !== currentUserProfile.username) {
                    await db.collection('users').doc(currentUser.uid).update({ username: newUsername });
                    currentUserProfile.username = newUsername; // Update local profile
                    document.getElementById('settingsStatus').textContent = 'Username updated!';
                    document.getElementById('settingsStatus').className = 'status-msg status-success';
                    document.getElementById('settingsStatus').style.display = 'block';
                }
            });
        }


        /* ---
        /* --- SECTION 8: PORTED APP LOGIC
        /* --- This contains the JavaScript from your original files, refactored into
        /* --- initialization functions to work within the single-page application structure.
        /* --- */
        
        // --- Requests App Logic ---
        let requestsAppInitialized = false;
        function initRequestsApp() {
            if (requestsAppInitialized) return;
            
            // Selectors scoped to the requests view
            const view = document.getElementById('requests-view');
            const createBtn = view.querySelector('#createRequestBtn');
            const requestsList = view.querySelector('#requestsList');
            const sortSelect = view.querySelector('#sortRequests');
            
            createBtn.addEventListener('click', () => {
                setupModal('request-form-modal', null, 'requestForm', handleRequestSubmit);
                document.getElementById('request-form-modal').style.display = 'flex';
            });
            
            sortSelect.addEventListener('change', fetchAndDisplayRequests);
            fetchAndDisplayRequests();

            requestsList.addEventListener('click', (e) => {
                const requestItem = e.target.closest('.request-item');
                if (!requestItem) return;
                const requestId = requestItem.dataset.id;
                
                if (e.target.closest('.vote-btn')) {
                    e.stopPropagation();
                    if (!currentUser) return;
                    handleVote(requestId, e.target.closest('.vote-btn').classList.contains('upvote-btn'));
                }
            });

            requestsAppInitialized = true;
        }
        
        async function fetchAndDisplayRequests() {
            const requestsList = document.getElementById('requestsList');
            if (!currentUser) {
                requestsList.innerHTML = '<li>Please log in to see requests.</li>';
                return;
            }
            requestsList.innerHTML = '<li>Loading...</li>';
            
            let query = db.collection('requests').where('status', '==', 'active');
            // Add sorting logic from original file here...
            
            const snapshot = await query.orderBy('timestamp', 'desc').get();
            let html = '';
            for (const doc of snapshot.docs) {
                const request = { id: doc.id, ...doc.data() };
                const userDoc = await db.collection('users').doc(request.userId).get();
                const username = userDoc.exists ? userDoc.data().username : "Anonymous";

                html += `
                    <li class="request-item" data-id="${request.id}">
                        <div class="vote-section">
                            <button class="vote-btn upvote-btn ${request.upvotedBy?.includes(currentUser?.uid) ? 'voted' : ''}"><i class="fas fa-arrow-up"></i></button>
                            <span>${(request.upvotes || 0) - (request.downvotes || 0)}</span>
                            <button class="vote-btn downvote-btn ${request.downvotedBy?.includes(currentUser?.uid) ? 'voted' : ''}"><i class="fas fa-arrow-down"></i></button>
                        </div>
                        <div class="request-content">
                            <div><span class="request-type-badge badge-${request.type}">${request.type}</span></div>
                            <h4 class="request-title">${request.title}</h4>
                            <p>${request.description}</p>
                            <small>By ${username}</small>
                        </div>
                    </li>`;
            }
            requestsList.innerHTML = html || '<li>No requests found.</li>';
        }

        function handleRequestSubmit() {
            const type = document.getElementById('requestType').value;
            const title = document.getElementById('requestTitleForm').value;
            const description = document.getElementById('requestDescriptionForm').value;
            if(!type || !title || !description) return;
            
            db.collection('requests').add({
                userId: currentUser.uid,
                type,
                title,
                description,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                upvotes: 0, downvotes: 0, upvotedBy: [], downvotedBy: [],
                status: 'active'
            }).then(() => {
                document.getElementById('request-form-modal').style.display = 'none';
                fetchAndDisplayRequests();
            });
        }
        
        async function handleVote(requestId, isUpvote) {
            // Adapted from original file
            const requestRef = db.collection('requests').doc(requestId);
            await db.runTransaction(async (transaction) => {
                const doc = await transaction.get(requestRef);
                if (!doc.exists) throw "Document not found.";
                const data = doc.data();

                let { upvotedBy = [], downvotedBy = [] } = data;
                const upvoteIndex = upvotedBy.indexOf(currentUser.uid);
                const downvoteIndex = downvotedBy.indexOf(currentUser.uid);

                if (isUpvote) {
                    if (upvoteIndex > -1) { upvotedBy.splice(upvoteIndex, 1); } 
                    else { upvotedBy.push(currentUser.uid); if (downvoteIndex > -1) { downvotedBy.splice(downvoteIndex, 1); } }
                } else {
                    if (downvoteIndex > -1) { downvotedBy.splice(downvoteIndex, 1); } 
                    else { downvotedBy.push(currentUser.uid); if (upvoteIndex > -1) { upvotedBy.splice(upvoteIndex, 1); } }
                }
                transaction.update(requestRef, { upvotedBy, downvotedBy, upvotes: upvotedBy.length, downvotes: downvotedBy.length });
            });
            fetchAndDisplayRequests();
        }

        // --- Notes App Logic ---
        let notesAppInitialized = false;
        const notesTextArea = document.getElementById('notesTextArea');
        
        function initNotesApp() {
            if (notesAppInitialized) return;
            notesTextArea.addEventListener('blur', saveLocalNotes); // Save on losing focus
            loadLocalNotes();
            refreshCloudSavesDisplay();
            document.getElementById('saveCloudBtn').addEventListener('click', handleCloudSave);
            notesAppInitialized = true;
        }

        function saveLocalNotes() {
            localStorage.setItem(`notes_${currentUser.uid}`, notesTextArea.value);
        }

        function loadLocalNotes() {
            const localNotes = localStorage.getItem(`notes_${currentUser.uid}`);
            if (localNotes) {
                notesTextArea.value = localNotes;
            }
        }
        
        async function handleCloudSave() {
            const saveName = document.getElementById('cloudSaveName').value.trim() || `Note-${new Date().toISOString().slice(0,10)}`;
            const content = notesTextArea.value;
            const userNotesRef = db.collection('users').doc(currentUser.uid).collection('notes');
            await userNotesRef.add({ name: saveName, content: content, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            refreshCloudSavesDisplay();
        }

        async function refreshCloudSavesDisplay() {
            const cloudSavesList = document.getElementById('cloudSavesList');
            cloudSavesList.innerHTML = '<li>Loading...</li>';
            const snapshot = await db.collection('users').doc(currentUser.uid).collection('notes').orderBy('timestamp', 'desc').get();
            let html = '';
            snapshot.forEach(doc => {
                const note = doc.data();
                html += `<li class="list-item">
                            <span class="item-name">${note.name}</span>
                            <div class="list-item-actions">
                                <button class="btn btn-secondary btn-sm" onclick="openCloudNote('${doc.id}')">Open</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteCloudNote('${doc.id}')">Delete</button>
                            </div>
                         </li>`;
            });
            cloudSavesList.innerHTML = html || '<li>No cloud saves.</li>';
        }

        async function openCloudNote(noteId) {
            const noteDoc = await db.collection('users').doc(currentUser.uid).collection('notes').doc(noteId).get();
            if(noteDoc.exists) {
                notesTextArea.value = noteDoc.data().content;
            }
        }
        async function deleteCloudNote(noteId) {
            if(confirm('Are you sure you want to delete this cloud note?')) {
                await db.collection('users').doc(currentUser.uid).collection('notes').doc(noteId).delete();
                refreshCloudSavesDisplay();
            }
        }

        // --- Countdowns App Logic ---
        let countdownsAppInitialized = false;
        let countdownInterval;
        let flatpickrInstance;
        
        function initCountdownsApp() {
            if (countdownsAppInitialized) return;
            
            flatpickrInstance = flatpickr("#dateTimePicker", { enableTime: true, dateFormat: "Y-m-d H:i" });
            
            setupModal('countdown-form-modal', 'addCountdownBtn', 'countdownForm', handleCountdownSubmit);
            document.getElementById('countdownList').addEventListener('click', (e) => {
                const li = e.target.closest('li[data-id]');
                if(!li) return;
                const id = li.dataset.id;
                if(e.target.matches('.open-save-btn')) {
                    openCountdown(id);
                } else if(e.target.matches('.delete-save-btn')) {
                    deleteCountdown(id);
                }
            });

            loadCountdowns();
            countdownsAppInitialized = true;
        }

        async function loadCountdowns() {
            const listEl = document.getElementById('countdownList');
            listEl.innerHTML = '<li>Loading...</li>';
            const snapshot = await db.collection('users').doc(currentUser.uid).collection('countdowns').orderBy('targetTimestamp', 'asc').get();
            let html = '';
            snapshot.forEach(doc => {
                 const cd = { id: doc.id, ...doc.data() };
                 const targetDate = cd.targetTimestamp.toDate();
                 html += `<li class="list-item" data-id="${cd.id}">
                            <div>
                                <div class="item-name">${cd.name}</div>
                                <div class="item-details">${targetDate.toLocaleString()}</div>
                            </div>
                            <div class="list-item-actions">
                                <button class="btn btn-secondary btn-sm open-save-btn">Open</button>
                                <button class="btn btn-danger btn-sm delete-save-btn">Delete</button>
                            </div>
                          </li>`;
            });
            listEl.innerHTML = html || '<li>No countdowns saved.</li>';
        }

        async function handleCountdownSubmit() {
            const name = document.getElementById('countdownNameInput').value;
            const date = flatpickrInstance.selectedDates[0];
            if (!name || !date) return;
            await db.collection('users').doc(currentUser.uid).collection('countdowns').add({
                name: name,
                targetTimestamp: firebase.firestore.Timestamp.fromDate(date)
            });
            document.getElementById('countdown-form-modal').style.display = 'none';
            loadCountdowns();
        }

        async function openCountdown(id) {
            const doc = await db.collection('users').doc(currentUser.uid).collection('countdowns').doc(id).get();
            if(!doc.exists) return;
            const cd = doc.data();
            document.getElementById('activeCountdownNameDisplay').textContent = cd.name;
            const target = cd.targetTimestamp.toDate();
            
            clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                const now = new Date();
                const diff = target - now;
                if(diff <= 0) {
                    document.getElementById('timerDisplay').textContent = "ðŸŽ‰ Finished!";
                    clearInterval(countdownInterval);
                    return;
                }
                const d = Math.floor(diff / (1000 * 60 * 60 * 24));
                const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((diff % (1000 * 60)) / 1000);
                document.getElementById('timerDisplay').innerHTML = `
                    <span class="time-unit">${d}<span class="time-label">d</span></span>
                    <span class="time-unit">${h}<span class="time-label">h</span></span>
                    <span class="time-unit">${m}<span class="time-label">m</span></span>
                    <span class="time-unit">${s}<span class="time-label">s</span></span>
                `;
            }, 1000);
        }

        async function deleteCountdown(id) {
            if(confirm('Are you sure?')) {
                await db.collection('users').doc(currentUser.uid).collection('countdowns').doc(id).delete();
                loadCountdowns();
            }
        }
        
    </script>
</body>
</html>
