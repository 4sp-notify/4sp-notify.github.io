<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>4SP - APPS</title>
  <link rel="stylesheet" href="../css/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <script src="../panic-key.js"></script>
  <script src="../ban-enforcer.js"></script>
  <script src="../url-changer.js"></script>
  <style>
    /* --- Base Dashboard Layout --- */
    body.dashboard-page {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      margin: 0;
      font-family: 'PrimaryFont', sans-serif;
    }
    .dashboard-container {
      display: flex;
      flex: 1;
    }

    /* --- Sidebar --- */
    .sidebar { width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%); color: #fff; padding: 20px 10px; display: flex; flex-direction: column; border-right: 1px solid #444; transition: width 0.5s ease-in-out; position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
    .sidebar.collapsed { width: 85px; }
    #toggleSidebar { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: none; border: none; color: #fff; font-size: 1.2em; cursor: pointer; padding: 4px; transition: transform 0.5s ease-in-out; }
    .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
    .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
    .sidebar nav li { margin-bottom: 10px; }
    .sidebar nav a { display: flex; align-items: center; padding: 12px 15px; color: #fff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; font-family: 'PrimaryFont', sans-serif; text-transform: uppercase; }
    .sidebar nav a.active, .sidebar nav a:hover { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); transform: translateX(5px); }
    .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
    .sidebar nav a .label { 
        margin-left: 10px; 
        white-space: nowrap; 
        opacity: 1;
        visibility: visible;
        transition: opacity 0.2s ease-in-out;
        transition-delay: 0.4s;
    }
    .sidebar.collapsed nav a .label { 
        opacity: 0;
        visibility: hidden;
        transition-delay: 0s;
    }

    /* --- Main Content & Header --- */
    .main-content {
      flex: 1;
      padding: 30px;
      background: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
      overflow-y: auto;
      position: relative;
    }
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      background: white;
      padding: 20px 30px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      border: 1px solid rgba(103, 32, 189, 0.1);
      flex-shrink: 0;
    }
    .dashboard-title {
      margin: 0;
      font-size: 2.0em;
      font-weight: bold;
      background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      flex-grow: 1;
    }
    .header-actions {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    .app-search-bar {
        height: 40px;
        width: 280px;
        padding: 0 15px;
        border-radius: 10px;
        border: 1px solid #ddd;
        font-family: inherit;
        font-size: 0.95em;
        color: #333;
        transition: all 0.2s ease-in-out;
        outline: none;
    }
    .app-search-bar:focus {
        border-color: #8a2be2;
        box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.2);
    }
    .app-search-bar::placeholder {
        color: #999;
    }

    .header-btn {
        width: 40px;
        height: 40px;
        background-color: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(4px);
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease-in-out;
    }
    .header-btn:hover {
        background-color: rgba(255, 255, 255, 0.8);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .header-btn img {
        width: 22px;
        height: 22px;
    }

    /* --- NEW SINGLE-COLUMN LIST LAYOUT --- */
    .tiles-grid {
      display: flex;
      flex-direction: column;
      gap: 20px;
      position: relative;
    }

    /* --- TILE STYLES (WIDE & SHORT) --- */
    .grid-item {
      color: inherit;
      text-decoration: none;
      display: flex;
      border-radius: 24px;
      position: relative;
      /* ‚úÖ UPDATED: This transition creates the jitter/overshoot effect on arrival */
      transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1), 
                  opacity 0.25s linear;
    }
    
    /* ‚úÖ NEW: Class to temporarily disable transitions during the INVERT phase */
    .grid-item.no-transition {
        transition: none;
    }
    
    /* ‚úÖ NEW: Class for items that are fading out */
    .grid-item.is-filtering-out {
        opacity: 0;
    }
    
    /* ‚úÖ NEW: Class for items that are hidden from the layout */
    .grid-item.is-hidden {
        display: none;
    }

    .grid-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 25px rgba(103, 32, 189, 0.15);
    }
    .feature-tile {
      background: #ffffff;
      border-radius: 24px;
      padding: 20px 25px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.07);
      border: 1px solid rgba(103, 32, 189, 0.08);
      display: flex;
      flex-direction: row;
      align-items: center;
      width: 100%;
      box-sizing: border-box;
    }
    .tile-main-content {
      flex-grow: 1;
      padding: 0 25px;
      display: flex;
      flex-direction: column;
    }
    .tile-icon {
      font-size: 3em;
      color: #6720bd;
      flex-shrink: 0;
    }
    .tile-title {
      font-size: 1.3em;
      font-weight: bold;
      color: #333;
      margin: 0 0 5px 0;
    }
    .tile-description {
      font-size: 0.9em;
      color: #555;
      line-height: 1.5;
      margin: 0;
    }
    .tile-key-stats {
      flex-shrink: 0;
      border-left: 1px solid #e8eaf0;
      padding-left: 25px;
      display: flex;
      flex-direction: row;
      justify-content: space-around;
      text-align: center;
      gap: 20px;
    }
    .stat-item { flex-basis: 80px; }
    .stat-number {
      display: block;
      font-size: 1.6em;
      font-weight: bold;
      color: #6720bd;
      line-height: 1.1;
    }
    .stat-label {
      display: block;
      font-size: 0.75em;
      color: #777;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 2px;
    }

    /* --- Edit Mode Styles --- */
    .grid-item.is-editing {
      transform: scale(1.01);
      box-shadow: 0 15px 40px rgba(103, 32, 189, 0.25);
      z-index: 100;
      outline: 3px dotted #FFC107;
      outline-offset: 4px;
    }
    .grid-item.is-editing::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(255, 229, 100, 0.4);
      border-radius: 24px;
      z-index: 1;
      pointer-events: none;
    }

    /* --- Edit Mode Hint Bar --- */
    #edit-mode-hint {
        position: fixed;
        bottom: -100px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(40, 40, 40, 0.9);
        backdrop-filter: blur(5px);
        color: white;
        padding: 12px 25px;
        border-radius: 12px;
        z-index: 10001;
        font-family: 'PrimaryFont', sans-serif;
        font-size: 0.9em;
        transition: bottom 0.4s ease-in-out;
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
        justify-content: center;
    }
    #edit-mode-hint.visible { bottom: 20px; }
    #edit-mode-hint kbd { background-color: #555; padding: 2px 6px; border-radius: 4px; font-size: 0.9em; }
    .hint-divider { width: 1px; height: 14px; background-color: #666; }

    /* Animation for fade-in */
    .fade-in { animation: fadeInGeneral 0.5s ease-out forwards; }
    @keyframes fadeInGeneral { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .slide-in { animation: slideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
    @keyframes slideIn { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  </style>
</head>

<body class="dashboard-page">
  <header class="main-header light-bg">
    <div class="container">
      <div class="logo">
        <a href="../index.html">
          <img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer" />
        </a>
      </div>
      <div class="auth-buttons">
        <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button>
        <button id="logoutBtn" class="btn btn-login">LOG OUT</button>
      </div>
    </div>
  </header>

  <div class="dashboard-container">
    <aside class="sidebar slide-in" id="sidebar">
      <button id="toggleSidebar">‚ò∞</button>
      <nav>
        <ul>
          <li><a href="dashboard.html"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
          <li><a href="soundboard.html"><span class="icon">üéµ</span><span class="label">Soundboard</span></a></li>
          <li><a href="games.html"><span class="icon">üéÆ</span><span class="label">Games</span></a></li>
          <li><a href="apps.html" class="active"><span class="icon">‚ú®</span><span class="label">Apps</span></a></li>
          <li><a href="settings.html"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a></li>
          <li><a href="#" id="signOutLink"><span class="icon">üîí</span><span class="label">LOG OUT</span></a></li>
        </ul>
      </nav>
    </aside>

    <main class="main-content">
      <div class="dashboard-header fade-in">
        <h2 class="dashboard-title">OTHERS</h2>
        <div class="header-actions">
            <input type="search" id="app-search-input" class="app-search-bar" placeholder="Search apps...">
            <button id="reset-layout-btn" class="header-btn" title="Reset Layout">
                <img src="../images/refresh-dark.png" alt="Reset">
            </button>
        </div>
      </div>

      <div class="tiles-grid" id="tilesGrid">
        </div>
    </main>
  </div>
 
  <div id="edit-mode-hint"></div>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="../firebase-config.js"></script>
  <script>
    // --- DOM Elements ---
    const tilesGrid = document.getElementById('tilesGrid');
    const editModeHint = document.getElementById('edit-mode-hint');
    const appSearchInput = document.getElementById('app-search-input');

    // --- Firebase Refs ---
    let currentUser = null;
    const userProfileDocRef = () => currentUser ? firebase.firestore().collection('users').doc(currentUser.uid) : null;

    // --- Data & State Management ---
    const LAYOUT_STORAGE_KEY = '4sp_othersPageLayout_v16_list';
    let layoutData = [];
    let selectedId = null;

    // --- Data Source with EXPANDED DESCRIPTIONS ---
    const defaultTiles = [
      { id: 'msg-tutorial', href: 'messenger-tutorial.html', icon: 'üì±', title: 'MESSENGER TUTORIAL', description: 'Follow this comprehensive guide to access the Chromebook Messenger application. It leverages a secure Firebase backend for real-time, worldwide communication and reliable message saving.', stats: [{ number: 'SECURE', label: 'Talking' }, { number: 'FIREBASE', label: 'Saving' }, { number: 'GLOBAL', label: 'Chat' }] },
      { id: 'playlists', href: 'playlists.html', icon: 'üéº', title: 'PLAYLISTS', description: 'Create and manage an unlimited number of custom soundboard playlists. This tool allows you to organize your favorite sounds and share them easily with others via secure encoded files.', stats: [{ number: '‚àû', label: 'Playlists' }, { number: 'ENCODED', label: 'Sharing' }, { number: 'ANNOY', label: 'People' }] },
      { id: 'notes', href: 'notes.html', icon: 'üìù', title: 'NOTES', description: 'A powerful and versatile notes application with all data saved directly and securely in your local browser storage. Features include note coloring for organization and password protection for privacy.', stats: [{ number: 'SECURE', label: 'Passwords' }, { number: 'COLOR', label: 'Notes' }, { number: 'LOCAL', label: 'Save' }] },
      { id: 'weather', href: 'weather.html', icon: '‚õÖ', title: 'WEATHER', description: 'Get detailed weather information with a 24-hour hourly breakdown and an extended 14-day forecast. You can save your preferred location for quick access to local weather conditions.', stats: [{ number: 'DETAIL', label: 'Cards' }, { number: '24 HR', label: 'Forecast' }, { number: 'SAVED', label: 'Location' }] },
      { id: 'requests', href: 'requests.html', icon: 'üéµ', title: 'REQUESTS', description: 'Use this portal to submit requests for new sounds and application features, or to report any issues you encounter. You can choose to make your submissions public or keep them anonymous.', stats: [{ number: 'PUBLIC', label: 'Requests' }, { number: 'FAST', label: 'Handling' }, { number: 'WEEKDAY', label: 'Access' }] },
      { id: 'countdowns', href: 'countdowns.html', icon: 'üóì', title: 'COUNTDOWNS', description: 'Never miss an important date again. Create, manage, and track countdowns for any upcoming event, with all data saved securely and locally in your browser for quick and private access.', stats: [{ number: 'SECURE', label: 'Saving' }, { number: 'MANAGE', label: 'Events' }, { number: 'LOCAL', label: 'Save' }] },
      { id: 'grade-calculator', href: 'grade-calculator.html', icon: 'üìì', title: 'GRADE CALCULATOR', description: 'Easily calculate your academic grades for any class using the standard USA grading scale. All entered data is saved locally on your device, ensuring your information remains private.', stats: [{ number: 'LOCAL', label: 'Saving' }, { number: 'USA', label: 'Scale' }, { number: 'KNOW', label: 'Grades' }] },
      { id: 'lme', href: 'lme.html', icon: 'üè´', title: 'LME', description: 'Explore a fake learning management portal designed with a nostalgic 2000s web aesthetic. It serves as a unique and interactive environment where the answers are always easy to find.', stats: [{ number: 'FAKE', label: 'Portal' }, { number: '2000\'S', label: 'Aesthetic' }, { number: 'EASY', label: 'Answers' }] },
      { id: 'slotz', href: 'slotz.html', icon: 'üé∞', title: 'SLOTZ', description: 'Experience the excitement of a classic slot machine game. Test your luck, spin the reels, and track your performance on a personal leaderboard that saves your high scores locally.', stats: [{ number: 'PERSONAL', label: 'Board' }, { number: 'CLASSIC', label: 'Slots' }, { number: 'FUN', label: 'Addiction' }] },
    ];

    function saveLayout() {
      localStorage.setItem(LAYOUT_STORAGE_KEY, JSON.stringify(layoutData));
    }

    function loadLayout() {
      const savedLayout = localStorage.getItem(LAYOUT_STORAGE_KEY);
      if (savedLayout) {
        layoutData = JSON.parse(savedLayout);
      } else {
        layoutData = [...defaultTiles];
      }
    }
   
    // --- Rendering Functions ---
    function renderLayout() {
      const currentScroll = { x: window.scrollX, y: window.scrollY };
      tilesGrid.innerHTML = '';
      layoutData.forEach(item => {
        const element = createTileElement(item);
        tilesGrid.appendChild(element);
      });
      Array.from(tilesGrid.children).forEach((child, index) => {
        child.style.animation = `fadeInGeneral 0.5s ease-out ${index * 0.05}s forwards`;
      });
      window.scrollTo(currentScroll.x, currentScroll.y);
    }

    function createTileElement(tileData) {
      const a = document.createElement('a');
      a.href = tileData.href;
      a.className = 'grid-item';
      a.dataset.id = tileData.id;
      let statsHTML = tileData.stats.map(stat => `
        <div class="stat-item">
          <span class="stat-number">${stat.number}</span>
          <span class="stat-label">${stat.label}</span>
        </div>`).join('');

      a.innerHTML = `
        <div class="feature-tile">
          <div class="tile-icon">${tileData.icon}</div>
          <div class="tile-main-content">
            <h3 class="tile-title">${tileData.title}</h3>
            <p class="tile-description">${tileData.description || ''}</p>
          </div>
          <div class="tile-key-stats">${statsHTML}</div>
        </div>`;
     
      a.addEventListener('contextmenu', e => toggleEditMode(e, tileData.id));
      return a;
    }

    // --- ‚úÖ NEW: Advanced Animation Logic ---
    function filterApps() {
        const searchTerm = appSearchInput.value.toLowerCase().trim();

        // --- Phase 1: Fade out excluded cards ---
        const firstPositions = new Map();
        const allTiles = [...tilesGrid.children];
        
        allTiles.forEach(tile => {
            // Record position of cards that are currently visible
            if (!tile.classList.contains('is-hidden')) {
                firstPositions.set(tile, tile.getBoundingClientRect());
            }
            // Decide which cards to fade out
            const isMatch = tile.querySelector('.tile-title').textContent.toLowerCase().includes(searchTerm);
            if (!isMatch) {
                tile.classList.add('is-filtering-out');
            }
        });

        // --- Phase 2: After fade-out, slide remaining cards ---
        // We wait for the fade animation (250ms) to finish
        setTimeout(() => {
            // Apply the layout change by hiding the faded cards
            allTiles.forEach(tile => {
                const isMatch = tile.querySelector('.tile-title').textContent.toLowerCase().includes(searchTerm);
                if (isMatch) {
                    tile.classList.remove('is-hidden', 'is-filtering-out');
                } else {
                    tile.classList.add('is-hidden');
                }
            });
            
            // For the satisfying click sound you wanted!
            // You would need to have a click.mp3 file in your project for this.
            // new Audio('path/to/click.mp3').play();
            
            // --- The FLIP Animation ---
            const movingTiles = [];
            allTiles.forEach(tile => {
                if (!tile.classList.contains('is-hidden')) {
                    movingTiles.push(tile);
                    // LAST: Get the new position
                    const lastPos = tile.getBoundingClientRect();
                    // Get the original position
                    const firstPos = firstPositions.get(tile);

                    // If it doesn't have a first position, it's a new card. Let it fade in normally.
                    if (!firstPos) return;

                    // INVERT: Calculate the difference and apply a transform to move it
                    // back to its original spot, but without animation.
                    const deltaX = firstPos.left - lastPos.left;
                    const deltaY = firstPos.top - lastPos.top;
                    
                    if (deltaX !== 0 || deltaY !== 0) {
                        tile.classList.add('no-transition');
                        tile.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
                    }
                }
            });

            // Force the browser to paint the "inverted" state. This is crucial.
            tilesGrid.offsetHeight; 

            // PLAY: Remove the classes and styles to let the cards animate
            // to their final position with the jitter effect.
            movingTiles.forEach(tile => {
                tile.classList.remove('no-transition');
                tile.style.transform = '';
            });

        }, 250); // This MUST match the opacity transition duration
    }
   
    // --- Edit Mode & UI ---
    function toggleEditMode(event, itemId) {
        event.preventDefault();
        event.stopPropagation();
        const currentlyEditing = selectedId === itemId;
        exitEditMode(); 
        if (!currentlyEditing) {
            enterEditMode(itemId);
        }
    }

    function enterEditMode(itemId) {
        const itemElement = document.querySelector(`.grid-item[data-id="${itemId}"]`);
        if (!itemElement) return;
        selectedId = itemId;
        itemElement.classList.add('is-editing');
        itemElement.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
        updateHint();
    }

    function exitEditMode() {
        if (selectedId) {
            const oldElement = document.querySelector(`.grid-item[data-id="${selectedId}"]`);
            if (oldElement) oldElement.classList.remove('is-editing');
        }
        selectedId = null;
        updateHint();
    }

    function updateHint() {
        if (!selectedId) {
            editModeHint.classList.remove('visible');
            return;
        }
        const itemInfo = layoutData.find(item => item.id === selectedId);
        let hintHTML = `Editing '<span style="color: #FFC107;">${itemInfo.title}</span>' <span class="hint-divider"></span> Use <kbd>‚Üë</kbd><kbd>‚Üì</kbd> to Reorder <span class="hint-divider"></span> <kbd>Esc</kbd> Exit`;
        editModeHint.innerHTML = hintHTML;
        editModeHint.classList.add('visible');
    }

    // --- Data Manipulation Functions ---
    function moveItem(direction) {
        if (!selectedId) return;
       
        const currentIndex = layoutData.findIndex(item => item.id === selectedId);
        if (currentIndex === -1) return;

        let targetIndex = -1;
        const itemsPerRow = getItemsPerRow();

        switch (direction) {
            case 'up':
                targetIndex = currentIndex - itemsPerRow;
                break;
            case 'down':
                targetIndex = currentIndex + itemsPerRow;
                break;
            default:
                return;
        }
       
        if (targetIndex < 0 || targetIndex >= layoutData.length) {
            return;
        }

        const itemToMove = layoutData[currentIndex];
        const itemToSwap = layoutData[targetIndex];
        layoutData[targetIndex] = itemToMove;
        layoutData[currentIndex] = itemToSwap;
       
        saveLayout();
        renderLayout();
        enterEditMode(selectedId);
    }
   
    function getItemsPerRow() {
      return 1;
    }
   
    // --- Keyboard & Global Listeners ---
    function handleKeyDown(event) {
        if (!selectedId) return;
        
        switch(event.key) {
            case "Escape":
                exitEditMode();
                break;
            case "ArrowLeft":
            case "ArrowRight":
                break;
            case "ArrowUp":
                event.preventDefault();
                moveItem('up');
                break;
            case "ArrowDown":
                event.preventDefault();
                moveItem('down');
                break;
        }
    }
   
    function resetLayout() {
        if (confirm("Are you sure you want to reset the layout to the default? This cannot be undone.")) {
            localStorage.removeItem(LAYOUT_STORAGE_KEY);
            location.reload();
        }
    }

    // --- Sidebar & Auth ---
    const handleLogout = () => {
      firebase.auth().signOut().then(() => (location.href = '../login.html')).catch(error => console.error('Logout error:', error));
    };
   
    // --- Initial Setup ---
    document.addEventListener('DOMContentLoaded', () => {
      const sidebar = document.getElementById('sidebar');
      const toggleSidebarBtn = document.getElementById('toggleSidebar');
      if (toggleSidebarBtn && sidebar) {
        toggleSidebarBtn.addEventListener('click', () => sidebar.classList.toggle('collapsed'));
      }
      document.getElementById('logoutBtn').onclick = handleLogout;
      document.getElementById('signOutLink').onclick = handleLogout;
      document.getElementById('reset-layout-btn').addEventListener('click', resetLayout);
      document.addEventListener('keydown', handleKeyDown);
      document.addEventListener('click', (e) => { if (!e.target.closest('.grid-item')) exitEditMode(); });
      
      appSearchInput.addEventListener('input', filterApps);
      
      loadLayout();
      renderLayout();
    });

    firebase.auth().onAuthStateChanged(async user => {
      currentUser = user;
      if (!user) location.href = '../login.html';
    });
  </script>
</body>
</html>
