<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>4SP - CARD</title>
  <link rel="stylesheet" href="../css/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <script src="../panic-key.js"></script>
  <script src="../ban-enforcer.js"></script>
  <script src="../url-changer.js"></script>

  <style>
    /* Using styles from requests.html as a base and simplifying */
    body.dashboard-page { display: flex; flex-direction: column; min-height: 100vh; margin: 0; font-family: PrimaryFont, sans-serif; }
    .dashboard-container { display: flex; flex: 1; }
    .sidebar { width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%); color: #fff; padding: 20px 10px; display: flex; flex-direction: column; border-right: 1px solid #444; transition: width 0.5s ease-in-out; position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
    .sidebar.collapsed { width: 85px; }
    #toggleSidebar { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: none; border: none; color: #fff; font-size: 1.2em; cursor: pointer; padding: 4px; transition: transform 0.5s ease-in-out; }
    .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
    .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
    .sidebar nav li { margin-bottom: 10px; }
    .sidebar nav a { display: flex; align-items: center; padding: 12px 15px; color: #fff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; font-family: 'PrimaryFont', sans-serif; text-transform: uppercase; }
    .sidebar nav a.active, .sidebar nav a:hover { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); transform: translateX(5px); }
    .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
    .sidebar nav a .label { margin-left: 10px; white-space: nowrap; opacity: 1; visibility: visible; transition: opacity 0.2s ease-in-out; transition-delay: 0.4s; }
    .sidebar.collapsed nav a .label { opacity: 0; visibility: hidden; transition-delay: 0s; }
    .main-content { flex: 1; padding: 30px; background: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%); overflow-y: auto; position: relative; display: flex; flex-direction: column; }
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: linear-gradient(to right, #ffffff, #f8f9fa); padding: 15px 20px; border-radius: 12px; box-shadow: 0 6px 25px rgba(0,0,0,0.06); }
    .header-user-info .username { font-family: PrimaryFont, sans-serif; font-size: 1.2em; font-weight: bold; color: #333; }
    .header-user-info .email { font-family: SecondaryFont, sans-serif; font-size: 0.9em; color: #777; }
    #createRequestBtn { border: none; color: #fff; padding: 10px 20px; border-radius: 10px; font-family: PrimaryFont, sans-serif; cursor: pointer; transition: all 0.3s ease; font-size: 0.95em; font-weight: 600; display: flex; align-items: center; gap: 8px; background: linear-gradient(135deg, #7b2cbf 0%, #9d4edd 100%); box-shadow: 0 4px 15px rgba(123, 44, 191, 0.2); }
    #createRequestBtn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(123, 44, 191, 0.3); }
    .requests-display-card { background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); }
    .requests-controls { display: flex; gap: 15px; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
    .requests-controls input[type="search"] { flex-grow: 1; min-width: 200px; padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; font-family: PrimaryFont, sans-serif; height: 38px; box-sizing: border-box; }
    #requestsList { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 15px; }
    .request-item { border: 1px solid #e0e0e0; border-radius: 12px; padding: 20px; background: #fdfdfd; display: flex; gap: 20px; transition: all 0.2s; position: relative; cursor: pointer; }
    .request-item:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.09); border-color: #d0d0d0; }
    .request-content { width: 100%; overflow: hidden; }
    .request-header { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
    .request-type-badge { padding: 4px 8px; border-radius: 8px; font-size: 0.8em; font-weight: bold; color: white; font-family: PrimaryFont, sans-serif; }
    .badge-idea { background: linear-gradient(135deg, #007bff 0%, #00bfff 100%); }
    .badge-todo { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
    .request-title { font-size: 1.15em; font-weight: 600; color: #2c3e50; margin: 5px 0 8px 0; font-family: PrimaryFont, sans-serif; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .request-description { font-size: 0.9em; color: #555; font-family: SecondaryFont, sans-serif; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .admin-status-info { font-size: 0.85em; margin-top: 10px; padding: 6px 10px; border-radius: 8px; font-family: PrimaryFont, sans-serif; font-weight: 500; border-left: 4px solid; }
    .status-completed { background-color: #d4edda; border-color: #155724; color: #155724; }
    .status-in-progress { background-color: #fff8e1; border-color: #ffb300; color: #c66900; }
    .request-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 12px; font-size: 0.8em; color: #777; border-top: 1px solid #f0f0f0; padding-top: 8px; font-family: SecondaryFont, sans-serif; }
    .card-actions { position: absolute; top: 8px; right: 8px; display: flex; gap: 5px; background: #fff; padding: 4px; border-radius: 16px; border: 1px solid #eee; }
    .card-action-btn { background: none; border: 1px solid #ddd; color: #555; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.8em; transition: all 0.2s ease; }
    .card-action-btn:hover { background: #eee; color: #000; border-color: #ccc; }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display:flex; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
    .modal-overlay.show { opacity: 1; pointer-events: auto; display: flex; }
    .modal-content { background: white; padding: 25px 30px; border-radius: 12px; width: 100%; box-shadow: 0 5px 25px rgba(0,0,0,0.2); max-width: 600px; transform: scale(0.95); opacity: 0; transition: opacity 0.3s ease, transform 0.3s ease; }
    .modal-overlay.show .modal-content { transform: scale(1); opacity: 1; }
    .modal-close-btn-redesigned { position: absolute; top: 12px; right: 12px; background-color: #f1f1f1; border: 1px solid #ddd; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; transition: all 0.2s ease; z-index: 10; padding: 0; display: flex; align-items: center; justify-content: center; }
    .modal-close-btn-redesigned:hover { background-color: #e0e0e0; transform: rotate(90deg); }
    .modal-close-btn-redesigned img { width: 55%; height: 55%; filter: invert(1); opacity: 0.7; }
    .modal-footer { margin-top: 25px; display: flex; justify-content: flex-end; }
    .btn-purple { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); color: white; border: none; padding: 10px 15px; border-radius: 8px; font-weight: 600; cursor: pointer; }
    .form-group { margin-bottom: 22px; } .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #3d475c; }
    .form-group input, .form-group select, .form-group textarea { font-family: PrimaryFont, sans-serif; background-color: #fff; border: 2px solid #e9ecef; border-radius: 8px; padding: 12px; width: 100%; box-sizing: border-box; transition: border-color 0.2s, box-shadow 0.2s; }
    .form-group textarea { resize: vertical; min-height: 120px; font-family: SecondaryFont, sans-serif; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: #8a2be2; box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.15); outline: none; }
    #reauth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(10, 10, 10, 0.75); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); z-index: 20000; display: flex; justify-content: center; align-items: center; color: white; text-align: center; font-family: PrimaryFont, sans-serif; }
    #reauth-box { background: rgba(255, 255, 255, 0.1); padding: 40px; border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.2); }
    #reauth-box h2 { margin-top: 0; } #reauth-box p { margin-bottom: 25px; max-width: 400px; color: #e0e0e0; }
    #reauth-btn { background: linear-gradient(135deg, #4285F4 0%, #3478e6 100%); color: #fff; border: none; padding: 12px 25px; border-radius: 8px; font-size: 1em; cursor: pointer; transition: all 0.3s ease; }
    #reauth-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3); }
    #loadingIndicator { text-align: center; padding: 40px; font-size: 1.2em; color: #555; }
    .dot-flashing { position: relative; width: 10px; height: 10px; border-radius: 5px; background-color: #8a2be2; color: #8a2be2; animation: dot-flashing 1s infinite linear alternate; animation-delay: .5s; }
    .dot-flashing::before, .dot-flashing::after { content: ''; display: inline-block; position: absolute; top: 0; }
    .dot-flashing::before { left: -15px; width: 10px; height: 10px; border-radius: 5px; background-color: #8a2be2; animation: dot-flashing 1s infinite alternate; animation-delay: 0s; }
    .dot-flashing::after { left: 15px; width: 10px; height: 10px; border-radius: 5px; background-color: #8a2be2; animation: dot-flashing 1s infinite alternate; animation-delay: 1s; }
    @keyframes dot-flashing { 0% { background-color: #8a2be2; } 50%, 100% { background-color: rgba(138, 43, 226, 0.2); } }
  </style>
</head>

<body class="dashboard-page">
  <div id="reauth-overlay">
    <div id="reauth-box">
      <h2><i class="fas fa-user-shield"></i> Admin Verification Required</h2>
      <p>This is a restricted area. Please re-authenticate your account to verify your administrator status and access the dashboard.</p>
      <button id="reauth-btn">Verify Admin Status</button>
      <p id="reauth-status" style="margin-top: 20px; min-height: 1.2em;"></p>
    </div>
  </div>

  <header class="main-header light-bg">
    <div class="container">
      <div class="logo"><a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo"/></a></div>
      <div class="auth-buttons"><button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button><button id="logoutBtn" class="btn btn-login">LOG OUT</button></div>
    </div>
  </header>
  
  <div class="dashboard-container">
    <aside class="sidebar" id="sidebar">
      <button id="toggleSidebar">‚ò∞</button>
      <nav>
        <ul>
          <li><a href="dashboard.html"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
          <li><a href="soundboard.html"><span class="icon">üéµ</span><span class="label">Soundboard</span></a></li>
          <li><a href="games.html"><span class="icon">üéÆ</span><span class="label">Games</span></a></li>
          <li><a href="apps.html"><span class="icon">‚ú®</span><span class="label">Apps</span></a></li>
          <li><a href="settings.html"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a></li>
          <li><a href="card.html" class="active"><span class="icon">üìã</span><span class="label">CARD</span></a></li>
          <li><a href="#" id="signOutLink"><span class="icon">üîí</span><span class="label">LOG OUT</span></a></li>
        </ul>
      </nav>
    </aside>

    <main class="main-content" id="mainContent" style="visibility: hidden;">
      <div class="page-header">
          <div class="header-user-info" id="headerUserInfo"><div class="username">Admin</div><div class="email">Loading...</div></div>
          <div class="header-actions"><button id="createRequestBtn" class="btn"><i class="fas fa-plus"></i>Create Request</button></div>
      </div>
      <div class="requests-display-card">
          <div class="requests-controls"><input type="search" id="searchBar" placeholder="Search admin requests..."></div>
          <ul id="requestsList"></ul>
          <div id="loadingIndicator"><div class="dot-flashing"></div></div>
      </div>
    </main>
  </div>

  <div id="detailsModal" class="modal-overlay">
      <div class="modal-content">
          <button class="modal-close-btn-redesigned"><img src="../images/cross-white.png" alt="Close"></button>
          <h3 id="modalTitle">Details</h3>
          <p id="modalDescription"></p>
      </div>
  </div>

  <div id="formModal" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-btn-redesigned"><img src="../images/cross-white.png" alt="Close"></button>
        <h3>Create Admin Request</h3>
        <form id="requestForm">
            <div class="form-group">
                <label for="requestType">Category</label>
                <select id="requestType" required><option value="todo">To-Do</option><option value="idea">Idea</option></select>
            </div>
            <div class="form-group">
                <label for="requestTitleForm">Title</label>
                <input type="text" id="requestTitleForm" placeholder="A brief summary..." required maxlength="60">
            </div>
            <div class="form-group">
                <label for="requestDescriptionForm">Details</label>
                <textarea id="requestDescriptionForm" placeholder="Add details, links, or notes..." required maxlength="500" rows="5"></textarea>
            </div>
        </form>
        <div class="modal-footer"><button type="submit" form="requestForm" id="submitRequestBtn" class="btn-purple">Submit Request</button></div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="../firebase-config.js"></script>

  <script>
    // --- Configuration & Globals ---
    const ADMIN_EMAILS = ["4simpleproblems@gmail.com", "belkwy30@minerva.sparcc.org"];
    let currentUser = null;

    // --- DOM Elements ---
    const reauthOverlay = document.getElementById('reauth-overlay');
    const reauthBtn = document.getElementById('reauth-btn');
    const reauthStatus = document.getElementById('reauth-status');
    const mainContent = document.getElementById('mainContent');
    const requestsListEl = document.getElementById('requestsList');
    const loadingIndicator = document.getElementById('loadingIndicator');

    // --- Core Authentication Flow ---
    firebase.auth().onAuthStateChanged(user => {
        if (!user) {
            window.location.href = '../login.html';
            return;
        }
        currentUser = user;
        document.querySelector('#headerUserInfo .email').textContent = user.email;

        // Check session storage for existing verification
        if (sessionStorage.getItem('isAdminAuthenticated') === 'true') {
            reauthOverlay.style.display = 'none';
            mainContent.style.visibility = 'visible';
            initializeApp();
        } else {
            reauthOverlay.style.display = 'flex';
            mainContent.style.visibility = 'hidden';
        }
    });

    reauthBtn.addEventListener('click', async () => {
        reauthStatus.textContent = 'Awaiting verification...';
        try {
            const provider = new firebase.auth.GoogleAuthProvider();
            await currentUser.reauthenticateWithPopup(provider);
            
            // Re-fetch the user object to get the latest token
            await currentUser.reload();
            const updatedUser = firebase.auth().currentUser;

            if (updatedUser && ADMIN_EMAILS.includes(updatedUser.email)) {
                reauthStatus.textContent = 'Success! Accessing dashboard...';
                sessionStorage.setItem('isAdminAuthenticated', 'true');
                setTimeout(() => {
                    reauthOverlay.style.display = 'none';
                    mainContent.style.visibility = 'visible';
                    initializeApp();
                }, 1000);
            } else {
                reauthStatus.textContent = 'Access Denied. You are not a registered administrator.';
                setTimeout(() => window.location.href = 'dashboard.html', 3000);
            }
        } catch (error) {
            console.error("Re-authentication failed:", error);
            reauthStatus.textContent = `Error: ${error.message}`;
        }
    });
    
    // --- Main App Logic (runs after verification) ---
    function initializeApp() {
        fetchAdminRequests();
        setupEventListeners();
    }

    async function fetchAdminRequests() {
        loadingIndicator.style.display = 'block';
        requestsListEl.innerHTML = '';
        const db = firebase.firestore();
        try {
            const snapshot = await db.collection('admin_requests').orderBy('timestamp', 'desc').get();
            if (snapshot.empty) {
                requestsListEl.innerHTML = '<li>No admin requests found. Create one to get started!</li>';
            } else {
                snapshot.forEach(doc => {
                    const request = { id: doc.id, ...doc.data() };
                    const li = document.createElement('li');
                    li.className = 'request-item';
                    li.dataset.id = request.id;
                    
                    const badgeClass = request.type === 'todo' ? 'badge-todo' : 'badge-idea';
                    const badgeText = request.type === 'todo' ? 'To-Do' : 'Idea';

                    li.innerHTML = `
                        <div class="request-content">
                            <div class="request-header">
                                <span class="request-type-badge ${badgeClass}">${badgeText}</span>
                            </div>
                            <h4 class="request-title" title="${request.title}">${request.title}</h4>
                            <p class="request-description">${request.description.substring(0, 100)}...</p>
                            <div class="request-footer">
                                <span>By <strong>${request.adminEmail}</strong> on ${request.timestamp.toDate().toLocaleDateString()}</span>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="card-action-btn delete-btn-card" title="Delete Request"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    `;
                    requestsListEl.appendChild(li);
                });
            }
        } catch (error) {
            console.error("Error fetching admin requests:", error);
            requestsListEl.innerHTML = `<li>Error: ${error.message}</li>`;
        } finally {
            loadingIndicator.style.display = 'none';
        }
    }
    
    // --- Event Listeners Setup ---
    function setupEventListeners() {
        document.getElementById('logoutBtn').onclick = () => { sessionStorage.removeItem('isAdminAuthenticated'); firebase.auth().signOut(); };
        document.getElementById('signOutLink').onclick = (e) => { e.preventDefault(); sessionStorage.removeItem('isAdminAuthenticated'); firebase.auth().signOut(); };
        document.getElementById('toggleSidebar').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('collapsed'));
        
        const formModal = document.getElementById('formModal');
        document.getElementById('createRequestBtn').addEventListener('click', () => formModal.classList.add('show'));
        formModal.querySelector('.modal-close-btn-redesigned').addEventListener('click', () => formModal.classList.remove('show'));
        
        document.getElementById('requestForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submissionData = {
                adminEmail: currentUser.email,
                type: document.getElementById('requestType').value,
                title: document.getElementById('requestTitleForm').value,
                description: document.getElementById('requestDescriptionForm').value,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'pending' // Default status
            };
            try {
                await firebase.firestore().collection('admin_requests').add(submissionData);
                formModal.classList.remove('show');
                fetchAdminRequests();
            } catch (error) {
                alert(`Failed to save request: ${error.message}`);
            }
        });

        requestsListEl.addEventListener('click', (e) => {
            const requestItem = e.target.closest('.request-item');
            if (!requestItem) return;
            const requestId = requestItem.dataset.id;

            if (e.target.closest('.delete-btn-card')) {
                e.stopPropagation();
                if (confirm('Are you sure you want to delete this admin request?')) {
                    firebase.firestore().collection('admin_requests').doc(requestId).delete()
                        .then(() => fetchAdminRequests())
                        .catch(err => alert(`Error deleting: ${err.message}`));
                }
            } else {
                // Open details modal if needed in the future
            }
        });

        document.getElementById('searchBar').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            document.querySelectorAll('#requestsList .request-item').forEach(item => {
                item.style.display = item.textContent.toLowerCase().includes(query) ? 'flex' : 'none';
            });
        });
    }
  </script>
</body>
</html>
