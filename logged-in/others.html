<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>4SP - OTHERS</title>
  <link rel="stylesheet" href="../css/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <script src="../panic-key.js"></script>
  <script src="../ban-enforcer.js"></script>
  <script src="../url-changer.js"></script>
  <style>
    /* --- Base Dashboard Layout --- */
    body.dashboard-page {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      margin: 0;
      font-family: 'PrimaryFont', sans-serif;
    }
    .dashboard-container {
      display: flex;
      flex: 1;
    }

    /* --- Sidebar --- */
    .sidebar {
      width: 200px;
      background: linear-gradient(180deg, #333 0%, #2a2a2a 100%);
      color: #fff;
      padding: 20px 10px;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #444;
      transition: width 0.5s ease-in-out;
      position: relative;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }
    .sidebar.collapsed {
      width: 85px;
    }
    #toggleSidebar {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: none;
      border: none;
      color: #fff;
      font-size: 1.2em;
      cursor: pointer;
      padding: 4px;
      transition: transform 0.5s ease-in-out;
    }
    .sidebar.collapsed #toggleSidebar {
      transform: translateX(-50%) rotate(180deg);
    }
    .sidebar nav ul {
      list-style: none;
      padding: 0;
      margin: 60px 0 0;
    }
    .sidebar nav li {
      margin-bottom: 10px;
    }
    .sidebar nav a {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      color: #fff;
      text-decoration: none;
      border-radius: 8px;
      transition: all 0.3s ease;
      font-family: 'PrimaryFont', sans-serif;
      text-transform: uppercase;
      position: relative;
      overflow: hidden;
    }
    .sidebar nav a::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transition: left 0.5s;
    }
    .sidebar nav a:hover::before {
      left: 100%;
    }
    .sidebar nav a.active,
    .sidebar nav a:hover {
      background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
      transform: translateX(5px);
    }
    .sidebar nav a .icon {
      font-size: 1.2em;
      width: 24px;
      text-align: center;
    }
    .sidebar nav a .label {
      margin-left: 10px;
      white-space: nowrap;
    }
    .sidebar.collapsed nav a {
      justify-content: center;
      padding: 10px 0;
    }
    .sidebar.collapsed nav a .label {
      display: none;
    }
    .user-info {
      text-align: center;
      margin: 60px 0 30px;
      border-bottom: 1px solid #555;
      padding-bottom: 20px;
      overflow: visible;
    }
    .marquee-container {
      overflow: hidden;
      white-space: nowrap;
      position: relative;
      width: 100%;
      height: 1.8em;
      line-height: 1.8em;
    }
    .marquee-content {
      display: inline-block;
      padding-left: 100%;
      transform: translateX(0);
      animation: none;
      line-height: 1.8em;
    }
    .marquee-active {
      animation: scroll-left 12s linear infinite;
    }
    .sidebar.collapsed .marquee-active {
      animation-duration: 20s;
    }
    @keyframes scroll-left {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }
    .user-info .username {
      font-family: 'PrimaryFont', sans-serif;
      font-size: 1.3em;
      margin-bottom: 8px;
      line-height: 0.2em;
      font-weight: bold;
    }
    .user-info .email {
      font-family: 'SecondaryFont', sans-serif;
      font-size: 0.9em;
      color: #bbb;
    }

    /* --- Main Content & Header --- */
    .main-content {
      flex: 1;
      padding: 30px;
      background: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
      overflow-y: auto;
      position: relative;
    }
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      background: white;
      padding: 20px 30px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      border: 1px solid rgba(103, 32, 189, 0.1);
      flex-shrink: 0;
    }
    .dashboard-title {
      margin: 0;
      font-size: 2.0em;
      font-weight: bold;
      background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    #reset-layout-btn {
        width: 40px;
        height: 40px;
        background-color: #f0f2f5;
        border: 1px solid #e0e0e0;
        border-radius: 12px; /* Squircle shape */
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease-in-out;
    }
    #reset-layout-btn:hover {
        background-color: #e0e0e0;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    #reset-layout-btn img {
        width: 22px;
        height: 22px;
    }

    /* --- Grid System --- */
    .tiles-grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 25px;
        align-items: stretch;
    }

    /* --- Tile Styles (applies to both links and folders) --- */
    .grid-item {
        color: inherit;
        text-decoration: none;
        display: flex;
        border-radius: 15px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        position: relative;
    }
    .grid-item[data-size="normal"] { grid-column: span 4; }
    .grid-item[data-size="medium"] { grid-column: span 8; }
    .grid-item[data-size="wide"] { grid-column: span 12; }
    
    .grid-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 25px rgba(103, 32, 189, 0.15);
    }

    .feature-tile {
        background: #ffffff;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.07);
        border: 1px solid rgba(103, 32, 189, 0.08);
        display: flex;
        justify-content: space-between;
        overflow: hidden;
        width: 100%;
        box-sizing: border-box;
    }
    .tile-main-content {
        flex: 1;
        padding-right: 15px;
        display: flex;
        flex-direction: column;
    }
    .tile-icon {
        font-size: 2.5em;
        color: #6720bd;
        margin-bottom: 10px;
    }
    .tile-title {
        font-size: 1.3em;
        font-weight: bold;
        color: #333;
        margin-top: 0;
        margin-bottom: 8px;
    }
    .tile-description {
        font-size: 0.9em;
        color: #555;
        line-height: 1.5;
        flex-grow: 1;
        margin-bottom: 0;
    }
    .tile-key-stats {
        flex-basis: 100px;
        flex-shrink: 0;
        border-left: 1px solid #e8eaf0;
        padding-left: 15px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
    }
    .stat-item { margin-bottom: 8px; }
    .stat-item:last-child { margin-bottom: 0; }
    .stat-number {
        display: block;
        font-size: 2em;
        font-weight: bold;
        color: #6720bd;
        line-height: 1.1;
    }
    .stat-label {
        display: block;
        font-size: 0.75em;
        color: #777;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 2px;
    }

    /* --- Folder Styles --- */
    .folder-container {
        grid-column: span 12;
        background-color: rgba(103, 32, 189, 0.05);
        padding: 15px;
        border-radius: 15px;
        border: 1px dashed rgba(103, 32, 189, 0.2);
        display: block;
    }
    .folder-header {
        display: flex;
        align-items: center;
        cursor: pointer;
        padding: 5px;
        border-radius: 10px;
        transition: background-color 0.2s ease;
    }
    .folder-header:hover {
        background-color: rgba(103, 32, 189, 0.1);
    }
    .folder-toggle-icon {
        font-size: 1.5em;
        margin-right: 15px;
        transition: transform 0.3s ease;
    }
    .folder-container.collapsed .folder-toggle-icon {
        transform: rotate(-90deg);
    }
    .folder-title {
        font-size: 1.4em;
        font-weight: bold;
        color: #6720bd;
        margin: 0;
    }
    .folder-content {
        padding: 20px 0 5px 50px;
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 25px;
        align-items: stretch;
        max-height: 2000px;
        overflow: hidden;
        transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
    }
    .folder-container.collapsed .folder-content {
        max-height: 0;
        padding-top: 0;
        padding-bottom: 0;
    }

    /* --- Edit Mode Styles --- */
    .grid-item.is-editing {
        transform: scale(1.03);
        box-shadow: 0 15px 40px rgba(103, 32, 189, 0.25);
        z-index: 100;
        outline: 3px dotted #FFC107;
        outline-offset: 4px;
    }
    .grid-item.is-editing::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: rgba(255, 229, 100, 0.4);
        border-radius: 15px;
        z-index: 1;
        pointer-events: none;
    }
    .grid-item.is-flagged::before {
        background-color: rgba(255, 152, 0, 0.5);
    }
    .grid-item.is-selected {
        outline: 3px dotted #1982c4;
    }
    .grid-item.is-selected::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background-color: rgba(25, 130, 196, 0.4);
        border-radius: 15px;
        z-index: 1;
        pointer-events: none;
    }


    /* --- Edit Mode Hint Bar --- */
    #edit-mode-hint {
        position: fixed;
        bottom: -100px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(40, 40, 40, 0.9);
        backdrop-filter: blur(5px);
        color: white;
        padding: 12px 25px;
        border-radius: 12px;
        z-index: 10001;
        font-family: 'PrimaryFont', sans-serif;
        font-size: 0.9em;
        transition: bottom 0.4s ease-in-out;
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
        justify-content: center;
    }
    #edit-mode-hint.visible {
        bottom: 20px;
    }
    #edit-mode-hint kbd {
        background-color: #555;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.9em;
    }
    .hint-divider {
        width: 1px;
        height: 14px;
        background-color: #666;
    }
    
    /* --- Custom Rename Modal --- */
    .rename-modal-backdrop {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.6);
        backdrop-filter: blur(5px);
        z-index: 10002;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s;
    }
    .rename-modal-backdrop.visible {
        opacity: 1;
        visibility: visible;
    }
    .rename-modal {
        background: #fff;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        width: 90%;
        max-width: 400px;
        font-family: 'PrimaryFont', sans-serif;
        transform: scale(0.95);
        transition: transform 0.3s ease;
    }
    .rename-modal-backdrop.visible .rename-modal {
        transform: scale(1);
    }
    .rename-modal h3 {
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 1.3em;
    }
    .rename-modal input {
        width: 100%;
        padding: 12px;
        font-size: 1em;
        border: 1px solid #ccc;
        border-radius: 8px;
        margin-bottom: 15px;
        box-sizing: border-box;
        font-family: 'PrimaryFont', sans-serif;
    }
    .rename-modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
    .rename-modal-actions button {
        padding: 10px 20px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-family: 'PrimaryFont', sans-serif;
        font-weight: bold;
    }
    #rename-save-btn {
        background-color: #6720bd;
        color: white;
    }
    #rename-cancel-btn {
        background-color: #eee;
        color: #333;
    }

    /* --- Responsive adjustments --- */
    @media (max-width: 1200px) {
      .tiles-grid, .folder-content {
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      }
      .grid-item { grid-column: auto !important; }
    }
    @media (max-width: 768px) {
      .tiles-grid, .folder-content {
        grid-template-columns: 1fr;
      }
      .feature-tile { flex-direction: column; }
      .tile-main-content { padding-right: 0; margin-bottom: 15px; }
      .tile-key-stats {
        flex-basis: auto;
        border-left: none;
        padding-left: 0;
        border-top: 1px solid #e8eaf0;
        padding-top: 15px;
        flex-direction: row;
        justify-content: space-around;
        gap: 10px;
      }
      .stat-item { margin-bottom: 0; }
      .stat-number { font-size: 1.6em; }
      .stat-label { font-size: 0.7em; }
    }

    /* Animation for fade-in */
    .fade-in { animation: fadeInGeneral 0.5s ease-out forwards; }
    @keyframes fadeInGeneral { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .slide-in { animation: slideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
    @keyframes slideIn { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  </style>
</head>

<body class="dashboard-page">
  <header class="main-header light-bg">
    <div class="container">
      <div class="logo">
        <a href="../index.html">
          <img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer" />
        </a>
      </div>
      <div class="auth-buttons">
        <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button>
        <button id="logoutBtn" class="btn btn-login">LOG OUT</button>
      </div>
    </div>
  </header>

  <div class="dashboard-container">
    <aside class="sidebar slide-in" id="sidebar">
      <button id="toggleSidebar">‚ò∞</button>
      <div class="user-info">
        <div class="marquee-container">
          <span id="userName" class="marquee-content username">Loading‚Ä¶</span>
        </div>
        <div class="marquee-container">
          <span id="userEmail" class="marquee-content email">Loading‚Ä¶</span>
        </div>
      </div>
      <nav>
        <ul>
          <li><a href="dashboard.html"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
          <li><a href="soundboard.html"><span class="icon">üéµ</span><span class="label">Soundboard</span></a></li>
          <li><a href="games.html"><span class="icon">üéÆ</span><span class="label">Games</span></a></li>
          <li><a href="others.html" class="active"><span class="icon">‚ú®</span><span class="label">Others</span></a></li>
          <li><a href="settings.html"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a></li>
          <li><a href="#" id="signOutLink"><span class="icon">üîí</span><span class="label">LOG OUT</span></a></li>
        </ul>
      </nav>
    </aside>

    <main class="main-content">
      <div class="dashboard-header fade-in">
        <h2 class="dashboard-title">OTHERS</h2>
        <button id="reset-layout-btn" title="Reset Layout">
            <img src="../images/refresh-dark.png" alt="Reset">
        </button>
      </div>

      <div class="tiles-grid" id="tilesGrid">
        </div>
    </main>
  </div>
  
  <div id="edit-mode-hint"></div>
  
  <div id="rename-modal-backdrop" class="rename-modal-backdrop">
    <div class="rename-modal">
        <h3>Rename Folder</h3>
        <input type="text" id="rename-input" placeholder="Enter new folder name...">
        <div class="rename-modal-actions">
            <button id="rename-cancel-btn">Cancel</button>
            <button id="rename-save-btn">Save</button>
        </div>
    </div>
  </div>


  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="../firebase-config.js"></script>
  <script>
    // --- DOM Elements ---
    const marqueeEls = document.querySelectorAll('.marquee-content');
    const sidebarUserNameEl = document.getElementById('userName');
    const sidebarUserEmailEl = document.getElementById('userEmail');
    const tilesGrid = document.getElementById('tilesGrid');
    const editModeHint = document.getElementById('edit-mode-hint');
    const renameModalBackdrop = document.getElementById('rename-modal-backdrop');
    const renameInput = document.getElementById('rename-input');

    // --- Firebase Refs ---
    let currentUser = null;
    const userProfileDocRef = () => currentUser ? firebase.firestore().collection('users').doc(currentUser.uid) : null;

    // --- Data & State Management ---
    const LAYOUT_STORAGE_KEY = '4sp_othersPageLayout_v10';
    let layoutData = [];
    let editModeState = { 
        selectedId: null, 
        mode: 'normal', // 'normal', 'flagged-for-creation', 'adding-to-folder'
        selectionGroup: [] 
    };

    const defaultTiles = [
      { id: 'notes', type: 'tile', size: 'normal', href: 'notes.html', icon: 'üìù', title: 'NOTES', 
        description_short: 'Jot down ideas with local saving.',
        description_medium: 'A versatile notes app with local saving, note coloring, and password protection for security.',
        description_wide: 'Create, manage, and secure your thoughts with a versatile notes application. Features include local saving for offline access, custom note coloring for organization, and optional password protection for your sensitive information.',
        stats: [{ number: 'SECURE', label: 'Passwords' }, { number: 'NOTE', label: 'Coloring' }, { number: 'SYNC', label: 'Local Save' }] },
      { id: 'calculator', type: 'tile', size: 'normal', href: 'calculator.html', icon: 'üßÆ', title: 'CALCULATOR',
        description_short: 'A sleek and simple calculator.',
        description_medium: 'A sleekly designed calculator with useful keyboard shortcuts for pi, sine, and square root.',
        description_wide: 'Perform calculations with ease using this sleekly designed calculator. It features essential functions and handy keyboard shortcuts for scientific constants and operations, all within a clean, modern interface.',
        stats: [{ number: '1', label: 'Mode' }, { number: 'SLEEK', label: 'Design' }, { number: 'JUST', label: 'A Calculator üòà' }] },
      { id: 'countdowns', type: 'tile', size: 'normal', href: 'countdowns.html', icon: 'üìä', title: 'COUNTDOWNS',
        description_short: 'Create and manage countdowns.',
        description_medium: 'Create, manage, and securely save countdowns for any important event directly in your browser.',
        description_wide: 'Track upcoming events with a personal countdown manager. Create an unlimited number of countdowns, which are securely saved locally in your browser for privacy and immediate access.',
        stats: [{ number: 'SECURITY', label: 'pretty private ig' }, { number: 'MANAGE', label: 'Countdowns' }, { number: 'SYNC', label: 'Local Save' }] },
      { id: 'playlists', type: 'tile', size: 'normal', href: 'playlists.html', icon: 'üéº', title: 'PLAYLISTS',
        description_short: 'Create and share soundboard playlists.',
        description_medium: 'Manage unlimited soundboard playlists and share them with others via secure encoded files.',
        description_wide: 'Unleash your creativity by creating and managing an infinite number of soundboard playlists. Easily share your collections with friends using a secure, encoded file format, perfect for any occasion.',
        stats: [{ number: '‚àû', label: 'Playlists' }, { number: 'ENCODED', label: 'Sharing' }, { number: 'ANNOY', label: 'People' }] },
      { id: 'grade-calculator', type: 'tile', size: 'normal', href: 'grade-calculator.html', icon: 'üìì', title: 'GRADE CALCULATOR',
        description_short: 'Keep track of your class grades.',
        description_medium: 'Calculate your grades for any class using the USA grading scale, with all data saved locally.',
        description_wide: 'Take control of your academic progress with the Grade Calculator. Add assignments, track your scores for each class, and see your current grade based on the USA grading scale, with all information saved securely on your device.',
        stats: [{ number: 'LOCAL', label: 'Saving' }, { number: 'KNOW', label: 'ur grades' }, { number: 'KNOW', label: 'if ur cooked' }] },
      { id: 'weather', type: 'tile', size: 'normal', href: 'weather.html', icon: '‚õÖ', title: 'WEATHER',
        description_short: 'Get local weather forecasts.',
        description_medium: 'View detailed 24-hour and 14-day forecasts with saved location preferences.',
        description_wide: 'Access accurate and detailed weather information for any location. This tool provides 24-hour and 14-day forecasts, including precipitation, wind speed, and sunrise/sunset times, and saves your preferred location for quick access.',
        stats: [{ number: 'DETAIL', label: 'Cards' }, { number: '24 HOUR', label: 'Forecast' }, { number: 'LOCATION', label: 'Local Save' }] },
      { id: 'slotz', type: 'tile', size: 'normal', href: 'slotz.html', icon: 'üé∞', title: 'SLOTZ',
        description_short: 'A classic slot machine game.',
        description_medium: 'Experience the thrill of a classic slot machine game and track your high scores on a personal leaderboard.',
        description_wide: 'Test your luck with Slotz, the classic slot machine game from version 3. Spin the reels, aim for the jackpot, and climb the ranks of your own personal leaderboard to track your greatest wins.',
        stats: [{ number: 'PERSONAL', label: 'Leaderboard' }, { number: 'EXPERIENCE', label: 'Gambling' }, { number: 'GAIN', label: 'Addiction' }] },
      { id: 'lme', type: 'tile', size: 'normal', href: 'lme.html', icon: 'üè´', title: 'LME',
        description_short: 'A fake learning portal with a retro vibe.',
        description_medium: 'Navigate a fake learning portal designed with a 2000s aesthetic where the answers are always easy to find.',
        description_wide: 'Experience a blast from the past with LME, a parody of early 2000s online learning portals. This fake educational tool is designed to be effortlessly easy, with a unique visual aesthetic and straightforward quizzes.',
        stats: [{ number: 'FAKE', label: 'Learning Portal' }, { number: '2000\'S', label: 'Aesthetic' }, { number: 'REALLY', label: 'Easy?' }] },
      { id: 'requests', type: 'tile', size: 'normal', href: 'requests.html', icon: 'üéµ', title: 'REQUESTS',
        description_short: 'Request features and report issues.',
        description_medium: 'Submit public or anonymous requests for new sounds and features, or report issues for quick handling.',
        description_wide: 'Help improve 4SP by requesting new sounds, suggesting features, and reporting issues. You can submit your feedback publicly or anonymously, ensuring a quick response and resolution from the development team.',
        stats: [{ number: 'REQUESTS', label: 'Public/Anonymous' }, { number: 'FAST', label: 'Issue-Handling' }, { number: 'WEEKDAY', label: 'Access' }] },
    ];

    function saveLayout() {
      localStorage.setItem(LAYOUT_STORAGE_KEY, JSON.stringify(layoutData));
    }

    function loadLayout() {
      const savedLayout = localStorage.getItem(LAYOUT_STORAGE_KEY);
      if (savedLayout) {
        layoutData = JSON.parse(savedLayout);
      } else {
        layoutData = [...defaultTiles];
      }
    }
    
    // --- Automatic Sorting Logic ---
    function getSortedLayout(items) {
        const tiles = items.filter(item => item.type === 'tile');
        const mediumTilesCount = tiles.filter(tile => tile.size === 'medium').length;

        if (mediumTilesCount > 0 && mediumTilesCount % 2 === 0) {
            const sizeOrder = { 'wide': 1, 'medium': 2, 'normal': 3 };
            const sortedItems = [...items];

            sortedItems.sort((a, b) => {
                const isAFolder = a.type === 'folder';
                const isBFolder = b.type === 'folder';

                if (isAFolder && !isBFolder) return -1;
                if (!isAFolder && isBFolder) return 1;
                if (isAFolder && isBFolder) return 0;

                const orderA = sizeOrder[a.size] || 99;
                const orderB = sizeOrder[b.size] || 99;
                return orderA - orderB;
            });
            return sortedItems;
        }
        return items;
    }
    
    // --- Rendering Functions ---
    function renderLayout() {
      tilesGrid.innerHTML = '';
      const currentLayout = getSortedLayout(layoutData);
      
      currentLayout.forEach(item => {
        let element;
        if (item.type === 'folder') {
          element = createFolderElement(item);
        } else {
          element = createTileElement(item);
        }
        tilesGrid.appendChild(element);
      });
      
      Array.from(tilesGrid.children).forEach((child, index) => {
        child.style.animation = `fadeInGeneral 0.5s ease-out ${index * 0.05}s forwards`;
      });
    }

    function createTileElement(tileData) {
      const a = document.createElement('a');
      a.href = tileData.href;
      a.className = 'grid-item';
      a.dataset.id = tileData.id;
      a.dataset.size = tileData.size || 'normal';

      let descriptionText;
      switch (tileData.size) {
        case 'wide':
            descriptionText = tileData.description_wide;
            break;
        case 'medium':
            descriptionText = tileData.description_medium;
            break;
        default:
            descriptionText = tileData.description_short;
      }
      
      let statsHTML = tileData.stats.map(stat => `
        <div class="stat-item">
          <span class="stat-number">${stat.number}</span>
          <span class="stat-label">${stat.label}</span>
        </div>`).join('');

      a.innerHTML = `
        <div class="feature-tile">
          <div class="tile-main-content">
            <div class="tile-icon">${tileData.icon}</div>
            <h3 class="tile-title">${tileData.title}</h3>
            <p class="tile-description">${descriptionText || ''}</p>
          </div>
          <div class="tile-key-stats">${statsHTML}</div>
        </div>`;
      
      a.addEventListener('contextmenu', e => toggleEditMode(e, tileData.id));
      return a;
    }
    
    function createFolderElement(folderData) {
      const container = document.createElement('div');
      container.className = `folder-container grid-item ${folderData.collapsed ? 'collapsed' : ''}`;
      container.dataset.id = folderData.id;

      container.innerHTML = `
        <div class="folder-header">
          <span class="folder-toggle-icon">‚ñº</span>
          <h3 class="folder-title">${folderData.title}</h3>
        </div>
        <div class="folder-content"></div>`;
      
      const content = container.querySelector('.folder-content');
      const sortedFolderItems = getSortedLayout(folderData.items);
      sortedFolderItems.forEach(tileData => {
        content.appendChild(createTileElement(tileData));
      });
      
      container.querySelector('.folder-header').addEventListener('click', () => toggleFolder(folderData.id));
      container.addEventListener('contextmenu', e => toggleEditMode(e, folderData.id));
      return container;
    }
    
    // --- Edit Mode & UI ---
    function toggleEditMode(event, itemId) {
        event.preventDefault();
        event.stopPropagation();

        if (editModeState.mode === 'adding-to-folder' || editModeState.mode === 'flagged-for-creation') {
            const itemInfo = findItem(itemId);
            if (itemInfo && itemInfo.data.type === 'tile') {
                const index = editModeState.selectionGroup.indexOf(itemId);
                if (index > -1) {
                    editModeState.selectionGroup.splice(index, 1);
                    document.querySelector(`.grid-item[data-id="${itemId}"]`).classList.remove('is-selected');
                } else {
                    editModeState.selectionGroup.push(itemId);
                    document.querySelector(`.grid-item[data-id="${itemId}"]`).classList.add('is-selected');
                }
            }
            return;
        }

        const currentlyEditing = editModeState.selectedId === itemId;
        exitEditMode(); 
        if (!currentlyEditing) {
            enterEditMode(itemId);
        }
    }

    function enterEditMode(itemId) {
        const itemElement = document.querySelector(`.grid-item[data-id="${itemId}"]`);
        if (!itemElement) return;

        editModeState.selectedId = itemId;
        editModeState.mode = 'normal';
        itemElement.classList.add('is-editing');
        itemElement.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
        updateHint();
    }

    function exitEditMode() {
        if (editModeState.selectedId) {
            const oldElement = document.querySelector(`.grid-item[data-id="${editModeState.selectedId}"]`);
            if (oldElement) oldElement.classList.remove('is-editing');
        }
        editModeState.selectionGroup.forEach(id => {
            const el = document.querySelector(`.grid-item[data-id="${id}"]`);
            if(el) el.classList.remove('is-selected');
        });
        if (editModeState.flaggedId) {
            const flaggedElement = document.querySelector(`.grid-item[data-id="${editModeState.flaggedId}"]`);
            if (flaggedElement) flaggedElement.classList.remove('is-flagged');
        }
        editModeState = { selectedId: null, mode: 'normal', selectionGroup: [] };
        updateHint();
    }

    function updateHint() {
        if (!editModeState.selectedId) {
            editModeHint.classList.remove('visible');
            return;
        }

        const itemInfo = findItem(editModeState.selectedId);
        let hintHTML = ``;

        if(editModeState.mode === 'adding-to-folder' || editModeState.mode === 'flagged-for-creation') {
             hintHTML = `Selecting items... <span class="hint-divider"></span> <kbd>Enter</kbd> Confirm <span class="hint-divider"></span> <kbd>Esc</kbd> Cancel`;
        } else {
            hintHTML = `Editing '<span style="color: #FFC107;">${itemInfo.data.title}</span>' <span class="hint-divider"></span> <kbd>‚Üë</kbd><kbd>‚Üì</kbd><kbd>‚Üê</kbd><kbd>‚Üí</kbd> Move <span class="hint-divider"></span> <kbd>Esc</kbd> Exit`;
            if (itemInfo.data.type === 'tile') {
                hintHTML += ` <span class="hint-divider"></span> <kbd>1</kbd><kbd>2</kbd><kbd>3</kbd> Resize <span class="hint-divider"></span> <kbd>F</kbd> Folder`;
                if (itemInfo.parent) { // Check if it has a parent (i.e., is in a folder)
                     hintHTML += ` <span class="hint-divider"></span> <kbd>X</kbd> Remove from Folder`;
                }
            } else { // Folder
                hintHTML += ` <span class="hint-divider"></span> <kbd>F</kbd> Add Items <span class="hint-divider"></span> <kbd>N</kbd> Rename <span class="hint-divider"></span> <kbd>D</kbd> Dissolve`;
            }
        }
        
        editModeHint.innerHTML = hintHTML;
        editModeHint.classList.add('visible');
    }

    // --- Data Manipulation Functions ---
    function findItem(itemId, fromArray = layoutData, parent = null) {
      for (let i = 0; i < fromArray.length; i++) {
        const item = fromArray[i];
        if (item.id === itemId) return { data: item, index: i, array: fromArray, parent: parent };
        if (item.type === 'folder') {
          const foundInFolder = findItem(itemId, item.items, item);
          if (foundInFolder) return foundInFolder;
        }
      }
      return null;
    }

    function mapLayoutToGrid(items) {
        const grid = [];
        let currentRow = [];
        let currentSpan = 0;
        const sizeMap = { normal: 4, medium: 8, wide: 12 };

        items.forEach(item => {
            const itemSpan = item.type === 'folder' ? 12 : sizeMap[item.size] || 4;
            if (currentSpan + itemSpan > 12) {
                if(currentRow.length > 0) grid.push(currentRow);
                currentRow = [];
                currentSpan = 0;
            }
            currentRow.push({ id: item.id, start: currentSpan, end: currentSpan + itemSpan - 1});
            currentSpan += itemSpan;
        });
        if (currentRow.length > 0) grid.push(currentRow);
        return grid;
    }

    function moveItem(itemId, direction) {
      const itemInfo = findItem(itemId);
      if (!itemInfo) return;
      const { index, array } = itemInfo;
      const toIndex = direction === 'left' ? index - 1 : index + 1;
      
      if (toIndex >= 0 && toIndex < array.length) {
        [array[index], array[toIndex]] = [array[toIndex], array[index]];
        saveLayout();
        renderLayout();
        enterEditMode(itemId);
      }
    }

    function moveItemUpDown(direction) {
        const selectedId = editModeState.selectedId;
        const itemInfo = findItem(selectedId);
        if (!itemInfo) return;

        const parentArray = itemInfo.parent ? itemInfo.parent.items : layoutData;
        const grid = mapLayoutToGrid(parentArray);
        
        let currentPos = { row: -1, col: -1, start: -1, end: -1 };
        grid.forEach((row, rIdx) => {
            row.forEach((item, cIdx) => {
                if(item.id === selectedId) {
                    currentPos = { row: rIdx, col: cIdx, start: item.start, end: item.end };
                }
            });
        });

        if (currentPos.row === -1) return;

        const targetRowIndex = direction === 'up' ? currentPos.row - 1 : currentPos.row + 1;
        if (targetRowIndex < 0 || targetRowIndex >= grid.length) return;
        
        const targetRow = grid[targetRowIndex];
        let bestTarget = targetRow.reduce((best, current) => {
            const overlap = Math.max(0, Math.min(currentPos.end, current.end) - Math.max(currentPos.start, current.start));
            if (overlap > best.overlap) {
                return { id: current.id, overlap: overlap };
            }
            return best;
        }, { id: targetRow[0].id, overlap: 0 }); 

        const targetId = bestTarget.id;
        const targetInfo = findItem(targetId, parentArray);
        if (!targetInfo) return;

        const originalIndex = itemInfo.index;
        const targetIndex = targetInfo.index;
        [parentArray[originalIndex], parentArray[targetIndex]] = [parentArray[targetIndex], parentArray[originalIndex]];
        
        saveLayout();
        renderLayout();
        enterEditMode(selectedId);
    }
    
    function removeItemFromFolder(itemId) {
        const itemInfo = findItem(itemId);
        if (!itemInfo || !itemInfo.parent) return;

        const folder = itemInfo.parent;
        const [itemData] = itemInfo.array.splice(itemInfo.index, 1);
        
        layoutData.push(itemData);

        if (folder.items.length === 0) {
            const folderInfoInLayout = findItem(folder.id);
            if(folderInfoInLayout) layoutData.splice(folderInfoInLayout.index, 1);
        }

        exitEditMode();
        saveLayout();
        renderLayout();
        showNotification(`'${itemData.title}' removed from folder.`, 'success');
    }

    function resizeItem(itemId, newSize) {
      const itemInfo = findItem(itemId);
      if (itemInfo && itemInfo.data.type === 'tile') {
        itemInfo.data.size = newSize;
        saveLayout();
        renderLayout();
        enterEditMode(itemId);
      }
    }
    
    function toggleFolder(folderId) {
      if (editModeState.selectedId) return;
      const folderInfo = findItem(folderId);
      if (folderInfo && folderInfo.data.type === 'folder') {
        folderInfo.data.collapsed = !folderInfo.data.collapsed;
        saveLayout();
        const folderElement = document.querySelector(`.folder-container[data-id="${folderId}"]`);
        if(folderElement) folderElement.classList.toggle('collapsed');
      }
    }

    function handleFolderAction() {
        const selectedItemInfo = findItem(editModeState.selectedId);
        if (!selectedItemInfo) return;
        
        if (selectedItemInfo.data.type === 'tile') {
            if (editModeState.mode === 'normal') {
                editModeState.mode = 'flagged-for-creation';
                editModeState.selectionGroup = [editModeState.selectedId]; // The flagged item is part of the group
                document.querySelector(`.grid-item[data-id="${editModeState.selectedId}"]`).classList.add('is-flagged');
                showNotification(`'${selectedItemInfo.data.title}' flagged. Right-click other tiles to add them to selection, then press Enter.`);
                updateHint();
            }
        } else if (selectedItemInfo.data.type === 'folder') {
            if (editModeState.mode === 'normal') {
                editModeState.mode = 'adding-to-folder';
                showNotification(`Select tiles to add to '${selectedItemInfo.data.title}'. Press Enter to confirm.`);
                updateHint();
            }
        }
    }
    
    function createFolderWithItems() {
        const selectionGroup = editModeState.selectionGroup;
        if (selectionGroup.length < 2) {
            showNotification("You must select at least two tiles to create a folder.", "error");
            return;
        }

        const folderName = prompt("Enter a name for the new folder:", "New Folder");
        if (!folderName || folderName.trim() === "") return;

        const itemsToMove = [];
        let firstItemIndex = -1;

        // Find the index of the first selected item in the main layout to place the folder there
        for(let i = 0; i < layoutData.length; i++) {
            if(selectionGroup.includes(layoutData[i].id)) {
                firstItemIndex = i;
                break;
            }
        }
        if (firstItemIndex === -1) firstItemIndex = layoutData.length; // Failsafe

        selectionGroup.forEach(id => {
            const itemInfo = findItem(id);
            if(itemInfo) {
                itemsToMove.push(itemInfo.data);
            }
        });
        
        // Remove from original locations (must do this after collecting all data)
        layoutData = layoutData.filter(item => !selectionGroup.includes(item.id));

        const newFolder = {
            id: `folder-${Date.now()}`,
            type: 'folder',
            title: folderName.trim(),
            collapsed: false,
            items: itemsToMove
        };

        layoutData.splice(firstItemIndex, 0, newFolder);
        exitEditMode();
        saveLayout();
        renderLayout();
    }

    function addSelectedItemsToFolder() {
        const folderId = editModeState.selectedId;
        const selectionGroup = editModeState.selectionGroup;
        if (!folderId || selectionGroup.length === 0) return;

        const folderInfo = findItem(folderId);
        if (!folderInfo || folderInfo.data.type !== 'folder') return;
        
        selectionGroup.forEach(id => {
            const itemInfo = findItem(id);
            if (itemInfo) {
                const [itemData] = itemInfo.array.splice(itemInfo.index, 1);
                folderInfo.data.items.push(itemData);
            }
        });
        
        exitEditMode();
        saveLayout();
        renderLayout();
    }
    
    function showRenameModal(folderId) {
        const folderInfo = findItem(folderId);
        if (!folderInfo || folderInfo.data.type !== 'folder') return;
        
        renameInput.value = folderInfo.data.title;
        document.body.classList.add('modal-open');
        renameModalBackdrop.classList.add('visible');
        renameInput.focus();

        const saveHandler = () => {
            const newName = renameInput.value;
            if (newName && newName.trim() !== "") {
                folderInfo.data.title = newName.trim();
                saveLayout();
                renderLayout();
                enterEditMode(folderId);
            }
            closeModal();
        };

        const cancelHandler = () => closeModal();

        const closeModal = () => {
            document.body.classList.remove('modal-open');
            renameModalBackdrop.classList.remove('visible');
            document.getElementById('rename-save-btn').removeEventListener('click', saveHandler);
            document.getElementById('rename-cancel-btn').removeEventListener('click', cancelHandler);
        };

        document.getElementById('rename-save-btn').addEventListener('click', saveHandler);
        document.getElementById('rename-cancel-btn').addEventListener('click', cancelHandler);
    }

    function deleteFolder(folderId) {
        const folderInfo = findItem(folderId);
        if (!folderInfo || folderInfo.data.type !== 'folder' || !confirm(`Are you sure you want to dissolve the folder "${folderInfo.data.title}"? All items inside will be returned to the main grid.`)) return;

        const folderIndex = folderInfo.index;
        const itemsToRelease = folderInfo.data.items;

        layoutData.splice(folderIndex, 1);
        layoutData.splice(folderIndex, 0, ...itemsToRelease);

        exitEditMode();
        saveLayout();
        renderLayout();
    }

    // --- Keyboard & Global Listeners ---
    function handleKeyDown(event) {
        if (renameModalBackdrop.classList.contains('visible')) {
            if (event.key === 'Enter') document.getElementById('rename-save-btn').click();
            if (event.key === 'Escape') document.getElementById('rename-cancel-btn').click();
            return;
        }

        if (!editModeState.selectedId) return;

        const selectedItemInfo = findItem(editModeState.selectedId);
        if (!selectedItemInfo) return;

        switch(event.key) {
            case "Escape":
                exitEditMode();
                break;
            case "Enter":
                if (editModeState.mode === 'flagged-for-creation') createFolderWithItems();
                if (editModeState.mode === 'adding-to-folder') addSelectedItemsToFolder();
                break;
            case "ArrowLeft":
                if (editModeState.mode === 'normal') moveItem(editModeState.selectedId, 'left');
                break;
            case "ArrowRight":
                if (editModeState.mode === 'normal') moveItem(editModeState.selectedId, 'right');
                break;
            case "ArrowUp":
                if (editModeState.mode === 'normal') moveItemUpDown('up');
                break;
            case "ArrowDown":
                if (editModeState.mode === 'normal') moveItemUpDown('down');
                break;
            case "1":
                if (selectedItemInfo.data.type === 'tile' && editModeState.mode === 'normal') resizeItem(editModeState.selectedId, 'normal');
                break;
            case "2":
                if (selectedItemInfo.data.type === 'tile' && editModeState.mode === 'normal') resizeItem(editModeState.selectedId, 'medium');
                break;
            case "3":
                if (selectedItemInfo.data.type === 'tile' && editModeState.mode === 'normal') resizeItem(editModeState.selectedId, 'wide');
                break;
            case "f": case "F":
                handleFolderAction();
                break;
            case "n": case "N":
                if (selectedItemInfo.data.type === 'folder' && editModeState.mode === 'normal') showRenameModal(editModeState.selectedId);
                break;
            case "d": case "D":
                if (selectedItemInfo.data.type === 'folder' && editModeState.mode === 'normal') deleteFolder(editModeState.selectedId);
                break;
            case "x": case "X":
                if (selectedItemInfo.parent) removeItemFromFolder(editModeState.selectedId);
                break;
        }
    }
    
    function resetLayout() {
        if (confirm("Are you sure you want to reset your layout to the default? This cannot be undone.")) {
            localStorage.removeItem(LAYOUT_STORAGE_KEY);
            location.reload();
        }
    }

    // --- Sidebar & Auth ---
    function updateMarquees() {
      marqueeEls.forEach(el => {
        el.classList.remove('marquee-active');
        void el.offsetWidth;
        el.classList.add('marquee-active');
      });
    }

    const handleLogout = () => {
      firebase.auth().signOut().then(() => (location.href = '../login.html')).catch(error => {
        console.error('Logout error:', error);
      });
    };
    
    function showNotification(message, duration = 3000) {
        const notification = document.createElement('div');
        Object.assign(notification.style, {
            position: 'fixed', top: '20px', left: '50%', transform: 'translateX(-50%)',
            padding: '10px 20px', backgroundColor: 'rgba(0,0,0,0.8)', color: 'white',
            borderRadius: '8px', zIndex: '10002', fontFamily: 'PrimaryFont, sans-serif',
            opacity: '0', transition: 'opacity 0.3s ease'
        });
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => notification.style.opacity = '1', 10);
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 300);
        }, duration);
    }

    // --- Initial Setup ---
    document.addEventListener('DOMContentLoaded', () => {
      const sidebar = document.getElementById('sidebar');
      const toggleSidebarBtn = document.getElementById('toggleSidebar');
      if (toggleSidebarBtn && sidebar) {
        toggleSidebarBtn.addEventListener('click', () => {
          sidebar.classList.toggle('collapsed');
          setTimeout(updateMarquees, 550);
        });
      }
      
      document.getElementById('logoutBtn').onclick = handleLogout;
      document.getElementById('signOutLink').onclick = handleLogout;
      document.getElementById('reset-layout-btn').addEventListener('click', resetLayout);


      document.addEventListener('keydown', handleKeyDown);
      document.addEventListener('click', (e) => {
          if (!e.target.closest('.grid-item')) {
              exitEditMode();
          }
      });
      
      loadLayout();
      renderLayout();
    });

    firebase.auth().onAuthStateChanged(async user => {
      currentUser = user;
      if (user) {
        if (sidebarUserEmailEl) sidebarUserEmailEl.textContent = user.email;
        const userProfRef = userProfileDocRef();
        if (userProfRef) {
          try {
            const doc = await userProfRef.get();
            if (doc.exists) {
              sidebarUserNameEl.textContent = doc.data().username || user.displayName || 'User';
            } else {
              sidebarUserNameEl.textContent = user.displayName || 'User';
            }
          } catch (error) {
            console.error("Error fetching user profile:", error);
            sidebarUserNameEl.textContent = user.displayName || 'User';
          }
        }
      } else {
        sidebarUserNameEl.textContent = 'Not Logged In';
        sidebarUserEmailEl.textContent = 'Please log in';
      }
      updateMarquees();
    });

    window.addEventListener('resize', () => { setTimeout(updateMarquees, 300); });
  </script>
</body>
</html>
