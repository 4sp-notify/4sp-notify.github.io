<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4SP - SOUNDBOARD</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <script src="../ban-enforcer.js"></script>
    <script src="../panic-key.js"></script>
    <script src="../url-changer.js"></script>

    <style>
        :root {
            --v4-bg-gradient: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
            --v4-card-bg: #fff;
            --v4-text-primary: #333;
            --v4-text-secondary: #555;
            --v4-purple-accent: #6720bd;
            --v4-purple-accent-darker: #5a1aa8;
            --v4-purple-gradient: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            --v4-border-light: #ddd;
            --v4-border-softer: #eee;
            --v4-input-bg: #f8f9fa;
            --v4-input-border: #ccc;
            --v4-font-primary: 'PrimaryFont', sans-serif;
            --v4-font-secondary: 'SecondaryFont', sans-serif;
            --sound-search-bar-container-width: 530px;
        }
        body {
            display: flex; flex-direction: column; min-height: 100vh;
            margin: 0; font-family: var(--v4-font-primary);
            background: var(--v4-bg-gradient); color: var(--v4-text-primary);
            line-height: 1.6;
            user-select: none; /* Disable text highlighting */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        input[type="text"], input[type="number"], textarea {
            user-select: text; /* Re-enable for text inputs */
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }
        .soundboard-container-wrapper { display: flex; flex: 1; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%); color: #fff; padding: 20px 10px; display: flex; flex-direction: column; border-right: 1px solid #444; transition: width 0.5s ease-in-out; position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .sidebar.collapsed { width: 85px; }
        #toggleSidebar { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: none; border: none; color: #fff; font-size: 1.2em; cursor: pointer; padding: 4px; transition: transform 0.5s ease-in-out; }
        .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
        .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
        .sidebar nav li { margin-bottom: 10px; }
        .sidebar nav a { 
            display: flex; align-items: center; padding: 12px 15px; color: #fff; 
            text-decoration: none; border-radius: 8px; transition: all 0.3s ease; 
            font-family: 'PrimaryFont', sans-serif; text-transform: uppercase; 
            position: relative; overflow: hidden;
        }
        .sidebar nav a::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }
        .sidebar nav a:hover::before { left: 100%; }
        .sidebar nav a.active, .sidebar nav a:hover { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); transform: translateX(5px); }
        .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
        .sidebar nav a .label { 
            margin-left: 10px; 
            white-space: nowrap; 
            opacity: 1;
            visibility: visible;
            transition: opacity 0.2s ease-in-out;
            transition-delay: 0.4s;
        }
        .sidebar.collapsed nav a .label { 
            opacity: 0;
            visibility: hidden;
            transition-delay: 0s;
        }

        .main-soundboard-content {
            flex: 1; padding: 30px; background: var(--v4-bg-gradient);
            overflow-y: auto; display: flex; flex-direction: column; padding-bottom: 120px;
        }
        .soundboard-header-v4 {
            margin-bottom: 25px; background: var(--v4-card-bg); padding: 20px 30px; border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .soundboard-title-v4 {
            font-size: 2.2em; font-weight: bold; background: var(--v4-purple-gradient);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        
        .settings-action-btn {
            background: rgba(103, 32, 189, 0.08);
            border: none;
            cursor: pointer;
            padding: 8px;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .settings-action-btn:hover {
            background-color: rgba(103, 32, 189, 0.15);
            transform: translateY(-2px);
        }
        .settings-action-btn img {
            width: 22px;
            height: 22px;
            display: block;
            filter: invert(0.3) brightness(100%);
        }

        #settingsSearch {
            width: 100%;
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 12px;
            border: 1px solid var(--v4-border-light);
            font-family: var(--v4-font-primary);
            font-size: 1em;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        #settingsSearch:focus {
            border-color: var(--v4-purple-accent);
            box-shadow: 0 0 0 2px rgba(103, 32, 189, 0.2);
        }
        
        .tab-panel {
            flex-shrink: 0; 
            width: 100%; 
            box-sizing: border-box; 
            display: grid;
            gap: 12px 18px;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        }

        .control-group { position: relative; display: flex; flex-direction: column; transition: opacity 0.3s ease; border-radius: 8px; }
        .control-group.hidden-by-search { display: none; }
        .control-group.highlight {
            box-shadow: 0 0 0 2px var(--v4-purple-accent);
            border-radius: 8px;
            transition: box-shadow 0.3s ease-in-out;
        }
        .control-group.disabled, .control-group.locked { opacity: 0.4; pointer-events: none; cursor: not-allowed; }
        .control-group.locked * { pointer-events: none; cursor: not-allowed; }

        .control-group label, .checkbox-label-v4 {
            font-weight: 600;
            font-size: 0.95em;
            color: var(--v4-text-secondary);
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .slider-input-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .control-group input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            flex-grow: 1;
            height: 8px;
            background: var(--v4-border-light);
            outline: none;
            border-radius: 5px;
            transition: opacity 0.2s;
        }
        .control-group input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; background: var(--v4-purple-accent); cursor: pointer; border-radius: 50%; }
        .control-group input[type="number"], .control-group select, .control-group input[type="text"]:not(#settingsSearch) {
            padding: 8px;
            background-color: var(--v4-input-bg);
            border: 1px solid var(--v4-input-border);
            border-radius: 6px;
            color: var(--v4-text-primary);
            font-family: var(--v4-font-primary);
            font-size: 0.9em;
            outline: none;
            box-sizing: border-box;
        }
        input.slider-value-input {
            width: 70px;
            text-align: center;
        }
        .checkbox-label-v4 { padding: 4px 0; flex-wrap: wrap; }
        .control-group input[type="checkbox"] { margin-left: 12px; transform: scale(1.1); accent-color: var(--v4-purple-accent); }
        
        .radio-group-container {
            display: flex;
            flex-wrap: wrap; 
            gap: 4px 12px;
            background-color: var(--v4-input-bg);
            padding: 6px 8px;
            border-radius: 8px;
            border: 1px solid var(--v4-input-border);
        }
        .radio-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 0.95em;
        }
        .radio-label input[type="radio"] {
            margin-right: 6px;
            accent-color: var(--v4-purple-accent);
            transform: scale(1.1);
        }

        .device-display {
            background-color: var(--v4-input-bg);
            border: 1px solid var(--v4-border-light);
            border-radius: 8px;
            padding: 10px;
            margin-top: 5px;
            font-size: 0.85em;
            color: var(--v4-text-secondary);
        }
        #searchResultsContainer {
            display: none;
            max-height: 350px;
            overflow-y: auto;
            padding: 0 25px 25px 25px;
        }
        #searchResultsContainer::-webkit-scrollbar { width: 8px; }
        #searchResultsContainer::-webkit-scrollbar-track { background: var(--v4-input-bg); border-radius: 4px; }
        #searchResultsContainer::-webkit-scrollbar-thumb { background-color: var(--v4-border-light); border-radius: 4px; }
        #searchResultsContainer::-webkit-scrollbar-thumb:hover { background-color: var(--v4-text-secondary); }
        #searchResultsContainer .search-result-item {
            padding: 12px;
            border-bottom: 1px solid var(--v4-border-softer);
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #searchResultsContainer .search-result-item:hover { background-color: var(--v4-input-bg); }
        .search-result-category {
            font-size: 0.8em;
            text-transform: uppercase;
            color: var(--v4-text-secondary);
            background-color: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
        }
        #mic-permission-prompt {
            padding: 15px;
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 8px;
            text-align: center;
            grid-column: 1 / -1;
        }
        #mic-permission-prompt button { margin-top: 10px; padding: 8px 15px; }
        .mode-description {
            display: block;
            width: 100%;
            font-family: var(--v4-font-primary);
            font-size: 0.85em;
            color: #777;
            margin-top: -5px;
            margin-bottom: 5px;
            padding-left: 2px;
            font-style: italic;
            font-weight: 400;
        }

        /* --- SPATIAL AUDIO STYLES --- */
        .spatial-audio-control {
            grid-column: 1 / -1;
            padding: 10px;
            border: 1px solid transparent;
            border-radius: 12px;
            transition: background-color 0.4s ease, border-color 0.4s ease;
        }
        .spatial-audio-control:has(input:checked) {
            background-color: #f8f9fa;
            border-color: var(--v4-border-softer);
        }
        .spatial-audio-control .checkbox-label-v4 {
            font-size: 1.05em;
            transition: margin-bottom 0.4s ease;
        }
        .spatial-audio-panel {
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out, margin-top 0.5s ease-in-out;
            margin-top: 0;
        }
        .spatial-audio-control:has(input:checked) .spatial-audio-panel {
            max-height: 400px;
            opacity: 1;
            margin-top: 15px;
        }
        .spatial-extended-description {
            display: block;
            color: var(--v4-text-primary);
            font-style: italic;
            font-size: 0.9em;
            text-align: center;
            margin-bottom: 20px;
        }
        .spatial-interactive-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #spatial-pad {
            position: relative;
            width: 180px;
            height: 180px;
            border-radius: 50%;
            background-color: #e9e9e9;
            border: 1px solid #d1d1d1;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.1);
            cursor: crosshair;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
        }
        .spatial-circle {
            position: absolute; top: 50%; left: 50%;
            border: 1px solid #c0c0c0;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-sizing: border-box;
        }
        .spatial-circle.circle-1 { width: 33.33%; height: 33.33%; }
        .spatial-circle.circle-2 { width: 66.66%; height: 66.66%; }
        .spatial-line {
            position: absolute; top: 0; left: 50%;
            width: 1px;
            height: 100%;
            background-color: #c0c0c0;
            transform-origin: center;
        }
        .spatial-line.line-1 { transform: translateX(-50%) rotate(0deg); }
        .spatial-line.line-2 { transform: translateX(-50%) rotate(45deg); }
        .spatial-line.line-3 { transform: translateX(-50%) rotate(90deg); }
        .spatial-line.line-4 { transform: translateX(-50%) rotate(135deg); }
        #spatial-puck {
            position: absolute; top: 50%; left: 50%;
            width: 24px;
            height: 24px;
            background-color: #222;
            border: 2px solid var(--v4-purple-accent);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: grab;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: top 0.3s ease, left 0.3s ease, background-color 0.2s, transform 0.2s, box-shadow 0.2s;
        }
        #spatial-puck.snapped {
            box-shadow: 0 0 10px 2px var(--v4-purple-accent);
        }
        #spatial-puck:active {
            cursor: grabbing;
            background-color: var(--v4-purple-accent);
            transform: translate(-50%, -50%) scale(1.1);
            transition: background-color 0.2s, transform 0.2s;
        }
        #spatial-pad-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }
        #spatial-coords {
            margin-top: 0;
            font-family: var(--v4-font-primary);
            font-size: 0.9em;
            color: var(--v4-text-secondary);
            background-color: var(--v4-input-bg);
            padding: 5px 10px;
            border-radius: 6px;
            border: 1px solid var(--v4-border-light);
            min-width: 150px;
            text-align: center;
        }
        #resetSpatialBtn {
            background-color: var(--v4-input-bg);
            border: 1px solid var(--v4-border-light);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        #resetSpatialBtn:hover {
            border-color: var(--v4-purple-accent);
            transform: rotate(-180deg);
        }
        #resetSpatialBtn img {
            width: 16px;
            height: 16px;
        }

        /* --- EQ RECOMMENDATIONS STYLES --- */
        .eq-recommendations {
            grid-column: 1 / -1;
            padding: 15px;
            margin-top: 10px;
            background-color: #f8f9fa;
            border: 1px solid var(--v4-border-softer);
            border-radius: 8px;
            text-align: center;
        }
        .eq-recommendations p {
            margin: 0 0 10px 0;
            font-size: 0.9em;
            color: var(--v4-text-secondary);
        }
        #applyEqTuneBtn, #resetEqBtn {
            padding: 8px 16px;
            background: var(--v4-purple-gradient);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        #applyEqTuneBtn:hover, #resetEqBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(103, 32, 189, 0.3);
        }
        #resetEqBtn {
            background: #6c757d;
        }

        .sound-category-v4 {
            margin-bottom: 25px; background: var(--v4-card-bg); padding: 20px;
            border-radius: 15px; box-shadow: 0 6px 30px rgba(0,0,0,0.08);
            transition: opacity 0.3s ease-in-out;
        }
        .sound-category-v4 h2 { font-size: 1.5em; color: var(--v4-text-primary); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--v4-border-softer); text-transform: uppercase; }
        .sound-buttons-grid-v4 { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .sound-button-v4 {
            background-color: var(--v4-input-bg); color: var(--v4-text-secondary); border: 1px solid var(--v4-input-border);
            padding: 8px 12px; font-size: 1em; text-align: center; cursor: pointer;
            transition: all 0.2s ease, opacity 0.3s ease-in-out;
            text-transform: uppercase;
            font-family: var(--v4-font-primary);
            border-radius: 12px;
        }
        .sound-button-v4:hover { background-color: #e9ecef; border-color: var(--v4-purple-accent); color: var(--v4-purple-accent); transform: translateY(-2px); }
        .sound-button-v4.playing { background-color: var(--v4-purple-accent); color: white; border: 2px solid var(--v4-purple-accent-darker); }
        .sound-button-v4.pulsating { animation: pulsePlayingSoundboardV4 1.5s infinite; }
        @keyframes pulsePlayingSoundboardV4 { 0% { box-shadow: 0 0 0 0px var(--v4-purple-accent); } 100% { box-shadow: 0 0 0 8px rgba(103, 32, 189, 0); } }
        .is-hidden { display: none !important; }
        .is-filtering { opacity: 0 !important; }
        #bottom-fixed-bar {
            position: fixed;
            bottom: 15px;
            right: 15px;
            left: auto;
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 10px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            backdrop-filter: blur(4px) saturate(3);
            -webkit-backdrop-filter: blur(2px) saturate(1.2);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.15), inset 0 1px 1px 0 rgba(255, 255, 255, 0.7);
            width: var(--sound-search-bar-container-width);
        }
        #bottom-fixed-bar input[type="text"] {
            background: transparent;
            border: none;
            border-bottom: 1px solid rgba(50,50,50,0.6);
            border-radius: 0;
            color: var(--v4-text-primary);
            padding: 8px 5px;
            font-size: 1em;
            outline: none;
            font-family: var(--v4-font-primary);
            flex-grow: 1;
            width: auto;
        }
        #clearSoundsBtn {
            padding: 10px 12px; background: rgba(255, 5, 5, 0.85);
            color: white; border: 1px solid rgba(255,255,255,0.1); border-radius: 10px;
            cursor: pointer; font-size: 0.95em; text-transform: uppercase; transition: all 0.25s ease;
            font-family: var(--v4-font-primary);
            flex-shrink: 0;
        }
        .mute-status {
            display: none;
            background-color: #c41e3a;
            color: #fff;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 0.9em;
            font-weight: bold;
            text-transform: uppercase;
            pointer-events: none;
        }
        .mute-status.visible {
            display: inline-block;
        }
        .status-message-v4 { display: none; padding: 15px 25px; margin: 0 auto 20px auto; border-radius: 12px; text-align: center; max-width: 600px; text-transform: uppercase; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1); color: white; }
        .status-message-v4.success { background: linear-gradient(135deg, #1c7430, #155724); }
        .status-message-v4.error { background: linear-gradient(135deg, #8f262a, #721c24); }
        .status-message-v4.info { background: linear-gradient(135deg, #004085, #002752); }
        
        /* --- NEW: Modal Styles --- */
        .modal-backdrop { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); 
            z-index: 2000; 
            display: flex; align-items: center; justify-content: center;
            visibility: hidden; opacity: 0; 
            transition: opacity 0.25s ease-out, visibility 0s linear 0.25s;
        }
        .modal-backdrop.visible { 
            visibility: visible; opacity: 1; 
            transition: opacity 0.25s ease-out, visibility 0s linear 0s;
        }
        .modal-content { 
            background: var(--v4-card-bg); 
            width: 90%; 
            max-width: 800px; 
            border-radius: 15px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); 
            display: flex; flex-direction: column; 
            max-height: 90vh; 
            transform: scale(0.95); 
            transition: transform 0.3s ease; 
            padding: 0;
            font-family: var(--v4-font-primary);
        }
        .modal-content * {
            font-family: var(--v4-font-primary);
        }
        .modal-backdrop.visible .modal-content { transform: scale(1); }
        .modal-header { 
            padding: 15px 20px; 
            border-bottom: 1px solid var(--v4-border-softer);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 { margin: 0; font-size: 1.5em; color: var(--v4-text-primary); }
        .modal-close-btn { color: #aaa; font-size: 30px; font-weight: 300; background: none; border: none; cursor: pointer; line-height: 1; transition: color 0.2s ease; }
        .modal-close-btn:hover { color: var(--v4-purple-accent); }
        .modal-body { flex-grow: 1; overflow-y: auto; padding: 0 20px 15px; }
        .modal-footer { 
            padding: 15px 25px; 
            border-top: 1px solid var(--v4-border-softer); 
            display: flex; justify-content: flex-end; gap: 10px; 
            background-color: #f8f9fa;
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
        }
        
        .settings-tabs { display: flex; background-color: #f8f9fa; padding: 5px; border-radius: 12px; margin: 10px 0; gap: 5px; }
        .tab-button { flex: 1; padding: 8px; background: none; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1em; color: #555; transition: all 0.2s ease; }
        .tab-button.active { background: #fff; color: var(--v4-purple-accent); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        
        .tab-panels-wrapper { position: relative; overflow: hidden; min-height: 350px; }
        .tab-panels-container { display: flex; transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); }

        .btn-primary { background: var(--v4-purple-gradient); color: white; border: none; padding: 10px 20px; border-radius: 8px; text-transform: uppercase; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(103, 32, 189, 0.4); }
        .btn-secondary { background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; text-transform: uppercase; cursor: pointer; transition: all 0.3s ease; }
        .btn-secondary:hover { background: #5a6268; }

        .input-flash-accept { animation: flash-green 0.7s ease-out forwards; }
        .input-flash-deny { animation: shake-horizontal 0.5s ease-out, flash-red 0.7s ease-out; }
        @keyframes flash-green { 0% { box-shadow: 0 0 0 0 rgba(25, 135, 84, 0.5); } 100% { box-shadow: 0 0 0 8px rgba(25, 135, 84, 0); } }
        @keyframes flash-red { 0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.5); } 100% { box-shadow: 0 0 0 8px rgba(220, 53, 69, 0); } }
        @keyframes shake-horizontal { 10%, 90% { transform: translateX(-2px); } 20%, 80% { transform: translateX(4px); } 30%, 50%, 70% { transform: translateX(-6px); } 40%, 60% { transform: translateX(6px); } }
        
        #devMenu { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--v4-card-bg); border: 1px solid var(--v4-border-light); border-radius: 10px; box-shadow: 0 5px 25px rgba(0,0,0,0.2); z-index: 3000; color: var(--v4-text-primary); }
        #devMenuHeader { padding: 10px; background: var(--v4-input-bg); border-bottom: 1px solid var(--v4-border-light); cursor: move; border-top-left-radius: 10px; border-top-right-radius: 10px; text-align: center; font-weight: bold; }
        #devMenuContent { padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        #devMenu .btn-dev { width: 100%; padding: 8px; border-radius: 6px; }
    </style>
</head>
<body class="soundboard-page">

    <header class="main-header light-bg">
        <div class="container">
            <div class="logo"><a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer;"/></a></div>
            <div class="auth-buttons">
                <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button>
                <button id="logoutBtn" class="btn btn-login">LOG OUT</button>
            </div>
        </div>
    </header>

    <div class="soundboard-container-wrapper">
        <aside class="sidebar slide-in" id="sidebar">
            <button id="toggleSidebar">‚ò∞</button>
            <nav>
                <ul>
                    <li><a href="dashboard.html"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
                    <li><a href="soundboard.html" class="active"><span class="icon">üéµ</span><span class="label">Soundboard</span></a></li>
                    <li><a href="games.html"><span class="icon">üéÆ</span><span class="label">Games</span></a></li>
                    <li><a href="apps.html"><span class="icon">‚ú®</span><span class="label">Apps</span></a></li>
                    <li><a href="settings.html"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a></li>
                    <li><a href="#" id="signOutLink"><span class="icon">üîí</span><span class="label">LOG OUT</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-soundboard-content">
            <div class="soundboard-header-v4"> 
                <h2 class="soundboard-title-v4">Soundboard</h2>
                <button id="openSettingsBtn" class="settings-action-btn" title="Settings"><img src="../images/gear-dark.png" alt="Settings"></button>
            </div>
            <div class="status-message-v4" id="statusMessageV4"></div>

            <div id="soundCategoriesContainerV4"> <p>Loading sounds...</p> </div>
        </main>
    </div>

    <div id="bottom-fixed-bar">
        <span id="muteIndicator" class="mute-status">Muted</span>
        <input type="text" id="soundSearchInput" placeholder="Search sounds...">
        <button id="clearSoundsBtn">Clear Sounds</button>
    </div>

    <div id="soundboardSettingsModal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Soundboard Settings</h2>
                <button class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-tabs">
                     <button class="tab-button active" data-tab="general">General</button>
                     <button class="tab-button" data-tab="modes">Audio Modes</button>
                     <button class="tab-button" data-tab="equalizer">Equalizer</button>
                     <button class="tab-button" data-tab="effects">Effects</button>
                </div>
                <input type="text" id="settingsSearch" placeholder="Search settings...">
                <div id="searchResultsContainer"></div>

                <div class="tab-panels-wrapper">
                    <div class="tab-panels-container">
                        <div id="general" class="tab-panel">
                             <div class="control-group" data-search-terms="allow multiple sounds overlay">
                                 <label class="checkbox-label-v4">Allow Sound Overlay <input type="checkbox" id="allowMultipleSounds" data-setting="allowMultiple"></label>
                             </div>
                             <div class="control-group" data-search-terms="sound looping">
                                 <label class="checkbox-label-v4">Sound Looping <input type="checkbox" id="soundLooping" data-setting="looping"></label>
                             </div>
                             <div class="control-group" data-search-terms="auto clicker spam fast repeat">
                                 <label class="checkbox-label-v4">Auto Clicker <input type="checkbox" id="autoClickerCheckbox" data-setting="autoClicker"></label>
                                 <div id="autoClickDelayContainer" style="display: none; margin-top: 8px;">
                                     <label for="autoClickDelayInput" style="font-weight: normal; font-size: 0.9em; margin-bottom: 6px;">Delay (ms):</label>
                                     <div class="slider-input-container">
                                         <input type="number" id="autoClickDelayInput" data-setting="autoClickDelay" class="slider-value-input" value="1000" min="0" style="flex-grow: 1;">
                                         <button id="applyDelayBtn" class="btn-secondary" style="padding: 8px 12px; text-transform: none; flex-shrink: 0;">Apply</button>
                                     </div>
                                 </div>
                             </div>
                             <div id="masterVolumeControlGroup" class="control-group" data-search-terms="master volume">
                                 <label for="masterVolume">Master Volume: <span id="masterVolumeValue">100%</span></label>
                                 <div class="slider-input-container">
                                     <input type="range" id="masterVolume" min="0" max="1" step="0.01" value="1" data-setting="masterVolume">
                                     <input type="number" id="masterVolumeInput" class="slider-value-input" data-slider-id="masterVolume" min="0" max="100" step="1">
                                 </div>
                             </div>
                             <div class="control-group" data-search-terms="sort order alphabetical oldest newest a-z z-a">
                                <label>Sort Sounds By</label>
                                <div class="radio-group-container">
                                    <label class="radio-label">
                                        <input type="radio" name="soundSortOrder" value="alpha-asc" data-setting="soundSortOrder" checked>
                                        <span>A-Z</span>
                                    </label>
                                     <label class="radio-label">
                                        <input type="radio" name="soundSortOrder" value="alpha-desc" data-setting="soundSortOrder">
                                        <span>Z-A</span>
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="soundSortOrder" value="oldest" data-setting="soundSortOrder">
                                        <span>Oldest</span>
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="soundSortOrder" value="newest" data-setting="soundSortOrder">
                                        <span>Newest</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div id="modes" class="tab-panel">
                             <div class="spatial-audio-control" data-search-terms="spatial audio 3d surround sound immersive">
                                 <label class="checkbox-label-v4">Spatial Audio (Simulation)
                                     <input type="checkbox" id="modeSpatial" data-setting="modeSpatial">
                                 </label>
                                 <div class="spatial-audio-panel">
                                     <small class="spatial-extended-description">
                                         Our spatial audio engine simulates a virtual room, creating hyper-realistic reflections for a simulated 3D experience. Drag the puck to place the sound, and use the scroll wheel for elevation.
                                     </small>
                                     <div class="spatial-interactive-area">
                                         <div id="spatial-pad">
                                             <div class="spatial-line line-1"></div>
                                             <div class="spatial-line line-2"></div>
                                             <div class="spatial-line line-3"></div>
                                             <div class="spatial-line line-4"></div>
                                             <div class="spatial-circle circle-1"></div>
                                             <div class="spatial-circle circle-2"></div>
                                             <div id="spatial-puck"></div>
                                         </div>
                                         <div id="spatial-pad-controls">
                                             <div id="spatial-coords">X: 0.00, Y: 0.00, Z: 0.00</div>
                                             <button id="resetSpatialBtn" title="Reset Position"><img src="../images/refresh-dark.png" alt="Reset"></button>
                                         </div>
                                     </div>
                                 </div>
                             </div>
                             <div class="control-group" data-search-terms="warm tube vintage warmth saturation analog">
                                 <label class="checkbox-label-v4">Warm Tube <input type="checkbox" data-setting="modeVintageWarmth"></label>
                                 <small class="mode-description">Simulates the rich, warm saturation of vintage tube amps.</small>
                             </div>
                             <div class="control-group" data-search-terms="crisp clear vocal boost voice clarity">
                                 <label class="checkbox-label-v4">Crisp & Clear <input type="checkbox" data-setting="modeVocalBoost"></label>
                                 <small class="mode-description">Boosts high-end frequencies for an ultra-clear, sharp sound.</small>
                             </div>
                             <div class="control-group" data-search-terms="stadium echo party mode reverb bass boost">
                                 <label class="checkbox-label-v4">Stadium Echo <input type="checkbox" id="modeParty" data-setting="modeParty"></label>
                                 <small class="mode-description">Heavy bass and reverb that puts you in a massive arena.</small>
                             </div>
                             <div class="control-group" data-search-terms="smooth ride stable volume normalize compression">
                                 <label class="checkbox-label-v4">Smooth Ride <input type="checkbox" data-setting="modeStable"></label>
                                 <small class="mode-description">Evens out volume for a consistent, balanced listening experience.</small>
                             </div>
                             <div class="control-group" data-search-terms="auto ducker conversation awareness ducking microphone">
                                 <label class="checkbox-label-v4">Auto-Ducker <input type="checkbox" data-setting="modeAwareness"></label>
                                 <small class="mode-description">Lowers volume automatically when you speak (mic required).</small>
                             </div>
                             <div class="control-group" data-search-terms="midnight mode night quiet listening volume lock">
                                  <label class="checkbox-label-v4">Midnight Mode <input type="checkbox" id="modeNight" data-setting="modeNight"></label>
                                  <small class="mode-description">Balances audio and caps volume for neighbor-friendly listening.</small>
                             </div>
                            <div id="mic-permission-prompt" style="display: none;">
                                 <p>Auto-Ducker requires microphone access.</p>
                                 <button id="enable-mic-btn" class="btn-primary">Enable Microphone</button>
                            </div>
                        </div>

                        <div id="equalizer" class="tab-panel">
                             <div class="control-group" data-search-terms="equalizer eq bass">
                                 <label for="eqBass">Bass: <span id="eqBassValue">0 dB</span></label>
                                 <div class="slider-input-container">
                                     <input type="range" id="eqBass" min="-40" max="80" step="1" value="0" data-setting="eqBass">
                                     <input type="number" class="slider-value-input" data-slider-id="eqBass" min="-40" max="80" step="1">
                                 </div>
                             </div>
                             <div class="control-group" data-search-terms="equalizer eq mid">
                                 <label for="eqMid">Mid: <span id="eqMidValue">0 dB</span></label>
                                 <div class="slider-input-container">
                                     <input type="range" id="eqMid" min="-20" max="20" step="1" value="0" data-setting="eqMid">
                                     <input type="number" class="slider-value-input" data-slider-id="eqMid" min="-20" max="20" step="1">
                                 </div>
                             </div>
                             <div class="control-group" data-search-terms="equalizer eq treble highs">
                                 <label for="eqTreble">Treble: <span id="eqTrebleValue">0 dB</span></label>
                                 <div class="slider-input-container">
                                     <input type="range" id="eqTreble" min="-30" max="30" step="1" value="0" data-setting="eqTreble">
                                     <input type="number" class="slider-value-input" data-slider-id="eqTreble" min="-30" max="30" step="1">
                                 </div>
                             </div>
                             <div class="eq-recommendations" data-search-terms="equalizer recommend preset tune">
                                 <p>Not sure where to start? Try our recommended tune for vibrant, balanced audio.</p>
                                 <button id="applyEqTuneBtn">Apply Recommended Tune</button>
                             </div>
                        </div>

                        <div id="effects" class="tab-panel">
                             <div class="control-group" data-search-terms="fade in">
                                 <label for="fadeIn">Fade In (sec): <span id="fadeInValue">0.1s</span></label>
                                 <div class="slider-input-container">
                                   <input type="range" id="fadeIn" min="0" max="5" step="0.1" value="0.1" data-setting="fadeIn">
                                   <input type="number" class="slider-value-input" data-slider-id="fadeIn" min="0" max="5" step="0.1">
                                 </div>
                             </div>
                              <div class="control-group" data-search-terms="fade out">
                                   <label for="fadeOut">Fade Out (sec): <span id="fadeOutValue">0.1s</span></label>
                                   <div class="slider-input-container">
                                     <input type="range" id="fadeOut" min="0" max="5" step="0.1" value="0.1" data-setting="fadeOut">
                                     <input type="number" class="slider-value-input" data-slider-id="fadeOut" min="0" max="5" step="0.1">
                                   </div>
                             </div>
                             <div class="control-group" data-search-terms="speed rate tempo">
                                 <label for="speed">Speed: <span id="speedValue">1.00x</span></label>
                                 <div class="slider-input-container">
                                     <input type="range" id="speed" min="0.25" max="4" step="0.01" value="1" data-setting="speed">
                                     <input type="number" class="slider-value-input" data-slider-id="speed" min="0.25" max="4" step="0.01">
                                 </div>
                             </div>
                             <div class="control-group" data-search-terms="pitch shift detune">
                                 <label for="pitch">Pitch: <span id="pitchValue">0</span></label>
                                 <div class="slider-input-container">
                                     <input type="range" id="pitch" min="-2000" max="2000" step="10" value="0" data-setting="pitch">
                                     <input type="number" class="slider-value-input" data-slider-id="pitch" min="-2000" max="2000" step="10">
                                 </div>
                             </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="resetEqBtn">Reset EQ</button>
                <button id="resetSettingsBtn" class="btn-secondary">Reset All</button>
                <button id="saveSettingsBtn" class="btn-primary">Save</button>
            </div>
        </div>
    </div>

    <div id="welcomeModal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Welcome to the Soundboard!</h2>
            </div>
            <div class="modal-body">
                <p>Here are some handy shortcuts to get you started:</p>
                <ul class="controls-list">
                    <li><span>Toggle Settings Panel</span><span class="key-combo">Shift + S</span></li>
                    <li><span>Mute/Unmute All Sounds</span><span class="key-combo">M</span></li>
                    <li><span>Clear All Playing Sounds</span><span class="key-combo">Shift + C</span></li>
                </ul>
            </div>
            <div class="modal-footer">
                <button id="dismissWelcomeBtn" class="btn-secondary">Dismiss</button>
                <button id="dismissWelcomePermanentlyBtn" class="btn-primary">Got It, Don't Show Again</button>
            </div>
        </div>
    </div>

    <div id="devMenu">
        <div id="devMenuHeader">Dev Testing Options</div>
        <div id="devMenuContent">
            <button id="devResetSettingsBtn" class="btn-secondary btn-dev">Reset All Settings</button>
            <button id="devShowWelcomeBtn" class="btn-secondary btn-dev">Show Welcome Popup Again</button>
        </div>
    </div>

    <script>
    // --- Standard Setup (Auth, Sidebar, User Info) ---
    const dbRef_ = () => firebase.firestore().collection('users').doc(firebase.auth().currentUser.uid);
    firebase.auth().onAuthStateChanged(async user => {
        if (!user) { window.location.href = '../login.html'; }
    });
    document.getElementById('logoutBtn')?.addEventListener('click', () => { firebase.auth().signOut().then(() => { window.location.href = '../login.html'; }); });
    document.getElementById('signOutLink')?.addEventListener('click', (e) => { e.preventDefault(); firebase.auth().signOut().then(() => { window.location.href = '../login.html'; }); });
    const sidebar_ = document.getElementById('sidebar');
    const toggleSidebarBtn_ = document.getElementById('toggleSidebar');
    if (toggleSidebarBtn_ && sidebar_) { toggleSidebarBtn_.addEventListener('click', () => { sidebar_.classList.toggle('collapsed'); }); }
    
    // --- Soundboard Logic ---
    document.addEventListener('DOMContentLoaded', () => {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const LOCAL_STORAGE_KEY = 'soundboardSettingsV21';
        
        let activeSounds = new Map();
        const soundCache = new Map();
        let isMuted = false;
        let lastVolumeBeforeMute = 1;
        let volumeBeforeNightMode = 1;
        
        let spatialPadRect = null;
        let currentSnapAngle = null;
        let currentZ = 0;
        let isDragging = false;
        let lastDragPosition = { x: 0, y: 0, timestamp: 0 };
        
        // Auto-Clicker State Variables
        let autoClickInterval = null;
        let requestAnimationFrameId = null;
        let currentlyHoveredButton = null;
        
        const unlockAudioContext = () => {
            if (audioContext.state === 'suspended') {
                audioContext.resume().then(() => { console.log('AudioContext resumed successfully.'); });
            }
            document.body.removeEventListener('click', unlockAudioContext);
            document.body.removeEventListener('touchstart', unlockAudioContext);
        };
        document.body.addEventListener('click', unlockAudioContext);
        document.body.addEventListener('touchstart', unlockAudioContext);

        const masterGain = audioContext.createGain();
        const finalCompressor = new DynamicsCompressorNode(audioContext, { threshold: -12.0, ratio: 6.0 });
        
        const nodes = {
            spatialInput: audioContext.createGain(),
            airAbsorptionFilter: new BiquadFilterNode(audioContext, { type: 'lowpass', frequency: 22050 }),
            mainPanner: new PannerNode(audioContext, { panningModel: 'HRTF', distanceModel: 'inverse' }),
            reverb: { node: audioContext.createConvolver(), gain: audioContext.createGain() },
            earlyReflections: { input: audioContext.createGain(), output: audioContext.createGain(), surfaces: {} },
            partyMode: { 
                bass: new BiquadFilterNode(audioContext, { type: 'lowshelf', frequency: 120 }), 
                comp: new DynamicsCompressorNode(audioContext, { threshold: -18, ratio: 8 }), 
                reverb: audioContext.createConvolver(),
                gain: audioContext.createGain()
            },
            inputGain: audioContext.createGain(),
            eqBass: new BiquadFilterNode(audioContext, { type: 'lowshelf', frequency: 100, gain: 0 }),
            bassWaveShaper: audioContext.createWaveShaper(),
            eqMid: new BiquadFilterNode(audioContext, { type: 'peaking', frequency: 1200, Q: 1.0, gain: 0 }),
            eqTreble: new BiquadFilterNode(audioContext, { type: 'highshelf', frequency: 6000, gain: 0 }),
            vintageWarmer: audioContext.createWaveShaper(),
            stableVolume: new DynamicsCompressorNode(audioContext, {threshold: -24, ratio: 12}), 
            vocalBoost: new BiquadFilterNode(audioContext, {type: 'peaking', frequency: 3000, Q: 2.0, gain: 0}),
            awarenessGain: audioContext.createGain(),
            nightModeCompressor: new DynamicsCompressorNode(audioContext, {threshold: 0, knee: 30, ratio: 1, attack: 0.003, release: 0.25 }),
        };
        
        nodes.partyMode.gain.gain.value = 0;
        nodes.reverb.gain.gain.value = 0;

        nodes.inputGain.connect(masterGain);
        nodes.spatialInput.connect(nodes.airAbsorptionFilter);
        nodes.airAbsorptionFilter.connect(nodes.mainPanner).connect(masterGain);
        nodes.airAbsorptionFilter.connect(nodes.reverb.gain).connect(nodes.reverb.node).connect(masterGain);
        nodes.airAbsorptionFilter.connect(nodes.earlyReflections.input);
        nodes.earlyReflections.output.connect(masterGain);
        masterGain.connect(nodes.eqBass)
                    .connect(nodes.bassWaveShaper)
                    .connect(nodes.eqMid)
                    .connect(nodes.eqTreble)
                    .connect(nodes.vintageWarmer)
                    .connect(nodes.stableVolume)
                    .connect(nodes.vocalBoost)
                    .connect(nodes.awarenessGain)
                    .connect(nodes.nightModeCompressor)
                    .connect(finalCompressor);
        masterGain.connect(nodes.partyMode.bass);
        nodes.partyMode.bass.connect(nodes.partyMode.reverb);
        nodes.partyMode.reverb.connect(nodes.partyMode.comp);
        nodes.partyMode.comp.connect(nodes.partyMode.gain);
        nodes.partyMode.gain.connect(finalCompressor);
        finalCompressor.connect(audioContext.destination);

        async function createReverbIR(audioContext, duration = 2, decay = 2) { const sampleRate = audioContext.sampleRate; const length = sampleRate * duration; const impulse = audioContext.createBuffer(2, length, sampleRate); for (let ch = 0; ch < 2; ch++) { const data = impulse.getChannelData(ch); for (let i = 0; i < length; i++) data[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, decay); } return impulse; }
        async function setupReverbs() { nodes.reverb.node.buffer = await createReverbIR(audioContext, 2, 3); nodes.partyMode.reverb.buffer = await createReverbIR(audioContext, 3, 1.5); }
        function createEarlyReflectionsEngine() { const surfaces = ['left', 'right', 'front', 'back', 'top', 'bottom']; surfaces.forEach(name => { const reflection = { delay: audioContext.createDelay(1.0), gain: audioContext.createGain(), panner: audioContext.createStereoPanner(), }; nodes.earlyReflections.input.connect(reflection.delay).connect(reflection.gain).connect(reflection.panner).connect(nodes.earlyReflections.output); nodes.earlyReflections.surfaces[name] = reflection; }); nodes.earlyReflections.surfaces.left.panner.pan.value = -0.8; nodes.earlyReflections.surfaces.right.panner.pan.value = 0.8; }
        function makeDistortionCurve(amount) { const k = typeof amount === 'number' ? amount : 50; const n_samples = 44100; const curve = new Float32Array(n_samples); const deg = Math.PI / 180; for (let i = 0; i < n_samples; i++) { const x = i * 2 / n_samples - 1; curve[i] = (3 + k) * x * 20 * deg / (Math.PI + k * Math.abs(x)); } return curve; }
        function makeVintageCurve(amount) { const n_samples = 44100; const curve = new Float32Array(n_samples); if (amount === 0) { for (let i = 0; i < n_samples; i++) { curve[i] = i * 2 / n_samples - 1; } } else { for (let i = 0; i < n_samples; i++) { const x = i * 2 / n_samples - 1; curve[i] = Math.tanh(x * amount); } } return curve; }

        nodes.bassWaveShaper.curve = makeDistortionCurve(0); nodes.bassWaveShaper.oversample = '4x'; nodes.vintageWarmer.curve = makeVintageCurve(0); nodes.vintageWarmer.oversample = '4x';
        
        const showStatus = (message, type = 'info', duration = 3000) => { const el = document.getElementById('statusMessageV4'); clearTimeout(el.timeoutId); el.textContent = message; el.className = `status-message-v4 ${type}`; el.style.display = 'block'; el.timeoutId = setTimeout(() => el.style.display = 'none', duration); };
        const awarenessEngine = { micStream: null, analyser: null, interval: null, isActive: false, isSpeaking: false, start() { if (this.isActive) return; this.isActive = true; navigator.mediaDevices.getUserMedia({ audio: { noiseSuppression: true, echoCancellation: true } }).then(stream => { this.micStream = stream; this.analyser = audioContext.createAnalyser(); this.analyser.fftSize = 512; audioContext.createMediaStreamSource(stream).connect(this.analyser); this.interval = setInterval(() => this.process(), 100); }).catch(err => { this.stop(); showStatus('Could not access microphone. Please enable it in browser settings.', 'error'); const awarenessCheckbox = document.querySelector('[data-setting="modeAwareness"]'); if(awarenessCheckbox) awarenessCheckbox.checked = false; }); }, stop() { if (this.interval) clearInterval(this.interval); if (this.micStream) this.micStream.getTracks().forEach(track => track.stop()); this.isActive = false; this.interval = this.micStream = this.analyser = null; this.setDucking(false); }, process() { if (!this.analyser) return; const dataArray = new Uint8Array(this.analyser.frequencyBinCount); this.analyser.getByteFrequencyData(dataArray); let voiceEnergy = 0; for (let i = 5; i < 100; i++) voiceEnergy += dataArray[i]; voiceEnergy /= 95; const currentlySpeaking = voiceEnergy > 20; if (currentlySpeaking !== this.isSpeaking) { this.isSpeaking = currentlySpeaking; this.setDucking(this.isSpeaking); } }, setDucking(isDucking) { const newVolume = isDucking ? 0.3 : 1.0; nodes.awarenessGain.gain.setTargetAtTime(newVolume, audioContext.currentTime, 0.1); } };
        
        // --- AUTO-CLICKER FUNCTIONS ---
        function fastClicker() {
            if (currentlyHoveredButton && document.getElementById('autoClickerCheckbox').checked) {
                currentlyHoveredButton.click();
                requestAnimationFrameId = requestAnimationFrame(fastClicker);
            }
        }

        function stopAutoClicker() {
            if (autoClickInterval) {
                clearInterval(autoClickInterval);
                autoClickInterval = null;
            }
            if (requestAnimationFrameId) {
                cancelAnimationFrame(requestAnimationFrameId);
                requestAnimationFrameId = null;
            }
        }

        function startAutoClicker() {
            stopAutoClicker(); // Clear any existing intervals/frames
            const delayInput = document.getElementById('autoClickDelayInput');
            const delay = parseInt(delayInput.value, 10) || 0;
            if (!currentlyHoveredButton || !document.getElementById('autoClickerCheckbox').checked) return;

            if (delay === 0) {
                requestAnimationFrameId = requestAnimationFrame(fastClicker);
            } else {
                autoClickInterval = setInterval(() => {
                    if (currentlyHoveredButton) { // Check again in case mouse left during interval
                        currentlyHoveredButton.click();
                    } else {
                        stopAutoClicker(); // Stop if button is no longer hovered
                    }
                }, delay);
            }
        }

        function applyAutoClickerDelay() {
            const delayInput = document.getElementById('autoClickDelayInput');
            const delay = parseInt(delayInput.value, 10);
            if (isNaN(delay) || delay < 0) {
                delayInput.value = 0; // Reset to 0 if invalid
                delayInput.classList.add('input-flash-deny');
                setTimeout(() => delayInput.classList.remove('input-flash-deny'), 700);
            } else {
                delayInput.classList.add('input-flash-accept');
                setTimeout(() => delayInput.classList.remove('input-flash-accept'), 700);
                if (document.getElementById('autoClickerCheckbox').checked && currentlyHoveredButton) {
                    startAutoClicker(); // Restart with new delay if active
                }
                showStatus(`Auto click delay set to ${delayInput.value}ms`, 'info');
            }
            // Settings are saved via the main "Save" button in the modal footer.
        }
        
        const clearSounds = () => {
            stopAutoClicker(); // Stop the auto-clicker
            const fadeOutTime = parseFloat(document.getElementById('fadeOut').value || 0.1);
            for (const [_, instances] of activeSounds.entries()) {
                [...instances].forEach(sound => sound.stop(fadeOutTime));
            }
        };

        class Sound {
            constructor(fileName, onEnd) {
                this.fileName = fileName;
                this.audioBuffer = null;
                this.sourceNode = null;
                this.onEnd = onEnd;
                this.gainNode = audioContext.createGain();
                this.analyser = audioContext.createAnalyser();
                this.analyser.fftSize = 128;
                this.spatialOnGain = audioContext.createGain();
                this.spatialOffGain = audioContext.createGain();
                this.spatialOnGain.gain.value = 0;
                this.spatialOffGain.gain.value = 1;
                this.gainNode.connect(this.analyser);
                this.analyser.connect(this.spatialOnGain).connect(nodes.spatialInput);
                this.analyser.connect(this.spatialOffGain).connect(nodes.inputGain);
            }
            toggleSpatial(isOn) { const onValue = isOn ? 1.0 : 0.0; this.spatialOnGain.gain.setTargetAtTime(onValue, audioContext.currentTime, 0.05); this.spatialOffGain.gain.setTargetAtTime(1.0 - onValue, audioContext.currentTime, 0.05); }
            async load() {
                if (soundCache.has(this.fileName)) { this.audioBuffer = soundCache.get(this.fileName); return; }
                const response = await fetch(`../Sounds/${this.fileName}`);
                const arrayBuffer = await response.arrayBuffer();
                this.audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                soundCache.set(this.fileName, this.audioBuffer);
            }
            async play(options) {
                await this.load();
                this.sourceNode = audioContext.createBufferSource();
                this.sourceNode.buffer = this.audioBuffer;
                this.sourceNode.loop = options.looping;
                this.sourceNode.detune.value = options.pitch;
                this.sourceNode.playbackRate.value = options.speed;
                this.sourceNode.connect(this.gainNode);
                this.gainNode.gain.setValueAtTime(0.0001, audioContext.currentTime).linearRampToValueAtTime(options.volume, audioContext.currentTime + options.fadeTime);
                this.sourceNode.start(0);
                this.sourceNode.onended = () => { if (this.gainNode.gain.value > 0.0001) { this.onEnd(this); } };
            }
            stop(fadeTime) {
                if (!this.sourceNode) return;
                const stopTime = audioContext.currentTime + fadeTime;
                this.gainNode.gain.cancelScheduledValues(audioContext.currentTime);
                this.gainNode.gain.setTargetAtTime(0.0001, audioContext.currentTime, fadeTime / 4);
                try { this.sourceNode.stop(stopTime + 0.1); } catch (e) { /* Ignore errors if already stopped */ }
                setTimeout(() => this.onEnd(this), fadeTime * 1000 + 50);
            }
        }
        
        async function playSound(fileName, button) {
            const fadeOutTime = parseFloat(document.getElementById('fadeOut').value || 0.1);

            // If sound overlay is NOT allowed, stop all other currently playing sounds.
            if (!document.getElementById('allowMultipleSounds').checked) {
                for (const instances of activeSounds.values()) {
                    [...instances].forEach(sound => sound.stop(fadeOutTime));
                }
            }

            // --- The rest of the function creates and plays a new sound instance every time ---
            let playVolume = 1.0;
            const masterVolume = masterGain.gain.value;
            const categoryKey = button.dataset.category;

            if (categoryKey.toLowerCase() === 'explicit' && masterVolume > 0.65) {
                playVolume = 0.65 / masterVolume;
            }

            const onEnd = (soundInstance) => {
                const instances = activeSounds.get(fileName) || [];
                const filtered = instances.filter(s => s !== soundInstance);
                if (filtered.length > 0) activeSounds.set(fileName, filtered);
                else activeSounds.delete(fileName);
            };

            const sound = new Sound(fileName, onEnd);
            sound.toggleSpatial(document.getElementById('modeSpatial').checked);
            
            // Add the new sound instance to the active sounds map
            activeSounds.set(fileName, [...(activeSounds.get(fileName) || []), sound]);
            
            await sound.play({ 
                looping: document.getElementById('soundLooping').checked, 
                fadeTime: parseFloat(document.getElementById('fadeIn').value) || 0.1, 
                speed: parseFloat(document.getElementById('speed').value) || 1, 
                pitch: parseFloat(document.getElementById('pitch').value) || 0,
                volume: playVolume 
            });
        }
        
        async function loadSoundsAndCreateButtons() {
            try {
                const response = await fetch('../SoundboardNames.json');
                const soundsData = await response.json();
                const containerV4 = document.getElementById('soundCategoriesContainerV4');
                containerV4.innerHTML = ''; 

                const sortOrder = document.querySelector('input[name="soundSortOrder"]:checked')?.value || 'alpha-asc';
                
                for (const categoryKey in soundsData) {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'sound-category-v4';
                    categoryDiv.innerHTML = `<h2>${categoryKey.replace(/([A-Z])/g, ' $1').trim()}</h2>`;
                    const buttonsGrid = document.createElement('div');
                    buttonsGrid.className = 'sound-buttons-grid-v4';

                    let soundList = soundsData[categoryKey];
                    
                    if (sortOrder === 'alpha-asc') {
                        soundList = [...soundList].sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }));
                    } else if (sortOrder === 'alpha-desc') {
                        soundList = [...soundList].sort((a, b) => b.localeCompare(a, undefined, { sensitivity: 'base' }));
                    } else if (sortOrder === 'newest') {
                        soundList = [...soundList].reverse();
                    }

                    soundList.forEach(fileName => {
                        const displayName = fileName.replace(/\.mp3$/i, '').replace(/_/g, ' ');
                        const button = document.createElement('button');
                        button.className = 'sound-button-v4';
                        button.textContent = displayName;
                        button.dataset.soundFile = fileName;
                        button.dataset.category = categoryKey;
                        button.addEventListener('click', () => playSound(fileName, button));

                        // Add mouse listeners for auto-clicker
                        button.addEventListener('mouseenter', () => {
                            currentlyHoveredButton = button;
                            if (document.getElementById('autoClickerCheckbox').checked) {
                                startAutoClicker();
                            }
                        });
                        button.addEventListener('mouseleave', () => {
                            if (currentlyHoveredButton === button) {
                                currentlyHoveredButton = null;
                                stopAutoClicker();
                            }
                        });

                        buttonsGrid.appendChild(button);
                    });
                    categoryDiv.appendChild(buttonsGrid);
                    containerV4.appendChild(categoryDiv);
                }
            } catch (error) {
                console.error("Failed to load sounds:", error);
                document.getElementById('soundCategoriesContainerV4').innerHTML = '<p>Error: Could not load sounds. Please check the console.</p>';
            }
        }
        
        const toggleMute = () => { isMuted = !isMuted; const muteIndicator = document.getElementById('muteIndicator'); if (isMuted) { lastVolumeBeforeMute = masterGain.gain.value; masterGain.gain.value = 0; muteIndicator.classList.add('visible'); } else { masterGain.gain.value = lastVolumeBeforeMute; muteIndicator.classList.remove('visible'); } document.getElementById('masterVolume').value = masterGain.gain.value; document.getElementById('masterVolumeValue').textContent = `${Math.round(masterGain.gain.value * 100)}%`; };
        
        const updateFunctions = { 
            masterVolume: v => { const newVol = parseFloat(v); masterGain.gain.value = newVol; if (newVol > 0 && !document.getElementById('modeNight').checked) { lastVolumeBeforeMute = newVol; } isMuted = (newVol === 0); document.getElementById('muteIndicator').classList.toggle('visible', isMuted); document.getElementById('masterVolumeValue').textContent = `${Math.round(newVol*100)}%`; const numInput = document.querySelector(`[data-slider-id="masterVolume"]`); if(numInput) numInput.value = Math.round(newVol*100); }, 
            fadeIn: v => { document.getElementById('fadeInValue').textContent = `${parseFloat(v).toFixed(1)}s`; const numInput = document.querySelector(`[data-slider-id="fadeIn"]`); if(numInput) numInput.value = v; }, 
            fadeOut: v => { document.getElementById('fadeOutValue').textContent = `${parseFloat(v).toFixed(1)}s`; const numInput = document.querySelector(`[data-slider-id="fadeOut"]`); if(numInput) numInput.value = v; }, 
            speed: v => { document.getElementById('speedValue').textContent = `${parseFloat(v).toFixed(2)}x`; activeSounds.forEach(instances => instances.forEach(s => { if (s.sourceNode) s.sourceNode.playbackRate.setTargetAtTime(parseFloat(v), audioContext.currentTime, 0.01); })); const numInput = document.querySelector(`[data-slider-id="speed"]`); if(numInput) numInput.value = v; }, 
            pitch: v => { const pitchValue = parseFloat(v); document.getElementById('pitchValue').textContent = pitchValue; activeSounds.forEach(instances => instances.forEach(s => { if (s.sourceNode) s.sourceNode.detune.setTargetAtTime(pitchValue, audioContext.currentTime, 0.01); })); const numInput = document.querySelector(`[data-slider-id="pitch"]`); if(numInput) numInput.value = v; }, 
            eqBass: v => { const val = parseFloat(v); if (val <= 40) { nodes.eqBass.gain.value = val; nodes.bassWaveShaper.curve = makeDistortionCurve(0); document.getElementById('eqBassValue').textContent = `${val} dB`; } else { nodes.eqBass.gain.value = 40; const distortionAmount = (val - 40) * 10; nodes.bassWaveShaper.curve = makeDistortionCurve(distortionAmount); document.getElementById('eqBassValue').textContent = `+40 dB (Punch ${Math.round((val - 40) / 40 * 100)}%)`; if ('vibrate' in navigator) { navigator.vibrate(Math.min(200, (val - 40) * 5)); } } const numInput = document.querySelector(`[data-slider-id="eqBass"]`); if(numInput) numInput.value = v; },
            eqMid: v => { const val = parseFloat(v); nodes.eqMid.gain.value = val; document.getElementById('eqMidValue').textContent = `${val} dB`; const numInput = document.querySelector(`[data-slider-id="eqMid"]`); if(numInput) numInput.value = v; },
            eqTreble: v => { const val = parseFloat(v); nodes.eqTreble.gain.value = val; document.getElementById('eqTrebleValue').textContent = `${val} dB`; const numInput = document.querySelector(`[data-slider-id="eqTreble"]`); if(numInput) numInput.value = v; },
            modeSpatial: v => { for (const instances of activeSounds.values()) { instances.forEach(sound => sound.toggleSpatial(v)); } if (v) { const posEl = document.querySelector('.spatial-audio-control'); const x = parseFloat(posEl.dataset.x) || 0; const y = parseFloat(posEl.dataset.y) || 0; const z = parseFloat(posEl.dataset.z) || 0; updateSpatialPuckAndAudio(x, y, z, document.getElementById('spatial-pad').offsetWidth / 2 || 90); } },
            modeVintageWarmth: v => { nodes.vintageWarmer.curve = makeVintageCurve(v ? 1.5 : 0); },
            modeParty: v => {
                const nightModeCheckbox = document.getElementById('modeNight');
                if (v && nightModeCheckbox.checked) {
                    nightModeCheckbox.checked = false;
                    nightModeCheckbox.dispatchEvent(new Event('change'));
                }
                const bassGain = v ? 8 : 0;
                const compThreshold = v ? -20 : 0;
                const partyMix = v ? 0.4 : 0; // Mix level for the effect

                nodes.partyMode.bass.gain.setTargetAtTime(bassGain, audioContext.currentTime, 0.02);
                nodes.partyMode.comp.threshold.setTargetAtTime(compThreshold, audioContext.currentTime, 0.02);
                nodes.partyMode.gain.gain.setTargetAtTime(partyMix, audioContext.currentTime, 0.05);
            },
            modeNight: v => { const partyModeCheckbox = document.getElementById('modeParty'); if (v && partyModeCheckbox.checked) { partyModeCheckbox.checked = false; partyModeCheckbox.dispatchEvent(new Event('change')); } const volControlGroup = document.getElementById('masterVolumeControlGroup'); const volSlider = document.getElementById('masterVolume'); const volInput = document.getElementById('masterVolumeInput'); if (v) { volumeBeforeNightMode = volSlider.value; volControlGroup.classList.add('locked'); volSlider.disabled = true; volInput.disabled = true; volSlider.value = 0.15; volSlider.dispatchEvent(new Event('input', { bubbles: true })); nodes.nightModeCompressor.threshold.setTargetAtTime(-40, audioContext.currentTime, 0.01); nodes.nightModeCompressor.ratio.setTargetAtTime(12.0, audioContext.currentTime, 0.01); } else { volControlGroup.classList.remove('locked'); volSlider.disabled = false; volInput.disabled = false; volSlider.value = volumeBeforeNightMode; volSlider.dispatchEvent(new Event('input', { bubbles: true })); nodes.nightModeCompressor.threshold.setTargetAtTime(0, audioContext.currentTime, 0.01); nodes.nightModeCompressor.ratio.setTargetAtTime(1.0, audioContext.currentTime, 0.01); } },
            modeVocalBoost: v => nodes.vocalBoost.gain.setTargetAtTime(v ? 6 : 0, audioContext.currentTime, 0.01), 
            modeAwareness: v => v ? awarenessEngine.start() : awarenessEngine.stop(), 
            modeStable: v => { nodes.stableVolume.ratio.setTargetAtTime(v ? 12 : 1, audioContext.currentTime, 0.01); }
        };
        
        function updateButtonVisuals() { requestAnimationFrame(updateButtonVisuals); document.querySelectorAll('.sound-button-v4[data-sound-file]').forEach(button => { const fileName = button.dataset.soundFile; const instances = activeSounds.get(fileName); if (instances && instances.length > 0) { button.classList.add('playing'); if (instances.length > 1) { button.classList.add('pulsating'); button.style.transform = ''; button.style.boxShadow = ''; } else { button.classList.remove('pulsating'); if(instances[0].analyser) { const analyser = instances[0].analyser; const dataArray = new Uint8Array(analyser.frequencyBinCount); analyser.getByteFrequencyData(dataArray); const avg = dataArray.reduce((s, v) => s + v, 0) / dataArray.length; const scale = 1 + (avg / 255) * 0.05; const shadowSpread = 2 + (avg / 255) * 8; button.style.transform = `scale(${scale})`; button.style.boxShadow = `0 0 ${shadowSpread}px rgba(103, 32, 189, 0.7)`; } } } else { button.classList.remove('playing', 'pulsating'); button.style.transform = ''; button.style.boxShadow = ''; } }); }
        function handleSettingsSearch(e) { const searchTerm = e.target.value.toLowerCase().trim(); const resultsContainer = document.getElementById('searchResultsContainer'); const tabPanelsContainer = document.querySelector('.tab-panels-wrapper'); resultsContainer.innerHTML = ''; if (!searchTerm) { tabPanelsContainer.style.display = 'block'; resultsContainer.style.display = 'none'; return; } tabPanelsContainer.style.display = 'none'; resultsContainer.style.display = 'block'; const allControls = document.querySelectorAll('.control-group[data-search-terms], .eq-recommendations[data-search-terms]'); let matchFound = false; allControls.forEach(control => { const searchTerms = control.dataset.searchTerms; if (searchTerms.includes(searchTerm)) { matchFound = true; const resultItem = document.createElement('div'); resultItem.className = 'search-result-item'; const labelText = control.querySelector('label')?.textContent.trim().replace(/\s\s.+/, '') || control.querySelector('button')?.textContent.trim(); const tabPane = control.closest('.tab-panel'); const tabId = tabPane.id; const tabName = document.querySelector(`.tab-button[data-tab="${tabId}"]`).textContent; resultItem.innerHTML = `<span>${labelText}</span> <span class="search-result-category">${tabName}</span>`; resultItem.onclick = () => { document.querySelector(`.tab-button[data-tab="${tabId}"]`).click(); document.getElementById('settingsSearch').value = ''; tabPanelsContainer.style.display = 'block'; resultsContainer.style.display = 'none'; setTimeout(() => { control.scrollIntoView({ behavior: 'smooth', block: 'center' }); control.classList.add('highlight'); setTimeout(() => control.classList.remove('highlight'), 1500); }, 50); }; resultsContainer.appendChild(resultItem); } }); if (!matchFound) { resultsContainer.innerHTML = '<div class="search-result-item">No settings found.</div>'; } }
        let isAnimatingSearch = false; function debounce(func, delay) { let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); }; }
        const performSoundSearch = (searchTerm) => { if (isAnimatingSearch) return; isAnimatingSearch = true; const allCategories = document.querySelectorAll('.sound-category-v4'); allCategories.forEach(category => category.classList.add('is-filtering')); setTimeout(() => { let firstMatchCategory = null; allCategories.forEach(category => { const buttonsInCategory = category.querySelectorAll('.sound-button-v4'); let categoryHasVisibleChildren = false; buttonsInCategory.forEach(button => { const soundName = button.textContent.toLowerCase(); const matches = searchTerm ? soundName.includes(searchTerm) : true; button.classList.toggle('is-hidden', !matches); if (matches) { categoryHasVisibleChildren = true; } }); category.classList.toggle('is-hidden', !categoryHasVisibleChildren); if (categoryHasVisibleChildren && !firstMatchCategory) { firstMatchCategory = category; } }); allCategories.forEach(category => category.classList.remove('is-filtering')); if (firstMatchCategory && searchTerm) { firstMatchCategory.scrollIntoView({ behavior: 'smooth', block: 'start' }); } isAnimatingSearch = false; }, 300); };
        const debouncedSoundSearch = debounce(event => { performSoundSearch(event.target.value.toLowerCase().trim()); }, 350);
        
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        function updateSaveButtonText(isoTimestamp) { if (!isoTimestamp) { saveSettingsBtn.textContent = "Save"; return; } const savedDate = new Date(isoTimestamp); const now = new Date(); const isToday = savedDate.toDateString() === now.toDateString(); if (isToday) { saveSettingsBtn.textContent = `Saved at ${savedDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`; } else { saveSettingsBtn.textContent = `Saved ${savedDate.toLocaleDateString()}`; } }
        
        function saveSettings() { const settingsToSave = {}; document.querySelectorAll('[data-setting]').forEach(el => { const key = el.dataset.setting; if (el.type === 'radio') { if (el.checked) { settingsToSave[key] = el.value; } } else { settingsToSave[key] = (el.type === 'checkbox') ? el.checked : el.value; } }); const spatialControl = document.querySelector('.spatial-audio-control'); if (spatialControl.dataset.x) { settingsToSave['spatial_x'] = spatialControl.dataset.x; settingsToSave['spatial_y'] = spatialControl.dataset.y; settingsToSave['spatial_z'] = spatialControl.dataset.z; } settingsToSave.savedAt = new Date().toISOString(); localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(settingsToSave)); updateSaveButtonText(settingsToSave.savedAt); showStatus('Settings saved successfully!', 'success'); }
        function loadSettings() { const savedSettings = localStorage.getItem(LOCAL_STORAGE_KEY); if (savedSettings) { const settings = JSON.parse(savedSettings); for (const key in settings) { const el = document.querySelector(`[data-setting="${key}"]`); if(el) { if (el.type === 'radio') { const targetRadio = document.querySelector(`input[name="${el.name}"][value="${settings[key]}"]`); if(targetRadio) targetRadio.checked = true; } else if (el.type === 'checkbox') { el.checked = settings[key]; } else { el.value = settings[key]; } el.dispatchEvent(new Event(el.type === 'checkbox' ? 'change' : 'input', { bubbles: true })); } } if (settings['spatial_x'] !== undefined) { const x = parseFloat(settings['spatial_x']); const y = parseFloat(settings['spatial_y']); const z = parseFloat(settings['spatial_z'] || 0); currentZ = z; setTimeout(() => { const padRadius = document.getElementById('spatial-pad').offsetWidth / 2 || 90; updateSpatialPuckAndAudio(x, y, z, padRadius); }, 100); } updateSaveButtonText(settings.savedAt); showStatus('Settings loaded.', 'info'); } loadSoundsAndCreateButtons(); }
        
        const spatialPad = document.getElementById('spatial-pad'); const spatialPuck = document.getElementById('spatial-puck'); const spatialCoords = document.getElementById('spatial-coords');

        function updateSpatialPuckAndAudio(audioX, audioY, audioZ, padRadius) {
            if (!padRadius) padRadius = 90;
            const timeConstant = 0.015;
            const now = audioContext.currentTime;
            nodes.mainPanner.positionX.setTargetAtTime(audioX * 10, now, timeConstant);
            nodes.mainPanner.positionY.setTargetAtTime(audioY * 10, now, timeConstant);
            nodes.mainPanner.positionZ.setTargetAtTime(audioZ * 10, now, timeConstant);
            const puckX = audioX * padRadius; const puckY = -audioY * padRadius;
            spatialPuck.style.left = `${puckX + padRadius}px`; spatialPuck.style.top = `${puckY + padRadius}px`;
            const zScale = 1 + (audioZ * 0.15); const zShadow = 2 + (Math.abs(audioZ) * 5);
            spatialPuck.style.transform = `translate(-50%, -50%) scale(${zScale})`;
            spatialPuck.style.boxShadow = `0 ${zShadow}px ${zShadow * 2}px rgba(0,0,0,0.3)`;
            spatialCoords.textContent = `X:${audioX.toFixed(2)}, Y:${audioY.toFixed(2)}, Z:${audioZ.toFixed(2)}`;
            const posEl = document.querySelector('.spatial-audio-control');
            if (posEl) { posEl.dataset.x = audioX; posEl.dataset.y = audioY; posEl.dataset.z = audioZ; }
            const distance = Math.sqrt(audioX**2 + audioY**2 + audioZ**2);
            const airAbsorptionFreq = Math.max(4000, 20000 - (distance * 16000));
            nodes.airAbsorptionFilter.frequency.setTargetAtTime(airAbsorptionFreq, now, timeConstant);
            const reverbLevel = Math.min(0.5, distance * 0.35);
            nodes.reverb.gain.gain.setTargetAtTime(reverbLevel, now, timeConstant);
            const room = { width: 20, depth: 20, height: 10 }; const speedOfSound = 343;
            const pos = { x: audioX * 10, y: audioY * 10, z: audioZ * 5 };
            const calcReflection = (dist) => ({ delay: dist / speedOfSound, gain: Math.max(0, 0.7 - (dist / room.width)) });
            const surfaces = nodes.earlyReflections.surfaces;
            let r;
            r = calcReflection(room.width / 2 + pos.x); surfaces.left.delay.delayTime.setTargetAtTime(r.delay, now, timeConstant); surfaces.left.gain.gain.setTargetAtTime(r.gain, now, timeConstant);
            r = calcReflection(room.width / 2 - pos.x); surfaces.right.delay.delayTime.setTargetAtTime(r.delay, now, timeConstant); surfaces.right.gain.gain.setTargetAtTime(r.gain, now, timeConstant);
            r = calcReflection(room.depth / 2 - pos.y); surfaces.front.delay.delayTime.setTargetAtTime(r.delay, now, timeConstant); surfaces.front.gain.gain.setTargetAtTime(r.gain * 0.8, now, timeConstant);
            r = calcReflection(room.depth / 2 + pos.y); surfaces.back.delay.delayTime.setTargetAtTime(r.delay, now, timeConstant); surfaces.back.gain.gain.setTargetAtTime(r.gain, now, timeConstant);
            r = calcReflection(room.height / 2 - pos.z); surfaces.top.delay.delayTime.setTargetAtTime(r.delay, now, timeConstant); surfaces.top.gain.gain.setTargetAtTime(r.gain * 0.6, now, timeConstant);
            r = calcReflection(room.height / 2 + pos.z); surfaces.bottom.delay.delayTime.setTargetAtTime(r.delay, now, timeConstant); surfaces.bottom.gain.gain.setTargetAtTime(r.gain * 0.5, now, timeConstant);
        }
        
        function handleDrag(event) { if (!isDragging || !spatialPadRect) return; event.preventDefault(); const padRadius = spatialPadRect.width / 2; const clientX = event.touches ? event.touches[0].clientX : event.clientX; const clientY = event.touches ? event.touches[0].clientY : event.clientY; let x = clientX - spatialPadRect.left - padRadius; let y = -(clientY - spatialPadRect.top - padRadius); let distance = Math.sqrt(x * x + y * y); let angle = Math.atan2(y, x); const engage_tolerance_rad = 5 * (Math.PI / 180); const break_tolerance_rad = 10 * (Math.PI / 180); let isSnapped = false; if (currentSnapAngle !== null) { let angle_diff = Math.abs(angle - currentSnapAngle); if (angle_diff > Math.PI) angle_diff = 2 * Math.PI - angle_diff; if (angle_diff > break_tolerance_rad) { currentSnapAngle = null; } else { angle = currentSnapAngle; isSnapped = true; } } else { const snap_angles_rad = [0, 0.25 * Math.PI, 0.5 * Math.PI, 0.75 * Math.PI, Math.PI, -0.75 * Math.PI, -0.5 * Math.PI, -0.25 * Math.PI]; for (const snap_angle of snap_angles_rad) { let angle_diff = Math.abs(angle - snap_angle); if (angle_diff > Math.PI) angle_diff = 2 * Math.PI - angle_diff; if (angle_diff < engage_tolerance_rad) { angle = snap_angle; currentSnapAngle = snap_angle; isSnapped = true; break; } } } spatialPuck.classList.toggle('snapped', isSnapped); x = distance * Math.cos(angle); y = distance * Math.sin(angle); const final_distance = Math.sqrt(x * x + y * y); if (final_distance > padRadius) { x = (x / final_distance) * padRadius; y = (y / final_distance) * padRadius; } const audioX = x / padRadius; const audioY = y / padRadius; updateSpatialPuckAndAudio(audioX, audioY, currentZ, padRadius); const now = Date.now(); if (lastDragPosition.timestamp > 0) { const dt = (now - lastDragPosition.timestamp) / 1000.0; if (dt > 0) { const lastDist = Math.sqrt(lastDragPosition.x**2 + lastDragPosition.y**2); const currentDist = Math.sqrt(audioX**2 + audioY**2); const radialVelocity = (lastDist - currentDist) / dt; const dopplerShift = radialVelocity * 0.05; const baseSpeed = parseFloat(document.getElementById('speed').value || 1); const newSpeed = baseSpeed + dopplerShift; activeSounds.forEach(instances => instances.forEach(s => { if(s.sourceNode) s.sourceNode.playbackRate.setTargetAtTime(newSpeed, audioContext.currentTime, 0.01); })); } } lastDragPosition = { x: audioX, y: audioY, timestamp: now }; }
        function startDrag(event) { if (!document.getElementById('modeSpatial').checked || (event.type === 'mousedown' && event.button !== 0)) return; spatialPadRect = spatialPad.getBoundingClientRect(); isDragging = true; document.body.style.userSelect = 'none'; handleDrag(event); }
        function stopDrag() { if (!isDragging) return; isDragging = false; spatialPadRect = null; currentSnapAngle = null; document.body.style.userSelect = ''; spatialPuck.classList.remove('snapped'); const baseSpeed = parseFloat(document.getElementById('speed').value || 1); activeSounds.forEach(instances => instances.forEach(s => { if(s.sourceNode) s.sourceNode.playbackRate.setTargetAtTime(baseSpeed, audioContext.currentTime, 0.01); })); lastDragPosition = { x: 0, y: 0, timestamp: 0 }; const deadzoneRadius = 0.15; const posEl = document.querySelector('.spatial-audio-control'); const currentX = parseFloat(posEl.dataset.x); const currentY = parseFloat(posEl.dataset.y); if (Math.sqrt(currentX**2 + currentY**2) < deadzoneRadius) { updateSpatialPuckAndAudio(0, 0, currentZ, spatialPad.offsetWidth / 2); } }

        function showWelcomePopupIfNeeded() {
            const welcomeModal = document.getElementById('welcomeModal');
            if (localStorage.getItem('hasSeenWelcomePopup') !== 'true') {
                welcomeModal.classList.add('visible');
            }
            document.getElementById('dismissWelcomeBtn').addEventListener('click', () => {
                welcomeModal.classList.remove('visible');
            });
            document.getElementById('dismissWelcomePermanentlyBtn').addEventListener('click', () => {
                localStorage.setItem('hasSeenWelcomePopup', 'true');
                welcomeModal.classList.remove('visible');
            });
        }

        function makeDraggable(element, handle) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            handle.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e = e || window.event;
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                element.style.top = (element.offsetTop - pos2) + "px";
                element.style.left = (element.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        async function initialize() {
            await setupReverbs();
            createEarlyReflectionsEngine();
            requestAnimationFrame(updateButtonVisuals);
            showWelcomePopupIfNeeded();
            makeDraggable(document.getElementById('devMenu'), document.getElementById('devMenuHeader'));

            // --- MODAL & TABS ---
            const settingsModal = document.getElementById('soundboardSettingsModal');
            const openSettingsBtn = document.getElementById('openSettingsBtn');
            const closeSettingsBtn = settingsModal.querySelector('.modal-close-btn');

            const openModal = () => settingsModal.classList.add('visible');
            const closeModal = () => settingsModal.classList.remove('visible');

            openSettingsBtn.addEventListener('click', openModal);
            closeSettingsBtn.addEventListener('click', closeModal);
            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) closeModal();
            });

            const tabButtons = settingsModal.querySelectorAll('.tab-button');
            const tabPanelContainer = settingsModal.querySelector('.tab-panels-container');
            settingsModal.querySelector('.settings-tabs').addEventListener('click', e => {
                const clickedButton = e.target.closest('.tab-button');
                if (clickedButton) {
                    const tabIndex = Array.from(tabButtons).indexOf(clickedButton);
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    clickedButton.classList.add('active');
                    if (tabPanelContainer) {
                        tabPanelContainer.style.transform = `translateX(-${tabIndex * 100}%)`;
                    }
                }
            });

            // --- EVENT LISTENERS ---
            saveSettingsBtn.addEventListener('click', saveSettings); 
            document.getElementById('resetSettingsBtn').addEventListener('click', () => { if (confirm('Are you sure you want to reset all settings on this page? This cannot be undone.')) { localStorage.removeItem(LOCAL_STORAGE_KEY); window.location.reload(); } }); 
            document.getElementById('clearSoundsBtn').addEventListener('click', clearSounds); 
            document.getElementById('settingsSearch').addEventListener('input', handleSettingsSearch); 
            document.getElementById('soundSearchInput').addEventListener('input', debouncedSoundSearch); 
            
            // --- AUTO-CLICKER EVENT LISTENERS ---
            const autoClickerCheckbox = document.getElementById('autoClickerCheckbox');
            const autoClickDelayContainer = document.getElementById('autoClickDelayContainer');
            const autoClickDelayInput = document.getElementById('autoClickDelayInput');

            autoClickerCheckbox.addEventListener('change', function() {
                autoClickDelayContainer.style.display = this.checked ? 'block' : 'none';
                if (this.checked && currentlyHoveredButton) {
                    startAutoClicker();
                } else {
                    stopAutoClicker();
                }
            });
            document.getElementById('applyDelayBtn').addEventListener('click', applyAutoClickerDelay);
            autoClickDelayInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    applyAutoClickerDelay();
                }
            });
            
            const keysPressed = {};
            document.addEventListener('keydown', (event) => {
                const key = event.key.toLowerCase();
                keysPressed[key] = true;

                if (event.target.tagName === 'INPUT' || event.target.tagName === 'SELECT' || event.target.tagName === 'TEXTAREA') { return; } 
                
                if (keysPressed['shift'] && key === 'c') {
                    event.preventDefault();
                    const currentVolume = masterGain.gain.value;
                    const wasAlreadyMuted = currentVolume === 0;
                    if (!wasAlreadyMuted) {
                        masterGain.gain.setValueAtTime(0, audioContext.currentTime);
                    }
                    
                    clearSounds(); // Correctly call clearSounds once

                    setTimeout(() => {
                        if (!wasAlreadyMuted) {
                             masterGain.gain.setValueAtTime(currentVolume, audioContext.currentTime);
                        }
                    }, 150);
                } 
                if (!keysPressed['shift'] && key === 'm') { event.preventDefault(); toggleMute(); }
                if (keysPressed['shift'] && key === 's') {
                    event.preventDefault();
                    settingsModal.classList.toggle('visible');
                }
                if (keysPressed['shift'] && keysPressed['0'] && key === 'c') {
                    event.preventDefault();
                    const devMenu = document.getElementById('devMenu');
                    devMenu.style.display = devMenu.style.display === 'block' ? 'none' : 'block';
                }
            }); 
            document.addEventListener('keyup', (event) => {
                keysPressed[event.key.toLowerCase()] = false;
            });
            
            document.getElementById('resetEqBtn').addEventListener('click', () => { ['eqBass', 'eqMid', 'eqTreble'].forEach(key => { const slider = document.getElementById(key); if (slider) { slider.value = 0; slider.dispatchEvent(new Event('input', { bubbles: true })); } }); }); 
            const recommendedTune = { eqBass: 4, eqMid: 2, eqTreble: 5 }; 
            document.getElementById('applyEqTuneBtn').addEventListener('click', () => { Object.entries(recommendedTune).forEach(([key, value]) => { const slider = document.getElementById(key); if (slider) { slider.value = value; slider.dispatchEvent(new Event('input', { bubbles: true })); } }); });
            
            document.querySelectorAll('[data-setting]').forEach(el => { const eventType = (el.type === 'checkbox' || el.type === 'radio') ? 'change' : 'input'; el.addEventListener(eventType, e => { const key = e.target.dataset.setting; const value = el.type === 'checkbox' ? e.target.checked : e.target.value; if(updateFunctions[key]) { updateFunctions[key](value); } }); }); 
            
            document.querySelectorAll('.slider-value-input').forEach(numInput => { numInput.addEventListener('change', (e) => { const sliderId = e.target.dataset.sliderId; const slider = document.getElementById(sliderId); if (!slider) return; let value = parseFloat(e.target.value); const min = parseFloat(slider.min); const max = parseFloat(slider.max); if (slider.id === 'masterVolume') { value = value / 100; } if (value < min) value = min; if (value > max) value = max; slider.value = value; slider.dispatchEvent(new Event('input', { bubbles: true })); }); });
            
            document.querySelectorAll('input[name="soundSortOrder"]').forEach(radio => {
                radio.addEventListener('change', loadSoundsAndCreateButtons);
            });
            
            document.querySelectorAll('input[type="checkbox"], input[type="radio"], button, select, a').forEach(el => {
                const handler = (e) => {
                    el.blur();
                };
                el.addEventListener('click', handler);
                el.addEventListener('keyup', e => {
                    if (e.key === ' ' || e.key === 'Enter') {
                        handler(e);
                    }
                });
            });

            document.getElementById('devResetSettingsBtn').addEventListener('click', () => {
                if (confirm('Are you sure you want to reset ALL settings? This will reload the page.')) {
                    localStorage.removeItem(LOCAL_STORAGE_KEY);
                    location.reload();
                }
            });
            document.getElementById('devShowWelcomeBtn').addEventListener('click', () => {
                localStorage.removeItem('hasSeenWelcomePopup');
                showStatus('Welcome popup will show on next visit.', 'success');
            });

            spatialPad.addEventListener('mousedown', startDrag); 
            document.addEventListener('mousemove', handleDrag); 
            document.addEventListener('mouseup', stopDrag); 
            spatialPad.addEventListener('touchstart', startDrag, { passive: false }); 
            document.addEventListener('touchmove', handleDrag, { passive: false }); 
            document.addEventListener('touchend', stopDrag);
            document.getElementById('resetSpatialBtn').addEventListener('click', () => { currentZ = 0; updateSpatialPuckAndAudio(0, 0, 0, spatialPad.offsetWidth / 2); });
            spatialPad.addEventListener('wheel', event => { if (!document.getElementById('modeSpatial').checked) return; event.preventDefault(); event.stopPropagation(); const scrollAmount = event.deltaY > 0 ? -0.05 : 0.05; currentZ = Math.max(-1, Math.min(1, currentZ + scrollAmount)); const posEl = document.querySelector('.spatial-audio-control'); const currentX = parseFloat(posEl.dataset.x) || 0; const currentY = parseFloat(posEl.dataset.y) || 0; updateSpatialPuckAndAudio(currentX, currentY, currentZ, spatialPad.offsetWidth / 2); }, { passive: false });
            
            loadSettings();
        }

        initialize();
    });
    </script>
</body>
</html>
