<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
Â  <title>4SP - SETTINGS</title>
Â  <link rel="stylesheet" href="../css/style.css" />
Â  <style>
Â  Â  /* --- Settings Layout (matching dashboard structure) --- */
Â  Â  body.settings-page {
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  min-height: 100vh;
Â  Â  Â  margin: 0;
Â  Â  }
Â  Â  .settings-container {
Â  Â  Â  display: flex;
Â  Â  Â  flex: 1;
Â  Â  }

Â  Â  /* --- Sidebar: full / collapsed (identical to dashboard) --- */
Â  Â  .sidebar {
Â  Â  Â  width: 200px;
Â  Â  Â  background: #333;
Â  Â  Â  color: #fff;
Â  Â  Â  padding: 20px 10px;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  border-right: 1px solid #444;
Â  Â  Â  transition: width 0.5s ease-in-out;
Â  Â  Â  position: relative;
Â  Â  }
Â  Â  .sidebar.collapsed {
Â  Â  Â  width: 85px;
Â  Â  }
Â  Â  #toggleSidebar {
Â  Â  Â  position: absolute;
Â  Â  Â  top: 10px;
Â  Â  Â  left: 50%;
Â  Â  Â  transform: translateX(-50%);
Â  Â  Â  background: none;
Â  Â  Â  border: none;
Â  Â  Â  color: #fff;
Â  Â  Â  font-size: 1.2em;
Â  Â  Â  cursor: pointer;
Â  Â  Â  padding: 4px;
Â  Â  Â  transition: transform 0.5s ease-in-out;
Â  Â  }
Â  Â  .sidebar.collapsed #toggleSidebar {
Â  Â  Â  transform: translateX(-50%) rotate(180deg);
Â  Â  }

Â  Â  /* --- Sidebar Navigation (matching dashboard exactly) --- */
Â  Â  .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
Â  Â  .sidebar nav li { margin-bottom: 10px; }
Â  Â  .sidebar nav a {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  padding: 10px 15px;
Â  Â  Â  color: #fff;
Â  Â  Â  text-decoration: none;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  transition: background 0.3s;
Â  Â  Â  font-family: 'PrimaryFont', sans-serif;
Â  Â  Â  text-transform: uppercase;
Â  Â  }
Â  Â  .sidebar nav a.active,
Â  Â  .sidebar nav a:hover {
Â  Â  Â  background: #6720bd;
Â  Â  }
Â  Â  .sidebar nav a .icon {
Â  Â  Â  font-size: 1.2em;
Â  Â  Â  width: 24px;
Â  Â  Â  text-align: center;
Â  Â  }
Â  Â  .sidebar nav a .label {
Â  Â  Â  margin-left: 10px;
Â  Â  Â  white-space: nowrap;
Â  Â  }
Â  Â  .sidebar.collapsed nav a {
Â  Â  Â  justify-content: center;
Â  Â  Â  padding: 10px 0;
Â  Â  }
Â  Â  .sidebar.collapsed nav a .label {
Â  Â  Â  display: none;
Â  Â  }

Â  Â  /* --- User Info & Marquee (identical to dashboard) --- */
Â  Â  .user-info {
Â  Â  Â  text-align: center;
Â  Â  Â  margin: 60px 0 30px;
Â  Â  Â  border-bottom: 1px solid #555;
Â  Â  Â  padding-bottom: 20px;
Â  Â  Â  overflow: visible;
Â  Â  }
Â  Â  .marquee-container {
Â  Â  Â  overflow: hidden;
Â  Â  Â  white-space: nowrap;
Â  Â  Â  position: relative;
Â  Â  Â  width: 100%;
Â  Â  Â  height: 1.8em;
Â  Â  Â  line-height: 1.8em;
Â  Â  }
Â  Â  .marquee-content {
Â  Â  Â  display: inline-block;
Â  Â  Â  padding-left: 100%;
Â  Â  Â  transform: translateX(0);
Â  Â  Â  animation: none;
Â  Â  Â  line-height: 1.8em;
Â  Â  }
Â  Â  .marquee-active {
Â  Â  Â  animation: scroll-left 12s linear infinite;
Â  Â  }
Â  Â  .sidebar.collapsed .marquee-active {
Â  Â  Â  animation-duration: 20s;
Â  Â  }
Â  Â  @keyframes scroll-left {
Â  Â  Â  0%Â  Â { transform: translateX(0); }
Â  Â  Â  100% { transform: translateX(-100%); }
Â  Â  }
Â  Â  .user-info .username {Â 
Â  Â  Â  font-family: 'PrimaryFont', sans-serif;Â 
Â  Â  Â  font-size: 1.3em;Â 
Â  Â  Â  margin-bottom: 8px;Â 
Â  Â  Â  line-height: 1.2em;
Â  Â  }
Â  Â  .user-info .email {Â 
Â  Â  Â  font-family: 'SecondaryFont', sans-serif;Â 
Â  Â  Â  font-size: 0.9em;Â 
Â  Â  Â  color: #bbb;Â 
Â  Â  }

Â  Â  /* --- Main Content --- */
Â  Â  .main-content {
Â  Â  Â  flex: 1;
Â  Â  Â  padding: 40px;
Â  Â  Â  background: #f0f2f5;
Â  Â  Â  overflow-y: auto;
Â  Â  Â  position: relative;
Â  Â  }

Â  Â  /* --- Settings Sections --- */
Â  Â  .settings-section {
Â  Â  Â  background: #fff;
Â  Â  Â  padding: 30px;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
Â  Â  Â  margin-bottom: 30px;
Â  Â  Â  position: relative;
Â  Â  Â  border: 1px solid #e0e0e0;
Â  Â  Â  transition: all 0.3s ease;
Â  Â  }

Â  Â  .settings-section h3 {
Â  Â  Â  font-family: 'PrimaryFont', sans-serif;
Â  Â  Â  margin: 0 0 20px;
Â  Â  Â  font-size: 1.5em;
Â  Â  Â  color: #333;
Â  Â  Â  border-bottom: 2px solid #eee;
Â  Â  Â  padding-bottom: 10px;
Â  Â  }

Â  Â  .settings-section p {
Â  Â  Â  font-family: 'SecondaryFont', sans-serif;
Â  Â  Â  color: #666;
Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  line-height: 1.5;
Â  Â  }

Â  Â  /* --- Form Styling --- */
Â  Â  .settings-form {
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  gap: 15px;
Â  Â  Â  margin-top: 10px;
Â  Â  Â  position: relative;
Â  Â  }

Â  Â  .form-group {
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  gap: 8px;
Â  Â  }

Â  Â  .settings-form label {
Â  Â  Â  font-family: 'SecondaryFont', sans-serif;
Â  Â  Â  font-weight: bold;
Â  Â  Â  color: #555;
Â  Â  Â  font-size: 0.95em;
Â  Â  }

Â  Â  .settings-form input {
Â  Â  Â  padding: 12px 15px;
Â  Â  Â  border: 1px solid #ddd;
Â  Â  Â  border-radius: 4px;
Â  Â  Â  font-size: 1em;
Â  Â  Â  font-family: 'SecondaryFont', sans-serif;
Â  Â  Â  transition: border-color 0.3s, box-shadow 0.3s;
Â  Â  Â  background: #fff;
Â  Â  }

Â  Â  .settings-form input:focus {
Â  Â  Â  outline: none;
Â  Â  Â  border-color: #6720bd;
Â  Â  Â  box-shadow: 0 0 0 3px rgba(103, 32, 189, 0.1);
Â  Â  }

Â  Â  .settings-form button {
Â  Â  Â  padding: 12px 20px;
Â  Â  Â  border: none;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  background: #6720bd;
Â  Â  Â  color: #fff;
Â  Â  Â  font-size: 1em;
Â  Â  Â  cursor: pointer;
Â  Â  Â  font-family: 'PrimaryFont', sans-serif;
Â  Â  Â  text-transform: uppercase;
Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  align-self: flex-start;
Â  Â  Â  min-width: 150px;
Â  Â  }

Â  Â  .settings-form button:hover {
Â  Â  Â  background: #5a1aa8;
Â  Â  Â  transform: translateY(-1px);
Â  Â  Â  box-shadow: 0 4px 12px rgba(103, 32, 189, 0.3);
Â  Â  }

Â  Â  .settings-form button.delete {
Â  Â  Â  background: #dc3545;
Â  Â  Â  color: #fff;
Â  Â  }

Â  Â  .settings-form button.delete:hover {
Â  Â  Â  background: #c82333;
Â  Â  Â  box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
Â  Â  }

Â  Â  .settings-form button.secondary {
Â  Â  Â  background: #6c757d;
Â  Â  }

Â  Â  .settings-form button.secondary:hover {
Â  Â  Â  background: #5a6268;
Â  Â  Â  box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
Â  Â  }

Â  Â  /* --- Disabled State Overlays --- */
Â  Â  .settings-section.disabled {
Â  Â  Â  position: relative;
Â  Â  }

Â  Â  .settings-section.disabled::before {
Â  Â  Â  content: '';
Â  Â  Â  position: absolute;
Â  Â  Â  top: 0;
Â  Â  Â  left: 0;
Â  Â  Â  right: 0;
Â  Â  Â  bottom: 0;
Â  Â  Â  background: rgba(240, 240, 240, 0.8);
Â  Â  Â  border-radius: 12px;
Â  Â  Â  z-index: 5;
Â  Â  Â  transition: opacity 1s ease;
Â  Â  }

Â  Â  .settings-section.disabled::after {
Â  Â  Â  content: attr(data-disabled-message);
Â  Â  Â  position: absolute;
Â  Â  Â  top: 50%;
Â  Â  Â  left: 50%;
Â  Â  Â  transform: translate(-50%, -50%);
Â  Â  Â  font-family: 'SecondaryFont', sans-serif;
Â  Â  Â  font-weight: bold;
Â  Â  Â  color: #666;
Â  Â  Â  z-index: 6;
Â  Â  Â  background: rgba(255, 255, 255, 0.95);
Â  Â  Â  padding: 12px 20px;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
Â  Â  Â  transition: opacity 1s ease;
Â  Â  Â  text-align: center;
Â  Â  }

Â  Â  .settings-section.disabled.fadeout::before,
Â  Â  .settings-section.disabled.fadeout::after {
Â  Â  Â  opacity: 0;
Â  Â  Â  pointer-events: none;
Â  Â  }

Â  Â  /* --- Reauthenticate Button in Bottom Right --- */
Â  Â  .reauth-btn {
Â  Â  Â  position: absolute;
Â  Â  Â  bottom: 20px;
Â  Â  Â  right: 20px;
Â  Â  Â  z-index: 6;
Â  Â  Â  background: #6720bd !important;
Â  Â  Â  color: #fff !important;
Â  Â  Â  border: none;
Â  Â  Â  padding: 12px 20px;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  font-family: 'PrimaryFont', sans-serif;
Â  Â  Â  text-transform: uppercase;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: all 1s ease;
Â  Â  Â  font-size: 0.9em;
Â  Â  }

Â  Â  .reauth-btn:hover {
Â  Â  Â  background: #5a1aa8 !important;
Â  Â  Â  transform: translateY(-1px);
Â  Â  Â  box-shadow: 0 4px 12px rgba(103, 32, 189, 0.3);
Â  Â  }

Â  Â  .reauth-btn.fadeout {
Â  Â  Â  opacity: 0;
Â  Â  Â  pointer-events: none;
Â  Â  }

Â  Â  /* --- Success/Error Messages --- */
Â  Â  .message {
Â  Â  Â  padding: 12px 16px;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  font-family: 'SecondaryFont', sans-serif;
Â  Â  Â  font-weight: 500;
Â  Â  }

Â  Â  .message.success {
Â  Â  Â  background: #d4edda;
Â  Â  Â  color: #155724;
Â  Â  Â  border: 1px solid #c3e6cb;
Â  Â  }

Â  Â  .message.error {
Â  Â  Â  background: #f8d7da;
Â  Â  Â  color: #721c24;
Â  Â  Â  border: 1px solid #f5c6cb;
Â  Â  }

Â  Â  /* --- Responsive Design --- */
Â  Â  @media (max-width: 768px) {
Â  Â  Â  .settings-container {
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .sidebar {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  padding: 15px;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .sidebar.collapsed {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .main-content {
Â  Â  Â  Â  padding: 20px;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .settings-section {
Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  Â  }

Â  Â  Â  .reauth-btn {
Â  Â  Â  Â  bottom: 15px;
Â  Â  Â  Â  right: 15px;
Â  Â  Â  Â  font-size: 0.8em;
Â  Â  Â  Â  padding: 10px 16px;
Â  Â  Â  }
Â  Â  }
Â  </style>
</head>

<body class="settings-page">
Â  Â  <header class="main-header light-bg">
Â  Â  <div class="container">
Â  Â  Â  <div class="logo">
Â  Â  Â  Â  <a href="../index.html">
Â  Â  Â  Â  Â  <img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer"/>
Â  Â  Â  Â  </a>
Â  Â  Â  </div>
Â  Â  Â  <div class="auth-buttons">
Â  Â  Â  Â  <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button>
Â  Â  Â  Â  <button id="logoutBtn" class="btn btn-login">LOG OUT</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </header>

Â  <div class="settings-container">
Â  Â  Â  Â  <aside class="sidebar" id="sidebar">
Â  Â  Â  <button id="toggleSidebar">â˜°</button>

Â  Â  Â  <div class="user-info">
Â  Â  Â  Â  <div class="marquee-container">
Â  Â  Â  Â  Â  <span id="userName" class="marquee-content username">Loadingâ€¦</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="marquee-container">
Â  Â  Â  Â  Â  <span id="userEmail" class="marquee-content email">Loadingâ€¦</span>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <nav>
Â  Â  Â  Â  <ul>
Â  Â  Â  Â  Â  <li><a href="dashboard.html"><span class="icon">ğŸ </span><span class="label">Dashboard</span></a></li>
Â  Â  Â  Â  Â  <li><a href="proxies.html"><span class="icon">ğŸ›¡ï¸</span><span class="label">Proxies</span></a></li>
Â  Â  Â  Â  Â  <li><a href="soundboard.html"><span class="icon">ğŸµ</span><span class="label">Soundboard</span></a></li>
Â  Â  Â  Â  Â  <li><a href="games.html"><span class="icon">ğŸ®</span><span class="label">Games</span></a></li>
Â  Â  Â  Â  Â  <li><a href="others.html"><span class="icon">âœ¨</span><span class="label">Others</span></a></li>
Â  Â  Â  Â  Â  <li><a href="settings.html" class="active"><span class="icon">âš™ï¸</span><span class="label">Settings</span></a></li>
Â  Â  Â  Â  Â  <li><a href="#" id="signOutLink"><span class="icon">ğŸ”’</span><span class="label">LOG OUT</span></a></li>
Â  Â  Â  Â  </ul>
Â  Â  Â  </nav>
Â  Â  </aside>

Â  Â  <main class="main-content">
Â  Â  Â  <h2>Settings</h2>
Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <section class="settings-section" id="username-section">
Â  Â  Â  Â  <h3>Edit Username</h3>
Â  Â  Â  Â  <p>Update your display name that appears throughout the application. This change will be reflected immediately across all pages.</p>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <form class="settings-form" id="username-form">
Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  <label for="newUsername">New Username (4-12 characters)</label>
Â  Â  Â  Â  Â  Â  <input type="text" id="newUsername" placeholder="Enter your new username (letters, numbers, . ? ! @ # $ % &)..." required maxlength="12"/>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <button type="button" onclick="updateUsername()">Update Username</button>
Â  Â  Â  Â  </form>
Â  Â  Â  </section>

Â  Â  Â  Â  Â  Â  <section class="settings-section" id="password-section" data-disabled-message="Password changes are not available for Google accounts">
Â  Â  Â  Â  <h3>Change Password</h3>
Â  Â  Â  Â  <p>Update your account password for enhanced security. Your new password must be at least 6 characters long and different from your current password.</p>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <form class="settings-form" id="password-form">
Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  <label for="oldPassword">Current Password</label>
Â  Â  Â  Â  Â  Â  <input type="password" id="oldPassword" placeholder="Enter your current password..." required/>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  <label for="newPassword">New Password</label>
Â  Â  Â  Â  Â  Â  <input type="password" id="newPassword" placeholder="Enter new password (minimum 6 characters)..." required/>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <button type="button" onclick="changePassword()">Change Password</button>
Â  Â  Â  Â  </form>
Â  Â  Â  </section>

Â  Â  Â  Â  Â  Â  <section class="settings-section" id="delete-section" data-disabled-message="Reauthenticate with your Google account to enable account deletion">
Â  Â  Â  Â  <h3>Delete Account</h3>
Â  Â  Â  Â  <p><strong>Warning:</strong> This action is permanent and cannot be undone. All your data, settings, and account information will be permanently removed from our system.</p>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <button class="reauth-btn" id="reauthBtn" style="display: none;">Reauthenticate</button>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <form class="settings-form" id="delete-form">
Â  Â  Â  Â  Â  <button type="button" class="delete" onclick="deleteAccount()">Delete Account Permanently</button>
Â  Â  Â  Â  </form>
Â  Â  Â  </section>
Â  Â  </main>
Â  </div>

Â  Â  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
Â  <script src="../firebase-config.js"></script>
Â  <script>
Â  Â  // Global variables to track authentication state
Â  Â  let isGoogleAccount = false;
Â  Â  let isReauthenticated = false;
Â  Â Â 
Â  Â  // Database reference helper
Â  Â  const dbRef = () => db.collection('users').doc(firebase.auth().currentUser.uid);
Â  Â Â 
Â  Â  // Marquee elements for text scrolling
Â  Â  const marqueeEls = document.querySelectorAll('.marquee-content');

Â  Â  // Authentication state management with improved delete account logic
Â  Â  firebase.auth().onAuthStateChanged(async user => {
Â  Â  Â  if (!user) {
Â  Â  Â  Â  return location.href = '../login.html';
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  // Update user info in sidebar
Â  Â  Â  document.getElementById('userEmail').textContent = user.email;
Â  Â  Â Â 
Â  Â  Â  // Get user data from Firestore
Â  Â  Â  const doc = await dbRef().get();
Â  Â  Â  const username = (doc.exists && doc.data().username) ?Â 
Â  Â  Â  Â  doc.data().username :Â 
Â  Â  Â  Â  (user.displayName || 'No name');
Â  Â  Â Â 
Â  Â  Â  document.getElementById('userName').textContent = username;
Â  Â  Â Â 
Â  Â  Â  // Pre-fill username field with current username
Â  Â  Â  if (doc.exists && doc.data().username) {
Â  Â  Â  Â  document.getElementById('newUsername').value = doc.data().username;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  // Check if user signed in with Google
Â  Â  Â  isGoogleAccount = user.providerData.some(p => p.providerId === 'google.com');
Â  Â  Â Â 
Â  Â  Â  // Handle password section for Google accounts
Â  Â  Â  const passwordSection = document.getElementById('password-section');
Â  Â  Â  passwordSection.classList.toggle('disabled', isGoogleAccount);
Â  Â  Â Â 
Â  Â  Â  // Handle delete account section based on authentication method
Â  Â  Â  setupDeleteAccountSection();
Â  Â  Â Â 
Â  Â  Â  // Update marquee animations
Â  Â  Â  updateMarquees();
Â  Â  });

Â  Â  // Setup delete account section based on authentication method
Â  Â  function setupDeleteAccountSection() {
Â  Â  Â  const deleteSection = document.getElementById('delete-section');
Â  Â  Â  const reauthBtn = document.getElementById('reauthBtn');
Â  Â  Â Â 
Â  Â  Â  if (isGoogleAccount) {
Â  Â  Â  Â  // Google accounts need reauthentication - show overlay and button
Â  Â  Â  Â  deleteSection.classList.add('disabled');
Â  Â  Â  Â  deleteSection.setAttribute('data-disabled-message', 'Reauthenticate with your Google account to enable account deletion');
Â  Â  Â  Â  reauthBtn.style.display = 'block';
Â  Â  Â  Â  isReauthenticated = false;
Â  Â  Â  } else {
Â  Â  Â  Â  // Email accounts don't need reauthentication - enable immediately
Â  Â  Â  Â  deleteSection.classList.remove('disabled');
Â  Â  Â  Â  reauthBtn.style.display = 'none';
Â  Â  Â  Â  isReauthenticated = true;
Â  Â  Â  }
Â  Â  }

Â  Â  // Logout functionality - identical to dashboard
Â  Â  document.getElementById('logoutBtn').onclick =
Â  Â  document.getElementById('signOutLink').onclick = () => {
Â  Â  Â  firebase.auth().signOut().then(() => {
Â  Â  Â  Â  location.href = '../login.html';
Â  Â  Â  });
Â  Â  };

Â  Â  // Sidebar toggle functionality - identical to dashboard
Â  Â  const toggleSidebarBtn = document.getElementById('toggleSidebar');
Â  Â  const sidebar = document.getElementById('sidebar');
Â  Â Â 
Â  Â  toggleSidebarBtn.addEventListener('click', () => {
Â  Â  Â  sidebar.classList.toggle('collapsed');
Â  Â  Â  // Update marquees after animation completes
Â  Â  Â  setTimeout(updateMarquees, 550);
Â  Â  });

Â  Â  // Marquee logic - identical to dashboard
Â  Â  function updateMarquees() {
Â  Â  Â  marqueeEls.forEach(el => {
Â  Â  Â  Â  const parent = el.parentElement;
Â  Â  Â  Â  const overflow = el.scrollWidth > parent.clientWidth;
Â  Â  Â  Â  const shouldScroll = sidebar.classList.contains('collapsed') || overflow;
Â  Â  Â  Â  el.classList.toggle('marquee-active', shouldScroll);
Â  Â  Â  });
Â  Â  }
Â  Â Â 
Â  Â  // Update marquees on window resize
Â  Â  window.addEventListener('resize', updateMarquees);

Â  Â  // Reauthentication for Google accounts only
Â  Â  document.getElementById('reauthBtn').addEventListener('click', async () => {
Â  Â  Â  const user = firebase.auth().currentUser;
Â  Â  Â Â 
Â  Â  Â  // Only proceed if this is a Google account
Â  Â  Â  if (!isGoogleAccount) {
Â  Â  Â  Â  showMessage('error', 'Reauthentication is not required for email accounts.');
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  const provider = new firebase.auth.GoogleAuthProvider();
Â  Â  Â Â 
Â  Â  Â  try {
Â  Â  Â  Â  // Attempt reauthentication with Google
Â  Â  Â  Â  await user.reauthenticateWithPopup(provider);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Mark as reauthenticated
Â  Â  Â  Â  isReauthenticated = true;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Start fade out animation for overlay and button
Â  Â  Â  Â  const deleteSection = document.getElementById('delete-section');
Â  Â  Â  Â  const reauthBtn = document.getElementById('reauthBtn');
Â  Â  Â  Â Â 
Â  Â  Â  Â  deleteSection.classList.add('fadeout');
Â  Â  Â  Â  reauthBtn.classList.add('fadeout');
Â  Â  Â  Â Â 
Â  Â  Â  Â  // After 1 second, completely remove disabled state
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  deleteSection.classList.remove('disabled', 'fadeout');
Â  Â  Â  Â  Â  reauthBtn.style.display = 'none';
Â  Â  Â  Â  Â  reauthBtn.classList.remove('fadeout');
Â  Â  Â  Â  }, 1000);
Â  Â  Â  Â Â 
Â  Â  Â  Â  showMessage('success', 'Reauthentication successful. You can now delete your account.');
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Reauthentication failed:', error);
Â  Â  Â  Â Â 
Â  Â  Â  Â  let errorMessage = 'Reauthentication failed: ';
Â  Â  Â  Â  if (error.code === 'auth/popup-closed-by-user') {
Â  Â  Â  Â  Â  errorMessage += 'Authentication popup was closed. Please try again.';
Â  Â  Â  Â  } else if (error.code === 'auth/cancelled-popup-request') {
Â  Â  Â  Â  Â  errorMessage += 'Authentication was cancelled. Please try again.';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  errorMessage += error.message;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  showMessage('error', errorMessage);
Â  Â  Â  }
Â  Â  });

Â  Â  // Update username function with comprehensive validation and profanity filter
Â  Â  async function updateUsername() {
Â  Â  Â  const newName = document.getElementById('newUsername').value.trim();
Â  Â  Â Â 
Â  Â  Â  // Check if username is empty
Â  Â  Â  if (!newName) {
Â  Â  Â  Â  showMessage('error', 'Username cannot be empty.');
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  // Check minimum length requirement
Â  Â  Â  if (newName.length < 4) {
Â  Â  Â  Â  showMessage('error', 'Username must be at least 4 characters long.');
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  // Check maximum length requirement
Â  Â  Â  if (newName.length > 12) {
Â  Â  Â  Â  showMessage('error', 'Username cannot be longer than 12 characters.');
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  // Define allowed characters: letters, numbers, and specific symbols including **
Â  Â  Â  const allowedPattern = /^[a-zA-Z0-9.?!@#$%&* -]*$/; Â  Â  Â  
Â  Â  Â  // Check if username contains only allowed characters
Â  Â  Â  if (!allowedPattern.test(newName)) {
Â  Â  Â  Â  showMessage('error', 'Username can only contain letters, numbers, and these symbols: Â - . ? ! @ # $ % & *');
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  try {
Â  Â  Â  Â  // Apply Purgomalum profanity filter
Â  Â  Â  Â  const response = await fetch(`https://www.purgomalum.com/service/plain?text=${encodeURIComponent(newName)}`);
Â  Â  Â  Â  const filteredName = await response.text();
Â  Â  Â  Â Â 
Â  Â  Â  Â  // If the filtered name contains asterisks, it means profanity was detected
Â  Â  Â  Â  if (filteredName.includes('*') && !newName.includes('**')) { // Added condition to allow original '**'
Â  Â  Â  Â  Â  showMessage('error', 'Profanity detected in username. Please choose a different username.');
Â  Â  Â  Â  Â  document.getElementById('newUsername').value = filteredName; // Show the filtered version
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  // If the original input contains '**' and the filtered output also contains '**', allow it.
Â  Â  Â  Â  if (newName.includes('**') && filteredName.includes('**')) {
Â  Â  Â  Â  Â  // Do nothing, proceed with the original newName, as per the request to accept '**'
Â  Â  Â  Â  } else if (filteredName.includes('*')) {
Â  Â  Â  Â  Â  showMessage('error', 'Profanity detected in username. Please choose a different username.');
Â  Â  Â  Â  Â  document.getElementById('newUsername').value = filteredName; // Show the filtered version
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Update username in Firestore database with the filtered name
Â  Â  Â  Â  await dbRef().update({ username: filteredName });
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Update the sidebar display immediately for instant feedback
Â  Â  Â  Â  document.getElementById('userName').textContent = filteredName;
Â  Â  Â  Â  updateMarquees();
Â  Â  Â  Â Â 
Â  Â  Â  Â  showMessage('success', 'Username updated successfully!');
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Username update failed:', error);
Â  Â  Â  Â  showMessage('error', 'Failed to update username: ' + error.message);
Â  Â  Â  }
Â  Â  }

Â  Â  // Change password function
Â  Â  async function changePassword() {
Â  Â  Â  const user = firebase.auth().currentUser;
Â  Â  Â  const oldPassword = document.getElementById('oldPassword').value;
Â  Â  Â  const newPassword = document.getElementById('newPassword').value;
Â  Â  Â Â 
Â  Â  Â  // Validation
Â  Â  Â  if (!oldPassword) {
Â  Â  Â  Â  showMessage('error', 'Please enter your current password.');
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  if (newPassword.length < 6) {
Â  Â  Â  Â  showMessage('error', 'New password must be at least 6 characters long.');
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  if (oldPassword === newPassword) {
Â  Â  Â  Â  showMessage('error', 'New password must be different from your current password.');
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  try {
Â  Â  Â  Â  // Reauthenticate with current password
Â  Â  Â  Â  const credential = firebase.auth.EmailAuthProvider.credential(user.email, oldPassword);
Â  Â  Â  Â  await user.reauthenticateWithCredential(credential);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Update password
Â  Â  Â  Â  await user.updatePassword(newPassword);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Clear form fields
Â  Â  Â  Â  document.getElementById('oldPassword').value = '';
Â  Â  Â  Â  document.getElementById('newPassword').value = '';
Â  Â  Â  Â Â 
Â  Â  Â  Â  showMessage('success', 'Password changed successfully!');
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Password change failed:', error);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Provide specific error messages
Â  Â  Â  Â  let errorMessage = 'Failed to change password: ';
Â  Â  Â  Â  if (error.code === 'auth/wrong-password') {
Â  Â  Â  Â  Â  errorMessage += 'Current password is incorrect.';
Â  Â  Â  Â  } else if (error.code === 'auth/weak-password') {
Â  Â  Â  Â  Â  errorMessage += 'New password is too weak.';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  errorMessage += error.message;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  showMessage('error', errorMessage);
Â  Â  Â  }
Â  Â  }

Â  Â  // Delete account function with proper authentication checking
Â  Â  async function deleteAccount() {
Â  Â  Â  // Check if user needs to reauthenticate first
Â  Â  Â  if (isGoogleAccount && !isReauthenticated) {
Â  Â  Â  Â  showMessage('error', 'Please reauthenticate with your Google account first.');
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  // Double confirmation for this destructive action
Â  Â  Â  const firstConfirm = confirm('Are you absolutely certain you want to delete your account? This action cannot be undone and will permanently remove all your data.');
Â  Â  Â  if (!firstConfirm) return;
Â  Â  Â Â 
Â  Â  Â  const secondConfirm = confirm('Last chance! This will permanently delete everything. Are you sure you want to proceed?');
Â  Â  Â  if (!secondConfirm) return;
Â  Â  Â Â 
Â  Â  Â  const user = firebase.auth().currentUser;
Â  Â  Â Â 
Â  Â  Â  try {
Â  Â  Â  Â  // Delete user data from Firestore first
Â  Â  Â  Â  await dbRef().delete();
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Delete the authentication account
Â  Â  Â  Â  await user.delete();
Â  Â  Â  Â Â 
Â  Â  Â  Â  alert('Your account has been permanently deleted. You will now be redirected to the signup page.');
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Redirect to signup page
Â  Â  Â  Â  location.href = '../signup.html';
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Account deletion failed:', error);
Â  Â  Â  Â Â 
Â  Â  Â  Â  let errorMessage = 'Failed to delete account: ';
Â  Â  Â  Â  if (error.code === 'auth/requires-recent-login') {
Â  Â  Â  Â  Â  errorMessage += 'Your authentication has expired. Please reauthenticate and try again.';
Â  Â  Â  Â  Â  // Reset reauthentication state for Google users
Â  Â  Â  Â  Â  if (isGoogleAccount) {
Â  Â  Â  Â  Â  Â  isReauthenticated = false;
Â  Â  Â  Â  Â  Â  setupDeleteAccountSection();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  errorMessage += error.message;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  showMessage('error', errorMessage);
Â  Â  Â  }
Â  Â  }

Â  Â  // Utility function to show success/error messages
Â  Â  function showMessage(type, text) {
Â  Â  Â  // Remove any existing messages
Â  Â  Â  const existingMessages = document.querySelectorAll('.message');
Â  Â  Â  existingMessages.forEach(msg => msg.remove());
Â  Â  Â Â 
Â  Â  Â  // Create new message element
Â  Â  Â  const message = document.createElement('div');
Â  Â  Â  message.className = `message ${type}`;
Â  Â  Â  message.textContent = text;
Â  Â  Â Â 
Â  Â  Â  // Insert at the top of main content
Â  Â  Â  const mainContent = document.querySelector('.main-content');
Â  Â  Â  const firstSection = mainContent.querySelector('.settings-section');
Â  Â  Â  mainContent.insertBefore(message, firstSection);
Â  Â  Â Â 
Â  Â  Â  // Auto-remove success messages after 5 seconds
Â  Â  Â  if (type === 'success') {
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  if (message.parentNode) {
Â  Â  Â  Â  Â  Â  message.remove();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }, 5000);
Â  Â  Â  }
Â  Â  }
Â  </script>
</body>
</html>
