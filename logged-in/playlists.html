<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4SP - Playlists (Fixed DB)</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>

    <style>
        /* V4 Theme Base (White & Purple, adapted from soundboard.html) */
        :root {
            --v4-bg-gradient: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
            --v4-card-bg: #fff;
            --v4-text-primary: #333;
            --v4-text-secondary: #555;
            --v4-purple-accent: #6720bd;
            --v4-purple-accent-darker: #5a1aa8;
            --v4-purple-gradient: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            --v4-border-light: #ddd;
            --v4-border-softer: #eee;
            --v4-input-bg: #f8f9fa;
            --v4-input-border: #ccc;
            --v4-error-color: #721c24;
            --v4-error-bg: #f8d7da;
            --v4-success-color: #155724;
            --v4-success-bg: #d4edda;
            --v4-info-color: #004085;
            --v4-info-bg: #cce5ff;
            --v4-font-primary: 'PrimaryFont', sans-serif;
            --v4-font-secondary: 'SecondaryFont', sans-serif;
        }

        body.playlists-page { display: flex; flex-direction: column; min-height: 100vh; margin: 0; font-family: var(--v4-font-primary); background: var(--v4-bg-gradient); color: var(--v4-text-primary); line-height: 1.6; }
        .playlists-container-wrapper { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%); color: #fff; padding: 20px 10px; display: flex; flex-direction: column; border-right: 1px solid #444; transition: width 0.5s ease-in-out; position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .sidebar.collapsed { width: 85px; }
        #toggleSidebar { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: none; border: none; color: #fff; font-size: 1.2em; cursor: pointer; padding: 4px; transition: transform 0.5s ease-in-out; }
        .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
        .user-info { text-align: center; margin: 60px 0 30px; border-bottom: 1px solid #555; padding-bottom: 20px; overflow: visible; }
        .marquee-container { overflow: hidden; white-space: nowrap; position: relative; width: 100%; height: 1.8em; line-height: 1.8em; }
        .marquee-content { display: inline-block; padding-left: 100%; transform: translateX(0); animation: none; line-height: 1.8em; }
        .marquee-active { animation: scroll-left-playlists 12s linear infinite; }
        .sidebar.collapsed .marquee-active { animation-duration: 20s; }
        @keyframes scroll-left-playlists { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        .user-info .username { font-family: var(--v4-font-primary); font-size: 1.3em; margin-bottom: 8px; line-height: 0.2em; font-weight: bold;}
        .user-info .email { font-family: var(--v4-font-secondary); font-size: 0.9em; color: #bbb; }
        .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
        .sidebar nav li { margin-bottom: 10px; }
        .sidebar nav a { display: flex; align-items: center; padding: 12px 15px; color: #fff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; font-family: var(--v4-font-primary); text-transform: uppercase; position: relative; overflow: hidden; font-size: 1em; }
        .sidebar nav a::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent); transition: left 0.5s; }
        .sidebar nav a:hover::before { left: 100%; }
        .sidebar nav a.active, .sidebar nav a:hover { background: var(--v4-purple-gradient); transform: translateX(5px); color: #fff; }
        .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
        .sidebar nav a .label { margin-left: 10px; white-space: nowrap; }
        .sidebar.collapsed nav a { justify-content: center; padding: 10px 0; }
        .sidebar.collapsed nav a .label { display: none; }
        .sidebar.collapsed nav a .icon { margin-right: 0; margin-left:0; }
        .main-playlists-content { flex: 1; padding: 30px; background: var(--v4-bg-gradient); overflow-y: auto; display: flex; flex-direction: column; }
        .playlists-header-v4 { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: var(--v4-card-bg); padding: 20px 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid rgba(103, 32, 189, 0.1); }
        .playlists-title-v4 { font-size: 2.2em; font-weight: bold; background: var(--v4-purple-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }
        .control-button-v4 { padding: 10px 18px; background: var(--v4-purple-gradient); color: white; border: none; border-radius: 8px; cursor: pointer; font-family: var(--v4-font-primary); font-size: 0.95em; text-transform: uppercase; transition: all 0.25s ease; box-shadow: 0 2px 8px rgba(103, 32, 189, 0.3); }
        .control-button-v4:hover:not(:disabled) { background: linear-gradient(135deg, var(--v4-purple-accent-darker) 0%, #7923c8 100%); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(103, 32, 189, 0.5); }
        .control-button-v4:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; transform: none; }
        .action-button-v4 { padding: 6px 12px; font-size: 0.8em; margin: 0 5px; background-color: var(--v4-input-bg); color: var(--v4-text-secondary); border: 1px solid var(--v4-input-border); border-radius: 6px; }
        .action-button-v4:hover { background-color: #e9ecef; border-color: var(--v4-purple-accent); color: var(--v4-purple-accent);}
        .action-button-v4.delete { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb;}
        .action-button-v4.delete:hover { background-color: #f5c6cb; color: #721c24; border-color: #721c24;}
        .playlist-tabs { margin-bottom: 20px; display: flex; gap: 10px; border-bottom: 2px solid var(--v4-border-light); }
        .tab-button { padding: 10px 20px; cursor: pointer; border: none; background-color: transparent; font-family: var(--v4-font-primary); font-size: 1em; color: var(--v4-text-secondary); border-bottom: 3px solid transparent; transition: color 0.3s, border-bottom-color 0.3s; }
        .tab-button:hover { color: var(--v4-purple-accent); }
        .tab-button.active { color: var(--v4-purple-accent); border-bottom-color: var(--v4-purple-accent); font-weight: bold; }
        .playlists-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .playlist-card-v4 { background: var(--v4-card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.07); border: 1px solid var(--v4-border-softer); display: flex; flex-direction: column; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .playlist-card-v4:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
        .playlist-card-v4 h3 { font-size: 1.3em; color: var(--v4-purple-accent); margin:0 0 10px; font-family: var(--v4-font-primary); }
        .playlist-card-v4 p.desc { font-size: 0.9em; color: var(--v4-text-secondary); margin-bottom: 8px; font-family: var(--v4-font-secondary); flex-grow: 1; max-height: 60px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; }
        .playlist-card-v4 .info-chips { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .info-chip { background-color: var(--v4-input-bg); color: var(--v4-text-secondary); padding: 4px 10px; border-radius: 15px; font-size: 0.75em; border: 1px solid var(--v4-border-softer); }
        .info-chip.public { background-color: #d4edda; color: #155724; border-color: #c3e6cb;}
        .info-chip.private { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb;}
        .playlist-card-v4 .actions { margin-top: auto; padding-top: 10px; border-top: 1px solid var(--v4-border-softer); display: flex; justify-content: flex-end; flex-wrap: wrap; gap: 5px; }
        .modal-v4 { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); animation: fadeInModalV4 0.3s ease forwards; }
        .modal-content-v4 { background-color: var(--v4-card-bg); margin: 5% auto; padding: 25px 35px; border-radius: 15px; width: 90%; max-width: 700px; box-shadow: 0 5px 25px rgba(0,0,0,0.15); position: relative; }
        .close-btn-v4 { color: #aaa; float: right; font-size: 28px; font-weight: bold; position: absolute; top: 15px; right: 25px; }
        .close-btn-v4:hover, .close-btn-v4:focus { color: var(--v4-text-primary); text-decoration: none; cursor: pointer; }
        .modal-content-v4 h3 { font-size: 1.8em; color: var(--v4-purple-accent); margin-bottom: 20px; text-align: center; font-family: var(--v4-font-primary); }
        .form-group-v4 { margin-bottom: 20px; }
        .form-group-v4 label { display: block; margin-bottom: 8px; color: var(--v4-text-secondary); font-family: var(--v4-font-secondary); font-size: 0.95em; font-weight: 500; }
        .form-group-v4 input[type="text"], .form-group-v4 textarea { width: 100%; padding: 12px 15px; background-color: var(--v4-input-bg); border: 1px solid var(--v4-input-border); border-radius: 8px; color: var(--v4-text-primary); font-size: 1em; outline: none; font-family: var(--v4-font-secondary); box-sizing: border-box; }
        .form-group-v4 input[type="text"]:focus, .form-group-v4 textarea:focus { border-color: var(--v4-purple-accent); box-shadow: 0 0 0 3px rgba(103, 32, 189, 0.15); }
        .form-group-v4 textarea { min-height: 80px; resize: vertical; }
        .form-group-v4 .radio-group label { display: inline-flex; align-items: center; margin-right: 15px; font-weight: normal;}
        .form-group-v4 input[type="radio"] { margin-right: 5px; accent-color: var(--v4-purple-accent); transform: scale(1.1);}
        #playlistSoundSearch { margin-bottom: 10px; }
        .sound-selector-grid-v4 { max-height: 250px; overflow-y: auto; padding: 10px; border: 1px solid var(--v4-border-light); border-radius: 8px; background-color: var(--v4-input-bg); }
        .sound-selector-grid-v4 .category-title-modal { font-size: 1.1em; color: var(--v4-purple-accent); margin: 15px 0 8px; padding-bottom: 5px; border-bottom: 1px solid var(--v4-border-softer); }
        .sound-selector-grid-v4 .sound-checkbox-label { display: block; padding: 8px 10px; margin-bottom: 5px; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; font-size: 0.9em; color: var(--v4-text-primary); line-height: 1.4; }
        .sound-selector-grid-v4 .sound-checkbox-label:hover { background-color: #e9ecef; }
        .sound-selector-grid-v4 input[type="checkbox"] { margin-right: 10px; transform: scale(1.1); accent-color: var(--v4-purple-accent); vertical-align: middle;}
        .status-message-v4 { display: none; padding: 15px 25px; margin: 20px auto; border-radius: 12px; font-size: 0.95em; text-align: center; min-width: 300px; max-width: 600px; width: auto; font-family: var(--v4-font-primary, 'PrimaryFont', sans-serif); text-transform: uppercase; border: 1px solid transparent; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1); color: white; }
        .status-message-v4.fade-in { display: block; animation: fadeInV4 0.3s ease forwards; }
        .status-message-v4.fade-out { animation: fadeOutV4 0.3s ease forwards; }
        .status-message-v4.success { background: linear-gradient(135deg, #1c7430, #155724); border-color: #104d1e; }
        .status-message-v4.error { background: linear-gradient(135deg, #8f262a, #721c24); border-color: #5f171e; }
        .status-message-v4.info { background: var(--v4-purple-gradient); border-color: var(--v4-purple-accent-darker); }
        @keyframes fadeInModalV4 { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInV4 { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOutV4 { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(10px); } }
        @media (max-width: 768px) { .sidebar { width: 100%; height: auto; flex-direction: row; overflow-x: auto; border-right: none; border-bottom: 1px solid #333; padding: 5px; } .sidebar.collapsed { width: 100%; } .sidebar .user-info { display: none; } .sidebar nav { width: 100%; } .sidebar nav ul { flex-direction: row; margin: 0; justify-content: center; width: 100%; } .sidebar nav li { margin-bottom: 0; margin-right: 5px; } .sidebar nav a { padding: 8px 10px; font-size: 0.9em;} .sidebar nav a .icon { margin-right: 5px; font-size: 1em;} #toggleSidebar { display: none; } .playlists-container-wrapper { flex-direction: column; } .main-playlists-content { padding: 15px; } .playlists-title-v4 { font-size: 1.8em; } .playlists-grid { grid-template-columns: 1fr; } .modal-content-v4 { margin: 5% auto; padding: 20px; width: 95%; } .status-message-v4 { min-width: 90%; padding: 10px 15px; font-size: 0.9em; } }
    </style>
</head>
<body class="playlists-page">

    <header class="main-header light-bg">
        <div class="container">
            <div class="logo"><a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer;"/></a></div>
            <div class="auth-buttons">
                <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button>
                <button id="logoutBtnHeader" class="btn btn-login">LOG OUT</button>
            </div>
        </div>
    </header>

    <div class="playlists-container-wrapper">
        <aside class="sidebar slide-in" id="sidebar">
            <button id="toggleSidebar">‚ò∞</button>
            <div class="user-info">
                <div class="marquee-container"> <span id="userName" class="marquee-content username">Loading‚Ä¶</span> </div>
                <div class="marquee-container"> <span id="userEmail" class="marquee-content email">Loading‚Ä¶</span> </div>
            </div>
            <nav>
                <ul>
                    <li><a href="dashboard.html"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
                    <li><a href="proxies.html"><span class="icon">üõ°Ô∏è</span><span class="label">Proxies</span></a></li>
                    <li><a href="soundboard.html"><span class="icon">üéµ</span><span class="label">Soundboard</span></a></li>
                    <li><a href="playlists.html" class="active"><span class="icon">üé∂</span><span class="label">Playlists</span></a></li>
                    <li><a href="games.html"><span class="icon">üéÆ</span><span class="label">Games</span></a></li>
                    <li><a href="others.html"><span class="icon">‚ú®</span><span class="label">Others</span></a></li>
                    <li><a href="settings.html"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a></li>
                    <li><a href="#" id="signOutLinkSidebar"><span class="icon">üîí</span><span class="label">LOG OUT</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-playlists-content">
            <div class="playlists-header-v4">
                <h1 class="playlists-title-v4">Playlists</h1>
                <button id="createPlaylistBtn" class="control-button-v4">Create New Playlist</button>
            </div>
            <div class="playlist-tabs">
                <button class="tab-button active" id="myPlaylistsTab" data-tab="my-playlists">My Playlists</button>
                <button class="tab-button" id="publicPlaylistsTab" data-tab="public-playlists">Public Playlists</button>
            </div>
            <div class="status-message-v4" id="statusMessage"></div>
            <div id="playlistsContainer" class="playlists-grid"><p>Initializing playlists...</p></div>
        </main>
    </div>

    <div id="playlistModal" class="modal-v4">
        <div class="modal-content-v4">
            <span class="close-btn-v4" id="closePlaylistModalBtn">&times;</span>
            <h3 id="modalTitle">Create Playlist</h3>
            <form id="playlistForm">
                <input type="hidden" id="playlistIdStore">
                <div class="form-group-v4">
                    <label for="playlistName">Playlist Name:</label>
                    <input type="text" id="playlistName" required>
                </div>
                <div class="form-group-v4">
                    <label for="playlistDescription">Description:</label>
                    <textarea id="playlistDescription"></textarea>
                </div>
                <div class="form-group-v4">
                    <label>Privacy:</label>
                    <div class="radio-group">
                        <label><input type="radio" name="playlistPrivacy" value="private" checked> Private</label>
                        <label><input type="radio" name="playlistPrivacy" value="public"> Public</label>
                    </div>
                </div>
                <div class="form-group-v4">
                    <h4>Select Sounds: <span id="selectedSoundsCount">(0 selected)</span></h4>
                    <input type="text" id="playlistSoundSearch" placeholder="Search sounds in list...">
                    <div id="playlistSoundSelector" class="sound-selector-grid-v4"><p>Loading sounds for selection...</p></div>
                </div>
                <button type="submit" class="control-button-v4" id="savePlaylistBtn">Save Playlist</button>
            </form>
        </div>
    </div>

    <script>
        console.log("Playlist Script: Initializing (v2 - unique DB var)...");

        const marqueeEls = document.querySelectorAll('.marquee-content');
        let currentUser = null;
        let currentUsername = 'User';
        let firestoreDB; // Using a unique name for the Firestore instance in this script

        function initializeFirestoreInstance() {
            console.log("Playlist Script: Attempting to initialize FirestoreDB instance...");
            try {
                if (firebase && typeof firebase.firestore === 'function') {
                    firestoreDB = firebase.firestore();
                    console.log("Playlist Script: Firestore instance 'firestoreDB' acquired.");
                    return true;
                } else {
                    console.error("Playlist Script: Firebase or firebase.firestore is not available at initialization time.");
                    showStatus("CRITICAL: Firebase Firestore could not be initialized. Playlists disabled.", "error", 10000);
                    return false;
                }
            } catch (e) {
                console.error("Playlist Script: Error during Firestore initialization:", e);
                showStatus("CRITICAL: Error initializing Firestore. Playlists disabled. " + e.message, "error", 10000);
                return false;
            }
        }

        firebase.auth().onAuthStateChanged(async user => {
            console.log("Playlist Script: Auth state changed. User:", user ? user.uid : 'null');
            if (!user) {
                console.log("Playlist Script: User not logged in, redirecting.");
                window.location.href = '../login.html'; 
            } else {
                if (!firestoreDB) { // Initialize Firestore if not already done
                    if (!initializeFirestoreInstance()) {
                        console.error("Playlist Script: Halting further execution due to Firestore init failure.");
                        document.getElementById('playlistsContainer').innerHTML = "<p style='color:red;'>Error: Database connection failed. Cannot load or create playlists.</p>";
                        document.getElementById('createPlaylistBtn').disabled = true;
                        return; // Stop if DB can't be initialized
                    }
                }
                currentUser = user;
                document.getElementById('userEmail').textContent = user.email;
                try {
                    const userDocRef = firestoreDB.collection('users').doc(user.uid);
                    const doc = await userDocRef.get();
                    currentUsername = (doc.exists && doc.data().username) ? doc.data().username : (user.displayName || 'User');
                    document.getElementById('userName').textContent = currentUsername;
                    console.log("Playlist Script: User info populated:", currentUsername);
                } catch (error) {
                    document.getElementById('userName').textContent = 'User'; 
                    console.error("Playlist Script: Error fetching username:", error);
                }
                updateMarquees(); 
                console.log("Playlist Script: Awaiting sound data load...");
                await loadSoundsForForm(); 
                console.log("Playlist Script: Sound data load attempt complete. Processing URL params and loading playlists...");
                processUrlParametersAndLoadPlaylists(); 
            }
        });

        const sidebar = document.getElementById('sidebar');
        if (sidebar) { // Ensure sidebar exists before adding listener
            const toggleBtn = document.getElementById('toggleSidebar');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', () => {
                    sidebar.classList.toggle('collapsed');
                    setTimeout(updateMarquees, 550); 
                });
            }
        }
        
        function updateMarquees() { /* ... (same as previous, ensure sidebar is defined) ... */
            if (!sidebar) return; // Add a guard
            marqueeEls.forEach(el => {
                if (!el || !el.parentElement) return;
                const parent = el.parentElement;
                const isOverflowing = el.scrollWidth > parent.clientWidth;
                const isSidebarCollapsed = sidebar.classList.contains('collapsed');
                el.classList.toggle('marquee-active', isSidebarCollapsed || isOverflowing);
                if (!isOverflowing && !isSidebarCollapsed) {
                    el.classList.remove('marquee-active');
                }
            });
        }
        window.addEventListener('resize', updateMarquees);

        document.getElementById('logoutBtnHeader').addEventListener('click', () => firebase.auth().signOut().then(() => { window.location.href = '../login.html'; }));
        document.getElementById('signOutLinkSidebar').addEventListener('click', (e) => { e.preventDefault(); firebase.auth().signOut().then(() => { window.location.href = '../login.html'; }); });

        const playlistsContainer = document.getElementById('playlistsContainer');
        const createPlaylistBtn = document.getElementById('createPlaylistBtn');
        const playlistModal = document.getElementById('playlistModal');
        const closePlaylistModalBtn = document.getElementById('closePlaylistModalBtn');
        const playlistForm = document.getElementById('playlistForm');
        const modalTitle = document.getElementById('modalTitle');
        const playlistIdStore = document.getElementById('playlistIdStore'); 
        const playlistNameInput = document.getElementById('playlistName');
        const playlistDescriptionInput = document.getElementById('playlistDescription');
        const playlistSoundSelector = document.getElementById('playlistSoundSelector');
        const playlistSoundSearchInput = document.getElementById('playlistSoundSearch');
        const selectedSoundsCountEl = document.getElementById('selectedSoundsCount');
        const statusMessageEl = document.getElementById('statusMessage');
        const savePlaylistBtn = document.getElementById('savePlaylistBtn');
        let statusMessageTimeout = null;

        let allSoundsData = {}; 
        let selectedSoundObjectsInModal = []; 
        let currentView = 'my-playlists'; 

        document.getElementById('myPlaylistsTab').addEventListener('click', () => switchTab('my-playlists'));
        document.getElementById('publicPlaylistsTab').addEventListener('click', () => switchTab('public-playlists'));

        function switchTab(tabName) {
            console.log(`Playlist Script: Switching tab to ${tabName}`);
            currentView = tabName;
            document.getElementById('myPlaylistsTab').classList.toggle('active', tabName === 'my-playlists');
            document.getElementById('publicPlaylistsTab').classList.toggle('active', tabName === 'public-playlists');
            loadPlaylists(); 
        }

        function showStatus(message, type = 'info', duration = 3000) {
            console.log(`Playlist Script: Status - Type: ${type}, Message: ${message}`);
            clearTimeout(statusMessageTimeout);
            statusMessageEl.textContent = message;
            statusMessageEl.className = 'status-message-v4 ' + type; 
            statusMessageEl.style.display = 'block';
            statusMessageEl.classList.remove('fade-out'); statusMessageEl.classList.add('fade-in');
            statusMessageTimeout = setTimeout(() => {
                statusMessageEl.classList.remove('fade-in'); statusMessageEl.classList.add('fade-out');
                setTimeout(() => { statusMessageEl.style.display = 'none'; statusMessageEl.classList.remove('fade-out'); }, 300);
            }, duration);
        }

        function generatePlaylistId(length = 15) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
            console.log(`Playlist Script: Generated Playlist ID: ${result}`);
            return result;
        }

        async function loadSoundsForForm() {
            console.log("Playlist Script: Attempting to load SoundboardNames.json from '../SoundboardNames.json'...");
            try {
                const response = await fetch('../SoundboardNames.json'); 
                console.log(`Playlist Script: SoundboardNames.json fetch response status: ${response.status}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}. Failed to fetch SoundboardNames.json.`);
                }
                allSoundsData = await response.json();
                if (typeof allSoundsData !== 'object' || allSoundsData === null) {
                    throw new Error("SoundboardSN.json did not parse into an object.");
                }
                if (Object.keys(allSoundsData).length === 0) {
                    console.warn("Playlist Script: SoundboardSN.json loaded but is empty or structured unexpectedly.");
                    showStatus("Sound data loaded, but no sounds found. Sound selection will be empty.", "info", 4000);
                } else {
                    console.log("Playlist Script: SoundboardSN.json loaded. Categories found:", Object.keys(allSoundsData).length);
                }
            } catch (error) {
                console.error("Playlist Script: CRITICAL ERROR loading SoundboardSN.json:", error.message, error.stack);
                if(playlistSoundSelector) playlistSoundSelector.innerHTML = `<p style="color:var(--v4-error-color);">Error loading sounds. Check console.</p>`;
                showStatus(`Critical: Could not load sounds data. Error: ${error.message}. Check console.`, "error", 7000);
                allSoundsData = {}; 
            }
        }

        function handleSoundSelectionChangeInModal() {
            selectedSoundObjectsInModal = Array.from(playlistSoundSelector.querySelectorAll('input[type="checkbox"]:checked'))
                                             .map(cb => JSON.parse(cb.value));
            updateSelectedSoundsCount();
            // console.log("Playlist Script: Modal sound selection changed. Count:", selectedSoundObjectsInModal.length);
        }

        function updateSelectedSoundsCount() {
            selectedSoundsCountEl.textContent = `(${selectedSoundObjectsInModal.length} selected)`;
        }

        function renderSoundSelector(searchTerm = '') {
            // console.log(`Playlist Script: Rendering sound selector. Term: "${searchTerm}", Sounds loaded: ${Object.keys(allSoundsData).length > 0}`);
            playlistSoundSelector.innerHTML = ''; 
            const categoryIcons = {"NormalSounds": "üòä", "ExplicitSounds": "üòà"};
            let soundAvailableOverall = false;

            if (Object.keys(allSoundsData).length === 0) {
                 playlistSoundSelector.innerHTML = `<p style="color:var(--v4-error-color);">No sounds loaded (SoundboardSN.json might be missing, empty, or invalid). Cannot select sounds.</p>`;
                 return;
            }

            for (const categoryKey in allSoundsData) {
                if (!allSoundsData.hasOwnProperty(categoryKey) || !Array.isArray(allSoundsData[categoryKey])) continue;
                const categoryName = categoryKey.replace(/([A-Z])/g, ' $1').trim(); 
                const icon = categoryIcons[categoryKey] || 'üéµ';
                const filteredSounds = allSoundsData[categoryKey].filter(filename => {
                    const displayName = filename.replace(/\.mp3$/i, '').replace(/_/g, ' ');
                    return displayName.toLowerCase().includes(searchTerm.toLowerCase());
                }).sort();

                if (filteredSounds.length > 0) {
                    soundAvailableOverall = true;
                    const categoryTitleEl = document.createElement('h5');
                    categoryTitleEl.className = 'category-title-modal';
                    categoryTitleEl.innerHTML = `<span class="category-icon-v4">${icon}</span> ${categoryName}`;
                    playlistSoundSelector.appendChild(categoryTitleEl);
                    filteredSounds.forEach(filename => {
                        const displayName = filename.replace(/\.mp3$/i, '').replace(/_/g, ' ');
                        const soundObject = { category: categoryKey, filename: filename, displayName: displayName };
                        const labelEl = document.createElement('label'); labelEl.className = 'sound-checkbox-label';
                        const checkboxEl = document.createElement('input'); checkboxEl.type = 'checkbox'; checkboxEl.value = JSON.stringify(soundObject);
                        checkboxEl.checked = selectedSoundObjectsInModal.some(s => s.filename === soundObject.filename && s.category === soundObject.category);
                        checkboxEl.addEventListener('change', handleSoundSelectionChangeInModal);
                        labelEl.appendChild(checkboxEl); labelEl.appendChild(document.createTextNode(` ${displayName}`)); playlistSoundSelector.appendChild(labelEl);
                    });
                }
            }
            if (!soundAvailableOverall && searchTerm) {
                 playlistSoundSelector.innerHTML = `<p>No sounds match "${searchTerm}".</p>`;
            } else if (!soundAvailableOverall && !searchTerm) {
                playlistSoundSelector.innerHTML = `<p>No sounds found in the loaded data.</p>`;
            }
        }

        playlistSoundSearchInput.addEventListener('input', (e) => {
            renderSoundSelector(e.target.value.toLowerCase());
        });

        createPlaylistBtn.addEventListener('click', () => {
            console.log("Playlist Script: 'Create New Playlist' button clicked.");
            modalTitle.textContent = 'Create New Playlist';
            playlistForm.reset(); 
            playlistIdStore.value = ''; 
            selectedSoundObjectsInModal = []; 
            renderSoundSelector(''); 
            updateSelectedSoundsCount(); 
            playlistModal.style.display = 'block';
            playlistNameInput.focus(); 
        });

        closePlaylistModalBtn.addEventListener('click', () => playlistModal.style.display = 'none');
        window.addEventListener('click', (event) => { 
            if (event.target == playlistModal) {
                playlistModal.style.display = 'none';
            }
        });

        playlistForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log("Playlist Script: Playlist form submitted.");
            if (!firestoreDB) { showStatus("Database not connected. Cannot save.", "error"); return; }
            if (!currentUser) { showStatus("You must be logged in.", "error"); return; }

            const name = playlistNameInput.value.trim();
            const description = playlistDescriptionInput.value.trim();
            const isPrivate = playlistForm.elements.playlistPrivacy.value === 'private';
            const sounds = selectedSoundObjectsInModal; 

            if (!name) { showStatus("Playlist name is required.", "error"); playlistNameInput.focus(); return; }
            if (sounds.length === 0 && Object.keys(allSoundsData).length > 0) { 
                 showStatus("Please select at least one sound.", "error"); return; 
            } else if (sounds.length === 0 && Object.keys(allSoundsData).length === 0) {
                console.warn("Playlist Script: Creating playlist without sounds as no sounds were available/loaded.");
            }

            const playlistData = {
                name, description, sounds, isPrivate,
                creatorId: currentUser.uid, creatorUsername: currentUsername, 
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            const existingId = playlistIdStore.value; 
            savePlaylistBtn.disabled = true; savePlaylistBtn.textContent = 'Saving...';
            console.log("Playlist Script: Saving playlist. New?:", !existingId, "Data:", playlistData);

            try {
                if (existingId) { 
                    console.log(`Playlist Script: Updating playlist ${existingId}`);
                    await firestoreDB.collection('playlists').doc(existingId).update(playlistData);
                    showStatus("Playlist updated!", "success");
                } else { 
                    playlistData.id = generatePlaylistId(); 
                    playlistData.createdAt = firebase.firestore.FieldValue.serverTimestamp(); 
                    console.log(`Playlist Script: Creating new playlist with ID ${playlistData.id}`);
                    await firestoreDB.collection('playlists').doc(playlistData.id).set(playlistData);
                    showStatus("Playlist created!", "success");
                }
                playlistModal.style.display = 'none'; 
                loadPlaylists(); 
            } catch (error) {
                console.error("Playlist Script: Error saving playlist:", error.message, error.code, error.stack);
                showStatus("Error saving playlist: " + error.message + ". Check console & Firestore rules.", "error", 7000);
            } finally {
                savePlaylistBtn.disabled = false; savePlaylistBtn.textContent = 'Save Playlist';
            }
        });

        async function loadPlaylists() {
            console.log(`Playlist Script: Loading playlists. View: ${currentView}`);
            if (!firestoreDB) { showStatus("Database error. Cannot load playlists.", "error"); playlistsContainer.innerHTML = '<p>Database not connected.</p>'; return; }
            if (!currentUser) { playlistsContainer.innerHTML = '<p>Please log in.</p>'; return; }

            playlistsContainer.innerHTML = '<p>Loading playlists...</p>'; 

            try {
                let query = firestoreDB.collection('playlists').orderBy('updatedAt', 'desc');
                if (currentView === 'my-playlists') {
                    query = query.where('creatorId', '==', currentUser.uid);
                } else { 
                    query = query.where('isPrivate', '==', false);
                }
                console.log(`Playlist Script: Executing Firestore query for ${currentView}...`);
                const snapshot = await query.get();
                console.log(`Playlist Script: Query completed. Found ${snapshot.size} playlists.`);
                if (snapshot.empty) {
                    playlistsContainer.innerHTML = currentView === 'my-playlists' ?
                        '<p>No playlists created by you yet. Try creating one!</p>' :
                        '<p>No public playlists available at the moment.</p>';
                    return;
                }

                playlistsContainer.innerHTML = ''; 
                snapshot.forEach(doc => {
                    const playlist = doc.data();
                    const playlistIdToUse = playlist.id || doc.id; 
                    if (!playlistIdToUse) { console.warn("Playlist Script: Playlist doc missing ID:", doc.ref.path); return; }
                    renderPlaylistCard(playlist, playlistIdToUse);
                });
            } catch (error) {
                console.error("Playlist Script: Error loading playlists (check rules/indexes):", error.message, error.code, error.stack);
                playlistsContainer.innerHTML = `<p style="color:var(--v4-error-color);">Error loading. Details: ${error.message}. See console.</p>`;
                showStatus("Failed to load. Check console (permissions, indexes).", "error", 7000);
            }
        }

        function renderPlaylistCard(playlist, playlistId) {
            const card = document.createElement('div'); card.className = 'playlist-card-v4'; card.dataset.playlistId = playlistId;
            const title = document.createElement('h3'); title.textContent = playlist.name; card.appendChild(title);
            const desc = document.createElement('p'); desc.className = 'desc'; desc.textContent = playlist.description || 'No description.'; card.appendChild(desc);
            const chips = document.createElement('div'); chips.className = 'info-chips';
            chips.innerHTML = `<span class="info-chip">${playlist.sounds.length} Sound${playlist.sounds.length !== 1 ? 's' : ''}</span> <span class="info-chip ${playlist.isPrivate ? 'private' : 'public'}">${playlist.isPrivate ? 'Private' : 'Public'}</span>`;
            if (currentView === 'public-playlists' && playlist.creatorUsername && playlist.creatorId !== currentUser.uid) {
                 chips.innerHTML += `<span class="info-chip">By: ${playlist.creatorUsername}</span>`;
            }
            card.appendChild(chips);
            const actionsDiv = document.createElement('div'); actionsDiv.className = 'actions';
            const openBtn = document.createElement('button'); openBtn.textContent = 'Open'; openBtn.className = 'control-button-v4 action-button-v4';
            openBtn.onclick = () => { console.log(`Playlist Script: Opening playlist ${playlistId}`); window.location.href = `playlist-view.html?viewid=${playlistId}`;}; actionsDiv.appendChild(openBtn);

            if (playlist.creatorId === currentUser.uid) { 
                const editBtn = document.createElement('button'); editBtn.textContent = 'Edit'; editBtn.className = 'control-button-v4 action-button-v4';
                editBtn.onclick = () => { console.log(`Playlist Script: Editing playlist ${playlistId}`); openEditPlaylistForm(playlistId); }; actionsDiv.appendChild(editBtn);
                const deleteBtn = document.createElement('button'); deleteBtn.textContent = 'Delete'; deleteBtn.className = 'control-button-v4 action-button-v4 delete';
                deleteBtn.onclick = () => { console.log(`Playlist Script: Deleting playlist ${playlistId}`); deletePlaylist(playlistId, playlist.name); }; actionsDiv.appendChild(deleteBtn);
            } else if (!playlist.isPrivate) { 
                const remixBtn = document.createElement('button'); remixBtn.textContent = 'Remix'; remixBtn.className = 'control-button-v4 action-button-v4';
                remixBtn.onclick = () => { console.log(`Playlist Script: Remixing playlist ${playlistId}`); remixPlaylist(playlistId); }; actionsDiv.appendChild(remixBtn);
            }
            card.appendChild(actionsDiv); playlistsContainer.appendChild(card);
        }

        async function openEditPlaylistForm(playlistId) { /* ... (Same as previous but use firestoreDB) ... */
            console.log(`Playlist Script: Opening edit form for ${playlistId}. Sounds loaded: ${Object.keys(allSoundsData).length > 0}`);
            if (Object.keys(allSoundsData).length === 0 && !confirm("Sound data couldn't be loaded. You can edit text fields, but not sounds. Continue?")) {
                showStatus("Sound data not available. Cannot fully edit playlist sounds.", "error", 4000); return;
            }
            try {
                const doc = await firestoreDB.collection('playlists').doc(playlistId).get();
                if (!doc.exists) { showStatus("Playlist not found for editing.", "error"); return; }
                const playlist = doc.data();
                if (playlist.creatorId !== currentUser.uid) { showStatus("You can only edit your own playlists.", "error"); return;}
                modalTitle.textContent = 'Edit Playlist'; playlistForm.reset(); playlistIdStore.value = playlistId; 
                playlistNameInput.value = playlist.name; playlistDescriptionInput.value = playlist.description;
                playlistForm.elements.playlistPrivacy.value = playlist.isPrivate ? 'private' : 'public';
                selectedSoundObjectsInModal = [...playlist.sounds]; renderSoundSelector(''); updateSelectedSoundsCount();
                playlistModal.style.display = 'block'; playlistNameInput.focus();
            } catch (error) { console.error("Playlist Script: Error fetching playlist for edit:", error); showStatus("Failed to load for edit. Check console.", "error", 5000); }
        }

        async function deletePlaylist(playlistId, playlistName) { /* ... (Same as previous but use firestoreDB) ... */
            if (!confirm(`Delete "${playlistName}"?`)) return; console.log(`Playlist Script: Confirmed deletion for ${playlistId}`);
            try { await firestoreDB.collection('playlists').doc(playlistId).delete(); showStatus(`"${playlistName}" deleted.`, "success"); loadPlaylists(); 
            } catch (error) { console.error("Playlist Script: Error deleting playlist:", error); showStatus(`Error deleting: ${error.message}. Check console.`, "error", 5000); }
        }

        async function remixPlaylist(playlistId) { /* ... (Same as previous but use firestoreDB) ... */
            console.log(`Playlist Script: Preparing remix for ${playlistId}. Sounds loaded: ${Object.keys(allSoundsData).length > 0}`);
            if (Object.keys(allSoundsData).length === 0 && !confirm("Sound data couldn't be loaded. You can edit text fields, but not sounds for remix. Continue?")) {
                showStatus("Sound data not available. Cannot fully remix sounds.", "error", 4000); return;
            }
             try {
                const doc = await firestoreDB.collection('playlists').doc(playlistId).get();
                if (!doc.exists) { showStatus("Remix source not found.", "error"); return; }
                const p = doc.data(); if (p.isPrivate && p.creatorId !== currentUser.uid) { showStatus("Cannot remix other's private playlist.", "error"); return; }
                modalTitle.textContent = 'Remix Playlist'; playlistForm.reset(); playlistIdStore.value = ''; 
                playlistNameInput.value = `${p.name} (remix)`; playlistDescriptionInput.value = p.description;
                playlistForm.elements.playlistPrivacy.value = 'private'; 
                selectedSoundObjectsInModal = [...p.sounds]; renderSoundSelector(''); updateSelectedSoundsCount();
                playlistModal.style.display = 'block'; showStatus(`Remixing "${p.name}". Save as new.`, "info", 5000); playlistNameInput.focus();
            } catch (error) { console.error("Playlist Script: Error preparing remix:", error); showStatus("Failed to prep remix. Check console.", "error", 5000); }
        }

        async function processUrlParametersAndLoadPlaylists() {
            console.log("Playlist Script: Processing URL parameters...");
            const urlParams = new URLSearchParams(window.location.search);
            const editId = urlParams.get('edit');
            const remixId = urlParams.get('remix');
            let actionTakenViaUrl = false;
            
            if ((editId || remixId) && Object.keys(allSoundsData).length === 0) {
                console.warn("Playlist Script: URL params for edit/remix but sound data not loaded. Modal might lack sounds.");
            }
            
            if (editId) {
                console.log(`Playlist Script: URL 'edit' param: ${editId}`);
                await openEditPlaylistForm(editId); actionTakenViaUrl = true;
            } else if (remixId) {
                console.log(`Playlist Script: URL 'remix' param: ${remixId}`);
                await remixPlaylist(remixId); actionTakenViaUrl = true;
            }

            if (actionTakenViaUrl) {
                console.log("Playlist Script: Cleaning URL parameters.");
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            console.log("Playlist Script: Proceeding to load playlists.");
            loadPlaylists();
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log("Playlist Script: DOMContentLoaded event.");
            // Initialize Firestore here if not done in auth, but auth-based is better for user-specific ops.
            // For now, auth state change listener handles main initialization.
            setTimeout(updateMarquees, 600);
        });

        console.log("Playlist Script: Script loaded. Waiting for Firebase Auth & Firestore init.");
    </script>
</body>
</html>
