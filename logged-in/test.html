<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4SP - SOUNDBOARD</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>

    <style>
        /* V4 Theme Base */
        :root {
            --v4-bg-gradient: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
            --v4-card-bg: #fff;
            --v4-text-primary: #333;
            --v4-text-secondary: #555;
            --v4-purple-accent: #6720bd;
            --v4-purple-accent-darker: #5a1aa8;
            --v4-purple-gradient: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            --v4-border-light: #ddd;
            --v4-border-softer: #eee;
            --v4-input-bg: #f8f9fa;
            --v4-input-border: #ccc;
            --v4-font-primary: 'PrimaryFont', sans-serif;
            --v4-font-secondary: 'SecondaryFont', sans-serif;
        }

        body.soundboard-page {
            display: flex; flex-direction: column; min-height: 100vh; margin: 0;
            font-family: var(--v4-font-primary); background-color: var(--v4-bg-gradient);
            color: var(--v4-text-primary); line-height: 1.6;
        }

        .soundboard-container-wrapper { display: flex; flex: 1; overflow: hidden; }

        /* Sidebar Styles (Unchanged) */
        .sidebar {
            width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%);
            color: #fff; padding: 20px 10px; display: flex; flex-direction: column;
            border-right: 1px solid #444; transition: width 0.5s ease-in-out;
            position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .sidebar.collapsed { width: 85px; }
        .sidebar nav a { border-radius: 8px; /* Consistent with new design */ }
        .user-info { text-align: center; margin: 60px 0 30px; border-bottom: 1px solid #555; padding-bottom: 20px; }
        
        /* --- V5 UNIFIED REDESIGN --- */
        
        /* Main Layout & Cards */
        .main-soundboard-content {
            flex: 1; padding: 30px; background: var(--v4-bg-gradient);
            overflow-y: auto; display: flex; flex-direction: column;
        }
        .soundboard-header-v4, .search-filter-container, .soundboard-controls-v4, .sound-category-v4, .status-message-v4 {
            background: var(--v4-card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid rgba(103, 32, 189, 0.1);
            margin-bottom: 25px;
        }
        .soundboard-header-v4 { display: flex; justify-content: space-between; align-items: center; padding: 20px 30px; }
        .soundboard-title-v4 { font-size: 2.2em; font-weight: bold; background: var(--v4-purple-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        
        /* Search & Inputs */
        .search-filter-container { padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.06); }
        .search-filter-container input[type="text"] {
            width: 100%; padding: 12px 15px; background-color: var(--v4-input-bg);
            border: 1px solid var(--v4-input-border); border-radius: 8px;
            color: var(--v4-text-primary); font-size: 1em; outline: none;
        }
        .search-filter-container input[type="text"]:focus { border-color: var(--v4-purple-accent); box-shadow: 0 0 0 3px rgba(103, 32, 189, 0.15); }
        
        /* Settings Panel */
        #toggleControlsBtn { margin-bottom: 15px; align-self: flex-start; }
        .soundboard-controls-v4 {
            padding: 25px; transition: all 0.4s cubic-bezier(0.25, 0.1, 0.25, 1);
            opacity: 1; max-height: 2000px; overflow: hidden;
        }
        .soundboard-controls-v4.collapsed { padding-top: 0; padding-bottom: 0; margin-bottom: 0; border-width: 0; opacity: 0; max-height: 0; }
        .controls-sections-wrapper { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; }
        .controls-section h3 { font-size: 1.1em; font-weight: 600; color: var(--v4-purple-accent); margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid var(--v4-border-light); text-transform: uppercase; letter-spacing: 0.5px; }
        .control-group { display: flex; flex-direction: column; margin-bottom: 15px; }
        .control-group label, .checkbox-label-v4 { font-size: 0.9em; color: var(--v4-text-secondary); margin-bottom: 6px; }
        .checkbox-label-v4 { display: flex; align-items: center; cursor: pointer; }
        .control-group input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: var(--v4-border-light); outline: none; border-radius: 8px; }
        .control-group input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; background: var(--v4-purple-accent); cursor: pointer; border-radius: 50%; }
        .control-group input[type="number"], .control-group select { width: 100%; padding: 10px 12px; background-color: var(--v4-input-bg); border: 1px solid var(--v4-input-border); border-radius: 8px; font-size: 0.95em; outline: none; }
        .control-group input[type="checkbox"] { margin-right: 8px; transform: scale(1.1); accent-color: var(--v4-purple-accent); }

        /* --- NEW, CORRECTED BUTTON STYLES --- */
        .styled-btn {
          background: none; border: 1.5px solid; padding: 8px 12px;
          border-radius: 8px; cursor: pointer; font-size: 0.9em;
          transition: all 0.2s ease-in-out; font-family: var(--v4-font-primary);
          text-transform: uppercase; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
          margin: 0 2px;
        }
        .styled-btn:hover { transform: translateY(-1px); }
        .open-save-btn { background: rgba(0, 123, 255, 0.1); border-color: #007bff; color: #007bff; }
        .open-save-btn:hover { background: #007bff; color: #fff; box-shadow: 0 2px 6px rgba(0,123,255,0.3); }
        .edit-countdown-btn { background: rgba(255, 193, 7, 0.1); border-color: #ffc107; color: #856404; }
        .edit-countdown-btn:hover { background: #ffc107; color: #212529; box-shadow: 0 2px 6px rgba(255,193,7,0.3); }
        .delete-save-btn { background: rgba(178, 34, 34, 0.1); border-color: #b22222; color: #b22222; }
        .delete-save-btn:hover { background: #b22222; color: #fff; box-shadow: 0 2px 6px rgba(178,34,34,0.3); }
        .button-group { display: flex; flex-wrap: wrap; gap: 5px; align-items: center; }
        
        /* Sound Pads */
        .sound-category-v4 { padding: 20px; }
        .sound-category-v4 h2 { font-size: 1.5em; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--v4-border-softer); text-transform: uppercase; display: flex; align-items: center; }
        .category-icon-v4 { margin-right: 10px; font-size: 1.2em; color: var(--v4-purple-accent); }
        .sound-buttons-grid-v4 { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .sound-button-v4 { background-color: var(--v4-input-bg); color: var(--v4-text-secondary); border: 1px solid var(--v4-input-border); padding: 8px 12px; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s ease; text-transform: uppercase; display: flex; align-items: center; justify-content: center; }
        .sound-button-v4:hover { background-color: #e9ecef; border-color: var(--v4-purple-accent); color: var(--v4-purple-accent); transform: translateY(-2px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .sound-button-v4.playing { background-color: var(--v4-purple-accent); color: white; border-color: var(--v4-purple-accent-darker); animation: pulsePlayingSoundboardV4 1.5s infinite; }
        @keyframes pulsePlayingSoundboardV4 { 0% { box-shadow: 0 0 0 0px var(--v4-purple-accent); } 70% { box-shadow: 0 0 0 8px rgba(103, 32, 189, 0.4); } 100% { box-shadow: 0 0 0 0px rgba(103, 32, 189, 0.1); } }
        
        /* Overlay & Status Messages */
        #currentSoundDisplayOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(240, 242, 245, 0.85); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; text-align: center; z-index: 1000; flex-direction: column; padding: 20px; }
        #overlaySoundNameV4 { font-size: 2.5em; margin-bottom: 20px; color: var(--v4-purple-accent); }
        #overlayProgressContainerV4 { width: 70%; max-width: 500px; height: 15px; background-color: var(--v4-border-light); border-radius: 8px; overflow: hidden; margin-top: 15px; }
        #overlayProgressBarV4 { width: 0%; height: 100%; background-color: var(--v4-purple-accent); border-radius: 8px; transition: width 0.1s linear; }
        #closeOverlayBtnV4 { margin-top: 30px; }
        .status-message-v4 { padding: 15px 25px; margin: 0 auto 25px auto; text-align: center; color: white; display: none; }
        .status-message-v4.success { background: linear-gradient(135deg, #1c7430, #155724); }
        .status-message-v4.error { background: linear-gradient(135deg, #8f262a, #721c24); }
        @keyframes fadeInV4 { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeInV4 0.3s ease forwards; }
    </style>
</head>
<body class="soundboard-page">

    <header class="main-header light-bg"> </header>
    <div class="soundboard-container-wrapper">
        <aside class="sidebar slide-in" id="sidebar"> </aside>

        <main class="main-soundboard-content">
            <div class="soundboard-header-v4">
                <h2 class="soundboard-title-v4">Soundboard</h2>
                <button id="clearAllSoundsBtnV4" class="styled-btn delete-save-btn">Stop All</button>
            </div>

            <div class="search-filter-container">
                <input type="text" id="soundSearchInputV4" placeholder="Search for sounds...">
            </div>

            <div id="statusMessageV4" class="status-message-v4"></div>

            <button id="toggleControlsBtn" class="styled-btn open-save-btn">Hide Settings</button>

            <div class="soundboard-controls-v4">
                <div class="controls-inner-wrapper">
                    <div class="controls-sections-wrapper">
                        <div class="controls-section">
                            <h3>Playback Options</h3>
                            <div class="control-group"> <label class="checkbox-label-v4"> <input type="checkbox" id="allowMultipleSoundsToggleV4" checked> Allow Multiple Sounds </label> </div>
                            <div class="control-group"> <label class="checkbox-label-v4"> <input type="checkbox" id="currentSoundDisplayToggleV4"> Show Sound Overlay </label> </div>
                            <div class="control-group"> <label>Looping</label> <div class="button-group"> <button id="loopToggleBtnV4" class="styled-btn edit-countdown-btn">Loop: OFF</button> </div> </div>
                        </div>

                        <div class="controls-section">
                            <h3>Speed & Timing</h3>
                            <div class="control-group"> <label for="playbackSpeedSelectV4">Playback Speed Presets</label> <select id="playbackSpeedSelectV4"> <option value="0.5">0.5x</option> <option value="0.75">0.75x</option> <option value="1" selected>1x (Normal)</option> <option value="1.5">1.5x</option> <option value="2">2x</option> <option value="3">3x</option> </select> </div>
                            <div class="control-group"> <label for="playbackSpeedSliderV4">Fine Tune Speed: <span id="playbackSpeedValueV4">1.0x</span></label> <input type="range" id="playbackSpeedSliderV4" min="0.1" max="5" step="0.05" value="1"> </div>
                            <div class="control-group"> <label for="fadeDurationV4">Fade In/Out (ms)</label> <input type="number" id="fadeDurationV4" value="100" min="0" placeholder="e.g., 100"> </div>
                        </div>

                        <div class="controls-section">
                            <h3>Autoclicker</h3>
                            <div class="control-group"> <label class="checkbox-label-v4"> <input type="checkbox" id="autoClickerCheckboxV4"> Enable Autoclicker </label> </div>
                            <div class="control-group" id="autoClickDelayLabelV4" style="display: none;">
                                <label for="autoClickDelayInputV4">Delay (ms)</label>
                                <div class="button-group"> <input type="number" id="autoClickDelayInputV4" value="200" min="0.5" style="width: 100px;"> <button id="applyDelayBtnV4" class="styled-btn open-save-btn">Apply</button> </div>
                            </div>
                        </div>
                    </div>
                     <div class="control-group" style="margin-top: 20px; border-top: 1px solid var(--v4-border-softer); padding-top:20px;"> <label for="masterVolumeSliderV4">Master Volume: <span id="masterVolumeValueV4">100%</span></label> <input type="range" id="masterVolumeSliderV4" min="0" max="1" step="0.01" value="1"> </div>
                    <div class="controls-section" style="margin-top: 10px; border-top: 1px solid var(--v4-border-softer); padding-top:20px;">
                        <h3>Manage Settings</h3>
                        <div class="button-group"> <button class="styled-btn open-save-btn">Save Preferences</button> <button class="styled-btn edit-countdown-btn">Load Defaults</button> <button class="styled-btn delete-save-btn">Reset All</button> </div>
                    </div>
                    <div class="control-group" style="margin-top: 10px;"> <p style="font-size: 0.8em; color: var(--v4-text-secondary);">Keyboard Shortcut: Shift + C to Mute & Clear All Sounds.</p> </div>
                </div>
            </div>
            <div id="soundCategoriesContainerV4"> <p>Loading sounds...</p> </div>
        </main>
    </div>

    <div id="currentSoundDisplayOverlay"> <h3 id="overlaySoundNameV4">Sound Name</h3>
        <div id="overlayProgressContainerV4"> <div id="overlayProgressBarV4"></div> </div>
        <button id="closeOverlayBtnV4" class="styled-btn delete-save-btn">Close Display</button>
    </div>

    <script>
        // Using the known-good, original V4 Script to ensure functionality.
        const dbRef = () => firebase.firestore().collection('users').doc(firebase.auth().currentUser.uid);
        const marqueeEls = document.querySelectorAll('.marquee-content');
        firebase.auth().onAuthStateChanged(async user => { if (!user) { window.location.href = '../login.html'; } else { const userEmailEl = document.getElementById('userEmail'); const userNameEl = document.getElementById('userName'); if (userEmailEl) userEmailEl.textContent = user.email; if (userNameEl) { try { const doc = await dbRef().get(); userNameEl.textContent = (doc.exists && doc.data().username) ? doc.data().username : (user.displayName || 'User'); } catch (error) { userNameEl.textContent = 'User'; console.error("Error fetching username:", error); } } } });
        document.getElementById('logoutBtn').addEventListener('click', () => { firebase.auth().signOut().then(() => { window.location.href = '../login.html'; }); });
        const signOutLink = document.getElementById('signOutLink'); if(signOutLink) { signOutLink.addEventListener('click', (e) => { e.preventDefault(); firebase.auth().signOut().then(() => { window.location.href = '../login.html'; }); }); }
        const sidebar = document.getElementById('sidebar'); const toggleSidebarBtn = document.getElementById('toggleSidebar'); if (toggleSidebarBtn && sidebar) { toggleSidebarBtn.addEventListener('click', () => { sidebar.classList.toggle('collapsed'); }); }
        
        const soundCategoriesContainerV4 = document.getElementById('soundCategoriesContainerV4'); const soundSearchInputV4 = document.getElementById('soundSearchInputV4'); const statusMessageV4 = document.getElementById('statusMessageV4'); const allowMultipleSoundsToggleV4 = document.getElementById('allowMultipleSoundsToggleV4'); const currentSoundDisplayToggleV4 = document.getElementById('currentSoundDisplayToggleV4'); const loopToggleBtnV4 = document.getElementById('loopToggleBtnV4'); const playbackSpeedSelectV4 = document.getElementById('playbackSpeedSelectV4'); const playbackSpeedSliderV4 = document.getElementById('playbackSpeedSliderV4'); const playbackSpeedValueDisplayV4 = document.getElementById('playbackSpeedValueV4'); const masterVolumeSliderV4 = document.getElementById('masterVolumeSliderV4'); const masterVolumeValueDisplayV4 = document.getElementById('masterVolumeValueDisplayV4'); const autoClickerCheckboxV4 = document.getElementById('autoClickerCheckboxV4'); const autoClickDelayLabelV4 = document.getElementById('autoClickDelayLabelV4'); const autoClickDelayInputV4 = document.getElementById('autoClickDelayInputV4'); const applyDelayBtnV4 = document.getElementById('applyDelayBtnV4'); const fadeDurationInputV4 = document.getElementById('fadeDurationV4'); const clearAllSoundsBtnV4 = document.getElementById('clearAllSoundsBtnV4'); const currentSoundDisplayOverlay = document.getElementById('currentSoundDisplayOverlay'); const overlaySoundNameV4 = document.getElementById('overlaySoundNameV4'); const overlayProgressBarV4 = document.getElementById('overlayProgressBarV4'); const closeOverlayBtnV4 = document.getElementById('closeOverlayBtnV4'); const toggleControlsBtn = document.getElementById('toggleControlsBtn'); const soundboardControlsV4 = document.querySelector('.soundboard-controls-v4');
        let soundsDataGlobal = {}; let playingAudios = []; let currentLoopingAudio = null; let autoClickIntervalId = null; let currentlyHoveredButton = null; const audioContext = new (window.AudioContext || window.webkitAudioContext)(); let globalGainNode = audioContext.createGain(); globalGainNode.connect(audioContext.destination); let statusMessageTimeout = null;
        if (toggleControlsBtn && soundboardControlsV4) { toggleControlsBtn.addEventListener('click', () => { soundboardControlsV4.classList.toggle('collapsed'); if (soundboardControlsV4.classList.contains('collapsed')) { toggleControlsBtn.textContent = 'Show Settings'; } else { toggleControlsBtn.textContent = 'Hide Settings'; } }); }
        function showStatus(message, type = 'info') { if (statusMessageTimeout) clearTimeout(statusMessageTimeout); statusMessageV4.textContent = message; statusMessageV4.className = 'status-message-v4 ' + type; statusMessageV4.classList.add('fade-in'); statusMessageTimeout = setTimeout(() => { statusMessageV4.classList.remove('fade-in'); }, 3000); }
        let currentPlaybackSpeed = 1.0; function applySpeedToAllPlaying() { playingAudios.forEach(audioObj => { if (audioObj.audioElement && !audioObj.audioElement.paused) audioObj.audioElement.playbackRate = currentPlaybackSpeed; }); }
        playbackSpeedSelectV4.addEventListener('change', function() { currentPlaybackSpeed = parseFloat(this.value); playbackSpeedSliderV4.value = currentPlaybackSpeed; playbackSpeedValueDisplayV4.textContent = `${currentPlaybackSpeed.toFixed(2)}x`; localStorage.setItem('playbackSpeedV4', currentPlaybackSpeed.toString()); applySpeedToAllPlaying(); showStatus(`Playback speed: ${currentPlaybackSpeed.toFixed(2)}x`, 'info'); });
        playbackSpeedSliderV4.addEventListener('input', function() { currentPlaybackSpeed = parseFloat(this.value); playbackSpeedValueDisplayV4.textContent = `${currentPlaybackSpeed.toFixed(2)}x`; const presetOption = Array.from(playbackSpeedSelectV4.options).find(opt => parseFloat(opt.value).toFixed(2) === currentPlaybackSpeed.toFixed(2)); playbackSpeedSelectV4.value = presetOption ? presetOption.value : ""; });
        masterVolumeSliderV4.addEventListener('input', (e) => { const volume = parseFloat(e.target.value); masterVolumeValueDisplayV4.textContent = `${Math.round(volume * 100)}%`; globalGainNode.gain.setValueAtTime(volume, audioContext.currentTime); localStorage.setItem('masterVolumeV4', volume.toString()); });
        autoClickerCheckboxV4.addEventListener('change', function() { autoClickDelayLabelV4.style.display = this.checked ? 'block' : 'none'; if (!this.checked) stopAutoClicker(); localStorage.setItem('autoClickerV4', this.checked.toString()); });
        function fadeOutAndStopSingle(audioObj, duration = 0) { const { audioElement, gainNode } = audioObj; if (!audioElement || !gainNode) return; const fadeTime = duration / 1000; if (fadeTime > 0 && audioContext.state === 'running') { try { gainNode.gain.cancelScheduledValues(audioContext.currentTime); gainNode.gain.setValueAtTime(gainNode.gain.value, audioContext.currentTime); gainNode.gain.linearRampToValueAtTime(0.0001, audioContext.currentTime + fadeTime); setTimeout(() => { if (!audioElement.paused) audioElement.pause(); audioElement.currentTime = 0; if (audioObj.buttonElement) audioObj.buttonElement.classList.remove('playing'); }, fadeTime * 1000 + 50); } catch (e) { if (!audioElement.paused) audioElement.pause(); audioElement.currentTime = 0; if (audioObj.buttonElement) audioObj.buttonElement.classList.remove('playing');} } else { if (!audioElement.paused) audioElement.pause(); audioElement.currentTime = 0; if (audioObj.buttonElement) audioObj.buttonElement.classList.remove('playing'); } }
        function stopAllActiveSounds(clearLoopState = true) { const fadeDuration = parseInt(fadeDurationInputV4.value) || 0; [...playingAudios].forEach(audioObj => fadeOutAndStopSingle(audioObj, fadeDuration)); playingAudios = []; if (clearLoopState && currentLoopingAudio) { if (currentLoopingAudio.audioElement) currentLoopingAudio.audioElement.loop = false; if (currentLoopingAudio.buttonElement) currentLoopingAudio.buttonElement.classList.remove('playing'); currentLoopingAudio = null; } if (clearLoopState) loopToggleBtnV4.textContent = "Loop: OFF"; document.querySelectorAll('.sound-button-v4.playing').forEach(btn => btn.classList.remove('playing')); if (currentSoundDisplayOverlay.classList.contains('active')) { currentSoundDisplayOverlay.classList.remove('active'); } }
        clearAllSoundsBtnV4.addEventListener('click', () => { stopAllActiveSounds(true); showStatus('All sounds stopped.', 'info'); });
        loopToggleBtnV4.addEventListener('click', () => { const isLooping = loopToggleBtnV4.textContent.includes("ON"); if (isLooping) { loopToggleBtnV4.textContent = "Loop: OFF"; if (currentLoopingAudio && currentLoopingAudio.audioElement) { currentLoopingAudio.audioElement.loop = false; } } else { loopToggleBtnV4.textContent = "Loop: ON"; } });
        closeOverlayBtnV4.addEventListener('click', () => currentSoundDisplayOverlay.classList.remove('active'));
        function playSound(soundDetails, buttonElement) { if (audioContext.state === 'suspended') audioContext.resume(); if (!allowMultipleSoundsToggleV4.checked) { stopAllActiveSounds(false); } const audioElement = new Audio(soundDetails.path); audioElement.playbackRate = currentPlaybackSpeed; audioElement.loop = loopToggleBtnV4.textContent.includes("ON"); if (audioElement.loop) { if (currentLoopingAudio && currentLoopingAudio.id !== soundDetails.id && currentLoopingAudio.audioElement) { currentLoopingAudio.audioElement.loop = false; if (currentLoopingAudio.audioElement && !currentLoopingAudio.audioElement.paused) { fadeOutAndStopSingle(currentLoopingAudio, parseInt(fadeDurationInputV4.value) || 0); } } } const sourceNode = audioContext.createMediaElementSource(audioElement); const gainNode = audioContext.createGain(); sourceNode.connect(gainNode); gainNode.connect(globalGainNode); const audioObj = { id: soundDetails.id, audioElement: audioElement, sourceNode: sourceNode, gainNode: gainNode, buttonElement: buttonElement, name: soundDetails.name }; if (audioElement.loop) { currentLoopingAudio = audioObj; } else if (currentLoopingAudio && currentLoopingAudio.id === audioObj.id) { currentLoopingAudio = null; } playingAudios.push(audioObj); const fadeDuration = parseInt(fadeDurationInputV4.value) || 0; gainNode.gain.setValueAtTime(fadeDuration > 0 ? 0.0001 : 1, audioContext.currentTime); if (fadeDuration > 0) { gainNode.gain.linearRampToValueAtTime(1, audioContext.currentTime + fadeDuration / 1000); } audioElement.play().catch(e => { console.error("Error playing sound:", soundDetails.path, e); showStatus(`ERROR PLAYING: ${soundDetails.name}`, 'error'); playingAudios = playingAudios.filter(obj => obj !== audioObj); if (buttonElement) buttonElement.classList.remove('playing'); }); if (buttonElement) { if (!allowMultipleSoundsToggleV4.checked) { document.querySelectorAll('.sound-button-v4.playing').forEach(btn => btn.classList.remove('playing')); } buttonElement.classList.add('playing'); } if (currentSoundDisplayToggleV4.checked) { overlaySoundNameV4.textContent = soundDetails.name; overlayProgressBarV4.style.width = '0%'; currentSoundDisplayOverlay.classList.add('active'); } audioElement.ontimeupdate = () => { if (currentSoundDisplayToggleV4.checked && currentSoundDisplayOverlay.classList.contains('active') && audioElement.duration) { if(overlaySoundNameV4.textContent === audioObj.name){ overlayProgressBarV4.style.width = `${(audioElement.currentTime / audioElement.duration) * 100}%`; } } }; audioElement.onended = () => { if (buttonElement && !audioElement.loop) buttonElement.classList.remove('playing'); playingAudios = playingAudios.filter(obj => obj !== audioObj); if (currentSoundDisplayOverlay.classList.contains('active') && overlaySoundNameV4.textContent === audioObj.name) { if (!playingAudios.some(ao => ao.audioElement && !ao.audioElement.paused && ao.buttonElement?.classList.contains('playing'))) { currentSoundDisplayOverlay.classList.remove('active'); } } if (currentLoopingAudio && currentLoopingAudio.id === audioObj.id && !audioElement.loop) { currentLoopingAudio = null; } }; }
        async function loadSoundsAndCreateButtons() { try { const response = await fetch('../SoundboardSN.json'); if (!response.ok) throw new Error(`HTTP error! S:${response.status}`); soundsDataGlobal = await response.json(); soundCategoriesContainerV4.innerHTML = ''; const categoryIcons = {"NormalSounds": "ðŸ˜Š", "ExplicitSounds": "ðŸ˜ˆ"}; for (const categoryKey in soundsDataGlobal) { if (soundsDataGlobal.hasOwnProperty(categoryKey) && Array.isArray(soundsDataGlobal[categoryKey])) { let categoryName = categoryKey.replace(/([A-Z])/g, ' $1').trim(); categoryName = categoryName.charAt(0).toUpperCase() + categoryName.slice(1); const icon = categoryIcons[categoryKey] || 'ðŸŽµ'; const categoryDiv = document.createElement('div'); categoryDiv.className = 'sound-category-v4'; categoryDiv.innerHTML = `<h2><span class="category-icon-v4">${icon}</span>${categoryName}</h2>`; const buttonsGrid = document.createElement('div'); buttonsGrid.className = 'sound-buttons-grid-v4'; const sortedFilenames = [...soundsDataGlobal[categoryKey]].sort(); sortedFilenames.forEach((filename, index) => { let displayName = filename.replace(/\.mp3$/i, '').replace(/_/g, ' '); const soundPath = `../Sounds/${filename}`; const button = document.createElement('button'); button.className = 'sound-button-v4'; button.textContent = displayName; button.dataset.soundName = displayName; const soundDetails = { id: `${categoryKey}-${filename}-${index}`, name: displayName, path: soundPath }; button.addEventListener('click', () => playSound(soundDetails, button)); button.addEventListener('mouseenter', () => { currentlyHoveredButton = button; if (autoClickerCheckboxV4.checked) startAutoClicker(); }); button.addEventListener('mouseleave', () => { if (currentlyHoveredButton === button) { currentlyHoveredButton = null; stopAutoClicker(); } }); buttonsGrid.appendChild(button); }); categoryDiv.appendChild(buttonsGrid); soundCategoriesContainerV4.appendChild(categoryDiv); } } if (Object.keys(soundsDataGlobal).length === 0) { showStatus('No sound categories found in JSON.', 'error'); } } catch (error) { console.error("Error loading SoundboardSN.json:", error); soundCategoriesContainerV4.innerHTML = `<p style="color:var(--v4-error-color);">Error loading sounds. Check console.</p>`; showStatus('ERROR LOADING SOUND LIST.', 'error'); } }
        function filterSounds(searchTerm) { document.querySelectorAll('.sound-category-v4').forEach(categoryDiv => { let categoryHasVisibleSounds = false; categoryDiv.querySelectorAll('.sound-button-v4').forEach(btn => { const soundName = btn.dataset.soundName.toLowerCase(); if (soundName.includes(searchTerm)) { btn.style.display = 'flex'; categoryHasVisibleSounds = true; } else { btn.style.display = 'none'; } }); categoryDiv.style.display = categoryHasVisibleSounds ? '' : 'none'; }); }
        soundSearchInputV4.addEventListener('input', (e) => filterSounds(e.target.value.toLowerCase()));
        function loadPreferences() { if (localStorage.getItem('allowMultipleSoundsV4') === 'false') allowMultipleSoundsToggleV4.checked = false; else allowMultipleSoundsToggleV4.checked = true; if (localStorage.getItem('currentSoundDisplayV4') === 'true') currentSoundDisplayToggleV4.checked = true; if (localStorage.getItem('autoClickerV4') === 'true') { autoClickerCheckboxV4.checked = true; autoClickDelayLabelV4.style.display = 'block'; } else { autoClickerCheckboxV4.checked = false; autoClickDelayLabelV4.style.display = 'none'; } const savedDelay = localStorage.getItem('autoClickDelayV4'); if (savedDelay !== null) autoClickDelayInputV4.value = savedDelay; else autoClickDelayInputV4.value = 200; const savedSpeed = localStorage.getItem('playbackSpeedV4'); if (savedSpeed !== null) { currentPlaybackSpeed = parseFloat(savedSpeed); playbackSpeedSelectV4.value = currentPlaybackSpeed.toString(); if (!playbackSpeedSelectV4.value) { const closestOption = Array.from(playbackSpeedSelectV4.options).find(opt => parseFloat(opt.value).toFixed(2) === currentPlaybackSpeed.toFixed(2)); if(closestOption) playbackSpeedSelectV4.value = closestOption.value; else playbackSpeedSelectV4.value = ""; } playbackSpeedSliderV4.value = currentPlaybackSpeed; playbackSpeedValueDisplayV4.textContent = `${currentPlaybackSpeed.toFixed(2)}x`; } else { currentPlaybackSpeed = 1.0; playbackSpeedSelectV4.value = "1"; playbackSpeedSliderV4.value = "1"; playbackSpeedValueDisplayV4.textContent = "1.0x"; } const savedVolume = localStorage.getItem('masterVolumeV4'); if (savedVolume !== null) { const volume = parseFloat(savedVolume); masterVolumeSliderV4.value = volume; masterVolumeValueDisplayV4.textContent = `${Math.round(volume * 100)}%`; globalGainNode.gain.value = volume; } loopToggleBtnV4.textContent = "Loop: OFF"; if(currentLoopingAudio && currentLoopingAudio.audioElement) currentLoopingAudio.audioElement.loop = false; currentLoopingAudio = null; const savedFade = localStorage.getItem('fadeDurationV4'); if (savedFade !== null) fadeDurationInputV4.value = savedFade; else fadeDurationInputV4.value = 100; }
        document.addEventListener('DOMContentLoaded', () => { loadPreferences(); loadSoundsAndCreateButtons(); });
    </script>
</body>
</html>
