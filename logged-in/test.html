<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Grade Checker - HAC & PowerSchool</title>
    
    <style>
        :root {
            --v4-bg-gradient: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
            --v4-card-bg: #fff;
            --v4-text-primary: #333;
            --v4-text-secondary: #555;
            --v4-purple-accent: #6720bd;
            --v4-blue-accent: #007bff;
            --v4-purple-gradient: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            --v4-blue-gradient: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            --v4-border-light: #ddd;
            --v4-border-softer: #eee;
            --v4-input-bg: #f8f9fa;
            --v4-input-border: #ccc;
            --v4-font-primary: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            --v4-font-secondary: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
        }
        .hidden { display: none !important; }
        body { display: flex; flex-direction: column; min-height: 100vh; margin: 0; font-family: var(--v4-font-primary); background: var(--v4-bg-gradient); color: var(--v4-text-primary); line-height: 1.6; }
        .container-wrapper { display: flex; flex: 1; overflow: hidden; }
        
        .sidebar { width: 220px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%); color: #fff; padding: 20px 10px; display: flex; flex-direction: column; border-right: 1px solid #444; transition: width 0.3s ease-in-out; position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .sidebar nav ul { list-style: none; padding: 0; margin: 20px 0 0; }
        .sidebar nav li { margin-bottom: 10px; }
        .sidebar nav a { display: flex; align-items: center; padding: 12px 15px; color: #fff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; font-family: var(--v4-font-primary); text-transform: uppercase; font-size: 0.9em; letter-spacing: 0.5px; }
        .sidebar nav a.active, .sidebar nav a:hover { transform: translateX(5px); }
        .sidebar[data-system="hac"] nav a.active, .sidebar[data-system="hac"] nav a:hover { background: var(--v4-purple-gradient); }
        .sidebar[data-system="powerschool"] nav a.active, .sidebar[data-system="powerschool"] nav a:hover { background: var(--v4-blue-gradient); }
        .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; margin-right: 10px; }
        .sidebar nav a .label { white-space: nowrap; }
        #logout-container { margin-top: auto; padding: 10px; }

        .main-content { flex: 1; padding: 30px; background: var(--v4-bg-gradient); overflow-y: auto; display: flex; flex-direction: column; }
        .page-header-v4 { margin-bottom: 25px; background: var(--v4-card-bg); padding: 20px 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center; }
        .page-title-v4 { font-size: 2.2em; font-weight: bold; -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .page-title-v4[data-system="hac"] { background-image: var(--v4-purple-gradient); }
        .page-title-v4[data-system="powerschool"] { background-image: var(--v4-blue-gradient); }
        #student-name-display { font-size: 1.2rem; font-weight: 500; color: var(--v4-text-secondary); }
        #top-right-actions { display: flex; align-items: center; gap: 15px; }

        .status-message-v4 { display: none; padding: 15px 25px; margin: 0 auto 20px auto; border-radius: 12px; text-align: center; max-width: 600px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1); color: white; }
        .status-message-v4.error { background: linear-gradient(135deg, #8f262a, #721c24); }
        .status-message-v4.info { background: linear-gradient(135deg, #004085, #002752); }
        
        #login-container { background: var(--v4-card-bg); padding: 35px; border-radius: 15px; box-shadow: 0 6px 30px rgba(0,0,0,0.08); margin: auto; max-width: 500px; width: 100%; }
        #loginForm .form-group { margin-bottom: 20px; }
        #loginForm label { font-weight: bold; color: var(--v4-text-secondary); margin-bottom: 8px; display: block; }
        #loginForm input, #loginForm select { width: 100%; padding: 14px; border: 1px solid var(--v4-input-border); border-radius: 8px; background: var(--v4-input-bg); font-family: var(--v4-font-secondary); font-size: 1.1em; box-sizing: border-box; transition: all 0.3s ease; }
        #loginForm input:focus, #loginForm select:focus { box-shadow: 0 0 0 3px rgba(103, 32, 189, 0.3); border-color: var(--v4-purple-accent); outline: none; }
        #loginForm button { width: 100%; }
        .form-group.sub-group { padding-left: 10px; border-left: 3px solid #eee; }

        #data-view { overflow-y: auto; padding: 5px; }
        .btn { border: none; padding: 14px 24px; border-radius: 10px; font-family: var(--v4-font-primary); text-transform: uppercase; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn-primary[data-system="hac"] { background: var(--v4-purple-gradient); color: white; }
        .btn-primary[data-system="powerschool"] { background: var(--v4-blue-gradient); color: white; }
        .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(103, 32, 189, 0.4); }
        .btn-primary[data-system="powerschool"]:hover { box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; transform: translateY(-3px); box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4); }

        .loader { text-align: center; padding: 50px; }
        .loader .spinner { border: 8px solid #f3f3f3; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 0 auto 20px auto; }
        .loader .spinner[data-system="hac"] { border-top-color: var(--v4-purple-accent); }
        .loader .spinner[data-system="powerschool"] { border-top-color: var(--v4-blue-accent); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loader p { font-size: 1.2em; color: var(--v4-text-secondary); }

        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .class-card { background: var(--v4-card-bg); border-radius: 10px; padding: 20px 25px; box-shadow: 0 6px 30px rgba(0,0,0,0.08); transition: all 0.2s ease-in-out; }
        .class-card[data-system="hac"] { border-left: 5px solid var(--v4-purple-accent); }
        .class-card[data-system="powerschool"] { border-left: 5px solid var(--v4-blue-accent); }
        .class-card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 15px; }
        .class-info { flex-grow: 1; min-width: 0; }
        .class-title { font-size: 1.4em; font-weight: bold; color: var(--v4-text-primary); }
        .class-teacher { font-size: 1em; color: var(--v4-text-secondary); }
        .class-grade-display { font-size: 2.5em; font-weight: bold; }
        .class-grade-display[data-system="hac"] { color: var(--v4-purple-accent); }
        .class-grade-display[data-system="powerschool"] { color: var(--v4-blue-accent); }

        .table-container { background: var(--v4-card-bg); border-radius: 15px; box-shadow: 0 6px 30px rgba(0,0,0,0.08); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid var(--v4-border-softer); }
        th { background-color: #f8f9fa; font-weight: bold; color: var(--v4-text-secondary); text-transform: uppercase; font-size: 0.9em; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #f1f3f5; }

        .rank-container { background: var(--v4-card-bg); border-radius: 15px; box-shadow: 0 6px 30px rgba(0,0,0,0.08); padding: 30px; display: flex; justify-content: space-around; text-align: center; }
        .rank-item { padding: 20px; }
        .rank-item .value { font-size: 3em; font-weight: bold; }
        .rank-item .value[data-system="hac"] { color: var(--v4-purple-accent); }
        .rank-item .value[data-system="powerschool"] { color: var(--v4-blue-accent); }
        .rank-item .label { font-size: 1.2em; color: var(--v4-text-secondary); margin-top: 5px; }
        
        .section-title { font-size: 1.8em; font-weight: bold; margin-bottom: 15px; padding-bottom: 10px; border-bottom-width: 2px; border-bottom-style: solid; }
        .section-title[data-system="hac"] { color: var(--v4-purple-accent); border-bottom-color: var(--v4-purple-accent); }
        .section-title[data-system="powerschool"] { color: var(--v4-blue-accent); border-bottom-color: var(--v4-blue-accent); }
    </style>
</head>
<body>

    <div class="container-wrapper">
        <aside class="sidebar" id="sidebar" data-system="hac">
            <h2 style="text-align: center; margin-bottom: 20px; color: #eee; font-weight: 300;">Grade Portal</h2>
            <nav id="main-nav" class="hidden"></nav>
            <div id="logout-container">
                 <button id="logoutBtn" class="btn btn-secondary hidden" style="width: 100%;">Log Out</button>
            </div>
        </aside>

        <main class="main-content">
            <div class="page-header-v4"> 
                <div>
                    <h2 class="page-title-v4" id="page-title" data-system="hac">Login</h2> 
                    <p id="student-name-display" class="hidden"></p>
                </div>
                <div id="top-right-actions">
                    <button id="refreshBtn" class="btn btn-primary hidden" data-system="hac">Refresh Data</button>
                </div>
            </div>
            <div class="status-message-v4" id="statusMessage"></div>

            <div id="login-container">
                <form id="loginForm">
                    <div class="form-group">
                        <label for="system-type">Portal Type</label>
                        <select id="system-type" required>
                            <option value="hac">Home Access Center (Live)</option>
                            <option value="powerschool">PowerSchool (Simulated)</option>
                        </select>
                    </div>
                    
                    <div id="hac-login-options">
                        <div class="form-group">
                            <label for="hac-login-mode">Login Mode</label>
                            <select id="hac-login-mode">
                                <option value="district">District Selection</option>
                                <option value="mobile">Mobile App Passcode</option>
                            </select>
                        </div>
                        <div id="hac-district-fields">
                            <div class="form-group sub-group">
                                <label for="state">State</label>
                                <select id="state" required></select>
                            </div>
                            <div class="form-group sub-group">
                                <label for="district">School District</label>
                                <select id="district" required></select>
                            </div>
                        </div>
                         <div id="hac-mobile-fields" class="hidden">
                            <div class="form-group sub-group">
                                <label for="mobile-passcode">District Passcode</label>
                                <input type="text" id="mobile-passcode" placeholder="e.g., NISD24">
                            </div>
                        </div>
                    </div>

                    <div id="powerschool-login-options" class="hidden">
                         <div class="form-group">
                            <label for="ps-state">State</label>
                            <select id="ps-state" required></select>
                        </div>
                        <div class="form-group">
                            <label for="ps-district">School District</label>
                            <select id="ps-district" required></select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" placeholder="Enter your username" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" id="loginBtn" class="btn btn-primary" data-system="hac">Log In</button>
                </form>
            </div>
            
            <div id="data-view" class="hidden"></div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        const DISTRICT_DATA = {
            hac: {
                "Ohio": {
                    "Canton City Schools": { url: "https://hac.ccs.sparcc.org/HomeAccess", code: "CCSOH" },
                    "Massillon City Schools": { url: "https://hac.massillonschools.org/HomeAccess", code: "MCSOH"},
                    "Jackson Local Schools": { url: "https://hac.jackson.sparcc.org/HomeAccess", code: "JLSOH" },
                    "Madison Local Schools (Richland)": { url: "https://hac.mlsd.net/HomeAccess", code: "MLSDOH" },
                    "North Canton City Schools": { url: "https://hac.northcanton.sparcc.org/HomeAccess", code: "NCCSOH" },
                    "Perry Local Schools (Stark)": { url: "https://hac.perry.sparcc.org/HomeAccess", code: "PLSSH" }
                },
                "Texas": {
                    "Northside ISD": { url: "https://hac.nisd.net/HomeAccess", code: "NISD24" }
                 }
            },
            powerschool: {
                "Ohio": {
                    "Minerva Local Schools": { url: "https://minerva.sparcc.org/public/", code: "MLPS" }
                }
            }
        };

        // This maps a mobile code to its district URL for HAC
        const HAC_MOBILE_CODES = {};
        Object.values(DISTRICT_DATA.hac).forEach(state => {
            Object.values(state).forEach(district => {
                if (district.code) HAC_MOBILE_CODES[district.code.toUpperCase()] = district.url;
            });
        });

        const API_HANDLER = {
            hac: {
                fetch: async (endpoint, credentials, forceRefresh) => {
                    const { username, password, base } = credentials;
                    const apiUrl = `https://homeaccesscenterapi.vercel.app/api?username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&base=${encodeURIComponent(base)}&endpoint=${endpoint}`;
                    try {
                        const response = await fetch(apiUrl);
                        if (!response.ok) throw new Error((await response.json()).message || `API error ${response.status}`);
                        return { success: true, data: await response.json() };
                    } catch (error) { return { success: false, message: error.message }; }
                }
            },
            powerschool: {
                fetch: async (endpoint, credentials, forceRefresh) => {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    const { username, password } = credentials;
                    if (!username || !password) return { success: false, message: "Invalid credentials" };
                    const studentName = "Alex Lion (Simulated)";
                    
                    if (endpoint === 'grades') return { success: true, data: { courses: [ { id: 1, name: "AP English Lit", grade: 94, teacher: "Mr. Joyce" }, { id: 2, name: "Calculus BC", grade: 88, teacher: "Mrs. Newton" }, { id: 3, name: "Physics C", grade: 91, teacher: "Dr. Einstein" }, { id: 4, name: "US Government", grade: 96, teacher: "Ms. Madison" }, ], studentName }};
                    if (endpoint === 'assignments') return { success: true, data: { courses: [ { name: "AP English Lit", assignments: [{ name: "Frankenstein Essay", score: "95/100" }, { name: "Poetry Analysis", score: "A" }] }, { name: "Calculus BC", assignments: [{ name: "Unit 6 Test", score: "85/100" }, { name: "Related Rates HW", score: "10/10" }] } ], studentName }};
                    if (endpoint === 'attendance') return { success: true, data: { summary: { total: 3, excused: 2, unexcused: 1 }, details: [{ date: "2025-09-15", reason: "Doctor Appointment" }, { date: "2025-09-16", reason: "Illness" }], studentName }};
                    return { success: false, message: "Endpoint not found" };
                }
            }
        };

        const UI_ELEMENTS = {
            sidebar: document.getElementById('sidebar'),
            loginContainer: document.getElementById('login-container'),
            loginForm: document.getElementById('loginForm'),
            loginBtn: document.getElementById('loginBtn'),
            logoutBtn: document.getElementById('logoutBtn'),
            refreshBtn: document.getElementById('refreshBtn'),
            dataView: document.getElementById('data-view'),
            systemTypeSelect: document.getElementById('system-type'),
            hacLoginOptions: document.getElementById('hac-login-options'),
            hacLoginMode: document.getElementById('hac-login-mode'),
            hacDistrictFields: document.getElementById('hac-district-fields'),
            hacMobileFields: document.getElementById('hac-mobile-fields'),
            mobilePasscodeInput: document.getElementById('mobile-passcode'),
            powerschoolLoginOptions: document.getElementById('powerschool-login-options'),
            stateSelect: document.getElementById('state'),
            districtSelect: document.getElementById('district'),
            psStateSelect: document.getElementById('ps-state'),
            psDistrictSelect: document.getElementById('ps-district'),
            mainNav: document.getElementById('main-nav'),
            pageTitle: document.getElementById('page-title'),
            studentNameDisplay: document.getElementById('student-name-display'),
            statusMessage: document.getElementById('statusMessage'),
        };

        const appState = { system: 'hac', credentials: null, cache: {}, currentView: '' };

        const NAV_MENUS = {
            hac: `<ul><li><a href="#" class="nav-link active" data-endpoint="averages"><span class="icon">üìä</span><span class="label">Averages</span></a></li><li><a href="#" class="nav-link" data-endpoint="reportcard"><span class="icon">üìÑ</span><span class="label">Report Card</span></a></li><li><a href="#" class="nav-link" data-endpoint="ipr"><span class="icon">üìà</span><span class="label">IPR</span></a></li><li><a href="#" class="nav-link" data-endpoint="rank"><span class="icon">üèÜ</span><span class="label">Class Rank</span></a></li><li><a href="#" class="nav-link" data-endpoint="transcript"><span class="icon">üìú</span><span class="label">Transcript</span></a></li></ul>`,
            powerschool: `<ul><li><a href="#" class="nav-link active" data-endpoint="grades"><span class="icon">üìä</span><span class="label">Grades</span></a></li><li><a href="#" class="nav-link" data-endpoint="assignments"><span class="icon">üìÑ</span><span class="label">Assignments</span></a></li><li><a href="#" class="nav-link" data-endpoint="attendance"><span class="icon">üìà</span><span class="label">Attendance</span></a></li></ul>`
        };

        const RENDERERS = {
            loader: (system) => `<div class="loader"><div class="spinner" data-system="${system}"></div><p>Fetching data...</p></div>`,
            error: (message) => `<div class="status-message-v4 error" style="display: block; margin-top: 20px;"><strong>Error:</strong> ${message}</div>`,
            hac: { /* Omitted for brevity */ },
            powerschool: { /* Omitted for brevity */ }
        };
        RENDERERS.hac.averages = (data) => `<div class="card-grid">${data.map(c => `<div class="class-card" data-system="hac"><div class="class-card-header"><div class="class-info"><div class="class-title">${c.className}</div><div class="class-teacher">${c.teacherName}</div></div><div class="class-grade-display" data-system="hac">${c.average||'N/A'}</div></div></div>`).join('')}</div>`;
        RENDERERS.hac.reportcard = (data) => `<div class="table-container"><table><thead><tr><th>Course</th><th>Period</th><th>Teacher</th>${Object.keys(data.courses[0].grades).map(k=>`<th>${k}</th>`).join('')}</tr></thead><tbody>${data.courses.map(c=>`<tr><td>${c.course}</td><td>${c.period}</td><td>${c.teacher}</td>${Object.values(c.grades).map(g=>`<td>${g||'-'}</td>`).join('')}</tr>`).join('')}</tbody></table></div>`;
        RENDERERS.hac.ipr = (data) => `<div class="table-container"><table><thead><tr><th>Course</th><th>Period</th><th>Teacher</th><th>Grade</th><th>Absences</th></tr></thead><tbody>${data.courses.map(c=>`<tr><td>${c.course}</td><td>${c.period}</td><td>${c.teacher}</td><td>${c.grade}</td><td>${c.absences}</td></tr>`).join('')}</tbody></table></div>`;
        RENDERERS.hac.rank = (data) => `<div class="rank-container">${Object.entries(data).map(([k,v])=>`<div class="rank-item"><div class="value" data-system="hac">${v}</div><div class="label" style="text-transform: capitalize;">${k.replace(/([A-Z])/g, ' $1').trim()}</div></div>`).join('')}</div>`;
        RENDERERS.hac.transcript = (data) => data.years.map(y=>`<div class="transcript-year"><h3 class="section-title" data-system="hac">${y.year}</h3>${y.semesters.map(s=>`<div style="margin-bottom:20px;"><h4 style="font-size: 1.3em;">${s.semester}</h4><div class="table-container"><table><thead><tr><th>Course</th><th>Credit</th><th>Grade</th></tr></thead><tbody>${s.courses.map(c=>`<tr><td>${c.course}</td><td>${c.credit}</td><td>${c.grade}</td></tr>`).join('')}</tbody></table></div></div>`).join('')}</div>`).join('');
        RENDERERS.powerschool.grades = (data) => `<div class="card-grid">${data.courses.map(c => `<div class="class-card" data-system="powerschool"><div class="class-card-header"><div class="class-info"><div class="class-title">${c.name}</div><div class="class-teacher">${c.teacher}</div></div><div class="class-grade-display" data-system="powerschool">${c.grade||'N/A'}</div></div></div>`).join('')}</div>`;
        RENDERERS.powerschool.assignments = (data) => data.courses.map(c => `<div class="table-container" style="margin-bottom: 20px;"><h3 class="section-title" data-system="powerschool" style="padding:15px; margin:0; border:0;">${c.name}</h3><table><thead><tr><th>Assignment</th><th>Score</th></tr></thead><tbody>${c.assignments.map(a => `<tr><td>${a.name}</td><td>${a.score}</td></tr>`).join('')}</tbody></table></div>`).join('');
        RENDERERS.powerschool.attendance = (data) => `<div class="rank-container">${Object.entries(data.summary).map(([key, value]) => `<div class="rank-item"><div class="value" data-system="powerschool">${value}</div><div class="label" style="text-transform: capitalize;">${key}</div></div>`).join('')}</div><h3 class="section-title" data-system="powerschool" style="margin-top:30px;">Details</h3><div class="table-container">${data.details.length > 0 ? `<table><thead><tr><th>Date</th><th>Reason</th></tr></thead><tbody>${data.details.map(d => `<tr><td>${d.date}</td><td>${d.reason}</td></tr>`).join('')}</tbody></table>` : `<p style="padding: 20px; text-align: center;">No attendance events recorded.</p>`}</div>`;

        async function fetchData(endpoint, forceRefresh = false) {
            if (appState.cache[endpoint] && !forceRefresh) return { success: true, data: appState.cache[endpoint] };
            const result = await API_HANDLER[appState.system].fetch(endpoint, appState.credentials, forceRefresh);
            if (result.success) appState.cache[endpoint] = result.data;
            return result;
        }
        
        function updateUIForSystem(system) {
            appState.system = system;
            document.querySelectorAll('[data-system]').forEach(el => el.dataset.system = system);
            UI_ELEMENTS.hacLoginOptions.classList.toggle('hidden', system !== 'hac');
            UI_ELEMENTS.powerschoolLoginOptions.classList.toggle('hidden', system !== 'powerschool');
            
            populateStates(DISTRICT_DATA.hac, UI_ELEMENTS.stateSelect, UI_ELEMENTS.districtSelect);
            populateStates(DISTRICT_DATA.powerschool, UI_ELEMENTS.psStateSelect, UI_ELEMENTS.psDistrictSelect);
        }

        async function renderViewContent(endpoint, forceRefresh = false) {
            UI_ELEMENTS.dataView.innerHTML = RENDERERS.loader(appState.system);
            const result = await fetchData(endpoint, forceRefresh);
            if (result.success) {
                const nameKey = appState.system === 'hac' ? 'name' : 'grades';
                const nameData = appState.cache[nameKey] || (await fetchData(nameKey))?.data;
                if (nameData && nameData.studentName) {
                    UI_ELEMENTS.studentNameDisplay.textContent = `Student: ${nameData.studentName}`;
                    UI_ELEMENTS.studentNameDisplay.classList.remove('hidden');
                }
                const renderer = RENDERERS[appState.system][endpoint];
                UI_ELEMENTS.dataView.innerHTML = renderer ? renderer(result.data) : RENDERERS.error(`No renderer for: ${endpoint}`);
            } else {
                UI_ELEMENTS.dataView.innerHTML = RENDERERS.error(result.message);
            }
        }

        function showView(viewName) {
            UI_ELEMENTS.loginContainer.classList.add('hidden');
            UI_ELEMENTS.mainNav.classList.remove('hidden');
            UI_ELEMENTS.logoutBtn.classList.remove('hidden');
            UI_ELEMENTS.refreshBtn.classList.remove('hidden');
            UI_ELEMENTS.dataView.classList.remove('hidden');

            UI_ELEMENTS.mainNav.innerHTML = NAV_MENUS[appState.system];
            appState.currentView = viewName;
            document.querySelectorAll('.nav-link').forEach(l => l.classList.toggle('active', l.dataset.endpoint === viewName));
            const activeLink = document.querySelector('.nav-link.active');
            UI_ELEMENTS.pageTitle.textContent = activeLink ? activeLink.querySelector('.label').textContent : 'Dashboard';
            addNavListeners();
            renderViewContent(viewName);
        }
        
        function handleLogin(e) {
            e.preventDefault();
            const credentials = {
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
            };

            if (appState.system === 'hac') {
                const mode = UI_ELEMENTS.hacLoginMode.value;
                if (mode === 'district') {
                    credentials.base = UI_ELEMENTS.districtSelect.value;
                } else { // mobile mode
                    const code = UI_ELEMENTS.mobilePasscodeInput.value.toUpperCase();
                    credentials.base = HAC_MOBILE_CODES[code];
                     if (!credentials.base) {
                        showStatus('Invalid Mobile App Passcode.', 'error');
                        return;
                    }
                }
            } else {
                credentials.base = UI_ELEMENTS.psDistrictSelect.value;
            }

            if (!credentials.base) {
                showStatus('Please select a school district.', 'error');
                return;
            }

            appState.credentials = credentials;
            sessionStorage.setItem('grade_portal_creds', JSON.stringify({ ...credentials, system: appState.system }));
            UI_ELEMENTS.loginBtn.disabled = true;
            UI_ELEMENTS.loginBtn.textContent = 'Logging In...';
            showStatus('Authenticating...', 'info');
            
            const initialView = appState.system === 'hac' ? 'averages' : 'grades';
            renderViewContent(initialView).then(() => {
                UI_ELEMENTS.loginBtn.disabled = false;
                UI_ELEMENTS.loginBtn.textContent = 'Log In';
                if (UI_ELEMENTS.dataView.innerHTML.includes('Error')) {
                    hideStatus();
                    showStatus('Login failed. Please check credentials.', 'error');
                } else {
                    hideStatus();
                    showView(initialView);
                }
            });
        }

        function handleLogout() {
            appState.credentials = null; appState.cache = {};
            sessionStorage.removeItem('grade_portal_creds');
            UI_ELEMENTS.dataView.classList.add('hidden');
            UI_ELEMENTS.mainNav.classList.add('hidden');
            UI_ELEMENTS.logoutBtn.classList.add('hidden');
            UI_ELEMENTS.refreshBtn.classList.add('hidden');
            UI_ELEMENTS.studentNameDisplay.classList.add('hidden');
            UI_ELEMENTS.loginContainer.classList.remove('hidden');
            UI_ELEMENTS.pageTitle.textContent = 'Login';
        }
        
        function showStatus(message, type = 'info') { UI_ELEMENTS.statusMessage.textContent = message; UI_ELEMENTS.statusMessage.className = `status-message-v4 ${type}`; UI_ELEMENTS.statusMessage.style.display = 'block'; }
        function hideStatus() { UI_ELEMENTS.statusMessage.style.display = 'none'; }
        
        function populateStates(districtsByState, stateSelect, districtSelect) {
            stateSelect.innerHTML = '<option value="" disabled selected>Select a state...</option>';
            Object.keys(districtsByState).sort().forEach(state => {
                stateSelect.appendChild(new Option(state, state));
            });
            populateDistricts(districtsByState, '', districtSelect);
        }

        function populateDistricts(districtsByState, state, districtSelect) {
            districtSelect.innerHTML = '<option value="" disabled selected>Select a district...</option>';
            const districts = districtsByState[state] || {};
            Object.keys(districts).sort().forEach(name => {
                districtSelect.appendChild(new Option(name, districts[name].url));
            });
        }
        
        function addNavListeners() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    showView(link.dataset.endpoint);
                });
            });
        }

        function init() {
            updateUIForSystem('hac');
            const savedCreds = sessionStorage.getItem('grade_portal_creds');
            if (savedCreds) {
                const { system, ...credentials } = JSON.parse(savedCreds);
                appState.credentials = credentials;
                updateUIForSystem(system);
                showView(system === 'hac' ? 'averages' : 'grades');
            }

            UI_ELEMENTS.systemTypeSelect.addEventListener('change', (e) => updateUIForSystem(e.target.value));
            UI_ELEMENTS.hacLoginMode.addEventListener('change', (e) => {
                const isDistrict = e.target.value === 'district';
                UI_ELEMENTS.hacDistrictFields.classList.toggle('hidden', !isDistrict);
                UI_ELEMENTS.hacMobileFields.classList.toggle('hidden', isDistrict);
            });
            
            UI_ELEMENTS.stateSelect.addEventListener('change', (e) => populateDistricts(DISTRICT_DATA.hac, e.target.value, UI_ELEMENTS.districtSelect));
            UI_ELEMENTS.psStateSelect.addEventListener('change', (e) => populateDistricts(DISTRICT_DATA.powerschool, e.target.value, UI_ELEMENTS.psDistrictSelect));

            UI_ELEMENTS.loginForm.addEventListener('submit', handleLogin);
            UI_ELEMENTS.logoutBtn.addEventListener('click', handleLogout);
            UI_ELEMENTS.refreshBtn.addEventListener('click', () => renderViewContent(appState.currentView, true));
        }

        init();
    });
    </script>
</body>
</html>

