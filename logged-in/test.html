<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
Â  <title>4SP - DASHBOARD</title>
Â  <link rel="stylesheet" href="../css/style.css" />
Â  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
Â  <script src="../panic-key.js"></script>
Â  <script src="../ban-enforcer.js"></script>
Â  <script src="../url-changer.js"></script>

Â  <style>
Â  Â  /* --- Dashboard Layout --- */
Â  Â  body.dashboard-page { display: flex; flex-direction: column; min-height: 100vh; margin: 0; font-family: 'PrimaryFont', sans-serif; }
Â  Â  .dashboard-container { display: flex; flex: 1; }

Â  Â  /* --- Sidebar --- */
Â  Â  .sidebar { width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%); color: #fff; padding: 20px 10px; display: flex; flex-direction: column; border-right: 1px solid #444; transition: width 0.5s ease-in-out; position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
Â  Â  .sidebar.collapsed { width: 85px; }
Â  Â  #toggleSidebar { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: none; border: none; color: #fff; font-size: 1.2em; cursor: pointer; padding: 4px; transition: transform 0.5s ease-in-out; }
Â  Â  .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
Â  Â  .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
Â  Â  .sidebar nav li { margin-bottom: 10px; }
Â  Â  .sidebar nav a { display: flex; align-items: center; padding: 12px 15px; color: #fff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; font-family: 'PrimaryFont', sans-serif; text-transform: uppercase; }
Â  Â  .sidebar nav a.active, .sidebar nav a:hover { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); transform: translateX(5px); }
Â  Â  .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
Â  Â  .sidebar nav a .label { margin-left: 10px; white-space: nowrap; opacity: 1; visibility: visible; transition: opacity 0.2s ease-in-out; transition-delay: 0.4s; }
Â  Â  .sidebar.collapsed nav a .label { opacity: 0; visibility: hidden; transition-delay: 0s; }

Â  Â  /* --- Main Content & Controls --- */
Â  Â  .main-content { flex: 1; padding: 40px; background: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%); overflow-y: auto; position: relative; }
Â  Â  .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; background: white; padding: 20px 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid rgba(103, 32, 189, 0.1); position: relative; }
Â  Â  .dashboard-title { margin: 0; font-size: 2.2em; font-weight: bold; background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
Â  Â  .dashboard-title-wrapper { display: flex; align-items: center; gap: 20px; flex-grow: 1; }
Â  Â  .battery-status-container { display: none; flex-direction: column; font-size: 0.75em; font-weight: 500; color: #5f6368; background-color: rgba(0, 0, 0, 0.03); border: 1px solid rgba(0, 0, 0, 0.08); border-radius: 8px; padding: 4px 8px; line-height: 1.3; }
Â  Â  .battery-status-container.charging { color: #2e7d32; border-color: rgba(46, 125, 50, 0.4); }
Â  Â  #battery-level.low { color: #f5c518; } #battery-level.critical { color: #e53935; } #battery-level.very-critical { color: #b71c1c; }
Â  Â Â 
Â  Â  /* --- Dashboard Grid & Cards --- */
Â  Â  .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 20px; position: relative; }
Â  Â  @media (min-width: 768px) { .dashboard-grid { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); } }
Â  Â  @media (min-width: 1200px) { .dashboard-grid { grid-template-columns: repeat(6, 1fr); } }
Â  Â  .dashboard-card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 6px 30px rgba(0,0,0,0.08); border: 1px solid rgba(103, 32, 189, 0.1); position: relative; user-select: none; z-index: 2; display: flex; flex-direction: column; overflow: hidden; transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease; min-height: 200px; grid-column: span 1; }
Â  Â  @media (min-width: 1200px) { .dashboard-card[data-card-type="medium"] { grid-column: span 3; } .dashboard-card[data-card-type="small"] { grid-column: span 2; } .dashboard-card[data-card-type="full"] { grid-column: span 6; } }
Â  Â  .dashboard-card:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 15px 40px rgba(103, 32, 189, 0.15); border-color: rgba(103, 32, 189, 0.3); }
Â  Â  .card-header { display: flex; align-items: center; margin-bottom: 15px; padding-bottom: 12px; border-bottom: 1px solid rgba(103, 32, 189, 0.1); justify-content: flex-start; flex-shrink: 0; position: relative; }
Â  Â  .card-icon { font-size: 2em; margin-right: 12px; background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 2px 4px rgba(103, 32, 189, 0.2)); }
Â  Â  .card-title { font-size: 1.3em; font-weight: bold; margin: 0; color: #333; flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
Â  Â  .card-header-buttons { position: relative; margin-left: auto; display: flex; gap: 6px; align-items: center; }
Â  Â  .weather-action-btn { background: rgba(103, 32, 189, 0.08); border: none; cursor: pointer; padding: 8px; line-height: 1; display: inline-flex; align-items: center; justify-content: center; border-radius: 12px; z-index: 5; transition: all 0.2s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
Â  Â  .weather-action-btn img { width: 22px; height: 22px; display: block; filter: invert(0.3) brightness(100%); }
Â  Â  .weather-action-btn:hover { background-color: rgba(103, 32, 189, 0.15); transform: translateY(-2px); }
Â  Â  .weather-action-btn:disabled { cursor: not-allowed; opacity: 0.6; transform: translateY(0); }
Â  Â  @keyframes spin-clockwise { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
Â  Â  .weather-refresh-btn.refreshing img { animation: spin-clockwise 0.8s linear infinite; }
Â  Â  .card-content-inner { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
Â  Â Â 
Â  Â  /* --- Super Widget Specific Styles --- */
Â  Â  .super-widget-container { display: flex; flex-wrap: wrap; gap: 20px; height: 100%; flex-grow: 1; }
Â  Â  .super-widget-clock-section { flex: 1 1 300px; display: flex; flex-direction: column; justify-content: center; }
Â  Â  .super-widget-weather-section { flex: 2 1 400px; display: flex; flex-direction: column; justify-content: center; border-left: 1px solid rgba(103, 32, 189, 0.1); padding-left: 20px; }
Â  Â  @media (max-width: 900px) { .super-widget-weather-section { border-left: none; padding-left: 0; border-top: 1px solid rgba(103, 32, 189, 0.1); padding-top: 20px; } }
Â  Â  .weather-large-content { display: flex; flex-direction: column; height: 100%; justify-content: flex-start; }
Â  Â  .current-weather-layout { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid rgba(103, 32, 189, 0.08); width: 100%; box-sizing: border-box; }
Â  Â  .weather-icon-large { font-size: 3.2em; color: #6720bd; flex-shrink: 0; }
Â  Â  .current-weather-main-info { display: flex; flex-direction: column; align-items: flex-start; flex-grow: 1; }
Â  Â  .temp-large { font-size: 2.3em; font-weight: bold; color: #333; line-height: 1.1; }
Â  Â  .condition-large { font-size: 0.95em; color: #555; }
Â  Â  .current-weather-details-aside { display: flex; flex-direction: column; align-items: flex-end; font-size: 0.75em; color: #777; line-height: 1.4; flex-shrink: 0; padding-left: 12px; border-left: 1px solid rgba(103, 32, 189, 0.1); text-align: right; }
Â  Â  .current-weather-details-aside p { margin: 0; }
Â  Â  .forecast-large { display: flex; flex-wrap: wrap; justify-content: center; gap: 4px; padding: 6px 0px; margin-bottom: 8px; }
Â  Â  .forecast-day { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 8px 4px; background-color: #ffffff; border-radius: 12px; min-width: 70px; text-align: center; border: 1.25px solid rgba(103, 32, 189, 0.2); cursor: pointer; transition: all 0.2s ease; height: 82.5px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
Â  Â  .forecast-day:hover { background-color: rgba(103, 32, 189, 0.1); transform: translateY(-3px); box-shadow: 0 5px 15px rgba(103, 32, 189, 0.1); }
Â  Â  .forecast-day .day-name { font-size: 0.75em; font-weight: 600; color: #555; }
Â  Â  .forecast-day .icon { font-size: 1.6em; color: #6720bd; line-height:1; }
Â  Â  .forecast-day .temps { font-size: 0.8em; color: #333; }
Â  Â  .clock-display { font-size: 3.5em; font-weight: bold; color: #333; text-align: left; margin-bottom: 5px; }
Â  Â  .date-display { font-size: 1.5em; color: #666; text-align: left; }
Â  Â  .additional-time-info { font-size: 1em; color: #777; text-align: left; margin-top: 10px; line-height: 1.3; }
Â  Â  .additional-time-info span { display: inline-block; padding: 0 5px; }
Â  Â  .additional-time-info span:first-child { padding-left: 0; }
Â  Â  .dashboard-countdown-section { margin-top: 15px; border-top: 1px solid rgba(103, 32, 189, 0.1); padding-top: 15px; }
Â  Â  .dashboard-countdown-display-name { font-size: 1em; font-weight: 600; color: #444; margin: 0 0 5px 0; text-align: left; }
Â  Â  .dashboard-countdown-display-timer { font-size: 1.5em; font-weight: bold; color: #6720bd; text-align: left; min-height: 1.5em; }
Â  Â  .dashboard-countdown-display-timer .time-unit { display: inline-block; margin: 0 4px; text-align: center; }
Â  Â  .dashboard-countdown-display-timer .time-label { display: block; font-size: 0.5em; color: #888; font-weight: normal; }

Â  Â  /* Other Widgets */
Â  Â  .stopwatch-display, .timer-display-value{font-size: 2.2em;font-weight: bold;color: #6720bd;text-align: center;margin-bottom: 15px;letter-spacing: 1px;font-family: 'PrimaryFont', sans-serif}.timer-inputs{display: flex;justify-content: center;gap: 5px;margin-bottom: 15px}.timer-inputs.hidden{display: none}.timer-inputs input{width: 40px;padding: 8px;text-align: center;border: 1px solid #ccc;border-radius: 5px;font-size: 1em;font-family: 'PrimaryFont', sans-serif}.controls-flex{display: flex;justify-content: center;gap: 10px;flex-wrap: wrap}.controls-flex button{background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);color: white;border: none;padding: 10px 15px;border-radius: 8px;cursor: pointer;font-family: 'PrimaryFont', sans-serif;font-weight: 600;transition: all .2s ease}.controls-flex button:hover{transform: translateY(-2px);box-shadow: 0 4px 10px rgba(103, 32, 189, .3)}.controls-flex button[data-action=pause]{background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%)}.controls-flex button[data-action=reset]{background: linear-gradient(135deg, #6c757d 0%, #495057 100%)}.quick-actions-list{display: flex;flex-direction: column;gap: 10px}.quick-actions-list button{display: flex;align-items: center;width: 100%;padding: 12px 15px;background-color: #f8f9fa;border: 1px solid #e9ecef;border-radius: 12px;text-align: left;font-family: 'PrimaryFont', sans-serif;font-size: 1.1em;text-transform: uppercase;color: #495057;cursor: pointer;transition: all .2s ease;height: 42.5px}.quick-actions-list button:hover{background-color: #e9ecef;border-color: #dee2e6;transform: translateY(-1px);box-shadow: 0 2px 5px rgba(0,0,0,.05)}.quick-actions-list button .icon{font-size: 1.5em;margin-right: 12px;color: #6720bd}.quick-actions-list button .text{flex-grow: 1;font-weight: 500}.quick-actions-list button .arrow{font-size: 1.2em;color: #adb5bd}
Â  Â Â 
Â  Â  /* --- Modals (General & Specific) --- */
Â  Â  .modal { display: flex; align-items: center; justify-content: center; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); visibility: hidden; opacity: 0; transition: opacity 0.25s ease-out, visibility 0s linear 0.25s; }
Â  Â  .modal.modal-open { visibility: visible; opacity: 1; transition: opacity 0.25s ease-out, visibility 0s linear 0s; }
Â  Â  .modal-content { background-color: #fefefe; padding: 30px; border: 1px solid #bbb; width: 90%; max-width: 500px; border-radius: 18px; box-shadow: 0 8px 30px rgba(0,0,0,0.25); position: relative; color: #333; transform: scale(0.9); transition: transform 0.3s ease-out; display: flex; flex-direction: column; gap: 15px; }
Â  Â  .modal.modal-open .modal-content { transform: scale(1); }
Â  Â  .modal-close-btn { color: #aaa; position: absolute; top: 15px; right: 18px; font-size: 30px; font-weight: 300; background: none; border: none; cursor: pointer; line-height: 1; transition: color 0.2s ease; }
Â  Â  .modal-close-btn:hover { color: #6720bd; }
Â  Â  #forecastDetailModal .modal-header-section { text-align: center; border-bottom: 1px solid rgba(103, 32, 189, 0.1); padding-bottom: 15px; margin-bottom: 15px; }
Â  Â  #forecastDetailModal h3 { margin: 0 0 8px; color: #6720bd; font-size: 1.8em; } #forecastDetailModal .date-subtitle { font-size: 1.1em; color: #555; margin: 0; }
Â  Â  #forecastDetailModal .modal-current-weather-summary { display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 20px; }
Â  Â  #forecastDetailModal .modal-icon-large { font-size: 4em; color: #6720bd; } #forecastDetailModal .modal-temp-display { font-size: 2.8em; font-weight: bold; }
Â  Â  #forecastDetailModal #modalWeatherDesc { font-size: 1.2em; color: #666; }
Â  Â  #forecastDetailModal .modal-details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px 20px; }
Â  Â  #forecastDetailModal .modal-details-grid p { font-size: .9em; line-height: 1.5; margin: 0; display: flex; align-items: center; gap: 8px; color: #444; }
Â  Â  #forecastDetailModal .modal-details-grid p strong { font-weight: 600; display: flex; align-items: center; gap: 5px; }
Â  Â  #forecastDetailModal .modal-details-grid .detail-icon { font-size: 1.1em; color: #8a2be2; }
Â  Â  #forecastDetailModal .modal-advice-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(103, 32, 189, .15); }
Â  Â  #forecastDetailModal .modal-advice-section h4 { margin: 0 0 10px; font-size: 1.1em; font-weight: 600; display: flex; align-items: center; gap: 8px; }
Â  Â  #forecastDetailModal .modal-advice-section ul { list-style-type: "âœ“Â  "; margin: 0 0 0 20px; padding: 0; font-size: .95em; line-height: 1.6; color: #555; }
Â  Â  #forecastDetailModal .modal-advice-section li { margin-bottom: 5px; }

Â  Â  /* === UPDATED: Overview Settings Modal Styles === */
Â  Â  .overview-settings-modal .modal-content { max-width: 700px; padding: 0; gap: 0; font-family: 'PrimaryFont', sans-serif; }
Â  Â  .overview-settings-modal .modal-content button,
Â  Â  .overview-settings-modal .modal-content input,
Â  Â  .overview-settings-modal .modal-content select,
Â  Â  .overview-settings-modal .modal-content label { font-family: 'PrimaryFont', sans-serif; }
Â  Â  .overview-settings-modal .modal-header { padding: 20px 30px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
Â  Â  .overview-settings-modal .modal-header h3 { margin: 0; font-size: 1.6em; color: #6720bd; font-weight: bold; }
Â  Â  .settings-tabs { display: flex; background-color: #f8f9fa; padding: 5px; border-radius: 12px; margin: 20px 30px; gap: 5px; }
Â  Â  .tab-button { flex: 1; padding: 10px; background: none; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1em; color: #555; transition: all 0.2s ease; }
Â  Â  .tab-button.active { background: #fff; color: #6720bd; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
Â  Â Â 
Â  Â  /* Sliding Tab Animation Styles */
Â  Â  .tab-panels-wrapper { position: relative; overflow: hidden; min-height: 380px; /* Prevents height jump */ }
Â  Â  .tab-panels-container { display: flex; transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); }
Â  Â  .tab-panel { flex-shrink: 0; width: 100%; box-sizing: border-box; display: block !important; padding: 0 30px 30px; }
Â  Â Â 
Â  Â  .settings-section { display: flex; flex-direction: column; gap: 12px; margin-bottom: 25px; } .settings-section:last-child { margin-bottom: 0; }
Â  Â  .settings-section label { font-weight: 600; color: #555; font-size: 1.1em; }
Â  Â  .location-input-wrapper { position: relative; }
Â  Â  #overviewLocationInput { width: 100%; padding: 12px 15px; font-size: 1em; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
Â  Â  #overviewLocationInput:focus { outline: none; border-color: #8a2be2; box-shadow: 0 0 0 3px rgba(103, 32, 189, 0.2); }
Â  Â  #overviewLocationSuggestions { list-style: none; padding: 0; margin: 5px 0 0 0; position: absolute; background: white; width: 100%; border: 1px solid #ddd; border-radius: 8px; max-height: 150px; overflow-y: auto; z-index: 10001; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
Â  Â  #overviewLocationSuggestions li { padding: 10px 15px; cursor: pointer; transition: background-color 0.2s; border-bottom: 1px solid #eee; } #overviewLocationSuggestions li:hover { background-color: #f0f2f5; }
Â  Â  #overviewUseCurrentLocationBtn { padding: 10px 15px; font-size: 0.95em; font-weight: 600; background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; }
Â  Â  .unit-toggle-wrapper { display: flex; align-items: center; justify-content: space-between; padding: 10px; background-color: #f8f9fa; border-radius: 10px; }
Â  Â  .switch { position: relative; display: inline-block; width: 60px; height: 34px; } .switch input { display:none; } .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; } .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; } input:checked + .slider { background-color: #6720bd; } input:checked + .slider:before { transform: translateX(26px); } .slider:after{ content:'Â°F'; color: white; position: absolute; transform: translate(-50%,-50%); top: 50%; left: 75%; font-size: 12px; } input#overviewUnitToggle:checked + .slider:after { content:'Â°C'; left: 25%; } input#fullscreenWeatherToggle:not(:checked) + .slider:after{ content:'OFF'; color: white; left: 75%; } input#fullscreenWeatherToggle:checked + .slider:after { content:'ON'; left: 25%; }
Â  Â  .data-source-selector { display: flex; gap: 10px; } .data-source-selector input[type="radio"] { display: none; } .data-source-selector label { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; font-weight: 600; } .data-source-selector input[type="radio"]:checked + label { background-color: #6720bd; border-color: #8a2be2; color: white; box-shadow: 0 2px 8px rgba(103, 32, 189, 0.3); } .data-source-selector input[type="radio"]:disabled + label { background-color: #e9ecef; cursor: not-allowed; color: #999; border-color: #e0e0e0; }
Â  Â  #nwsApiNote { font-size: 0.85em; color: #777; text-align: center; margin-top: 5px; }

Â  Â  /* Other Modals */
Â  Â  .new-countdown-modal .modal-content { max-width: 400px; gap: 15px; } .new-countdown-modal h3 { margin: 0; text-align: center; font-size: 1.6em; color: #6720bd; font-weight: bold; } .form-group { display: flex; flex-direction: column; gap: 5px; } .form-group label { font-weight: 600; } .form-group input { padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 1em; } #saveNewCountdownBtn { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1.1em; }
Â  Â  .shortcut-settings-modal .modal-content{max-width: 600px;gap: 10px}.shortcut-settings-modal h3{margin: 0 0 10px;text-align: center;font-size: 1.6em;color: #6720bd;font-weight: 700;font-family: 'PrimaryFont', sans-serif}#shortcutSettingsForm{display: flex;flex-direction: column;gap: 20px;max-height: 60vh;overflow-y: auto;padding-right: 10px}.shortcut-editor-group{padding: 15px;border: 1px solid #ddd;border-radius: 12px;background-color: #f9f9f9}.shortcut-editor-group h4{margin-top: 0;margin-bottom: 15px;color: #333;border-bottom: 1px solid #eee;padding-bottom: 8px}.shortcut-input-row{display: flex;flex-wrap: wrap;align-items: center;gap: 10px;margin-bottom: 12px}.shortcut-input-row label{font-weight: 600;color: #555;white-space: nowrap}.shortcut-input-row input[type=text],.shortcut-input-row input[type=url],.shortcut-input-row select{padding: 8px 10px;font-size: 1em;border: 1px solid #ccc;border-radius: 6px;box-sizing: border-box;font-family: 'PrimaryFont', sans-serif;flex: 1 1 150px}.shortcut-emoji-input{flex: 0 1 60px}.shortcut-name-input{flex: 1 1 200px}.action-target-wrapper .hidden{display: none}.shortcut-modal-buttons{display: flex;justify-content: flex-end;gap: 10px;margin-top: 10px;border-top: 1px solid #eee;padding-top: 20px}.shortcut-modal-buttons button{padding: 10px 20px;border: none;border-radius: 8px;cursor: pointer;font-weight: 600;font-family: 'PrimaryFont', sans-serif;transition: all .2s ease}#saveShortcutsBtn{background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);color: #fff}#saveShortcutsBtn:hover{transform: translateY(-2px);box-shadow: 0 4px 10px rgba(103, 32, 189, .3)}#resetShortcutsBtn{background-color: #6c757d;color: #fff}#resetShortcutsBtn:hover{background-color: #5a6268}
Â  Â Â 
Â  Â  /* --- Fullscreen Additions --- */
Â  Â  #fullscreen-weather-display { position: absolute; top: 20px; right: 80px; text-align: right; font-size: 1.5vw; text-shadow: 0 0 10px black; display: flex; align-items: center; gap: 10px; transition: right 0.5s ease-in-out; }
Â  Â  #fullscreen-weather-display .icon { font-size: 2em; } #fullscreen-weather-display .temp { font-weight: bold; } #fullscreen-weather-display .condition { font-size: 0.7em; }
Â  Â  #clock-fs-color-palette .color-swatch-custom { background: conic-gradient(red, yellow, lime, aqua, blue, magenta, red); } #color-picker-input { visibility: hidden; width: 0; height: 0; position: absolute; }
Â  Â  #edit-mode-hint { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background-color: rgba(40, 40, 40, 0.9); backdrop-filter: blur(5px); color: white; padding: 12px 25px; border-radius: 12px; z-index: 10001; font-size: 0.9em; transition: bottom 0.4s ease-in-out; display: flex; align-items: center; gap: 15px; }
Â  Â  #edit-mode-hint.visible { bottom: 20px; } #edit-mode-hint kbd { background-color: #555; padding: 2px 6px; border-radius: 4px; }
Â  Â  .hint-divider { width: 1px; height: 14px; background-color: #666; }
Â  Â  #clock-fullscreen-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; color: white; z-index: 2000; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; box-sizing: border-box; background: #0a0a14; transition: background 0.5s ease; user-select: none; }
Â  Â  #clock-fullscreen-overlay.active { display: flex; } #clock-fullscreen-overlay.inactive-cursor { cursor: none; }
Â  Â  #clock-fs-main-time { font-size: 12vw; font-weight: bold; } #clock-fs-main-date { font-size: 2.5vw; margin-top: -1vh; }
Â  Â  #clock-fs-countdown-section { margin-top: 5vh; min-height: 15vh; width: 100%; }
Â  Â  #clock-fs-countdown-name { font-size: 2vw; font-weight: 500; } #clock-fs-countdown-timer { font-size: 4vw; font-weight: bold; }
Â  Â  #clock-fs-countdown-timer .time-unit { display: inline-block; margin: 0 0.5vw; } #clock-fs-countdown-timer .time-label { font-size: 0.3em; display: block; margin-top: -0.5vh; }
Â  Â Â 
Â  Â  /* --- Fullscreen controls fade behavior --- */
Â  Â  .clock-fs-controls, .clock-fs-right-controls { opacity: 1; visibility: visible; position: absolute; top: 20px; transition: opacity 0.5s ease-in-out; }
Â  Â  .clock-fs-controls { left: 20px; display: flex; gap: 15px; align-items: center; }
Â  Â  .clock-fs-right-controls { right: 20px; }
Â  Â  .clock-fs-controls.controls-hidden, .clock-fs-right-controls.controls-hidden { opacity: 0; visibility: hidden; transition: opacity 0.5s ease-in-out, visibility 0s linear 0.5s; }

Â  Â  #clock-fs-color-toggle { font-size: 1.8em; cursor: pointer; transition: transform 0.3s; } #clock-fs-color-toggle:hover { transform: rotate(45deg); }
Â  Â  #clock-fs-color-palette { position: absolute; top: 70px; right: 20px; width: 152px; background: rgba(255,255,255,.1); backdrop-filter: blur(5px); border-radius: 12px; padding: 10px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; z-index: 2001; opacity: 0; visibility: hidden; transition: opacity 0.3s; }
Â  Â  #clock-fs-color-palette.visible { opacity: 1; visibility: visible; }
Â  Â  .color-swatch { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid white; transition: transform 0.2s; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
Â  Â  .color-swatch:hover { transform: scale(1.1); }
Â  Â Â 
Â  Â  /* Custom Select Dropdown Styles */
Â  Â  .custom-select-wrapper { position: relative; font-family: 'PrimaryFont', sans-serif;}
Â  Â  .custom-select-trigger { background: rgba(255,255,255,.15); color: white; border: 1px solid rgba(255,255,255,.3); border-radius: 12px; padding: 10px 30px 10px 15px; cursor: pointer; position: relative; width: 250px; transition: background-color 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 1em; }
Â  Â  #overviewSettingsModal .custom-select-trigger { background: #fff; color: #333; border: 1px solid #ccc; width: 100%; box-sizing: border-box; }
Â  Â  .custom-select-trigger:hover { background: rgba(255,255,255,.25); }
Â  Â  #overviewSettingsModal .custom-select-trigger:hover { background-color: #f0f2f5; }
Â  Â  .custom-select-trigger::after { content: "â–¼"; font-size: .7em; position: absolute; right: 15px; top: 50%; transform: translateY(-50%); transition: transform .2s; }
Â  Â  .custom-select.open .custom-select-trigger::after { transform: translateY(-50%) rotate(180deg); }
Â  Â  .custom-options { position: absolute; top: 105%; left: 0; right: 0; background: rgba(40,40,40,.7); backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,.2); border-radius: 12px; z-index: 2002; max-height: 200px; overflow-y: auto; display: none; }
Â  Â  #overviewSettingsModal .custom-options { background: white; border: 1px solid #ddd; color: #333; z-index: 10001; }
Â  Â  .custom-select.open .custom-options { display: block; }
Â  Â  .custom-option, .custom-optgroup { display: block; padding: 12px 15px; cursor: pointer; transition: background-color 0.2s; white-space: normal; word-break: break-word; }
Â  Â  .custom-optgroup { font-weight: bold; color: #888; background-color: #f8f9fa; cursor: default; }
Â  Â  .custom-option:hover { background-color: rgba(255,255,255,.1); }
Â  Â  #overviewSettingsModal .custom-option:hover { background-color: #f0f2f5; }
Â  Â  .custom-option.selected { background-color: rgba(138,43,226,.5); font-weight: bold; }
Â  Â  #overviewSettingsModal .custom-option.selected { background-color: #e9ecef; }
Â  Â  .fade-in { animation: fadeIn .6s ease-out forwards; } @keyframes fadeIn{from{opacity: 0;transform: translateY(20px)}to{opacity: 1;transform: translateY(0)}}
Â  </style>
</head>
<body class="dashboard-page">
Â  <header class="main-header light-bg">
Â  Â  <div class="container">
Â  Â  Â  <div class="logo"> <a href="../index.html"> <img src="../images/logo-dark.png" alt="4SP Logo" /> </a> </div>
Â  Â  Â  <div class="auth-buttons"> <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button> <button id="logoutBtn" class="btn btn-login">LOG OUT</button> </div>
Â  Â  </div>
Â  </header>
Â  <div class="dashboard-container">
Â  Â  <aside class="sidebar" id="sidebar">
Â  Â  Â  <button id="toggleSidebar">â˜°</button>
Â  Â  Â  <nav>
Â  Â  Â  Â  <ul>
Â  Â  Â  Â  Â  <li><a href="dashboard.html" class="active"><span class="icon">ğŸ </span><span class="label">Dashboard</span></a></li>
Â  Â  Â  Â  Â  <li><a href="soundboard.html"><span class="icon">ğŸµ</span><span class="label">Soundboard</span></a></li>
Â  Â  Â  Â  Â  <li><a href="games.html"><span class="icon">ğŸ®</span><span class="label">Games</span></a></li>
Â  Â  Â  Â  Â  <li><a href="apps.html"><span class="icon">âœ¨</span><span class="label">Apps</span></a></li>
Â  Â  Â  Â  Â  <li><a href="settings.html"><span class="icon">âš™ï¸</span><span class="label">Settings</span></a></li>
Â  Â  Â  Â  Â  <li><a href="#" id="signOutLink"><span class="icon">ğŸ”’</span><span class="label">LOG OUT</span></a></li>
Â  Â  Â  Â  </ul>
Â  Â  Â  </nav>
Â  Â  </aside>
Â  Â  <main class="main-content">
Â  Â  Â  <div class="dashboard-header">
Â  Â  Â  Â  <div class="dashboard-title-wrapper">
Â  Â  Â  Â  Â  <h2 class="dashboard-title">Dashboard</h2>
Â  Â  Â  Â  Â  <div id="battery-status" class="battery-status-container">
Â  Â  Â  Â  Â  Â  <div id="battery-charging-status"></div> <div id="battery-level"></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div class="dashboard-grid" id="dashboardGrid"></div>
Â  Â  </main>
Â  </div>
Â  <div id="edit-mode-hint"></div>
Â  <div id="clock-fullscreen-overlay">
Â  Â  <div id="fullscreen-weather-display" style="display: none;"></div>
Â  Â  <div class="clock-fs-controls">
Â  Â  Â  <div class="custom-select-wrapper" id="fullscreen-countdown-select-wrapper">
Â  Â  Â  Â  <div class="custom-select">
Â  Â  Â  Â  Â  <div class="custom-select-trigger"><span>No Countdown</span></div>
Â  Â  Â  Â  Â  <div class="custom-options"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div class="clock-fs-right-controls"> <div id="clock-fs-color-toggle" title="Change Background">ğŸ¨</div> </div>
Â  Â  <div id="clock-fs-color-palette">
Â  Â  Â  Â  <div class="color-swatch" style="background: #0a0a14;" data-color="#0a0a14"></div>
Â  Â  Â  Â  <div class="color-swatch" style="background: linear-gradient(135deg, #23074d, #cc5333);" data-color="linear-gradient(135deg, #23074d, #cc5333)"></div>
Â  Â  Â  Â  <div class="color-swatch" style="background: linear-gradient(135deg, #1f4037, #99f2c8);" data-color="linear-gradient(135deg, #1f4037, #99f2c8)"></div>
Â  Â  Â  Â  <div class="color-swatch" style="background: linear-gradient(135deg, #603813, #b29f94);" data-color="linear-gradient(135deg, #603813, #b29f94)"></div>
Â  Â  Â  Â  <div class="color-swatch" style="background: linear-gradient(135deg, #780206, #061161);" data-color="linear-gradient(135deg, #780206, #061161)"></div>
Â  Â  Â  Â  <div class="color-swatch" style="background: #2c3e50;" data-color="#2c3e50"></div>
Â  Â  Â  Â  <div class="color-swatch" style="background: #c0392b;" data-color="#c0392b"></div>
Â  Â  Â  Â  <div class="color-swatch" style="background: #008080;" data-color="#008080"></div>
Â  Â  Â  Â  <div class="color-swatch" style="background: linear-gradient(to right, #00c6ff, #0072ff);" data-color="linear-gradient(to right, #00c6ff, #0072ff)"></div>
Â  Â  Â  Â  <div class="color-swatch" style="background: linear-gradient(to right, #ff7e5f, #feb47b);" data-color="linear-gradient(to right, #ff7e5f, #feb47b)"></div>
Â  Â  Â  Â  <div class="color-swatch" style="background: linear-gradient(to right, #8e2de2, #4a00e0);" data-color="linear-gradient(to right, #8e2de2, #4a00e0)"></div>
Â  Â  Â  Â  <div class="color-swatch color-swatch-custom" title="Custom Color"></div>
Â  Â  Â  Â  <input type="color" id="color-picker-input">
Â  Â  </div>
Â  Â  <div id="clock-fs-main-time">00:00:00</div>
Â  Â  <div id="clock-fs-main-date">Day, Month Date, Year</div>
Â  Â  <div id="clock-fs-countdown-section"> <h3 id="clock-fs-countdown-name"></h3> <div id="clock-fs-countdown-timer"></div> </div>
Â  </div>
Â  <div id="forecastDetailModal" class="modal">
Â  Â  <div class="modal-content">
Â  Â  Â  <button class="modal-close-btn">&times;</button>
Â  Â  Â  <div class="modal-header-section">
Â  Â  Â  Â  <h3 id="modalDayDate">Day, Date</h3>
Â  Â  Â  Â  <p class="date-subtitle" id="modalFullDateSubtitle"></p>
Â  Â  Â  </div>
Â  Â  Â  <div class="modal-current-weather-summary"> <span id="modalWeatherIcon" class="modal-icon-large">â“</span>
Â  Â  Â  Â  <div class="modal-temp-and-desc">
Â  Â  Â  Â  Â  <div class="modal-temp-display"> <span id="modalMaxTemp">--</span> / <span id="modalMinTemp">--</span> </div>
Â  Â  Â  Â  Â  <div id="modalWeatherDesc">Description</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <div class="modal-details-grid">
Â  Â  Â  Â  <p><strong><span class="detail-icon">ğŸŒ¡ï¸</span>Feels Like:</strong> <span id="modalFeelsLike">--</span></p>
Â  Â  Â  Â  <p><strong><span class="detail-icon">ğŸ’§</span>Humidity:</strong> <span id="modalHumidity">--</span>%</p>
Â  Â  Â  Â  <p><strong><span class="detail-icon">ğŸŒ§ï¸</span>Precipitation:</strong> <span id="modalPrecipSum">--</span> mm</p>
Â  Â  Â  Â  <p><strong><span class="detail-icon">â˜”</span>Precip. Chance:</strong> <span id="modalPrecipProb">--</span>%</p>
Â  Â  Â  Â  <p><strong><span class="detail-icon">ğŸ’¨</span>Max Wind:</strong> <span id="modalWindSpeed">--</span></p>
Â  Â  Â  Â  <p><strong><span class="detail-icon">ğŸ§­</span>Wind Direction:</strong> <span id="modalWindDirection">--</span></p>
Â  Â  Â  Â  <p><strong><span class="detail-icon">â˜€ï¸</span>Sunrise:</strong> <span id="modalSunriseTime">--:--</span></p>
Â  Â  Â  Â  <p><strong><span class="detail-icon">ğŸŒ‡</span>Sunset:</strong> <span id="modalSunsetTime">--:--</span></p>
Â  Â  Â  Â  <p><strong><span class="detail-icon">ğŸ’¡</span>Daylight:</strong> <span id="modalDaylightDuration">--</span></p>
Â  Â  Â  </div>
Â  Â  Â  <div class="modal-advice-section">
Â  Â  Â  Â  <h4><span class="detail-icon">ğŸ’¡</span> Daily Advice</h4>
Â  Â  Â  Â  <div id="modalDailyAdvice">Checking the forecast for tips...</div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
Â  <div id="overviewSettingsModal" class="modal overview-settings-modal">
Â  Â  <div class="modal-content">
Â  Â  Â  Â  <div class="modal-header">
Â  Â  Â  Â  Â  Â  <h3>Overview Settings</h3>
Â  Â  Â  Â  Â  Â  <button class="modal-close-btn">&times;</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="settings-tabs">
Â  Â  Â  Â  Â  Â  <button class="tab-button active" data-tab="general">General</button>
Â  Â  Â  Â  Â  Â  <button class="tab-button" data-tab="weather">Weather</button>
Â  Â  Â  Â  Â  Â  <button class="tab-button" data-tab="countdown">Countdown</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="tab-panels-wrapper">
Â  Â  Â  Â  Â  Â  <div class="tab-panels-container">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="tab-general" class="tab-panel">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="settings-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Fullscreen Title Display</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="custom-select-wrapper" id="title-display-select-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="custom-select">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="custom-select-trigger"><span>None</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="custom-options">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="custom-option selected" data-value="none">None</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="custom-option" data-value="time">Current Time</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="custom-option" data-value="countdown">Current Countdown</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="settings-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Fullscreen Options</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="unit-toggle-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Show Weather in Fullscreen</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="switch"><input type="checkbox" id="fullscreenWeatherToggle"><span class="slider"></span></label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="tab-weather" class="tab-panel">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="settings-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="overviewLocationInput">Location</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="location-input-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="overviewLocationInput" placeholder="Enter a city name...">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul id="overviewLocationSuggestions"></ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="overviewUseCurrentLocationBtn">ğŸ“ Use My Current Location</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="settings-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Data Source</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="data-source-selector">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="radio" id="sourceOpenMeteo" name="dataSource" value="open-meteo" checked>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="sourceOpenMeteo">Open-Meteo</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="radio" id="sourceNWS" name="dataSource" value="nws">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="sourceNWS">NWS (USA)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="nwsApiNote" style="display: none;">The NWS API is only for locations in the United States.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="settings-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Units</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="unit-toggle-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Imperial (Â°F) / Metric (Â°C)</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="switch"> <input type="checkbox" id="overviewUnitToggle"> <span class="slider"></span> </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="tab-countdown" class="tab-panel">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="settings-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Displayed Countdown or Group</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="custom-select-wrapper" id="overview-countdown-select-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="custom-select">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="custom-select-trigger"><span>-- None --</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="custom-options"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>
Â  <div id="shortcutSettingsModal" class="modal shortcut-settings-modal">
Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  <button class="modal-close-btn">&times;</button>
Â  Â  Â  Â  Â  <h3>Edit Quick Shortcuts</h3>
Â  Â  Â  Â  Â  <form id="shortcutSettingsForm" onsubmit="return false;"></form>
Â  Â  Â  Â  Â  <div class="shortcut-modal-buttons">
Â  Â  Â  Â  Â  Â  Â  <button id="resetShortcutsBtn" type="button">Reset to Default</button>
Â  Â  Â  Â  Â  Â  Â  <button id="saveShortcutsBtn" type="button">Save Changes</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  </div>
Â  <div id="newCountdownModal" class="modal new-countdown-modal">
Â  Â  <div class="modal-content">
Â  Â  Â  <button class="modal-close-btn">&times;</button>
Â  Â  Â  <h3>New Countdown</h3>
Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="newCountdownName">Event Name</label>
Â  Â  Â  Â  <input type="text" id="newCountdownName" placeholder="e.g., New Year's Day">
Â  Â  Â  </div>
Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="newCountdownDateTime">Date & Time</label>
Â  Â  Â  Â  <input type="text" id="newCountdownDateTime" placeholder="Select a future date...">
Â  Â  Â  </div>
Â  Â  Â  <button id="saveNewCountdownBtn">Save Countdown</button>
Â  Â  </div>
Â  </div>

Â  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
Â  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
Â  <script src="../firebase-config.js"></script>
Â  <script>
Â  Â  // --- THIS IS THE FULL, CORRECTED AND CONSOLIDATED SCRIPT ---
Â  Â Â 
Â  Â  // --- GLOBALS AND UTILITIES ---
Â  Â  const getStorageKey = (key) => firebase.auth().currentUser ? `4sp_${key}_${firebase.auth().currentUser.uid}` : `4sp_${key}_guest`;
Â  Â  const WMO_CODES={0:{d:"Clear sky",i:"â˜€ï¸"},1:{d:"Mainly clear",i:"ğŸŒ¤ï¸"},2:{d:"Partly cloudy",i:"ğŸŒ¥ï¸"},3:{d:"Overcast",i:"â˜ï¸"},45:{d:"Fog",i:"ğŸŒ«ï¸"},48:{d:"Rime fog",i:"ğŸŒ«ï¸"},51:{d:"Light drizzle",i:"ğŸŒ¦ï¸"},53:{d:"Drizzle",i:"ğŸŒ¦ï¸"},55:{d:"Dense drizzle",i:"ğŸŒ§ï¸"},56:{d:"Light freezing drizzle",i:"ğŸŒ¨ï¸"},57:{d:"Dense freezing drizzle",i:"ğŸŒ¨ï¸"},61:{d:"Slight rain",i:"ğŸŒ§ï¸"},63:{d:"Rain",i:"ğŸŒ§ï¸"},65:{d:"Heavy rain",i:"ğŸŒ§ï¸"},66:{d:"Light freezing rain",i:"ğŸŒ¨ï¸"},67:{d:"Heavy freezing rain",i:"ğŸŒ¨ï¸"},71:{d:"Slight snow",i:"â„ï¸"},73:{d:"Snow",i:"â„ï¸"},75:{d:"Heavy snow",i:"â„ï¸"},77:{d:"Snow grains",i:"â„ï¸"},80:{d:"Slight showers",i:"ğŸŒ¦ï¸"},81:{d:"Showers",i:"ğŸŒ¦ï¸"},82:{d:"Violent showers",i:"â›ˆï¸"},85:{d:"Slight snow showers",i:"ğŸŒ¨ï¸"},86:{d:"Heavy snow showers",i:"ğŸŒ¨ï¸"},95:{d:"Thunderstorm",i:"â›ˆï¸"},96:{d:"Thunderstorm, slight hail",i:"â›ˆï¸"},99:{d:"Thunderstorm, heavy hail",i:"â›ˆï¸"}};
Â  Â Â 
Â  Â  // --- DOM Elements ---
Â  Â  const dashboardGrid = document.getElementById('dashboardGrid');
Â  Â  const editModeHint = document.getElementById('edit-mode-hint');

Â  Â  // --- Layout Globals ---
Â  Â  const dashboardLayoutStorageKey = '4sp_dashboardLayout_v2_super';
Â  Â  let selectedWidgetId = null;
Â  Â  const defaultDashboardLayout = ['time_weather_super_widget', 'stopwatch_widget', 'timer_widget', 'quick_actions_widget'];
Â  Â  const pageSuggestions = [ { name: 'Dashboard', url: 'dashboard.html' }, { name: 'Games', url: 'games.html' }, { name: 'Soundboard', url: 'soundboard.html' }, { name: 'Notes', url: 'notes.html' }, { name: 'Countdowns', url: 'countdowns.html' }, { name: 'Requests', url: 'requests.html' }, { name: 'Apps', url: 'apps.html' }, { name: 'Weather', url: 'weather.html' }, { name: 'Settings', url: 'settings.html' }];
Â  Â Â 
Â  Â  // --- Quick Actions / Shortcuts Globals ---
Â  Â  const defaultQuickActions = [
Â  Â  Â  Â  { icon: "ğŸ“", text: "Classroom", type: "url", value: "https://classroom.google.com/" },
Â  Â  Â  Â  { icon: "ğŸ“", text: "Notes", type: "page", value: "notes.html" },
Â  Â  Â  Â  { icon: "ğŸ—“ï¸", text: "Countdowns", type: "page", value: "countdowns.html" },
Â  Â  Â  Â  { icon: "ğŸµ", text: "Requests", type: "page", value: "requests.html" }
Â  Â  ];
Â  Â  let currentQuickActions = [...defaultQuickActions];

Â  Â  // --- Settings Globals ---
Â  Â  const defaultWeatherSettings = { dataSource: 'open-meteo', location: { label: 'New York, NY', latitude: 40.71, longitude: -74.01 }, units: 'imperial', showWeatherInFullscreen: false };
Â  Â  const defaultGeneralSettings = { titleDisplay: 'none' };
Â  Â  let weatherSettings = { ...defaultWeatherSettings };
Â  Â  let generalSettings = { ...defaultGeneralSettings };
Â  Â  let userCoords = null, userCountry = null, fullWeatherData = null;
    
    // --- Title update globals ---
    const originalBrowserTitle = document.title;
    let browserTitleInterval = null;

Â  Â  // --- SETTINGS LOGIC ---
Â  Â  function saveWeatherSettings() { localStorage.setItem(getStorageKey('weatherWidgetSettings'), JSON.stringify(weatherSettings)); }
Â  Â  function loadWeatherSettings() { const s = localStorage.getItem(getStorageKey('weatherWidgetSettings')); if (s) { try { const loaded = JSON.parse(s); weatherSettings = { ...defaultWeatherSettings, ...loaded }; } catch(e) { console.error("Failed to parse weather settings", e); } } }
Â  Â  function saveGeneralSettings() { localStorage.setItem(getStorageKey('generalSettings_v1'), JSON.stringify(generalSettings)); }
Â  Â  function loadGeneralSettings() { const s = localStorage.getItem(getStorageKey('generalSettings_v1')); if (s) { try { const loaded = JSON.parse(s); generalSettings = { ...defaultGeneralSettings, ...loaded }; } catch(e) { console.error("Failed to parse general settings", e); } } }

Â  Â  // --- WEATHER LOGIC ---
Â  Â  async function determineUserCountry() { try { const r = await fetch('https://ipapi.co/json/'); if (!r.ok) return; const d = await r.json(); userCountry = d.country_code?.toUpperCase(); } catch (e) { console.warn("Could not determine user country from IP.", e); } }
Â  Â  function mapNWSKeywordsToWMO(f) { if (!f) return 0; f=f.toLowerCase(); if (f.includes("thunderstorm")||f.includes("t-storm")) return 95; if (f.includes("snow")||f.includes("flurr")) return 73; if (f.includes("rain")||f.includes("shower")) return 63; if (f.includes("drizzle")) return 53; if (f.includes("fog")) return 45; if (f.includes("overcast")||f.includes("cloudy")) return 3; if (f.includes("partly cloudy")||f.includes("mostly cloudy")) return 2; if (f.includes("mostly clear")||f.includes("partly sunny")) return 1; if (f.includes("sunny")||f.includes("clear")) return 0; return 0; }
Â  Â Â 
Â  Â  function transformNWSData(daily, hourly) {
Â  Â  Â  Â  const t = { latitude: weatherSettings.location.latitude, longitude: weatherSettings.location.longitude, utc_offset_seconds: new Date().getTimezoneOffset() * -60, timezone: Intl.DateTimeFormat().resolvedOptions().timeZone, current: {}, hourly: {}, daily: {} };
Â  Â  Â  Â  const now = hourly.periods[0];
Â  Â  Â  Â  t.current = { time: now.startTime, temperature_2m: now.temperature, relative_humidity_2m: now.relativeHumidity.value, apparent_temperature: now.temperature, weather_code: mapNWSKeywordsToWMO(now.shortForecast), wind_speed_10m: parseInt(now.windSpeed.split(' ')[0],10) };
Â  Â  Â  Â  const dailyPeriods = []; for (let i = 0; i < daily.periods.length; i++) { if (daily.periods[i].isDaytime) { const night = (daily.periods[i+1] && !daily.periods[i+1].isDaytime) ? daily.periods[i+1] : daily.periods[i]; dailyPeriods.push({ day: daily.periods[i], night }); } }
Â  Â  Â  Â  t.daily = { time: dailyPeriods.map(p => p.day.startTime.split('T')[0]), weather_code: dailyPeriods.map(p => mapNWSKeywordsToWMO(p.day.shortForecast)), temperature_2m_max: dailyPeriods.map(p => p.day.temperature), temperature_2m_min: dailyPeriods.map(p => p.night.temperature), precipitation_sum: dailyPeriods.map(()=>null), precipitation_probability_max: dailyPeriods.map(p=>Math.max(p.day.probabilityOfPrecipitation.value||0, p.night.probabilityOfPrecipitation.value||0)), wind_speed_10m_max: dailyPeriods.map(p=>parseInt(p.day.windSpeed.split(' ')[0],10)), sunrise: dailyPeriods.map(()=>null), sunset: dailyPeriods.map(()=>null), daylight_duration: dailyPeriods.map(()=>null), wind_direction_10m_dominant: dailyPeriods.map(()=>null), uv_index_max: dailyPeriods.map(()=>null), relative_humidity_2m_mean: dailyPeriods.map(() => null) };
Â  Â  Â  Â  return t;
Â  Â  }

Â  Â  const fetchWeather = async () => {
Â  Â  Â  Â  const widget = document.querySelector('.dashboard-card[data-template-id="time_weather_super_widget"]');
Â  Â  Â  Â  const refreshBtn = widget?.querySelector('.weather-refresh-btn');
Â  Â  Â  Â  const refreshImg = refreshBtn?.querySelector('img');
Â  Â  Â  Â  if (refreshBtn) { refreshBtn.disabled = true; if(refreshImg) refreshImg.classList.add('refreshing'); }
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  if (weatherSettings.dataSource === 'nws') {
Â  Â  Â  Â  Â  Â  Â  Â  const { latitude, longitude } = weatherSettings.location; const r = await fetch(`https://api.weather.gov/points/${latitude},${longitude}`); if (!r.ok) throw new Error("Outside NWS (USA) coverage."); const d = await r.json();
Â  Â  Â  Â  Â  Â  Â  Â  const [forecastRes, hourlyRes] = await Promise.all([fetch(d.properties.forecast), fetch(d.properties.forecastHourly)]); if (!forecastRes.ok || !hourlyRes.ok) throw new Error("Failed to get NWS forecast details.");
Â  Â  Â  Â  Â  Â  Â  Â  const [dailyData, hourlyData] = await Promise.all([forecastRes.json(), hourlyRes.json()]); fullWeatherData = transformNWSData(dailyData.properties, hourlyData.properties);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  const {units,location}=weatherSettings; const p=new URLSearchParams({current:"temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m",daily:"weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum,precipitation_probability_max,wind_speed_10m_max,sunrise,sunset,daylight_duration,wind_direction_10m_dominant,uv_index_max,relative_humidity_2m_mean",timezone:"auto",forecast_days:7,temperature_unit:units==='metric'?'celsius':'fahrenheit',wind_speed_unit:units==='metric'?'kmh':'mph'});
Â  Â  Â  Â  Â  Â  Â  Â  const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${location.latitude}&longitude=${location.longitude}&${p}`); if (!r.ok) throw new Error(`API Error: ${r.status}`); fullWeatherData = await r.json();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (window.renderWeatherInDashboard) window.renderWeatherInDashboard(fullWeatherData);
Â  Â  Â  Â  } catch (error) { if (window.renderWeatherErrorInDashboard) window.renderWeatherErrorInDashboard(error.message);
Â  Â  Â  Â  } finally { if (refreshBtn) { refreshBtn.disabled = false; if(refreshImg) refreshImg.classList.remove('refreshing'); } }
Â  Â  };
Â  Â Â 
Â  Â  // --- FORECAST MODAL & ADVICE LOGIC ---
Â  Â  function formatDaylightDuration(s) { if (s == null) return 'N/A'; const h=Math.floor(s/3600); const m=Math.floor((s%3600)/60); return `${h}h ${m}m`; }
Â  Â  function degreesToCardinal(d) { if (d==null) return 'N/A'; const v=Math.floor((d/22.5)+0.5); const a=["N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE", "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW"]; return a[(v % 16)]; }
Â  Â  function generateWeatherAdvice(dayData) {
Â  Â  Â  Â  const advice = new Set(); const { tempMax, tempMin, weatherCode, precipSum, precipProb, windSpeedMax, humidity, uvIndexMax } = dayData; const units = weatherSettings.units;
Â  Â  Â  Â  const tempMaxC = units === 'imperial' ? (tempMax - 32) * 5 / 9 : tempMax; const tempMinC = units === 'imperial' ? (tempMin - 32) * 5 / 9 : tempMin; const windSpeedMph = units === 'metric' ? windSpeedMax * 0.621371 : windSpeedMax;
Â  Â  Â  Â  if (tempMaxC >= 32) advice.add("Extreme heat expected. Stay hydrated and avoid strenuous activity."); else if (tempMaxC >= 25) advice.add("It's going to be hot. Wear light clothing."); else if (tempMinC <= 0) advice.add("Freezing temperatures overnight. Watch for icy patches."); else if (tempMaxC <= 5) advice.add("It's quite cold. Bundle up with a thick coat.");
Â  Â  Â  Â  if (Math.abs(tempMax - tempMin) > (units === 'imperial' ? 25 : 14)) advice.add("Large temperature swing today. Dressing in layers is a good idea.");
Â  Â  Â  Â  if ((precipSum != null && precipSum > 0.1) || (precipProb != null && precipProb > 40)) { if ([61, 63, 65, 80, 81, 82].includes(weatherCode)) advice.add("Rain is likely. Don't forget an umbrella."); else if ([71, 73, 75, 85, 86].includes(weatherCode)) advice.add("Snow is expected! Wear a warm, waterproof coat."); else if ([95, 96, 99].includes(weatherCode)) advice.add("Thunderstorms are possible. Stay indoors if you hear thunder."); else advice.add("There's a chance of precipitation."); }
Â  Â  Â  Â  if (windSpeedMph >= 15) advice.add("It could be quite windy. A windbreaker is recommended."); if (humidity != null && tempMaxC >= 28 && humidity >= 60) advice.add("High heat and humidity will make it feel very muggy."); if ([45, 48].includes(weatherCode)) advice.add("Foggy conditions are expected. Be extra cautious if you're driving.");
Â  Â  Â  Â  if (uvIndexMax != null) { if (uvIndexMax >= 8) advice.add("UV index is very high. Seek shade and use strong sunscreen."); else if (uvIndexMax >= 6) advice.add("High UV index today. Sunscreen is recommended."); }
Â  Â  Â  Â  if (advice.size === 0) { if ([0, 1].includes(weatherCode)) return "<p>Looks like a beautiful day. Perfect for outdoor activities!</p>"; if (tempMaxC > 18 && tempMaxC < 24 && (!precipProb || precipProb < 20)) return "<p>Conditions look pleasant and mild. A great day to be outside!</p>"; return "<p>Enjoy your day! Check the details above for a full forecast.</p>"; }
Â  Â  Â  Â  return '<ul>' + [...advice].map(item => `<li>${item}</li>`).join('') + '</ul>';
Â  Â  }
Â  Â  function openForecastModal(dayData) {
Â  Â  Â  Â  const tempS = weatherSettings.units === 'metric' ? 'Â°C' : 'Â°F'; const speedS = weatherSettings.units === 'metric' ? 'km/h' : 'mph';
Â  Â  Â  Â  const utcDate = new Date(dayData.dateStr + 'T12:00:00Z');
Â  Â  Â  Â  document.getElementById('modalDayDate').textContent = utcDate.toLocaleDateString(undefined, { weekday: 'long' });
Â  Â  Â  Â  document.getElementById('modalFullDateSubtitle').textContent = utcDate.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
Â  Â  Â  Â  const codeInfo = WMO_CODES[dayData.weatherCode] || { description: "Unknown", icon: "â“" };
Â  Â  Â  Â  document.getElementById('modalWeatherIcon').textContent = codeInfo.icon; document.getElementById('modalWeatherDesc').textContent = codeInfo.description;
Â  Â  Â  Â  document.getElementById('modalMaxTemp').textContent = `${Math.round(dayData.tempMax)}${tempS}`; document.getElementById('modalMinTemp').textContent = `${Math.round(dayData.tempMin)}${tempS}`;
Â  Â  Â  Â  document.getElementById('modalPrecipSum').textContent = `${dayData.precipSum != null ? dayData.precipSum : '--'} ${weatherSettings.units === 'metric' ? 'mm' : 'in'}`;
Â  Â  Â  Â  document.getElementById('modalPrecipProb').textContent = `${dayData.precipProb != null ? dayData.precipProb : '--'}%`;
Â  Â  Â  Â  document.getElementById('modalWindSpeed').textContent = `${dayData.windSpeedMax != null ? Math.round(dayData.windSpeedMax) : '--'} ${speedS}`;
Â  Â  Â  Â  document.getElementById('modalWindDirection').textContent = degreesToCardinal(dayData.windDirection);
Â  Â  Â  Â  document.getElementById('modalDaylightDuration').textContent = formatDaylightDuration(dayData.daylightDuration);
Â  Â  Â  Â  document.getElementById('modalSunriseTime').textContent = dayData.sunrise ? new Date(dayData.sunrise).toLocaleTimeString([],{hour:'2-digit', minute:'2-digit'}) : 'N/A';
Â  Â  Â  Â  document.getElementById('modalSunsetTime').textContent = dayData.sunset ? new Date(dayData.sunset).toLocaleTimeString([],{hour:'2-digit', minute:'2-digit'}) : 'N/A';
Â  Â  Â  Â  document.getElementById('modalFeelsLike').textContent = `${dayData.feelsLike != null ? Math.round(dayData.feelsLike) : '--'}${tempS}`;
Â  Â  Â  Â  document.getElementById('modalHumidity').textContent = `${dayData.humidity != null ? dayData.humidity : '--'}%`;
Â  Â  Â  Â  document.getElementById('modalDailyAdvice').innerHTML = generateWeatherAdvice(dayData);
Â  Â  Â  Â  document.getElementById('forecastDetailModal').classList.add('modal-open');
Â  Â  }
Â  Â Â 
Â  Â  // --- FULLSCREEN CLOCK LOGIC ---
Â  Â  const clockFsOverlay=document.getElementById('clock-fullscreen-overlay'),clockFsTime=document.getElementById('clock-fs-main-time'),clockFsDate=document.getElementById('clock-fs-main-date'),clockFsCountdownName=document.getElementById('clock-fs-countdown-name'),clockFsCountdownTimer=document.getElementById('clock-fs-countdown-timer');
Â  Â  let clockFsTimeout, clockFsCountdownTimeout, inactivityTimer;
Â  Â  let activeGroupId = null; // For countdown groups

Â  Â  function resetInactivityTimer() {
Â  Â  Â  Â  clearTimeout(inactivityTimer);
Â  Â  Â  Â  const controls = document.querySelectorAll('.clock-fs-controls, .clock-fs-right-controls');
Â  Â  Â  Â  const weatherDisplay = document.getElementById('fullscreen-weather-display');
Â  Â  Â  Â  clockFsOverlay.classList.remove('inactive-cursor');
Â  Â  Â  Â  controls.forEach(c => c.classList.remove('controls-hidden'));
Â  Â  Â  Â  if (weatherDisplay.style.display !== 'none') weatherDisplay.style.right = '80px';
Â  Â  Â  Â  inactivityTimer = setTimeout(() => {
Â  Â  Â  Â  Â  Â  clockFsOverlay.classList.add('inactive-cursor');
Â  Â  Â  Â  Â  Â  controls.forEach(c => c.classList.add('controls-hidden'));
Â  Â  Â  Â  Â  Â  if (weatherDisplay.style.display !== 'none') weatherDisplay.style.right = '20px';
Â  Â  Â  Â  }, 3000);
Â  Â  }

Â  Â  function openClockFullscreen(){
Â  Â  Â  Â  const savedColor = localStorage.getItem(getStorageKey('clockFsColor'));
Â  Â  Â  Â  if (savedColor) clockFsOverlay.style.background = savedColor;
Â  Â  Â  Â  clockFsOverlay.classList.add('active');
Â  Â  Â  Â  updateFullscreenClock();
Â  Â  Â  Â  clockFsOverlay.requestFullscreen().catch(err=>{console.error("Fullscreen request failed:",err);closeClockFullscreen()});
Â  Â  Â  Â Â 
Â  Â  Â  Â  populateAndInitCountdownDropdown('fullscreen-countdown-select-wrapper', setActiveDisplay);
Â  Â  Â  Â  const savedId = localStorage.getItem(getStorageKey('selectedDashboardCountdownId'));
Â  Â  Â  Â  setActiveDisplay(savedId);

Â  Â  Â  Â  updateFullscreenWeatherDisplay();
Â  Â  Â  Â  clockFsOverlay.addEventListener('mousemove', resetInactivityTimer);
Â  Â  Â  Â  resetInactivityTimer();
Â  Â  }
Â  Â Â 
Â  Â  function closeClockFullscreen(){
Â  Â  Â  Â  clockFsOverlay.classList.remove('active');
Â  Â  Â  Â  clearTimeout(clockFsTimeout);
Â  Â  Â  Â  clearTimeout(clockFsCountdownTimeout);
Â  Â  Â  Â  clearTimeout(inactivityTimer);
Â  Â  Â  Â  clockFsOverlay.removeEventListener('mousemove', resetInactivityTimer);
Â  Â  Â  Â  clockFsOverlay.classList.remove('inactive-cursor');
Â  Â  Â  Â  document.querySelectorAll('.clock-fs-controls, .clock-fs-right-controls').forEach(c => c.classList.remove('controls-hidden'));
Â  Â  Â  Â  if(window.updateDashboardCountdownDisplay) window.updateDashboardCountdownDisplay();
Â  Â  }
Â  Â Â 
Â  Â  document.addEventListener('fullscreenchange', ()=>{if(!document.fullscreenElement)closeClockFullscreen()});
Â  Â Â 
Â  Â  function updateFullscreenClock(){
Â  Â  Â  Â  const n=new Date();
Â  Â  Â  Â  clockFsTime.textContent=n.toLocaleTimeString();
Â  Â  Â  Â  clockFsDate.textContent=n.toLocaleDateString(undefined,{weekday:'long',year:'numeric',month:'long',day:'numeric'});
Â  Â  Â  Â  const msUntilNextSecond = 1000 - n.getMilliseconds();
Â  Â  Â  Â  clockFsTimeout = setTimeout(updateFullscreenClock, msUntilNextSecond);
Â  Â  }
Â  Â Â 
Â  Â  function updateFullscreenWeatherDisplay() {
Â  Â  Â  Â  const container = document.getElementById('fullscreen-weather-display');
Â  Â  Â  Â  if (weatherSettings.showWeatherInFullscreen && fullWeatherData) {
Â  Â  Â  Â  Â  Â  const { current } = fullWeatherData;
Â  Â  Â  Â  Â  Â  const codeInfo = WMO_CODES[current.weather_code] || { d: '', i: 'â“' };
Â  Â  Â  Â  Â  Â  const tempSuffix = weatherSettings.units === 'metric' ? 'Â°C' : 'Â°F';
Â  Â  Â  Â  Â  Â  container.innerHTML = `<div class="icon">${codeInfo.i}</div><div><div class="temp">${Math.round(current.temperature_2m)}${tempSuffix}</div><div class="condition">${codeInfo.d}</div></div>`;
Â  Â  Â  Â  Â  Â  container.style.display = 'flex';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  container.style.display = 'none';
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  // --- COUNTDOWN LOGIC (including GROUPS) ---
Â  Â  function calculateNextOccurrence(countdown) {
Â  Â  Â  Â  if (!countdown.repeat) return new Date(countdown.targetTimestamp);
Â  Â  Â  Â  let lastTarget = new Date(countdown.targetTimestamp);
Â  Â  Â  Â  let now = new Date();
Â  Â  Â  Â  if (lastTarget > now) return lastTarget;
Â  Â  Â  Â  let nextTarget = new Date(lastTarget);
Â  Â  Â  Â  if (countdown.repeat.type === 'daily') {
Â  Â  Â  Â  Â  Â  const diffDays = Math.ceil((now - nextTarget) / (1000 * 60 * 60 * 24));
Â  Â  Â  Â  Â  Â  nextTarget.setDate(nextTarget.getDate() + diffDays);
Â  Â  Â  Â  Â  Â  if (nextTarget <= now) nextTarget.setDate(nextTarget.getDate() + 1);
Â  Â  Â  Â  } else if (countdown.repeat.type === 'weekly' && countdown.repeat.days?.length > 0) {
Â  Â  Â  Â  Â  Â  const sortedDays = countdown.repeat.days.map(d => parseInt(d)).sort((a,b) => a - b);
Â  Â  Â  Â  Â  Â  while (nextTarget <= now) {
Â  Â  Â  Â  Â  Â  Â  Â  let currentDay = nextTarget.getDay();
Â  Â  Â  Â  Â  Â  Â  Â  let nextDayInCycle = sortedDays.find(d => d > currentDay);
Â  Â  Â  Â  Â  Â  Â  Â  if (nextDayInCycle !== undefined) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nextTarget.setDate(nextTarget.getDate() + (nextDayInCycle - currentDay));
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nextTarget.setDate(nextTarget.getDate() + (7 - currentDay + sortedDays[0]));
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  return nextTarget;
Â  Â  }

Â  Â  function formatCountdown(targetDate, returnHtml = true) {
        const end = new Date(targetDate);
        const now = new Date();
        const diff = end - now;

        if (diff <= 0) {
            return "ğŸ‰ Finished!";
        }

        const w = Math.floor(diff / 604800000);
        const d = Math.floor((diff % 604800000) / 86400000);
        const h = Math.floor((diff % 86400000) / 3600000);
        const m = Math.floor((diff % 3600000) / 60000);
        const s = Math.floor((diff % 60000) / 1000);

        const units = [{v: w, l:'wks'}, {v: d, l:'days'}, {v: h, l:'hrs'}, {v: m, l:'mins'}, {v: s, l:'secs'}];
        const visibleUnits = units.filter((unit, idx) => units.slice(0, idx).reduce((acc, p) => acc + p.v, 0) + unit.v > 0);
        
        if (returnHtml) {
            return visibleUnits.map(unit => `<span class="time-unit">${unit.v}<span class="time-label">${unit.l}</span></span>`).join('') || `<span class="time-unit">0<span class="time-label">secs</span></span>`;
        } else {
            return visibleUnits.map(unit => `${unit.v}${unit.l.charAt(0)}`).join(' ') || "0s";
        }
Â  Â  }

Â  Â  function playNextInGroup(groupId) {
Â  Â  Â  Â  activeGroupId = groupId;
Â  Â  Â  Â  const countdowns = JSON.parse(localStorage.getItem(getStorageKey('countdowns')) || '[]');
Â  Â  Â  Â  const groups = JSON.parse(localStorage.getItem(getStorageKey('countdownGroups')) || '[]');
Â  Â  Â  Â  const group = groups.find(g => g.id === groupId);
Â  Â  Â  Â  if (!group) { console.error("Group not found"); return; }

Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  const nextCountdown = group.countdownIds
Â  Â  Â  Â  Â  Â  .map(id => countdowns.find(cd => cd.id === id))
Â  Â  Â  Â  Â  Â  .filter(cd => cd && cd.repeat)
Â  Â  Â  Â  Â  Â  .map(cd => ({ ...cd, nextOccurrence: calculateNextOccurrence(cd) }))
Â  Â  Â  Â  Â  Â  .filter(cd => cd.nextOccurrence > now)
Â  Â  Â  Â  Â  Â  .sort((a, b) => a.nextOccurrence - b.nextOccurrence)[0];
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (nextCountdown) { displaySingleCountdown(nextCountdown); }Â 
Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  Â  clockFsCountdownName.textContent = `${group.name} Finished`;
Â  Â  Â  Â  Â  Â  clockFsCountdownTimer.innerHTML = '';
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function displaySingleCountdown(countdown) {
Â  Â  Â  Â  if (!countdown) {
Â  Â  Â  Â  Â  Â  Â clockFsCountdownName.textContent = ''; clockFsCountdownTimer.innerHTML = ''; return;
Â  Â  Â  Â  }
Â  Â  Â  Â  clockFsCountdownName.textContent = countdown.name;
Â  Â  Â  Â  const tick = () => {
Â  Â  Â  Â  Â  Â  const nextOccurrence = calculateNextOccurrence(countdown);
Â  Â  Â  Â  Â  Â  const formattedTime = formatCountdown(nextOccurrence, true);
Â  Â  Â  Â  Â  Â  clockFsCountdownTimer.innerHTML = formattedTime;

Â  Â  Â  Â  Â  Â  if (formattedTime.includes("Finished")) {
Â  Â  Â  Â  Â  Â  Â  Â  clearTimeout(clockFsCountdownTimeout);
Â  Â  Â  Â  Â  Â  Â  Â  if (activeGroupId) { setTimeout(() => playNextInGroup(activeGroupId), 1000); }
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const msUntilNextSecond = 1000 - new Date().getMilliseconds();
Â  Â  Â  Â  Â  Â  clockFsCountdownTimeout = setTimeout(tick, msUntilNextSecond);
Â  Â  Â  Â  };
Â  Â  Â  Â  tick();
Â  Â  }

Â  Â  function setActiveDisplay(id) {
Â  Â  Â  Â  clearTimeout(clockFsCountdownTimeout);
Â  Â  Â  Â  localStorage.setItem(getStorageKey('selectedDashboardCountdownId'), id || '');
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (!id) {
Â  Â  Â  Â  Â  Â  activeGroupId = null;
Â  Â  Â  Â  Â  Â  clockFsCountdownName.textContent = '';
Â  Â  Â  Â  Â  Â  clockFsCountdownTimer.innerHTML = '';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  if (id.startsWith('group_')) {
Â  Â  Â  Â  Â  Â  playNextInGroup(id.replace('group_', ''));
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  activeGroupId = null;
Â  Â  Â  Â  Â  Â  const countdowns = JSON.parse(localStorage.getItem(getStorageKey('countdowns')) || '[]');
Â  Â  Â  Â  Â  Â  const countdown = countdowns.find(cd => cd.id === id);
Â  Â  Â  Â  Â  Â  displaySingleCountdown(countdown);
Â  Â  Â  Â  }
Â  Â  }

    // --- DYNAMIC BROWSER TITLE LOGIC ---
    function updateBrowserTitle() {
        if (generalSettings.titleDisplay === 'none') {
            if (document.title !== originalBrowserTitle) {
                document.title = originalBrowserTitle;
            }
            return;
        }

        if (generalSettings.titleDisplay === 'time') {
            document.title = new Date().toLocaleTimeString();
            return;
        }

        if (generalSettings.titleDisplay === 'countdown') {
            const savedId = localStorage.getItem(getStorageKey('selectedDashboardCountdownId'));
            if (!savedId) {
                if (document.title !== originalBrowserTitle) document.title = originalBrowserTitle;
                return;
            }

            const countdowns = JSON.parse(localStorage.getItem(getStorageKey('countdowns')) || '[]');
            const groups = JSON.parse(localStorage.getItem(getStorageKey('countdownGroups')) || '[]');
            let activeCountdown;
            let countdownName;

            if (savedId.startsWith('group_')) {
                const groupId = savedId.replace('group_', '');
                const group = groups.find(g => g.id === groupId);
                if (!group) { if (document.title !== originalBrowserTitle) document.title = originalBrowserTitle; return; }
                countdownName = group.name;
                const now = new Date();
                activeCountdown = group.countdownIds
                    .map(cid => countdowns.find(cd => cd.id === cid))
                    .filter(Boolean)
                    .map(cd => ({...cd, nextOccurrence: calculateNextOccurrence(cd)}))
                    .filter(cd => cd.nextOccurrence > now)
                    .sort((a,b) => a.nextOccurrence - b.nextOccurrence)[0];
            } else {
                activeCountdown = countdowns.find(cd => cd.id === savedId);
                if (activeCountdown) countdownName = activeCountdown.name;
            }

            if (activeCountdown) {
                const target = calculateNextOccurrence(activeCountdown);
                const formattedTime = formatCountdown(target, false);
                if (formattedTime.includes("Finished")) {
                    document.title = `${countdownName} - Finished!`;
                } else {
                    document.title = `${formattedTime} | ${countdownName}`;
                }
            } else {
                if (document.title !== originalBrowserTitle) document.title = originalBrowserTitle;
            }
        }
    }
Â  Â Â 
Â  Â  function populateAndInitCountdownDropdown(wrapperId, callback) {
Â  Â  Â  Â  const wrapper = document.getElementById(wrapperId);
Â  Â  Â  Â  if (!wrapper) return;
Â  Â  Â  Â  const customOptions = wrapper.querySelector('.custom-options');
Â  Â  Â  Â  const customSelectTrigger = wrapper.querySelector('.custom-select-trigger span');

Â  Â  Â  Â  const countdowns = JSON.parse(localStorage.getItem(getStorageKey('countdowns')) || '[]');
Â  Â  Â  Â  const groups = JSON.parse(localStorage.getItem(getStorageKey('countdownGroups')) || '[]');
Â  Â  Â  Â Â 
Â  Â  Â  Â  let optionsHTML = '<span class="custom-option" data-value="">-- None --</span>';
Â  Â  Â  Â  const now = new Date();

Â  Â  Â  Â  if (groups && groups.length > 0) {
Â  Â  Â  Â  Â  Â  optionsHTML += '<div class="custom-optgroup">Groups</div>';
Â  Â  Â  Â  Â  Â  groups.forEach(g => {
Â  Â  Â  Â  Â  Â  Â  Â  optionsHTML += `<span class="custom-option" data-value="group_${g.id}">${g.name}</span>`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const upcomingCountdowns = countdowns.filter(cd => new Date(cd.targetTimestamp) > now || cd.repeat).sort((a, b) => new Date(a.targetTimestamp) - new Date(b.targetTimestamp));
Â  Â  Â  Â  if (upcomingCountdowns.length > 0) {
Â  Â  Â  Â  Â  Â  optionsHTML += '<div class="custom-optgroup">Countdowns</div>';
Â  Â  Â  Â  Â  Â  upcomingCountdowns.forEach(cd => {
Â  Â  Â  Â  Â  Â  Â  Â  optionsHTML += `<span class="custom-option" data-value="${cd.id}">${cd.name}</span>`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  customOptions.innerHTML = optionsHTML;

Â  Â  Â  Â  const savedId = localStorage.getItem(getStorageKey('selectedDashboardCountdownId')) || '';
Â  Â  Â  Â  const selectedOption = customOptions.querySelector(`.custom-option[data-value="${savedId}"]`) || customOptions.querySelector('.custom-option[data-value=""]');
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (selectedOption) {
Â  Â  Â  Â  Â  Â  customOptions.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
Â  Â  Â  Â  Â  Â  selectedOption.classList.add('selected');
Â  Â  Â  Â  Â  Â  customSelectTrigger.textContent = selectedOption.textContent;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (callback) {
Â  Â  Â  Â  Â  Â  initializeCustomSelect(wrapper, callback);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function populateAllCountdownDropdowns() {
Â  Â  Â  Â  // This function now only targets the dropdown in the settings modal
Â  Â  Â  Â  populateAndInitCountdownDropdown('overview-countdown-select-wrapper', (value) => {
Â  Â  Â  Â  Â  Â  localStorage.setItem(getStorageKey('selectedDashboardCountdownId'), value);
Â  Â  Â  Â  Â  Â  if(window.updateDashboardCountdownDisplay) window.updateDashboardCountdownDisplay();
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // --- WIDGET TEMPLATES & LOGIC ---
Â  Â  const availableCardTemplates = [
Â  Â  Â  {
Â  Â  Â  Â  templateId: 'time_weather_super_widget', title: 'Overview', icon: 'ğŸŒ', type: 'full',
Â  Â  Â  Â  onMount: async (cardElement) => {
Â  Â  Â  Â  Â  Â  const timeEl = cardElement.querySelector('#clockTime');
Â  Â  Â  Â  Â  Â  const dateEl = cardElement.querySelector('#clockDate');
Â  Â  Â  Â  Â  Â  const dayOfYearEl = cardElement.querySelector('#clockDayOfYear');
Â  Â  Â  Â  Â  Â  const weekNumEl = cardElement.querySelector('#clockWeekNum');
Â  Â  Â  Â  Â  Â  const fullscreenBtn = cardElement.querySelector('.clock-fullscreen-btn');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  function updateClock() {
Â  Â  Â  Â  Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  Â  Â  Â  Â  timeEl.textContent = now.toLocaleTimeString();
Â  Â  Â  Â  Â  Â  Â  Â  dateEl.textContent = now.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
Â  Â  Â  Â  Â  Â  Â  Â  const start = new Date(now.getFullYear(), 0, 0);
Â  Â  Â  Â  Â  Â  Â  Â  const diff = (now - start) + ((start.getTimezoneOffset() - now.getTimezoneOffset()) * 60 * 1000);
Â  Â  Â  Â  Â  Â  Â  Â  const oneDay = 1000 * 60 * 60 * 24;
Â  Â  Â  Â  Â  Â  Â  Â  const dayOfYear = Math.floor(diff / oneDay);
Â  Â  Â  Â  Â  Â  Â  Â  if (dayOfYearEl) dayOfYearEl.textContent = `Day: ${dayOfYear}`;
Â  Â  Â  Â  Â  Â  Â  Â  const tempDate = new Date(now.valueOf());
Â  Â  Â  Â  Â  Â  Â  Â  tempDate.setDate(tempDate.getDate() + 3 - (tempDate.getDay() + 6) % 7);
Â  Â  Â  Â  Â  Â  Â  Â  const week1 = new Date(tempDate.getFullYear(), 0, 4);
Â  Â  Â  Â  Â  Â  Â  Â  const weekNumber = 1 + Math.round(((tempDate.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
Â  Â  Â  Â  Â  Â  Â  Â  if (weekNumEl) weekNumEl.textContent = `Week: ${weekNumber}`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  updateClock(); setInterval(updateClock, 1000);
Â  Â  Â  Â  Â  Â  if (fullscreenBtn) fullscreenBtn.addEventListener('click', openClockFullscreen);

Â  Â  Â  Â  Â  Â  const countdownNameEl = cardElement.querySelector('.dashboard-countdown-display-name');
Â  Â  Â  Â  Â  Â  const countdownTimerEl = cardElement.querySelector('.dashboard-countdown-display-timer');
Â  Â  Â  Â  Â  Â  const countdownSectionEl = cardElement.querySelector('.dashboard-countdown-section');
Â  Â  Â  Â  Â  Â  const additionalInfoEl = cardElement.querySelector('.additional-time-info');
Â  Â  Â  Â  Â  Â  window.dashboardCountdownTimeout = null;

Â  Â  Â  Â  Â  Â  function renderCountdownInDashboard(id) {
Â  Â  Â  Â  Â  Â  Â  Â  clearTimeout(window.dashboardCountdownTimeout);
Â  Â  Â  Â  Â  Â  Â  Â  if (!id) { countdownSectionEl.style.display = 'none'; additionalInfoEl.style.display = 'block'; return; }

Â  Â  Â  Â  Â  Â  Â  Â  const countdowns = JSON.parse(localStorage.getItem(getStorageKey('countdowns')) || '[]');
Â  Â  Â  Â  Â  Â  Â  Â  const groups = JSON.parse(localStorage.getItem(getStorageKey('countdownGroups')) || '[]');
Â  Â  Â  Â  Â  Â  Â  Â  let displayCountdown;
Â  Â  Â  Â  Â  Â  Â  Â  let displayName;

Â  Â  Â  Â  Â  Â  Â  Â  if (id.startsWith('group_')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const groupId = id.replace('group_', '');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const group = groups.find(g => g.id === groupId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!group) { countdownSectionEl.style.display = 'none'; additionalInfoEl.style.display = 'block'; return; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayName = group.name;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayCountdown = group.countdownIds
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .map(cid => countdowns.find(cd => cd.id === cid))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .filter(cd => cd && cd.repeat)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .map(cd => ({...cd, nextOccurrence: calculateNextOccurrence(cd)}))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .filter(cd => cd.nextOccurrence > now)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .sort((a,b) => a.nextOccurrence - b.nextOccurrence)[0];
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayCountdown = countdowns.find(cd => cd.id === id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (displayCountdown) displayName = displayCountdown.name;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (!displayCountdown || new Date(displayCountdown.targetTimestamp) <= new Date() && !displayCountdown.repeat) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  countdownSectionEl.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  additionalInfoEl.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  countdownSectionEl.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  additionalInfoEl.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  countdownNameEl.textContent = displayName;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const tick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const target = calculateNextOccurrence(displayCountdown);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const formattedTime = formatCountdown(target);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  countdownTimerEl.innerHTML = formattedTime;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (formattedTime.includes("Finished")) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearTimeout(window.dashboardCountdownTimeout);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (id.startsWith('group_')) { setTimeout(() => renderCountdownInDashboard(id), 1000); }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const msUntilNextSecond = 1000 - new Date().getMilliseconds();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.dashboardCountdownTimeout = setTimeout(tick, msUntilNextSecond);
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  tick();
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  window.updateDashboardCountdownDisplay = () => {
Â  Â  Â  Â  Â  Â  Â  Â  const savedId = localStorage.getItem(getStorageKey('selectedDashboardCountdownId'));
Â  Â  Â  Â  Â  Â  Â  Â  renderCountdownInDashboard(savedId);
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  window.updateDashboardCountdownDisplay();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const refreshBtn = cardElement.querySelector('.weather-refresh-btn'), settingsBtn = cardElement.querySelector('.overview-settings-btn');
Â  Â  Â  Â  Â  Â  window.renderWeatherErrorInDashboard = (message) => {
Â  Â  Â  Â  Â  Â  Â  Â  const els = { c: cardElement.querySelector('.condition-large'), i: cardElement.querySelector('.weather-icon-large'), t: cardElement.querySelector('.temp-large'), f: cardElement.querySelector('.forecast-large') };
Â  Â  Â  Â  Â  Â  Â  Â  if(els.c) els.c.textContent = message; if(els.i) els.i.textContent = 'âš ï¸'; if(els.t) els.t.textContent = '--Â°'; if(els.f) els.f.innerHTML = `<p style="color:red;font-size:0.9em;">${message}</p>`;
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  window.renderWeatherInDashboard = (data) => {
Â  Â  Â  Â  Â  Â  Â  Â  const {units, location} = weatherSettings; const tempS = units === 'metric' ? 'Â°C' : 'Â°F';
Â  Â  Â  Â  Â  Â  Â  Â  const cw = data.current; const codeInfo = WMO_CODES[cw.weather_code] || {d: "Unknown", i: "â“"};
Â  Â  Â  Â  Â  Â  Â  Â  cardElement.querySelector('.temp-large').textContent = `${Math.round(cw.temperature_2m)}${tempS}`;
Â  Â  Â  Â  Â  Â  Â  Â  cardElement.querySelector('.weather-icon-large').textContent = codeInfo.i;
Â  Â  Â  Â  Â  Â  Â  Â  cardElement.querySelector('.condition-large').textContent = codeInfo.d;
Â  Â  Â  Â  Â  Â  Â  Â  cardElement.querySelector('.feels-like-value').textContent = `${Math.round(cw.apparent_temperature)}${tempS}`;
Â  Â  Â  Â  Â  Â  Â  Â  cardElement.querySelector('.humidity-value').textContent = `${cw.relative_humidity_2m}%`;
Â  Â  Â  Â  Â  Â  Â  Â  cardElement.querySelector('.wind-value').textContent = `${Math.round(cw.wind_speed_10m)} ${units === 'metric' ? 'km/h' : 'mph'}`;
Â  Â  Â  Â  Â  Â  Â  Â  cardElement.querySelector('.location-large').textContent = location.label;
Â  Â  Â  Â  Â  Â  Â  Â  const forecastEl = cardElement.querySelector('.forecast-large'); forecastEl.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  if (data.daily?.time?.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data.daily.time.forEach((dateStr, i) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dayCodeInfo = WMO_CODES[data.daily.weather_code[i]] || { i: "â“" };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dayDiv = document.createElement('div'); dayDiv.className = 'forecast-day'; dayDiv.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  openForecastModal({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dateStr, feelsLike: cw.apparent_temperature, humidity: cw.relative_humidity_2m,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  weatherCode: data.daily.weather_code[i], tempMax: data.daily.temperature_2m_max[i], tempMin: data.daily.temperature_2m_min[i],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  precipSum: data.daily.precipitation_sum?.[i], precipProb: data.daily.precipitation_probability_max?.[i], windSpeedMax: data.daily.wind_speed_10m_max?.[i],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sunrise: data.daily.sunrise?.[i], sunset: data.daily.sunset?.[i], daylightDuration: data.daily.daylight_duration?.[i], windDirection: data.daily.wind_direction_10m_dominant?.[i],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  uvIndexMax: data.daily.uv_index_max?.[i]
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dayName = i === 0 ? "Today" : new Date(dateStr + 'T12:00:00Z').toLocaleDateString(undefined, { weekday: 'short', timeZone: 'UTC' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dayDiv.innerHTML = `<span class="day-name">${dayName}</span><span class="icon">${dayCodeInfo.i}</span><span class="temps">${Math.round(data.daily.temperature_2m_max[i])}Â°/${Math.round(data.daily.temperature_2m_min[i])}Â°</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  forecastEl.appendChild(dayDiv);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  updateFullscreenWeatherDisplay();
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  async function initializeWeather() {
Â  Â  Â  Â  Â  Â  Â  Â  await determineUserCountry();
Â  Â  Â  Â  Â  Â  Â  Â  loadWeatherSettings();
Â  Â  Â  Â  Â  Â  Â  Â  loadGeneralSettings();
Â  Â  Â  Â  Â  Â  Â  Â  const settingsLoaded = localStorage.getItem(getStorageKey('weatherWidgetSettings'));
Â  Â  Â  Â  Â  Â  Â  Â  if (!settingsLoaded && navigator.geolocation) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  navigator.geolocation.getCurrentPosition(
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  async (pos) => { userCoords = { lat: pos.coords.latitude, lon: pos.coords.longitude }; const { label, country_code } = await fetchCityName(userCoords.lat, userCoords.lon); weatherSettings.location = { label, latitude: userCoords.lat, longitude: userCoords.lon }; weatherSettings.units = (country_code === 'us' || !country_code) ? 'imperial' : 'metric'; saveWeatherSettings(); await fetchWeather(); },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  async () => { showNotification(`Could not find you. Defaulting to NY.`, 'info'); await fetchWeather(); }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  Â  } else { await fetchWeather(); }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (settingsBtn) settingsBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  const modal = document.getElementById('overviewSettingsModal');
Â  Â  Â  Â  Â  Â  Â  Â  modal.classList.add('modal-open');
Â  Â  Â  Â  Â  Â  Â  Â  populateAllCountdownDropdowns();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // General settings
Â  Â  Â  Â  Â  Â  Â  Â  const titleWrapper = document.getElementById('title-display-select-wrapper');
Â  Â  Â  Â  Â  Â  Â  Â  const savedTitleDisplay = generalSettings.titleDisplay || 'none';
Â  Â  Â  Â  Â  Â  Â  Â  const titleOption = titleWrapper.querySelector(`.custom-option[data-value="${savedTitleDisplay}"]`);
Â  Â  Â  Â  Â  Â  Â  Â  if(titleOption) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  titleWrapper.querySelector('.selected')?.classList.remove('selected');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  titleOption.classList.add('selected');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  titleWrapper.querySelector('.custom-select-trigger span').textContent = titleOption.textContent;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  initializeCustomSelect(titleWrapper, (value) => { generalSettings.titleDisplay = value; saveGeneralSettings(); });
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('fullscreenWeatherToggle').checked = weatherSettings.showWeatherInFullscreen;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Weather settings
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('overviewLocationInput').value = weatherSettings.location.label;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('overviewUnitToggle').checked = weatherSettings.units === 'metric';
Â  Â  Â  Â  Â  Â  Â  Â  document.querySelector(`input[name="dataSource"][value="${weatherSettings.dataSource}"]`).checked = true;
Â  Â  Â  Â  Â  Â  Â  Â  window.updateNWSAvailability();
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  if (refreshBtn) refreshBtn.addEventListener('click', fetchWeather);
Â  Â  Â  Â  Â  Â  initializeWeather(); setInterval(fetchWeather, 30 * 60 * 1000);
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  templateId: 'stopwatch_widget', title: 'Stopwatch', icon: 'â±ï¸', type: 'small',
Â  Â  Â  Â  onMount: (cardElement) => {
Â  Â  Â  Â  Â  Â  const STORAGE_KEY = getStorageKey('stopwatchState_v4');
Â  Â  Â  Â  Â  Â  const display = cardElement.querySelector('.stopwatch-display');
Â  Â  Â  Â  Â  Â  const startBtn = cardElement.querySelector('button[data-action="start"]');
Â  Â  Â  Â  Â  Â  const pauseBtn = cardElement.querySelector('button[data-action="pause"]');
Â  Â  Â  Â  Â  Â  const resetBtn = cardElement.querySelector('button[data-action="reset"]');
Â  Â  Â  Â  Â  Â  let state = { startTime: null, elapsedTime: 0, isRunning: false };
Â  Â  Â  Â  Â  Â  let intervalId = null;
Â  Â  Â  Â  Â  Â  function saveState() { const dataToSave = { elapsedTime: state.elapsedTime, isRunning: state.isRunning, startTime: state.isRunning ? state.startTime : null }; localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave)); }
Â  Â  Â  Â  Â  Â  function formatTime(ms) { const totalSeconds = Math.floor(ms / 1000); const centiseconds = Math.floor((ms % 1000) / 10).toString().padStart(2, '0'); const hours = Math.floor(totalSeconds / 3600); const minutes = Math.floor((totalSeconds % 3600) / 60); const seconds = totalSeconds % 60; return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}.${centiseconds}`; }
Â  Â  Â  Â  Â  Â  function updateDisplay() { const totalElapsed = state.elapsedTime + (state.isRunning ? (Date.now() - state.startTime) : 0); display.textContent = formatTime(totalElapsed); }
Â  Â  Â  Â  Â  Â  function start() { if (state.isRunning) return; state.isRunning = true; state.startTime = Date.now(); startBtn.style.display = 'none'; pauseBtn.style.display = 'inline-block'; intervalId = setInterval(updateDisplay, 50); saveState(); }
Â  Â  Â  Â  Â  Â  function pause() { if (!state.isRunning) return; clearInterval(intervalId); state.elapsedTime += Date.now() - state.startTime; state.isRunning = false; startBtn.style.display = 'inline-block'; pauseBtn.style.display = 'none'; saveState(); }
Â  Â  Â  Â  Â  Â  function reset() { clearInterval(intervalId); state = { startTime: null, elapsedTime: 0, isRunning: false }; localStorage.removeItem(STORAGE_KEY); updateDisplay(); startBtn.style.display = 'inline-block'; pauseBtn.style.display = 'none'; }
Â  Â  Â  Â  Â  Â  function loadState() { const saved = JSON.parse(localStorage.getItem(STORAGE_KEY)); if (!saved) return; state.elapsedTime = saved.elapsedTime || 0; if (saved.isRunning && saved.startTime) { state.elapsedTime += Date.now() - saved.startTime; start(); } else { updateDisplay(); } }
Â  Â  Â  Â  Â  Â  startBtn.addEventListener('click', start); pauseBtn.addEventListener('click', pause); resetBtn.addEventListener('click', reset);
Â  Â  Â  Â  Â  Â  loadState();
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  templateId: 'timer_widget', title: 'Timer', icon: 'âŒ›', type: 'small',
Â  Â  Â  Â  onMount: (cardElement) => {
Â  Â  Â  Â  Â  Â  const STORAGE_KEY = getStorageKey('timerState_v4');
Â  Â  Â  Â  Â  Â  const inputs = ['w', 'd', 'h', 'm', 's'].map(id => cardElement.querySelector(`#timer-${id}`));
Â  Â  Â  Â  Â  Â  const display = cardElement.querySelector('.timer-display-value');
Â  Â  Â  Â  Â  Â  const inputsContainer = cardElement.querySelector('.timer-inputs');
Â  Â  Â  Â  Â  Â  const startBtn = cardElement.querySelector('button[data-action="start"]');
Â  Â  Â  Â  Â  Â  const pauseBtn = cardElement.querySelector('button[data-action="pause"]');
Â  Â  Â  Â  Â  Â  const resetBtn = cardElement.querySelector('button[data-action="reset"]');
Â  Â  Â  Â  Â  Â  let state = { targetTime: null, remainingTime: 0, isRunning: false };
Â  Â  Â  Â  Â  Â  let intervalId = null;
Â  Â  Â  Â  Â  Â  function formatTime(ms) { if (ms < 0) ms = 0; const s = Math.round(ms / 1000); const w = Math.floor(s / 604800); const d = Math.floor((s % 604800) / 86400); const h = Math.floor((s % 86400) / 3600); const m = Math.floor((s % 3600) / 60); const secs = s % 60; const p = (n) => String(n).padStart(2,'0'); if(w > 0) return `${w}:${p(d)}:${p(h)}:${p(m)}:${p(secs)}`; if(d > 0) return `${d}:${p(h)}:${p(m)}:${p(secs)}`; return `${p(h)}:${p(m)}:${p(secs)}`; }
Â  Â  Â  Â  Â  Â  function updateDisplay() { const remaining = state.isRunning ? state.targetTime - Date.now() : state.remainingTime; display.textContent = formatTime(remaining); if (state.isRunning && remaining <= 0) finish(); }
Â  Â  Â  Â  Â  Â  function updateFromInputs() { if (state.isRunning) return; const [w, d, h, m, s] = inputs.map(input => parseInt(input.value) || 0); state.remainingTime = (w * 604800 + d * 86400 + h * 3600 + m * 60 + s) * 1000; updateDisplay(); }
Â  Â  Â  Â  Â  Â  function toggleUI(isRunning) { inputsContainer.classList.toggle('hidden', isRunning); startBtn.style.display = isRunning ? 'none' : 'inline-block'; pauseBtn.style.display = isRunning ? 'inline-block' : 'none'; }
Â  Â  Â  Â  Â  Â  function start() { if (state.isRunning) return; if (state.remainingTime <= 0) { showNotification("Please set a timer duration.", "info"); return; } state.isRunning = true; state.targetTime = Date.now() + state.remainingTime; intervalId = setInterval(updateDisplay, 100); toggleUI(true); localStorage.setItem(STORAGE_KEY, JSON.stringify({ targetTime: state.targetTime })); }
Â  Â  Â  Â  Â  Â  function pause() { if (!state.isRunning) return; clearInterval(intervalId); state.remainingTime = state.targetTime - Date.now(); state.isRunning = false; toggleUI(false); localStorage.setItem(STORAGE_KEY, JSON.stringify({ remainingTime: state.remainingTime })); }
Â  Â  Â  Â  Â  Â  function reset() { clearInterval(intervalId); state.isRunning = false; toggleUI(false); inputs.forEach(input => input.value = '0'); updateFromInputs(); localStorage.removeItem(STORAGE_KEY); }
Â  Â  Â  Â  Â  Â  function finish() { showNotification('Timer Finished!', 'success'); try { new Audio('https://interactive-examples.mdn.mozilla.net/media/cc0-audio/bell-ringing-01.mp3').play(); } catch(e) {} reset(); }
Â  Â  Â  Â  Â  Â  function loadState() { const saved = JSON.parse(localStorage.getItem(STORAGE_KEY)); if (!saved) { updateFromInputs(); return; }; if (saved.targetTime) { state.remainingTime = saved.targetTime - Date.now(); if (state.remainingTime > 0) start(); else reset(); } else if (saved.remainingTime) { state.remainingTime = saved.remainingTime; updateDisplay(); } }
Â  Â  Â  Â  Â  Â  inputs.forEach(input => input.addEventListener('input', updateFromInputs));
Â  Â  Â  Â  Â  Â  startBtn.addEventListener('click', start); pauseBtn.addEventListener('click', pause); resetBtn.addEventListener('click', reset);
Â  Â  Â  Â  Â  Â  loadState();
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  templateId: 'quick_actions_widget', title: 'Shortcuts', icon: 'âš¡', type: 'small',
Â  Â  Â  Â  onMount: (cardElement) => {
Â  Â  Â  Â  Â  Â  const settingsBtn = cardElement.querySelector('.quick-actions-settings-btn');
Â  Â  Â  Â  Â  Â  const contentContainer = cardElement.querySelector('.quick-actions-list');
Â  Â  Â  Â  Â  Â  const renderAndAttachListeners = (actions) => {
Â  Â  Â  Â  Â  Â  Â  Â  contentContainer.innerHTML = actions.map(action => `<button data-type="${action.type}" data-value="${action.value}"><span class="icon">${action.icon}</span><span class="text">${action.text}</span><span class="arrow">â†’</span></button>`).join('');
Â  Â  Â  Â  Â  Â  Â  Â  contentContainer.querySelectorAll('button').forEach(btn => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.addEventListener('click', () => { const { type, value } = btn.dataset; if (type === 'url') { window.open(value, '_blank'); } else if (type === 'page') { const page = pageSuggestions.find(p => p.url === value); if (page && page.action) { page.action(); } else { window.location.href = value; } } });
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  const updateUI = () => { const saved = localStorage.getItem(getStorageKey('quickActions_v1')); currentQuickActions = saved ? JSON.parse(saved) : [...defaultQuickActions]; renderAndAttachListeners(currentQuickActions); };
Â  Â  Â  Â  Â  Â  window.updateQuickActionsWidget = updateUI;
Â  Â  Â  Â  Â  Â  updateUI();
Â  Â  Â  Â  Â  Â  if (settingsBtn) { settingsBtn.addEventListener('click', () => { populateShortcutSettingsForm(); document.getElementById('shortcutSettingsModal').classList.add('modal-open'); }); }
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  ];
Â  Â Â 
Â  Â  function getContentGenerator(templateId) {
Â  Â  Â  Â  switch (templateId) {
Â  Â  Â  Â  Â  Â  case 'time_weather_super_widget': return () => `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="super-widget-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="super-widget-clock-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="clock-display" id="clockTime">00:00:00</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="date-display" id="clockDate"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="additional-time-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="clockDayOfYear">Day: ---</span> | <span id="clockWeekNum">Week: --</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="dashboard-countdown-section" style="display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="dashboard-countdown-display-name"></h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="dashboard-countdown-display-timer"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="super-widget-weather-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="weather-large-content">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="current-weather-layout">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="weather-icon-large"></span> <div class="current-weather-main-info"> <span class="temp-large"></span> <span class="condition-large"></span> </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="current-weather-details-aside"> <p>Feels like: <span class="feels-like-value"></span></p> <p>Humidity: <span class="humidity-value"></span></p> <p>Wind: <span class="wind-value"></span></p> <p>Location: <span class="location-large"></span></p> </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div> <div class="forecast-large"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  case 'stopwatch_widget': return () => `<div class="stopwatch-display">00:00:00.00</div><div class="controls-flex"><button data-action="start">Start</button><button data-action="pause" style="display:none;">Pause</button><button data-action="reset">Reset</button></div>`;
Â  Â  Â  Â  Â  Â  case 'timer_widget': return () => `<div class="timer-display-value">00:00:00</div><div class="timer-inputs"><input type="number" id="timer-w" placeholder="W" min="0" max="1" value="0">:<input type="number" id="timer-d" placeholder="D" min="0" max="6" value="0">:<input type="number" id="timer-h" placeholder="HH" min="0" max="23" value="0">:<input type="number" id="timer-m" placeholder="MM" min="0" max="59" value="0">:<input type="number" id="timer-s" placeholder="SS" min="0" max="59" value="0"></div><div class="controls-flex"><button data-action="start">Start</button><button data-action="pause" style="display:none;">Pause</button><button data-action="reset">Reset</button></div>`;
Â  Â  Â  Â  Â  Â  case 'quick_actions_widget': return () => `<div class="quick-actions-list"></div>`;
Â  Â  Â  Â  Â  Â  default: return () => '';
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  function createCardDOMElement(t){const c=document.createElement('div');c.className='dashboard-card';c.dataset.templateId=t.templateId;c.dataset.cardType=t.type||'full';c.innerHTML=`<div class="card-header"><div class="card-icon">${t.icon}</div><h4 class="card-title">${t.title}</h4><div class="card-header-buttons"></div></div><div class="card-content-inner">${getContentGenerator(t.templateId)()}</div>`;const b=c.querySelector('.card-header-buttons');if(t.templateId==='time_weather_super_widget'){b.innerHTML=`<button class="weather-action-btn overview-settings-btn" title="Overview Settings"><img src="../images/gear-dark.png"></button><button class="weather-action-btn weather-refresh-btn" title="Refresh Weather"><img src="../images/refresh-dark.png"></button><button class="weather-action-btn clock-fullscreen-btn" title="Fullscreen Clock"><img src="../images/zoom-in-dark.png"></button>`}else if(t.templateId==='quick_actions_widget'){b.innerHTML=`<button class="weather-action-btn quick-actions-settings-btn" title="Edit Shortcuts"><img src="../images/gear-dark.png"></button>`}if(t.onMount){setTimeout(()=>{try{t.onMount(c)}catch(e){console.error(`Error onMount for ${t.templateId}:`,e);c.querySelector('.card-content-inner').innerHTML=`<p style="color:red;">Failed to load widget.</p>`}},0)}return c}
Â  Â  function renderDashboardLayout(){const l=getDashboardLayout();dashboardGrid.innerHTML='';l.forEach(id=>{const t=availableCardTemplates.find(t=>t.templateId===id);if(t)dashboardGrid.appendChild(createCardDOMElement(t))});dashboardGrid.querySelectorAll('.dashboard-card').forEach((c,i)=>{c.style.animation='none';c.offsetHeight;c.style.animation=`fadeIn 0.4s ease-out ${i*0.05}s forwards`})}
Â  Â  function getDashboardLayout(){const s=localStorage.getItem(dashboardLayoutStorageKey);if(s){try{const p=JSON.parse(s);if(Array.isArray(p)&&p.length>0)return p}catch(e){}}return[...defaultDashboardLayout]}
Â  Â  function showNotification(message,type='info',duration=3000){const n=document.createElement('div');n.className=`notification ${type}`;n.textContent=message;Object.assign(n.style,{position:'fixed',bottom:'20px',right:'20px',padding:'12px 20px',borderRadius:'8px',color:'white',fontWeight:'600',zIndex:'10000',transform:'translateY(150%)',transition:'transform 0.4s ease-in-out',background:type==='success'?'linear-gradient(135deg,#28a745,#20c997)':type==='error'?'linear-gradient(135deg,#dc3545,#e83e8c)':'linear-gradient(135deg,#6720bd,#8a2be2)'});document.body.appendChild(n);setTimeout(()=>{n.style.transform='translateY(0)'},100);setTimeout(()=>{n.style.transform='translateY(150%)';setTimeout(()=>{if(document.body.contains(n))document.body.removeChild(n)},400)},duration)}

Â  Â  // --- CUSTOM SELECT DROPDOWN LOGIC ---
Â  Â  function initializeCustomSelect(wrapper, onChangeCallback) {
Â  Â  Â  Â  if (wrapper.dataset.customSelectInitialized) return;
Â  Â  Â  Â  const select = wrapper.querySelector('.custom-select');
Â  Â  Â  Â  const trigger = select.querySelector('.custom-select-trigger');
Â  Â  Â  Â  const optionsContainer = select.querySelector('.custom-options');

Â  Â  Â  Â  const handleTriggerClick = (e) => { e.stopPropagation(); select.classList.toggle('open'); };
Â  Â  Â  Â  const handleOptionClick = (e) => {
Â  Â  Â  Â  Â  Â  const option = e.target.closest('.custom-option');
Â  Â  Â  Â  Â  Â  if (option) {
Â  Â  Â  Â  Â  Â  Â  Â  const value = option.dataset.value;
Â  Â  Â  Â  Â  Â  Â  Â  const text = option.textContent;
Â  Â  Â  Â  Â  Â  Â  Â  if (optionsContainer.querySelector('.selected')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  optionsContainer.querySelector('.selected').classList.remove('selected');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  option.classList.add('selected');
Â  Â  Â  Â  Â  Â  Â  Â  trigger.querySelector('span').textContent = text;
Â  Â  Â  Â  Â  Â  Â  Â  select.classList.remove('open');
Â  Â  Â  Â  Â  Â  Â  Â  if (onChangeCallback) onChangeCallback(value);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  trigger.addEventListener('click', handleTriggerClick);
Â  Â  Â  Â  optionsContainer.addEventListener('click', handleOptionClick);
Â  Â  Â  Â  wrapper.dataset.customSelectInitialized = true;
Â  Â  }
Â  Â  document.addEventListener('click', () => { document.querySelectorAll('.custom-select.open').forEach(select => select.classList.remove('open')); });

Â  Â  // --- SHORTCUTS SETTINGS LOGIC ---
Â  Â  function populateShortcutSettingsForm() {
Â  Â  Â  Â  const form = document.getElementById('shortcutSettingsForm');
Â  Â  Â  Â  form.innerHTML = '';
Â  Â  Â  Â  currentQuickActions.forEach((action, index) => {
Â  Â  Â  Â  Â  Â  const group = document.createElement('div');
Â  Â  Â  Â  Â  Â  group.className = 'shortcut-editor-group';
Â  Â  Â  Â  Â  Â  group.innerHTML = `<h4>Shortcut ${index + 1}</h4><div class="shortcut-input-row"><label>Icon</label><input type="text" class="shortcut-emoji-input" value="${action.icon}" maxlength="2"><label>Name</label><input type="text" class="shortcut-name-input" value="${action.text}"></div><div class="shortcut-input-row"><label>Action Type</label><select class="shortcut-action-type-select"><option value="url" ${action.type === 'url' ? 'selected' : ''}>Go to URL</option><option value="page" ${action.type === 'page' ? 'selected' : ''}>Go to Page</option></select></div><div class="shortcut-input-row action-target-wrapper"><label class="url-label ${action.type !== 'url' ? 'hidden' : ''}">URL</label><input type="url" class="shortcut-url-input ${action.type !== 'url' ? 'hidden' : ''}" value="${action.type === 'url' ? action.value : 'https://'}" placeholder="https://example.com"><label class="page-label ${action.type !== 'page' ? 'hidden' : ''}">Page</label><select class="shortcut-page-select ${action.type !== 'page' ? 'hidden' : ''}">${pageSuggestions.map(p => `<option value="${p.url}" ${action.type === 'page' && action.value === p.url ? 'selected' : ''}>${p.name}</option>`).join('')}</select></div>`;
Â  Â  Â  Â  Â  Â  form.appendChild(group);
Â  Â  Â  Â  });
Â  Â  Â  Â  form.querySelectorAll('.shortcut-action-type-select').forEach(select => {
Â  Â  Â  Â  Â  Â  select.addEventListener('change', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  const wrapper = e.target.closest('.shortcut-editor-group').querySelector('.action-target-wrapper');
Â  Â  Â  Â  Â  Â  Â  Â  const isUrl = e.target.value === 'url';
Â  Â  Â  Â  Â  Â  Â  Â  wrapper.querySelector('.url-label').classList.toggle('hidden', !isUrl); wrapper.querySelector('.shortcut-url-input').classList.toggle('hidden', !isUrl); wrapper.querySelector('.page-label').classList.toggle('hidden', isUrl); wrapper.querySelector('.shortcut-page-select').classList.toggle('hidden', isUrl);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  }
Â  Â  function saveShortcutSettings() {
Â  Â  Â  Â  const newActions = [];
Â  Â  Â  Â  document.getElementById('shortcutSettingsForm').querySelectorAll('.shortcut-editor-group').forEach(group => {
Â  Â  Â  Â  Â  Â  const type = group.querySelector('.shortcut-action-type-select').value;
Â  Â  Â  Â  Â  Â  newActions.push({ icon: group.querySelector('.shortcut-emoji-input').value, text: group.querySelector('.shortcut-name-input').value, type: type, value: type === 'url' ? group.querySelector('.shortcut-url-input').value : group.querySelector('.shortcut-page-select').value });
Â  Â  Â  Â  });
Â  Â  Â  Â  localStorage.setItem(getStorageKey('quickActions_v1'), JSON.stringify(newActions));
Â  Â  Â  Â  currentQuickActions = newActions;
Â  Â  Â  Â  window.updateQuickActionsWidget();
Â  Â  Â  Â  document.getElementById('shortcutSettingsModal').classList.remove('modal-open');
Â  Â  Â  Â  showNotification("Shortcuts saved!", "success");
Â  Â  }
Â  Â  function resetShortcutSettings() {
Â  Â  Â  Â  localStorage.removeItem(getStorageKey('quickActions_v1'));
Â  Â  Â  Â  currentQuickActions = [...defaultQuickActions];
Â  Â  Â  Â  populateShortcutSettingsForm();
Â  Â  Â  Â  showNotification("Shortcuts reset to default.", "info");
Â  Â  }

Â  Â  // --- LOCATION HELPER FUNCTIONS ---
Â  Â  function getShortLocationLabel(address, fullDisplayName) {
Â  Â  Â  Â  if (!address) return fullDisplayName;
Â  Â  Â  Â  const city = address.city || address.town || address.village || address.hamlet;
Â  Â  Â  Â  if (address.road && city) { return `${address.road}, ${city}`; }
Â  Â  Â  Â  if (city && address.state) { return `${city}, ${address.state}`; }
Â  Â  Â  Â  if (city && address.country) { return `${city}, ${address.country}`; }
Â  Â  Â  Â  if (city) { return city; }
Â  Â  Â  Â  return fullDisplayName;
Â  Â  }

Â  Â  async function fetchCityName(lat, lon) {
Â  Â  Â  Â  const nominatimUrl = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`;
Â  Â  Â  Â  const fallbackLabel = `Lat: ${parseFloat(lat).toFixed(2)}, Lon: ${parseFloat(lon).toFixed(2)}`;
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const response = await fetch(nominatimUrl);
Â  Â  Â  Â  Â  Â  if (!response.ok) { console.warn(`Nominatim API error: ${response.status}`); return { label: fallbackLabel, country_code: 'us' }; }
Â  Â  Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  Â  Â  if (data && data.address) { const label = getShortLocationLabel(data.address, data.display_name); return { label, country_code: data.address.country_code || 'us' }; }
Â  Â  Â  Â  Â  Â  return { label: fallbackLabel, country_code: 'us' };
Â  Â  Â  Â  } catch (error) { console.error("Error fetching city name:", error); return { label: fallbackLabel, country_code: 'us' }; }
Â  Â  }

Â  Â  // --- INITIALIZATION ---
Â  Â  document.addEventListener('DOMContentLoaded', () => {
        firebase.auth().onAuthStateChanged(user => { 
            if (!user) {
                // If you are testing locally and not using Firebase Auth,
                // you can comment out the next line to prevent redirection.
                // location.href = '../login.html';
                
                // For local testing without login, run these functions directly:
                loadGeneralSettings(); 
                renderDashboardLayout();
                if (browserTitleInterval) clearInterval(browserTitleInterval);
                browserTitleInterval = setInterval(updateBrowserTitle, 1000);
            } else {
                loadGeneralSettings(); 
                renderDashboardLayout();
                if (browserTitleInterval) clearInterval(browserTitleInterval);
                browserTitleInterval = setInterval(updateBrowserTitle, 1000);
            }
        });

Â  Â  Â  Â  document.getElementById('logoutBtn').addEventListener('click', () => firebase.auth().signOut());
Â  Â  Â  Â  document.getElementById('signOutLink').addEventListener('click', (e) => { e.preventDefault(); firebase.auth().signOut(); });
Â  Â  Â  Â  document.getElementById('toggleSidebar').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('collapsed'));
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Modal Handling
Â  Â  Â  Â  const settingsModal = document.getElementById('overviewSettingsModal');
Â  Â  Â  Â  document.querySelectorAll('.modal').forEach(modal => {
Â  Â  Â  Â  Â  Â  const closeBtn = modal.querySelector('.modal-close-btn');
Â  Â  Â  Â  Â  Â  const isSettingsModal = modal.id === 'overviewSettingsModal';
Â  Â  Â  Â  Â  Â  const closeModal = () => { modal.classList.remove('modal-open'); if(isSettingsModal) fetchWeather(); };
Â  Â  Â  Â  Â  Â  if(closeBtn) closeBtn.addEventListener('click', closeModal);
Â  Â  Â  Â  Â  Â  modal.addEventListener('click', (e) => { if(e.target === modal) closeModal(); });
Â  Â  Â  Â  });

Â  Â  Â  Â  // Settings Modal Sliding Tab Logic
Â  Â  Â  Â  const tabButtons = settingsModal.querySelectorAll('.tab-button');
Â  Â  Â  Â  const tabPanelContainer = settingsModal.querySelector('.tab-panels-container');
Â  Â  Â  Â  settingsModal.querySelector('.settings-tabs').addEventListener('click', e => {
Â  Â  Â  Â  Â  Â  const clickedButton = e.target.closest('.tab-button');
Â  Â  Â  Â  Â  Â  if (clickedButton) {
Â  Â  Â  Â  Â  Â  Â  Â  const tabIndex = Array.from(tabButtons).indexOf(clickedButton);
Â  Â  Â  Â  Â  Â  Â  Â  tabButtons.forEach(btn => btn.classList.remove('active'));
Â  Â  Â  Â  Â  Â  Â  Â  clickedButton.classList.add('active');
Â  Â  Â  Â  Â  Â  Â  Â  if (tabPanelContainer) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tabPanelContainer.style.transform = `translateX(-${tabIndex * 100}%)`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // Countdown Creation Modal
Â  Â  Â  Â  const dateTimePicker = flatpickr("#newCountdownDateTime", { enableTime: true, dateFormat: "Y-m-d H:i", minDate: "today" });
Â  Â  Â  Â  document.getElementById('saveNewCountdownBtn').addEventListener('click', () => { const name = document.getElementById('newCountdownName').value.trim(); const dateTime = dateTimePicker.selectedDates[0]; if (!name || !dateTime) { showNotification("Please provide a name and a future date.", "error"); return; } const newCountdown = { id: `cd_${Date.now()}`, name, targetTimestamp: dateTime.toISOString() }; const key = getStorageKey('countdowns'); const countdowns = JSON.parse(localStorage.getItem(key) || '[]'); countdowns.push(newCountdown); localStorage.setItem(key, JSON.stringify(countdowns)); showNotification("Countdown saved!", "success"); document.getElementById('newCountdownModal').classList.remove('modal-open'); document.getElementById('newCountdownName').value = ''; dateTimePicker.clear(); populateAllCountdownDropdowns(); if (window.updateDashboardCountdownDisplay) window.updateDashboardCountdownDisplay(); });
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Shortcut Settings
Â  Â  Â  Â  document.getElementById('saveShortcutsBtn').addEventListener('click', saveShortcutSettings);
Â  Â  Â  Â  document.getElementById('resetShortcutsBtn').addEventListener('click', resetShortcutSettings);

Â  Â  Â  Â  // Weather Location Settings
Â  Â  Â  Â  const wLocInput = document.getElementById('overviewLocationInput'), wLocSuggest = document.getElementById('overviewLocationSuggestions'), useCurrentBtn = document.getElementById('overviewUseCurrentLocationBtn');
Â  Â  Â  Â  wLocInput.addEventListener('input', (e) => { const q = e.target.value; if (q.length < 2) { wLocSuggest.style.display = 'none'; return; } fetchLocationSuggestions(q); });
Â  Â  Â  Â  useCurrentBtn.addEventListener('click', async () => {
            useCurrentBtn.disabled = true;
            useCurrentBtn.textContent = 'Locating...';
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 5000, enableHighAccuracy: true });
                });
                const { latitude, longitude } = position.coords;
                const { label } = await fetchCityName(latitude, longitude);
                weatherSettings.location = { label, latitude, longitude };
                showNotification(`Location found: ${label}`, 'success');
            } catch (error) {
                console.warn("High-accuracy location failed:", error.message, "Trying broader method.");
                showNotification("Precise location failed, trying a broader search...", "info");
                try {
                    const position = await new Promise((resolve, reject) => {
                         navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 8000, enableHighAccuracy: false });
                    });
                    const { latitude, longitude } = position.coords;
                    const { label } = await fetchCityName(latitude, longitude);
                    weatherSettings.location = { label, latitude, longitude };
                    showNotification(`Location found: ${label}`, 'success');
                } catch (err) {
                    console.error("All geolocation methods failed:", err.message);
                    showNotification("Could not get location. Using IP lookup.", "error");
                    const r = await fetch('https://ipapi.co/json/');
                    const d = await r.json();
                    weatherSettings.location = { label: `${d.city}, ${d.region}`, latitude: d.latitude, longitude: d.longitude };
                }
            } finally {
                wLocInput.value = weatherSettings.location.label;
                saveWeatherSettings();
                useCurrentBtn.disabled = false;
                useCurrentBtn.textContent = 'ğŸ“ Use My Current Location';
                settingsModal.classList.remove('modal-open');
                fetchWeather();
            }
Â  Â  Â  Â  });

Â  Â  Â  Â  async function fetchLocationSuggestions(query) {
Â  Â  Â  Â  Â  Â  let url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5`;
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const r = await fetch(url); const d = await r.json(); wLocSuggest.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  if (d.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  wLocSuggest.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  d.forEach(p => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const shortLabel = getShortLocationLabel(p.address, p.display_name); const li = document.createElement('li'); li.textContent = shortLabel;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  li.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  weatherSettings.location = { label: shortLabel, latitude: parseFloat(p.lat), longitude: parseFloat(p.lon) }; wLocInput.value = shortLabel; wLocSuggest.style.display = 'none'; saveWeatherSettings();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  settingsModal.classList.remove('modal-open'); fetchWeather();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  wLocSuggest.appendChild(li);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  } else { wLocSuggest.style.display = 'none'; }
Â  Â  Â  Â  Â  Â  } catch (e) { console.error("Failed to fetch location suggestions:", e); }
Â  Â  Â  Â  }

Â  Â  Â  Â  // Other Settings Listeners
Â  Â  Â  Â  document.getElementById('overviewUnitToggle').addEventListener('change', (e) => { weatherSettings.units = e.target.checked ? 'metric' : 'imperial'; saveWeatherSettings(); });
Â  Â  Â  Â  document.querySelectorAll('input[name="dataSource"]').forEach(r => {r.addEventListener('change', (e) => { weatherSettings.dataSource = e.target.value; saveWeatherSettings(); window.updateNWSAvailability(); })});
Â  Â  Â  Â  window.updateNWSAvailability = function(isUS = userCountry === 'US') { const nR = document.getElementById('sourceNWS'); const nN = document.getElementById('nwsApiNote'); if (isUS) { nR.disabled = false; nN.style.display = 'none'; } else { if (weatherSettings.dataSource === 'nws') { weatherSettings.dataSource = 'open-meteo'; saveWeatherSettings(); document.getElementById('sourceOpenMeteo').checked = true; } nR.disabled = true; nN.style.display = 'block'; }};
Â  Â  Â  Â  const fsWeatherToggle = document.getElementById('fullscreenWeatherToggle'); fsWeatherToggle.addEventListener('change', () => { weatherSettings.showWeatherInFullscreen = fsWeatherToggle.checked; saveWeatherSettings(); updateFullscreenWeatherDisplay(); });
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Fullscreen Color Palette
Â  Â  Â  Â  const colorToggle = document.getElementById('clock-fs-color-toggle'), colorPalette = document.getElementById('clock-fs-color-palette'), colorPickerInput = document.getElementById('color-picker-input');
Â  Â  Â  Â  colorToggle.addEventListener('click', (e) => { e.stopPropagation(); colorPalette.classList.toggle('visible'); });
Â  Â  Â  Â  document.addEventListener('click', (e) => { if (!colorPalette.contains(e.target) && !colorToggle.contains(e.target)) { colorPalette.classList.remove('visible'); } });
Â  Â  Â  Â  colorPalette.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  if(e.target.classList.contains('color-swatch') && !e.target.classList.contains('color-swatch-custom')) {
Â  Â  Â  Â  Â  Â  Â  Â  const color = e.target.dataset.color;
Â  Â  Â  Â  Â  Â  Â  Â  clockFsOverlay.style.background = color;
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem(getStorageKey('clockFsColor'), color);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  document.querySelector('.color-swatch-custom').addEventListener('click', () => colorPickerInput.click());
Â  Â  Â  Â  colorPickerInput.addEventListener('input', (e) => {
Â  Â  Â  Â  Â  Â  const color = e.target.value;
Â  Â  Â  Â  Â  Â  clockFsOverlay.style.background = color;
Â  Â  Â  Â  Â  Â  localStorage.setItem(getStorageKey('clockFsColor'), color);
Â  Â  Â  Â  });
Â  Â  });
Â  </script>
</body>
</html>
