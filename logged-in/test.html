<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4SP - Web Radio</title>
    <link rel="stylesheet" href="../css/style.css"> <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>
    
    <style>
        /* Core Styles (re-used and adapted from soundboard) */
        :root {
            --v4-bg-gradient: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
            --v4-card-bg: #fff;
            --v4-text-primary: #333;
            --v4-text-secondary: #555;
            --v4-purple-accent: #6720bd;
            --v4-purple-accent-darker: #5a1aa8;
            --v4-purple-gradient: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            --v4-border-light: #ddd;
            --v4-border-softer: #eee;
            --v4-input-bg: #f8f9fa;
            --v4-input-border: #ccc;
            --v4-font-primary: 'PrimaryFont', sans-serif;
            --v4-font-secondary: 'SecondaryFont', sans-serif;
        }
        body {
            display: flex; flex-direction: column; min-height: 100vh;
            margin: 0; font-family: var(--v4-font-primary);
            background: var(--v4-bg-gradient); color: var(--v4-text-primary);
            line-height: 1.6;
        }
        .soundboard-container-wrapper { display: flex; flex: 1; overflow: hidden; }
        .sidebar {
            width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%);
            color: #fff; padding: 20px 10px; display: flex; flex-direction: column;
            border-right: 1px solid #444; transition: width 0.5s ease-in-out;
            position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .sidebar.collapsed { width: 85px; }
        #toggleSidebar {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: none; border: none; color: #fff; font-size: 1.2em;
            cursor: pointer; padding: 4px; transition: transform 0.5s ease-in-out;
        }
        .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
        .user-info { text-align: center; margin: 60px 0 30px; border-bottom: 1px solid #555; padding-bottom: 20px; overflow: visible; }
        .marquee-container { overflow: hidden; white-space: nowrap; position: relative; width: 100%; height: 1.8em; line-height: 1.8em; }
        .marquee-content { display: inline-block; padding-left: 100%; transform: translateX(0); animation: none; line-height: 1.8em; }
        .marquee-active { animation: scroll-left-soundboard 12s linear infinite; }
        @keyframes scroll-left-soundboard { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        .user-info .username { font-family: var(--v4-font-primary); font-size: 1.3em; margin-bottom: 8px; line-height: 0.2em; font-weight: bold;}
        .user-info .email { font-family: var(--v4-font-secondary); font-size: 0.9em; color: #bbb; }
        .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
        .sidebar nav li { margin-bottom: 10px; }
        .sidebar nav a {
            display: flex; align-items: center; padding: 12px 15px; color: #fff;
            text-decoration: none; border-radius: 8px; transition: all 0.3s ease;
            font-family: var(--v4-font-primary); text-transform: uppercase;
            position: relative; overflow: hidden; font-size: 1em;
        }
        .sidebar nav a:hover, .sidebar nav a.active { background: var(--v4-purple-gradient); transform: translateX(5px); color: #fff; }
        .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
        .sidebar nav a .label { margin-left: 10px; white-space: nowrap; }
        .sidebar.collapsed nav a .label { display: none; }
        .main-content {
            flex: 1; padding: 30px; background: var(--v4-bg-gradient);
            overflow-y: auto; display: flex; flex-direction: column;
        }
        .content-header-v4 {
            margin-bottom: 25px; background: var(--v4-card-bg); padding: 20px 30px; border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        .content-title-v4 {
            font-size: 2.2em; font-weight: bold; background: var(--v4-purple-gradient);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .settings-tab-container {
            background: var(--v4-card-bg); border-radius: 15px;
            box-shadow: 0 6px 30px rgba(0,0,0,0.08);
            margin-top: 25px;
        }
        .settings-header { display: flex; flex-direction: column; padding: 0 15px; border-bottom: 1px solid var(--v4-border-softer); }
        nav.settings-tabs { display: flex; flex-wrap: wrap; }
        .tab-link {
            background: none; border: none; padding: 15px 20px; cursor: pointer;
            font-size: 1.1em; font-family: var(--v4-font-primary); color: var(--v4-text-secondary);
            border-bottom: 3px solid transparent; margin-bottom: -1px; transition: all 0.2s ease-in-out;
        }
        .tab-link.active, .tab-link:hover { color: var(--v4-purple-accent); }
        .tab-link.active { border-bottom-color: var(--v4-purple-accent); font-weight: bold; }
        .tab-content {
            display: none;
            padding: 25px;
            gap: 15px 25px;
        }
        .tab-content.active {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
        .control-group { position: relative; display: flex; flex-direction: column; margin-bottom: 10px; }
        .control-group.locked { opacity: 0.4; pointer-events: none; }
        .control-group label, .checkbox-label-v4 { font-family: var(--v4-font-primary); font-weight: 600; font-size: 0.95em; color: var(--v4-text-secondary); margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; }
        .control-group input, .control-group select {
            padding: 8px; background-color: var(--v4-input-bg); border: 1px solid var(--v4-input-border);
            border-radius: 6px; color: var(--v4-text-primary); font-family: var(--v4-font-secondary); font-size: 1em;
        }
        .control-group input[type="range"] { -webkit-appearance: none; appearance: none; flex-grow: 1; height: 8px; background: var(--v4-border-light); outline: none; padding: 0;}
        .control-group input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; background: var(--v4-purple-accent); cursor: pointer; border-radius: 50%; }
        .control-group input[type="checkbox"] { margin-left: 12px; transform: scale(1.1); accent-color: var(--v4-purple-accent); }
        .mode-description { font-family: var(--v4-font-secondary); font-size: 0.85em; color: #777; margin-top: -5px; margin-bottom: 5px; padding-left: 2px; font-style: italic; font-weight: 400; }
        .spatial-audio-panel { margin-top: 15px; border-top: 1px solid var(--v4-border-softer); padding-top: 15px; display: none; }
        .control-group:has(#modeSpatial:checked) .spatial-audio-panel { display: block; }
        #spatial-pad { position: relative; width: 150px; height: 150px; border-radius: 50%; background-color: #e9e9e9; border: 1px solid #d1d1d1; box-shadow: inset 0 2px 8px rgba(0,0,0,0.1); cursor: crosshair; touch-action: none; -webkit-user-select: none; user-select: none; margin: 10px auto; }
        #spatial-puck { position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; background-color: #222; border: 2px solid var(--v4-purple-accent); border-radius: 50%; transform: translate(-50%, -50%); cursor: grab; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.5); transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s; }
        #spatial-coords { text-align: center; font-family: var(--v4-font-secondary); margin-top: 10px; }
        
        /* Radio Specific Styles */
        .radio-player-container {
            padding: 30px;
            background: var(--v4-card-bg);
            border-radius: 15px;
            box-shadow: 0 6px 30px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .radio-display {
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
            text-align: center;
        }
        .station-name {
            font-size: 1.75em;
            font-weight: bold;
            min-height: 1.2em;
        }
        .station-genre {
            font-size: 1em;
            color: var(--v4-text-secondary);
            font-style: italic;
            min-height: 1.2em; /* Reserve space */
        }
        .search-controls, .custom-station-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .custom-station-controls { flex-wrap: wrap; }
        .search-controls input, .custom-station-controls input { flex-grow: 1; }
        .btn-primary {
            padding: 8px 15px;
            font-size: 1em;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            border: 1px solid transparent;
            background: var(--v4-purple-gradient);
            color: #fff;
            transition: all 0.2s ease;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(103, 32, 189, 0.3); }
        .btn-secondary {
            padding: 8px 15px;
            font-size: 1em;
            border-radius: 6px;
            cursor: pointer;
            background-color: var(--v4-input-bg);
            border: 1px solid var(--v4-input-border);
            color: var(--v4-text-primary);
        }
        .power-button {
            padding: 10px 15px;
            font-size: 1em;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.3s ease;
        }
        .power-button.off { background-color: #dc3545; border-color: #c82333; color: #fff; }
        .power-button.on { background-color: #28a745; border-color: #218838; color: #fff; }
        hr.divider { border: none; border-top: 1px solid var(--v4-border-softer); margin: 20px 0; }
    </style>
</head>
<body class="radio-page">

    <header class="main-header light-bg">
        <div class="container">
            <div class="logo"><a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer;"/></a></div>
            <div class="auth-buttons">
                <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button>
                <button id="logoutBtn" class="btn btn-login">LOG OUT</button>
            </div>
        </div>
    </header>

    <div class="soundboard-container-wrapper">
        <aside class="sidebar slide-in" id="sidebar">
            <button id="toggleSidebar">‚ò∞</button>
            <div class="user-info">
                <div class="marquee-container"> <span id="userName" class="marquee-content username">Loading‚Ä¶</span> </div>
                <div class="marquee-container"> <span id="userEmail" class="marquee-content email">Loading‚Ä¶</span> </div>
            </div>
            <nav>
                <ul>
                    <li><a href="dashboard.html"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
                    <li><a href="proxies.html"><span class="icon">üõ°Ô∏è</span><span class="label">Proxies</span></a></li>
                    <li><a href="soundboard.html"><span class="icon">üéµ</span><span class="label">Soundboard</span></a></li>
                    <li><a href="radio.html" class="active"><span class="icon">üìª</span><span class="label">Radio</span></a></li>
                    <li><a href="games.html"><span class="icon">üéÆ</span><span class="label">Games</span></a></li>
                    <li><a href="others.html"><span class="icon">‚ú®</span><span class="label">Others</span></a></li>
                    <li><a href="settings.html"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a></li>
                    <li><a href="#" id="signOutLink"><span class="icon">üîí</span><span class="label">LOG OUT</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <div class="content-header-v4">
                <h2 class="content-title-v4">Web Radio</h2>
            </div>

            <div class="radio-player-container">
                <div class="radio-display">
                    <h3 id="stationName" class="station-name">OFF</h3>
                    <p id="stationGenre" class="station-genre">---</p>
                </div>

                <div class="search-controls">
                    <input type="text" id="stationSearchInput" placeholder="Search for a station (e.g., Q92.5, rock cleveland)...">
                    <button id="searchButton" class="btn-primary">Tune</button>
                    <button id="powerButton" class="power-button off">POWER</button>
                </div>

                <hr class="divider">

                <div class="custom-station-controls">
                    <input type="text" id="customStationName" placeholder="Custom Station Name" style="flex-basis: 30%; flex-grow: 1;">
                    <input type="url" id="customStationUrl" placeholder="https://your-stream-url.mp3" style="flex-basis: 60%; flex-grow: 2;">
                    <button id="addCustomStationButton" class="btn-primary">Add & Play</button>
                </div>
                <div class="custom-station-controls">
                     <select id="customStationSelect" style="flex-grow: 1;" title="Your Saved Stations"></select>
                     <button id="removeCustomStationButton" class="btn-secondary">Remove Selected</button>
                </div>
            </div>

            <div class="settings-tab-container">
                <div class="settings-header">
                     <nav class="settings-tabs">
                         <button class="tab-link active" data-tab="modes">Audio Modes</button>
                         <button class="tab-link" data-tab="equalizer">Equalizer</button>
                     </nav>
                </div>
                <div id="modes" class="tab-content active">
                     <div class="control-group">
                         <label class="checkbox-label-v4">Spatial Audio
                             <input type="checkbox" id="modeSpatial" data-setting="modeSpatial">
                         </label>
                         <div class="spatial-audio-panel">
                            <div id="spatial-pad"><div id="spatial-puck"></div></div>
                            <div id="spatial-coords">X: 0.00, Y: 0.00, Z: 0.00</div>
                         </div>
                     </div>
                     <div class="control-group">
                         <label class="checkbox-label-v4">Vintage Warmth
                             <input type="checkbox" data-setting="modeVintageWarmth">
                         </label>
                         <small class="mode-description">Adds subtle analog-style saturation for a richer sound.</small>
                     </div>
                     <div class="control-group">
                         <label class="checkbox-label-v4">Vocal Boost
                            <input type="checkbox" data-setting="modeVocalBoost">
                         </label>
                         <small class="mode-description">Emphasizes frequencies common in human speech.</small>
                     </div>
                </div>
                <div id="equalizer" class="tab-content">
                    <div class="control-group">
                        <label>Bass: <span id="eqBassValue">0 dB</span></label>
                        <input type="range" id="eqBass" min="-40" max="40" step="1" value="0" data-setting="eqBass">
                    </div>
                    <div class="control-group">
                        <label>Mid: <span id="eqMidValue">0 dB</span></label>
                        <input type="range" id="eqMid" min="-20" max="20" step="1" value="0" data-setting="eqMid">
                    </div>
                    <div class="control-group">
                        <label>Treble: <span id="eqTrebleValue">0 dB</span></label>
                        <input type="range" id="eqTreble" min="-30" max="30" step="1" value="0" data-setting="eqTreble">
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
    // --- Standard Setup (Auth, Sidebar, etc.) ---
    const dbRef_ = () => firebase.firestore().collection('users').doc(firebase.auth().currentUser.uid);
    const marqueeEls_ = document.querySelectorAll('.marquee-content');
    firebase.auth().onAuthStateChanged(async user => {
        if (!user) { window.location.href = '../login.html'; }
        else {
            const userEmailEl = document.getElementById('userEmail');
            const userNameEl = document.getElementById('userName');
            if (userEmailEl) userEmailEl.textContent = user.email;
            if (userNameEl) {
                try {
                    const doc = await dbRef_().get();
                    userNameEl.textContent = (doc.exists && doc.data().username) ? doc.data().username : (user.displayName || 'User');
                } catch (error) { userNameEl.textContent = 'User'; console.error("Error fetching username:", error); }
            }
            updateMarquees_();
        }
    });
    document.getElementById('logoutBtn')?.addEventListener('click', () => { firebase.auth().signOut().then(() => { window.location.href = '../login.html'; }); });
    document.getElementById('signOutLink')?.addEventListener('click', (e) => { e.preventDefault(); firebase.auth().signOut().then(() => { window.location.href = '../login.html'; }); });
    const sidebar_ = document.getElementById('sidebar');
    const toggleSidebarBtn_ = document.getElementById('toggleSidebar');
    if (toggleSidebarBtn_ && sidebar_) { toggleSidebarBtn_.addEventListener('click', () => { sidebar_.classList.toggle('collapsed'); setTimeout(updateMarquees_, 550); }); }
    function updateMarquees_() {
        marqueeEls_.forEach(el => {
            if (!el || !el.parentElement) return;
            const parent = el.parentElement; const overflow = el.scrollWidth > parent.clientWidth;
            const shouldScroll = sidebar_.classList.contains('collapsed') || (overflow && !sidebar_.classList.contains('collapsed'));
            el.classList.toggle('marquee-active', shouldScroll);
            if (!overflow && !sidebar_.classList.contains('collapsed')) { el.classList.remove('marquee-active'); }
        });
    }
    window.addEventListener('resize', updateMarquees_);
    
    // --- Radio Logic ---
    document.addEventListener('DOMContentLoaded', () => {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let radioAudioElement = new Audio();
        radioAudioElement.crossOrigin = "anonymous";
        let radioSourceNode;

        let isPowerOn = false;

        // --- UI Elements ---
        const powerButton = document.getElementById('powerButton');
        const stationNameEl = document.getElementById('stationName');
        const stationGenreEl = document.getElementById('stationGenre');
        const searchInput = document.getElementById('stationSearchInput');
        const searchButton = document.getElementById('searchButton');
        const customNameInput = document.getElementById('customStationName');
        const customUrlInput = document.getElementById('customStationUrl');
        const addCustomBtn = document.getElementById('addCustomStationButton');
        const customSelect = document.getElementById('customStationSelect');
        const removeCustomBtn = document.getElementById('removeCustomStationButton');
        
        // --- Audio Nodes ---
        const masterGain = audioContext.createGain();
        const nodes = {
            mainPanner: new PannerNode(audioContext, { panningModel: 'HRTF', distanceModel: 'inverse' }),
            inputGain: audioContext.createGain(),
            eqBass: new BiquadFilterNode(audioContext, { type: 'lowshelf', frequency: 100, gain: 0 }),
            eqMid: new BiquadFilterNode(audioContext, { type: 'peaking', frequency: 1200, Q: 1.0, gain: 0 }),
            eqTreble: new BiquadFilterNode(audioContext, { type: 'highshelf', frequency: 6000, gain: 0 }),
            vintageWarmer: audioContext.createWaveShaper(),
            vocalBoost: new BiquadFilterNode(audioContext, {type: 'peaking', frequency: 2500, Q: 1.5, gain: 0}),
        };

        function makeVintageCurve(amount) { const n_samples = 44100; const curve = new Float32Array(n_samples); if (amount === 0) for (let i=0; i<n_samples; ++i) curve[i] = i * 2 / n_samples - 1; else for (let i=0; i<n_samples; ++i) { const x = i * 2 / n_samples - 1; curve[i] = Math.tanh(x*amount); } return curve; }
        nodes.vintageWarmer.curve = makeVintageCurve(0);

        // --- Audio Graph Wiring ---
        masterGain.connect(nodes.mainPanner).connect(nodes.inputGain).connect(nodes.vocalBoost).connect(nodes.vintageWarmer).connect(nodes.eqBass).connect(nodes.eqMid).connect(nodes.eqTreble).connect(audioContext.destination);

        // --- Station Logic ---
        function playStream(station) {
            if (!isPowerOn) return;
            stationNameEl.textContent = station.name;
            stationGenreEl.textContent = station.genre || 'Custom Stream';
            radioAudioElement.src = station.url;
            radioAudioElement.play().catch(e => {
                console.error("Playback error:", e);
                stationNameEl.textContent = "Error";
                stationGenreEl.textContent = "Could not play stream.";
            });
        }
        
        async function searchAndPlay(query) {
            if (!query) return;
            stationNameEl.textContent = "Searching...";
            stationGenreEl.textContent = `for "${query}"`;
            try {
                const response = await fetch(`https://de1.api.radio-browser.info/json/stations/search?limit=50&name=${encodeURIComponent(query)}&hidebroken=true&order=clickcount&reverse=true`);
                const data = await response.json();
                const bestResult = data.find(s => s.url_resolved && (s.codec === 'MP3' || s.codec === 'AAC'));
                
                if (bestResult) {
                    playStream({
                        name: bestResult.name,
                        genre: bestResult.tags,
                        url: bestResult.url_resolved
                    });
                } else {
                    stationNameEl.textContent = "Not Found";
                    stationGenreEl.textContent = `No results for "${query}"`;
                }
            } catch (error) {
                console.error("API search error:", error);
                stationNameEl.textContent = "API Error";
                stationGenreEl.textContent = "Could not perform search.";
            }
        }

        // --- Custom Station Logic ---
        function getCustomStations() {
            return JSON.parse(localStorage.getItem('customRadioStations') || '[]');
        }
        function saveCustomStations(stations) {
            localStorage.setItem('customRadioStations', JSON.stringify(stations));
        }
        function populateCustomStations() {
            const stations = getCustomStations();
            customSelect.innerHTML = '<option value="">Play a saved station...</option>';
            stations.forEach((station, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = station.name;
                customSelect.appendChild(option);
            });
        }
        addCustomBtn.addEventListener('click', () => {
            const name = customNameInput.value.trim();
            const url = customUrlInput.value.trim();
            if (!name || !url) {
                alert('Please enter both a name and a URL.');
                return;
            }
            const newStation = { name, url };
            const stations = getCustomStations();
            stations.push(newStation);
            saveCustomStations(stations);
            populateCustomStations();
            customNameInput.value = '';
            customUrlInput.value = '';
            customSelect.value = stations.length - 1;
            if (isPowerOn) {
                playStream(newStation);
            }
        });
        removeCustomBtn.addEventListener('click', () => {
            const selectedIndex = customSelect.value;
            if (selectedIndex === "") return;
            let stations = getCustomStations();
            stations.splice(selectedIndex, 1);
            saveCustomStations(stations);
            populateCustomStations();
        });
        customSelect.addEventListener('change', () => {
            const selectedIndex = customSelect.value;
            if (selectedIndex === "") return;
            const stations = getCustomStations();
            const station = stations[selectedIndex];
            if (station && isPowerOn) {
                playStream(station);
            }
        });

        // --- Event Listeners ---
        powerButton.addEventListener('click', () => {
            isPowerOn = !isPowerOn;
            powerButton.classList.toggle('on', isPowerOn);
            powerButton.classList.toggle('off', !isPowerOn);
            if (isPowerOn) {
                if (audioContext.state === 'suspended') audioContext.resume();
                if (!radioSourceNode) {
                    radioSourceNode = audioContext.createMediaElementSource(radioAudioElement);
                    radioSourceNode.connect(masterGain);
                }
                stationGenreEl.textContent = "Ready to tune.";
                stationNameEl.textContent = "Radio ON";
            } else {
                radioAudioElement.pause();
                radioAudioElement.src = '';
                stationNameEl.textContent = 'OFF';
                stationGenreEl.textContent = '---';
            }
        });

        searchButton.addEventListener('click', () => searchAndPlay(searchInput.value));
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') searchAndPlay(searchInput.value);
        });

        // --- Settings Logic ---
        document.querySelectorAll('[data-setting]').forEach(setting => {
            const eventType = setting.type === 'checkbox' ? 'change' : 'input';
            setting.addEventListener(eventType, (e) => {
                const { id, value, checked } = e.target;
                const timeConstant = 0.02;
                switch (id) {
                    case 'eqBass': nodes.eqBass.gain.setTargetAtTime(parseFloat(value), audioContext.currentTime, timeConstant); document.getElementById('eqBassValue').textContent = `${value} dB`; break;
                    case 'eqMid': nodes.eqMid.gain.setTargetAtTime(parseFloat(value), audioContext.currentTime, timeConstant); document.getElementById('eqMidValue').textContent = `${value} dB`; break;
                    case 'eqTreble': nodes.eqTreble.gain.setTargetAtTime(parseFloat(value), audioContext.currentTime, timeConstant); document.getElementById('eqTrebleValue').textContent = `${value} dB`; break;
                    case 'modeSpatial': nodes.mainPanner.panningModel = checked ? 'HRTF' : 'equalpower'; break;
                    case 'modeVintageWarmth': nodes.vintageWarmer.curve = makeVintageCurve(checked ? 1.5 : 0); break;
                    case 'modeVocalBoost': nodes.vocalBoost.gain.setTargetAtTime(checked ? 6 : 0, audioContext.currentTime, timeConstant); break;
                }
            });
        });
        
        document.querySelector('.settings-tabs').addEventListener('click', e => { if (e.target.matches('.tab-link')) { document.querySelectorAll('.tab-link, .tab-content').forEach(el => el.classList.remove('active')); e.target.classList.add('active'); document.getElementById(e.target.dataset.tab).classList.add('active'); } });

        const spatialPad = document.getElementById('spatial-pad');
        const spatialPuck = document.getElementById('spatial-puck');
        const spatialCoords = document.getElementById('spatial-coords');
        let isPuckDragging = false;
        let pannerZ = 0;

        function updatePannerPosition(x, y, z) { const scale = 10; const timeConstant = 0.015; nodes.mainPanner.positionX.setTargetAtTime(x * scale, audioContext.currentTime, timeConstant); nodes.mainPanner.positionY.setTargetAtTime(y * scale, audioContext.currentTime, timeConstant); nodes.mainPanner.positionZ.setTargetAtTime(z * scale, audioContext.currentTime, timeConstant); spatialCoords.textContent = `X: ${x.toFixed(2)}, Y: ${y.toFixed(2)}, Z: ${z.toFixed(2)}`; }
        function movePuck(e) { const rect = spatialPad.getBoundingClientRect(); const radius = rect.width / 2; let x = e.clientX - rect.left - radius; let y = e.clientY - rect.top - radius; let dist = Math.sqrt(x*x + y*y); if (dist > radius) { x = (x/dist) * radius; y = (y/dist) * radius; } spatialPuck.style.left = `${x + radius}px`; spatialPuck.style.top = `${y + radius}px`; updatePannerPosition(x / radius, -y / radius, pannerZ); }
        spatialPad.addEventListener('mousedown', (e) => { if(!document.getElementById('modeSpatial').checked) return; isPuckDragging = true; movePuck(e); });
        document.addEventListener('mousemove', (e) => { if(isPuckDragging) movePuck(e); });
        document.addEventListener('mouseup', () => { isPuckDragging = false; });
        spatialPad.addEventListener('wheel', e => { if(!document.getElementById('modeSpatial').checked) return; e.preventDefault(); pannerZ += e.deltaY * -0.01; pannerZ = Math.max(-1, Math.min(1, pannerZ)); const rect = spatialPad.getBoundingClientRect(); const radius = rect.width / 2; const currentX = (parseFloat(spatialPuck.style.left || `${radius}px`) - radius) / radius; const currentY = -(parseFloat(spatialPuck.style.top || `${radius}px`) - radius) / radius; updatePannerPosition(currentX, currentY, pannerZ); });

        // --- Initial setup ---
        populateCustomStations();
    });
    </script>
</body>
</html>
