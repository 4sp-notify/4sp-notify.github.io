<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
Â  <title>4SP - DASHBOARD</title>
Â  <link rel="stylesheet" href="../css/style.css" />
Â  <script src="../panic-key.js"></script>
Â  <script src="../ban-enforcer.js"></script>
Â  <script src="../url-changer.js"></script>

Â  <style>
Â  Â  /* --- Dashboard Layout --- */
Â  Â  body.dashboard-page {
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  min-height: 100vh;
Â  Â  Â  margin: 0;
Â  Â  Â  font-family: 'PrimaryFont', sans-serif;
Â  Â  }
Â  Â  .dashboard-container {
Â  Â  Â  display: flex;
Â  Â  Â  flex: 1;
Â  Â  }

Â  Â  /* --- Sidebar --- */
Â  Â  .sidebar {
Â  Â  Â  width: 200px;
Â  Â  Â  background: linear-gradient(180deg, #333 0%, #2a2a2a 100%);
Â  Â  Â  color: #fff;
Â  Â  Â  padding: 20px 10px;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  border-right: 1px solid #444;
Â  Â  Â  transition: width 0.5s ease-in-out;
Â  Â  Â  position: relative;
Â  Â  Â  box-shadow: 2px 0 10px rgba(0,0,0,0.1);
Â  Â  }
Â  Â  .sidebar.collapsed {
Â  Â  Â  width: 85px;
Â  Â  }
Â  Â  #toggleSidebar {
Â  Â  Â  position: absolute;
Â  Â  Â  top: 10px;
Â  Â  Â  left: 50%;
Â  Â  Â  transform: translateX(-50%);
Â  Â  Â  background: none;
Â  Â  Â  border: none;
Â  Â  Â  color: #fff;
Â  Â  Â  font-size: 1.2em;
Â  Â  Â  cursor: pointer;
Â  Â  Â  padding: 4px;
Â  Â  Â  transition: transform 0.5s ease-in-out;
Â  Â  }
Â  Â  .sidebar.collapsed #toggleSidebar {
Â  Â  Â  transform: translateX(-50%) rotate(180deg);
Â  Â  }
Â  Â  .sidebar nav ul {
Â  Â  Â  list-style: none;
Â  Â  Â  padding: 0;
Â  Â  Â  margin: 60px 0 0;
Â  Â  }
Â  Â  .sidebar nav li {
Â  Â  Â  margin-bottom: 10px;
Â  Â  }
Â  Â  .sidebar nav a {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  padding: 12px 15px;
Â  Â  Â  color: #fff;
Â  Â  Â  text-decoration: none;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  font-family: 'PrimaryFont', sans-serif;
Â  Â  Â  text-transform: uppercase;
Â  Â  Â  position: relative;
Â  Â  Â  overflow: hidden;
Â  Â  }
Â  Â  .sidebar nav a::before {
Â  Â  Â  content: '';
Â  Â  Â  position: absolute;
Â  Â  Â  top: 0;
Â  Â  Â  left: -100%;
Â  Â  Â  width: 100%;
Â  Â  Â  height: 100%;
Â  Â  Â  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
Â  Â  Â  transition: left 0.5s;
Â  Â  }
Â  Â  .sidebar nav a:hover::before {
Â  Â  Â  left: 100%;
Â  Â  }
Â  Â  .sidebar nav a.active,
Â  Â  .sidebar nav a:hover {
Â  Â  Â  background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
Â  Â  Â  transform: translateX(5px);
Â  Â  }
Â  Â  .sidebar nav a .icon {
Â  Â  Â  font-size: 1.2em;
Â  Â  Â  width: 24px;
Â  Â  Â  text-align: center;
Â  Â  }
Â  Â  .sidebar nav a .label {
Â  Â  Â  margin-left: 10px;
Â  Â  Â  white-space: nowrap;
Â  Â  }
Â  Â  .sidebar.collapsed nav a {
Â  Â  Â  justify-content: center;
Â  Â  Â  padding: 10px 0;
Â  Â  }
Â  Â  .sidebar.collapsed nav a .label {
Â  Â  Â  display: none;
Â  Â  }
Â  Â  .user-info {
Â  Â  Â  text-align: center;
Â  Â  Â  margin: 60px 0 30px;
Â  Â  Â  border-bottom: 1px solid #555;
Â  Â  Â  padding-bottom: 20px;
Â  Â  Â  overflow: visible;
Â  Â  }
Â  Â  .marquee-container {
Â  Â  Â  overflow: hidden;
Â  Â  Â  white-space: nowrap;
Â  Â  Â  position: relative;
Â  Â  Â  width: 100%;
Â  Â  Â  height: 1.8em;
Â  Â  Â  line-height: 1.8em;
Â  Â  }
Â  Â  .marquee-content {
Â  Â  Â  display: inline-block;
Â  Â  Â  padding-left: 100%;
Â  Â  Â  transform: translateX(0);
Â  Â  Â  animation: none;
Â  Â  Â  line-height: 1.8em;
Â  Â  }
Â  Â  .marquee-active {
Â  Â  Â  animation: scroll-left 12s linear infinite;
Â  Â  }
Â  Â  .sidebar.collapsed .marquee-active {
Â  Â  Â  animation-duration: 20s;
Â  Â  }
Â  Â  @keyframes scroll-left {
Â  Â  Â  0% { transform: translateX(0); }
Â  Â  Â  100% { transform: translateX(-100%); }
Â  Â  }
Â  Â  .user-info .username {
Â  Â  Â  font-family: 'PrimaryFont', sans-serif;
Â  Â  Â  font-size: 1.3em;
Â  Â  Â  margin-bottom: 8px;
Â  Â  Â  line-height: 0.2em;
Â  Â  Â  font-weight: bold;
Â  Â  }
Â  Â  .user-info .email {
Â  Â  Â  font-family: 'SecondaryFont', sans-serif;
Â  Â  Â  font-size: 0.9em;
Â  Â  Â  color: #bbb;
Â  Â  }

Â  Â  /* --- Main Content & Controls --- */
Â  Â  .main-content {
Â  Â  Â  flex: 1;
Â  Â  Â  padding: 40px;
Â  Â  Â  background: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
Â  Â  Â  overflow-y: auto;
Â  Â  Â  position: relative;
Â  Â  }
Â  Â  .dashboard-header {
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  align-items: center;
Â  Â  Â  margin-bottom: 40px;
Â  Â  Â  background: white;
Â  Â  Â  padding: 20px 30px;
Â  Â  Â  border-radius: 15px;
Â  Â  Â  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
Â  Â  Â  border: 1px solid rgba(103, 32, 189, 0.1);
Â  Â  Â  position: relative; /* Added for search suggestions positioning */
Â  Â  }
Â  Â  .dashboard-title {
Â  Â  Â  margin: 0;
Â  Â  Â  font-size: 2.2em;
Â  Â  Â  font-weight: bold;
Â  Â  Â  background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
Â  Â  Â  -webkit-background-clip: text;
Â  Â  Â  -webkit-text-fill-color: transparent;
Â  Â  Â  background-clip: text;
Â  Â  }

Â  Â  /* --- START: New Battery Styles --- */
Â  Â  .dashboard-title-wrapper {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  gap: 20px;
Â  Â  Â  Â  flex-grow: 1;Â 
Â  Â  }
Â  Â  .battery-status-container {
Â  Â  Â  Â  display: none; /* Hidden by default; JS enables it if API is supported */
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  font-size: 0.75em;
Â  Â  Â  Â  font-weight: 500;
Â  Â  Â  Â  color: #5f6368; /* Default grey color */
Â  Â  Â  Â  background-color: rgba(0, 0, 0, 0.03);
Â  Â  Â  Â  border: 1px solid rgba(0, 0, 0, 0.08);
Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  padding: 4px 8px;
Â  Â  Â  Â  line-height: 1.3;
Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  }
Â  Â  .battery-status-container.charging {
Â  Â  Â  Â  color: #2e7d32; /* Green when charging */
Â  Â  Â  Â  border-color: rgba(46, 125, 50, 0.4);
Â  Â  }
Â  Â  #battery-level.low {
Â  Â  Â  Â  color: #f5c518; /* Yellow for low battery */
Â  Â  Â  Â  font-weight: bold;
Â  Â  }
Â  Â  #battery-level.critical {
Â  Â  Â  Â  color: #e53935; /* Red for critical battery */
Â  Â  Â  Â  font-weight: bold;
Â  Â  }
Â  Â  #battery-level.very-critical {
Â  Â  Â  Â  color: #b71c1c; /* Dark red for very critical battery */
Â  Â  Â  Â  font-weight: bold;
Â  Â  }
Â  Â  /* --- END: New Battery Styles --- */
Â  Â Â 
Â  Â  .dashboard-controls {
Â  Â  Â  display: flex;
Â  Â  Â  gap: 15px;
Â  Â  Â  align-items: center;
Â  Â  }

Â  Â  /* --- START: Search Bar Styles --- */
Â  Â  .search-container {
Â  Â  Â  position: relative;
Â  Â  Â  width: 350px; /* Set a specific width for the search bar */
Â  Â  }
Â  Â  #dashboardSearch {
Â  Â  Â  width: 100%;
Â  Â  Â  padding: 12px 20px;
Â  Â  Â  font-family: 'PrimaryFont', sans-serif;
Â  Â  Â  font-size: 1em;
Â  Â  Â  color: #333;
Â  Â  Â  background: rgba(255, 255, 255, 0.4);
Â  Â  Â  backdrop-filter: blur(8px);
Â  Â  Â  -webkit-backdrop-filter: blur(8px);
Â  Â  Â  border: 1px solid rgba(103, 32, 189, 0.2);
Â  Â  Â  border-radius: 12px;
Â  Â  Â  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
Â  Â  Â  outline: none;
Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  box-sizing: border-box;
Â  Â  }
Â  Â  #dashboardSearch::placeholder {
Â  Â  Â  color: #777;
Â  Â  }
Â  Â  #dashboardSearch:focus {
Â  Â  Â  box-shadow: 0 4px 15px rgba(103, 32, 189, 0.15);
Â  Â  Â  border-color: rgba(103, 32, 189, 0.4);
Â  Â  }
Â  Â  .suggestions-container {
Â  Â  Â  display: none;
Â  Â  Â  position: absolute;
Â  Â  Â  top: 100%;
Â  Â  Â  left: 0;
Â  Â  Â  right: 0;
Â  Â  Â  margin-top: 8px;
Â  Â  Â  background: rgba(255, 255, 255, 0.6);
Â  Â  Â  backdrop-filter: blur(10px);
Â  Â  Â  -webkit-backdrop-filter: blur(10px);
Â  Â  Â  border: 1px solid rgba(103, 32, 189, 0.2);
Â  Â  Â  border-radius: 12px;
Â  Â  Â  box-shadow: 0 8px 25px rgba(0,0,0,0.1);
Â  Â  Â  z-index: 1000;
Â  Â  Â  max-height: 250px;
Â  Â  Â  overflow-y: auto;
Â  Â  }
Â  Â  .suggestion-item {
Â  Â  Â  display: block;
Â  Â  Â  padding: 12px 20px;
Â  Â  Â  color: #333;
Â  Â  Â  text-decoration: none;
Â  Â  Â  font-family: 'PrimaryFont', sans-serif;
Â  Â  Â  font-size: 0.95em;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: background-color 0.2s ease, color 0.2s ease;
Â  Â  Â  border-bottom: 1px solid rgba(103, 32, 189, 0.1);
Â  Â  }
Â  Â  .suggestion-item:last-child {
Â  Â  Â  border-bottom: none;
Â  Â  }
Â  Â  .suggestion-item:hover {
Â  Â  Â  background-color: rgba(103, 32, 189, 0.1);
Â  Â  Â  color: #6720bd;
Â  Â  }
Â  Â  /* --- END: Search Bar Styles --- */

Â  Â  /* --- Dashboard Grid & Cards --- */
Â  Â  .dashboard-grid {
Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  grid-template-columns: 1fr;Â 
Â  Â  Â  Â  gap: 20px;
Â  Â  Â  Â  position: relative;
Â  Â  }
Â  Â  @media (min-width: 768px) {
Â  Â  Â  Â  .dashboard-grid {
Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
Â  Â  Â  Â  }
Â  Â  }
Â  Â  @media (min-width: 1200px) {
Â  Â  Â  Â  .dashboard-grid {
Â  Â  Â  Â  Â  Â  grid-template-columns: repeat(6, 1fr);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  .dashboard-card {
Â  Â  Â  background: white;
Â  Â  Â  border-radius: 20px;
Â  Â  Â  padding: 20px;
Â  Â  Â  box-shadow: 0 6px 30px rgba(0,0,0,0.08);
Â  Â  Â  border: 1px solid rgba(103, 32, 189, 0.1);
Â  Â  Â  position: relative;
Â  Â  Â  user-select: none;
Â  Â  Â  z-index: 2;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  overflow: hidden;
Â  Â  Â  transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
Â  Â  Â  min-height: 200px;
Â  Â  }
Â  Â Â 
Â  Â  /* Default span for cards on smaller grids or when type not specified for 6-col */
Â  Â  .dashboard-card {
Â  Â  Â  Â  grid-column: span 1;Â 
Â  Â  }
Â  Â Â 
Â  Â  @media (min-width: 768px) and (max-width: 1199px) { /* For auto-fit on medium screens */
Â  Â  Â  Â  .dashboard-card[data-card-type="medium"],
Â  Â  Â  Â  .dashboard-card[data-card-type="small"],
Â  Â  Â  Â  .dashboard-card[data-card-type="full"] {
Â  Â  Â  Â  Â  Â  grid-column: auto / span 1; /* Each card takes one of the auto-fitted columns */
Â  Â  Â  Â  }
Â  Â  }

Â  Â  @media (min-width: 1200px) { /* Spans for the 6-column grid */
Â  Â  Â  Â  .dashboard-card[data-card-type="medium"] {
Â  Â  Â  Â  Â  Â  grid-column: span 3;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .dashboard-card[data-card-type="small"] {
Â  Â  Â  Â  Â  Â  grid-column: span 2;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .dashboard-card[data-card-type="full"] {Â 
Â  Â  Â  Â  Â  Â  grid-column: span 6;
Â  Â  Â  Â  }
Â  Â  }

Â  Â  .dashboard-card[data-template-id="weather_large_widget"] {
Â  Â  Â  Â  padding-top: 10px;
Â  Â  }

Â  Â  .dashboard-card::before {
Â  Â  Â  content: '';
Â  Â  Â  position: absolute;
Â  Â  Â  top: 0;
Â  Â  Â  left: -100%;
Â  Â  Â  width: 100%;
Â  Â  Â  height: 100%;
Â  Â  Â  background: linear-gradient(90deg, transparent, rgba(103, 32, 189, 0.05), transparent);
Â  Â  Â  transition: left 0.6s ease;
Â  Â  Â  z-index: -1;
Â  Â  }
Â  Â  .dashboard-card:hover::before {
Â  Â  Â  left: 100%;
Â  Â  }
Â  Â  .dashboard-card:hover {
Â  Â  Â  transform: translateY(-8px) scale(1.02);
Â  Â  Â  box-shadow: 0 15px 40px rgba(103, 32, 189, 0.15);
Â  Â  Â  border-color: rgba(103, 32, 189, 0.3);
Â  Â  }

Â  Â  .card-header {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  padding-bottom: 12px;
Â  Â  Â  border-bottom: 1px solid rgba(103, 32, 189, 0.1);
Â  Â  Â  justify-content: flex-start;
Â  Â  Â  flex-shrink: 0;
Â  Â  Â  position: relative;
Â  Â  }
Â  Â  .card-icon {
Â  Â  Â  font-size: 2em;
Â  Â  Â  margin-right: 12px;
Â  Â  Â  background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
Â  Â  Â  -webkit-background-clip: text;
Â  Â  Â  -webkit-text-fill-color: transparent;
Â  Â  Â  filter: drop-shadow(0 2px 4px rgba(103, 32, 189, 0.2));
Â  Â  }
Â  Â  .card-title {
Â  Â  Â  font-size: 1.3em;
Â  Â  Â  font-weight: bold;
Â  Â  Â  margin: 0;
Â  Â  Â  color: #333;
Â  Â  Â  flex-grow: 1;
Â  Â  Â  white-space: nowrap;
Â  Â  Â  overflow: hidden;
Â  Â  Â  text-overflow: ellipsis;
Â  Â  }
Â  Â Â 
Â  Â  .card-header-buttons {
Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  margin-left: auto;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  gap: 6px;
Â  Â  }

Â  Â  .weather-action-btn {
Â  Â  Â  Â  background: rgba(103, 32, 189, 0.08);
Â  Â  Â  Â  border: none;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  padding: 8px;
Â  Â  Â  Â  line-height: 1;
Â  Â  Â  Â  display: inline-flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  z-index: 5;
Â  Â  Â  Â  transition: background-color 0.2s ease, transform 0.2s ease;
Â  Â  Â  Â  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
Â  Â  }
Â  Â  .weather-action-btn img {
Â  Â  Â  Â  width: 22px;
Â  Â  Â  Â  height: 22px;
Â  Â  Â  Â  display: block;
Â  Â  Â  Â  transform: rotate(0deg);Â 
Â  Â  Â  Â  transition: none;
Â  Â  Â  Â  filter: invert(0.3) brightness(100%);
Â  Â  }
Â  Â  .weather-action-btn:hover {
Â  Â  Â  Â  background-color: rgba(103, 32, 189, 0.15);
Â  Â  Â  Â  transform: translateY(-2px);
Â  Â  }
Â  Â  .weather-action-btn:disabled {
Â  Â  Â  Â  cursor: not-allowed;
Â  Â  Â  Â  opacity: 0.6;
Â  Â  Â  Â  background-color: rgba(103, 32, 189, 0.08);
Â  Â  Â  Â  transform: translateY(0);
Â  Â  }

Â  Â  @keyframes spin-clockwise {
Â  Â  Â  Â  0% { transform: rotate(0deg); }
Â  Â  Â  Â  100% { transform: rotate(360deg); }
Â  Â  }
Â  Â  @keyframes spin-counter-clockwise {
Â  Â  Â  Â  from { transform: rotate(360deg); }
Â  Â  Â  Â  to { transform: rotate(0deg); }
Â  Â  }
Â  Â  .weather-refresh-btn.refreshing img {
Â  Â  Â  Â  animation: spin-clockwise 0.8s linear infinite;Â 
Â  Â  }
Â  Â  .weather-refresh-btn.spin-back img {
Â  Â  Â  Â  animation: spin-counter-clockwise 0.5s ease-out forwards;Â 
Â  Â  }

Â  Â  .card-content-inner {
Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  justify-content: center;
Â  Â  }

Â  Â  /* Specific Widget Styles */
Â  Â  .weather-large-content {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  justify-content: flex-start;
Â  Â  }
Â  Â  .current-weather-layout {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  gap: 15px;
Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  padding-bottom: 10px;
Â  Â  Â  Â  border-bottom: 1px solid rgba(103, 32, 189, 0.08);
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  box-sizing: border-box;
Â  Â  }
Â  Â  .weather-icon-large {
Â  Â  Â  Â  font-size: 3.2em;
Â  Â  Â  Â  color: #6720bd;
Â  Â  Â  Â  flex-shrink: 0;
Â  Â  }
Â  Â  .current-weather-main-info {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  align-items: flex-start;
Â  Â  Â  Â  flex-grow: 1;
Â  Â  }
Â  Â  .temp-large {
Â  Â  Â  Â  font-size: 2.3em;
Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  color: #333;
Â  Â  Â  Â  line-height: 1.1;
Â  Â  }
Â  Â  .condition-large {
Â  Â  Â  Â  font-size: 0.95em;
Â  Â  Â  Â  color: #555;
Â  Â  }
Â  Â  .current-weather-details-aside {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  align-items: flex-end;
Â  Â  Â  Â  font-size: 0.75em;
Â  Â  Â  Â  color: #777;
Â  Â  Â  Â  line-height: 1.4;
Â  Â  Â  Â  flex-shrink: 0;
Â  Â  Â  Â  padding-left: 12px;
Â  Â  Â  Â  border-left: 1px solid rgba(103, 32, 189, 0.1);
Â  Â  Â  Â  text-align: right;
Â  Â  }
Â  Â  .current-weather-details-aside p {
Â  Â  Â  Â  margin: 0px 0;
Â  Â  }

Â  Â  .forecast-large {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  Â  justify-content: space-around;
Â  Â  Â  Â  gap: 5px;
Â  Â  Â  Â  padding: 6px 0px;
Â  Â  Â  Â  margin-bottom: 8px;
Â  Â  }
Â  Â  .forecast-day {
Â  Â  Â  Â  flex: 0 1 auto;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  padding: 8px 4px;
Â  Â  Â  Â  background-color: #ffffff;
Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  min-width: 58.5px;
Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  border: 1.25px solid rgba(103, 32, 189, 0.2);
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  transition: all 0.2s ease;
Â  Â  Â  Â  height: 82.5px;
Â  Â  Â  Â  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
Â  Â  }
Â  Â  .forecast-day:hover {
Â  Â  Â  Â  background-color: rgba(103, 32, 189, 0.1);
Â  Â  Â  Â  transform: translateY(-3px);
Â  Â  Â  Â  box-shadow: 0 5px 15px rgba(103, 32, 189, 0.1);
Â  Â  }
Â  Â  .forecast-day .day-name { font-size: 0.75em; font-weight: 600; color: #555; margin-bottom: 4px; }
Â  Â  .forecast-day .icon {Â 
Â  Â  Â  Â  font-size: 1.6em;
Â  Â  Â  Â  color: #6720bd; margin-bottom: 4px; line-height:1;Â 
Â  Â  Â  Â  filter: drop-shadow(0 1px 2px rgba(103, 32, 189, 0.1));
Â  Â  }
Â  Â  .forecast-day .temps {Â 
Â  Â  Â  Â  font-size: 0.8em;
Â  Â  Â  Â  color: #333;Â 
Â  Â  Â  Â  font-weight: 500;
Â  Â  }

Â  Â  /* Clock Widget */
Â  Â  .clock-display {
Â  Â  Â  Â  font-size: 3.5em;
Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  color: #333;
Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  margin-bottom: 5px;
Â  Â  }
Â  Â  .date-display {
Â  Â  Â  Â  font-size: 1.5em;
Â  Â  Â  Â  color: #666;
Â  Â  Â  Â  text-align: left;
Â  Â  }
Â  Â  .additional-time-info {
Â  Â  Â  Â  font-size: 1em;
Â  Â  Â  Â  color: #777;
Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  line-height: 1.3;
Â  Â  }
Â  Â  .additional-time-info span {
Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  padding: 0 5px;
Â  Â  }
Â  Â  .additional-time-info span:first-child {
Â  Â  Â  Â  padding-left: 0;
Â  Â  }

Â  Â  /* --- REVISED Stopwatch & Timer Widget --- */
Â  Â  .stopwatch-display, .timer-display-value {
Â  Â  Â  Â  font-size: 2.2em;
Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  color: #6720bd;
Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  letter-spacing: 1px;
Â  Â  Â  Â  font-family: 'PrimaryFont', sans-serif;
Â  Â  }
Â  Â  .timer-inputs {Â 
Â  Â  Â  display: flex;Â 
Â  Â  Â  justify-content: center;Â 
Â  Â  Â  gap: 5px;Â 
Â  Â  Â  margin-bottom: 15px;Â 
Â  Â  }
Â  Â  .timer-inputs.hidden {
Â  Â  Â  display: none;
Â  Â  }
Â  Â  .timer-inputs input {
Â  Â  Â  Â  width: 40px;
Â  Â  Â  Â  padding: 8px;
Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  font-size: 1em;
Â  Â  Â  Â  font-family: 'PrimaryFont', sans-serif;
Â  Â  }
Â  Â  .controls-flex {Â 
Â  Â  Â  display: flex;Â 
Â  Â  Â  justify-content: center;Â 
Â  Â  Â  gap: 10px;Â 
Â  Â  Â  flex-wrap: wrap;
Â  Â  }
Â  Â  .controls-flex button {
Â  Â  Â  Â  background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
Â  Â  Â  Â  color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer;
Â  Â  Â  Â  font-family: 'PrimaryFont', sans-serif; font-weight: 600; transition: all 0.2s ease;
Â  Â  }
Â  Â  .controls-flex button:hover {Â 
Â  Â  Â  transform: translateY(-2px);Â 
Â  Â  Â  box-shadow: 0 4px 10px rgba(103, 32, 189, 0.3);Â 
Â  Â  }
Â  Â  .controls-flex button[data-action="pause"] {Â 
Â  Â  Â  background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);Â 
Â  Â  }
Â  Â  .controls-flex button[data-action="reset"] {Â 
Â  Â  Â  background: linear-gradient(135deg, #6c757d 0%, #495057 100%);Â 
Â  Â  }
Â  Â  /* --- End Revised Styles --- */


Â  Â  /* Quick Actions Widget - New List Style */
Â  Â  .quick-actions-list {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  gap: 10px;
Â  Â  }
Â  Â  .quick-actions-list button {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  padding: 12px 15px;
Â  Â  Â  Â  background-color: #f8f9fa;
Â  Â  Â  Â  border: 1px solid #e9ecef;
Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  font-family: 'PrimaryFont', sans-serif;
Â  Â  Â  Â  font-size: 1.1em;
Â  Â  Â  Â  text-transform: uppercase;
Â  Â  Â  Â  color: #495057;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  transition: all 0.2s ease;
Â  Â  Â  Â  height: 42.5px;
Â  Â  }
Â  Â  .quick-actions-list button:hover {
Â  Â  Â  Â  background-color: #e9ecef;
Â  Â  Â  Â  border-color: #dee2e6;
Â  Â  Â  Â  transform: translateY(-1px);
Â  Â  Â  Â  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
Â  Â  }
Â  Â  .quick-actions-list button .icon {
Â  Â  Â  Â  font-size: 1.5em;
Â  Â  Â  Â  margin-right: 12px;
Â  Â  Â  Â  color: #6720bd;
Â  Â  }
Â  Â  .quick-actions-list button .text {
Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  font-weight: 500;
Â  Â  }
Â  Â  .quick-actions-list button .arrow {
Â  Â  Â  Â  font-size: 1.2em;
Â  Â  Â  Â  color: #adb5bd;
Â  Â  }


Â  Â  /* --- Modals (General) --- */
Â  Â  .modal {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  z-index: 10000;
Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  overflow: auto;
Â  Â  Â  Â  background-color: rgba(0,0,0,0.6);
Â  Â  Â  Â  font-family: 'PrimaryFont', sans-serif;
Â  Â  Â  Â  visibility: hidden;
Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  transition: opacity 0.25s ease-out, visibility 0s linear 0.25s;
Â  Â  }
Â  Â  .modal.modal-open {
Â  Â  Â  Â  visibility: visible;
Â  Â  Â  Â  opacity: 1;
Â  Â  Â  Â  transition: opacity 0.25s ease-out, visibility 0s linear 0s;
Â  Â  }
Â  Â  .modal-content {
Â  Â  Â  Â  background-color: #fefefe;
Â  Â  Â  Â  padding: 30px;
Â  Â  Â  Â  border: 1px solid #bbb;
Â  Â  Â  Â  width: 90%;
Â  Â  Â  Â  max-width: 500px;
Â  Â  Â  Â  border-radius: 18px;
Â  Â  Â  Â  box-shadow: 0 8px 30px rgba(0,0,0,0.25);
Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  color: #333;
Â  Â  Â  Â  transform: scale(0.9);
Â  Â  Â  Â  transition: transform 0.3s ease-out;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  gap: 15px;
Â  Â  }
Â  Â  .modal.modal-open .modal-content {
Â  Â  Â  Â  transform: scale(1);
Â  Â  }
Â  Â  .modal-close-btn {
Â  Â  Â  Â  color: #aaa;
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  top: 15px;
Â  Â  Â  Â  right: 18px;
Â  Â  Â  Â  font-size: 30px;
Â  Â  Â  Â  font-weight: 300;
Â  Â  Â  Â  background: none;
Â  Â  Â  Â  border: none;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  line-height: 1;
Â  Â  Â  Â  transition: color 0.2s ease;
Â  Â  }
Â  Â  .modal-close-btn:hover,
Â  Â  .modal-close-btn:focus {
Â  Â  Â  Â  color: #6720bd;
Â  Â  Â  Â  text-decoration: none;
Â  Â  }

Â  Â  /* --- Forecast Detail Modal --- */
Â  Â  #forecastDetailModal .modal-header-section {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  border-bottom: 1px solid rgba(103, 32, 189, 0.1);
Â  Â  Â  Â  padding-bottom: 15px;
Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  }
Â  Â  #forecastDetailModal .modal-header-section h3 {
Â  Â  Â  Â  margin: 0 0 8px 0;
Â  Â  Â  Â  color: #6720bd;
Â  Â  Â  Â  font-size: 1.8em;
Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  text-align: center;
Â  Â  }
Â  Â  #forecastDetailModal .modal-header-section .date-subtitle {
Â  Â  Â  Â  font-size: 1.1em;
Â  Â  Â  Â  color: #555;
Â  Â  Â  Â  font-weight: normal;
Â  Â  Â  Â  margin: 0;
Â  Â  }
Â  Â  #forecastDetailModal .modal-current-weather-summary {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  gap: 20px;
Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  }
Â  Â  #forecastDetailModal .modal-icon-large {
Â  Â  Â  Â  font-size: 4em;
Â  Â  Â  Â  color: #6720bd;
Â  Â  Â  Â  text-shadow: 0 3px 8px rgba(103, 32, 189, 0.2);
Â  Â  }
Â  Â  #forecastDetailModal .modal-temp-and-desc {
Â  Â  Â  Â  text-align: left;
Â  Â  }
Â  Â  #forecastDetailModal .modal-temp-and-desc .modal-temp-display {
Â  Â  Â  Â  font-size: 2.8em;
Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  color: #333;
Â  Â  Â  Â  line-height: 1;
Â  Â  Â  Â  margin-bottom: 5px;
Â  Â  }
Â  Â  #forecastDetailModal .modal-temp-and-desc #modalWeatherDesc {
Â  Â  Â  Â  font-size: 1.2em;
Â  Â  Â  Â  font-weight: 500;
Â  Â  Â  Â  color: #666;
Â  Â  }
Â  Â  #forecastDetailModal .modal-details-grid {
Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
Â  Â  Â  Â  gap: 10px 20px;
Â  Â  Â  Â  margin-bottom: 15px; /* Added for spacing */
Â  Â  }
Â  Â  #forecastDetailModal .modal-details-grid p {
Â  Â  Â  Â  font-size: 0.9em;
Â  Â  Â  Â  line-height: 1.5;
Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  gap: 8px;
Â  Â  Â  Â  color: #444;
Â  Â  }
Â  Â  #forecastDetailModal .modal-details-grid p strong {
Â  Â  Â  Â  color: #222;
Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  gap: 5px;
Â  Â  }
Â  Â  #forecastDetailModal .modal-details-grid .detail-icon {
Â  Â  Â  Â  font-size: 1.1em;
Â  Â  Â  Â  color: #8a2be2;
Â  Â  }

Â  Â  /* --- START: New Weather Advice Styles --- */
Â  Â  .weather-advice-section {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  gap: 12px;
Â  Â  Â  Â  padding: 12px 15px;
Â  Â  Â  Â  background-color: rgba(103, 32, 189, 0.05);
Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  border: 1px solid rgba(103, 32, 189, 0.1);
Â  Â  }
Â  Â  .weather-advice-section .advice-icon {
Â  Â  Â  Â  font-size: 1.8em;
Â  Â  Â  Â  color: #6720bd;
Â  Â  Â  Â  flex-shrink: 0;
Â  Â  }
Â  Â  .weather-advice-section p {
Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  font-size: 0.95em;
Â  Â  Â  Â  color: #333;
Â  Â  Â  Â  font-weight: 500;
Â  Â  Â  Â  line-height: 1.4;
Â  Â  }
Â  Â  /* --- END: New Weather Advice Styles --- */

Â  Â  /* --- Weather Settings Modal --- */
Â  Â  .weather-settings-modal .modal-content {
Â  Â  Â  gap: 20px;
Â  Â  }
Â  Â  .weather-settings-modal h3 {
Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  font-size: 1.6em;
Â  Â  Â  Â  color: #6720bd;
Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  font-family: 'PrimaryFont', sans-serif;
Â  Â  }
Â  Â  .settings-section {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  gap: 12px;
Â  Â  }
Â  Â  .settings-section label {
Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  color: #555;
Â  Â  Â  Â  font-size: 1.1em;
Â  Â  Â  Â  font-family: 'PrimaryFont', sans-serif;
Â  Â  }
Â  Â  .location-input-wrapper {
Â  Â  Â  Â  position: relative;
Â  Â  }
Â  Â  #weatherLocationInput {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  padding: 12px 15px;
Â  Â  Â  Â  font-size: 1em;
Â  Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  transition: border-color 0.2s, box-shadow 0.2s;
Â  Â  Â  Â  font-family: 'PrimaryFont', sans-serif; /* Ensure font */
Â  Â  }
Â  Â  #weatherLocationInput:focus {
Â  Â  Â  Â  outline: none;
Â  Â  Â  Â  border-color: #8a2be2;
Â  Â  Â  Â  box-shadow: 0 0 0 3px rgba(103, 32, 189, 0.2);
Â  Â  }
Â  Â  #locationSuggestions {
Â  Â  Â  Â  list-style: none;
Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  margin: 5px 0 0 0;
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  background: white;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  border: 1px solid #ddd;
Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  max-height: 150px;
Â  Â  Â  Â  overflow-y: auto;
Â  Â  Â  Â  z-index: 10001;
Â  Â  Â  Â  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
Â  Â  }
Â  Â  #locationSuggestions li {
Â  Â  Â  Â  padding: 10px 15px;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  transition: background-color 0.2s;
Â  Â  Â  Â  border-bottom: 1px solid #eee;
Â  Â  Â  Â  font-family: 'PrimaryFont', sans-serif; /* Ensure font */
Â  Â  }
Â  Â  #locationSuggestions li:last-child {
Â  Â  Â  Â  border-bottom: none;
Â  Â  }
Â  Â  #locationSuggestions li:hover {
Â  Â  Â  Â  background-color: #f0f2f5;
Â  Â  }
Â  Â  #useCurrentLocationBtn {
Â  Â  Â  Â  padding: 10px 15px;
Â  Â  Â  Â  font-size: 0.95em;
Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
Â  Â  Â  Â  color: white;
Â  Â  Â  Â  border: none;
Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  transition: all 0.2s ease;
Â  Â  Â  Â  font-family: 'PrimaryFont', sans-serif; /* Ensure font */
Â  Â  }
Â  Â  #useCurrentLocationBtn:hover {
Â  Â  Â  Â  transform: translateY(-2px);
Â  Â  Â  Â  box-shadow: 0 4px 10px rgba(103, 32, 189, 0.3);
Â  Â  }
Â  Â  #useCurrentLocationBtn:disabled {
Â  Â  Â  Â  background: #aaa;
Â  Â  Â  Â  cursor: not-allowed;
Â  Â  Â  Â  transform: none;
Â  Â  Â  Â  box-shadow: none;
Â  Â  }
Â  Â  .unit-toggle-wrapper {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  background-color: #f8f9fa;
Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  font-family: 'PrimaryFont', sans-serif; /* Ensure font */
Â  Â  }
Â  Â  /* Custom Toggle Switch */
Â  Â  .switch {
Â  Â  Â  position: relative;
Â  Â  Â  display: inline-block;
Â  Â  Â  width: 60px;
Â  Â  Â  height: 34px;
Â  Â  }
Â  Â  .switch input { display:none; }
Â  Â  .slider {
Â  Â  Â  position: absolute;
Â  Â  Â  cursor: pointer;
Â  Â  Â  top: 0; left: 0; right: 0; bottom: 0;
Â  Â  Â  background-color: #ccc;
Â  Â  Â  transition: .4s;
Â  Â  Â  border-radius: 34px;
Â  Â  }
Â  Â  .slider:before {
Â  Â  Â  position: absolute;
Â  Â  Â  content: "";
Â  Â  Â  height: 26px; width: 26px;
Â  Â  Â  left: 4px; bottom: 4px;
Â  Â  Â  background-color: white;
Â  Â  Â  transition: .4s;
Â  Â  Â  border-radius: 50%;
Â  Â  }
Â  Â  input:checked + .slider {
Â  Â  Â  background-color: #6720bd;
Â  Â  }
Â  Â  input:checked + .slider:before {
Â  Â  Â  transform: translateX(26px);
Â  Â  }
Â  Â  .slider:after{
Â  Â  Â  content:'Â°F';
Â  Â  Â  color: white;
Â  Â  Â  display: block;
Â  Â  Â  position: absolute;
Â  Â  Â  transform: translate(-50%,-50%);
Â  Â  Â  top: 50%;
Â  Â  Â  left: 75%;
Â  Â  Â  font-size: 12px;
Â  Â  Â  font-family: sans-serif;
Â  Â  }
Â  Â  input:checked + .slider:after {Â Â 
Â  Â  Â  content:'Â°C';
Â  Â  Â  left: 25%;
Â  Â  }

Â  Â  /* --- START: New Styles for Shortcut Settings Modal --- */
Â  Â  .shortcut-settings-modal .modal-content {
Â  Â  Â  Â  max-width: 600px;
Â  Â  Â  Â  gap: 10px;
Â  Â  }
Â  Â  .shortcut-settings-modal h3 {
Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  font-size: 1.6em;
Â  Â  Â  Â  color: #6720bd;
Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  font-family: 'PrimaryFont', sans-serif;
Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  }
Â  Â  #shortcutSettingsForm {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  gap: 20px;
Â  Â  Â  Â  max-height: 60vh;
Â  Â  Â  Â  overflow-y: auto;
Â  Â  Â  Â  padding-right: 10px;
Â  Â  }
Â  Â  .shortcut-editor-group {
Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  border: 1px solid #ddd;
Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  background-color: #f9f9f9;
Â  Â  }
Â  Â  .shortcut-editor-group h4 {
Â  Â  Â  Â  margin-top: 0;
Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  color: #333;
Â  Â  Â  Â  border-bottom: 1px solid #eee;
Â  Â  Â  Â  padding-bottom: 8px;
Â  Â  }
Â  Â  .shortcut-input-row {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  gap: 10px;
Â  Â  Â  Â  margin-bottom: 12px;
Â  Â  }
Â  Â  .shortcut-input-row label {
Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  color: #555;
Â  Â  Â  Â  white-space: nowrap;
Â  Â  }
Â  Â  .shortcut-input-row input[type="text"],
Â  Â  .shortcut-input-row input[type="url"],
Â  Â  .shortcut-input-row select {
Â  Â  Â  Â  padding: 8px 10px;
Â  Â  Â  Â  font-size: 1em;
Â  Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  Â  border-radius: 6px;
Â  Â  Â  Â  box-sizing: border-box;
Â  Â  Â  Â  font-family: 'PrimaryFont', sans-serif;
Â  Â  Â  Â  flex: 1 1 150px; /* Allow wrapping */
Â  Â  }
Â  Â  .shortcut-emoji-input {
Â  Â  Â  Â  flex: 0 1 60px;
Â  Â  }
Â  Â  .shortcut-name-input {
Â  Â  Â  Â  flex: 1 1 200px;
Â  Â  }
Â  Â  .action-target-wrapper .hidden {
Â  Â  Â  Â  display: none;
Â  Â  }
Â  Â  .shortcut-modal-buttons {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  justify-content: flex-end;
Â  Â  Â  Â  gap: 10px;
Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  border-top: 1px solid #eee;
Â  Â  Â  Â  padding-top: 20px;
Â  Â  }
Â  Â  .shortcut-modal-buttons button {
Â  Â  Â  Â  padding: 10px 20px;
Â  Â  Â  Â  border: none;
Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  font-family: 'PrimaryFont', sans-serif;
Â  Â  Â  Â  transition: all 0.2s ease;
Â  Â  }
Â  Â  #saveShortcutsBtn {
Â  Â  Â  Â  background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
Â  Â  Â  Â  color: white;
Â  Â  }
Â  Â  #saveShortcutsBtn:hover {
Â  Â  Â  Â  transform: translateY(-2px);
Â  Â  Â  Â  box-shadow: 0 4px 10px rgba(103, 32, 189, 0.3);
Â  Â  }
Â  Â  #resetShortcutsBtn {
Â  Â  Â  Â  background-color: #6c757d;
Â  Â  Â  Â  color: white;
Â  Â  }
Â  Â  #resetShortcutsBtn:hover {
Â  Â  Â  Â  background-color: #5a6268;
Â  Â  }
Â  Â  /* --- END: New Styles for Shortcut Settings Modal --- */

Â  Â  /* --- Responsive Design --- */
Â  Â  @media (max-width: 1199px) and (min-width: 768px) {
Â  Â  Â  Â  .dashboard-card[data-card-type="medium"],
Â  Â  Â  Â  .dashboard-card[data-card-type="small"],
Â  Â  Â  Â  .dashboard-card[data-card-type="full"] {
Â  Â  Â  Â  Â  Â  /* All cards take 1fr of the auto-fit columns */
Â  Â  Â  Â  }
Â  Â  }

Â  Â  @media (max-width: 767px) {
Â  Â  Â  .dashboard-grid {
Â  Â  Â  Â  grid-template-columns: 1fr;
Â  Â  Â  }
Â  Â  Â  .dashboard-card {
Â  Â  Â  Â  grid-column: span 1 / auto !important;
Â  Â  Â  }
Â  Â  Â  .current-weather-layout {
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  align-items: flex-start;
Â  Â  Â  }
Â  Â  Â  .current-weather-details-aside {
Â  Â  Â  Â  padding-left: 0;
Â  Â  Â  Â  margin-left: 0;
Â  Â  Â  Â  border-left: none;
Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  align-items: flex-start; /* Align to left on small screens */
Â  Â  Â  }
Â  Â  Â  .dashboard-header {
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  gap: 15px;
Â  Â  Â  Â  text-align: center;
Â  Â  Â  }
Â  Â  Â  /* --- START: Responsive Battery Style --- */
Â  Â  Â  .dashboard-title-wrapper {
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  gap: 10px;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  }
Â  Â  Â  /* --- END: Responsive Battery Style --- */
Â  Â  Â  .search-container { /* Adjust search for mobile */
Â  Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  }
Â  Â  Â  .main-content {
Â  Â  Â  Â  padding: 20px;
Â  Â  Â  }
Â  Â  Â  .weather-icon-large { font-size: 3em; }
Â  Â  Â  .temp-large { font-size: 2.2em; }
Â  Â  Â  .clock-display { font-size: 2em; }
Â  Â  Â  .date-display { font-size: 0.9em; }
Â  Â  Â  .additional-time-info { font-size: 0.75em; margin-top: 8px;}
Â  Â  Â  .stopwatch-display, .timer-display-value { font-size: 1.8em;}
Â  Â  Â  .quick-actions-list button { font-size: 0.9em; padding: 10px 12px;}
Â  Â  Â  .quick-actions-list button .icon { font-size: 1.3em; margin-right: 10px;}

Â  Â  Â  /* Modal on small screens */
Â  Â  Â  .modal-content {
Â  Â  Â  Â  width: 95%;
Â  Â  Â  Â  padding: 20px;
Â  Â  Â  }
Â  Â  Â  #forecastDetailModal .modal-header-section h3 { font-size: 1.5em; }
Â  Â  Â  #forecastDetailModal .modal-header-section .date-subtitle { font-size: 1em; }
Â  Â  Â  #forecastDetailModal .modal-current-weather-summary {
Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  gap: 10px;
Â  Â  Â  }
Â  Â  Â  #forecastDetailModal .modal-temp-and-desc {
Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  }
Â  Â  Â  #forecastDetailModal .modal-icon-large { font-size: 3.5em; }
Â  Â  Â  #forecastDetailModal .modal-temp-and-desc .modal-temp-display { font-size: 2.5em; }
Â  Â  Â  #forecastDetailModal .modal-temp-and-desc #modalWeatherDesc { font-size: 1.1em; }
Â  Â  Â  #forecastDetailModal .modal-details-grid {
Â  Â  Â  Â  Â  grid-template-columns: 1fr;
Â  Â  Â  Â  Â  gap: 8px;
Â  Â  Â  }
Â  Â  }

Â  Â  /* --- Animation Classes --- */
Â  Â  .fade-in {
Â  Â  Â  animation: fadeIn 0.6s ease-out;
Â  Â  }
Â  Â  @keyframes fadeIn {
Â  Â  Â  from { opacity: 0; transform: translateY(20px); }
Â  Â  Â  to { opacity: 1; transform: translateY(0); }
Â  Â  }
Â  Â  .slide-in {
Â  Â  Â  animation: slideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
Â  Â  }
Â  Â  @keyframes slideIn {
Â  Â  Â  from { transform: translateX(-100%); opacity: 0; }
Â  Â  Â  to { transform: translateX(0); opacity: 1; }
Â  Â  }
Â  </style>
</head>

<body class="dashboard-page">
Â  <header class="main-header light-bg">
Â  Â  <div class="container">
Â  Â  Â  <div class="logo">
Â  Â  Â  Â  <a href="../index.html">
Â  Â  Â  Â  Â  <img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer" />
Â  Â  Â  Â  </a>
Â  Â  Â  </div>
Â  Â  Â  <div class="auth-buttons">
Â  Â  Â  Â  <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button>
Â  Â  Â  Â  <button id="logoutBtn" class="btn btn-login">LOG OUT</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </header>

Â  <div class="dashboard-container">
Â  Â  <aside class="sidebar slide-in" id="sidebar">
Â  Â  Â  <button id="toggleSidebar">â˜°</button>
Â  Â  Â  <div class="user-info">
Â  Â  Â  Â  <div class="marquee-container">
Â  Â  Â  Â  Â  <span id="userName" class="marquee-content username">Loadingâ€¦</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="marquee-container">
Â  Â  Â  Â  Â  <span id="userEmail" class="marquee-content email">Loadingâ€¦</span>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <nav>
Â  Â  Â  Â  <ul>
Â  Â  Â  Â  Â  <li><a href="dashboard.html" class="active"><span class="icon">ğŸ </span><span class="label">Dashboard</span></a></li>
Â  Â  Â  Â  Â  <li><a href="soundboard.html"><span class="icon">ğŸµ</span><span class="label">Soundboard</span></a></li>
Â  Â  Â  Â  Â  <li><a href="games.html"><span class="icon">ğŸ®</span><span class="label">Games</span></a></li>
Â  Â  Â  Â  Â  <li><a href="others.html"><span class="icon">âœ¨</span><span class="label">Others</span></a></li>
Â  Â  Â  Â  Â  <li><a href="settings.html"><span class="icon">âš™ï¸</span><span class="label">Settings</span></a></li>
Â  Â  Â  Â  Â  <li><a href="#" id="signOutLink"><span class="icon">ğŸ”’</span><span class="label">LOG OUT</span></a></li>
Â  Â  Â  Â  </ul>
Â  Â  Â  </nav>
Â  Â  </aside>

Â  Â  <main class="main-content fade-in">
Â  Â  Â  <div class="dashboard-header">
Â  Â  Â  Â  <div class="dashboard-title-wrapper">
Â  Â  Â  Â  Â  Â  <h2 class="dashboard-title">Dashboard</h2>
Â  Â  Â  Â  Â  Â  <div id="battery-status" class="battery-status-container">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="battery-charging-status">Checking...</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="battery-level">Percentage: --%</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="dashboard-controls">
Â  Â  Â  Â  Â  <div class="search-container">
Â  Â  Â  Â  Â  Â  <input type="text" id="dashboardSearch" placeholder="ğŸ” Search pages & features...">
Â  Â  Â  Â  Â  Â  <div id="searchSuggestions" class="suggestions-container"></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="dashboard-grid" id="dashboardGrid">
Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  </main>
Â  </div>

Â  <div id="forecastDetailModal" class="modal">
Â  Â  <div class="modal-content">
Â  Â  Â  Â  <button class="modal-close-btn">&times;</button>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="modal-header-section">
Â  Â  Â  Â  Â  Â  <h3 id="modalDayDate">Day, Date</h3>
Â  Â  Â  Â  Â  Â  <p class="date-subtitle" id="modalFullDateSubtitle"></p>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="modal-current-weather-summary">
Â  Â  Â  Â  Â  Â  <span id="modalWeatherIcon" class="modal-icon-large">â“</span>
Â  Â  Â  Â  Â  Â  <div class="modal-temp-and-desc">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="modal-temp-display">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="modalMaxTemp">--</span> / <span id="modalMinTemp">--</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="modalWeatherDesc">Description</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="modal-details-grid">
Â  Â  Â  Â  Â  Â  <p><strong><span class="detail-icon">ğŸŒ¡ï¸</span>Feels Like:</strong> <span id="modalFeelsLike">--</span></p>
Â  Â  Â  Â  Â  Â  <p><strong><span class="detail-icon">ğŸ’§</span>Humidity:</strong> <span id="modalHumidity">--</span>%</p>
Â  Â  Â  Â  Â  Â  <p><strong><span class="detail-icon">ğŸŒ§ï¸</span>Precipitation:</strong> <span id="modalPrecipSum">--</span> mm</p>
Â  Â  Â  Â  Â  Â  <p><strong><span class="detail-icon">â˜”</span>Precip. Chance:</strong> <span id="modalPrecipProb">--</span>%</p>
Â  Â  Â  Â  Â  Â  <p><strong><span class="detail-icon">ğŸ’¨</span>Max Wind:</strong> <span id="modalWindSpeed">--</span></p>
Â  Â  Â  Â  Â  Â  <p><strong><span class="detail-icon">ğŸ§­</span>Wind Direction:</strong> <span id="modalWindDirection">--</span></p>
Â  Â  Â  Â  Â  Â  <p><strong><span class="detail-icon">â˜€ï¸</span>Sunrise:</strong> <span id="modalSunriseTime">--:--</span></p>
Â  Â  Â  Â  Â  Â  <p><strong><span class="detail-icon">ğŸŒ‡</span>Sunset:</strong> <span id="modalSunsetTime">--:--</span></p>
Â  Â  Â  Â  Â  Â  <p><strong><span class="detail-icon">ğŸ’¡</span>Daylight:</strong> <span id="modalDaylightDuration">--</span></p>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="weather-advice-section">
Â  Â  Â  Â  Â  Â  <span class="advice-icon">ğŸ’¡</span>
Â  Â  Â  Â  Â  Â  <p id="modalWeatherAdvice">Loading advice...</p>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
Â Â 
Â  <div id="weatherSettingsModal" class="modal weather-settings-modal">
Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  <button class="modal-close-btn">&times;</button>
Â  Â  Â  Â  Â  <h3>Weather Settings</h3>
Â  Â  Â  Â  Â  <div class="settings-section">
Â  Â  Â  Â  Â  Â  Â  <label for="weatherLocationInput">Location</label>
Â  Â  Â  Â  Â  Â  Â  <div class="location-input-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="weatherLocationInput" placeholder="Enter a city name...">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul id="locationSuggestions"></ul>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <button id="useCurrentLocationBtn">ğŸ“ Use My Current Location</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="settings-section">
Â  Â  Â  Â  Â  Â  Â  <label>Units</label>
Â  Â  Â  Â  Â  Â  Â  <div class="unit-toggle-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Imperial (Â°F) / Metric (Â°C)</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="switch">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="unitToggle">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="slider"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  </div>

Â  <div id="shortcutSettingsModal" class="modal shortcut-settings-modal">
Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  <button class="modal-close-btn">&times;</button>
Â  Â  Â  Â  Â  <h3>Edit Quick Shortcuts</h3>
Â  Â  Â  Â  Â  <form id="shortcutSettingsForm" onsubmit="return false;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  </div>
Â  </div>
Â  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
Â  <script src="../firebase-config.js"></script>
Â  <script>
Â  Â  // --- Globals & Firebase Refs ---
Â  Â  const dbRef = () =>
Â  Â  Â  firebase.auth().currentUser
Â  Â  Â  Â  ? firebase.firestore().collection('users').doc(firebase.auth().currentUser.uid)
Â  Â  Â  Â  : null;

Â  Â  // --- DOM Elements ---
Â  Â  const marqueeEls = document.querySelectorAll('.marquee-content');
Â  Â  const dashboardGrid = document.getElementById('dashboardGrid');
Â  Â  const userNameEl = document.getElementById('userName');
Â  Â Â 
Â  Â  // --- START: Search Bar Suggestions Data (used by search bar and shortcuts modal) ---
Â  Â  const pageSuggestions = [
Â  Â  Â  Â  { name: 'Dashboard Home', url: 'dashboard.html' },
Â  Â  Â  Â  { name: 'Games Page', url: 'games.html' },
Â  Â  Â  Â  { name: 'Soundboard', url: 'soundboard.html' },
Â  Â  Â  Â  { name: 'Others Page', url: 'others.html' },
Â  Â  Â  Â  { name: 'Notes Page', url: 'notes.html' },
Â  Â  Â  Â  { name: 'Requests Page', url: 'requests.html' },
Â  Â  Â  Â  { name: 'Countdowns Page', url: 'countdowns.html' },
Â  Â  Â  Â  { name: 'Playlists Page', url: 'playlists.html' },
Â  Â  Â  Â  { name: 'Weather Page', url: 'weather.html' },
Â  Â  Â  Â  { name: 'GB-GAMES', url: '../GB-GAMES/index.html' },
Â  Â  Â  Â  { name: 'GN-MATH Games', url: '../GN-GAMES/index.html' },
Â  Â  Â  Â  { name: 'User Settings', url: 'settings.html' },
Â  Â  Â  Â  { name: 'Calculator Page', url: 'calculator.html' },
Â  Â  Â  Â  { name: 'Slotz', url: 'slotz.html' },
Â  Â  Â  Â  { name: 'LME Page', url: 'lme.html' },
Â  Â  Â  Â  // These items scroll to a widget on the current page instead of redirecting
Â  Â  Â  Â  { name: 'Scroll to Weather', url: '#', action: () => { const el = document.querySelector('[data-template-id="weather_large_widget"]'); if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' }); } },
Â  Â  Â  Â  { name: 'Scroll to Clock', url: '#', action: () => { const el = document.querySelector('[data-template-id="clock_widget"]'); if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' }); } },
Â  Â  Â  Â  { name: 'Scroll to Stopwatch', url: '#', action: () => { const el = document.querySelector('[data-template-id="stopwatch_widget"]'); if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' }); } },
Â  Â  Â  Â  { name: 'Scroll to Timer', url: '#', action: () => { const el = document.querySelector('[data-template-id="timer_widget"]'); if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' }); } }
Â  Â  ];
Â  Â  // --- END: Search Bar Suggestions Data ---

Â  Â  // --- Weather Settings ---
Â  Â  let weatherSettings = {
Â  Â  Â  Â  location: {
Â  Â  Â  Â  Â  Â  label: 'Massillon, OH',
Â  Â  Â  Â  Â  Â  latitude: 40.7909,
Â  Â  Â  Â  Â  Â  longitude: -81.5218,
Â  Â  Â  Â  },
Â  Â  Â  Â  units: 'imperial' // 'imperial' or 'metric'
Â  Â  };
Â  Â  let userCoords = null; // To store user's actual location for suggestion proximity

Â  Â  const WMO_CODES = {
Â  Â  Â  0: { description: "Clear sky", icon: "â˜€ï¸" }, 1: { description: "Mainly clear", icon: "ğŸŒ¤ï¸" },
Â  Â  Â  2: { description: "Partly cloudy", icon: "ğŸŒ¥ï¸" }, 3: { description: "Overcast", icon: "â˜ï¸" },
Â  Â  Â  45: { description: "Fog", icon: "ğŸŒ«ï¸" }, 48: { description: "Depositing rime fog", icon: "ğŸŒ«ï¸" },
Â  Â  Â  51: { description: "Light drizzle", icon: "ğŸŒ¦ï¸" }, 53: { description: "Moderate drizzle", icon: "ğŸŒ¦ï¸" },
Â  Â  Â  55: { description: "Dense drizzle", icon: "ğŸŒ¦ï¸" }, 56: { description: "Light freezing drizzle", icon: "ğŸŒ¨ï¸" },
Â  Â  Â  57: { description: "Dense freezing drizzle", icon: "ğŸŒ¨ï¸" }, 61: { description: "Slight rain", icon: "ğŸŒ§ï¸" },
Â  Â  Â  63: { description: "Moderate rain", icon: "ğŸŒ§ï¸" }, 65: { description: "Heavy rain", icon: "ğŸŒ§ï¸" },
Â  Â  Â  66: { description: "Light freezing rain", icon: "ğŸŒ¨ï¸" }, 67: { description: "Heavy freezing rain", icon: "ğŸŒ¨ï¸" },
Â  Â  Â  71: { description: "Slight snow fall", icon: "â„ï¸" }, 73: { description: "Moderate snow fall", icon: "â„ï¸" },
Â  Â  Â  75: { description: "Heavy snow fall", icon: "â„ï¸" }, 77: { description: "Snow grains", icon: "â„ï¸" },
Â  Â  Â  80: { description: "Slight rain showers", icon: "ğŸŒ¦ï¸" }, 81: { description: "Moderate rain showers", icon: "ğŸŒ¦ï¸" },
Â  Â  Â  82: { description: "Violent rain showers", icon: "â›ˆï¸" }, 85: { description: "Slight snow showers", icon: "ğŸŒ¨ï¸" },
Â  Â  Â  86: { description: "Heavy snow showers", icon: "ğŸŒ¨ï¸" }, 95: { description: "Thunderstorm", icon: "â›ˆï¸" },
Â  Â  Â  96: { description: "Thunderstorm with slight hail", icon: "â›ˆï¸" }, 99: { description: "Thunderstorm with heavy hail", icon: "â›ˆï¸" },
Â  Â  };
Â  Â Â 
Â  Â  // --- START: New Shortcut Widget Globals ---
Â  Â  const QUICK_ACTIONS_STORAGE_KEY = '4sp_quickActions_v1';
Â  Â  const defaultQuickActions = [
Â  Â  Â  Â  { icon: 'â›…', text: 'Weather', type: 'page', value: 'weather.html' },
Â  Â  Â  Â  { icon: 'ğŸ“', text: 'Notes', type: 'page', value: 'notes.html' },
Â  Â  Â  Â  { icon: 'ğŸµ', text: 'Requests', type: 'page', value: 'requests.html' },
Â  Â  Â  Â  { icon: 'ğŸ“Š', text: 'Countdowns', type: 'page', value: 'countdowns.html' },
Â  Â  ];
Â  Â  let currentQuickActions = [...defaultQuickActions];
Â  Â  // --- END: New Shortcut Widget Globals ---

Â  Â  // --- Modal Elements & Functions ---
Â  Â  const forecastModal = document.getElementById('forecastDetailModal');
Â  Â  const weatherSettingsModal = document.getElementById('weatherSettingsModal');
Â  Â  const shortcutSettingsModal = document.getElementById('shortcutSettingsModal'); // New modal
Â  Â Â 
Â  Â  function setupModal(modal) {
Â  Â  Â  Â  if (!modal) return;
Â  Â  Â  Â  const closeBtn = modal.querySelector('.modal-close-btn');
Â  Â  Â  Â  if (closeBtn) {
Â  Â  Â  Â  Â  Â  closeBtn.onclick = () => modal.classList.remove('modal-open');
Â  Â  Â  Â  }
Â  Â  Â  Â  modal.onclick = (event) => {
Â  Â  Â  Â  Â  Â  if (event.target === modal) {
Â  Â  Â  Â  Â  Â  Â  Â  modal.classList.remove('modal-open');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };
Â  Â  }
Â  Â  setupModal(forecastModal);
Â  Â  setupModal(weatherSettingsModal);
Â  Â  setupModal(shortcutSettingsModal); // Setup new modal

Â  Â  function formatModalTime(isoString, timeZone) {
Â  Â  Â  Â  if (!isoString || isoString === 'N/A') return 'N/A';
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const date = new Date(isoString);
Â  Â  Â  Â  Â  Â  return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', timeZone: timeZone, hour12: true });
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  console.error("Error formatting modal time:", e);
Â  Â  Â  Â  Â  Â  return 'N/A';
Â  Â  Â  Â  }
Â  Â  }
Â  Â  function formatDaylightDuration(totalSeconds) {
Â  Â  Â  Â  if (totalSeconds === null || totalSeconds === undefined || totalSeconds === 'N/A' || isNaN(totalSeconds)) return 'N/A';
Â  Â  Â  Â  const hours = Math.floor(totalSeconds / 3600);
Â  Â  Â  Â  const minutes = Math.floor((totalSeconds % 3600) / 60);
Â  Â  Â  Â  return `${hours}h ${minutes}m`;
Â  Â  }

Â  Â  function degreesToCardinal(degrees) {
Â  Â  Â  Â  if (degrees === null || degrees === undefined || degrees === 'N/A' || isNaN(degrees)) return 'N/A';
Â  Â  Â  Â  const val = Math.floor((degrees / 22.5) + 0.5);
Â  Â  Â  Â  const arr = ["N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE", "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW"];
Â  Â  Â  Â  return arr[(val % 16)];
Â  Â  }

Â  Â  /**
Â  Â  Â * Generates a brief piece of advice based on weather conditions.
Â  Â  Â * @param {object} dayData - The weather data for a specific day.
Â  Â  Â * @param {string} units - 'imperial' or 'metric'.
Â  Â  Â * @returns {string} - A string containing the advice.
Â  Â  Â */
Â  Â  function getWeatherAdvice(dayData, units) {
Â  Â  Â  Â  const { weatherCode, tempMax, precipProb } = dayData;

Â  Â  Â  Â  // Weather codes for snow/freezing conditions
Â  Â  Â  Â  const snowCodes = [56, 57, 66, 67, 71, 73, 75, 77, 85, 86];
Â  Â  Â  Â  // Weather codes for rain/thunderstorms
Â  Â  Â  Â  const rainCodes = [51, 53, 55, 61, 63, 65, 80, 81, 82, 95, 96, 99];

Â  Â  Â  Â  if (snowCodes.includes(weatherCode)) {
Â  Â  Â  Â  Â  Â  return "â„ï¸ It might snow. Remember to wear your snow boots and drive safely!";
Â  Â  Â  Â  }

Â  Â  Â  Â  if (rainCodes.includes(weatherCode) || (precipProb && precipProb > 40)) {
Â  Â  Â  Â  Â  Â  return "â˜” Looks like rain is possible. Don't forget to bring an umbrella!";
Â  Â  Â  Â  }

Â  Â  Â  Â  const hotTemp = units === 'imperial' ? 85 : 29; // 85Â°F or 29Â°C
Â  Â  Â  Â  if (tempMax > hotTemp) {
Â  Â  Â  Â  Â  Â  return "â˜€ï¸ It's going to be hot! Remember to wear sunscreen and stay hydrated.";
Â  Â  Â  Â  }

Â  Â  Â  Â  const coolTemp = units === 'imperial' ? 60 : 15; // 60Â°F or 15Â°C
Â  Â  Â  Â  const coldTemp = units === 'imperial' ? 45 : 7; // 45Â°F or 7Â°C

Â  Â  Â  Â  if (tempMax < coldTemp) {
Â  Â  Â  Â  Â  Â  return "ğŸ¥¶ Brrr, it's cold! A warm jacket is a must.";
Â  Â  Â  Â  }

Â  Â  Â  Â  if (tempMax < coolTemp) {
Â  Â  Â  Â  Â  Â  return "ğŸ§¥ It's a bit chilly today. A hoodie or light jacket would be a good idea.";
Â  Â  Â  Â  }

Â  Â  Â  Â  // Default "nice day" message
Â  Â  Â  Â  return "ğŸ‘ Looks like a beautiful day outside. Enjoy it!";
Â  Â  }

Â  Â  function getShortLocationLabel(address, fullDisplayName) {
Â  Â  Â  Â  if (!address) return fullDisplayName;

Â  Â  Â  Â  const city = address.city || address.town || address.village || address.hamlet;

Â  Â  Â  Â  if (address.house_number && address.road && city) {
Â  Â  Â  Â  Â  Â  return `${address.house_number} ${address.road}, ${city}`;
Â  Â  Â  Â  }
Â  Â  Â  Â  if (address.road && city) {
Â  Â  Â  Â  Â  Â  return `${address.road}, ${city}`;
Â  Â  Â  Â  }
Â  Â  Â  Â  if (city && address.state) {
Â  Â  Â  Â  Â  Â  return `${city}, ${address.state}`;
Â  Â  Â  Â  }
Â  Â  Â  Â  if (city && address.country) {
Â  Â  Â  Â  Â  Â  return `${city}, ${address.country}`;
Â  Â  Â  Â  }
Â  Â  Â  Â  if (city) {
Â  Â  Â  Â  Â  Â  return city;
Â  Â  Â  Â  }
Â  Â  Â  Â  return fullDisplayName;
Â  Â  }


Â  Â  async function fetchCityName(lat, lon) {
Â  Â  Â  Â  const nominatimUrl = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`;
Â  Â  Â  Â  const fallbackLabel = `Lat: ${parseFloat(lat).toFixed(2)}, Lon: ${parseFloat(lon).toFixed(2)}`;
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const response = await fetch(nominatimUrl);
Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  console.warn(`Nominatim API error: ${response.status}`);
Â  Â  Â  Â  Â  Â  Â  Â  return { label: fallbackLabel, country_code: 'us' };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  Â  Â  if (data && data.address) {
Â  Â  Â  Â  Â  Â  Â  Â  const label = getShortLocationLabel(data.address, data.display_name);
Â  Â  Â  Â  Â  Â  Â  Â  return { label, country_code: data.address.country_code || 'us' };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return { label: fallbackLabel, country_code: 'us' };
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Error fetching city name:", error);
Â  Â  Â  Â  Â  Â  return { label: fallbackLabel, country_code: 'us' };
Â  Â  Â  Â  }
Â  Â  }


Â  Â  function openForecastModal(dayData, dailyTimeZone, displayUnits, speedSuffixUnit, currentApparentTemp, currentHumidity) {
Â  Â  Â  Â  if (!forecastModal) return;

Â  Â  Â  Â  const { dateStr, weatherCode, tempMax, tempMin, precipSum, precipProb, windSpeedMax, sunrise, sunset, daylightDuration, windDirection } = dayData;
Â  Â  Â  Â  const tempSuffix = displayUnits === 'metric' ? 'Â°C' : 'Â°F';

Â  Â  Â  Â  const parts = dateStr.split('-').map(s => parseInt(s, 10));
Â  Â  Â  Â  const utcDateForModal = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2], 12, 0, 0));
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById('modalDayDate').textContent = utcDateForModal.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: dailyTimeZone });
Â  Â  Â  Â  document.getElementById('modalFullDateSubtitle').textContent = utcDateForModal.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric', timeZone: dailyTimeZone });

Â  Â  Â  Â  const codeInfo = WMO_CODES[weatherCode] || { description: "Unknown", icon: "â“" };
Â  Â  Â  Â  document.getElementById('modalWeatherIcon').textContent = codeInfo.icon;
Â  Â  Â  Â  document.getElementById('modalWeatherDesc').textContent = codeInfo.description;

Â  Â  Â  Â  document.getElementById('modalMaxTemp').textContent = `${Math.round(tempMax)}${tempSuffix}`;
Â  Â  Â  Â  document.getElementById('modalMinTemp').textContent = `${Math.round(tempMin)}${tempSuffix}`;
Â  Â  Â  Â  document.getElementById('modalPrecipSum').textContent = `${precipSum !== 'N/A' && precipSum !== null ? precipSum : '--'}`;
Â  Â  Â  Â  document.getElementById('modalPrecipProb').textContent = `${precipProb !== 'N/A' && precipProb !== null ? precipProb : '--'}`;
Â  Â  Â  Â  document.getElementById('modalWindSpeed').textContent = `${windSpeedMax !== 'N/A' && windSpeedMax !== null ? Math.round(windSpeedMax) : '--'} ${speedSuffixUnit}`;
Â  Â  Â  Â  document.getElementById('modalWindDirection').textContent = degreesToCardinal(windDirection);
Â  Â  Â  Â  document.getElementById('modalDaylightDuration').textContent = formatDaylightDuration(daylightDuration);
Â  Â  Â  Â  document.getElementById('modalSunriseTime').textContent = formatModalTime(sunrise, dailyTimeZone);
Â  Â  Â  Â  document.getElementById('modalSunsetTime').textContent = formatModalTime(sunset, dailyTimeZone);
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById('modalFeelsLike').textContent = `${currentApparentTemp !== null ? Math.round(currentApparentTemp) : '--'}${tempSuffix}`;
Â  Â  Â  Â  document.getElementById('modalHumidity').textContent = `${currentHumidity !== null ? currentHumidity : '--'}`;

Â  Â  Â  Â  const adviceEl = document.getElementById('modalWeatherAdvice');
Â  Â  Â  Â  if (adviceEl) {
Â  Â  Â  Â  Â  Â  const adviceText = getWeatherAdvice(dayData, displayUnits);
Â  Â  Â  Â  Â  Â  adviceEl.textContent = adviceText;
Â  Â  Â  Â  }

Â  Â  Â  Â  forecastModal.classList.add('modal-open');
Â  Â  }

Â  Â  // --- Weather Settings Logic ---
Â  Â  function saveWeatherSettings() {
Â  Â  Â  Â  localStorage.setItem('weatherWidgetSettings', JSON.stringify(weatherSettings));
Â  Â  }

Â  Â  function loadWeatherSettings() {
Â  Â  Â  Â  const saved = localStorage.getItem('weatherWidgetSettings');
Â  Â  Â  Â  if (saved) {
Â  Â  Â  Â  Â  Â  weatherSettings = JSON.parse(saved);
Â  Â  Â  Â  }
Â  Â  Â  Â  return !!saved;
Â  Â  }
Â  Â Â 
Â  Â  const weatherLocationInput = document.getElementById('weatherLocationInput');
Â  Â  const locationSuggestions = document.getElementById('locationSuggestions');
Â  Â  const unitToggle = document.getElementById('unitToggle');
Â  Â  const useCurrentLocationBtn = document.getElementById('useCurrentLocationBtn');
Â  Â  let debounceTimer;

Â  Â  weatherLocationInput.addEventListener('keyup', (e) => {
Â  Â  Â  Â  clearTimeout(debounceTimer);
Â  Â  Â  Â  const query = e.target.value;
Â  Â  Â  Â  if (query.length < 3) {
Â  Â  Â  Â  Â  Â  locationSuggestions.innerHTML = '';
Â  Â  Â  Â  Â  Â  locationSuggestions.style.display = 'none';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  debounceTimer = setTimeout(() => fetchLocationSuggestions(query), 500);
Â  Â  });

Â  Â  useCurrentLocationBtn.addEventListener('click', async () => {
Â  Â  Â  Â  if (!navigator.geolocation) {
Â  Â  Â  Â  Â  Â  showNotification("Geolocation is not supported by your browser.", "error");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  useCurrentLocationBtn.disabled = true;
Â  Â  Â  Â  useCurrentLocationBtn.textContent = 'Locating...';

Â  Â  Â  Â  navigator.geolocation.getCurrentPosition(async (position) => {
Â  Â  Â  Â  Â  Â  const { latitude, longitude } = position.coords;
Â  Â  Â  Â  Â  Â  const { label } = await fetchCityName(latitude, longitude);

Â  Â  Â  Â  Â  Â  weatherSettings.location = { label, latitude, longitude };
Â  Â  Â  Â  Â  Â  weatherLocationInput.value = label;
Â  Â  Â  Â  Â  Â  saveWeatherSettings();
Â  Â  Â  Â  Â  Â  showNotification(`Location updated to ${label}`, 'success');
Â  Â  Â  Â  Â  Â  updateWeatherForNewSettings();
Â  Â  Â  Â  Â  Â  weatherSettingsModal.classList.remove('modal-open');

Â  Â  Â  Â  Â  Â  useCurrentLocationBtn.disabled = false;
Â  Â  Â  Â  Â  Â  useCurrentLocationBtn.textContent = 'ğŸ“ Use My Current Location';
Â  Â  Â  Â  }, (error) => {
Â  Â  Â  Â  Â  Â  console.error("Geolocation error:", error);
Â  Â  Â  Â  Â  Â  showNotification("Could not get location. Please enable location services.", "error");
Â  Â  Â  Â  Â  Â  useCurrentLocationBtn.disabled = false;
Â  Â  Â  Â  Â  Â  useCurrentLocationBtn.textContent = 'ğŸ“ Use My Current Location';
Â  Â  Â  Â  }, { timeout: 10000 });
Â  Â  });

Â  Â  async function fetchLocationSuggestions(query) {
Â  Â  Â  Â  let url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1`;

Â  Â  Â  Â  if (userCoords) {
Â  Â  Â  Â  Â  Â  const R = 6371; // Earth radius in km
Â  Â  Â  Â  Â  Â  const d = 250; // Viewbox side length in km
Â  Â  Â  Â  Â  Â  const latRad = userCoords.latitude * (Math.PI / 180);
Â  Â  Â  Â  Â  Â  const lonRad = userCoords.longitude * (Math.PI / 180);
Â  Â  Â  Â  Â  Â  const lat1 = 180 / Math.PI * (latRad - (d/R));
Â  Â  Â  Â  Â  Â  const lat2 = 180 / Math.PI * (latRad + (d/R));
Â  Â  Â  Â  Â  Â  const lon1 = 180 / Math.PI * (lonRad - Math.asin(d/R) / Math.cos(latRad));
Â  Â  Â  Â  Â  Â  const lon2 = 180 / Math.PI * (lonRad + Math.asin(d/R) / Math.cos(latRad));
Â  Â  Â  Â  Â  Â  url += `&viewbox=${lon1},${lat2},${lon2},${lat1}&bounded=1`;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const response = await fetch(url);
Â  Â  Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  Â  Â  locationSuggestions.innerHTML = '';
Â  Â  Â  Â  Â  Â  if (data.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  locationSuggestions.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  data.slice(0, 5).forEach(place => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const shortLabel = getShortLocationLabel(place.address, place.display_name);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const li = document.createElement('li');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  li.textContent = shortLabel;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  li.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  weatherSettings.location = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  label: shortLabel,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  latitude: parseFloat(place.lat),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  longitude: parseFloat(place.lon)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  weatherLocationInput.value = shortLabel;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  locationSuggestions.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  locationSuggestions.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  saveWeatherSettings();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateWeatherForNewSettings();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  weatherSettingsModal.classList.remove('modal-open');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  locationSuggestions.appendChild(li);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  locationSuggestions.style.display = 'none';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Failed to fetch location suggestions:", error);
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  unitToggle.addEventListener('change', () => {
Â  Â  Â  Â  weatherSettings.units = unitToggle.checked ? 'metric' : 'imperial';
Â  Â  Â  Â  saveWeatherSettings();
Â  Â  Â  Â  updateWeatherForNewSettings();
Â  Â  });
Â  Â Â 
Â  Â  function openWeatherSettingsModal() {
Â  Â  Â  Â  weatherLocationInput.value = weatherSettings.location.label;
Â  Â  Â  Â  unitToggle.checked = weatherSettings.units === 'metric';
Â  Â  Â  Â  locationSuggestions.style.display = 'none';
Â  Â  Â  Â  weatherSettingsModal.classList.add('modal-open');
Â  Â  }

Â  Â  function updateWeatherForNewSettings() {
Â  Â  Â  Â  const weatherCard = document.querySelector('.dashboard-card[data-template-id="weather_large_widget"]');
Â  Â  Â  Â  if (weatherCard && weatherCard.updateWeather) {
Â  Â  Â  Â  Â  Â  weatherCard.updateWeather();
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  // --- START: New Shortcut Modal Logic ---
Â  Â  function populateShortcutModal() {
Â  Â  Â  Â  const form = document.getElementById('shortcutSettingsForm');
Â  Â  Â  Â  let formHTML = '';

Â  Â  Â  Â  const pageOptionsHTML = pageSuggestions
Â  Â  Â  Â  Â  Â  .map(p => `<option value="${p.url}">${p.name}</option>`)
Â  Â  Â  Â  Â  Â  .join('');

Â  Â  Â  Â  currentQuickActions.forEach((action, index) => {
Â  Â  Â  Â  Â  Â  const sanitizedText = action.text.replace(/"/g, '&quot;');
Â  Â  Â  Â  Â  Â  const sanitizedValue = action.value.replace(/"/g, '&quot;');
Â  Â  Â  Â  Â  Â  formHTML += `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="shortcut-editor-group" data-shortcut-index="${index}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4>Shortcut ${index + 1}</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="shortcut-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="shortcut-emoji-${index}">Emoji</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="shortcut-emoji-${index}" class="shortcut-emoji-input" value="${action.icon}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="shortcut-name-${index}">Name</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="shortcut-name-${index}" class="shortcut-name-input" maxlength="20" required value="${sanitizedText}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="shortcut-input-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label>Action Type:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="radio" name="actionType-${index}" value="page" ${action.type === 'page' ? 'checked' : ''}> Page
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="radio" name="actionType-${index}" value="url" ${action.type === 'url' ? 'checked' : ''}> URL
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="shortcut-input-row action-target-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="shortcut-page-${index}" class="shortcut-page-select ${action.type !== 'page' ? 'hidden' : ''}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${pageOptionsHTML}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="url" id="shortcut-url-${index}" class="shortcut-url-input ${action.type !== 'url' ? 'hidden' : ''}" placeholder="https://example.com" value="${action.type === 'url' ? sanitizedValue : ''}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  form.innerHTML = formHTML + `
Â  Â  Â  Â  Â  Â  <div class="shortcut-modal-buttons">
Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" id="saveShortcutsBtn">Save Changes</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="resetShortcutsBtn">Reset to Defaults</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;

Â  Â  Â  Â  currentQuickActions.forEach((action, index) => {
Â  Â  Â  Â  Â  Â  if (action.type === 'page') {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(`shortcut-page-${index}`).value = action.value;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  document.querySelectorAll(`input[name="actionType-${index}"]`).forEach(radio => {
Â  Â  Â  Â  Â  Â  Â  Â  radio.addEventListener('change', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const pageSelect = document.getElementById(`shortcut-page-${index}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const urlInput = document.getElementById(`shortcut-url-${index}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (e.target.value === 'page') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pageSelect.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  urlInput.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pageSelect.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  urlInput.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById('saveShortcutsBtn').addEventListener('click', handleSaveShortcuts);
Â  Â  Â  Â  document.getElementById('resetShortcutsBtn').addEventListener('click', handleResetShortcuts);
Â  Â  }

Â  Â  function handleSaveShortcuts(e) {
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  const newActions = [];
Â  Â  Â  Â  let isValid = true;
Â  Â  Â  Â  const nameRegex = /^[a-zA-Z0-9\s!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]*$/;

Â  Â  Â  Â  for (let i = 0; i < 4; i++) {
Â  Â  Â  Â  Â  Â  const icon = document.getElementById(`shortcut-emoji-${i}`).value.trim();
Â  Â  Â  Â  Â  Â  const text = document.getElementById(`shortcut-name-${i}`).value.trim();
Â  Â  Â  Â  Â  Â  const type = document.querySelector(`input[name="actionType-${i}"]:checked`).value;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let value;
Â  Â  Â  Â  Â  Â  if (type === 'page') {
Â  Â  Â  Â  Â  Â  Â  Â  value = document.getElementById(`shortcut-page-${i}`).value;
Â  Â  Â  Â  Â  Â  } else { // url
Â  Â  Â  Â  Â  Â  Â  Â  value = document.getElementById(`shortcut-url-${i}`).value.trim();
Â  Â  Â  Â  Â  Â  Â  Â  if (value && !value.startsWith('http://') && !value.startsWith('https://')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â value = 'https://' + value;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (!text) {
Â  Â  Â  Â  Â  Â  Â  Â  showNotification(`Name for Shortcut ${i + 1} cannot be empty.`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  isValid = false; break;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if(!nameRegex.test(text)){
Â  Â  Â  Â  Â  Â  Â  Â  showNotification(`Name for Shortcut ${i+1} contains invalid characters.`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  isValid = false; break;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (type === 'url' && !value) {
Â  Â  Â  Â  Â  Â  Â  Â  showNotification(`URL for Shortcut ${i + 1} cannot be empty.`, 'error');
Â  Â  Â  Â  Â  Â  Â  Â  isValid = false; break;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  newActions.push({ icon: icon || 'ğŸ”—', text, type, value });
Â  Â  Â  Â  }

Â  Â  Â  Â  if (isValid) {
Â  Â  Â  Â  Â  Â  localStorage.setItem(QUICK_ACTIONS_STORAGE_KEY, JSON.stringify(newActions));
Â  Â  Â  Â  Â  Â  if (window.updateQuickActionsWidget) {
Â  Â  Â  Â  Â  Â  Â  Â  window.updateQuickActionsWidget();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  shortcutSettingsModal.classList.remove('modal-open');
Â  Â  Â  Â  Â  Â  showNotification('Shortcuts updated successfully!', 'success');
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function handleResetShortcuts() {
Â  Â  Â  Â  localStorage.removeItem(QUICK_ACTIONS_STORAGE_KEY);
Â  Â  Â  Â  if (window.updateQuickActionsWidget) {
Â  Â  Â  Â  Â  Â  window.updateQuickActionsWidget();
Â  Â  Â  Â  }
Â  Â  Â  Â  shortcutSettingsModal.classList.remove('modal-open');
Â  Â  Â  Â  showNotification('Shortcuts have been reset to default.', 'info');
Â  Â  }
Â  Â  // --- END: New Shortcut Modal Logic ---

Â  Â  // --- Card Templates ---
Â  Â  const availableCardTemplates = [
Â  Â  {
Â  Â  Â  Â  templateId: 'weather_large_widget', title: 'Weather Forecast', icon: 'ğŸŒ¦ï¸', type: 'medium',
Â  Â  Â  Â  onMount: async (cardElement) => {
Â  Â  Â  Â  Â const forecastEl = cardElement.querySelector('.forecast-large');
Â  Â  Â  Â  Â const currentIconEl = cardElement.querySelector('.weather-icon-large');
Â  Â  Â  Â  Â const currentTempEl = cardElement.querySelector('.temp-large');
Â  Â  Â  Â  Â const currentConditionEl = cardElement.querySelector('.condition-large');
Â  Â  Â  Â  Â const feelsLikeValueEl = cardElement.querySelector('.feels-like-value');
Â  Â  Â  Â  Â const humidityValueEl = cardElement.querySelector('.humidity-value');
Â  Â  Â  Â  Â const windValueEl = cardElement.querySelector('.wind-value');
Â  Â  Â  Â  Â const locationDisplayEl = cardElement.querySelector('.location-large');

Â  Â  Â  Â  Â const refreshBtn = cardElement.querySelector('.weather-refresh-btn');
Â  Â  Â  Â  Â const settingsBtn = cardElement.querySelector('.weather-settings-btn');
Â  Â  Â  Â  Â const refreshImg = refreshBtn ? refreshBtn.querySelector('img') : null;
Â  Â  Â  Â  Â let fullDailyForecastData = null;
Â  Â  Â  Â  Â let currentApparentTemp = null;
Â  Â  Â  Â  Â let currentHumidity = null;
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â if (settingsBtn) {
Â  Â  Â  Â  Â  Â  Â settingsBtn.addEventListener('click', openWeatherSettingsModal);
Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â const displayErrorInCard = (message) => {
Â  Â  Â  Â  Â  currentConditionEl.textContent = message; currentIconEl.textContent = 'âš ï¸'; currentTempEl.textContent = '--Â°';
Â  Â  Â  Â  Â  if(feelsLikeValueEl) feelsLikeValueEl.textContent = '--Â°';
Â  Â  Â  Â  Â  if(humidityValueEl) humidityValueEl.textContent = '--%';
Â  Â  Â  Â  Â  if(windValueEl) windValueEl.textContent = '--';
Â  Â  Â  Â  Â  if(locationDisplayEl) locationDisplayEl.textContent = "Error";
Â  Â  Â  Â  Â  forecastEl.innerHTML = `<p style="color:red; text-align:center; font-size:0.9em;">${message}</p>`;
Â  Â  Â  Â  Â  if (refreshBtn) {
Â  Â  Â  Â  Â  Â  refreshBtn.disabled = false;
Â  Â  Â  Â  Â  Â  if (refreshImg) {
Â  Â  Â  Â  Â  Â  Â  Â  refreshImg.classList.remove('refreshing');
Â  Â  Â  Â  Â  Â  Â  Â  refreshBtn.classList.add('spin-back');
Â  Â  Â  Â  Â  Â  Â  Â  refreshImg.addEventListener('animationend', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  refreshBtn.classList.remove('spin-back');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  refreshImg.style.transform = '';
Â  Â  Â  Â  Â  Â  Â  Â  }, { once: true });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â };

Â  Â  Â  Â  Â async function actualFetchAndDisplayWeather() {
Â  Â  Â  Â  Â  const { latitude, longitude, label } = weatherSettings.location;
Â  Â  Â  Â  Â  const { units } = weatherSettings;

Â  Â  Â  Â  Â  if (refreshBtn) {
Â  Â  Â  Â  Â  Â  refreshBtn.disabled = true;
Â  Â  Â  Â  Â  Â  refreshBtn.classList.remove('spin-back');
Â  Â  Â  Â  Â  Â  if (refreshImg) {
Â  Â  Â  Â  Â  Â  Â  Â  refreshImg.classList.remove('spin-back');
Â  Â  Â  Â  Â  Â  Â  Â  refreshImg.classList.add('refreshing');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  currentIconEl.textContent = 'â³';
Â  Â  Â  Â  Â  currentConditionEl.textContent = 'Fetching...';

Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const tempUnitParam = units === 'metric' ? 'celsius' : 'fahrenheit';
Â  Â  Â  Â  Â  Â  const windSpeedUnitParam = units === 'metric' ? 'kmh' : 'mph';
Â  Â  Â  Â  Â  Â  const dailyParams = "weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum,precipitation_probability_max,wind_speed_10m_max,sunrise,sunset,daylight_duration,wind_direction_10m_dominant";
Â  Â  Â  Â  Â  Â  const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m&daily=${dailyParams}&temperature_unit=${tempUnitParam}&wind_speed_unit=${windSpeedUnitParam}&timezone=auto&forecast_days=7`;
Â  Â  Â  Â  Â  Â  const response = await fetch(apiUrl);
Â  Â  Â  Â  Â  Â  if (!response.ok) throw new Error(`API Error: ${response.status}`);
Â  Â  Â  Â  Â  Â  const data = await response.json();

Â  Â  Â  Â  Â  Â  const cw = data.current;
Â  Â  Â  Â  Â  Â  const cwCodeInfo = WMO_CODES[cw.weather_code] || { description: "Unknown", icon: "â“" };
Â  Â  Â  Â  Â  Â  const tempSuffix = units === 'metric' ? 'Â°C' : 'Â°F';
Â  Â  Â  Â  Â  Â  const speedSuffix = units === 'metric' ? 'km/h' : 'mph';

Â  Â  Â  Â  Â  Â  currentTempEl.textContent = `${Math.round(cw.temperature_2m)}${tempSuffix}`;
Â  Â  Â  Â  Â  Â  currentIconEl.textContent = cwCodeInfo.icon;
Â  Â  Â  Â  Â  Â  currentConditionEl.textContent = cwCodeInfo.description;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  currentApparentTemp = cw.apparent_temperature;
Â  Â  Â  Â  Â  Â  currentHumidity = cw.relative_humidity_2m;

Â  Â  Â  Â  Â  Â  if (feelsLikeValueEl) feelsLikeValueEl.textContent = `${Math.round(currentApparentTemp)}${tempSuffix}`;
Â  Â  Â  Â  Â  Â  if (humidityValueEl) humidityValueEl.textContent = `${currentHumidity}%`;
Â  Â  Â  Â  Â  Â  if (windValueEl) windValueEl.textContent = `${Math.round(cw.wind_speed_10m)}${speedSuffix}`;
Â  Â  Â  Â  Â  Â  if (locationDisplayEl) locationDisplayEl.textContent = label;

Â  Â  Â  Â  Â  Â  forecastEl.innerHTML = '';
Â  Â  Â  Â  Â  Â  fullDailyForecastData = data.daily;

Â  Â  Â  Â  Â  Â  if (fullDailyForecastData && fullDailyForecastData.time && fullDailyForecastData.time.length > 0) {
Â  Â  Â  Â  Â  Â  Â  for (let i = 0; i < fullDailyForecastData.time.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  const dayCodeInfo = WMO_CODES[fullDailyForecastData.weather_code[i]] || { description: "Unknown", icon: "â“" };
Â  Â  Â  Â  Â  Â  Â  Â  const dayDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  dayDiv.classList.add('forecast-day');
Â  Â  Â  Â  Â  Â  Â  Â  dayDiv.dataset.dayIndex = i;

Â  Â  Â  Â  Â  Â  Â  Â  const currentDayDateString = fullDailyForecastData.time[i];
Â  Â  Â  Â  Â  Â  Â  Â  const parts = currentDayDateString.split('-').map(s => parseInt(s, 10));
Â  Â  Â  Â  Â  Â  Â  Â  const utcDateForForecastDay = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2], 12, 0, 0));
Â  Â  Â  Â  Â  Â  Â  Â  const dayName = i === 0 ? "Today" : utcDateForForecastDay.toLocaleDateString(undefined, { weekday: 'short', timeZone: data.timezone });

Â  Â  Â  Â  Â  Â  Â  Â  dayDiv.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="day-name">${dayName}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="icon">${dayCodeInfo.icon}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="temps">${Math.round(fullDailyForecastData.temperature_2m_max[i])}Â°/${Math.round(fullDailyForecastData.temperature_2m_min[i])}Â°</span>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  dayDiv.addEventListener('click', function() {
Â  Â  Â  Â  Â  Â  Â  Â  Â  const dayIndex = parseInt(this.dataset.dayIndex);
Â  Â  Â  Â  Â  Â  Â  Â  Â  if (fullDailyForecastData) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const daySpecificData = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dateStr: fullDailyForecastData.time[dayIndex],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  weatherCode: fullDailyForecastData.weather_code[dayIndex],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tempMax: fullDailyForecastData.temperature_2m_max[dayIndex],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tempMin: fullDailyForecastData.temperature_2m_min[dayIndex],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  precipSum: fullDailyForecastData.precipitation_sum ? fullDailyForecastData.precipitation_sum[dayIndex] : 'N/A',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  precipProb: fullDailyForecastData.precipitation_probability_max ? fullDailyForecastData.precipitation_probability_max[dayIndex] : 'N/A',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  windSpeedMax: fullDailyForecastData.wind_speed_10m_max ? fullDailyForecastData.wind_speed_10m_max[dayIndex] : 'N/A',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sunrise: fullDailyForecastData.sunrise ? fullDailyForecastData.sunrise[dayIndex] : 'N/A',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sunset: fullDailyForecastData.sunset ? fullDailyForecastData.sunset[dayIndex] : 'N/A',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  daylightDuration: fullDailyForecastData.daylight_duration ? fullDailyForecastData.daylight_duration[dayIndex] : 'N/A',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  windDirection: fullDailyForecastData.wind_direction_10m_dominant ? fullDailyForecastData.wind_direction_10m_dominant[dayIndex] : 'N/A'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  openForecastModal(daySpecificData, data.timezone, units, speedSuffix, currentApparentTemp, currentHumidity);
Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  forecastEl.appendChild(dayDiv);
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  forecastEl.innerHTML = "<p>No forecast data available.</p>";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Weather API fetch error:", error);
Â  Â  Â  Â  Â  Â  displayErrorInCard(error.message || "Could not fetch weather.");
Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  if (refreshBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  refreshBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  if (refreshImg) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  refreshImg.classList.remove('refreshing');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  refreshBtn.classList.add('spin-back');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  refreshImg.addEventListener('animationend', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  refreshBtn.classList.remove('spin-back');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  refreshImg.style.transform = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, { once: true });
Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â cardElement.updateWeather = actualFetchAndDisplayWeather;

Â  Â  Â  Â  Â async function initializeWeather() {
Â  Â  Â  Â  Â  currentIconEl.textContent = 'ğŸ“';
Â  Â  Â  Â  Â  currentConditionEl.textContent = 'Locating...';
Â  Â  Â  Â  Â  if (locationDisplayEl) locationDisplayEl.textContent = 'Acquiring location...';

Â  Â  Â  Â  Â  const settingsLoaded = loadWeatherSettings();
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  if (settingsLoaded) {
Â  Â  Â  Â  Â  Â  Â  await actualFetchAndDisplayWeather();
Â  Â  Â  Â  Â  Â  Â  if (navigator.geolocation) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  navigator.geolocation.getCurrentPosition(pos => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userCoords = { latitude: pos.coords.latitude, longitude: pos.coords.longitude };
Â  Â  Â  Â  Â  Â  Â  Â  Â  }, () => {}, { timeout: 5000, enableHighAccuracy: false });
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  if (navigator.geolocation) {
Â  Â  Â  Â  Â  Â  Â  Â  navigator.geolocation.getCurrentPosition(
Â  Â  Â  Â  Â  Â  Â  Â  Â  async (position) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userCoords = { latitude: position.coords.latitude, longitude: position.coords.longitude };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const { label, country_code } = await fetchCityName(userCoords.latitude, userCoords.longitude);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  weatherSettings.location = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  label: label,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  latitude: userCoords.latitude,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  longitude: userCoords.longitude
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  weatherSettings.units = (country_code === 'us') ? 'imperial' : 'metric';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  saveWeatherSettings();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await actualFetchAndDisplayWeather();
Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  async (error) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn(`Geolocation error (${error.code}): ${error.message}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showNotification(`Geolocation failed: ${error.message}. Using default location.`, 'error', 4000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await actualFetchAndDisplayWeather();
Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  { timeout: 10000, enableHighAccuracy: false }
Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  showNotification("Geolocation not available. Using default location.", "info", 4000);
Â  Â  Â  Â  Â  Â  Â  Â  await actualFetchAndDisplayWeather();
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â if (refreshBtn) {
Â  Â  Â  Â  Â  refreshBtn.addEventListener('click', actualFetchAndDisplayWeather);
Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â initializeWeather();
Â  Â  Â  Â  Â setInterval(actualFetchAndDisplayWeather, 30 * 60 * 1000);
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  templateId: 'clock_widget', title: 'Current Time', icon: 'ğŸ•’', type: 'medium',
Â  Â  Â  Â  onMount: (cardElement) => {
Â  Â  Â  Â  Â  const timeEl = cardElement.querySelector('#clockTime');
Â  Â  Â  Â  Â  const dateEl = cardElement.querySelector('#clockDate');
Â  Â  Â  Â  Â  const dayOfYearEl = cardElement.querySelector('#clockDayOfYear');
Â  Â  Â  Â  Â  const weekNumEl = cardElement.querySelector('#clockWeekNum');

Â  Â  Â  Â  Â  function updateClock() {
Â  Â  Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  Â  Â  timeEl.textContent = now.toLocaleTimeString();
Â  Â  Â  Â  Â  Â  dateEl.textContent = now.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

Â  Â  Â  Â  Â  Â  const start = new Date(now.getFullYear(), 0, 0);
Â  Â  Â  Â  Â  Â  const diff = (now - start) + ((start.getTimezoneOffset() - now.getTimezoneOffset()) * 60 * 1000);
Â  Â  Â  Â  Â  Â  const oneDay = 1000 * 60 * 60 * 24;
Â  Â  Â  Â  Â  Â  const dayOfYear = Math.floor(diff / oneDay);
Â  Â  Â  Â  Â  Â  if (dayOfYearEl) dayOfYearEl.textContent = `Day: ${dayOfYear}`;

Â  Â  Â  Â  Â  Â  const tempDate = new Date(now.valueOf());
Â  Â  Â  Â  Â  Â  tempDate.setDate(tempDate.getDate() + 3 - (tempDate.getDay() + 6) % 7);
Â  Â  Â  Â  Â  Â  const week1 = new Date(tempDate.getFullYear(), 0, 4);
Â  Â  Â  Â  Â  Â  const weekNumber = 1 + Math.round(((tempDate.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
Â  Â  Â  Â  Â  Â  if (weekNumEl) weekNumEl.textContent = `Week: ${weekNumber}`;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  updateClock();
Â  Â  Â  Â  Â  setInterval(updateClock, 1000);
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  templateId: 'stopwatch_widget', title: 'Stopwatch', icon: 'â±ï¸', type: 'small',
Â  Â  Â  Â  onMount: (cardElement) => {
Â  Â  Â  Â  Â  Â  const STORAGE_KEY = '4sp_stopwatchState_v4';
Â  Â  Â  Â  Â  Â  const display = cardElement.querySelector('.stopwatch-display');
Â  Â  Â  Â  Â  Â  const startBtn = cardElement.querySelector('button[data-action="start"]');
Â  Â  Â  Â  Â  Â  const pauseBtn = cardElement.querySelector('button[data-action="pause"]');
Â  Â  Â  Â  Â  Â  const resetBtn = cardElement.querySelector('button[data-action="reset"]');

Â  Â  Â  Â  Â  Â  let state = { startTime: null, elapsedTime: 0, isRunning: false };
Â  Â  Â  Â  Â  Â  let intervalId = null;

Â  Â  Â  Â  Â  Â  function saveState() {
Â  Â  Â  Â  Â  Â  Â  Â  if (state.isRunning) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem(STORAGE_KEY, JSON.stringify({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startTime: state.startTime,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  elapsedTime: state.elapsedTime,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isRunning: true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }));
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem(STORAGE_KEY, JSON.stringify({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startTime: null,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  elapsedTime: state.elapsedTime,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isRunning: false
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }));
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  function formatTime(ms) {
Â  Â  Â  Â  Â  Â  Â  Â  const totalSeconds = Math.floor(ms / 1000);
Â  Â  Â  Â  Â  Â  Â  Â  const centiseconds = Math.floor((ms % 1000) / 10).toString().padStart(2, '0');

Â  Â  Â  Â  Â  Â  Â  Â  const weeks = Math.floor(totalSeconds / 604800);
Â  Â  Â  Â  Â  Â  Â  Â  const days = Math.floor((totalSeconds % 604800) / 86400);
Â  Â  Â  Â  Â  Â  Â  Â  const hours = Math.floor((totalSeconds % 86400) / 3600);
Â  Â  Â  Â  Â  Â  Â  Â  const minutes = Math.floor((totalSeconds % 3600) / 60);
Â  Â  Â  Â  Â  Â  Â  Â  const seconds = totalSeconds % 60;

Â  Â  Â  Â  Â  Â  Â  Â  const pad = (num) => num.toString().padStart(2, '0');

Â  Â  Â  Â  Â  Â  Â  Â  const timePart = `${pad(hours)}:${pad(minutes)}:${pad(seconds)}.${centiseconds}`;

Â  Â  Â  Â  Â  Â  Â  Â  if (weeks > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `${weeks}:${pad(days)}:${timePart}`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (days > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `${days}:${timePart}`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return timePart;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function updateDisplay() {
Â  Â  Â  Â  Â  Â  Â  Â  const totalElapsed = state.elapsedTime + (state.isRunning ? (Date.now() - state.startTime) : 0);
Â  Â  Â  Â  Â  Â  Â  Â  display.textContent = formatTime(totalElapsed);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  function start() {
Â  Â  Â  Â  Â  Â  Â  Â  if (state.isRunning) return;
Â  Â  Â  Â  Â  Â  Â  Â  state.isRunning = true;
Â  Â  Â  Â  Â  Â  Â  Â  state.startTime = Date.now();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  startBtn.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  pauseBtn.style.display = 'inline-block';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  intervalId = setInterval(updateDisplay, 50);
Â  Â  Â  Â  Â  Â  Â  Â  saveState();
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function pause() {
Â  Â  Â  Â  Â  Â  Â  Â  if (!state.isRunning) return;
Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(intervalId);
Â  Â  Â  Â  Â  Â  Â  Â  state.elapsedTime += Date.now() - state.startTime;
Â  Â  Â  Â  Â  Â  Â  Â  state.isRunning = false;

Â  Â  Â  Â  Â  Â  Â  Â  startBtn.style.display = 'inline-block';
Â  Â  Â  Â  Â  Â  Â  Â  pauseBtn.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  saveState();
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function reset() {
Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(intervalId);
Â  Â  Â  Â  Â  Â  Â  Â  state = { startTime: null, elapsedTime: 0, isRunning: false };
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem(STORAGE_KEY);
Â  Â  Â  Â  Â  Â  Â  Â  updateDisplay();
Â  Â  Â  Â  Â  Â  Â  Â  startBtn.style.display = 'inline-block';
Â  Â  Â  Â  Â  Â  Â  Â  pauseBtn.style.display = 'none';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  function loadState() {
Â  Â  Â  Â  Â  Â  Â  Â  const saved = JSON.parse(localStorage.getItem(STORAGE_KEY));
Â  Â  Â  Â  Â  Â  Â  Â  if (!saved) return;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  state.elapsedTime = saved.elapsedTime || 0;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (saved.isRunning && saved.startTime) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const timePassed = Date.now() - saved.startTime;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.elapsedTime += timePassed;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  start();
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateDisplay();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  startBtn.addEventListener('click', start);
Â  Â  Â  Â  Â  Â  pauseBtn.addEventListener('click', pause);
Â  Â  Â  Â  Â  Â  resetBtn.addEventListener('click', reset);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  loadState();
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  templateId: 'timer_widget', title: 'Timer', icon: 'âŒ›', type: 'small',
Â  Â  Â  Â  onMount: (cardElement) => {
Â  Â  Â  Â  Â  Â  const STORAGE_KEY = '4sp_timerState_v4';
Â  Â  Â  Â  Â  Â  const wInput = cardElement.querySelector('#timer-w');
Â  Â  Â  Â  Â  Â  const dInput = cardElement.querySelector('#timer-d');
Â  Â  Â  Â  Â  Â  const hInput = cardElement.querySelector('#timer-h');
Â  Â  Â  Â  Â  Â  const mInput = cardElement.querySelector('#timer-m');
Â  Â  Â  Â  Â  Â  const sInput = cardElement.querySelector('#timer-s');
Â  Â  Â  Â  Â  Â  const display = cardElement.querySelector('.timer-display-value');
Â  Â  Â  Â  Â  Â  const inputsContainer = cardElement.querySelector('.timer-inputs');
Â  Â  Â  Â  Â  Â  const startBtn = cardElement.querySelector('button[data-action="start"]');
Â  Â  Â  Â  Â  Â  const pauseBtn = cardElement.querySelector('button[data-action="pause"]');
Â  Â  Â  Â  Â  Â  const resetBtn = cardElement.querySelector('button[data-action="reset"]');

Â  Â  Â  Â  Â  Â  let state = { targetTime: null, remainingTime: 0, isRunning: false };
Â  Â  Â  Â  Â  Â  let intervalId = null;

Â  Â  Â  Â  Â  Â  function formatTime(ms) {
Â  Â  Â  Â  Â  Â  Â  Â  if (ms < 0) ms = 0;
Â  Â  Â  Â  Â  Â  Â  Â  const totalSeconds = Math.round(ms / 1000);

Â  Â  Â  Â  Â  Â  Â  Â  const weeks = Math.floor(totalSeconds / 604800);
Â  Â  Â  Â  Â  Â  Â  Â  const days = Math.floor((totalSeconds % 604800) / 86400);
Â  Â  Â  Â  Â  Â  Â  Â  const hours = Math.floor((totalSeconds % 86400) / 3600);
Â  Â  Â  Â  Â  Â  Â  Â  const minutes = Math.floor((totalSeconds % 3600) / 60);
Â  Â  Â  Â  Â  Â  Â  Â  const seconds = totalSeconds % 60;

Â  Â  Â  Â  Â  Â  Â  Â  const pad = (num) => num.toString().padStart(2, '0');

Â  Â  Â  Â  Â  Â  Â  Â  const timePart = `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;

Â  Â  Â  Â  Â  Â  Â  Â  if (weeks > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `${weeks}:${pad(days)}:${timePart}`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (days > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `${days}:${timePart}`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return timePart;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function updateDisplay() {
Â  Â  Â  Â  Â  Â  Â  Â  const remaining = state.isRunning ? state.targetTime - Date.now() : state.remainingTime;
Â  Â  Â  Â  Â  Â  Â  Â  display.textContent = formatTime(remaining);

Â  Â  Â  Â  Â  Â  Â  Â  if (state.isRunning && remaining <= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  finish();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function updateFromInputs() {
Â  Â  Â  Â  Â  Â  Â  Â  if (state.isRunning) return;
Â  Â  Â  Â  Â  Â  Â  Â  const w = parseInt(wInput.value) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  const d = parseInt(dInput.value) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  const h = parseInt(hInput.value) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  const m = parseInt(mInput.value) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  const s = parseInt(sInput.value) || 0;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const ONE_WEEK_MS = 7 * 24 * 60 * 60 * 1000;
Â  Â  Â  Â  Â  Â  Â  Â  let totalMs = (w * 7 * 24 * 60 * 60 * 1000) +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (d * 24 * 60 * 60 * 1000) +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (h * 60 * 60 * 1000) +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (m * 60 * 1000) +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (s * 1000);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (totalMs > ONE_WEEK_MS) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalMs = ONE_WEEK_MS;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  wInput.value = 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dInput.value = 0; hInput.value = 0; mInput.value = 0; sInput.value = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showNotification("Timer capped at maximum of 1 week.", "info");
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  state.remainingTime = totalMs;
Â  Â  Â  Â  Â  Â  Â  Â  updateDisplay();
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function toggleUI(isRunning) {
Â  Â  Â  Â  Â  Â  Â  Â  inputsContainer.classList.toggle('hidden', isRunning);
Â  Â  Â  Â  Â  Â  Â  Â  startBtn.style.display = isRunning ? 'none' : 'inline-block';
Â  Â  Â  Â  Â  Â  Â  Â  pauseBtn.style.display = isRunning ? 'inline-block' : 'none';
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function start() {
Â  Â  Â  Â  Â  Â  Â  Â  if (state.isRunning) return;
Â  Â  Â  Â  Â  Â  Â  Â  if (state.remainingTime <= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showNotification("Please set a timer duration.", "info");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  state.isRunning = true;
Â  Â  Â  Â  Â  Â  Â  Â  state.targetTime = Date.now() + state.remainingTime;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  intervalId = setInterval(updateDisplay, 100);
Â  Â  Â  Â  Â  Â  Â  Â  toggleUI(true);
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem(STORAGE_KEY, JSON.stringify({ targetTime: state.targetTime }));
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function pause() {
Â  Â  Â  Â  Â  Â  Â  Â  if (!state.isRunning) return;
Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(intervalId);
Â  Â  Â  Â  Â  Â  Â  Â  state.remainingTime = state.targetTime - Date.now();
Â  Â  Â  Â  Â  Â  Â  Â  state.isRunning = false;
Â  Â  Â  Â  Â  Â  Â  Â  toggleUI(false);
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem(STORAGE_KEY, JSON.stringify({ remainingTime: state.remainingTime }));
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function reset() {
Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(intervalId);
Â  Â  Â  Â  Â  Â  Â  Â  state.isRunning = false;
Â  Â  Â  Â  Â  Â  Â  Â  toggleUI(false);
Â  Â  Â  Â  Â  Â  Â  Â  updateFromInputs();
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem(STORAGE_KEY);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function finish() {
Â  Â  Â  Â  Â  Â  Â  Â  showNotification('Timer Finished!', 'success');
Â  Â  Â  Â  Â  Â  Â  Â  try { new Audio('https://interactive-examples.mdn.mozilla.net/media/cc0-audio/bell-ringing-01.mp3').play(); } catch(e) {}
Â  Â  Â  Â  Â  Â  Â  Â  reset();
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  function loadState() {
Â  Â  Â  Â  Â  Â  Â  Â  const saved = JSON.parse(localStorage.getItem(STORAGE_KEY));
Â  Â  Â  Â  Â  Â  Â  Â  if (!saved) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateFromInputs();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  if (saved.targetTime) { // Was running
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.targetTime = saved.targetTime;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.remainingTime = state.targetTime - Date.now();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (state.remainingTime > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  start();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reset();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else if (saved.remainingTime) { // Was paused
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  state.remainingTime = saved.remainingTime;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateDisplay();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  [wInput, dInput, hInput, mInput, sInput].forEach(input => {
Â  Â  Â  Â  Â  Â  Â  Â  input.addEventListener('input', updateFromInputs);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  startBtn.addEventListener('click', start);
Â  Â  Â  Â  Â  Â  pauseBtn.addEventListener('click', pause);
Â  Â  Â  Â  Â  Â  resetBtn.addEventListener('click', reset);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  loadState();
Â  Â  Â  Â  }
Â  Â  Â  },
Â  Â  Â  {
Â  Â  Â  Â  templateId: 'quick_actions_widget', title: 'Shortcuts', icon: 'âš¡', type: 'small',
Â  Â  Â  Â  onMount: (cardElement) => {
Â  Â  Â  Â  Â  Â  const settingsBtn = cardElement.querySelector('.quick-actions-settings-btn');
Â  Â  Â  Â  Â  Â  const contentContainer = cardElement.querySelector('.quick-actions-list');

Â  Â  Â  Â  Â  Â  const renderAndAttachListeners = (actions) => {
Â  Â  Â  Â  Â  Â  Â  Â  contentContainer.innerHTML = actions.map(action => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const sanitizedText = action.text.replace(/"/g, '&quot;');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-type="${action.type}" data-value="${action.value}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="icon">${action.icon}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text">${action.text}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="arrow">â†’</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>`;
Â  Â  Â  Â  Â  Â  Â  Â  }).join('');

Â  Â  Â  Â  Â  Â  Â  Â  contentContainer.querySelectorAll('button').forEach(btn => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const { type, value } = btn.dataset;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (type === 'url') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.open(value, '_blank');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (type === 'page') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const page = pageSuggestions.find(p => p.url === value);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (page && page.action) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  page.action(); // For scroll actions
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = value; // For regular pages
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  const updateUI = () => {
Â  Â  Â  Â  Â  Â  Â  Â  const savedActions = localStorage.getItem(QUICK_ACTIONS_STORAGE_KEY);
Â  Â  Â  Â  Â  Â  Â  Â  currentQuickActions = savedActions ? JSON.parse(savedActions) : [...defaultQuickActions];
Â  Â  Â  Â  Â  Â  Â  Â  renderAndAttachListeners(currentQuickActions);
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  window.updateQuickActionsWidget = updateUI; // So modal can call it
Â  Â  Â  Â  Â  Â  updateUI(); // Initial render

Â  Â  Â  Â  Â  Â  if (settingsBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  settingsBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  populateShortcutModal();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  shortcutSettingsModal.classList.add('modal-open');
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  ];

Â  Â  function getContentGenerator(templateId) {
Â  Â  Â  Â  switch (templateId) {
Â  Â  Â  Â  Â  Â  case 'weather_large_widget': return () => `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="weather-large-content">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="current-weather-layout">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="weather-icon-large">â³</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="current-weather-main-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="temp-large">--Â°</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="condition-large">Loading...</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="current-weather-details-aside">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Feels like: <span class="feels-like-value">--Â°</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Humidity: <span class="humidity-value">--%</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Wind: <span class="wind-value">--</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>Location: <span class="location-large">${weatherSettings.location.label || 'N/A'}</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="forecast-large"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <small style="text-align:center; display:block; margin-top:auto; color:#aaa; font-size:0.7em;">Weather by Open-Meteo.com</small>
Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  case 'clock_widget': return () => `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="clock-display" id="clockTime">00:00:00</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="date-display" id="clockDate">Monday, January 1, 2024</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="additional-time-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="clockDayOfYear">Day: ---</span> | <span id="clockWeekNum">Week: --</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  case 'stopwatch_widget': return () => `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="stopwatch-display">00:00:00.00</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="controls-flex">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-action="start">Start</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-action="pause" style="display:none;">Pause</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-action="reset">Reset</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  case 'timer_widget': return () => `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="timer-display-value">00:00:00</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="timer-inputs">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="timer-w" placeholder="W" min="0" max="1" value="0"> :
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="timer-d" placeholder="D" min="0" max="6" value="0"> :
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="timer-h" placeholder="HH" min="0" max="23" value="0"> :
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="timer-m" placeholder="MM" min="0" max="59" value="0"> :
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="timer-s" placeholder="SS" min="0" max="59" value="0">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="controls-flex">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-action="start">Start</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-action="pause" style="display:none;">Pause</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-action="reset">Reset</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  case 'quick_actions_widget': return () => `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="quick-actions-list">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  default: return () => '';
Â  Â  Â  Â  }
Â  Â  }


Â  Â  // --- Authentication & Initial Load ---
Â  Â  firebase.auth().onAuthStateChanged(async user => {
Â  Â  Â  if (!user) {
Â  Â  Â  Â  return location.href = '../login.html';
Â  Â  Â  }
Â  Â  Â  document.getElementById('userEmail').textContent = user.email;
Â  Â  Â  try {
Â  Â  Â  Â  const userDocRef = dbRef();
Â  Â  Â  Â  if (!userDocRef) return;
Â  Â  Â  Â  const doc = await userDocRef.get();
Â  Â  Â  Â  const userData = doc.exists ? doc.data() : {};
Â  Â  Â  Â  userNameEl.textContent = userData.username || user.displayName || 'Welcome User';
Â  Â  Â  Â  setupFixedDashboardLayout();
Â  Â  Â  Â  updateMarquees();
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  document.querySelectorAll('.dashboard-card').forEach((card, index) => {
Â  Â  Â  Â  Â  Â  card.style.animationDelay = `${index * 0.08}s`;
Â  Â  Â  Â  Â  Â  card.classList.add('fade-in');
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }, 100);
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Error loading user data:', error);
Â  Â  Â  Â  setupFixedDashboardLayout();
Â  Â  Â  }
Â  Â  });

Â  Â  function updateMarquees() {
Â  Â  Â  marqueeEls.forEach(el => {
Â  Â  Â  Â  el.classList.remove('marquee-active');
Â  Â  Â  Â  void el.offsetWidth;
Â  Â  Â  Â  el.classList.add('marquee-active');
Â  Â  Â  });
Â  Â  }

Â  Â  function createCardDOMElement(template) {
Â  Â  Â  const newCard = document.createElement('div');
Â  Â  Â  newCard.classList.add('dashboard-card');
Â  Â  Â  newCard.dataset.id = `${template.templateId}_${Date.now()}`;
Â  Â  Â  newCard.dataset.templateId = template.templateId;
Â  Â  Â  newCard.dataset.cardType = template.type || 'full';
Â  Â  Â  const header = document.createElement('div');
Â  Â  Â  header.classList.add('card-header');
Â  Â  Â  const iconEl = document.createElement('div');
Â  Â  Â  iconEl.classList.add('card-icon');
Â  Â  Â  iconEl.textContent = template.icon;
Â  Â  Â  const titleEl = document.createElement('h4');
Â  Â  Â  titleEl.classList.add('card-title');
Â  Â  Â  titleEl.textContent = template.title;
Â  Â  Â  header.appendChild(iconEl);
Â  Â  Â  header.appendChild(titleEl);

Â  Â  Â  const buttonContainer = document.createElement('div');
Â  Â  Â  buttonContainer.className = 'card-header-buttons';

Â  Â  Â  if (template.templateId === 'weather_large_widget') {
Â  Â  Â  Â  const settingsButton = document.createElement('button');
Â  Â  Â  Â  settingsButton.className = 'weather-action-btn weather-settings-btn';
Â  Â  Â  Â  settingsButton.title = 'Weather Settings';
Â  Â  Â  Â  const settingsImg = document.createElement('img');
Â  Â  Â  Â  settingsImg.src = '../images/gear-dark.png';
Â  Â  Â  Â  settingsImg.alt = 'Settings';
Â  Â  Â  Â  settingsButton.appendChild(settingsImg);
Â  Â  Â  Â Â 
Â  Â  Â  Â  const refreshButton = document.createElement('button');
Â  Â  Â  Â  refreshButton.className = 'weather-action-btn weather-refresh-btn';
Â  Â  Â  Â  refreshButton.title = 'Refresh Weather';
Â  Â  Â  Â  const refreshImg = document.createElement('img');
Â  Â  Â  Â  refreshImg.src = '../images/refresh-dark.png';
Â  Â  Â  Â  refreshImg.alt = 'Refresh';
Â  Â  Â  Â  refreshButton.appendChild(refreshImg);

Â  Â  Â  Â  buttonContainer.appendChild(settingsButton);
Â  Â  Â  Â  buttonContainer.appendChild(refreshButton);
Â  Â  Â  Â  header.appendChild(buttonContainer);
Â  Â  Â  } else if (template.templateId === 'quick_actions_widget') {
Â  Â  Â  Â  Â  const settingsButton = document.createElement('button');
Â  Â  Â  Â  Â  settingsButton.className = 'weather-action-btn quick-actions-settings-btn';
Â  Â  Â  Â  Â  settingsButton.title = 'Edit Shortcuts';
Â  Â  Â  Â  Â  const settingsImg = document.createElement('img');
Â  Â  Â  Â  Â  settingsImg.src = '../images/gear-dark.png';
Â  Â  Â  Â  Â  settingsImg.alt = 'Settings';
Â  Â  Â  Â  Â  settingsButton.appendChild(settingsImg);
Â  Â  Â  Â  Â  buttonContainer.appendChild(settingsButton);
Â  Â  Â  Â  Â  header.appendChild(buttonContainer);
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  const contentWrapper = document.createElement('div');
Â  Â  Â  contentWrapper.classList.add('card-content-inner');
Â  Â  Â  contentWrapper.innerHTML = getContentGenerator(template.templateId)();
Â  Â  Â Â 
Â  Â  Â  newCard.appendChild(header);
Â  Â  Â  newCard.appendChild(contentWrapper);
Â  Â  Â Â 
Â  Â  Â  if (template.onMount) {
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  template.onMount(newCard);
Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  console.error(`Error during onMount for card ${template.templateId}:`, e);
Â  Â  Â  Â  Â  Â  const contentInner = newCard.querySelector('.card-content-inner');
Â  Â  Â  Â  Â  Â  if (contentInner) {
Â  Â  Â  Â  Â  Â  Â  Â  contentInner.innerHTML = `<p style="color: red; text-align: center; padding: 20px;">Failed to load widget content.</p>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }, 0);
Â  Â  Â  }
Â  Â  Â  return newCard;
Â  Â  }

Â  Â  function addCardToDashboard(templateId) {
Â  Â  Â  const template = availableCardTemplates.find(t => t.templateId === templateId);
Â  Â  Â  if (!template) {
Â  Â  Â  Â  console.warn(`Template ${templateId} not found.`);
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  const cardDom = createCardDOMElement(template);
Â  Â  Â  dashboardGrid.appendChild(cardDom);
Â  Â  }

Â  Â  function setupFixedDashboardLayout() {
Â  Â  Â  Â  dashboardGrid.innerHTML = '';
Â  Â  Â  Â  availableCardTemplates.forEach(template => addCardToDashboard(template.templateId));
Â  Â  }

Â  Â  function showNotification(message, type = 'info', duration = 3000) {
Â  Â  Â  const notification = document.createElement('div');
Â  Â  Â  notification.className = `notification ${type}`;
Â  Â  Â  notification.textContent = message;
Â  Â  Â  Object.assign(notification.style, {
Â  Â  Â  Â  position: 'fixed', bottom: '20px', right: '20px', padding: '12px 20px',
Â  Â  Â  Â  borderRadius: '8px', color: 'white', fontWeight: '600', zIndex: '10000',
Â  Â  Â  Â  transform: 'translateY(150%)', transition: 'transform 0.4s ease-in-out, background 0.3s',
Â  Â  Â  Â  boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
Â  Â  Â  Â  fontFamily: 'PrimaryFont, sans-serif'
Â  Â  Â  });
Â  Â  Â  const colors = {
Â  Â  Â  Â  success: 'linear-gradient(135deg, #28a745, #20c997)',
Â  Â  Â  Â  error: 'linear-gradient(135deg, #dc3545, #e83e8c)',
Â  Â  Â  Â  info: 'linear-gradient(135deg, #6720bd, #8a2be2)'
Â  Â  Â  };
Â  Â  Â  notification.style.background = colors[type] || colors.info;
Â  Â  Â  document.body.appendChild(notification);
Â  Â  Â  setTimeout(() => { notification.style.transform = 'translateY(0)'; }, 100);
Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  notification.style.transform = 'translateY(150%)';
Â  Â  Â  Â  setTimeout(() => { if (document.body.contains(notification)) document.body.removeChild(notification); }, 400);
Â  Â  Â  }, duration);
Â  Â  }

Â  Â  window.addEventListener('resize', () => { setTimeout(updateMarquees, 300); });
Â  Â Â 
Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  document.documentElement.style.scrollBehavior = 'smooth';

Â  Â  Â  // --- START: Search Bar Logic ---
Â  Â  Â  const searchInput = document.getElementById('dashboardSearch');
Â  Â  Â  const suggestionsContainer = document.getElementById('searchSuggestions');
Â  Â  Â  const searchContainer = document.querySelector('.search-container');

Â  Â  Â  if (searchInput && suggestionsContainer && searchContainer) {
Â  Â  Â  Â  searchInput.addEventListener('input', function() {
Â  Â  Â  Â  Â  const query = this.value.toLowerCase().trim();
Â  Â  Â  Â  Â  suggestionsContainer.innerHTML = '';

Â  Â  Â  Â  Â  if (query.length === 0) {
Â  Â  Â  Â  Â  Â  suggestionsContainer.style.display = 'none';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  const filteredSuggestions = pageSuggestions.filter(item =>
Â  Â  Â  Â  Â  Â  item.name.toLowerCase().includes(query)
Â  Â  Â  Â  Â  );

Â  Â  Â  Â  Â  if (filteredSuggestions.length > 0) {
Â  Â  Â  Â  Â  Â  filteredSuggestions.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  const suggestionElement = document.createElement('a');
Â  Â  Â  Â  Â  Â  Â  suggestionElement.className = 'suggestion-item';
Â  Â  Â  Â  Â  Â  Â  suggestionElement.textContent = item.name;
Â  Â  Â  Â  Â  Â  Â  suggestionElement.href = item.url;

Â  Â  Â  Â  Â  Â  Â  suggestionElement.addEventListener('click', function(e) {
Â  Â  Â  Â  Â  Â  Â  Â  if (item.action) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault(); // Prevent navigating to '#'
Â  Â  Â  Â  Â  Â  Â  Â  Â  item.action();
Â  Â  Â  Â  Â  Â  Â  Â  Â  suggestionsContainer.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  searchInput.value = ''; // Optional: clear input after action
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  suggestionsContainer.appendChild(suggestionElement);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  suggestionsContainer.style.display = 'block';
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  suggestionsContainer.style.display = 'none';
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // Hide suggestions when clicking anywhere else on the page
Â  Â  Â  Â  document.addEventListener('click', function(event) {
Â  Â  Â  Â  Â  if (!searchContainer.contains(event.target)) {
Â  Â  Â  Â  Â  Â  suggestionsContainer.style.display = 'none';
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  Â  // --- END: Search Bar Logic ---
Â  Â  Â Â 
Â  Â  Â  // --- START: Battery Status Logic ---
Â  Â  Â  const batteryStatusContainer = document.getElementById('battery-status');
Â  Â  Â  const chargingStatusEl = document.getElementById('battery-charging-status');
Â  Â  Â  const levelEl = document.getElementById('battery-level');

Â  Â  Â  function updateBatteryUI(battery) {
Â  Â  Â  Â  Â  if (!batteryStatusContainer || !chargingStatusEl || !levelEl) return;

Â  Â  Â  Â  Â  batteryStatusContainer.style.display = 'flex';

Â  Â  Â  Â  Â  chargingStatusEl.textContent = battery.charging ? 'âš¡ Charging' : 'ğŸ”‹ Discharging';
Â  Â  Â  Â  Â  if (battery.charging) {
Â  Â  Â  Â  Â  Â  Â  batteryStatusContainer.classList.add('charging');
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  batteryStatusContainer.classList.remove('charging');
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  const percentage = Math.floor(battery.level * 100);
Â  Â  Â  Â  Â  levelEl.textContent = `Percentage: ${percentage}%`;

Â  Â  Â  Â  Â  levelEl.classList.remove('low', 'critical', 'very-critical');
Â  Â  Â  Â  Â  if (percentage <= 3) {
Â  Â  Â  Â  Â  Â  Â  levelEl.classList.add('very-critical');
Â  Â  Â  Â  Â  } else if (percentage <= 10) {
Â  Â  Â  Â  Â  Â  Â  levelEl.classList.add('critical');
Â  Â  Â  Â  Â  } else if (percentage <= 20) {
Â  Â  Â  Â  Â  Â  Â  levelEl.classList.add('low');
Â  Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  if ('getBattery' in navigator) {
Â  Â  Â  Â  Â  navigator.getBattery().then(battery => {
Â  Â  Â  Â  Â  Â  Â  updateBatteryUI(battery);
Â  Â  Â  Â  Â  Â  Â  battery.addEventListener('chargingchange', () => updateBatteryUI(battery));
Â  Â  Â  Â  Â  Â  Â  battery.addEventListener('levelchange', () => updateBatteryUI(battery));
Â  Â  Â  Â  Â  }).catch(err => {
Â  Â  Â  Â  Â  Â  Â  console.error('Battery API could not be accessed:', err);
Â  Â  Â  Â  Â  Â  Â  if (batteryStatusContainer) batteryStatusContainer.style.display = 'none';
Â  Â  Â  Â  Â  });
Â  Â  Â  } else {
Â  Â  Â  Â  if (batteryStatusContainer) batteryStatusContainer.style.display = 'none';
Â  Â  Â  }
Â  Â  Â  // --- END: Battery Status Logic ---

Â  Â  Â  // Logout and Sidebar Logic
Â  Â  Â  document.getElementById('logoutBtn').addEventListener('click', () => {
Â  Â  Â  Â  firebase.auth().signOut();
Â  Â  Â  });
Â  Â  Â  document.getElementById('signOutLink').addEventListener('click', (e) => {
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  firebase.auth().signOut();
Â  Â  Â  });
Â  Â  Â  const sidebar = document.getElementById('sidebar');
Â  Â  Â  document.getElementById('toggleSidebar').addEventListener('click', () => {
Â  Â  Â  Â  sidebar.classList.toggle('collapsed');
Â  Â  Â  Â  updateMarquees();
Â  Â  Â  });
Â  Â  });
Â  </script>

</body>
</html>
