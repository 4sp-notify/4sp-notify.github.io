<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4SP - SOUNDBOARD (Restored Header)</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>

    <style>
        /* V4 Theme Base */
        :root {
            --v4-bg-gradient: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
            --v4-card-bg: #fff;
            --v4-text-primary: #333;
            --v4-text-secondary: #555;
            --v4-purple-accent: #6720bd;
            --v4-purple-accent-darker: #5a1aa8;
            --v4-purple-gradient: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            --v4-border-light: #ddd;
            --v4-border-softer: #eee;
            --v4-input-bg: #f8f9fa;
            --v4-input-border: #ccc;
            --v4-font-primary: 'PrimaryFont', sans-serif;
            --v4-font-secondary: 'SecondaryFont', sans-serif;
        }

        body.soundboard-page {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
            font-family: var(--v4-font-primary);
            background: var(--v4-bg-gradient);
            color: var(--v4-text-primary);
            line-height: 1.6;
        }
        
        /* --- NEW: Header Styles --- */
        .main-header {
            background-color: #ffffff;
            padding: 10px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-bottom: 1px solid var(--v4-border-softer);
        }
        .main-header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 95%;
            margin: 0 auto;
        }
        .main-header .logo img {
            height: 40px;
        }
        .main-header .auth-buttons .btn {
            background: none;
            border: 2px solid var(--v4-purple-accent);
            color: var(--v4-purple-accent);
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-left: 10px;
        }
        .main-header .auth-buttons .btn:hover {
            background: var(--v4-purple-accent);
            color: white;
        }


        .soundboard-container-wrapper { display: flex; flex: 1; overflow: hidden; }

        /* Sidebar Styles */
        .sidebar {
            width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%); color: #fff; padding: 20px 10px; display: flex; flex-direction: column;
            border-right: 1px solid #444; transition: width 0.5s ease-in-out; position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .sidebar .user-info { text-align: center; margin: 20px 0 30px; border-bottom: 1px solid #555; padding-bottom: 20px; }
        .sidebar .user-info .username { font-size: 1.2em; font-weight: bold; }
        .sidebar .user-info .email { font-size: 0.9em; color: #bbb; }
        .sidebar nav ul { list-style: none; padding: 0; margin: 0; }
        .sidebar nav li { margin-bottom: 10px; }
        .sidebar nav a {
            display: flex; align-items: center; padding: 12px 15px; color: #fff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease;
            text-transform: uppercase; font-size: 1em;
        }
        .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; margin-right: 10px; }
        .sidebar nav a:hover, .sidebar nav a.active { background: var(--v4-purple-gradient); transform: translateX(5px); color: #fff; }

        /* Main Content */
        .main-soundboard-content {
            flex: 1; padding: 30px; background: var(--v4-bg-gradient); overflow-y: auto; display: flex; flex-direction: column;
        }
        .soundboard-header-v4 {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: var(--v4-card-bg);
            padding: 20px 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid rgba(103, 32, 189, 0.1);
        }
        .soundboard-title-v4 {
            font-size: 2.2em; font-weight: bold; background: var(--v4-purple-gradient);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }

        /* Bottom Right Fixed Controls Container */
        .fixed-controls-container {
            position: fixed; bottom: 20px; right: 20px; z-index: 1001; display: flex; gap: 15px; align-items: center;
        }
        .glass-control {
            background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(10px) saturate(150%); -webkit-backdrop-filter: blur(10px) saturate(150%);
            border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15); padding: 10px; transition: all 0.3s ease;
        }
        #soundSearchInputV4 {
            width: 250px; padding: 12px 15px; border: none; outline: none; color: var(--v4-text-primary); font-family: var(--v4-font-secondary);
            background-color: transparent; font-size: 1em;
        }
        #clearSoundsBtn {
            padding: 12px 20px; color: #fff; background: var(--v4-purple-gradient); border: none; cursor: pointer;
            font-family: var(--v4-font-primary); font-size: 0.95em; text-transform: uppercase;
        }
        
        /* Tabbed Settings Panel */
        .settings-panel {
            background: var(--v4-card-bg); border-radius: 15px; margin-bottom: 25px;
            box-shadow: 0 6px 30px rgba(0,0,0,0.08); border: 1px solid var(--v4-border-softer);
            overflow: hidden;
        }
        .settings-tabs-nav {
            display: flex; border-bottom: 1px solid var(--v4-border-softer); padding: 0 25px;
        }
        .settings-tab-btn {
            padding: 15px 20px; cursor: pointer; background: none; border: none; font-size: 1em; font-weight: 500;
            color: var(--v4-text-secondary); position: relative; transition: color 0.3s ease; border-bottom: 3px solid transparent;
        }
        .settings-tab-btn:hover { color: var(--v4-purple-accent); }
        .settings-tab-btn.active {
            color: var(--v4-purple-accent); font-weight: 700; border-bottom-color: var(--v4-purple-accent);
        }
        .settings-tab-content { padding: 25px; }
        .settings-tab-pane { display: none; }
        .settings-tab-pane.active { display: block; }
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 25px; }
        .settings-footer { padding: 20px 25px; border-top: 1px solid var(--v4-border-softer); }

        /* Generic Control Styles */
        .control-group { display: flex; flex-direction: column; margin-bottom: 5px; }
        .control-group label, .checkbox-label-v4 {
            font-family: var(--v4-font-secondary); font-size: 0.9em; color: var(--v4-text-secondary); margin-bottom: 8px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .checkbox-label-v4 { cursor: pointer; }
        .control-group input[type="range"] {
            -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: var(--v4-border-light);
            outline: none; border-radius: 5px; margin: 0;
        }
        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 18px; height: 18px; background: var(--v4-purple-accent);
            cursor: pointer; border-radius: 50%;
        }
        .control-group input[type="number"], .control-group select, .control-button-v4 {
            width: 100%; box-sizing: border-box; padding: 10px 12px; background-color: var(--v4-input-bg);
            border: 1px solid var(--v4-input-border); border-radius: 6px; color: var(--v4-text-primary);
            font-size: 0.95em; outline: none;
        }
        .control-button-v4 { background: var(--v4-purple-gradient); color: white; border: none; cursor: pointer; }
        .control-group input[type="checkbox"] { margin-left: 8px; transform: scale(1.1); accent-color: var(--v4-purple-accent); }
        .fade-input-group { display: flex; align-items: center; gap: 10px; }
        .fade-input-group input[type="number"] { width: 80px; }

        /* Sound Categories & Buttons */
        .sound-category-v4 {
            margin-bottom: 25px; background: var(--v4-card-bg); padding: 20px; border-radius: 15px;
            box-shadow: 0 6px 30px rgba(0,0,0,0.08); border: 1px solid rgba(103, 32, 189, 0.1);
        }
        .sound-category-v4 h2 {
            font-size: 1.5em; color: var(--v4-text-primary); margin-bottom: 15px; padding-bottom: 10px;
            border-bottom: 1px solid var(--v4-border-softer); text-transform: uppercase;
        }
        .sound-buttons-grid-v4 {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px;
        }
        .sound-button-v4 {
            background-color: var(--v4-input-bg); color: var(--v4-text-secondary); border: 1px solid var(--v4-input-border);
            padding: 8px 12px; border-radius: 6px; font-size: 1em; text-align: center; cursor: pointer;
            transition: all 0.2s ease; text-transform: uppercase; display: flex; align-items: center; justify-content: center;
        }
        .sound-button-v4:hover {
            background-color: #e9ecef; border-color: var(--v4-purple-accent); color: var(--v4-purple-accent); transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .sound-button-v4.playing {
            background-color: var(--v4-purple-accent); color: white; border: 2px solid var(--v4-purple-accent-darker);
            animation: pulsePlayingSoundboardV4 1.5s infinite;
        }
        @keyframes pulsePlayingSoundboardV4 {
            0% { box-shadow: 0 0 0 0px var(--v4-purple-accent); }
            70% { box-shadow: 0 0 0 8px rgba(103, 32, 189, 0.4); }
            100% { box-shadow: 0 0 0 0px rgba(103, 32, 189, 0.1); }
        }

    </style>
</head>
<body class="soundboard-page">

    <header class="main-header">
        <div class="container">
            <div class="logo">
                <a href="../index.html">
                    <img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer;"/>
                </a>
            </div>
            <div class="auth-buttons">
                <button class="btn" onclick="window.location.href='../index.html'">HOME</button>
                <button id="logoutBtn" class="btn">LOG OUT</button>
            </div>
        </div>
    </header>

    <div class="soundboard-container-wrapper">
        <aside class="sidebar" id="sidebar">
            <div class="user-info">
                <div id="userName" class="username">Loading‚Ä¶</div>
                <div id="userEmail" class="email">Loading‚Ä¶</div>
            </div>
            <nav>
                <ul>
                    <li><a href="dashboard.html"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
                    <li><a href="proxies.html"><span class="icon">üõ°Ô∏è</span><span class="label">Proxies</span></a></li>
                    <li><a href="soundboard.html" class="active"><span class="icon">üéµ</span><span class="label">Soundboard</span></a></li>
                    <li><a href="games.html"><span class="icon">üéÆ</span><span class="label">Games</span></a></li>
                    <li><a href="others.html"><span class="icon">‚ú®</span><span class="label">Others</span></a></li>
                    <li><a href="settings.html"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a></li>
                    <li><a href="#" id="signOutLink"><span class="icon">üîí</span><span class="label">LOG OUT</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-soundboard-content">
            <div class="soundboard-header-v4">
                <h2 class="soundboard-title-v4">Soundboard</h2>
            </div>

            <div class="settings-panel">
                <nav class="settings-tabs-nav">
                    <button class="settings-tab-btn active" data-tab="playback">Playback</button>
                    <button class="settings-tab-btn" data-tab="effects">Effects</button>
                    <button class="settings-tab-btn" data-tab="equalizer">Equalizer</button>
                    <button class="settings-tab-btn" data-tab="spatial">Spatial Audio</button>
                    <button class="settings-tab-btn" data-tab="autoclicker">Autoclicker</button>
                </nav>

                <div class="settings-tab-content">
                    <div id="playback-pane" class="settings-tab-pane active">
                        <div class="settings-grid">
                            <div class="control-group" style="flex-direction: row; gap: 20px;">
                                 <label class="checkbox-label-v4">
                                    <input type="checkbox" id="allowMultipleSoundsToggle" checked> Allow Multiple Sounds
                                </label>
                                <label class="checkbox-label-v4">
                                    <input type="checkbox" id="soundLoopingToggle"> Loop Sound
                                </label>
                            </div>
                             <div class="control-group fade-input-group">
                                <label for="fadeDuration" style="margin:0; white-space:nowrap;">Fade In/Out (ms)</label>
                                <input type="number" id="fadeDuration" value="100" min="0">
                            </div>
                        </div>
                    </div>

                    <div id="effects-pane" class="settings-tab-pane">
                         <div class="settings-grid">
                            <div class="control-group"><label for="speed">Speed: <span id="speedValue">1.00x</span></label><input type="range" id="speed" min="0.25" max="4" step="0.05" value="1"></div>
                            <div class="control-group"><label for="pitch">Pitch: <span id="pitchValue">0 cents</span></label><input type="range" id="pitch" min="-20" max="20" step="1" value="0"></div>
                            <div class="control-group"><label for="distortion">Distortion: <span id="distortionValue">0%</span></label><input type="range" id="distortion" min="0" max="100" step="1" value="0"></div>
                            <div class="control-group"><label for="chorus">Chorus: <span id="chorusValue">0%</span></label><input type="range" id="chorus" min="0" max="100" step="1" value="0"></div>
                            <div class="control-group"><label for="flanger">Flanger: <span id="flangerValue">0%</span></label><input type="range" id="flanger" min="0" max="100" step="1" value="0"></div>
                         </div>
                    </div>

                    <div id="equalizer-pane" class="settings-tab-pane">
                         <div class="settings-grid">
                            <div class="control-group"><label for="subBass">Sub-Bass (60Hz): <span id="subBassValue">0 dB</span></label><input type="range" class="eq-slider" id="subBass" min="-30" max="30" step="1" value="0"></div>
                            <div class="control-group"><label for="bass">Bass (250Hz): <span id="bassValue">0 dB</span></label><input type="range" class="eq-slider" id="bass" min="-30" max="30" step="1" value="0"></div>
                            <div class="control-group"><label for="mid">Mid (1kHz): <span id="midValue">0 dB</span></label><input type="range" class="eq-slider" id="mid" min="-30" max="30" step="1" value="0"></div>
                            <div class="control-group"><label for="treble">Treble (4kHz): <span id="trebleValue">0 dB</span></label><input type="range" class="eq-slider" id="treble" min="-30" max="30" step="1" value="0"></div>
                            <div class="control-group"><label for="presence">Presence (10kHz): <span id="presenceValue">0 dB</span></label><input type="range" class="eq-slider" id="presence" min="-30" max="30" step="1" value="0"></div>
                         </div>
                    </div>

                    <div id="spatial-pane" class="settings-tab-pane">
                        <div class="settings-grid">
                            <div class="control-group"><label for="pan">Pan: <span id="panValue">Center</span></label><input type="range" id="pan" min="-1" max="1" step="0.1" value="0"></div>
                            <div class="control-group"><label for="reverb">Reverb: <span id="reverbValue">0%</span></label><input type="range" id="reverb" min="0" max="100" step="1" value="0"></div>
                            <div class="control-group"><label for="distance">Distance: <span id="distanceValue">1m</span></label><input type="range" id="distance" min="1" max="50" step="1" value="1"></div>
                            <div class="control-group"><label for="coneAngle">Cone Angle: <span id="coneAngleValue">360¬∞</span></label><input type="range" id="coneAngle" min="0" max="360" step="1" value="360"></div>
                        </div>
                    </div>
                    
                    <div id="autoclicker-pane" class="settings-tab-pane">
                        <div class="settings-grid">
                            <div class="control-group"><label for="clickInterval">Click Interval (ms)</label><input type="number" id="clickInterval" value="200" min="50"></div>
                            <div class="control-group"><label for="clickType">Click Type</label><select id="clickType"><option value="single">Single</option><option value="double">Double</option></select></div>
                            <div class="control-group" style="justify-content: flex-end;"><button id="autoclickerToggle" class="control-button-v4">Start Autoclicker</button></div>
                        </div>
                    </div>
                </div>

                <div class="settings-footer">
                     <div class="control-group">
                        <label for="masterVolume">Master Volume: <span id="masterVolumeValue">100%</span></label>
                        <input type="range" id="masterVolume" min="0" max="1" step="0.01" value="1">
                     </div>
                </div>
            </div>

            <div id="soundCategoriesContainerV4"> <p>Loading sounds...</p> </div>
        </main>
    </div>

    <div class="fixed-controls-container">
        <div class="glass-control">
            <input type="text" id="soundSearchInputV4" placeholder="Search sounds...">
        </div>
        <div class="glass-control">
            <button id="clearSoundsBtn">Clear Sounds</button>
        </div>
    </div>

    <script>
        // --- Firebase Auth & User Info ---
        firebase.auth().onAuthStateChanged(async user => {
            const userEmailEl = document.getElementById('userEmail');
            const userNameEl = document.getElementById('userName');

            if (!user) {
                window.location.href = '../login.html';
                return;
            }
            
            if (userEmailEl) userEmailEl.textContent = user.email;
            if (userNameEl) {
                try {
                    const dbRef = () => firebase.firestore().collection('users').doc(user.uid);
                    const doc = await dbRef().get();
                    userNameEl.textContent = (doc.exists && doc.data().username) ? doc.data().username : (user.displayName || 'User');
                } catch (error) {
                    userNameEl.textContent = 'User';
                    console.error("Error fetching username:", error);
                }
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            firebase.auth().signOut().then(() => window.location.href = '../login.html');
        });
        document.getElementById('signOutLink').addEventListener('click', (e) => {
            e.preventDefault();
            firebase.auth().signOut().then(() => window.location.href = '../login.html');
        });

        // --- Main App Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            let playingAudios = new Map();

            const masterGain = audioContext.createGain();
            const panner = audioContext.createStereoPanner();
            const eqBands = [60, 250, 1000, 4000, 10000].map(freq => {
                const filter = audioContext.createBiquadFilter();
                filter.type = 'peaking';
                filter.frequency.value = freq;
                filter.gain.value = 0;
                return filter;
            });
            masterGain.connect(panner);
            panner.connect(eqBands[0]);
            eqBands.forEach((band, index) => {
                if(index < eqBands.length - 1) band.connect(eqBands[index + 1]);
            });
            eqBands[eqBands.length - 1].connect(audioContext.destination);
            
            // --- Tab Navigation ---
            const tabButtons = document.querySelectorAll('.settings-tab-btn');
            const tabPanes = document.querySelectorAll('.settings-tab-pane');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetPaneId = button.dataset.tab + '-pane';
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    tabPanes.forEach(pane => pane.classList.toggle('active', pane.id === targetPaneId));
                });
            });

            // --- Control Handlers ---
            const controls = {
                allowMultiple: document.getElementById('allowMultipleSoundsToggle'),
                looping: document.getElementById('soundLoopingToggle'),
                fade: document.getElementById('fadeDuration'),
                speed: document.getElementById('speed'),
                pitch: document.getElementById('pitch'),
                pan: document.getElementById('pan'),
                masterVolume: document.getElementById('masterVolume'),
                eqSliders: {
                    subBass: document.getElementById('subBass'), bass: document.getElementById('bass'), mid: document.getElementById('mid'),
                    treble: document.getElementById('treble'), presence: document.getElementById('presence'),
                },
                search: document.getElementById('soundSearchInputV4'),
                clear: document.getElementById('clearSoundsBtn'),
            };

            const sliderValueDisplays = {
                speed: document.getElementById('speedValue'), pitch: document.getElementById('pitchValue'), pan: document.getElementById('panValue'),
                masterVolume: document.getElementById('masterVolumeValue'), subBass: document.getElementById('subBassValue'),
                bass: document.getElementById('bassValue'), mid: document.getElementById('midValue'), treble: document.getElementById('trebleValue'),
                presence: document.getElementById('presenceValue'),
            };

            controls.speed.addEventListener('input', () => sliderValueDisplays.speed.textContent = `${parseFloat(controls.speed.value).toFixed(2)}x`);
            controls.pitch.addEventListener('input', () => sliderValueDisplays.pitch.textContent = `${controls.pitch.value} cents`);
            controls.masterVolume.addEventListener('input', () => {
                masterGain.gain.value = controls.masterVolume.value;
                sliderValueDisplays.masterVolume.textContent = `${Math.round(controls.masterVolume.value * 100)}%`;
            });
            controls.pan.addEventListener('input', () => {
                 panner.pan.value = controls.pan.value;
                 const v = parseFloat(controls.pan.value);
                 if (v === 0) sliderValueDisplays.pan.textContent = 'Center';
                 else sliderValueDisplays.pan.textContent = v < 0 ? `${Math.round(-v*100)}% L` : `${Math.round(v*100)}% R`;
            });
            Object.keys(controls.eqSliders).forEach((key, index) => {
                const slider = controls.eqSliders[key];
                slider.addEventListener('input', () => {
                    eqBands[index].gain.value = slider.value;
                    sliderValueDisplays[key].textContent = `${slider.value} dB`;
                });
            });
            
            // --- Sound Playback ---
            async function playSound(soundDetails, buttonElement) {
                if (audioContext.state === 'suspended') await audioContext.resume();
                if (!controls.allowMultiple.checked) stopAllSounds();
                
                if (playingAudios.has(soundDetails.id)) {
                    playingAudios.get(soundDetails.id).source.stop();
                    return;
                }

                const response = await fetch(soundDetails.path);
                const audioBuffer = await audioContext.decodeAudioData(await response.arrayBuffer());
                const source = audioContext.createBufferSource();
                source.buffer = audioBuffer;
                source.playbackRate.value = controls.speed.value;
                source.loop = controls.looping.checked;
                
                const gainNode = audioContext.createGain();
                source.connect(gainNode).connect(masterGain);
                
                const fadeTime = (parseInt(controls.fade.value, 10) || 0) / 1000;
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(1, audioContext.currentTime + fadeTime);
                
                source.start(audioContext.currentTime);
                buttonElement.classList.add('playing');

                source.onended = () => {
                    buttonElement.classList.remove('playing');
                    playingAudios.delete(soundDetails.id);
                };
                playingAudios.set(soundDetails.id, { source, gainNode, fadeTime });
            }
            
            function stopAllSounds() {
                document.querySelectorAll('.sound-button-v4.playing').forEach(btn => btn.classList.remove('playing'));
                playingAudios.forEach((audio, id) => {
                    audio.gainNode.gain.cancelScheduledValues(audioContext.currentTime);
                    audio.gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + audio.fadeTime);
                    setTimeout(() => audio.source.stop(), audio.fadeTime * 1000);
                });
                playingAudios.clear();
            }
            controls.clear.addEventListener('click', stopAllSounds);

            async function loadSoundsAndCreateButtons() {
                try {
                    const response = await fetch('../SoundboardSN.json');
                    const soundsDataGlobal = await response.json();
                    const container = document.getElementById('soundCategoriesContainerV4');
                    container.innerHTML = '';
                    for (const categoryKey in soundsDataGlobal) {
                        const categoryDiv = document.createElement('div');
                        categoryDiv.className = 'sound-category-v4';
                        categoryDiv.innerHTML = `<h2>${categoryKey.replace(/([A-Z])/g, ' $1').trim()}</h2>`;
                        const buttonsGrid = document.createElement('div');
                        buttonsGrid.className = 'sound-buttons-grid-v4';
                        soundsDataGlobal[categoryKey].sort().forEach((filename, index) => {
                            let displayName = filename.replace(/\.mp3$/i, '').replace(/_/g, ' ');
                            const button = document.createElement('button');
                            button.className = 'sound-button-v4';
                            button.textContent = displayName;
                            button.dataset.soundName = displayName.toLowerCase();
                            const soundDetails = { id: `${categoryKey}-${index}`, path: `../Sounds/${filename}` };
                            button.addEventListener('click', () => playSound(soundDetails, button));
                            buttonsGrid.appendChild(button);
                        });
                        categoryDiv.appendChild(buttonsGrid);
                        container.appendChild(categoryDiv);
                    }
                } catch (error) { console.error("Failed to load sounds:", error); }
            }

            controls.search.addEventListener('input', e => {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('.sound-button-v4').forEach(btn => {
                    btn.style.display = btn.dataset.soundName.includes(searchTerm) ? 'flex' : 'none';
                });
            });

            loadSoundsAndCreateButtons();
        });
    </script>
</body>
</html>
