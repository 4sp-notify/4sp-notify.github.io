<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4SP - SOUNDBOARD</title>
    <link rel="stylesheet" href="../css/style.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>

    <style>
        /* V4 Theme Base */
        :root {
            --v4-bg-gradient: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
            --v4-card-bg: #fff;
            --v4-text-primary: #333;
            --v4-text-secondary: #555;
            --v4-purple-accent: #6720bd;
            --v4-purple-accent-darker: #5a1aa8;
            --v4-boost-color: #ff4136;
            --v4-danger-color: #dc3545;
            --v4-danger-color-darker: #c82333;
            --v4-purple-gradient: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            --v4-border-light: #ddd;
            --v4-input-bg: #f8f9fa;
            --v4-input-border: #ccc;
            --v4-font-primary: 'PrimaryFont', sans-serif;
        }

        body, html {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }

        body.soundboard-page {
            display: flex;
            flex-direction: column;
            font-family: var(--v4-font-primary);
            background: var(--v4-bg-gradient);
            color: var(--v4-text-primary);
        }
        
        .main-header {
            position: sticky; top: 0;
            z-index: 1001;
            background: var(--v4-card-bg, #fff);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .soundboard-container-wrapper { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%); color: #fff; padding: 20px 10px; display: flex; flex-direction: column; border-right: 1px solid #444; transition: width 0.5s ease-in-out; position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .sidebar.collapsed { width: 85px; }
        .user-info { text-align: center; margin: 60px 0 30px; border-bottom: 1px solid #555; padding-bottom: 20px; overflow: visible; }
        .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
        .sidebar nav li { margin-bottom: 10px; }
        .sidebar nav a { display: flex; align-items: center; padding: 12px 15px; color: #fff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; text-transform: uppercase; position: relative; overflow: hidden; font-size: 1em; font-family: var(--v4-font-primary); }
        .sidebar nav a.active, .sidebar nav a:hover { background: var(--v4-purple-gradient); transform: translateX(5px); color: #fff; }
        .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
        .sidebar nav a .label { margin-left: 10px; white-space: nowrap; }
        .main-soundboard-content { flex: 1; padding: 30px; padding-bottom: 120px; overflow-y: auto; display: flex; flex-direction: column; position: relative; }
        
        /* General Button Styling */
        .action-button {
            padding: 10px 18px; background: var(--v4-purple-gradient); color: white;
            border: none; border-radius: 8px; cursor: pointer;
            font-family: var(--v4-font-primary); font-size: 0.95em;
            text-transform: uppercase; transition: all 0.25s ease;
            box-shadow: 0 2px 8px rgba(103, 32, 189, 0.3);
            white-space: nowrap;
        }
        .action-button:hover {
            background: linear-gradient(135deg, var(--v4-purple-accent-darker) 0%, #7923c8 100%);
            transform: translateY(-1px); box-shadow: 0 4px 12px rgba(103, 32, 189, 0.5);
        }
        
        /* Floating Action Bar */
        .floating-action-bar {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .floating-action-bar .action-button-circular {
            border-radius: 50px; width: 56px; height: 56px; padding: 0;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5em; background: var(--v4-purple-gradient);
            box-shadow: 0 2px 8px rgba(103, 32, 189, 0.3);
            color: white; border: none; cursor: pointer; transition: all 0.25s ease;
        }
         .floating-action-bar .action-button-circular:hover {
            background: linear-gradient(135deg, var(--v4-purple-accent-darker) 0%, #7923c8 100%);
            transform: translateY(-1px); box-shadow: 0 4px 12px rgba(103, 32, 189, 0.5);
         }
        #clearAllSoundsBtn {
            background: linear-gradient(135deg, var(--v4-danger-color), var(--v4-danger-color-darker));
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4);
            border-radius: 50px; height: 56px;
        }
        #clearAllSoundsBtn:hover {
            background: linear-gradient(135deg, var(--v4-danger-color-darker), #b01e2c);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.6);
        }
        #soundSearchInput {
            width: 0; opacity: 0; border: none; outline: none; border-radius: 50px; padding: 18px 20px;
            font-size: 1em; font-family: var(--v4-font-primary);
            transition: all 0.4s ease-in-out;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            background: var(--v4-card-bg);
            margin-right: -66px; /* Overlap the toggle button */
            pointer-events: none;
        }
        .floating-action-bar.search-active #soundSearchInput {
            width: 250px; opacity: 1; margin-right: 0; pointer-events: auto;
        }
        .floating-action-bar.search-active #toggleSearchBtn {
            background: var(--v4-purple-accent-darker);
        }

        /* Controls Panel */
        .soundboard-header-v4 { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; background: var(--v4-card-bg); padding: 20px 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .soundboard-title-v4 { font-size: 2.2em; font-weight: bold; background: var(--v4-purple-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .soundboard-controls-v4 { background: var(--v4-card-bg); padding: 25px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 6px 30px rgba(0,0,0,0.08); transition: all 0.4s ease; opacity: 1; max-height: 3000px; overflow: hidden; }
        .soundboard-controls-v4.collapsed { padding-top: 0; padding-bottom: 0; margin-bottom: 0; border-width: 0; opacity: 0; max-height: 0; }
        .controls-disclaimer { font-size: 0.85em; font-style: italic; color: var(--v4-text-secondary); background-color: var(--v4-input-bg); border-radius: 6px; padding: 8px 12px; margin-top: 15px; border: 1px dashed var(--v4-input-border); text-align: center; }
        .controls-sections-wrapper { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px 35px; }
        .controls-section h3 { font-size: 1.1em; font-weight: 600; color: var(--v4-purple-accent); margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid var(--v4-border-light); text-transform: uppercase; letter-spacing: 0.5px; }
        .control-group { display: flex; flex-direction: column; margin-bottom: 15px; }
        .control-group label, .checkbox-label-v4 { font-size: 0.9em; color: var(--v4-text-secondary); margin-bottom: 6px; font-family: var(--v4-font-primary); }
        .checkbox-label-v4 { display: flex; align-items: center; cursor: pointer; margin-bottom: 10px; gap: 8px;}
        .control-group input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: var(--v4-border-light); outline: none; border-radius: 5px; }
        .control-group input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; background: var(--v4-purple-accent); cursor: pointer; border-radius: 50%; transition: all 0.2s ease-in-out; }
        .control-group input[type="number"], .control-group select { width: 100%; padding: 10px 12px; background-color: var(--v4-input-bg); border: 1px solid var(--v4-input-border); border-radius: 10px; font-size: 0.95em; outline: none; font-family: var(--v4-font-primary); }
        .autoclicker-main-group { display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
        .autoclicker-options-wrapper { display: flex; gap: 15px; align-items: center; flex: 1; min-width: 200px; }
        
        /* Volume Soft Lock */
        .volume-slider-wrapper { position: relative; }
        #masterVolumeSliderV4 { --volume-percent: 100%; --track-bg: linear-gradient(to right, var(--v4-purple-accent) var(--volume-percent), var(--v4-border-light) var(--volume-percent)); background: var(--track-bg); transition: background 0.1s ease; }
        .volume-slider-wrapper.boosted #masterVolumeSliderV4 { --track-bg: linear-gradient(to right, var(--v4-purple-accent) 50%, var(--v4-boost-color) 50%, var(--v4-boost-color) var(--volume-percent), var(--v4-border-light) var(--volume-percent)); background: var(--track-bg); }
        .volume-slider-wrapper.boosted #masterVolumeSliderV4::-webkit-slider-thumb { background: var(--v4-boost-color); transform: scale(0.8); box-shadow: 0 0 10px var(--v4-boost-color); }

        /* Sound Buttons */
        .sound-category-v4 { margin-bottom: 25px; background: var(--v4-card-bg); padding: 20px; border-radius: 15px; box-shadow: 0 6px 30px rgba(0,0,0,0.08); }
        .sound-buttons-grid-v4 { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .sound-button-v4 { background-color: var(--v4-input-bg); color: var(--v4-text-secondary); border: 1px solid var(--v4-input-border); padding: 8px 12px; border-radius: 6px; font-family: var(--v4-font-primary); transition: all 0.2s ease; white-space: normal; word-wrap: break-word; text-transform: uppercase; display: flex; align-items: center; justify-content: center; min-height: 50px; text-align: center; cursor: pointer; }
        .sound-button-v4:hover { background-color: #e9ecef; border-color: var(--v4-purple-accent); color: var(--v4-purple-accent); transform: translateY(-2px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .sound-button-v4.playing { background-color: var(--v4-purple-accent); color: white; border: 2px solid var(--v4-purple-accent-darker); animation: pulsePlayingSoundboardV4 1.5s infinite; }
        @keyframes pulsePlayingSoundboardV4 { 0% { box-shadow: 0 0 0 0px var(--v4-purple-accent); } 70% { box-shadow: 0 0 0 8px rgba(103, 32, 189, 0.4); } 100% { box-shadow: 0 0 0 0px rgba(103, 32, 189, 0.1); } }
    </style>
</head>
<body class="soundboard-page">

    <header class="main-header light-bg">
        <div class="container">
            <div class="logo">
                <a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer;"/></a>
            </div>
            <div class="auth-buttons">
                <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button>
                <button id="signOutBtnHeader" class="btn btn-login signOutBtn">LOG OUT</button>
            </div>
        </div>
    </header>

    <div class="soundboard-container-wrapper">
        <aside class="sidebar slide-in" id="sidebar">
             <button id="toggleSidebar">‚ò∞</button>
            <div class="user-info">
                <div class="marquee-container"> <span id="userName" class="marquee-content username">Loading‚Ä¶</span> </div>
                <div class="marquee-container"> <span id="userEmail" class="marquee-content email">Loading‚Ä¶</span> </div>
            </div>
            <nav>
                <ul>
                    <li><a href="dashboard.html"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
                    <li><a href="proxies.html"><span class="icon">üõ°Ô∏è</span><span class="label">Proxies</span></a></li>
                    <li><a href="soundboard.html" class="active"><span class="icon">üéµ</span><span class="label">Soundboard</span></a></li>
                    <li><a href="games.html"><span class="icon">üéÆ</span><span class="label">Games</span></a></li>
                    <li><a href="others.html"><span class="icon">‚ú®</span><span class="label">Others</span></a></li>
                    <li><a href="settings.html"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a></li>
                    <li><a href="#" id="signOutBtnSidebar" class="signOutBtn"><span class="icon">üîí</span><span class="label">LOG OUT</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-soundboard-content">
            <div class="soundboard-header-v4">
                <h2 class="soundboard-title-v4">Soundboard</h2>
            </div>
            
            <div class="status-message-v4" id="statusMessageV4"></div>

            <button id="toggleControlsBtn" class="action-button">Hide Settings</button>

            <div class="soundboard-controls-v4">
                <div class="controls-inner-wrapper">
                    <div class="controls-sections-wrapper">
                        
                        <div class="controls-section">
                            <h3>Playback Options</h3>
                            <div class="control-group">
                                <label class="checkbox-label-v4"><input type="checkbox" id="allowMultipleSoundsToggleV4" checked><span>Allow Multiple Sounds</span></label>
                                <label class="checkbox-label-v4"><input type="checkbox" id="loopSoundToggleV4"><span>Loop Sound</span></label>
                            </div>
                            <div class="control-group">
                                <label for="fadeDurationInputV4">Fade In/Out (ms):</label>
                                <input type="number" id="fadeDurationInputV4" value="100" min="0" step="50">
                            </div>
                        </div>

                        <div class="controls-section">
                             <h3>Sound Effects</h3>
                            <div class="control-group">
                                <label for="playbackSpeedSliderV4">Speed: <span id="playbackSpeedValueV4">1.00x</span></label>
                                <input type="range" id="playbackSpeedSliderV4" min="0.1" max="4" step="0.05" value="1">
                            </div>
                             <div class="control-group">
                                <label for="pitchSliderV4">Pitch: <span id="pitchValueV4">0 semitones</span></label>
                                <input type="range" id="pitchSliderV4" min="-24" max="24" step="1" value="0">
                            </div>
                        </div>
                        
                        <div class="controls-section">
                            <h3>Equalizer</h3>
                            <div class="control-group">
                                <label for="bassSliderV4">Bass: <span id="bassValueV4">0 dB</span></label>
                                <input type="range" id="bassSliderV4" min="-12" max="12" step="1" value="0">
                            </div>
                            <div class="control-group">
                                <label for="midSliderV4">Mids: <span id="midValueV4">0 dB</span></label>
                                <input type="range" id="midSliderV4" min="-12" max="12" step="1" value="0">
                            </div>
                            <div class="control-group">
                                <label for="trebleSliderV4">Treble: <span id="trebleValueV4">0 dB</span></label>
                                <input type="range" id="trebleSliderV4" min="-12" max="12" step="1" value="0">
                            </div>
                        </div>

                        <div class="controls-section">
                            <h3>Spatial & Ambience</h3>
                            <div class="control-group">
                                <label for="panSliderV4">Pan (L/R): <span id="panValueV4">Center</span></label>
                                <input type="range" id="panSliderV4" min="-1" max="1" step="0.05" value="0">
                            </div>
                            <div class="control-group">
                                <label for="reverbSliderV4">Reverb: <span id="reverbValueV4">0%</span></label>
                                <input type="range" id="reverbSliderV4" min="0" max="1" step="0.01" value="0">
                            </div>
                        </div>

                        <div class="controls-section" style="grid-column: 1 / -1;">
                            <h3>Autoclicker</h3>
                            <div class="autoclicker-main-group">
                                <label class="checkbox-label-v4">
                                    <input type="checkbox" id="autoClickerCheckboxV4"><span>Enable</span>
                                </label>
                                <div class="autoclicker-options-wrapper" id="autoclickerOptionsWrapper" style="display: none;">
                                    <div class="control-group">
                                        <label for="autoClickerTriggerV4">Trigger:</label>
                                        <select id="autoClickerTriggerV4">
                                            <option value="mouseenter">Mouse Enter</option>
                                            <option value="click">Mouse Click</option>
                                        </select>
                                    </div>
                                    <div class="control-group">
                                        <label for="autoClickDelayInputV4">Delay:</label>
                                        <input type="number" id="autoClickDelayInputV4" value="200" min="50" style="width: 80px;">
                                    </div>
                                    <label class="checkbox-label-v4">
                                        <input type="checkbox" id="autoClickerRandomizeV4"><span>Random</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                    </div>
                     <div id="masterVolumeContainer" class="control-group" style="margin-top: 20px; border-top: 1px solid var(--v4-border-softer); padding-top:20px;">
                        <label for="masterVolumeSliderV4">Master Volume: <span id="masterVolumeValueV4">100%</span></label>
                        <div class="volume-slider-wrapper">
                            <input type="range" id="masterVolumeSliderV4" min="0" max="1" step="0.01" value="1">
                        </div>
                    </div>
                    <div class="controls-disclaimer" style="display: none;">
                        Limited Live Effects: Some controls are disabled during playback to ensure performance.
                    </div>
                 </div>
            </div>

            <div id="soundCategoriesContainerV4"> <p>Loading sounds...</p> </div>
        </main>
    </div>

    <div id="floatingActionBar" class="floating-action-bar">
        <input type="text" id="soundSearchInput" placeholder="Search sounds...">
        <button id="toggleSearchBtn" class="action-button action-button-circular">üîç</button>
        <button id="clearAllSoundsBtn" class="action-button">Stop All</button>
    </div>

    <script>
        // --- V4 Standard Setup (Auth, Sidebar, User Info) ---
        firebase.auth().onAuthStateChanged(async user => {
            if (!user) { window.location.href = '../login.html'; return; }
            const userEmailEl = document.getElementById('userEmail');
            const userNameEl = document.getElementById('userName');
            const dbRef = () => firebase.firestore().collection('users').doc(user.uid);
            if (userEmailEl) userEmailEl.textContent = user.email;
            if (userNameEl) {
                try {
                    const doc = await dbRef().get();
                    userNameEl.textContent = (doc.exists && doc.data().username) ? doc.data().username : (user.displayName || 'User');
                } catch (error) {
                    userNameEl.textContent = 'User'; console.error("Error fetching username:", error);
                }
            }
            updateMarquees();
        });
        const setupSignOutButtons = () => { document.querySelectorAll('.signOutBtn').forEach(button => { button.addEventListener('click', (e) => { e.preventDefault(); firebase.auth().signOut().then(() => { window.location.href = '../login.html'; }); }); }); };
        const sidebar = document.getElementById('sidebar');
        const toggleSidebarBtn = document.getElementById('toggleSidebar');
        if (toggleSidebarBtn && sidebar) { toggleSidebarBtn.addEventListener('click', () => { sidebar.classList.toggle('collapsed'); setTimeout(updateMarquees, 550); }); }
        function updateMarquees() { document.querySelectorAll('.marquee-content').forEach(el => { if (!el || !el.parentElement) return; const parent = el.parentElement; el.classList.toggle('marquee-active', el.scrollWidth > parent.clientWidth || sidebar.classList.contains('collapsed')); }); }
        window.addEventListener('resize', updateMarquees);
        // --- End V4 Standard Setup ---

        // --- Soundboard V4 ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- Elements ---
            const soundCategoriesContainer = document.getElementById('soundCategoriesContainerV4');
            const clearAllSoundsBtn = document.getElementById('clearAllSoundsBtn');
            const soundboardControls = document.querySelector('.soundboard-controls-v4');
            const toggleControlsBtn = document.getElementById('toggleControlsBtn');
            const masterVolumeSlider = document.getElementById('masterVolumeSliderV4');
            const masterVolumeValueDisplay = document.getElementById('masterVolumeValueV4');
            const masterVolumeContainer = document.getElementById('masterVolumeContainer').querySelector('.volume-slider-wrapper');
            const allowMultipleSoundsToggle = document.getElementById('allowMultipleSoundsToggleV4');
            const loopSoundToggle = document.getElementById('loopSoundToggleV4');
            const fadeDurationInput = document.getElementById('fadeDurationInputV4');
            const playbackSpeedSlider = document.getElementById('playbackSpeedSliderV4');
            const playbackSpeedValueDisplay = document.getElementById('playbackSpeedValueV4');
            const pitchSlider = document.getElementById('pitchSliderV4');
            const pitchValueDisplay = document.getElementById('pitchValueV4');
            const bassSlider = document.getElementById('bassSliderV4');
            const bassValueDisplay = document.getElementById('bassValueV4');
            const midSlider = document.getElementById('midSliderV4');
            const midValueDisplay = document.getElementById('midValueV4');
            const trebleSlider = document.getElementById('trebleSliderV4');
            const trebleValueDisplay = document.getElementById('trebleValueV4');
            const panSlider = document.getElementById('panSliderV4');
            const panValueDisplay = document.getElementById('panValueV4');
            const reverbSlider = document.getElementById('reverbSliderV4');
            const reverbValueDisplay = document.getElementById('reverbValueV4');
            const autoClickerCheckbox = document.getElementById('autoClickerCheckboxV4');
            const autoClickerOptionsWrapper = document.getElementById('autoclickerOptionsWrapper');
            const autoClickerTrigger = document.getElementById('autoClickerTriggerV4');
            const autoClickDelayInput = document.getElementById('autoClickDelayInputV4');
            const autoClickerRandomize = document.getElementById('autoClickerRandomizeV4');
            const floatingActionBar = document.getElementById('floatingActionBar');
            const toggleSearchBtn = document.getElementById('toggleSearchBtn');
            const soundSearchInput = document.getElementById('soundSearchInput');
            
            // --- Audio Nodes ---
            const audioContext = new(window.AudioContext || window.webkitAudioContext)();
            const globalGainNode = audioContext.createGain();
            const bassFilter = audioContext.createBiquadFilter();
            const midFilter = audioContext.createBiquadFilter();
            const trebleFilter = audioContext.createBiquadFilter();
            const pannerNode = audioContext.createStereoPanner();
            const convolverNode = audioContext.createConvolver();
            const reverbWetGain = audioContext.createGain();
            const reverbDryGain = audioContext.createGain();
            
            bassFilter.type = 'lowshelf'; bassFilter.frequency.value = 300;
            midFilter.type = 'peaking'; midFilter.frequency.value = 1200; midFilter.Q.value = 1.2;
            trebleFilter.type = 'highshelf'; trebleFilter.frequency.value = 3000;
            pannerNode.connect(bassFilter);
            bassFilter.connect(midFilter);
            midFilter.connect(trebleFilter);
            trebleFilter.connect(reverbDryGain);
            trebleFilter.connect(convolverNode);
            convolverNode.connect(reverbWetGain);
            reverbDryGain.connect(globalGainNode);
            reverbWetGain.connect(globalGainNode);
            globalGainNode.connect(audioContext.destination);
            reverbWetGain.gain.value = 0;

            // --- State ---
            let audioBuffers = {};
            let playingAudios = [];
            let currentlyHoveredButton = null;
            let autoClickIntervalId = null;
            let isVolumeBoosted = false;

            // --- Functions ---
            const createReverbImpulse = () => {
                const sampleRate = audioContext.sampleRate;
                const duration = 2; const decay = 2.5;
                const impulse = audioContext.createBuffer(2, duration * sampleRate, sampleRate);
                for (let i = 0; i < 2; i++) {
                    const channel = impulse.getChannelData(i);
                    for (let j = 0; j < impulse.length; j++) {
                        channel[j] = (Math.random() * 2 - 1) * Math.pow(1 - j / impulse.length, decay);
                    }
                }
                convolverNode.buffer = impulse;
            };

            const setControlsDisabled = (disabled) => {
                soundboardControls.querySelector('.controls-disclaimer').style.display = disabled ? 'block' : 'none';
                const controlsToDisable = [allowMultipleSoundsToggle, loopSoundToggle, fadeDurationInput, playbackSpeedSlider, pitchSlider, autoClickerTrigger, autoClickDelayInput, autoClickerRandomize];
                controlsToDisable.forEach(el => { if(el) el.disabled = disabled; });
                if (autoClickerOptionsWrapper) {
                    autoClickerOptionsWrapper.style.opacity = disabled ? 0.5 : 1;
                    autoClickerOptionsWrapper.style.pointerEvents = disabled ? 'none' : 'auto';
                }
            };
            
            const setupControlsToggle = () => {
                if (toggleControlsBtn && soundboardControls) {
                    toggleControlsBtn.addEventListener('click', () => {
                        soundboardControls.classList.toggle('collapsed');
                        toggleControlsBtn.textContent = soundboardControls.classList.contains('collapsed') ? 'Show Settings' : 'Hide Settings';
                    });
                }
            };

            const stopAllActiveSounds = () => {
                playingAudios.forEach(audioObj => { try { audioObj.source.stop(); } catch(e){} });
                playingAudios = [];
                document.querySelectorAll('.sound-button-v4.playing').forEach(btn => btn.classList.remove('playing'));
                setControlsDisabled(false);
            };

            const playSound = async (soundDetails, buttonElement) => {
                if (audioContext.state === 'suspended') await audioContext.resume();
                if (!allowMultipleSoundsToggle.checked) stopAllActiveSounds();
                if (playingAudios.length === 0) setControlsDisabled(true);
                const source = audioContext.createBufferSource();
                source.buffer = audioBuffers[soundDetails.path];
                source.detune.value = parseInt(pitchSlider.value, 10) * 100;
                source.playbackRate.value = parseFloat(playbackSpeedSlider.value);
                source.loop = loopSoundToggle.checked;
                const fadeInGain = audioContext.createGain();
                const fadeSeconds = (parseInt(fadeDurationInput.value, 10) || 0) / 1000;
                if (fadeSeconds > 0) {
                    fadeInGain.gain.setValueAtTime(0.0001, audioContext.currentTime);
                    fadeInGain.gain.linearRampToValueAtTime(1, audioContext.currentTime + fadeSeconds);
                }
                source.connect(fadeInGain);
                fadeInGain.connect(pannerNode);
                const audioId = Date.now();
                playingAudios.push({ id: audioId, source: source });
                source.start(0);
                buttonElement.classList.add('playing');
                source.onended = () => {
                    buttonElement.classList.remove('playing');
                    playingAudios = playingAudios.filter(obj => obj.id !== audioId);
                    if (playingAudios.length === 0) setControlsDisabled(false);
                };
            };

            const loadSounds = async () => {
                try {
                    const response = await fetch('../SoundboardSN.json');
                    const soundsDataGlobal = await response.json();
                    soundCategoriesContainer.innerHTML = '';
                    const allSounds = [];
                    for (const categoryKey in soundsDataGlobal) {
                        const categoryDiv = document.createElement('div');
                        categoryDiv.className = 'sound-category-v4';
                        categoryDiv.innerHTML = `<h2><span class="category-icon-v4">üéµ</span>${categoryKey.replace(/([A-Z])/g, ' $1').trim()}</h2>`;
                        const buttonsGrid = document.createElement('div');
                        buttonsGrid.className = 'sound-buttons-grid-v4';
                        soundsDataGlobal[categoryKey].sort().forEach((filename, index) => {
                            const displayName = filename.replace(/\.mp3$/i, '').replace(/_/g, ' ');
                            const soundPath = `../Sounds/${filename}`;
                            allSounds.push({ path: soundPath });
                            const soundDetails = { id: `${categoryKey}-${index}`, path: soundPath };
                            const button = document.createElement('button');
                            button.className = 'sound-button-v4';
                            button.textContent = displayName;
                            button.dataset.soundName = displayName.toLowerCase();
                            button.addEventListener('click', () => playSound(soundDetails, button));
                            button.addEventListener('mouseenter', (event) => { currentlyHoveredButton = button; if (autoClickerCheckbox.checked) startAutoClicker(event); });
                            button.addEventListener('mouseleave', () => { if (currentlyHoveredButton === button) { currentlyHoveredButton = null; stopAutoClicker(); }});
                            button.addEventListener('mousedown', (event) => { if (autoClickerCheckbox.checked) startAutoClicker(event); });
                            button.addEventListener('mouseup', stopAutoClicker);
                            buttonsGrid.appendChild(button);
                        });
                        categoryDiv.appendChild(buttonsGrid);
                        soundCategoriesContainer.appendChild(categoryDiv);
                    }
                    const promises = allSounds.map(sound => 
                        fetch(sound.path).then(res => res.arrayBuffer()).then(buf => audioContext.decodeAudioData(buf)).then(decoded => { audioBuffers[sound.path] = decoded; })
                    );
                    await Promise.all(promises);
                } catch (error) { console.error("Error loading sounds:", error); }
            };

            const startAutoClicker = (event) => {
                if (!event) return;
                const trigger = autoClickerTrigger.value;
                if ((trigger === 'mouseenter' && event.type !== 'mouseenter') || (trigger === 'click' && event.type !== 'mousedown')) return;
                stopAutoClicker();
                if (!currentlyHoveredButton) return;
                const baseDelay = parseInt(autoClickDelayInput.value, 10) || 200;
                const isRandom = autoClickerRandomize.checked;
                const triggerClick = () => {
                    if (currentlyHoveredButton) { currentlyHoveredButton.dispatchEvent(new MouseEvent('click', { bubbles: true })); } else { stopAutoClicker(); }
                };
                autoClickIntervalId = setInterval(() => { if (isRandom) { setTimeout(triggerClick, Math.random() * 50); } else { triggerClick(); } }, Math.max(50, baseDelay));
            };

            const stopAutoClicker = () => { if (autoClickIntervalId) clearInterval(autoClickIntervalId); autoClickIntervalId = null; };

            const setupAutoClickerControls = () => {
                autoClickerCheckbox.addEventListener('change', function() {
                    autoClickerOptionsWrapper.style.display = this.checked ? 'flex' : 'none';
                    if (!this.checked) stopAutoClicker();
                    localStorage.setItem('autoClickerEnabledV4', this.checked);
                });
            };
            
            const setupEventListeners = () => {
                document.addEventListener('keydown', (e) => { if (e.shiftKey && (e.key === 'C' || e.key === 'c')) { e.preventDefault(); stopAllActiveSounds(); } });
                clearAllSoundsBtn.addEventListener('click', stopAllActiveSounds);
                toggleSearchBtn.addEventListener('click', () => {
                    floatingActionBar.classList.toggle('search-active');
                    if (floatingActionBar.classList.contains('search-active')) { soundSearchInput.focus(); } else { soundSearchInput.blur(); }
                });
                soundSearchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    document.querySelectorAll('.sound-button-v4').forEach(btn => { btn.style.display = btn.dataset.soundName.includes(searchTerm) ? 'flex' : 'none'; });
                });
                masterVolumeSlider.addEventListener('input', e => {
                    const value = parseFloat(e.target.value);
                    globalGainNode.gain.setValueAtTime(value, audioContext.currentTime);
                    masterVolumeValueDisplay.textContent = `${Math.round(value * 100)}%`;
                    masterVolumeSlider.style.setProperty('--volume-percent', `${(value / masterVolumeSlider.max) * 100}%`);
                    if (value >= 1 && !isVolumeBoosted) { isVolumeBoosted = true; masterVolumeSlider.max = 2; masterVolumeContainer.classList.add('boosted'); } 
                    else if (value < 1 && isVolumeBoosted) { isVolumeBoosted = false; masterVolumeSlider.max = 1; masterVolumeContainer.classList.remove('boosted'); }
                });
                masterVolumeSlider.addEventListener('change', e => localStorage.setItem('masterVolumeV4', e.target.value));
                panSlider.addEventListener('input', e => { const value = parseFloat(e.target.value); pannerNode.pan.setValueAtTime(value, audioContext.currentTime); let display = 'Center'; if (value < -0.05) display = `${Math.round(Math.abs(value) * 100)}% L`; if (value > 0.05) display = `${Math.round(value * 100)}% R`; panValueDisplay.textContent = display; });
                reverbSlider.addEventListener('input', e => { const value = parseFloat(e.target.value); const gain1 = Math.cos(value * 0.5 * Math.PI); const gain2 = Math.cos((1.0 - value) * 0.5 * Math.PI); reverbDryGain.gain.setValueAtTime(gain1, audioContext.currentTime); reverbWetGain.gain.setValueAtTime(gain2, audioContext.currentTime); reverbValueDisplay.textContent = `${Math.round(value * 100)}%`; });
                bassSlider.addEventListener('input', e => { const value = parseInt(e.target.value, 10); bassFilter.gain.setValueAtTime(value, audioContext.currentTime); bassValueDisplay.textContent = `${value >= 0 ? '+' : ''}${value} dB`; });
                midSlider.addEventListener('input', e => { const value = parseInt(e.target.value, 10); midFilter.gain.setValueAtTime(value, audioContext.currentTime); midValueDisplay.textContent = `${value >= 0 ? '+' : ''}${value} dB`; });
                trebleSlider.addEventListener('input', e => { const value = parseInt(e.target.value, 10); trebleFilter.gain.setValueAtTime(value, audioContext.currentTime); trebleValueDisplay.textContent = `${value >= 0 ? '+' : ''}${value} dB`; });
            };

            const loadPreferences = () => {
                const savedVolume = parseFloat(localStorage.getItem('masterVolumeV4') || '1');
                masterVolumeSlider.value = savedVolume;
                globalGainNode.gain.value = savedVolume;
                masterVolumeValueDisplay.textContent = `${Math.round(savedVolume * 100)}%`;
                if (savedVolume > 1) { isVolumeBoosted = true; masterVolumeSlider.max = 2; masterVolumeContainer.classList.add('boosted'); }
                masterVolumeSlider.style.setProperty('--volume-percent', `${(savedVolume / masterVolumeSlider.max) * 100}%`);
                // Load other preferences here
            };
            
            // --- Initial Execution ---
            setupSignOutButtons();
            loadPreferences();
            loadSounds();
            setupEventListeners();
            setupAutoClickerControls();
            setupControlsToggle();
            createReverbImpulse();
            setTimeout(updateMarquees, 500);
        });
    </script>
</body>
</html>
