<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>4SP - DASHBOARD</title>
  <link rel="stylesheet" href="../css/style.css" />
  <style>
    /* --- Fonts --- */
    /* Assuming "PrimaryFont" and "SecondaryFont" are defined elsewhere (e.g., in style.css or via @font-face). */
    body.dashboard-page {
      font-family: 'PrimaryFont', sans-serif;
      margin: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    /* --- Sidebar --- */
    .sidebar {
      width: 200px;
      background: linear-gradient(180deg, #333 0%, #2a2a2a 100%);
      color: #fff;
      padding: 20px 10px;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #444;
      transition: width 0.5s ease-in-out;
      position: relative;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }
    .sidebar.collapsed {
      width: 85px;
    }
    #toggleSidebar {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: none;
      border: none;
      color: #fff;
      font-size: 1.2em;
      cursor: pointer;
      padding: 4px;
      transition: transform 0.5s ease-in-out;
    }
    .sidebar.collapsed #toggleSidebar {
      transform: translateX(-50%) rotate(180deg);
    }
    .user-info {
      text-align: center;
      margin: 60px 0 30px;
      border-bottom: 1px solid #555;
      padding-bottom: 20px;
      overflow: visible;
    }
    .user-info .username {
      font-family: 'PrimaryFont', sans-serif;
      font-size: 1.3em;
      margin-bottom: 8px;
      line-height: 0.2em;
      font-weight: bold;
    }
    .user-info .email {
      font-family: 'SecondaryFont', sans-serif;
      font-size: 0.9em;
      color: #bbb;
    }
    .sidebar nav ul {
      list-style: none;
      padding: 0;
      margin: 20px 0 0;
    }
    .sidebar nav li {
      margin-bottom: 10px;
    }
    .sidebar nav a {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      color: #fff;
      text-decoration: none;
      border-radius: 8px;
      transition: all 0.3s ease;
      font-family: 'PrimaryFont', sans-serif;
      text-transform: uppercase;
      position: relative;
      overflow: hidden;
    }
    .sidebar nav a::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transition: left 0.5s;
    }
    .sidebar nav a:hover::before {
      left: 100%;
    }
    .sidebar nav a.active,
    .sidebar nav a:hover {
      background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
      transform: translateX(5px);
    }
    .sidebar nav a .icon {
      font-size: 1.2em;
      width: 24px;
      text-align: center;
    }
    .sidebar nav a .label {
      margin-left: 10px;
      white-space: nowrap;
    }
    .sidebar.collapsed nav a {
      justify-content: center;
      padding: 10px 0;
    }
    .sidebar.collapsed nav a .label {
      display: none;
    }

    /* --- Main Content & Controls --- */
    .main-content {
      flex: 1;
      padding: 40px;
      background: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
      overflow-y: auto;
      position: relative;
    }
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 40px;
      background: white;
      padding: 20px 30px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      border: 1px solid rgba(103, 32, 189, 0.1);
    }
    .dashboard-title {
      margin: 0;
      font-size: 2.2em;
      font-weight: bold;
      background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .dashboard-controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    .control-btn {
      background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
      border: none;
      color: #fff;
      padding: 10px 18px;
      border-radius: 15px;
      font-family: 'PrimaryFont', sans-serif;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9em;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: relative;
      overflow: hidden;
    }
    .control-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    .control-btn:hover::before {
      left: 100%;
    }
    .control-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(103, 32, 189, 0.3);
    }
    .control-btn.secondary {
      background: linear-gradient(135deg, #555 0%, #777 100%);
    }
    #addCardBtnElement {
      background: linear-gradient(135deg, #17a2b8 0%, #1f95a3 100%);
    }
    #tutorialBtn {
      background: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%);
    }
    .control-btn.secondary:hover {
      box-shadow: 0 8px 25px rgba(85, 85, 85, 0.3);
    }

    /* --- Quick Actions --- */
    .quick-actions {
      background: white;
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 6px 30px rgba(0,0,0,0.08);
      border: 1px solid rgba(103, 32, 189, 0.1);
    }
    .quick-actions h3 {
      margin: 0 0 20px 0;
      font-size: 1.4em;
      color: #333;
      display: flex;
      align-items: center;
    }
    .quick-actions h3::before {
      content: '‚ö°';
      margin-right: 10px;
      font-size: 1.2em;
    }
    .action-buttons {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    .action-btn {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border: 2px solid rgba(103, 32, 189, 0.2);
      color: #6720bd;
      padding: 12px 20px;
      border-radius: 15px;
      font-family: 'PrimaryFont', sans-serif;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .action-btn:hover {
      background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(103, 32, 189, 0.3);
    }

    /* --- Dashboard Grid & Cards --- */
    .dashboard-container {
      display: flex;
      flex: 1;
    }
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 25px;
      position: relative;
      transition: all 0.3s ease;
    }
    .dashboard-card {
      background: white;
      border-radius: 20px;
      padding: 15px;
      box-shadow: 0 6px 30px rgba(0,0,0,0.08);
      border: 1px solid rgba(103, 32, 189, 0.1);
      cursor: pointer;
      position: relative;
      user-select: none;
      z-index: 2;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
      font-family: 'SecondaryFont', sans-serif;
    }
    .dashboard-card[data-card-type="full"] {
      grid-column: span 1;
      min-height: 210px;
    }
    .dashboard-card[data-card-type="large"] {
      grid-column: span 2; /* spans two horizontal tiles */
      min-height: 160px;
      display: flex;
      flex-direction: column;
    }
    .dashboard-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(103, 32, 189, 0.05), transparent);
      transition: left 0.6s ease;
      z-index: -1;
    }
    .dashboard-card:hover::before {
      left: 100%;
    }
    .dashboard-card:hover:not(.dragging) {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 15px 40px rgba(103, 32, 189, 0.15);
      border-color: rgba(103, 32, 189, 0.3);
    }
    .card-header {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(103, 32, 189, 0.08);
      justify-content: space-between;
      flex-shrink: 0;
    }
    .card-icon {
      font-size: 1.8em;
      margin-right: 10px;
      background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 2px 4px rgba(103, 32, 189, 0.2));
    }
    .card-title {
      font-size: 1.1em;
      font-weight: bold;
      margin: 0;
      color: #333;
      flex-grow: 1;
      margin-right: 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-family: 'PrimaryFont', sans-serif;
    }
    .card-header-actions {
      display: none;
      gap: 6px;
      align-items: center;
    }
    .card-action-btn {
      background-color: rgba(0,0,0,0.05);
      color: #555;
      border: 1px solid rgba(0,0,0,0.15);
      width: 26px;
      height: 26px;
      border-radius: 50%;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .card-action-btn:hover {
      background-color: rgba(0,0,0,0.1);
      transform: scale(1.1);
      color: #000;
    }
    .card-action-btn.delete-btn {
      color: #dc3545;
      border-color: rgba(220, 53, 69, 0.5);
    }
    .card-action-btn.delete-btn:hover {
      background-color: #dc3545;
      border-color: #dc3545;
      color: white;
    }
    .card-action-btn.edit-btn {
      color: #007bff;
      border-color: rgba(0, 123, 255, 0.5);
    }
    .card-action-btn.edit-btn:hover {
      background-color: #007bff;
      border-color: #007bff;
      color: white;
    }
    .card-description {
      color: #666;
      font-size: 0.9em;
      line-height: 1.4;
      margin-bottom: 10px;
      flex-grow: 1;
      overflow: hidden;
    }
    .card-content-inner {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    /* --- Forecast (Schedule Layout) --- */
    .forecast-large {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 10px;
    }
    .forecast-row {
      display: grid;
      grid-template-columns: 1fr auto auto;
      align-items: center;
      font-size: 0.85em;
      border-bottom: 1px solid #eee;
      padding: 4px 0;
    }
    .schedule-day {
      font-weight: bold;
      color: #333;
      font-family: 'PrimaryFont', sans-serif;
    }
    .schedule-icon {
      font-size: 1.2em;
      text-align: center;
    }
    .schedule-temp {
      color: #555;
      text-align: right;
    }

    /* --- Calculator Styling --- */
    .calculator-display {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 1.1em;
      text-align: right;
      margin-bottom: 10px;
      box-sizing: border-box;
    }
    .calculator-buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 5px;
    }
    .calculator-buttons button {
      background: linear-gradient(135deg, #e0e0e0 0%, #f8f8f8 100%);
      border: 1px solid #ccc;
      padding: 12px;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
      font-family: 'PrimaryFont', sans-serif;
      transition: background 0.2s, transform 0.2s;
    }
    .calculator-buttons button:hover {
      background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
      color: #fff;
      transform: translateY(-2px);
    }

    /* --- Add/Edit Card Modal Styles --- */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.6);
      animation: fadeInModal 0.3s ease-out;
    }
    @keyframes fadeInModal {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .modal-content {
      background-color: #fefefe;
      margin: 8% auto;
      padding: 25px;
      border: 1px solid #888;
      width: 70%;
      max-width: 900px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      position: relative;
    }
    .close-button {
      color: #aaa;
      position: absolute;
      top: 15px;
      right: 25px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close-button:hover,
    .close-button:focus {
      color: #333;
      text-decoration: none;
    }
    .modal-content h2 {
      margin-top: 0;
      color: #6720bd;
      text-align: center;
      margin-bottom: 20px;
      font-family: 'PrimaryFont', sans-serif;
    }
    .modal-body {
      display: flex;
      max-height: 60vh;
    }
    .modal-sidebar {
      width: 220px;
      padding-right: 20px;
      border-right: 1px solid #eee;
      overflow-y: auto;
    }
    .modal-sidebar h3 {
      margin-top: 0;
      color: #333;
      margin-bottom: 15px;
      font-family: 'PrimaryFont', sans-serif;
    }
    .modal-sidebar ul {
      list-style: none;
      padding: 0;
    }
    .modal-sidebar li {
      padding: 10px 12px;
      cursor: pointer;
      border-radius: 8px;
      margin-bottom: 8px;
      color: #555;
      transition: background-color 0.2s, color 0.2s;
      font-size: 0.95em;
      font-family: 'SecondaryFont', sans-serif;
    }
    .modal-sidebar li:hover,
    .modal-sidebar li.active {
      background-color: #6720bd;
      color: white;
    }
    .modal-main-content {
      flex: 1;
      padding-left: 20px;
      overflow-y: auto;
    }
    .modal-card-selection-view,
    .modal-card-configure-view {
      display: none;
    }
    .modal-card-selection-view {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 20px;
    }
    .mini-card {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      background-color: #fff;
      transition: transform 0.2s, box-shadow 0.2s;
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-height: 120px;
      font-family: 'SecondaryFont', sans-serif;
    }
    .mini-card:hover {
      transform: translateY(-5px) scale(1.03);
      box-shadow: 0 8px 15px rgba(103, 32, 189, 0.15);
      border-color: #6720bd;
    }
    .mini-card .icon {
      font-size: 2.2em;
      margin-bottom: 10px;
      display: block;
      color: #6720bd;
    }
    .mini-card h4 {
      margin: 0 0 8px 0;
      font-size: 1.1em;
      color: #333;
      font-family: 'PrimaryFont', sans-serif;
    }
    .mini-card p {
      font-size: 0.85em;
      color: #777;
      margin: 0;
      line-height: 1.3;
      font-family: 'SecondaryFont', sans-serif;
    }
    .modal-card-configure-view h3 {
      color: #444;
      margin-top: 0;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
      font-family: 'PrimaryFont', sans-serif;
    }
    .config-option {
      margin-bottom: 15px;
    }
    .config-option label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #555;
      font-size: 0.9em;
      font-family: 'PrimaryFont', sans-serif;
    }
    .config-option input[type="text"],
    .config-option input[type="number"],
    .config-option select,
    .config-option textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
      font-size: 0.9em;
      font-family: 'SecondaryFont', sans-serif;
    }
    .config-option textarea {
      min-height: 60px;
      resize: vertical;
    }
    .config-option button {
      background-color: #777;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 5px;
      transition: background-color 0.2s;
      font-family: 'PrimaryFont', sans-serif;
    }
    .config-option button:hover {
      background-color: #666;
    }
    .modal-actions {
      margin-top: 25px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    .modal-actions button {
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.2s;
      font-family: 'PrimaryFont', sans-serif;
    }
    .modal-actions .btn-primary {
      background-color: #6720bd;
      color: white;
      border: none;
    }
    .modal-actions .btn-primary:hover {
      background-color: #5a1ca0;
    }
    .modal-actions .btn-secondary {
      background-color: #6c757d;
      color: white;
      border: none;
    }
    .modal-actions .btn-secondary:hover {
      background-color: #5a6268;
    }

    /* --- Tutorial Overlay Styles --- */
    .tutorial-overlay {
      display: none;
      position: fixed;
      z-index: 3000;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
    }
    .tutorial-highlight {
      position: relative;
      z-index: 3001;
      box-shadow: 0 0 0 4px rgba(255, 235, 59, 0.8);
      border-radius: 10px;
    }
    .tutorial-tooltip {
      position: absolute;
      z-index: 3002;
      background: #fff;
      color: #333;
      padding: 12px 16px;
      border-radius: 8px;
      max-width: 260px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      font-family: 'SecondaryFont', sans-serif;
      font-size: 0.9em;
    }
    .tutorial-close-btn {
      position: absolute;
      top: 20px;
      right: 30px;
      background: #ff5252;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 1.2em;
      cursor: pointer;
      z-index: 3003;
    }

    /* --- Responsive Design --- */
    @media (max-width: 768px) {
      .dashboard-grid {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      }
      .dashboard-card[data-card-type="large"] {
        grid-column: span 1;
      }
      .dashboard-header {
        flex-direction: column;
        gap: 20px;
        text-align: center;
      }
      .dashboard-controls {
        justify-content: center;
      }
      .main-content {
        padding: 20px;
      }
      .modal-content {
        width: 90%;
        margin: 10% auto;
      }
      .modal-body {
        flex-direction: column;
        max-height: 75vh;
      }
      .modal-sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #eee;
        padding-right: 0;
        margin-bottom: 15px;
        max-height: 150px;
      }
      .modal-main-content {
        padding-left: 0;
      }
    }

    /* --- Animation Classes --- */
    .fade-in {
      animation: fadeIn 0.6s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeInModal {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>
</head>

<body class="dashboard-page">
  <header class="main-header light-bg">
    <div class="container" style="display:flex; justify-content:space-between; align-items:center;">
      <div class="logo">
        <a href="../index.html">
          <img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer; height: 40px;" />
        </a>
      </div>
      <div class="dashboard-controls">
        <button class="control-btn" id="tutorialBtn">Tutorial</button>
        <button id="logoutBtn" class="control-btn secondary">LOG OUT</button>
      </div>
    </div>
  </header>

  <div class="dashboard-container">
    <aside class="sidebar slide-in" id="sidebar" data-tutorial-target="sidebar">
      <button id="toggleSidebar">‚ò∞</button>
      <div class="user-info">
        <div class="username" id="userName">Loading‚Ä¶</div>
        <div class="email" id="userEmail">Loading‚Ä¶</div>
      </div>
      <nav>
        <ul>
          <li><a href="dashboard.html" class="active"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
          <li><a href="proxies.html"><span class="icon">üõ°Ô∏è</span><span class="label">Proxies</span></a></li>
          <li><a href="soundboard.html"><span class="icon">üéµ</span><span class="label">Soundboard</span></a></li>
          <li><a href="games.html"><span class="icon">üéÆ</span><span class="label">Games</span></a></li>
          <li><a href="others.html"><span class="icon">‚ú®</span><span class="label">Others</span></a></li>
          <li><a href="settings.html"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a></li>
        </ul>
      </nav>
    </aside>

    <main class="main-content fade-in" id="mainContent">
      <div class="dashboard-header" data-tutorial-target="header">
        <h2 class="dashboard-title">Dashboard</h2>
        <div class="dashboard-controls">
          <button id="addCardBtnElement" class="control-btn">+ Add Card</button>
          <button id="resetLayoutBtn" class="control-btn secondary">Reset Layout</button>
          <button id="editDashboard" class="control-btn">Edit Layout</button>
        </div>
      </div>

      <div class="quick-actions" data-tutorial-target="quickActions">
        <h3>Quick Actions</h3>
        <div class="action-buttons">
          <button class="action-btn" onclick="window.location.href='proxies.html'">
            <span>üõ°Ô∏è</span> Launch Proxy
          </button>
          <button class="action-btn" onclick="window.location.href='games.html'">
            <span>üéÆ</span> Play Games
          </button>
          <button class="action-btn" onclick="window.location.href='soundboard.html'">
            <span>üéµ</span> Open Soundboard
          </button>
          <button class="action-btn" onclick="window.location.href='settings.html'">
            <span>‚öôÔ∏è</span> Settings
          </button>
        </div>
      </div>

      <div class="dashboard-grid" id="dashboardGrid">
        <!-- Weather Card (spans 2 columns horizontally) -->
        <div class="dashboard-card" data-card-type="large" data-id="weather_widget" data-template-id="weather_widget" data-tutorial-target="weather">
          <div class="card-header">
            <div class="card-icon">üå¶Ô∏è</div>
            <h4 class="card-title">Weekly Weather Forecast</h4>
            <div class="card-header-actions">
              <button class="card-action-btn edit-btn" data-action="edit">‚úé</button>
              <button class="card-action-btn delete-btn" data-action="delete">‚úï</button>
            </div>
          </div>
          <div class="weather-large-content">
            <div class="current-weather-large">
              <span class="weather-icon-large">‚è≥</span>
              <div>
                <span class="temp-large">--¬∞</span>
                <span class="condition-large">Loading...</span>
                <div class="details-large">
                  <p>Wind: --</p>
                  <p>Humidity: --%</p>
                  <p>Location: --</p>
                </div>
              </div>
            </div>
            <div class="forecast-large"></div>
            <small style="text-align:center; display:block; margin-top:auto; color:#aaa; font-size:0.7em;">Weather by Open-Meteo.com</small>
          </div>
        </div>

        <!-- Username Card -->
        <div class="dashboard-card" data-card-type="full" data-id="user_info_card" data-template-id="custom_card" data-tutorial-target="userCard">
          <div class="card-header">
            <div class="card-icon">üë§</div>
            <h4 class="card-title">Your Info</h4>
            <div class="card-header-actions">
              <button class="card-action-btn edit-btn" data-action="edit">‚úé</button>
              <button class="card-action-btn delete-btn" data-action="delete">‚úï</button>
            </div>
          </div>
          <div class="card-content-inner">
            <p class="card-description">Username:</p>
            <p id="displayUsername" style="font-family:'PrimaryFont'; font-size:1.1em; color:#333; margin-top:4px;">Loading‚Ä¶</p>
          </div>
        </div>

        <!-- Quick Notes Card -->
        <div class="dashboard-card" data-card-type="full" data-id="quick_notes" data-template-id="custom_card" data-tutorial-target="quickNotes">
          <div class="card-header">
            <div class="card-icon">üìù</div>
            <h4 class="card-title">Quick Notes</h4>
            <div class="card-header-actions">
              <button class="card-action-btn edit-btn" data-action="edit">‚úé</button>
              <button class="card-action-btn delete-btn" data-action="delete">‚úï</button>
            </div>
          </div>
          <div class="card-content-inner">
            <textarea id="quick_notes_textarea" placeholder="Type your notes here..." style="width:100%; height:100px; border:1px solid #ccc; border-radius:5px; padding:8px; font-size:0.9em;"></textarea>
            <button id="quick_notes_save_btn" style="margin-top:8px; background:#6720bd; color:#fff; border:none; padding:8px 12px; border-radius:5px; cursor:pointer; font-family:'PrimaryFont';">Save Note</button>
          </div>
        </div>

        <!-- Dictionary Card -->
        <div class="dashboard-card" data-card-type="full" data-id="dictionary" data-template-id="custom_card" data-tutorial-target="dictionary">
          <div class="card-header">
            <div class="card-icon">üìñ</div>
            <h4 class="card-title">Dictionary Lookup</h4>
            <div class="card-header-actions">
              <button class="card-action-btn edit-btn" data-action="edit">‚úé</button>
              <button class="card-action-btn delete-btn" data-action="delete">‚úï</button>
            </div>
          </div>
          <div class="card-content-inner">
            <input id="dictionary_input" type="text" placeholder="Enter a word..." style="width:100%; padding:8px; border:1px solid #ccc; border-radius:5px; margin-bottom:8px;"/>
            <button id="dictionary_lookup_btn" style="background:#6720bd; color:#fff; border:none; padding:8px 12px; border-radius:5px; cursor:pointer; font-family:'PrimaryFont';">Lookup</button>
            <div id="dictionary_result" style="margin-top:10px; font-size:0.9em; color:#333;"></div>
          </div>
        </div>

        <!-- Calculator Card -->
        <div class="dashboard-card" data-card-type="full" data-id="calculator" data-template-id="custom_card" data-tutorial-target="calculator">
          <div class="card-header">
            <div class="card-icon">üßÆ</div>
            <h4 class="card-title">Calculator</h4>
            <div class="card-header-actions">
              <button class="card-action-btn edit-btn" data-action="edit">‚úé</button>
              <button class="card-action-btn delete-btn" data-action="delete">‚úï</button>
            </div>
          </div>
          <div class="card-content-inner">
            <input id="calc_display" class="calculator-display" type="text" readonly />
            <div class="calculator-buttons">
              <button class="calc-btn">7</button>
              <button class="calc-btn">8</button>
              <button class="calc-btn">9</button>
              <button class="calc-btn">/</button>
              <button class="calc-btn">4</button>
              <button class="calc-btn">5</button>
              <button class="calc-btn">6</button>
              <button class="calc-btn">*</button>
              <button class="calc-btn">1</button>
              <button class="calc-btn">2</button>
              <button class="calc-btn">3</button>
              <button class="calc-btn">-</button>
              <button class="calc-btn">0</button>
              <button class="calc-btn">.</button>
              <button class="calc-btn">=</button>
              <button class="calc-btn">+</button>
            </div>
          </div>
        </div>

        <!-- Random Joke Card -->
        <div class="dashboard-card" data-card-type="full" data-id="random_joke" data-template-id="custom_card" data-tutorial-target="randomJoke">
          <div class="card-header">
            <div class="card-icon">ü§£</div>
            <h4 class="card-title">Random Joke</h4>
            <div class="card-header-actions">
              <button class="card-action-btn edit-btn" data-action="edit">‚úé</button>
              <button class="card-action-btn delete-btn" data-action="delete">‚úï</button>
            </div>
          </div>
          <div class="card-content-inner" style="justify-content:center; align-items:center;">
            <button id="random_joke_btn" style="background:#6720bd; color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-family:'PrimaryFont';">Tell Me a Joke</button>
          </div>
        </div>

        <!-- Random Quote Card -->
        <div class="dashboard-card" data-card-type="full" data-id="random_quote" data-template-id="custom_card" data-tutorial-target="randomQuote">
          <div class="card-header">
            <div class="card-icon">üí¨</div>
            <h4 class="card-title">Random Quote</h4>
            <div class="card-header-actions">
              <button class="card-action-btn edit-btn" data-action="edit">‚úé</button>
              <button class="card-action-btn delete-btn" data-action="delete">‚úï</button>
            </div>
          </div>
          <div class="card-content-inner" style="justify-content:center; align-items:center;">
            <button id="random_quote_btn" style="background:#6720bd; color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-family:'PrimaryFont';">Show Quote</button>
          </div>
        </div>
      </div>

      <p style="text-align: center; color: #666; margin-top: 40px; font-style: italic;">
        Drag cards to rearrange. Use "Edit Layout" for customization. Click "+ Add Card" for more widgets.
      </p>
    </main>
  </div>

  <!-- Tutorial Overlay -->
  <div class="tutorial-overlay" id="tutorialOverlay"></div>
  <button class="tutorial-close-btn" id="tutorialCloseBtn">√ó</button>
  <!-- Tooltips (dynamically positioned) -->
  <div class="tutorial-tooltip" id="tutorialTooltip"></div>

  <!-- Add/Edit Card Modal (shell for future expansion) -->
  <div id="addCardModal" class="modal">
    <div class="modal-content">
      <span class="close-button" id="closeModalBtn">√ó</span>
      <h2 id="modalTitle">Add New Card</h2>
      <div class="modal-body">
        <aside class="modal-sidebar">
          <h3>Categories</h3>
          <ul id="cardCategories">
            <li data-category="all" class="active">All Widgets</li>
            <li data-category="info">Info & Reference</li>
            <li data-category="tools">Productivity & Tools</li>
            <li data-category="media">Media & Entertainment</li>
            <li data-category="dev">Developer Utilities</li>
          </ul>
        </aside>
        <main class="modal-main-content">
          <div class="modal-card-selection-view" id="modalCardSelectionView"></div>
          <div class="modal-card-configure-view" id="modalCardConfigureView" style="display:none;">
            <h3 id="configureCardTitle">Configure Card</h3>
            <div id="configureCardOptionsContainer"></div>
            <div class="modal-actions">
              <button id="configureCardBackBtn" class="btn-secondary">Back</button>
              <button id="configureCardAddBtn" class="btn-primary">Add to Dashboard</button>
            </div>
          </div>
        </main>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="../firebase-config.js"></script>
  <script>
    // --- Globals & Firebase Refs ---
    const dbRef = () =>
      firebase.auth().currentUser
        ? firebase.firestore().collection('users').doc(firebase.auth().currentUser.uid)
        : null;
    let editMode = false;
    let draggedElement = null;
    let placeholderElement = null;

    // --- DOM Elements ---
    const marqueeEls = document.querySelectorAll('.marquee-content');
    const dashboardGrid = document.getElementById('dashboardGrid');
    const editBtn = document.getElementById('editDashboard');
    const addCardBtnElement = document.getElementById('addCardBtnElement');
    const resetLayoutBtn = document.getElementById('resetLayoutBtn');
    const addCardModal = document.getElementById('addCardModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const cardCategoriesList = document.getElementById('cardCategories');
    const modalCardSelectionView = document.getElementById('modalCardSelectionView');
    const modalCardConfigureView = document.getElementById('modalCardConfigureView');
    const configureCardTitle = document.getElementById('configureCardTitle');
    const configureCardOptionsContainer = document.getElementById('configureCardOptionsContainer');
    const configureCardBackBtn = document.getElementById('configureCardBackBtn');
    const configureCardAddBtn = document.getElementById('configureCardAddBtn');
    const userNameEl = document.getElementById('userName');
    const userEmailEl = document.getElementById('userEmail');
    const displayUsernameEl = document.getElementById('displayUsername');

    // Tutorial elements
    const tutorialBtn = document.getElementById('tutorialBtn');
    const tutorialOverlay = document.getElementById('tutorialOverlay');
    const tutorialCloseBtn = document.getElementById('tutorialCloseBtn');
    const tutorialTooltip = document.getElementById('tutorialTooltip');
    let tutorialStep = 0;
    const tutorialSteps = [
      {
        element: document.getElementById('sidebar'),
        text: "This is your sidebar. Use it to navigate between sections."
      },
      {
        element: document.querySelector('[data-tutorial-target="header"]'),
        text: "Here is the dashboard header. You can add, edit, or reset cards here."
      },
      {
        element: document.querySelector('[data-tutorial-target="quickActions"]'),
        text: "Quick Actions let you jump to other parts of the site quickly."
      },
      {
        element: document.querySelector('[data-tutorial-target="weather"]'),
        text: "This is the weather widget. It spans two tiles horizontally."
      },
      {
        element: document.querySelector('[data-tutorial-target="userCard"]'),
        text: "Your user info card shows your username."
      },
      {
        element: document.querySelector('[data-tutorial-target="calculator"]'),
        text: "Here‚Äôs the calculator card. Click buttons to perform calculations."
      }
    ];

    // WMO_CODES (same as before) ‚Ä¶
    const WMO_CODES = {
      0: { description: "Clear sky", icon: "‚òÄÔ∏è" },
      1: { description: "Mainly clear", icon: "üå§Ô∏è" },
      2: { description: "Partly cloudy", icon: "üå•Ô∏è" },
      3: { description: "Overcast", icon: "‚òÅÔ∏è" },
      45: { description: "Fog", icon: "üå´Ô∏è" },
      48: { description: "Depositing rime fog", icon: "üå´Ô∏è" },
      51: { description: "Light drizzle", icon: "üå¶Ô∏è" },
      53: { description: "Moderate drizzle", icon: "üå¶Ô∏è" },
      55: { description: "Dense drizzle", icon: "üå¶Ô∏è" },
      56: { description: "Light freezing drizzle", icon: "üå®Ô∏è" },
      57: { description: "Dense freezing drizzle", icon: "üå®Ô∏è" },
      61: { description: "Slight rain", icon: "üåßÔ∏è" },
      63: { description: "Moderate rain", icon: "üåßÔ∏è" },
      65: { description: "Heavy rain", icon: "üåßÔ∏è" },
      66: { description: "Light freezing rain", icon: "üå®Ô∏è" },
      67: { description: "Heavy freezing rain", icon: "üå®Ô∏è" },
      71: { description: "Slight snow fall", icon: "‚ùÑÔ∏è" },
      73: { description: "Moderate snow fall", icon: "‚ùÑÔ∏è" },
      75: { description: "Heavy snow fall", icon: "‚ùÑÔ∏è" },
      77: { description: "Snow grains", icon: "‚ùÑÔ∏è" },
      80: { description: "Slight rain showers", icon: "üå¶Ô∏è" },
      81: { description: "Moderate rain showers", icon: "üå¶Ô∏è" },
      82: { description: "Violent rain showers", icon: "‚õàÔ∏è" },
      85: { description: "Slight snow showers", icon: "üå®Ô∏è" },
      86: { description: "Heavy snow showers", icon: "üå®Ô∏è" },
      95: { description: "Thunderstorm", icon: "‚õàÔ∏è" },
      96: { description: "Thunderstorm with slight hail", icon: "‚õàÔ∏è" },
      99: { description: "Thunderstorm with heavy hail", icon: "‚õàÔ∏è" },
    };

    // --- Card Templates ---
    const availableCardTemplates = [
      // Weather card
      {
        templateId: 'weather_widget',
        title: 'Weekly Weather Forecast',
        icon: 'üå¶Ô∏è',
        description: '7-day weather forecast from Open-Meteo.',
        category: 'info',
        type: 'large',
        configOptions: [
          { name: 'use_current_location', label: 'Use Current Location', type: 'button', buttonText: 'üìç Use My Current Location' },
          { name: 'location_label', label: 'Location Label', type: 'text', defaultValue: 'Massillon, OH', placeholder: 'e.g., Home or New York' },
          { name: 'latitude', label: 'Latitude', type: 'number', defaultValue: '40.7909', step: '0.0001' },
          { name: 'longitude', label: 'Longitude', type: 'number', defaultValue: '-81.5218', step: '0.0001' },
          { name: 'units', label: 'Units', type: 'select', defaultValue: 'imperial', values: [
              { value: 'metric', label: 'Metric (¬∞C, km/h)' },
              { value: 'imperial', label: 'Imperial (¬∞F, mph)' }
            ]
          }
        ],
        contentGenerator: (config) => `
          <div class="weather-large-content">
            <div class="current-weather-large" style="display:flex; align-items:center;">
              <span class="weather-icon-large" style="font-size:2em; margin-right:10px;">‚è≥</span>
              <div>
                <span class="temp-large" style="font-size:1.8em; font-weight:bold;">--¬∞</span>
                <span class="condition-large" style="margin-left:8px;">Loading...</span>
                <div class="details-large" style="margin-top:6px; font-size:0.9em; color:#555;">
                  <p style="margin:2px 0;">Wind: --</p>
                  <p style="margin:2px 0;">Humidity: --%</p>
                  <p style="margin:2px 0;">Location: ${config.location_label || (config.latitude && config.longitude ? `Lat: ${parseFloat(config.latitude).toFixed(2)}, Lon: ${parseFloat(config.longitude).toFixed(2)}` : 'N/A')}</p>
                </div>
              </div>
            </div>
            <div class="forecast-large"></div>
            <small style="text-align:center; display:block; margin-top:8px; color:#aaa; font-size:0.7em;">Weather by Open-Meteo.com</small>
          </div>
        `,
        onMount: async (cardElement, config) => {
          const forecastEl = cardElement.querySelector('.forecast-large');
          const currentIconEl = cardElement.querySelector('.current-weather-large .weather-icon-large');
          const currentTempEl = cardElement.querySelector('.current-weather-large .temp-large');
          const currentConditionEl = cardElement.querySelector('.current-weather-large .condition-large');
          const currentDetailsEl = cardElement.querySelector('.current-weather-large .details-large');

          const displayError = (message) => {
            currentConditionEl.textContent = message;
            currentIconEl.textContent = '‚ö†Ô∏è';
            currentTempEl.textContent = '';
            forecastEl.innerHTML = `<p style="color:red; text-align:center; font-size:0.9em;">${message}</p>`;
          };

          async function fetchWeatherData(lat, lon, units = 'imperial') {
            try {
              currentConditionEl.textContent = 'Fetching...';
              currentIconEl.textContent = '‚è≥';
              const tempUnitParam = units === 'metric' ? 'celsius' : 'fahrenheit';
              const windSpeedUnitParam = units === 'metric' ? 'kmh' : 'mph';
              const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&daily=weathercode,temperature_2m_max,temperature_2m_min&temperature_unit=${tempUnitParam}&wind_speed_unit=${windSpeedUnitParam}&timezone=auto&forecast_days=7`;
              const response = await fetch(apiUrl);
              if (!response.ok) throw new Error(`API Error: ${response.status}`);
              const data = await response.json();

              const cw = data.current_weather;
              const cwCodeInfo = WMO_CODES[cw.weathercode] || { description: "Unknown", icon: "‚ùì" };
              const tempSuffix = units === 'metric' ? '¬∞C' : '¬∞F';
              const speedSuffix = units === 'metric' ? ' km/h' : ' mph';

              currentTempEl.textContent = `${Math.round(cw.temperature)}${tempSuffix}`;
              currentIconEl.textContent = cwCodeInfo.icon;
              currentConditionEl.textContent = cwCodeInfo.description;
              currentDetailsEl.innerHTML = `
                <p style="margin:2px 0;">Wind: ${Math.round(cw.windspeed)}${speedSuffix}</p>
                <p style="margin:2px 0;">Humidity: N/A</p>
                <p style="margin:2px 0;">Location: ${config.location_label || `Lat: ${parseFloat(lat).toFixed(2)}, Lon: ${parseFloat(lon).toFixed(2)}`}</p>
              `;

              forecastEl.innerHTML = '';
              const daily = data.daily;
              for (let i = 0; i < daily.time.length; i++) {
                const dayCodeInfo = WMO_CODES[daily.weathercode[i]] || { description: "Unknown", icon: "‚ùì" };
                const date = new Date(daily.time[i]);
                const dayName = i === 0 ? "Today" : date.toLocaleDateString(undefined, { weekday: 'short' });
                const dayRow = document.createElement('div');
                dayRow.classList.add('forecast-row');
                dayRow.innerHTML = `
                  <span class="schedule-day">${dayName}</span>
                  <span class="schedule-icon">${dayCodeInfo.icon}</span>
                  <span class="schedule-temp">${Math.round(daily.temperature_2m_max[i])}¬∞/${Math.round(daily.temperature_2m_min[i])}¬∞</span>
                `;
                forecastEl.appendChild(dayRow);
              }
            } catch (error) {
              console.error("Weather fetch error:", error);
              displayError(error.message || "Could not fetch weather.");
            }
          }

          const useLocBtn = cardElement.querySelector('[data-action="use_current_location"]');
          if (useLocBtn) {
            useLocBtn.addEventListener('click', async () => {
              if (navigator.geolocation) {
                try {
                  const position = await new Promise((resolve, reject) =>
                    navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 })
                  );
                  cardElement.dataset[`configLatitude`] = position.coords.latitude.toFixed(4);
                  cardElement.dataset[`configLongitude`] = position.coords.longitude.toFixed(4);
                  cardElement.querySelector(`#config_weather_widget_location_label`).value = "Current Location";
                  fetchWeatherData(position.coords.latitude, position.coords.longitude, config.units);
                } catch (err) {
                  console.warn(`Could not get location: ${err.message}`);
                }
              } else {
                console.warn('Geolocation is not supported.');
              }
            });
          }

          if (config.latitude && config.longitude) {
            fetchWeatherData(config.latitude, config.longitude, config.units);
          } else {
            displayError("Location not set.");
          }
        }
      },
      // Generic custom_card template
      {
        templateId: 'custom_card',
        title: 'Custom Card',
        icon: 'üìå',
        description: 'Utility card.',
        category: 'tools',
        type: 'full',
        contentGenerator: (config) => `
          <p class="card-description">${config.description || ''}</p>
          ${config.innerHTML || ''}
        `,
        onMount: (cardElement, config) => {
          if (config.functionName && typeof window[config.functionName] === 'function') {
            cardElement.onclick = (e) => {
              // Prevent navigation when clicking interactive elements
              if (
                e.target.tagName === 'BUTTON' ||
                e.target.closest('button') ||
                e.target.tagName === 'TEXTAREA' ||
                e.target.tagName === 'INPUT' ||
                e.target.closest('a') ||
                e.target.closest('iframe')
              ) {
                return;
              }
              window[config.functionName](cardElement);
            };
          }
        }
      }
    ];

    // --- Custom Card Definitions (8 total: weather + 7) ---
    const customCardDefinitions = [
      // Weather is handled separately
      {
        id: 'user_info_card',
        title: 'Your Info',
        icon: 'üë§',
        description: 'Display your username.',
        functionName: 'userInfoFunction',
        innerHTML: `<p class="card-description">Username:</p><p id="displayUsername" style="font-family:'PrimaryFont'; font-size:1.1em; color:#333; margin-top:4px;">Loading‚Ä¶</p>`
      },
      {
        id: 'quick_notes',
        title: 'Quick Notes',
        icon: 'üìù',
        description: 'Jot down and save quick notes.',
        functionName: 'quickNotesFunction',
        innerHTML: `
          <textarea id="quick_notes_textarea" placeholder="Type your notes here..." style="width:100%; height:100px; border:1px solid #ccc; border-radius:5px; padding:8px; font-size:0.9em;"></textarea>
          <button id="quick_notes_save_btn" style="margin-top:8px; background:#6720bd; color:#fff; border:none; padding:8px 12px; border-radius:5px; cursor:pointer; font-family:'PrimaryFont';">Save Note</button>
        `
      },
      {
        id: 'dictionary',
        title: 'Dictionary Lookup',
        icon: 'üìñ',
        description: 'Look up word definitions.',
        functionName: 'dictionaryFunction',
        innerHTML: `
          <input id="dictionary_input" type="text" placeholder="Enter a word..." style="width:100%; padding:8px; border:1px solid #ccc; border-radius:5px; margin-bottom:8px;"/>
          <button id="dictionary_lookup_btn" style="background:#6720bd; color:#fff; border:none; padding:8px 12px; border-radius:5px; cursor:pointer; font-family:'PrimaryFont';">Lookup</button>
          <div id="dictionary_result" style="margin-top:10px; font-size:0.9em; color:#333;"></div>
        `
      },
      {
        id: 'calculator',
        title: 'Calculator',
        icon: 'üßÆ',
        description: 'Basic arithmetic calculator.',
        functionName: 'calculatorFunction',
        innerHTML: `
          <input id="calc_display" class="calculator-display" type="text" readonly />
          <div class="calculator-buttons">
            <button class="calc-btn">7</button>
            <button class="calc-btn">8</button>
            <button class="calc-btn">9</button>
            <button class="calc-btn">/</button>
            <button class="calc-btn">4</button>
            <button class="calc-btn">5</button>
            <button class="calc-btn">6</button>
            <button class="calc-btn">*</button>
            <button class="calc-btn">1</button>
            <button class="calc-btn">2</button>
            <button class="calc-btn">3</button>
            <button class="calc-btn">-</button>
            <button class="calc-btn">0</button>
            <button class="calc-btn">.</button>
            <button class="calc-btn">=</button>
            <button class="calc-btn">+</button>
          </div>
        `
      },
      {
        id: 'unit_converter',
        title: 'Unit Converter',
        icon: 'üîÑ',
        description: 'Convert units (length, weight).',
        functionName: 'unitConverterFunction',
        innerHTML: `
          <select id="uc_from" style="width:48%; padding:6px; margin-right:4%; border:1px solid #ccc; border-radius:5px;">
            <option value="m_to_ft">Meters ‚Üí Feet</option>
            <option value="kg_to_lb">Kilograms ‚Üí Pounds</option>
          </select>
          <input id="uc_input" type="number" placeholder="Value" style="width:48%; padding:6px; border:1px solid #ccc; border-radius:5px;"/>
          <button id="uc_convert_btn" style="margin-top:8px; background:#6720bd; color:#fff; border:none; padding:8px 12px; border-radius:5px; cursor:pointer; font-family:'PrimaryFont';">Convert</button>
          <div id="uc_result" style="margin-top:10px; font-size:0.9em; color:#333;"></div>
        `
      },
      {
        id: 'random_joke',
        title: 'Random Joke',
        icon: 'ü§£',
        description: 'Get a random joke.',
        functionName: 'randomJokeFunction',
        innerHTML: `<button id="random_joke_btn" style="background:#6720bd; color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-family:'PrimaryFont';">Tell Me a Joke</button>`
      },
      {
        id: 'random_quote',
        title: 'Random Quote',
        icon: 'üí¨',
        description: 'Get an inspirational quote.',
        functionName: 'randomQuoteFunction',
        innerHTML: `<button id="random_quote_btn" style="background:#6720bd; color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-family:'PrimaryFont';">Show Quote</button>`
      }
    ];

    // --- Authentication & Initial Load ---
    firebase.auth().onAuthStateChanged(async user => {
      if (!user) {
        return location.href = '../login.html';
      }
      userEmailEl.textContent = user.email;
      try {
        const userDocRef = dbRef();
        if (!userDocRef) return;
        const doc = await userDocRef.get();
        const userData = doc.exists ? doc.data() : {};
        const displayName = userData.username || user.displayName || user.email.split('@')[0];
        userNameEl.textContent = displayName;
        displayUsernameEl.textContent = displayName;

        // Clear and recreate cards
        dashboardGrid.innerHTML = '';

        // 1. Weather Card
        addCardToDashboard('weather_widget', {
          latitude: '40.7909',
          longitude: '-81.5218',
          location_label: 'Massillon, OH',
          units: 'imperial'
        }, 'weather_widget');

        // 2. Create each custom convenience card (7 total)
        customCardDefinitions.forEach(def => {
          addCustomCard(def);
        });

        setTimeout(() => {
          document.querySelectorAll('.dashboard-card').forEach((card, index) => {
            card.style.animationDelay = `${index * 0.05}s`;
            card.classList.add('fade-in');
          });
        }, 300);

      } catch (error) {
        console.error('Error loading user data:', error);
      }
    });

    // --- Reset / Save Layout ---
    function resetToDefaultLayout(doConfirmAndSave = true) {
      if (doConfirmAndSave && !confirm('Are you sure you want to reset to default? All custom cards will be removed.')) return;
      dashboardGrid.innerHTML = '';
      addCardToDashboard('weather_widget', {
        latitude: '40.7909',
        longitude: '-81.5218',
        location_label: 'Massillon, OH',
        units: 'imperial'
      }, 'weather_widget');
      customCardDefinitions.forEach(def => {
        addCustomCard(def);
      });
      if (doConfirmAndSave) {
        saveLayout();
        alert('Layout has been reset to default.');
      }
    }

    resetLayoutBtn.addEventListener('click', () => {
      if (confirm('Are you sure you want to reset your dashboard layout to default? This will remove any unsaved custom cards.')) {
        resetToDefaultLayout();
      }
    });

    // --- Create / Mount Card DOM ---
    function createCardDOMElement(template, config, cardIdToUse) {
      const newCard = document.createElement('div');
      const newCardId = cardIdToUse || `custom_${template.templateId}_${Date.now()}`;
      newCard.classList.add('dashboard-card');
      newCard.dataset.id = newCardId;
      newCard.dataset.templateId = template.templateId;
      newCard.dataset.cardType = template.type || 'full';

      // Store config in data-attributes
      if (template.configOptions) {
        template.configOptions.forEach(opt => {
          const key = `config${opt.name.charAt(0).toUpperCase() + opt.name.slice(1)}`;
          if (config[opt.name] !== undefined) {
            newCard.dataset[key] = config[opt.name];
          } else if (opt.defaultValue !== undefined) {
            newCard.dataset[key] = opt.defaultValue;
          }
        });
      }
      // For custom cards: title, icon, description, functionName, innerHTML
      if (template.templateId === 'custom_card') {
        if (config.title) newCard.dataset.customTitle = config.title;
        if (config.icon) newCard.dataset.customIcon = config.icon;
        if (config.description) newCard.dataset.customDescription = config.description;
        if (config.functionName) newCard.dataset.functionName = config.functionName;
        if (config.innerHTML) newCard.dataset.innerHTML = config.innerHTML;
      }

      // Header
      const header = document.createElement('div');
      header.classList.add('card-header');
      const iconEl = document.createElement('div');
      iconEl.classList.add('card-icon');
      if (template.templateId === 'custom_card') {
        iconEl.textContent = config.icon || template.icon;
      } else {
        iconEl.textContent = template.icon;
      }
      const titleEl = document.createElement('h4');
      titleEl.classList.add('card-title');
      if (template.templateId === 'custom_card') {
        titleEl.textContent = config.title || template.title;
      } else {
        titleEl.textContent = template.title;
      }
      const actionsDiv = document.createElement('div');
      actionsDiv.classList.add('card-header-actions');
      actionsDiv.innerHTML = `
        <button class="card-action-btn edit-btn" data-action="edit">‚úé</button>
        <button class="card-action-btn delete-btn" data-action="delete">‚úï</button>
      `;
      header.appendChild(iconEl);
      header.appendChild(titleEl);
      header.appendChild(actionsDiv);

      // Content
      const contentWrapper = document.createElement('div');
      contentWrapper.classList.add('card-content-inner');
      contentWrapper.innerHTML = template.contentGenerator(config);

      newCard.appendChild(header);
      newCard.appendChild(contentWrapper);

      // Attach onclick for custom functions (onMount will override)
      if (template.templateId === 'custom_card' && config.functionName) {
        newCard.setAttribute('onclick', `return false;`);
      }

      // Mount widget logic if provided
      if (template.onMount && typeof template.onMount === 'function') {
        template.onMount(newCard, config);
      }

      return newCard;
    }

    function addCardToDashboard(templateId, config, specificCardId = null) {
      const template = availableCardTemplates.find(t => t.templateId === templateId);
      if (!template) return;
      const cardDom = createCardDOMElement(template, config, specificCardId);
      dashboardGrid.appendChild(cardDom);
      makeCardInteractive(cardDom);
    }

    function addCustomCard(def) {
      const template = availableCardTemplates.find(t => t.templateId === 'custom_card');
      if (!template) return;
      const config = {
        title: def.title,
        icon: def.icon,
        description: def.description,
        functionName: def.functionName,
        innerHTML: def.innerHTML || '',
        type: 'full'
      };
      const cardDom = createCardDOMElement(template, config, def.id);
      dashboardGrid.appendChild(cardDom);
      makeCardInteractive(cardDom);

      // Special setup per card
      if (def.id === 'quick_notes') {
        const textarea = cardDom.querySelector('#quick_notes_textarea');
        const saveBtn = cardDom.querySelector('#quick_notes_save_btn');
        const saved = localStorage.getItem('quick_notes_content') || '';
        textarea.value = saved;
        saveBtn.addEventListener('click', () => {
          localStorage.setItem('quick_notes_content', textarea.value);
          alert('Note saved!');
        });
      }
      if (def.id === 'dictionary') {
        const inputEl = cardDom.querySelector('#dictionary_input');
        const lookupBtn = cardDom.querySelector('#dictionary_lookup_btn');
        const resultDiv = cardDom.querySelector('#dictionary_result');
        lookupBtn.addEventListener('click', async () => {
          const word = inputEl.value.trim();
          if (!word) return;
          resultDiv.textContent = 'Looking up...';
          try {
            const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
            if (!response.ok) throw new Error('Word not found');
            const data = await response.json();
            const meaning = data[0].meanings[0].definitions[0].definition;
            resultDiv.innerHTML = `<strong>${word}:</strong> ${meaning}`;
          } catch (err) {
            resultDiv.textContent = 'Definition not found.';
          }
        });
      }
      if (def.id === 'calculator') {
        const display = cardDom.querySelector('#calc_display');
        const buttons = cardDom.querySelectorAll('.calc-btn');
        buttons.forEach(btn => {
          btn.addEventListener('click', () => {
            const val = btn.textContent;
            if (val === '=') {
              try {
                display.value = eval(display.value) || '';
              } catch {
                display.value = 'Error';
              }
            } else {
              display.value += val;
            }
          });
        });
      }
      if (def.id === 'unit_converter') {
        const fromSel = cardDom.querySelector('#uc_from');
        const inputEl = cardDom.querySelector('#uc_input');
        const btn = cardDom.querySelector('#uc_convert_btn');
        const resultDiv = cardDom.querySelector('#uc_result');
        btn.addEventListener('click', () => {
          const val = parseFloat(inputEl.value);
          if (isNaN(val)) return;
          const mode = fromSel.value;
          let converted;
          if (mode === 'm_to_ft') {
            converted = (val * 3.28084).toFixed(2) + ' ft';
          } else if (mode === 'kg_to_lb') {
            converted = (val * 2.20462).toFixed(2) + ' lb';
          }
          resultDiv.textContent = converted;
        });
      }
      if (def.id === 'random_joke') {
        const btn = cardDom.querySelector('#random_joke_btn');
        btn.addEventListener('click', () => {
          const jokes = [
            "Why don‚Äôt scientists trust atoms? Because they make up everything!",
            "I told my computer I needed a break, and now it won‚Äôt stop sending me Kit Kat ads!",
            "Why did the scarecrow win an award? Because he was outstanding in his field!"
          ];
          const pick = jokes[Math.floor(Math.random() * jokes.length)];
          alert(pick);
        });
      }
      if (def.id === 'random_quote') {
        const btn = cardDom.querySelector('#random_quote_btn');
        btn.addEventListener('click', () => {
          const quotes = [
            "‚ÄúThe only way to do great work is to love what you do.‚Äù ‚Äì Steve Jobs",
            "‚ÄúLife is what happens when you‚Äôre busy making other plans.‚Äù ‚Äì John Lennon",
            "‚ÄúDo not watch the clock. Do what it does. Keep going.‚Äù ‚Äì Sam Levenson"
          ];
          const pick = quotes[Math.floor(Math.random() * quotes.length)];
          alert(pick);
        });
      }
    }

    function makeCardInteractive(cardElement) {
      cardElement.draggable = true;
      cardElement.addEventListener('dragstart', handleDragStart);
      cardElement.addEventListener('dragend', handleDragEnd);
      cardElement.addEventListener('touchstart', handleTouchStart, { passive: false });
      cardElement.addEventListener('touchmove', handleTouchMove, { passive: false });
      cardElement.addEventListener('touchend', handleTouchEnd);
      cardElement.addEventListener('touchcancel', handleTouchEnd);
      cardElement.addEventListener('click', handleCardClick);

      // Invoke onMount for dynamic parts
      const templateId = cardElement.dataset.templateId;
      const template = availableCardTemplates.find(t => t.templateId === templateId);
      if (template && template.onMount && typeof template.onMount === 'function') {
        const config = {};
        if (template.configOptions) {
          template.configOptions.forEach(opt => {
            const datasetKey = `config${opt.name.charAt(0).toUpperCase() + opt.name.slice(1)}`;
            if (cardElement.dataset[datasetKey] !== undefined) {
              config[opt.name] = cardElement.dataset[datasetKey];
            } else if (opt.defaultValue !== undefined) {
              config[opt.name] = opt.defaultValue;
            }
          });
        }
        if (templateId === 'custom_card') {
          config.title = cardElement.dataset.customTitle;
          config.icon = cardElement.dataset.customIcon;
          config.description = cardElement.dataset.customDescription;
          config.functionName = cardElement.dataset.functionName;
          config.innerHTML = cardElement.dataset.innerHTML;
        }
        template.onMount(cardElement, config);
      }

      // Delete and Edit action buttons
      const editBtn = cardElement.querySelector('.edit-btn');
      const delBtn = cardElement.querySelector('.delete-btn');
      if (editBtn) {
        editBtn.addEventListener('click', e => {
          e.stopPropagation();
          openEditModalForCard(cardElement);
        });
      }
      if (delBtn) {
        delBtn.addEventListener('click', e => {
          e.stopPropagation();
          if (confirm('Remove this card?')) {
            cardElement.remove();
            saveLayout();
          }
        });
      }
    }

    function handleCardClick(e) {
      const card = e.currentTarget;
      if (!editMode && card.dataset.page && !draggedElement) {
        if (
          e.target.tagName === 'BUTTON' ||
          e.target.closest('button') ||
          e.target.tagName === 'TEXTAREA' ||
          e.target.tagName === 'INPUT' ||
          e.target.tagName === 'A' ||
          e.target.closest('a') ||
          e.target.closest('iframe')
        ) {
          return;
        }
        window.location.href = card.dataset.page;
      }
    }

    function ensureDragPlaceholder() {
      if (placeholderElement) return placeholderElement;
      placeholderElement = document.createElement('div');
      placeholderElement.classList.add('dashboard-card-placeholder');
      placeholderElement.textContent = 'Drop Here';
      return placeholderElement;
    }

    function removeDragPlaceholder() {
      if (placeholderElement && placeholderElement.parentNode) {
        placeholderElement.parentNode.removeChild(placeholderElement);
      }
      placeholderElement = null;
    }

    function getDragAfterElement(container, y) {
      const draggableElements = [...container.querySelectorAll('.dashboard-card:not(.dragging)')];
      return draggableElements.reduce(
        (closest, child) => {
          const box = child.getBoundingClientRect();
          const offset = y - (box.top + box.height / 2);
          if (offset < 0 && offset > closest.offset) {
            return { offset, element: child };
          } else {
            return closest;
          }
        },
        { offset: Number.NEGATIVE_INFINITY }
      ).element;
    }

    function handleDragStart(e) {
      if (!editMode) {
        e.preventDefault();
        return;
      }
      draggedElement = e.target.closest('.dashboard-card');
      if (!draggedElement) {
        e.preventDefault();
        return;
      }
      draggedElement.classList.add('dragging');
      dashboardGrid.classList.add('dragging-active');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', draggedElement.dataset.id);
      ensureDragPlaceholder();
      setTimeout(() => {
        if (draggedElement) draggedElement.style.opacity = '0.5';
      }, 0);
    }

    function handleDragEnd(e) {
      if (draggedElement) {
        draggedElement.classList.remove('dragging');
        draggedElement.style.opacity = '1';
      }
      removeDragPlaceholder();
      dashboardGrid.classList.remove('dragging-active');
      draggedElement = null;
    }

    function handleDragOver(e) {
      if (!editMode || !draggedElement) return;
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      const ph = ensureDragPlaceholder();
      const afterElement = getDragAfterElement(dashboardGrid, e.clientY);
      if (afterElement == null) {
        if (dashboardGrid.lastChild !== ph) dashboardGrid.appendChild(ph);
      } else {
        if (afterElement !== ph) dashboardGrid.insertBefore(ph, afterElement);
      }
    }

    function handleDrop(e) {
      e.preventDefault();
      if (!editMode || !draggedElement || !placeholderElement || !placeholderElement.parentNode) {
        removeDragPlaceholder();
        return;
      }
      placeholderElement.parentNode.replaceChild(draggedElement, placeholderElement);
      if (draggedElement) {
        draggedElement.classList.remove('dragging');
        draggedElement.style.opacity = '1';
      }
      placeholderElement = null;
    }

    let initialTouchX, initialTouchY, offsetX, offsetY, currentCardRect;
    function handleTouchStart(e) {
      if (!editMode) return;
      draggedElement = e.target.closest('.dashboard-card');
      if (!draggedElement) return;
      const touch = e.touches[0];
      initialTouchX = touch.clientX;
      initialTouchY = touch.clientY;
      currentCardRect = draggedElement.getBoundingClientRect();
      offsetX = initialTouchX - currentCardRect.left;
      offsetY = initialTouchY - currentCardRect.top;

      draggedElement.classList.add('dragging');
      dashboardGrid.classList.add('dragging-active');

      ensureDragPlaceholder();
      if (draggedElement.nextSibling) {
        dashboardGrid.insertBefore(placeholderElement, draggedElement.nextSibling);
      } else {
        dashboardGrid.appendChild(placeholderElement);
      }

      Object.assign(draggedElement.style, {
        position: 'fixed',
        left: `${currentCardRect.left}px`,
        top: `${currentCardRect.top}px`,
        width: `${currentCardRect.width}px`,
        height: `${currentCardRect.height}px`,
        zIndex: '1001',
        opacity: '0.8',
        pointerEvents: 'none'
      });
      if (e.cancelable) e.preventDefault();
    }

    function handleTouchMove(e) {
      if (!editMode || !draggedElement) return;
      if (e.cancelable) e.preventDefault();
      const touch = e.touches[0];
      draggedElement.style.left = `${touch.clientX - offsetX}px`;
      draggedElement.style.top = `${touch.clientY - offsetY}px`;
      const ph = placeholderElement;
      const afterElement = getDragAfterElement(dashboardGrid, touch.clientY);
      if (afterElement == null) {
        if (dashboardGrid.lastChild !== ph && ph) dashboardGrid.appendChild(ph);
      } else {
        if (afterElement !== ph && ph) dashboardGrid.insertBefore(ph, afterElement);
      }
    }

    function handleTouchEnd(e) {
      if (!editMode || !draggedElement) {
        removeDragPlaceholder();
        if (draggedElement) {
          Object.assign(draggedElement.style, {
            position: '',
            left: '',
            top: '',
            width: '',
            height: '',
            zIndex: '',
            opacity: '',
            pointerEvents: ''
          });
          draggedElement.classList.remove('dragging');
          draggedElement = null;
        }
        return;
      }
      if (placeholderElement && placeholderElement.parentNode) {
        placeholderElement.parentNode.replaceChild(draggedElement, placeholderElement);
      }
      removeDragPlaceholder();
      Object.assign(draggedElement.style, {
        position: '',
        left: '',
        top: '',
        width: '',
        height: '',
        zIndex: '',
        opacity: '',
        pointerEvents: ''
      });
      draggedElement.classList.remove('dragging');
      dashboardGrid.classList.remove('dragging-active');
      draggedElement = null;
    }

    // Attach dragover & drop to grid
    dashboardGrid.addEventListener('dragover', handleDragOver);
    dashboardGrid.addEventListener('drop', handleDrop);

    // Edit Layout Toggle
    editBtn.addEventListener('click', () => {
      editMode = !editMode;
      dashboardGrid.classList.toggle('editing', editMode);
      dashboardGrid.classList.toggle('edit-active', editMode);
      editBtn.textContent = editMode ? 'Save Layout' : 'Edit Layout';
      editBtn.classList.toggle('secondary', !editMode);

      const cardHeaderActions = dashboardGrid.querySelectorAll('.card-header-actions');
      cardHeaderActions.forEach(actions => actions.style.display = editMode ? 'flex' : 'none');

      if (editMode) {
        // show any editing hints if needed
      } else {
        // hide editing hints
        removeDragPlaceholder();
        saveLayout();
      }
    });

    // --- Add/Edit Card Modal Logic (shell) ---
    let currentCardToConfigure = null;
    function openAddCardModal() {
      modalTitle.textContent = 'Add New Card';
      modalCardSelectionView.innerHTML = '';
      modalCardConfigureView.style.display = 'none';
      // Populate selection view with customCardDefinitions
      customCardDefinitions.forEach(def => {
        const mini = document.createElement('div');
        mini.classList.add('mini-card');
        mini.dataset.templateId = 'custom_card';
        mini.dataset.cardId = def.id;
        mini.innerHTML = `
          <span class="icon">${def.icon}</span>
          <h4>${def.title}</h4>
          <p style="font-size:0.75em; color:#555;">${def.description}</p>
        `;
        mini.addEventListener('click', () => {
          openConfigureModal(def);
        });
        modalCardSelectionView.appendChild(mini);
      });
      modalCardSelectionView.style.display = 'grid';
      addCardModal.style.display = 'block';
    }
    function openConfigureModal(def) {
      currentCardToConfigure = def;
      modalCardSelectionView.style.display = 'none';
      modalCardConfigureView.style.display = 'block';
      configureCardTitle.textContent = `Add ‚Äú${def.title}‚Äù to Dashboard`;
      configureCardOptionsContainer.innerHTML = `
        <div class="config-option">
          <label for="config_cardTitle">Title</label>
          <input type="text" id="config_cardTitle" value="${def.title}" />
        </div>
        <div class="config-option">
          <label for="config_cardIcon">Icon</label>
          <input type="text" id="config_cardIcon" value="${def.icon}" />
        </div>
        <div class="config-option">
          <label for="config_cardSize">Size</label>
          <select id="config_cardSize">
            <option value="full">Normal</option>
            <option value="large">Large</option>
          </select>
        </div>
        <div class="config-option">
          <label for="config_cardDescription">Description</label>
          <textarea id="config_cardDescription">${def.description}</textarea>
        </div>
      `;
    }
    closeModalBtn.addEventListener('click', () => addCardModal.style.display = 'none');
    configureCardBackBtn.addEventListener('click', () => {
      modalCardConfigureView.style.display = 'none';
      modalCardSelectionView.style.display = 'grid';
    });
    configureCardAddBtn.addEventListener('click', () => {
      if (!currentCardToConfigure) return;
      const title = document.getElementById('config_cardTitle').value.trim();
      const icon = document.getElementById('config_cardIcon').value.trim();
      const size = document.getElementById('config_cardSize').value;
      const desc = document.getElementById('config_cardDescription').value.trim();
      const def = currentCardToConfigure;
      addCustomCard({
        id: `${def.id}_${Date.now()}`,
        title,
        icon,
        description: desc,
        functionName: def.functionName,
        innerHTML: def.innerHTML || ''
      });
      addCardModal.style.display = 'none';
      saveLayout();
    });
    addCardBtnElement.addEventListener('click', openAddCardModal);

    // --- Save Layout to Firestore ---
    async function saveLayout() {
      const userDocRef = dbRef();
      if (!userDocRef) return;
      const layoutArray = [];
      document.querySelectorAll('.dashboard-card').forEach(card => {
        layoutArray.push({
          id: card.dataset.id,
          templateId: card.dataset.templateId,
          config: (() => {
            const template = availableCardTemplates.find(t => t.templateId === card.dataset.templateId);
            if (!template) return {};
            if (template.templateId === 'custom_card') {
              return {
                title: card.dataset.customTitle,
                icon: card.dataset.customIcon,
                description: card.dataset.customDescription,
                functionName: card.dataset.functionName,
                innerHTML: card.dataset.innerHTML,
                type: card.dataset.cardType
              };
            }
            if (!template.configOptions) return {};
            const cfg = {};
            template.configOptions.forEach(opt => {
              const key = `config${opt.name.charAt(0).toUpperCase() + opt.name.slice(1)}`;
              if (card.dataset[key] !== undefined) cfg[opt.name] = card.dataset[key];
            });
            return cfg;
          })()
        });
      });
      try {
        await userDocRef.set({ dashboardLayout: layoutArray }, { merge: true });
        console.log('Layout saved.');
      } catch (err) {
        console.error('Could not save layout:', err);
      }
    }

    // --- Tutorial Logic ---
    function startTutorial() {
      tutorialStep = 0;
      showTutorialStep();
      tutorialOverlay.style.display = 'block';
      tutorialCloseBtn.style.display = 'block';
    }
    function endTutorial() {
      tutorialOverlay.style.display = 'none';
      tutorialCloseBtn.style.display = 'none';
      tutorialTooltip.style.display = 'none';
      // Remove highlight from all
      document.querySelectorAll('.tutorial-highlight').forEach(el => el.classList.remove('tutorial-highlight'));
    }
    function showTutorialStep() {
      // Remove previous highlight
      document.querySelectorAll('.tutorial-highlight').forEach(el => el.classList.remove('tutorial-highlight'));
      if (tutorialStep >= tutorialSteps.length) {
        endTutorial();
        return;
      }
      const step = tutorialSteps[tutorialStep];
      const el = step.element;
      if (!el) {
        tutorialStep++;
        showTutorialStep();
        return;
      }
      el.classList.add('tutorial-highlight');
      // Position tooltip near element
      const rect = el.getBoundingClientRect();
      tutorialTooltip.textContent = step.text;
      tutorialTooltip.style.display = 'block';
      // Default: show below
      let top = rect.bottom + 10;
      let left = rect.left;
      if (top + tutorialTooltip.offsetHeight > window.innerHeight) {
        // show above
        top = rect.top - tutorialTooltip.offsetHeight - 10;
      }
      if (left + tutorialTooltip.offsetWidth > window.innerWidth) {
        left = window.innerWidth - tutorialTooltip.offsetWidth - 20;
      }
      tutorialTooltip.style.top = `${top}px`;
      tutorialTooltip.style.left = `${left}px`;
    }
    tutorialBtn.addEventListener('click', () => {
      startTutorial();
    });
    tutorialCloseBtn.addEventListener('click', () => {
      endTutorial();
    });
    // Advance tutorial on overlay click
    tutorialOverlay.addEventListener('click', () => {
      tutorialStep++;
      showTutorialStep();
    });

    // --- Separate Functions for Each Custom Card ---

    // 1. Display Username (no action)
    function userInfoFunction(cardElement) {
      // no-op
    }

    // 2. Quick Notes
    function quickNotesFunction(cardElement) {
      const ta = cardElement.querySelector('#quick_notes_textarea');
      if (ta) ta.focus();
    }

    // 3. Dictionary Lookup
    function dictionaryFunction(cardElement) {
      const inp = cardElement.querySelector('#dictionary_input');
      if (inp) inp.focus();
    }

    // 4. Calculator
    function calculatorFunction(cardElement) {
      const disp = cardElement.querySelector('#calc_display');
      if (disp) disp.focus();
    }

    // 5. Unit Converter
    function unitConverterFunction(cardElement) {
      const sel = cardElement.querySelector('#uc_from');
      if (sel) sel.focus();
    }

    // 6. Random Joke
    function randomJokeFunction(cardElement) {
      const btn = cardElement.querySelector('#random_joke_btn');
      if (btn) btn.click();
    }

    // 7. Random Quote
    function randomQuoteFunction(cardElement) {
      const btn = cardElement.querySelector('#random_quote_btn');
      if (btn) btn.click();
    }
  </script>
</body>
</html>
