<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>4SP - DASHBOARD</title>
    <link rel="icon" type="image/png" href="../images/favicon.png">
    <link rel="apple-touch-icon" href="../images/favicon.png">
    <link rel="stylesheet" href="../css/style.css" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root {
            --v4-card-bg: #fff;
            --v4-input-bg: #f8f9fa;
            --v4-border-light: #ddd;
            --v4-border-softer: #eee;
            --v4-input-border: #ccc;
            --v4-text-primary: #333;
            --v4-text-secondary: #555;
            --v4-purple-accent: #6720bd;
            --v4-purple-accent-darker: #5a1aa8;
            --v4-purple-gradient: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            --v4-font-primary: 'PrimaryFont', sans-serif;
            --v4-font-secondary: 'SecondaryFont', sans-serif;
            --v4-bg-gradient: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
        }

        body.dashboard-page { display: flex; flex-direction: column; min-height: 100vh; margin: 0; font-family: var(--v4-font-primary); background-color: var(--v4-bg-gradient); }
        .dashboard-container { display: flex; flex: 1; overflow: hidden; }

        /* --- Sidebar (Standard with will-change) --- */
        .sidebar { width: 200px; background: linear-gradient(180deg, #333 0%, #2a2a2a 100%); color: #fff; padding: 20px 10px; display: flex; flex-direction: column; border-right: 1px solid #444; transition: width 0.5s ease-in-out; position: relative; box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 1001; will-change: width; flex-shrink: 0; }
        .sidebar.collapsed { width: 85px; }
        #toggleSidebar { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: none; border: none; color: #fff; font-size: 1.2em; cursor: pointer; padding: 4px; transition: transform 0.5s ease-in-out; }
        .sidebar.collapsed #toggleSidebar { transform: translateX(-50%) rotate(180deg); }
        .user-info { text-align: center; margin: 60px 0 30px; border-bottom: 1px solid #555; padding-bottom: 20px; overflow: hidden; }
        .marquee-container { overflow: hidden; white-space: nowrap; position: relative; width: 100%; height: 1.8em; line-height: 1.8em; }
        .marquee-content { display: inline-block; transform: translateX(0px); animation: none; line-height: inherit; white-space: nowrap; }
        .marquee-active { padding-left: 100%; animation: scroll-dashboard-marquee 12s linear infinite; overflow: visible; text-overflow: clip; max-width: none; }
        @keyframes scroll-dashboard-marquee { 0% { transform: translateX(0px); } 100% { transform: translateX(-100%); } }
        .user-info .username { font-family: var(--v4-font-primary); font-size: 1.3em; margin-bottom: 8px; line-height: 0.2em; font-weight: bold; display: block; }
        .user-info .email { font-family: var(--v4-font-secondary); font-size: 0.9em; color: #bbb; display: block; }
        .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
        .sidebar nav li { margin-bottom: 10px; }
        .sidebar nav a { display: flex; align-items: center; padding: 12px 15px; color: #fff; text-decoration: none; border-radius: 8px; transition: all 0.3s ease; font-family: var(--v4-font-primary); text-transform: uppercase; position: relative; overflow: hidden; font-size: 1em; }
        .sidebar nav a::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent); transition: left 0.5s; }
        .sidebar nav a:hover::before { left: 100%; }
        .sidebar nav a.active, .sidebar nav a:hover { background: var(--v4-purple-gradient); transform: translateX(5px); color: #fff; }
        .sidebar nav a .icon { font-size: 1.2em; width: 24px; text-align: center; }
        .sidebar nav a .label { margin-left: 10px; white-space: nowrap; }
        .sidebar.collapsed nav a { justify-content: center; padding: 10px 0; }
        .sidebar.collapsed nav a .label { display: none; }
        .sidebar.collapsed nav a .icon { margin-left: 0; }

        /* --- Header (Standard) --- */
        .main-header { background-color: #ffffff; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 0 20px; position: sticky; top: 0; z-index: 1002; }
        .main-header .container { display: flex; justify-content: space-between; align-items: center; height: 60px; max-width: 1200px; margin: 0 auto; }
        .main-header .logo img { height: 60px; width: auto; display: block; margin-right: 25px; }
        .main-header .auth-buttons { display: flex; align-items: center; }
        .main-header .btn { padding: 8px 18px; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; text-transform: uppercase; transition: all 0.3s ease; font-family: 'PrimaryFont', sans-serif; font-size: 0.9em; margin-left: 10px; }
        .main-header .btn-login { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); color: white; }
        .main-header .btn-login:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(103, 32, 189, 0.4); }

        /* --- Main Content (Standard with will-change) --- */
        .main-content { flex: 1; padding: 30px; background-color: var(--v4-bg-gradient); overflow-y: auto; display: flex; flex-direction: column; will-change: width, margin-left; }
        .main-content.fade-in { animation: fadeInDashboardPage 0.6s ease-out; }
        @keyframes fadeInDashboardPage { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .sidebar.slide-in { animation: slideInDashboardSidebar 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes slideInDashboardSidebar { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* --- Dashboard Header & Controls (Standard) --- */
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; background: var(--v4-card-bg); padding: 20px 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid rgba(103, 32, 189, 0.1); }
        .dashboard-title { margin: 0; font-size: 2.2em; font-weight: bold; background: var(--v4-purple-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-family: var(--v4-font-primary); }
        .dashboard-controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; } /* Added flex-wrap */
        .control-btn { background: var(--v4-purple-gradient); border: none; color: #fff; padding: 10px 18px; border-radius: 12px; font-family: var(--v4-font-primary); cursor: pointer; transition: all 0.3s ease; font-size: 0.85em; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; position: relative; overflow: hidden; white-space: nowrap; }
        .control-btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: left 0.5s; }
        .control-btn:hover::before { left: 100%; }
        .control-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(103, 32, 189, 0.3); }
        .control-btn.secondary { background: linear-gradient(135deg, #555 0%, #777 100%); }
        .control-btn.secondary:hover { box-shadow: 0 6px 20px rgba(85, 85, 85, 0.3); }
        .control-btn.danger { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }
        .control-btn.danger:hover { box-shadow: 0 6px 20px rgba(220,53,69,0.3); }


        /* --- Dashboard Grid & Cards (Updated for Edit Mode) --- */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; position: relative; padding: 10px; /* Padding for placeholder visibility */ }
        .dashboard-grid.editing { border: 2px dashed var(--v4-purple-accent); background-image: linear-gradient(45deg, rgba(0,0,0,0.03) 25%, transparent 25%, transparent 75%, rgba(0,0,0,0.03) 75%, rgba(0,0,0,0.03)), linear-gradient(45deg, rgba(0,0,0,0.03) 25%, transparent 25%, transparent 75%, rgba(0,0,0,0.03) 75%, rgba(0,0,0,0.03)); background-size: 30px 30px; background-position: 0 0, 15px 15px; border-radius: 10px; }
        
        .dashboard-card { background: var(--v4-card-bg); border-radius: 15px; padding: 20px; box-shadow: 0 5px 25px rgba(0,0,0,0.07); border: 1px solid var(--v4-border-softer); cursor: default; transition: all 0.3s ease; position: relative; overflow: hidden; display: flex; flex-direction: column; min-height: 180px; z-index: 2; }
        .dashboard-grid.editing .dashboard-card { cursor: grab; border-style: dashed; border-color: var(--v4-purple-accent); user-select: none; }
        .dashboard-card.dragging { opacity: 0.7; transform: scale(1.03) rotate(2deg); box-shadow: 0 15px 40px rgba(0,0,0,0.2); z-index: 1000; }
        .dashboard-card.drop-placeholder { background-color: rgba(103, 32, 189, 0.1); border: 2px dashed var(--v4-purple-accent); height: 180px; /* Match min-height */ }

        .card-header { display: flex; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--v4-border-softer); }
        .card-icon { font-size: 1.8em; margin-right: 12px; color: var(--v4-purple-accent); width: 30px; text-align: center; }
        .card-icon.material-icons { line-height: 1; } /* Align Material Icons better */
        .card-title { font-size: 1.25em; font-weight: 600; margin: 0; color: var(--v4-text-primary); flex-grow: 1;}
        .card-description { color: var(--v4-text-secondary); font-size: 0.9em; line-height: 1.5; margin-bottom: 15px; flex-grow: 1; }
        .card-content { flex-grow: 1; } /* For widgets to place their specific content */
        .card-action-button { display: block; width: calc(100% - 10px); margin: 10px 5px 0 5px; padding: 8px 12px; background: var(--v4-purple-gradient); color: white; border: none; border-radius: 8px; font-family: var(--v4-font-primary); font-size: 0.85em; text-transform: uppercase; cursor: pointer; transition: background 0.3s ease; text-align: center; text-decoration: none; }
        .card-action-button:hover { background: linear-gradient(135deg, var(--v4-purple-accent-darker) 0%, #7923c8 100%); }

        /* Widget Specific Styles */
        .widget-user-info p, .widget-local-info p { margin: 5px 0; font-size: 0.95em; }
        .widget-user-info strong, .widget-local-info strong { color: var(--v4-text-primary); }
        .widget-tab-cloak .form-group { margin-bottom: 10px; }
        .widget-tab-cloak label { display: block; margin-bottom: 4px; font-size: 0.85em; font-weight: 500; color: var(--v4-text-secondary); }
        .widget-tab-cloak input[type="text"], .widget-tab-cloak input[type="url"] { width: calc(100% - 20px); padding: 8px 10px; border: 1px solid var(--v4-input-border); border-radius: 6px; font-family: var(--v4-font-secondary); font-size: 0.9em; background-color: var(--v4-input-bg); }
        .widget-tab-cloak input:focus { border-color: var(--v4-purple-accent); box-shadow: 0 0 0 2px rgba(103, 32, 189, 0.1); outline: none; }
        .widget-tab-cloak small { font-size: 0.75em; color: #777; display: block; margin-top: 3px;}
        #batteryPercentage { font-weight: bold; }
        #batteryCharging { font-style: italic; }

        /* Notification & Modal Styles */
        .notification-bar { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background-color: var(--v4-purple-accent); color: white; padding: 12px 25px; border-radius: 0 0 8px 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 1005; transition: top 0.5s ease-in-out; font-size: 0.9em; text-align: center;}
        .notification-bar.visible { top: 0; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1010; justify-content: center; align-items: center; }
        .modal-overlay.visible { display: flex; }
        .modal-content { background: var(--v4-card-bg); padding: 25px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); max-width: 500px; width: 90%; text-align: center; }
        .modal-content h3 { margin-top: 0; color: var(--v4-purple-accent); }
        .modal-content p { font-size: 0.95em; margin-bottom: 20px; }
        .modal-content .control-btn { margin-top: 10px; }

        .hidden { display: none !important; }
    </style>
</head>
<body class="dashboard-page">
    <header class="main-header">
        <div class="container">
            <div class="logo"><a href="../index.html"><img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer;"></a></div>
            <div class="auth-buttons">
                <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button>
                <button id="logoutBtn" class="btn btn-login">LOG OUT</button>
            </div>
        </div>
    </header>

    <div class="dashboard-container">
        <aside class="sidebar" id="sidebar">
            <button id="toggleSidebar">‚ò∞</button>
            <div class="user-info">
                <div class="marquee-container"><span id="userName" class="marquee-content username">Loading‚Ä¶</span></div>
                <div class="marquee-container"><span id="userEmail" class="marquee-content email">Loading‚Ä¶</span></div>
            </div>
            <nav>
                <ul>
                    <li><a href="dashboard.html" class="active"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
                    <li><a href="proxies.html"><span class="icon">üõ°Ô∏è</span><span class="label">Proxies</span></a></li>
                    <li><a href="soundboard.html"><span class="icon">üéµ</span><span class="label">Soundboard</span></a></li>
                    <li><a href="games.html"><span class="icon">üéÆ</span><span class="label">Games</span></a></li>
                    <li><a href="others.html"><span class="icon">‚ú®</span><span class="label">Others</span></a></li>
                    <li><a href="settings.html"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a></li>
                    <li><a href="#" id="signOutLink"><span class="icon">üîí</span><span class="label">LOG OUT</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
            <div class="dashboard-header">
                <h2 class="dashboard-title">Dashboard</h2>
                <div class="dashboard-controls">
                    <button id="addWidgetBtn" class="control-btn secondary">+ Add Widget</button>
                    <button id="editLayoutBtn" class="control-btn">Edit Layout</button>
                </div>
            </div>

            <div id="editModeNotificationBar" class="notification-bar">
                ‚ú® **Edit Mode Active!** Drag cards to rearrange. Click "Save Layout" to keep changes.
            </div>
            
            <div id="addWidgetModal" class="modal-overlay">
                <div class="modal-content">
                    <h3>Add New Widget</h3>
                    <select id="widgetSelect" class="widget-tab-cloak input[type='text']" style="width: 100%; margin-bottom: 15px; padding: 10px; font-size: 1em;">
                        <option value="">-- Select a Widget --</option>
                        <option value="userInfo">User Info</option>
                        <option value="shortcuts">Shortcuts (Tab Cloak)</option>
                        <option value="localInfo">Local Device Info</option>
                        <option value="quickNavProxies">Quick Nav: Proxies</option>
                        <option value="quickNavSoundboard">Quick Nav: Soundboard</option>
                        <option value="quickNavGames">Quick Nav: Games Hub</option>
                        <option value="quickNavOthers">Quick Nav: Others</option>
                        <option value="quickNavSettings">Quick Nav: Settings</option>
                    </select>
                    <button id="confirmAddWidgetBtn" class="control-btn">Add Widget</button>
                    <button id="cancelAddWidgetBtn" class="control-btn secondary" style="margin-left: 10px;">Cancel</button>
                </div>
            </div>


            <div class="dashboard-grid" id="dashboardGrid">
                </div>
             <p style="text-align: center; color: #666; margin-top: 30px; font-style: italic; font-size: 0.9em;">
                Tip: Use Ctrl/Cmd + E to quickly toggle Edit Mode. Press Esc to exit Edit Mode.
            </p>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <script>
    // --- Core 4SP Firebase, Header, and Sidebar Logic (Standardized) ---
    const db = firebase.firestore(); // Ensure db is defined globally if used by dbRef
    const dbRef = () => {
        const currentUser = firebase.auth().currentUser;
        return currentUser ? db.collection('users').doc(currentUser.uid) : null;
    };

    const marqueeEls = document.querySelectorAll('.marquee-content');
    const sidebarEl = document.getElementById('sidebar');
    const toggleSidebarBtn = document.getElementById('toggleSidebar');
    const userNameEl = document.getElementById('userName');
    const userEmailEl = document.getElementById('userEmail');
    const headerLogoutBtn = document.getElementById('logoutBtn');
    const sidebarSignOutLink = document.getElementById('signOutLink');
    const mainContentEl = document.querySelector('.main-content');

    function handleLogout() {
        firebase.auth().signOut().then(() => {
            window.location.href = '../login.html';
        }).catch(error => {
            console.error('Logout error:', error);
            showNotification(`Logout failed: ${error.message}`, 'error', true); // true for persistent error
        });
    }

    if (headerLogoutBtn) headerLogoutBtn.addEventListener('click', handleLogout);
    if (sidebarSignOutLink) {
        sidebarSignOutLink.addEventListener('click', (e) => {
            e.preventDefault(); handleLogout();
        });
    }

    firebase.auth().onAuthStateChanged(async user => {
        const body = document.body;
        if (user) {
            if (userEmailEl) userEmailEl.textContent = user.email;
            if (userNameEl) {
                const userDocRef = dbRef();
                if (userDocRef) {
                    try {
                        const doc = await userDocRef.get();
                        userNameEl.textContent = (doc.exists && doc.data().username) ? doc.data().username : (user.displayName || 'User');
                    } catch (error) {
                        userNameEl.textContent = user.displayName || 'User'; console.error("Error fetching username:", error);
                    }
                } else { userNameEl.textContent = user.displayName || 'User'; }
            }
            if (!body.classList.contains('animations-applied')) {
                if(sidebarEl) sidebarEl.classList.add('slide-in');
                if(mainContentEl) mainContentEl.classList.add('fade-in');
                body.classList.add('animations-applied');
            }
            loadDashboardLayout(); // Load layout after user is confirmed
        } else { window.location.href = '../login.html'; }
        updateMarquees();
    });

    if (toggleSidebarBtn && sidebarEl) {
        toggleSidebarBtn.addEventListener('click', () => {
            sidebarEl.classList.toggle('collapsed');
            setTimeout(updateMarquees, 500);
        });
    }

    function updateMarquees() {
        const elementsToUpdate = (userNameEl && userEmailEl) ? [userNameEl, userEmailEl].filter(Boolean) : marqueeEls;
        elementsToUpdate.forEach(el => {
            if (!el || !el.parentElement || !sidebarEl) return;
            const parentContainer = el.parentElement;
            if (parentContainer.offsetWidth === 0 && !sidebarEl.classList.contains('collapsed')) {
                setTimeout(updateMarquees, 100); return;
            }
            el.classList.remove('marquee-active');
            el.style.transform = 'translateX(0px)';
            void el.offsetWidth; 
            const contentWidth = el.scrollWidth;
            const containerWidth = parentContainer.clientWidth;
            const shouldScroll = contentWidth > containerWidth;
            if (shouldScroll) { el.classList.add('marquee-active'); }
        });
    }
    window.addEventListener('resize', () => setTimeout(updateMarquees, 300));
    document.addEventListener('DOMContentLoaded', () => {
        if (firebase.auth().currentUser && !document.body.classList.contains('animations-applied')) {
            if(sidebarEl) sidebarEl.classList.add('slide-in');
            if(mainContentEl) mainContentEl.classList.add('fade-in');
            document.body.classList.add('animations-applied');
        }
        setTimeout(updateMarquees, 300);
        initializeDashboard(); // Initialize new dashboard features
    });

    let notificationTimeout;
    function showNotification(message, type = 'info', duration = 3000, persistent = false) {
        const bar = document.getElementById('editModeNotificationBar');
        if (!bar) return; // Should not happen if HTML is correct

        clearTimeout(notificationTimeout); // Clear existing timeout
        bar.textContent = message;
        bar.className = 'notification-bar'; // Reset classes
        bar.classList.add(type === 'error' ? 'danger' : (type === 'success' ? 'success-info' : 'info-type')); // Add type class if you have specific styles
        
        // Make it visible
        bar.classList.add('visible');

        if (!persistent) {
            notificationTimeout = setTimeout(() => {
                bar.classList.remove('visible');
            }, duration);
        }
    }
    // --- End of Core Logic ---

    // --- New Dashboard Functionality ---
    const dashboardGrid = document.getElementById('dashboardGrid');
    const editLayoutBtn = document.getElementById('editLayoutBtn');
    const addWidgetBtn = document.getElementById('addWidgetBtn');
    const addWidgetModal = document.getElementById('addWidgetModal');
    const widgetSelect = document.getElementById('widgetSelect');
    const confirmAddWidgetBtn = document.getElementById('confirmAddWidgetBtn');
    const cancelAddWidgetBtn = document.getElementById('cancelAddWidgetBtn');
    const editModeNotificationBar = document.getElementById('editModeNotificationBar');


    let isEditMode = false;
    let draggedCard = null;
    let firstEdit = !localStorage.getItem('hasEditedDashboardBefore');

    const WIDGET_CONFIG = {
        'userInfo': { title: 'User Information', icon: 'account_circle', contentGenerator: generateUserInfoContent, default: true },
        'shortcuts': { title: 'Shortcuts & Tab Cloak', icon: 'construction', contentGenerator: generateShortcutsContent, default: true },
        'localInfo': { title: 'Device Info', icon: 'battery_full', contentGenerator: generateLocalInfoContent, default: true },
        'quickNavProxies': { title: 'Proxies', icon: 'üõ°Ô∏è', link: 'proxies.html', description: 'Access proxy servers.', default: true},
        'quickNavSoundboard': { title: 'Soundboard', icon: 'üéµ', link: 'soundboard.html', description: 'Play various sounds.', default: true},
        'quickNavGames': { title: 'Games Hub', icon: 'üéÆ', link: 'games.html', description: 'Explore game categories.', default: true},
        'quickNavOthers': { title: 'Others', icon: '‚ú®', link: 'others.html', description: 'Miscellaneous tools.', default: false},
        'quickNavSettings': { title: 'Settings', icon: '‚öôÔ∏è', link: 'settings.html', description: 'Manage your account.', default: false}
    };

    function initializeDashboard() {
        editLayoutBtn.addEventListener('click', toggleEditMode);
        addWidgetBtn.addEventListener('click', openAddWidgetModal);
        cancelAddWidgetBtn.addEventListener('click', closeAddWidgetModal);
        confirmAddWidgetBtn.addEventListener('click', addSelectedWidget);

        dashboardGrid.addEventListener('dragover', handleDragOver);
        dashboardGrid.addEventListener('drop', handleDrop);
        // No resetLayoutBtn in HTML, can be added if needed
    }

    function toggleEditMode() {
        isEditMode = !isEditMode;
        dashboardGrid.classList.toggle('editing', isEditMode);
        editLayoutBtn.textContent = isEditMode ? 'Save Layout' : 'Edit Layout';
        editLayoutBtn.classList.toggle('danger', isEditMode); // Use danger style for save
        addWidgetBtn.style.display = isEditMode ? 'inline-flex' : 'none'; // Show add widget btn only in edit mode


        if (isEditMode) {
            if (firstEdit) {
                showNotification('‚ú® Edit Mode: Drag cards to reorder! Click "Add Widget" for more. Click "Save Layout" when done.', 'info', 7000);
                localStorage.setItem('hasEditedDashboardBefore', 'true');
                firstEdit = false;
            } else {
                 showNotification('Edit Mode Active. Drag to reorder or add widgets.', 'info', 3000);
            }
            makeCardsDraggable(true);
        } else {
            showNotification('Layout saved!', 'success', 2000);
            makeCardsDraggable(false);
            saveDashboardLayout();
        }
    }
    
    function makeCardsDraggable(draggable) {
        const cards = dashboardGrid.querySelectorAll('.dashboard-card');
        cards.forEach(card => {
            card.draggable = draggable;
            if (draggable) {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
            } else {
                card.removeEventListener('dragstart', handleDragStart);
                card.removeEventListener('dragend', handleDragEnd);
            }
        });
    }

    function handleDragStart(e) {
        if (!isEditMode) return;
        draggedCard = e.target.closest('.dashboard-card');
        draggedCard.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        // e.dataTransfer.setData('text/plain', draggedCard.dataset.widgetId); // Not strictly needed for this impl
    }

    function handleDragEnd() {
        if (draggedCard) {
            draggedCard.classList.remove('dragging');
            draggedCard = null;
        }
    }

    function handleDragOver(e) {
        e.preventDefault();
        if (!isEditMode || !draggedCard) return;
        e.dataTransfer.dropEffect = 'move';

        const afterElement = getDragAfterElement(dashboardGrid, e.clientY);
        if (afterElement == null) {
            dashboardGrid.appendChild(draggedCard);
        } else {
            dashboardGrid.insertBefore(draggedCard, afterElement);
        }
    }
    
    function handleDrop(e) {
        e.preventDefault(); // if not handled by dragover for some reason
        // Order is already managed by dragover for simplicity here
    }

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.dashboard-card:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else { return closest; }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function createWidgetCard(widgetId, config) {
        const card = document.createElement('div');
        card.className = 'dashboard-card';
        card.dataset.widgetId = widgetId;
        // card.draggable = isEditMode; // Set based on current mode

        const header = document.createElement('div');
        header.className = 'card-header';
        
        const iconSpan = document.createElement('span');
        iconSpan.className = 'card-icon';
        // Check if icon is a Material Icon name or an emoji/char
        if (config.icon.length > 1 && config.icon.match(/^[a-z_]+$/)) { // Heuristic for material icon name
            iconSpan.classList.add('material-icons');
        }
        iconSpan.textContent = config.icon;
        
        const titleH4 = document.createElement('h4');
        titleH4.className = 'card-title';
        titleH4.textContent = config.title;

        header.appendChild(iconSpan);
        header.appendChild(titleH4);
        
        if (isEditMode) { // Add remove button only in edit mode
            const removeBtn = document.createElement('button');
            removeBtn.innerHTML = '&times;'; // Close icon
            removeBtn.className = 'control-btn secondary';
            Object.assign(removeBtn.style, { 
                padding: '2px 6px', fontSize: '0.9em', marginLeft: 'auto', lineHeight: '1'
            });
            removeBtn.title = 'Remove Widget';
            removeBtn.onclick = (e) => { e.stopPropagation(); removeWidget(widgetId); };
            header.appendChild(removeBtn);
        }

        card.appendChild(header);

        if (config.contentGenerator) {
            const contentDiv = document.createElement('div');
            contentDiv.className = 'card-content';
            config.contentGenerator(contentDiv); // Populate content
            card.appendChild(contentDiv);
        } else if (config.link) {
            const descriptionP = document.createElement('p');
            descriptionP.className = 'card-description';
            descriptionP.textContent = config.description || `Maps to ${config.title}.`;
            card.appendChild(descriptionP);

            const actionButton = document.createElement('a'); // Make it a link
            actionButton.href = config.link;
            actionButton.className = 'card-action-button';
            actionButton.textContent = `Go to ${config.title}`;
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'card-button-container';
            buttonContainer.appendChild(actionButton);
            card.appendChild(buttonContainer);
        }
        
        // Add drag listeners if in edit mode
        if (isEditMode) {
            card.draggable = true;
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);
        }


        return card;
    }
    
    function removeWidget(widgetId) {
        if (confirm(`Are you sure you want to remove the "${WIDGET_CONFIG[widgetId]?.title || widgetId}" widget?`)) {
            const cardToRemove = dashboardGrid.querySelector(`.dashboard-card[data-widget-id="${widgetId}"]`);
            if (cardToRemove) {
                cardToRemove.remove();
                // Optionally, save layout immediately or wait for "Save Layout" click
                // saveDashboardLayout(); 
                showNotification('Widget removed. Save layout to keep changes.', 'info');
            }
        }
    }

    function generateUserInfoContent(container) {
        const user = firebase.auth().currentUser;
        if (user) {
            const nameP = document.createElement('p');
            nameP.innerHTML = `<strong>Username:</strong> <span id="widgetUserName">${userNameEl.textContent}</span>`;
            const emailP = document.createElement('p');
            emailP.innerHTML = `<strong>Email:</strong> <span id="widgetUserEmail">${userEmailEl.textContent}</span>`;
            container.appendChild(nameP);
            container.appendChild(emailP);
            
            // Keep widget user info synced with sidebar user info
            // This could be done with a MutationObserver on userNameEl/userEmailEl or custom events
            // For simplicity, we can update it if a global update function is called.
        } else {
            container.textContent = 'User not logged in.';
        }
    }
    
    function generateShortcutsContent(container) {
        container.innerHTML = `
            <div class="widget-tab-cloak">
                <div class="form-group">
                    <label for="cloakTitle">Tab Title:</label>
                    <input type="text" id="cloakTitle" placeholder="e.g., Google Docs">
                </div>
                <div class="form-group">
                    <label for="cloakFavicon">Favicon URL:</label>
                    <input type="url" id="cloakFavicon" placeholder="https://example.com/favicon.ico">
                </div>
                <div class="form-group">
                     <label for="cloakPreset">Or Presets:</label>
                     <select id="cloakPreset" class="widget-tab-cloak input[type='text']" style="width:100%; padding: 8px 10px;">
                        <option value="">-- Select Preset --</option>
                        <option value="google">Google</option>
                        <option value="docs">Google Docs</option>
                        <option value="drive">Google Drive</option>
                        <option value="classroom">Google Classroom</option>
                        <option value="gmail">Gmail</option>
                        <option value="wikipedia">Wikipedia</option>
                     </select>
                </div>
                <button id="applyCloakBtn" class="card-action-button">Apply Cloak</button>
                <button id="resetCloakBtn" class="card-action-button secondary" style="margin-top: 5px; background: linear-gradient(135deg, #777 0%, #555 100%);">Reset Cloak</button>
                <small>Note: Auto-fetching from URL is complex. Please provide details manually or use presets.</small>
            </div>
        `;
        container.querySelector('#applyCloakBtn').addEventListener('click', applyTabCloak);
        container.querySelector('#resetCloakBtn').addEventListener('click', resetTabCloak);
        container.querySelector('#cloakPreset').addEventListener('change', applyPresetCloak);
    }

    const PRESET_CLOAKS = {
        google: { title: "Google", favicon: "https://www.google.com/favicon.ico" },
        docs: { title: "Google Docs", favicon: "https://ssl.gstatic.com/docs/documents/images/kix-favicon7.ico" },
        drive: { title: "Google Drive", favicon: "https://ssl.gstatic.com/images/branding/product/1x/drive_2020q4_32dp.png" },
        classroom: { title: "Google Classroom", favicon: "https://www.gstatic.com/classroom/favicon.ico" },
        gmail: { title: "Gmail", favicon: "https://ssl.gstatic.com/ui/v1/icons/mail/rfr/gmail.ico"},
        wikipedia: { title: "Wikipedia", favicon: "https://www.wikipedia.org/static/favicon/wikipedia.ico"}
    };

    function applyPresetCloak(event) {
        const presetKey = event.target.value;
        if (presetKey && PRESET_CLOAKS[presetKey]) {
            const preset = PRESET_CLOAKS[presetKey];
            document.getElementById('cloakTitle').value = preset.title;
            document.getElementById('cloakFavicon').value = preset.favicon;
            applyTabCloak(); // Optionally apply immediately, or user clicks "Apply Cloak"
        } else if (!presetKey) { // "-- Select Preset --" chosen
            document.getElementById('cloakTitle').value = "4SP - DASHBOARD"; // Default title
            document.getElementById('cloakFavicon').value = "../images/favicon.png"; // Default favicon
            // applyTabCloak(); // Optionally reset immediately
        }
    }


    function applyTabCloak() {
        const title = document.getElementById('cloakTitle').value;
        const faviconUrl = document.getElementById('cloakFavicon').value;

        if (title) {
            document.title = title;
            localStorage.setItem('tabCloakTitle', title);
        }
        const link = document.querySelector("link[rel*='icon']") || document.createElement('link');
        link.type = 'image/x-icon'; // or image/png, image/vnd.microsoft.icon depending on actual favicon
        link.rel = 'shortcut icon'; // Standard
        if (faviconUrl) {
            link.href = faviconUrl;
            localStorage.setItem('tabCloakFavicon', faviconUrl);
        }
        document.getElementsByTagName('head')[0].appendChild(link);
        showNotification('Tab cloaked!', 'success', 2000);
    }

    function resetTabCloak() {
        document.title = '4SP - DASHBOARD'; // Default title
        const link = document.querySelector("link[rel*='icon']");
        if (link) link.href = '../images/favicon.png'; // Default favicon
        localStorage.removeItem('tabCloakTitle');
        localStorage.removeItem('tabCloakFavicon');
        document.getElementById('cloakTitle').value = '';
        document.getElementById('cloakFavicon').value = '';
        document.getElementById('cloakPreset').value = '';
        showNotification('Tab cloak reset.', 'info', 2000);
    }
    
    // Load cloak from localStorage on page load
    function loadSavedCloak() {
        const savedTitle = localStorage.getItem('tabCloakTitle');
        const savedFavicon = localStorage.getItem('tabCloakFavicon');
        if (savedTitle) document.title = savedTitle;
        if (savedFavicon) {
            const link = document.querySelector("link[rel*='icon']") || document.createElement('link');
            link.type = 'image/x-icon';
            link.rel = 'shortcut icon';
            link.href = savedFavicon;
            if (!document.head.contains(link)) { // Avoid appending duplicates
                 document.getElementsByTagName('head')[0].appendChild(link);
            }
        }
    }
    document.addEventListener('DOMContentLoaded', loadSavedCloak);


    function generateLocalInfoContent(container) {
        const batteryP = document.createElement('p');
        batteryP.innerHTML = `<strong>Battery:</strong> <span id="batteryPercentage">Checking...</span> (<span id="batteryCharging">N/A</span>)`;
        container.appendChild(batteryP);

        if ('getBattery' in navigator) {
            navigator.getBattery().then(battery => {
                const updateBatteryStatus = () => {
                    document.getElementById('batteryPercentage').textContent = `${Math.round(battery.level * 100)}%`;
                    document.getElementById('batteryCharging').textContent = battery.charging ? 'Charging' : 'Discharging';
                };
                updateBatteryStatus();
                battery.addEventListener('chargingchange', updateBatteryStatus);
                battery.addEventListener('levelchange', updateBatteryStatus);
            }).catch(err => {
                document.getElementById('batteryPercentage').textContent = 'N/A';
                document.getElementById('batteryCharging').textContent = 'Error';
                console.warn('Battery Status API error:', err);
            });
        } else {
            document.getElementById('batteryPercentage').textContent = 'N/A';
            document.getElementById('batteryCharging').textContent = 'Not Supported';
        }
    }

    // Add/Remove Widget Modal
    function openAddWidgetModal() {
        populateWidgetSelect();
        addWidgetModal.classList.add('visible');
    }
    function closeAddWidgetModal() {
        addWidgetModal.classList.remove('visible');
    }
    function populateWidgetSelect() {
        widgetSelect.innerHTML = '<option value="">-- Select a Widget --</option>'; // Clear existing
        const currentWidgetIds = Array.from(dashboardGrid.querySelectorAll('.dashboard-card')).map(card => card.dataset.widgetId);
        for (const id in WIDGET_CONFIG) {
            if (!currentWidgetIds.includes(id)) { // Only show widgets not already on dashboard
                const option = document.createElement('option');
                option.value = id;
                option.textContent = WIDGET_CONFIG[id].title;
                widgetSelect.appendChild(option);
            }
        }
    }
    function addSelectedWidget() {
        const widgetId = widgetSelect.value;
        if (widgetId && WIDGET_CONFIG[widgetId]) {
            if (dashboardGrid.querySelector(`.dashboard-card[data-widget-id="${widgetId}"]`)) {
                showNotification('This widget is already on your dashboard.', 'error', 3000);
                return;
            }
            const newCard = createWidgetCard(widgetId, WIDGET_CONFIG[widgetId]);
            dashboardGrid.appendChild(newCard);
            // Update draggable status for the new card if in edit mode
            if (isEditMode) {
                newCard.draggable = true;
                newCard.addEventListener('dragstart', handleDragStart);
                newCard.addEventListener('dragend', handleDragEnd);
            }
            closeAddWidgetModal();
            showNotification(`"${WIDGET_CONFIG[widgetId].title}" widget added. Save layout to keep it.`, 'success', 3000);
        } else if (widgetId) {
             showNotification('Selected widget configuration not found.', 'error', 3000);
        }
    }

    // Layout Saving and Loading
    const LAYOUT_STORAGE_KEY = 'dashboardLayout_v4';
    async function saveDashboardLayout() {
        const layout = Array.from(dashboardGrid.querySelectorAll('.dashboard-card')).map(card => card.dataset.widgetId);
        // Save to Firebase
        const userDocRef = dbRef();
        if (userDocRef) {
            try {
                await userDocRef.set({ dashboardLayout: layout }, { merge: true });
                // console.log('Layout saved to Firebase');
            } catch (error) {
                console.error("Error saving layout to Firebase:", error);
                showNotification('Error saving layout online. Changes saved locally.', 'error', 3000);
                // Fallback to localStorage if Firebase fails
                localStorage.setItem(LAYOUT_STORAGE_KEY, JSON.stringify(layout));
            }
        } else { // User not fully available yet, or error with dbRef
            localStorage.setItem(LAYOUT_STORAGE_KEY, JSON.stringify(layout));
            // console.log('Layout saved to localStorage (Firebase ref not available)');
        }
    }

    async function loadDashboardLayout() {
        dashboardGrid.innerHTML = ''; // Clear current grid
        let layout = null;
        const userDocRef = dbRef();

        if (userDocRef) {
            try {
                const doc = await userDocRef.get();
                if (doc.exists && doc.data().dashboardLayout) {
                    layout = doc.data().dashboardLayout;
                    // console.log('Layout loaded from Firebase');
                }
            } catch (error) {
                console.error("Error loading layout from Firebase:", error);
            }
        }

        if (!layout) { // Fallback to localStorage or default
            const localLayout = localStorage.getItem(LAYOUT_STORAGE_KEY);
            if (localLayout) {
                layout = JSON.parse(localLayout);
                // console.log('Layout loaded from localStorage');
            } else { // Default layout
                layout = Object.keys(WIDGET_CONFIG).filter(id => WIDGET_CONFIG[id].default);
                // console.log('Using default layout');
            }
        }
        
        layout.forEach(widgetId => {
            if (WIDGET_CONFIG[widgetId]) {
                const card = createWidgetCard(widgetId, WIDGET_CONFIG[widgetId]);
                dashboardGrid.appendChild(card);
            } else {
                console.warn(`Widget ID "${widgetId}" in layout not found in config. Skipping.`);
            }
        });
        // If in edit mode, ensure new cards are draggable
        if (isEditMode) makeCardsDraggable(true);
    }
    
    // Keyboard shortcuts for edit mode
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && isEditMode) {
            toggleEditMode(); // This will also trigger save
        }
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'e') {
            e.preventDefault();
            toggleEditMode();
        }
    });

    </script>
</body>
</html>
