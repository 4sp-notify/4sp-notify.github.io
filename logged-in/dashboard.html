<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Attentio</title>

    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Firebase Scripts (with corrected ../ paths) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js" defer></script>
    <script src="../firebase-config.js" defer></script>
    
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-accent: #f1f3f4;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --border-color: #e0e0e0;
            --primary-blue: #3B82F6;
            --primary-blue-dark: #2563EB;
            --status-green: #34A853;
            --status-red: #EA4335;
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .dark-mode {
            --bg-primary: #202124;
            --bg-secondary: #303134;
            --bg-accent: #3c4043;
            --text-primary: #e8eaed;
            --text-secondary: #bdc1c6;
            --border-color: #5f6368;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }
        #app-container { display: flex; flex-direction: column; height: 100vh; }
        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 2rem;
            background-color: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .logo { font-weight: 700; font-size: 1.5rem; }
        .profile-container { position: relative; }
        .profile-circle {
            width: 40px; height: 40px; border-radius: 50%;
            background-color: var(--primary-blue); color: white;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; cursor: pointer; user-select: none;
        }
        .profile-panel {
            position: absolute; top: calc(100% + 10px); right: 0;
            width: 240px; background-color: var(--bg-primary);
            border-radius: 12px; box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color); padding: 0.5rem;
            opacity: 0; visibility: hidden; transform: translateY(-10px);
            transition: opacity 0.2s, transform 0.2s; z-index: 100;
        }
        .profile-panel.is-active { opacity: 1; visibility: visible; transform: translateY(0); }
        .profile-panel ul { list-style: none; padding: 0; margin: 0; }
        .profile-panel .panel-button {
            display: flex; align-items: center; width: 100%;
            padding: 0.75rem; background: none; border: none;
            border-radius: 8px; text-align: left; cursor: pointer;
            font-size: 1rem; font-family: 'Poppins', sans-serif; color: var(--text-primary);
        }
        .profile-panel .panel-button:hover { background-color: var(--bg-accent); }
        .panel-divider { height: 1px; background-color: var(--border-color); margin: 0.5rem 0; }
        .dashboard-body { display: flex; flex-grow: 1; overflow: hidden; }
        .sidebar {
            width: 280px; background-color: var(--bg-primary);
            border-right: 1px solid var(--border-color); padding: 1.5rem;
            flex-shrink: 0; overflow-y: auto; /* Scrollable sidebar */
        }
        .sidebar h2 { margin-top: 0; }
        .sidebar-menu { list-style: none; padding: 0; margin: 0; }
        .sidebar-menu a {
            display: block; padding: 0.75rem 1rem; border-radius: 8px;
            text-decoration: none; color: var(--text-secondary); font-weight: 500;
        }
        .sidebar-menu a.active, .sidebar-menu a:hover { background-color: var(--bg-accent); color: var(--text-primary); }
        .main-content { flex-grow: 1; padding: 2.5rem; overflow-y: auto; }
        .main-content h1, .main-content h2 { margin-top: 0; }
        .card {
            background-color: var(--bg-primary); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 2rem; margin-bottom: 1.5rem;
        }
        .input-group { margin-bottom: 1rem; }
        .input-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .input-group input, .input-group textarea {
            width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-color);
            border-radius: 8px; font-family: 'Poppins', sans-serif; font-size: 1rem;
            background-color: var(--bg-secondary); color: var(--text-primary);
        }
        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none;
            font-weight: 500; border: none; cursor: pointer;
            font-family: 'Poppins', sans-serif; font-size: 1rem;
        }
        .btn-primary { background-color: var(--primary-blue); color: var(--bg-white); }
        .btn-primary:hover { background-color: var(--primary-blue-dark); }
        
        /* --- New Request/Hand Styles --- */
        .request-section summary {
            font-size: 1.25rem;
            font-weight: 700;
            cursor: pointer;
            padding: 0.5rem;
            list-style: none; /* Hide default arrow */
        }
        .request-section summary::-webkit-details-marker { display: none; } /* Hide default arrow */
        .request-card {
            display: flex; align-items: center; padding: 1rem 1.5rem;
        }
        .request-icon {
            font-size: 1.5rem;
            color: var(--text-secondary);
            margin-right: 1.5rem;
        }
        .request-content { flex-grow: 1; }
        .request-content strong {
            display: block;
            font-size: 1.1rem;
            color: var(--text-primary);
        }
        .request-content p {
            margin: 0.25rem 0 0;
            color: var(--text-secondary);
        }
        .request-comment {
            font-style: italic;
            color: var(--primary-blue);
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
        .request-actions {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .action-btn {
            width: 36px; height: 36px; border-radius: 50%;
            border: none; cursor: pointer; display: flex;
            align-items: center; justify-content: center;
            transition: transform 0.2s, opacity 0.2s;
        }
        .action-btn:hover { transform: scale(1.1); }
        .action-btn.accept { background-color: var(--status-green); color: white; }
        .action-btn.deny { background-color: var(--status-red); color: white; }
        .action-btn.comment { background-color: var(--primary-blue); color: white; }
        .action-btn.edit-comment { background-color: var(--primary-blue); color: white; }
        .action-btn.delete-comment { background-color: var(--text-secondary); color: white; }
    </style>
</head>
<body>

    <div id="app-container">
        <header class="topbar">
            <div class="logo">Attentio</div>
            <div class="profile-container">
                <div class="profile-circle" id="profileCircle"></div>
                <div class="profile-panel" id="profilePanel">
                    <ul>
                        <li><button class="panel-button" id="settingsBtn">Settings</button></li>
                        <li><div class="panel-divider"></div></li>
                        <li><button class="panel-button" id="logoutBtn">Logout</button></li>
                    </ul>
                </div>
            </div>
        </header>
        
        <div class="dashboard-body">
            <aside class="sidebar" id="sidebar">
                <h2>My Classes</h2>
                <ul class="sidebar-menu" id="classList">
                    <!-- Class links populated here -->
                </ul>
            </aside>
            <main class="main-content" id="mainContent">
                <!-- Role-specific content populated here -->
            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const auth = firebase.auth();
            const db = firebase.firestore();
            let currentUserData = null;

            const profileCircle = document.getElementById('profileCircle');
            const profilePanel = document.getElementById('profilePanel');
            const logoutBtn = document.getElementById('logoutBtn');
            const mainContent = document.getElementById('mainContent');
            const classList = document.getElementById('classList');

            // --- UI & AUTH ---
            profileCircle.addEventListener('click', () => profilePanel.classList.toggle('is-active'));
            document.addEventListener('click', (event) => {
                if (!profileCircle.contains(event.target) && !profilePanel.contains(event.target)) {
                    profilePanel.classList.remove('is-active');
                }
            });
            logoutBtn.addEventListener('click', () => {
                auth.signOut().then(() => window.location.href = '../login.html');
            });

            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        currentUserData = { uid: user.uid, ...userDoc.data() };
                        initializeDashboard(currentUserData);
                    } else {
                        auth.signOut();
                    }
                } else {
                    window.location.href = '../login.html';
                }
            });

            function initializeDashboard(userData) {
                const username = userData.username || userData.email;
                profileCircle.textContent = username.charAt(0).toUpperCase();
                
                classList.innerHTML = `
                    <li><a href="#" class="active">Biology 101</a></li>
                    <li><a href="#">History of Art</a></li>
                `;

                if (userData.role === 'teacher') {
                    renderTeacherView("Biology 101");
                } else {
                    renderStudentView("Biology 101");
                }
            }
            
            // --- DYNAMIC TAB TITLE ---
            function updateTabTitle(count) {
                document.title = count > 0 ? `(${count}) Dashboard - Attentio` : 'Dashboard - Attentio';
            }

            // --- STUDENT VIEW ---
            function renderStudentView(className) {
                const requests = [
                    { id: 'req1', title: 'Question about Mitosis', question: 'Can you explain prophase again?', status: 'held' },
                    { id: 'req2', title: 'Homework Extension', question: 'May I have one extra day?', status: 'done', comment: 'Approved. Please submit by tomorrow.' },
                    { id: 'req3', title: 'Clarification', question: 'What is the topic for the final essay?', status: 'denied', comment: 'This was covered in class. Please see the syllabus.' },
                    { id: 'req4', title: 'Help with lab', question: 'I am stuck on step 3.', status: 'commented', comment: 'Check the video I posted.' },
                ];
                
                const pendingCount = requests.filter(r => r.status === 'held' || r.status === 'commented').length;
                updateTabTitle(pendingCount);

                mainContent.innerHTML = `
                    <h1>${className}</h1>
                    <div class="card">
                        <h2><i class="fas fa-hand-paper"></i> Raise Your Hand</h2>
                        <form id="raiseHandForm">
                            <div class="input-group">
                                <label for="requestTitle">Title (Optional, max 24 chars)</label>
                                <input type="text" id="requestTitle" maxlength="24">
                            </div>
                            <div class="input-group">
                                <label for="requestQuestion">Question / Request</label>
                                <textarea id="requestQuestion" rows="3" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Submit Request</button>
                        </form>
                    </div>
                    ${renderRequests(requests, 'student')}
                `;

                document.getElementById('raiseHandForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    alert('Request submitted!');
                });
            }

            // --- TEACHER VIEW ---
            function renderTeacherView(className) {
                 const requests = [
                    { id: 'req1', student: 'Alex', title: 'Question about Mitosis', question: 'Can you explain prophase again?', status: 'held', timestamp: new Date() },
                    { id: 'req4', student: 'Beth', title: 'Help with lab', question: 'I am stuck on step 3 of the lab report.', status: 'commented', comment: 'Check the video I posted.', timestamp: new Date() },
                    { id: 'req2', student: 'Charlie', title: 'Homework Extension', question: 'May I have one extra day?', status: 'done', timestamp: new Date() },
                    { id: 'req3', student: 'Diana', title: 'Clarification', question: 'What is the topic for the final essay?', status: 'denied', timestamp: new Date() },
                ];

                const pendingCount = requests.filter(r => r.status === 'held' || r.status === 'commented').length;
                updateTabTitle(pendingCount);

                mainContent.innerHTML = `
                    <h1>${className} - Today's Requests</h1>
                    ${renderRequests(requests, 'teacher')}
                `;

                // Add event listeners for the action buttons
                mainContent.addEventListener('click', handleTeacherAction);
            }

            function handleTeacherAction(event) {
                const button = event.target.closest('.action-btn');
                if (!button) return;

                const card = button.closest('.request-card');
                const requestId = card.dataset.id;
                
                if (button.classList.contains('accept')) {
                    alert(`Accepting request ${requestId}.`);
                } else if (button.classList.contains('deny')) {
                    alert(`Denying request ${requestId}.`);
                } else if (button.classList.contains('comment')) {
                    const currentComment = card.dataset.comment || "";
                    const newComment = prompt("Enter your comment:", currentComment);
                    if (newComment !== null) alert(`Adding/editing comment for request ${requestId}: ${newComment}`);
                } else if (button.classList.contains('delete-comment')) {
                    if (confirm("Are you sure you want to delete this comment?")) {
                        alert(`Deleting comment for request ${requestId}.`);
                    }
                }
            }


            // --- SHARED REQUEST RENDERING LOGIC ---
            function renderRequests(requests, role) {
                const held = requests.filter(r => r.status === 'held' || r.status === 'commented');
                const done = requests.filter(r => r.status === 'done');
                const denied = requests.filter(r => r.status === 'denied');

                return `
                    <details class="request-section" open>
                        <summary><h3>Currently Held (${held.length})</h3></summary>
                        <div id="held-requests">${held.map(r => renderRequestCard(r, role)).join('') || '<p style="padding: 1rem;">No pending requests.</p>'}</div>
                    </details>
                    <details class="request-section">
                        <summary><h3>Done (${done.length})</h3></summary>
                        <div id="done-requests">${done.map(r => renderRequestCard(r, role)).join('') || '<p style="padding: 1rem;">No completed requests today.</p>'}</div>
                    </details>
                    <details class="request-section">
                        <summary><h3>Denied (${denied.length})</h3></summary>
                        <div id="denied-requests">${denied.map(r => renderRequestCard(r, role)).join('') || '<p style="padding: 1rem;">No denied requests today.</p>'}</div>
                    </details>
                `;
            }

            function renderRequestCard(request, role) {
                const title = request.title || 'Request';
                const question = request.question;
                
                let actionsHtml = '';
                if (role === 'teacher') {
                    const hasComment = request.comment && request.comment.length > 0;
                    const commentBtn = `<button class="action-btn comment" title="${hasComment ? 'Edit Comment' : 'Add Comment'}"><i class="fas fa-comment"></i></button>`;
                    const deleteBtn = hasComment ? `<button class="action-btn delete-comment" title="Delete Comment"><i class="fas fa-trash-alt"></i></button>` : '';

                    actionsHtml = `
                        <div class="request-actions">
                            <button class="action-btn accept" title="Accept"><i class="fas fa-check"></i></button>
                            ${commentBtn}
                            ${deleteBtn}
                            <button class="action-btn deny" title="Deny"><i class="fas fa-times"></i></button>
                        </div>
                    `;
                }

                return `
                    <div class="card request-card" data-id="${request.id}" data-comment="${request.comment || ''}">
                        <div class="request-icon"><i class="fas fa-hand-paper"></i></div>
                        <div class="request-content">
                            <strong>${title}</strong>
                            <p>${question}</p>
                            ${request.comment ? `<p class="request-comment"><strong>Comment:</strong> ${request.comment}</p>` : ''}
                        </div>
                        ${actionsHtml}
                    </div>
                `;
            }

            // Light/Dark Mode Toggle
            const settingsBtn = document.getElementById('settingsBtn');
            let isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (localStorage.getItem('theme') === 'dark') isDarkMode = true;
            if (localStorage.getItem('theme') === 'light') isDarkMode = false;
            
            if (isDarkMode) document.body.classList.add('dark-mode');
            settingsBtn.innerHTML = `Settings (Theme: ${isDarkMode ? 'Dark' : 'Light'})`;
            
            settingsBtn.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                isDarkMode = !isDarkMode;
                localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
                settingsBtn.innerHTML = `Settings (Theme: ${isDarkMode ? 'Dark' : 'Light'})`;
            });
        });
    </script>

</body>
</html>
