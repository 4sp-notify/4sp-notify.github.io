<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>4SP - DASHBOARD</title>
  <link rel="stylesheet" href="../css/style.css" />
  <script src="../panic-key.js"></script>
  <script src="../ban-enforcer.js"></script>
  <script src="../url-changer.js"></script>

  <style>
    /* --- Dashboard Layout --- */
    body.dashboard-page {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      margin: 0;
      font-family: 'PrimaryFont', sans-serif;
    }
    .dashboard-container {
      display: flex;
      flex: 1;
    }

    /* --- Sidebar --- */
    .sidebar {
      width: 200px;
      background: linear-gradient(180deg, #333 0%, #2a2a2a 100%);
      color: #fff;
      padding: 20px 10px;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #444;
      transition: width 0.5s ease-in-out;
      position: relative;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }
    .sidebar.collapsed {
      width: 85px;
    }
    #toggleSidebar {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: none;
      border: none;
      color: #fff;
      font-size: 1.2em;
      cursor: pointer;
      padding: 4px;
      transition: transform 0.5s ease-in-out;
    }
    .sidebar.collapsed #toggleSidebar {
      transform: translateX(-50%) rotate(180deg);
    }
    .sidebar nav ul {
      list-style: none;
      padding: 0;
      margin: 60px 0 0;
    }
    .sidebar nav li {
      margin-bottom: 10px;
    }
    .sidebar nav a {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      color: #fff;
      text-decoration: none;
      border-radius: 8px;
      transition: all 0.3s ease;
      font-family: 'PrimaryFont', sans-serif;
      text-transform: uppercase;
      position: relative;
      overflow: hidden;
    }
    .sidebar nav a::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transition: left 0.5s;
    }
    .sidebar nav a:hover::before {
      left: 100%;
    }
    .sidebar nav a.active,
    .sidebar nav a:hover {
      background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
      transform: translateX(5px);
    }
    .sidebar nav a .icon {
      font-size: 1.2em;
      width: 24px;
      text-align: center;
    }
    .sidebar nav a .label {
      margin-left: 10px;
      white-space: nowrap;
    }
    .sidebar.collapsed nav a {
      justify-content: center;
      padding: 10px 0;
    }
    .sidebar.collapsed nav a .label {
      display: none;
    }
    .user-info {
      text-align: center;
      margin: 60px 0 30px;
      border-bottom: 1px solid #555;
      padding-bottom: 20px;
      overflow: visible;
    }
    .marquee-container {
      overflow: hidden;
      white-space: nowrap;
      position: relative;
      width: 100%;
      height: 1.8em;
      line-height: 1.8em;
    }
    .marquee-content {
      display: inline-block;
      padding-left: 100%;
      transform: translateX(0);
      animation: none;
      line-height: 1.8em;
    }
    .marquee-active {
      animation: scroll-left 12s linear infinite;
    }
    .sidebar.collapsed .marquee-active {
      animation-duration: 20s;
    }
    @keyframes scroll-left {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }
    .user-info .username {
      font-family: 'PrimaryFont', sans-serif;
      font-size: 1.3em;
      margin-bottom: 8px;
      line-height: 0.2em;
      font-weight: bold;
    }
    .user-info .email {
      font-family: 'SecondaryFont', sans-serif;
      font-size: 0.9em;
      color: #bbb;
    }

    /* --- Main Content & Controls --- */
    .main-content {
      flex: 1;
      padding: 40px;
      background: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
      overflow-y: auto;
      position: relative;
    }
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 40px;
      background: white;
      padding: 20px 30px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      border: 1px solid rgba(103, 32, 189, 0.1);
      position: relative; /* Added for search suggestions positioning */
    }
    .dashboard-title {
      margin: 0;
      font-size: 2.2em;
      font-weight: bold;
      background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* --- START: New Battery Styles --- */
    .dashboard-title-wrapper {
        display: flex;
        align-items: center;
        gap: 20px;
        flex-grow: 1; 
    }
    .battery-status-container {
        display: none; /* Hidden by default; JS enables it if API is supported */
        flex-direction: column;
        font-size: 0.75em;
        font-weight: 500;
        color: #5f6368; /* Default grey color */
        background-color: rgba(0, 0, 0, 0.03);
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 8px;
        padding: 4px 8px;
        line-height: 1.3;
        transition: all 0.3s ease;
    }
    .battery-status-container.charging {
        color: #2e7d32; /* Green when charging */
        border-color: rgba(46, 125, 50, 0.4);
    }
    #battery-level.low {
        color: #f5c518; /* Yellow for low battery */
        font-weight: bold;
    }
    #battery-level.critical {
        color: #e53935; /* Red for critical battery */
        font-weight: bold;
    }
    #battery-level.very-critical {
        color: #b71c1c; /* Dark red for very critical battery */
        font-weight: bold;
    }
    /* --- END: New Battery Styles --- */
    
    .dashboard-controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    /* --- START: Search Bar Styles --- */
    .search-container {
      position: relative;
      width: 350px; /* Set a specific width for the search bar */
    }
    #dashboardSearch {
      width: 100%;
      padding: 12px 20px;
      font-family: 'PrimaryFont', sans-serif;
      font-size: 1em;
      color: #333;
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid rgba(103, 32, 189, 0.2);
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      outline: none;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }
    #dashboardSearch::placeholder {
      color: #777;
    }
    #dashboardSearch:focus {
      box-shadow: 0 4px 15px rgba(103, 32, 189, 0.15);
      border-color: rgba(103, 32, 189, 0.4);
    }
    .suggestions-container {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 8px;
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(103, 32, 189, 0.2);
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      z-index: 1000;
      max-height: 250px;
      overflow-y: auto;
    }
    .suggestion-item {
      display: block;
      padding: 12px 20px;
      color: #333;
      text-decoration: none;
      font-family: 'PrimaryFont', sans-serif;
      font-size: 0.95em;
      cursor: pointer;
      transition: background-color 0.2s ease, color 0.2s ease;
      border-bottom: 1px solid rgba(103, 32, 189, 0.1);
    }
    .suggestion-item:last-child {
      border-bottom: none;
    }
    .suggestion-item:hover {
      background-color: rgba(103, 32, 189, 0.1);
      color: #6720bd;
    }
    /* --- END: Search Bar Styles --- */

    /* --- Dashboard Grid & Cards --- */
    .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr; 
        gap: 20px;
        position: relative;
    }
    @media (min-width: 768px) {
        .dashboard-grid {
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }
    }
    @media (min-width: 1200px) {
        .dashboard-grid {
            grid-template-columns: repeat(6, 1fr);
        }
    }

    .dashboard-card {
      background: white;
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 6px 30px rgba(0,0,0,0.08);
      border: 1px solid rgba(103, 32, 189, 0.1);
      position: relative;
      user-select: none;
      z-index: 2;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
      min-height: 200px;
    }
    
    /* Default span for cards on smaller grids or when type not specified for 6-col */
    .dashboard-card {
        grid-column: span 1; 
    }
    
    @media (min-width: 768px) and (max-width: 1199px) { /* For auto-fit on medium screens */
        .dashboard-card[data-card-type="medium"],
        .dashboard-card[data-card-type="small"],
        .dashboard-card[data-card-type="full"] {
            grid-column: auto / span 1; /* Each card takes one of the auto-fitted columns */
        }
    }

    @media (min-width: 1200px) { /* Spans for the 6-column grid */
        .dashboard-card[data-card-type="medium"] {
            grid-column: span 3; 
        }
        .dashboard-card[data-card-type="small"] {
            grid-column: span 2; 
        }
        .dashboard-card[data-card-type="full"] { 
            grid-column: span 6;
        }
    }

    .dashboard-card[data-template-id="weather_large_widget"] {
        padding-top: 10px;
    }

    .dashboard-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(103, 32, 189, 0.05), transparent);
      transition: left 0.6s ease;
      z-index: -1;
    }
    .dashboard-card:hover::before {
      left: 100%;
    }
    .dashboard-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 15px 40px rgba(103, 32, 189, 0.15);
      border-color: rgba(103, 32, 189, 0.3);
    }

    .card-header {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(103, 32, 189, 0.1);
      justify-content: flex-start;
      flex-shrink: 0;
      position: relative;
    }
    .card-icon {
      font-size: 2em;
      margin-right: 12px;
      background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 2px 4px rgba(103, 32, 189, 0.2));
    }
    .card-title {
      font-size: 1.3em;
      font-weight: bold;
      margin: 0;
      color: #333;
      flex-grow: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .card-header-buttons {
        position: relative;
        margin-left: auto;
        display: flex;
        gap: 6px;
    }

    .weather-action-btn {
        background: rgba(103, 32, 189, 0.08);
        border: none;
        cursor: pointer;
        padding: 8px;
        line-height: 1;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 12px;
        z-index: 5;
        transition: background-color 0.2s ease, transform 0.2s ease;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .weather-action-btn img {
        width: 22px;
        height: 22px;
        display: block;
        transform: rotate(0deg); 
        transition: none;
        filter: invert(0.3) brightness(100%);
    }
    .weather-action-btn:hover {
        background-color: rgba(103, 32, 189, 0.15);
        transform: translateY(-2px);
    }
    .weather-action-btn:disabled {
        cursor: not-allowed;
        opacity: 0.6;
        background-color: rgba(103, 32, 189, 0.08);
        transform: translateY(0);
    }

    @keyframes spin-clockwise {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    @keyframes spin-counter-clockwise {
        from { transform: rotate(360deg); }
        to { transform: rotate(0deg); }
    }
    .weather-refresh-btn.refreshing img {
        animation: spin-clockwise 0.8s linear infinite; 
    }
    .weather-refresh-btn.spin-back img {
        animation: spin-counter-clockwise 0.5s ease-out forwards; 
    }

    .card-content-inner {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    /* Specific Widget Styles */
    .weather-large-content {
        display: flex;
        flex-direction: column;
        height: 100%;
        justify-content: flex-start;
    }
    .current-weather-layout {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(103, 32, 189, 0.08);
        width: 100%;
        box-sizing: border-box;
    }
    .weather-icon-large {
        font-size: 3.2em;
        color: #6720bd;
        flex-shrink: 0;
    }
    .current-weather-main-info {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        flex-grow: 1;
    }
    .temp-large {
        font-size: 2.3em;
        font-weight: bold;
        color: #333;
        line-height: 1.1;
    }
    .condition-large {
        font-size: 0.95em;
        color: #555;
    }
    .current-weather-details-aside {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        font-size: 0.75em;
        color: #777;
        line-height: 1.4;
        flex-shrink: 0;
        padding-left: 12px;
        border-left: 1px solid rgba(103, 32, 189, 0.1);
        text-align: right;
    }
    .current-weather-details-aside p {
        margin: 0px 0;
    }

    .forecast-large {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-around;
        gap: 5px;
        padding: 6px 0px;
        margin-bottom: 8px;
    }
    .forecast-day {
        flex: 0 1 auto;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        padding: 8px 4px;
        background-color: #ffffff;
        border-radius: 12px;
        min-width: 58.5px;
        text-align: center;
        border: 1.25px solid rgba(103, 32, 189, 0.2);
        cursor: pointer;
        transition: all 0.2s ease;
        height: 82.5px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .forecast-day:hover {
        background-color: rgba(103, 32, 189, 0.1);
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(103, 32, 189, 0.1);
    }
    .forecast-day .day-name { font-size: 0.75em; font-weight: 600; color: #555; margin-bottom: 4px; }
    .forecast-day .icon { 
        font-size: 1.6em;
        color: #6720bd; margin-bottom: 4px; line-height:1; 
        filter: drop-shadow(0 1px 2px rgba(103, 32, 189, 0.1));
    }
    .forecast-day .temps { 
        font-size: 0.8em;
        color: #333; 
        font-weight: 500;
    }

    /* Clock Widget */
    .clock-display {
        font-size: 3.5em;
        font-weight: bold;
        color: #333;
        text-align: left;
        margin-bottom: 5px;
    }
    .date-display {
        font-size: 1.5em;
        color: #666;
        text-align: left;
    }
    .additional-time-info {
        font-size: 1em;
        color: #777;
        text-align: left;
        margin-top: 10px;
        line-height: 1.3;
    }
    .additional-time-info span {
        display: inline-block;
        padding: 0 5px;
    }
    .additional-time-info span:first-child {
        padding-left: 0;
    }

    /* --- REVISED Stopwatch & Timer Widget --- */
    .stopwatch-display, .timer-display-value {
        font-size: 2.2em;
        font-weight: bold;
        color: #6720bd;
        text-align: center;
        margin-bottom: 15px;
        letter-spacing: 1px;
        font-family: 'PrimaryFont', sans-serif;
    }
    .timer-inputs { 
      display: flex; 
      justify-content: center; 
      gap: 5px; 
      margin-bottom: 15px; 
    }
    .timer-inputs.hidden {
      display: none;
    }
    .timer-inputs input {
        width: 40px;
        padding: 8px;
        text-align: center;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 1em;
        font-family: 'PrimaryFont', sans-serif;
    }
    .controls-flex { 
      display: flex; 
      justify-content: center; 
      gap: 10px; 
      flex-wrap: wrap;
    }
    .controls-flex button {
        background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
        color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer;
        font-family: 'PrimaryFont', sans-serif; font-weight: 600; transition: all 0.2s ease;
    }
    .controls-flex button:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 4px 10px rgba(103, 32, 189, 0.3); 
    }
    .controls-flex button[data-action="pause"] { 
      background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); 
    }
    .controls-flex button[data-action="reset"] { 
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%); 
    }
    /* --- End Revised Styles --- */


    /* Quick Actions Widget - New List Style */
    .quick-actions-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .quick-actions-list button {
        display: flex;
        align-items: center;
        width: 100%;
        padding: 12px 15px;
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        text-align: left;
        font-family: 'PrimaryFont', sans-serif;
        font-size: 1.1em;
        text-transform: uppercase;
        color: #495057;
        cursor: pointer;
        transition: all 0.2s ease;
        height: 42.5px;
    }
    .quick-actions-list button:hover {
        background-color: #e9ecef;
        border-color: #dee2e6;
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .quick-actions-list button .icon {
        font-size: 1.5em;
        margin-right: 12px;
        color: #6720bd;
    }
    .quick-actions-list button .text {
        flex-grow: 1;
        font-weight: 500;
    }
    .quick-actions-list button .arrow {
        font-size: 1.2em;
        color: #adb5bd;
    }


    /* --- Modals (General) --- */
    .modal {
        display: flex;
        align-items: center;
        justify-content: center;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.6);
        font-family: 'PrimaryFont', sans-serif;
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.25s ease-out, visibility 0s linear 0.25s;
    }
    .modal.modal-open {
        visibility: visible;
        opacity: 1;
        transition: opacity 0.25s ease-out, visibility 0s linear 0s;
    }
    .modal-content {
        background-color: #fefefe;
        padding: 30px;
        border: 1px solid #bbb;
        width: 90%;
        max-width: 500px;
        border-radius: 18px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.25);
        position: relative;
        color: #333;
        transform: scale(0.9);
        transition: transform 0.3s ease-out;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    .modal.modal-open .modal-content {
        transform: scale(1);
    }
    .modal-close-btn {
        color: #aaa;
        position: absolute;
        top: 15px;
        right: 18px;
        font-size: 30px;
        font-weight: 300;
        background: none;
        border: none;
        cursor: pointer;
        line-height: 1;
        transition: color 0.2s ease;
    }
    .modal-close-btn:hover,
    .modal-close-btn:focus {
        color: #6720bd;
        text-decoration: none;
    }

    /* --- Forecast Detail Modal --- */
    #forecastDetailModal .modal-header-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        border-bottom: 1px solid rgba(103, 32, 189, 0.1);
        padding-bottom: 15px;
        margin-bottom: 15px;
    }
    #forecastDetailModal .modal-header-section h3 {
        margin: 0 0 8px 0;
        color: #6720bd;
        font-size: 1.8em;
        font-weight: bold;
        text-align: center;
    }
    #forecastDetailModal .modal-header-section .date-subtitle {
        font-size: 1.1em;
        color: #555;
        font-weight: normal;
        margin: 0;
    }
    #forecastDetailModal .modal-current-weather-summary {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        margin-bottom: 20px;
    }
    #forecastDetailModal .modal-icon-large {
        font-size: 4em;
        color: #6720bd;
        text-shadow: 0 3px 8px rgba(103, 32, 189, 0.2);
    }
    #forecastDetailModal .modal-temp-and-desc {
        text-align: left;
    }
    #forecastDetailModal .modal-temp-and-desc .modal-temp-display {
        font-size: 2.8em;
        font-weight: bold;
        color: #333;
        line-height: 1;
        margin-bottom: 5px;
    }
    #forecastDetailModal .modal-temp-and-desc #modalWeatherDesc {
        font-size: 1.2em;
        font-weight: 500;
        color: #666;
    }
    #forecastDetailModal .modal-details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 10px 20px;
    }
    #forecastDetailModal .modal-details-grid p {
        font-size: 0.9em;
        line-height: 1.5;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
        color: #444;
    }
    #forecastDetailModal .modal-details-grid p strong {
        color: #222;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    #forecastDetailModal .modal-details-grid .detail-icon {
        font-size: 1.1em;
        color: #8a2be2;
    }
    /* START: New Advice Styles */
    #forecastDetailModal .modal-advice-section {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid rgba(103, 32, 189, 0.15);
        text-align: left;
    }
    #forecastDetailModal .modal-advice-section h4 {
        margin: 0 0 10px 0;
        color: #333;
        font-size: 1.1em;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    #forecastDetailModal .modal-advice-section p {
        font-size: 0.95em;
        line-height: 1.6;
        color: #555;
        margin: 0;
    }
    #forecastDetailModal .modal-advice-section ul {
        list-style-type: '‚úì  ';
        margin: 0 0 0 20px;
        padding: 0;
        font-size: 0.95em;
        line-height: 1.6;
        color: #555;
    }
    #forecastDetailModal .modal-advice-section li {
        margin-bottom: 5px;
    }
    /* END: New Advice Styles */

    /* --- Weather Settings Modal --- */
    .weather-settings-modal .modal-content {
      gap: 20px;
    }
    .weather-settings-modal h3 {
        margin: 0;
        text-align: center;
        font-size: 1.6em;
        color: #6720bd;
        font-weight: bold;
        font-family: 'PrimaryFont', sans-serif;
    }
    .settings-section {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    .settings-section label {
        font-weight: 600;
        color: #555;
        font-size: 1.1em;
        font-family: 'PrimaryFont', sans-serif;
    }
    .location-input-wrapper {
        position: relative;
    }
    #weatherLocationInput {
        width: 100%;
        padding: 12px 15px;
        font-size: 1em;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-sizing: border-box;
        transition: border-color 0.2s, box-shadow 0.2s;
        font-family: 'PrimaryFont', sans-serif; /* Ensure font */
    }
    #weatherLocationInput:focus {
        outline: none;
        border-color: #8a2be2;
        box-shadow: 0 0 0 3px rgba(103, 32, 189, 0.2);
    }
    #locationSuggestions {
        list-style: none;
        padding: 0;
        margin: 5px 0 0 0;
        position: absolute;
        background: white;
        width: 100%;
        border: 1px solid #ddd;
        border-radius: 8px;
        max-height: 150px;
        overflow-y: auto;
        z-index: 10001;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    #locationSuggestions li {
        padding: 10px 15px;
        cursor: pointer;
        transition: background-color 0.2s;
        border-bottom: 1px solid #eee;
        font-family: 'PrimaryFont', sans-serif; /* Ensure font */
    }
    #locationSuggestions li:last-child {
        border-bottom: none;
    }
    #locationSuggestions li:hover {
        background-color: #f0f2f5;
    }
    #useCurrentLocationBtn {
        padding: 10px 15px;
        font-size: 0.95em;
        font-weight: 600;
        background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-family: 'PrimaryFont', sans-serif; /* Ensure font */
    }
    #useCurrentLocationBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(103, 32, 189, 0.3);
    }
    #useCurrentLocationBtn:disabled {
        background: #aaa;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    .unit-toggle-wrapper {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 10px;
        font-family: 'PrimaryFont', sans-serif; /* Ensure font */
    }
    /* Custom Toggle Switch */
    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
    }
    .switch input { display:none; }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 26px; width: 26px;
      left: 4px; bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #6720bd;
    }
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    .slider:after{
      content:'¬∞F';
      color: white;
      display: block;
      position: absolute;
      transform: translate(-50%,-50%);
      top: 50%;
      left: 75%;
      font-size: 12px;
      font-family: sans-serif;
    }
    input:checked + .slider:after {  
      content:'¬∞C';
      left: 25%;
    }

    /* --- START: New Styles for Shortcut Settings Modal --- */
    .shortcut-settings-modal .modal-content {
        max-width: 600px;
        gap: 10px;
    }
    .shortcut-settings-modal h3 {
        margin: 0;
        text-align: center;
        font-size: 1.6em;
        color: #6720bd;
        font-weight: bold;
        font-family: 'PrimaryFont', sans-serif;
        margin-bottom: 10px;
    }
    #shortcutSettingsForm {
        display: flex;
        flex-direction: column;
        gap: 20px;
        max-height: 60vh;
        overflow-y: auto;
        padding-right: 10px;
    }
    .shortcut-editor-group {
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 12px;
        background-color: #f9f9f9;
    }
    .shortcut-editor-group h4 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #333;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
    }
    .shortcut-input-row {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 10px;
        margin-bottom: 12px;
    }
    .shortcut-input-row label {
        font-weight: 600;
        color: #555;
        white-space: nowrap;
    }
    .shortcut-input-row input[type="text"],
    .shortcut-input-row input[type="url"],
    .shortcut-input-row select {
        padding: 8px 10px;
        font-size: 1em;
        border: 1px solid #ccc;
        border-radius: 6px;
        box-sizing: border-box;
        font-family: 'PrimaryFont', sans-serif;
        flex: 1 1 150px; /* Allow wrapping */
    }
    .shortcut-emoji-input {
        flex: 0 1 60px;
    }
    .shortcut-name-input {
        flex: 1 1 200px;
    }
    .action-target-wrapper .hidden {
        display: none;
    }
    .shortcut-modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 10px;
        border-top: 1px solid #eee;
        padding-top: 20px;
    }
    .shortcut-modal-buttons button {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-family: 'PrimaryFont', sans-serif;
        transition: all 0.2s ease;
    }
    #saveShortcutsBtn {
        background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
        color: white;
    }
    #saveShortcutsBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(103, 32, 189, 0.3);
    }
    #resetShortcutsBtn {
        background-color: #6c757d;
        color: white;
    }
    #resetShortcutsBtn:hover {
        background-color: #5a6268;
    }
    /* --- END: New Styles for Shortcut Settings Modal --- */

    /* --- Responsive Design --- */
    @media (max-width: 1199px) and (min-width: 768px) {
        .dashboard-card[data-card-type="medium"],
        .dashboard-card[data-card-type="small"],
        .dashboard-card[data-card-type="full"] {
            /* All cards take 1fr of the auto-fit columns */
        }
    }

    @media (max-width: 767px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
      .dashboard-card {
        grid-column: span 1 / auto !important;
      }
      .current-weather-layout {
        flex-direction: column;
        align-items: flex-start;
      }
      .current-weather-details-aside {
        padding-left: 0;
        margin-left: 0;
        border-left: none;
        margin-top: 10px;
        width: 100%;
        align-items: flex-start; /* Align to left on small screens */
      }
      .dashboard-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      /* --- START: Responsive Battery Style --- */
      .dashboard-title-wrapper {
        flex-direction: column;
        gap: 10px;
        align-items: center;
      }
      /* --- END: Responsive Battery Style --- */
      .search-container { /* Adjust search for mobile */
          margin-top: 10px;
          width: 100%;
      }
      .main-content {
        padding: 20px;
      }
      .weather-icon-large { font-size: 3em; }
      .temp-large { font-size: 2.2em; }
      .clock-display { font-size: 2em; }
      .date-display { font-size: 0.9em; }
      .additional-time-info { font-size: 0.75em; margin-top: 8px;}
      .stopwatch-display, .timer-display-value { font-size: 1.8em;}
      .quick-actions-list button { font-size: 0.9em; padding: 10px 12px;}
      .quick-actions-list button .icon { font-size: 1.3em; margin-right: 10px;}

      /* Modal on small screens */
      .modal-content {
        width: 95%;
        padding: 20px;
      }
      #forecastDetailModal .modal-header-section h3 { font-size: 1.5em; }
      #forecastDetailModal .modal-header-section .date-subtitle { font-size: 1em; }
      #forecastDetailModal .modal-current-weather-summary {
          flex-direction: column;
          text-align: center;
          gap: 10px;
      }
      #forecastDetailModal .modal-temp-and-desc {
          text-align: center;
      }
      #forecastDetailModal .modal-icon-large { font-size: 3.5em; }
      #forecastDetailModal .modal-temp-and-desc .modal-temp-display { font-size: 2.5em; }
      #forecastDetailModal .modal-temp-and-desc #modalWeatherDesc { font-size: 1.1em; }
      #forecastDetailModal .modal-details-grid {
          grid-template-columns: 1fr;
          gap: 8px;
      }
    }

    /* --- Animation Classes --- */
    .fade-in {
      animation: fadeIn 0.6s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .slide-in {
      animation: slideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
    @keyframes slideIn {
      from { transform: translateX(-100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
  </style>
</head>

<body class="dashboard-page">
  <header class="main-header light-bg">
    <div class="container">
      <div class="logo">
        <a href="../index.html">
          <img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer" />
        </a>
      </div>
      <div class="auth-buttons">
        <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button>
        <button id="logoutBtn" class="btn btn-login">LOG OUT</button>
      </div>
    </div>
  </header>

  <div class="dashboard-container">
    <aside class="sidebar slide-in" id="sidebar">
      <button id="toggleSidebar">‚ò∞</button>
      <div class="user-info">
        <div class="marquee-container">
          <span id="userName" class="marquee-content username">Loading‚Ä¶</span>
        </div>
        <div class="marquee-container">
          <span id="userEmail" class="marquee-content email">Loading‚Ä¶</span>
        </div>
      </div>
      <nav>
        <ul>
          <li><a href="dashboard.html" class="active"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
          <li><a href="soundboard.html"><span class="icon">üéµ</span><span class="label">Soundboard</span></a></li>
          <li><a href="games.html"><span class="icon">üéÆ</span><span class="label">Games</span></a></li>
          <li><a href="others.html"><span class="icon">‚ú®</span><span class="label">Others</span></a></li>
          <li><a href="settings.html"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a></li>
          <li><a href="#" id="signOutLink"><span class="icon">üîí</span><span class="label">LOG OUT</span></a></li>
        </ul>
      </nav>
    </aside>

    <main class="main-content fade-in">
      <div class="dashboard-header">
        <div class="dashboard-title-wrapper">
            <h2 class="dashboard-title">Dashboard</h2>
            <div id="battery-status" class="battery-status-container">
                <div id="battery-charging-status">Checking...</div>
                <div id="battery-level">Percentage: --%</div>
            </div>
        </div>
        <div class="dashboard-controls">
          <div class="search-container">
            <input type="text" id="dashboardSearch" placeholder="üîç Search pages & features...">
            <div id="searchSuggestions" class="suggestions-container"></div>
          </div>
        </div>
      </div>

      <div class="dashboard-grid" id="dashboardGrid">
        </div>

    </main>
  </div>

  <div id="forecastDetailModal" class="modal">
    <div class="modal-content">
        <button class="modal-close-btn">&times;</button>
        
        <div class="modal-header-section">
            <h3 id="modalDayDate">Day, Date</h3>
            <p class="date-subtitle" id="modalFullDateSubtitle"></p>
        </div>

        <div class="modal-current-weather-summary">
            <span id="modalWeatherIcon" class="modal-icon-large">‚ùì</span>
            <div class="modal-temp-and-desc">
                <div class="modal-temp-display">
                    <span id="modalMaxTemp">--</span> / <span id="modalMinTemp">--</span>
                </div>
                <div id="modalWeatherDesc">Description</div>
            </div>
        </div>
        
        <div class="modal-details-grid">
            <p><strong><span class="detail-icon">üå°Ô∏è</span>Feels Like:</strong> <span id="modalFeelsLike">--</span></p>
            <p><strong><span class="detail-icon">üíß</span>Humidity:</strong> <span id="modalHumidity">--</span>%</p>
            <p><strong><span class="detail-icon">üåßÔ∏è</span>Precipitation:</strong> <span id="modalPrecipSum">--</span> mm</p>
            <p><strong><span class="detail-icon">‚òî</span>Precip. Chance:</strong> <span id="modalPrecipProb">--</span>%</p>
            <p><strong><span class="detail-icon">üí®</span>Max Wind:</strong> <span id="modalWindSpeed">--</span></p>
            <p><strong><span class="detail-icon">üß≠</span>Wind Direction:</strong> <span id="modalWindDirection">--</span></p>
            <p><strong><span class="detail-icon">‚òÄÔ∏è</span>Sunrise:</strong> <span id="modalSunriseTime">--:--</span></p>
            <p><strong><span class="detail-icon">üåá</span>Sunset:</strong> <span id="modalSunsetTime">--:--</span></p>
            <p><strong><span class="detail-icon">üí°</span>Daylight:</strong> <span id="modalDaylightDuration">--</span></p>
        </div>

        <div class="modal-advice-section">
            <h4><span class="detail-icon">üí°</span> Daily Advice</h4>
            <div id="modalDailyAdvice">Checking the forecast for tips...</div>
        </div>
    </div>
  </div>
  
  <div id="weatherSettingsModal" class="modal weather-settings-modal">
      <div class="modal-content">
          <button class="modal-close-btn">&times;</button>
          <h3>Weather Settings</h3>
          <div class="settings-section">
              <label for="weatherLocationInput">Location</label>
              <div class="location-input-wrapper">
                  <input type="text" id="weatherLocationInput" placeholder="Enter a city name...">
                  <ul id="locationSuggestions"></ul>
              </div>
              <button id="useCurrentLocationBtn">üìç Use My Current Location</button>
          </div>
          <div class="settings-section">
              <label>Units</label>
              <div class="unit-toggle-wrapper">
                  <span>Imperial (¬∞F) / Metric (¬∞C)</span>
                  <label class="switch">
                      <input type="checkbox" id="unitToggle">
                      <span class="slider"></span>
                  </label>
              </div>
          </div>
      </div>
  </div>

  <div id="shortcutSettingsModal" class="modal shortcut-settings-modal">
      <div class="modal-content">
          <button class="modal-close-btn">&times;</button>
          <h3>Edit Quick Shortcuts</h3>
          <form id="shortcutSettingsForm" onsubmit="return false;">
            </form>
      </div>
  </div>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="../firebase-config.js"></script>
  <script>
    // --- Globals & Firebase Refs ---
    const dbRef = () =>
      firebase.auth().currentUser
        ? firebase.firestore().collection('users').doc(firebase.auth().currentUser.uid)
        : null;

    // --- DOM Elements ---
    const marqueeEls = document.querySelectorAll('.marquee-content');
    const dashboardGrid = document.getElementById('dashboardGrid');
    const userNameEl = document.getElementById('userName');
    
    // --- START: Search Bar Suggestions Data (used by search bar and shortcuts modal) ---
    const pageSuggestions = [
        { name: 'Dashboard Home', url: 'dashboard.html' },
        { name: 'Games Page', url: 'games.html' },
        { name: 'Soundboard', url: 'soundboard.html' },
        { name: 'Others Page', url: 'others.html' },
        { name: 'Notes Page', url: 'notes.html' },
        { name: 'Requests Page', url: 'requests.html' },
        { name: 'Countdowns Page', url: 'countdowns.html' },
        { name: 'Playlists Page', url: 'playlists.html' },
        { name: 'Weather Page', url: 'weather.html' },
        { name: 'GB-GAMES', url: '../GB-GAMES/index.html' },
        { name: 'GN-MATH Games', url: '../GN-GAMES/index.html' },
        { name: 'User Settings', url: 'settings.html' },
        { name: 'Calculator Page', url: 'calculator.html' },
        { name: 'Grade Calculator Page', url: 'grade-calculator.html' },
        { name: 'Slotz', url: 'slotz.html' },
        { name: 'LME Page', url: 'lme.html' },
        // These items scroll to a widget on the current page instead of redirecting
        { name: 'Scroll to Weather', url: '#', action: () => { const el = document.querySelector('[data-template-id="weather_large_widget"]'); if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' }); } },
        { name: 'Scroll to Clock', url: '#', action: () => { const el = document.querySelector('[data-template-id="clock_widget"]'); if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' }); } },
        { name: 'Scroll to Stopwatch', url: '#', action: () => { const el = document.querySelector('[data-template-id="stopwatch_widget"]'); if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' }); } },
        { name: 'Scroll to Timer', url: '#', action: () => { const el = document.querySelector('[data-template-id="timer_widget"]'); if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' }); } }
    ];
    // --- END: Search Bar Suggestions Data ---

    // --- Weather Settings ---
    let weatherSettings = {
        location: {
            label: 'Massillon, OH',
            latitude: 40.7909,
            longitude: -81.5218,
        },
        units: 'imperial' // 'imperial' or 'metric'
    };
    let userCoords = null; // To store user's actual location for suggestion proximity

    const WMO_CODES = {
      0: { description: "Clear sky", icon: "‚òÄÔ∏è" }, 1: { description: "Mainly clear", icon: "üå§Ô∏è" },
      2: { description: "Partly cloudy", icon: "üå•Ô∏è" }, 3: { description: "Overcast", icon: "‚òÅÔ∏è" },
      45: { description: "Fog", icon: "üå´Ô∏è" }, 48: { description: "Depositing rime fog", icon: "üå´Ô∏è" },
      51: { description: "Light drizzle", icon: "üå¶Ô∏è" }, 53: { description: "Moderate drizzle", icon: "üå¶Ô∏è" },
      55: { description: "Dense drizzle", icon: "üå¶Ô∏è" }, 56: { description: "Light freezing drizzle", icon: "üå®Ô∏è" },
      57: { description: "Dense freezing drizzle", icon: "üå®Ô∏è" }, 61: { description: "Slight rain", icon: "üåßÔ∏è" },
      63: { description: "Moderate rain", icon: "üåßÔ∏è" }, 65: { description: "Heavy rain", icon: "üåßÔ∏è" },
      66: { description: "Light freezing rain", icon: "üå®Ô∏è" }, 67: { description: "Heavy freezing rain", icon: "üå®Ô∏è" },
      71: { description: "Slight snow fall", icon: "‚ùÑÔ∏è" }, 73: { description: "Moderate snow fall", icon: "‚ùÑÔ∏è" },
      75: { description: "Heavy snow fall", icon: "‚ùÑÔ∏è" }, 77: { description: "Snow grains", icon: "‚ùÑÔ∏è" },
      80: { description: "Slight rain showers", icon: "üå¶Ô∏è" }, 81: { description: "Moderate rain showers", icon: "üå¶Ô∏è" },
      82: { description: "Violent rain showers", icon: "‚õàÔ∏è" }, 85: { description: "Slight snow showers", icon: "üå®Ô∏è" },
      86: { description: "Heavy snow showers", icon: "üå®Ô∏è" }, 95: { description: "Thunderstorm", icon: "‚õàÔ∏è" },
      96: { description: "Thunderstorm with slight hail", icon: "‚õàÔ∏è" }, 99: { description: "Thunderstorm with heavy hail", icon: "‚õàÔ∏è" },
    };
    
    // --- START: New Shortcut Widget Globals ---
    const QUICK_ACTIONS_STORAGE_KEY = '4sp_quickActions_v1';
    const defaultQuickActions = [
        { icon: '‚õÖ', text: 'Weather', type: 'page', value: 'weather.html' },
        { icon: 'üìù', text: 'Notes', type: 'page', value: 'notes.html' },
        { icon: 'üéµ', text: 'Requests', type: 'page', value: 'requests.html' },
        { icon: 'üìä', text: 'Countdowns', type: 'page', value: 'countdowns.html' },
    ];
    let currentQuickActions = [...defaultQuickActions];
    // --- END: New Shortcut Widget Globals ---

    // --- Modal Elements & Functions ---
    const forecastModal = document.getElementById('forecastDetailModal');
    const weatherSettingsModal = document.getElementById('weatherSettingsModal');
    const shortcutSettingsModal = document.getElementById('shortcutSettingsModal'); // New modal
    
    function setupModal(modal) {
        if (!modal) return;
        const closeBtn = modal.querySelector('.modal-close-btn');
        if (closeBtn) {
            closeBtn.onclick = () => modal.classList.remove('modal-open');
        }
        modal.onclick = (event) => {
            if (event.target === modal) {
                modal.classList.remove('modal-open');
            }
        };
    }
    setupModal(forecastModal);
    setupModal(weatherSettingsModal);
    setupModal(shortcutSettingsModal); // Setup new modal

    function formatModalTime(isoString, timeZone) {
        if (!isoString || isoString === 'N/A') return 'N/A';
        try {
            const date = new Date(isoString);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', timeZone: timeZone, hour12: true });
        } catch (e) {
            console.error("Error formatting modal time:", e);
            return 'N/A';
        }
    }
    function formatDaylightDuration(totalSeconds) {
        if (totalSeconds === null || totalSeconds === undefined || totalSeconds === 'N/A' || isNaN(totalSeconds)) return 'N/A';
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        return `${hours}h ${minutes}m`;
    }

    function degreesToCardinal(degrees) {
        if (degrees === null || degrees === undefined || degrees === 'N/A' || isNaN(degrees)) return 'N/A';
        const val = Math.floor((degrees / 22.5) + 0.5);
        const arr = ["N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE", "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW"];
        return arr[(val % 16)];
    }

    function getShortLocationLabel(address, fullDisplayName) {
        if (!address) return fullDisplayName;

        const city = address.city || address.town || address.village || address.hamlet;

        if (address.house_number && address.road && city) {
            return `${address.house_number} ${address.road}, ${city}`;
        }
        if (address.road && city) {
            return `${address.road}, ${city}`;
        }
        if (city && address.state) {
            return `${city}, ${address.state}`;
        }
        if (city && address.country) {
            return `${city}, ${address.country}`;
        }
        if (city) {
            return city;
        }
        return fullDisplayName;
    }


    async function fetchCityName(lat, lon) {
        const nominatimUrl = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`;
        const fallbackLabel = `Lat: ${parseFloat(lat).toFixed(2)}, Lon: ${parseFloat(lon).toFixed(2)}`;
        try {
            const response = await fetch(nominatimUrl);
            if (!response.ok) {
                console.warn(`Nominatim API error: ${response.status}`);
                return { label: fallbackLabel, country_code: 'us' };
            }
            const data = await response.json();
            if (data && data.address) {
                const label = getShortLocationLabel(data.address, data.display_name);
                return { label, country_code: data.address.country_code || 'us' };
            }
            return { label: fallbackLabel, country_code: 'us' };
        } catch (error) {
            console.error("Error fetching city name:", error);
            return { label: fallbackLabel, country_code: 'us' };
        }
    }

    // --- START: New Weather Advice Function ---
    function generateWeatherAdvice(dayData, units, humidity) {
        const advice = [];
        const { tempMax, weatherCode, precipSum, precipProb, windSpeedMax } = dayData;

        // Convert temps and speeds for consistent logic
        const tempMaxC = units === 'imperial' ? (tempMax - 32) * 5 / 9 : tempMax;
        const windSpeedMph = units === 'metric' ? windSpeedMax * 0.621371 : windSpeedMax;

        // Temperature-based advice
        if (tempMaxC >= 30) {
            advice.push("It's going to be very hot. Wear light clothes and use sunscreen.");
        } else if (tempMaxC >= 22) {
            advice.push("Expect warm weather, a good day for a t-shirt.");
        } else if (tempMaxC <= 5) {
            advice.push("It's quite cold. Bundle up with a thick coat, scarf, and gloves.");
        }

        // Precipitation advice (based on WMO codes and probability)
        if (precipSum > 0.1 || precipProb > 40) {
            if ([51, 53, 55, 61, 63, 65, 80, 81, 82].includes(weatherCode)) {
                advice.push("Rain is likely. Don't forget an umbrella or a raincoat.");
            } else if ([56, 57, 66, 67, 71, 73, 75, 77, 85, 86].includes(weatherCode)) {
                advice.push("Snow is expected! Wear a warm, waterproof coat and snow boots.");
            } else {
                advice.push("There's a chance of precipitation, so it might be wise to bring an umbrella.");
            }
        }

        // Humidity advice (using current day's humidity as a proxy for the forecast day)
        if (humidity >= 75) {
            advice.push("High humidity can make it feel muggy. Lightweight, breathable clothing is recommended.");
        } else if (humidity <= 35 && precipProb < 20) {
            advice.push("The air seems dry. Remember to drink plenty of water to stay hydrated.");
        }

        // Wind advice
        if (windSpeedMph >= 15) {
            advice.push("It could be quite windy. A windbreaker would be a good idea.");
        }

        // Fog advice
        if ([45, 48].includes(weatherCode)) {
            advice.push("Foggy conditions are expected. Be extra cautious if you're driving or walking.");
        }

        // Thunderstorm advice
        if ([95, 96, 99].includes(weatherCode)) {
            advice.push("Thunderstorms are possible. It's best to stay indoors if you hear thunder.");
        }

        // Default/Sunny day advice
        if (advice.length === 0) {
            if ([0, 1].includes(weatherCode)) {
                return "<p>Looks like a beautiful, clear day. Perfect for outdoor activities!</p>";
            }
            return "<p>Enjoy your day! Check the details above for a full forecast.</p>";
        }

        return '<ul>' + advice.map(item => `<li>${item}</li>`).join('') + '</ul>';
    }
    // --- END: New Weather Advice Function ---


    function openForecastModal(dayData, dailyTimeZone, displayUnits, speedSuffixUnit, currentApparentTemp, currentHumidity) {
        if (!forecastModal) return;

        const { dateStr, weatherCode, tempMax, tempMin, precipSum, precipProb, windSpeedMax, sunrise, sunset, daylightDuration, windDirection } = dayData;
        const tempSuffix = displayUnits === 'metric' ? '¬∞C' : '¬∞F';

        const parts = dateStr.split('-').map(s => parseInt(s, 10));
        const utcDateForModal = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2], 12, 0, 0));
        
        document.getElementById('modalDayDate').textContent = utcDateForModal.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: dailyTimeZone });
        document.getElementById('modalFullDateSubtitle').textContent = utcDateForModal.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric', timeZone: dailyTimeZone });

        const codeInfo = WMO_CODES[weatherCode] || { description: "Unknown", icon: "‚ùì" };
        document.getElementById('modalWeatherIcon').textContent = codeInfo.icon;
        document.getElementById('modalWeatherDesc').textContent = codeInfo.description;

        document.getElementById('modalMaxTemp').textContent = `${Math.round(tempMax)}${tempSuffix}`;
        document.getElementById('modalMinTemp').textContent = `${Math.round(tempMin)}${tempSuffix}`;
        document.getElementById('modalPrecipSum').textContent = `${precipSum !== 'N/A' && precipSum !== null ? precipSum : '--'}`;
        document.getElementById('modalPrecipProb').textContent = `${precipProb !== 'N/A' && precipProb !== null ? precipProb : '--'}`;
        document.getElementById('modalWindSpeed').textContent = `${windSpeedMax !== 'N/A' && windSpeedMax !== null ? Math.round(windSpeedMax) : '--'} ${speedSuffixUnit}`;
        document.getElementById('modalWindDirection').textContent = degreesToCardinal(windDirection);
        document.getElementById('modalDaylightDuration').textContent = formatDaylightDuration(daylightDuration);
        document.getElementById('modalSunriseTime').textContent = formatModalTime(sunrise, dailyTimeZone);
        document.getElementById('modalSunsetTime').textContent = formatModalTime(sunset, dailyTimeZone);
        
        document.getElementById('modalFeelsLike').textContent = `${currentApparentTemp !== null ? Math.round(currentApparentTemp) : '--'}${tempSuffix}`;
        document.getElementById('modalHumidity').textContent = `${currentHumidity !== null ? currentHumidity : '--'}`;
        
        // --- START: Update to call advice function ---
        const adviceEl = document.getElementById('modalDailyAdvice');
        if (adviceEl) {
            adviceEl.innerHTML = generateWeatherAdvice(dayData, displayUnits, currentHumidity);
        }
        // --- END: Update to call advice function ---

        forecastModal.classList.add('modal-open');
    }

    // --- Weather Settings Logic ---
    function saveWeatherSettings() {
        localStorage.setItem('weatherWidgetSettings', JSON.stringify(weatherSettings));
    }

    function loadWeatherSettings() {
        const saved = localStorage.getItem('weatherWidgetSettings');
        if (saved) {
            weatherSettings = JSON.parse(saved);
        }
        return !!saved;
    }
    
    const weatherLocationInput = document.getElementById('weatherLocationInput');
    const locationSuggestions = document.getElementById('locationSuggestions');
    const unitToggle = document.getElementById('unitToggle');
    const useCurrentLocationBtn = document.getElementById('useCurrentLocationBtn');
    let debounceTimer;

    weatherLocationInput.addEventListener('keyup', (e) => {
        clearTimeout(debounceTimer);
        const query = e.target.value;
        if (query.length < 3) {
            locationSuggestions.innerHTML = '';
            locationSuggestions.style.display = 'none';
            return;
        }
        debounceTimer = setTimeout(() => fetchLocationSuggestions(query), 500);
    });

    useCurrentLocationBtn.addEventListener('click', async () => {
        if (!navigator.geolocation) {
            showNotification("Geolocation is not supported by your browser.", "error");
            return;
        }
        
        useCurrentLocationBtn.disabled = true;
        useCurrentLocationBtn.textContent = 'Locating...';

        navigator.geolocation.getCurrentPosition(async (position) => {
            const { latitude, longitude } = position.coords;
            const { label } = await fetchCityName(latitude, longitude);

            weatherSettings.location = { label, latitude, longitude };
            weatherLocationInput.value = label;
            saveWeatherSettings();
            showNotification(`Location updated to ${label}`, 'success');
            updateWeatherForNewSettings();
            weatherSettingsModal.classList.remove('modal-open');

            useCurrentLocationBtn.disabled = false;
            useCurrentLocationBtn.textContent = 'üìç Use My Current Location';
        }, (error) => {
            console.error("Geolocation error:", error);
            showNotification("Could not get location. Please enable location services.", "error");
            useCurrentLocationBtn.disabled = false;
            useCurrentLocationBtn.textContent = 'üìç Use My Current Location';
        }, { timeout: 10000 });
    });

    async function fetchLocationSuggestions(query) {
        let url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1`;

        if (userCoords) {
            const R = 6371; // Earth radius in km
            const d = 250; // Viewbox side length in km
            const latRad = userCoords.latitude * (Math.PI / 180);
            const lonRad = userCoords.longitude * (Math.PI / 180);
            const lat1 = 180 / Math.PI * (latRad - (d/R));
            const lat2 = 180 / Math.PI * (latRad + (d/R));
            const lon1 = 180 / Math.PI * (lonRad - Math.asin(d/R) / Math.cos(latRad));
            const lon2 = 180 / Math.PI * (lonRad + Math.asin(d/R) / Math.cos(latRad));
            url += `&viewbox=${lon1},${lat2},${lon2},${lat1}&bounded=1`;
        }
        
        try {
            const response = await fetch(url);
            const data = await response.json();
            locationSuggestions.innerHTML = '';
            if (data.length > 0) {
                locationSuggestions.style.display = 'block';
                data.slice(0, 5).forEach(place => {
                    const shortLabel = getShortLocationLabel(place.address, place.display_name);
                    const li = document.createElement('li');
                    li.textContent = shortLabel;
                    li.addEventListener('click', () => {
                        weatherSettings.location = {
                            label: shortLabel,
                            latitude: parseFloat(place.lat),
                            longitude: parseFloat(place.lon)
                        };
                        weatherLocationInput.value = shortLabel;
                        locationSuggestions.innerHTML = '';
                        locationSuggestions.style.display = 'none';
                        saveWeatherSettings();
                        updateWeatherForNewSettings();
                        weatherSettingsModal.classList.remove('modal-open');
                    });
                    locationSuggestions.appendChild(li);
                });
            } else {
                locationSuggestions.style.display = 'none';
            }
        } catch (error) {
            console.error("Failed to fetch location suggestions:", error);
        }
    }
    
    unitToggle.addEventListener('change', () => {
        weatherSettings.units = unitToggle.checked ? 'metric' : 'imperial';
        saveWeatherSettings();
        updateWeatherForNewSettings();
    });
    
    function openWeatherSettingsModal() {
        weatherLocationInput.value = weatherSettings.location.label;
        unitToggle.checked = weatherSettings.units === 'metric';
        locationSuggestions.style.display = 'none';
        weatherSettingsModal.classList.add('modal-open');
    }

    function updateWeatherForNewSettings() {
        const weatherCard = document.querySelector('.dashboard-card[data-template-id="weather_large_widget"]');
        if (weatherCard && weatherCard.updateWeather) {
            weatherCard.updateWeather();
        }
    }
    
    // --- START: New Shortcut Modal Logic ---
    function populateShortcutModal() {
        const form = document.getElementById('shortcutSettingsForm');
        let formHTML = '';

        const pageOptionsHTML = pageSuggestions
            .map(p => `<option value="${p.url}">${p.name}</option>`)
            .join('');

        currentQuickActions.forEach((action, index) => {
            const sanitizedText = action.text.replace(/"/g, '&quot;');
            const sanitizedValue = action.value.replace(/"/g, '&quot;');
            formHTML += `
                <div class="shortcut-editor-group" data-shortcut-index="${index}">
                    <h4>Shortcut ${index + 1}</h4>
                    <div class="shortcut-input-row">
                        <label for="shortcut-emoji-${index}">Emoji</label>
                        <input type="text" id="shortcut-emoji-${index}" class="shortcut-emoji-input" value="${action.icon}">
                        <label for="shortcut-name-${index}">Name</label>
                        <input type="text" id="shortcut-name-${index}" class="shortcut-name-input" maxlength="20" required value="${sanitizedText}">
                    </div>
                    <div class="shortcut-input-row">
                        <label>Action Type:</label>
                        <input type="radio" name="actionType-${index}" value="page" ${action.type === 'page' ? 'checked' : ''}> Page
                        <input type="radio" name="actionType-${index}" value="url" ${action.type === 'url' ? 'checked' : ''}> URL
                    </div>
                    <div class="shortcut-input-row action-target-wrapper">
                        <select id="shortcut-page-${index}" class="shortcut-page-select ${action.type !== 'page' ? 'hidden' : ''}">
                            ${pageOptionsHTML}
                        </select>
                        <input type="url" id="shortcut-url-${index}" class="shortcut-url-input ${action.type !== 'url' ? 'hidden' : ''}" placeholder="https://example.com" value="${action.type === 'url' ? sanitizedValue : ''}">
                    </div>
                </div>
            `;
        });
        
        form.innerHTML = formHTML + `
            <div class="shortcut-modal-buttons">
                <button type="submit" id="saveShortcutsBtn">Save Changes</button>
                <button type="button" id="resetShortcutsBtn">Reset to Defaults</button>
            </div>
        `;

        currentQuickActions.forEach((action, index) => {
            if (action.type === 'page') {
                document.getElementById(`shortcut-page-${index}`).value = action.value;
            }

            document.querySelectorAll(`input[name="actionType-${index}"]`).forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const pageSelect = document.getElementById(`shortcut-page-${index}`);
                    const urlInput = document.getElementById(`shortcut-url-${index}`);
                    if (e.target.value === 'page') {
                        pageSelect.classList.remove('hidden');
                        urlInput.classList.add('hidden');
                    } else {
                        pageSelect.classList.add('hidden');
                        urlInput.classList.remove('hidden');
                    }
                });
            });
        });
        
        document.getElementById('saveShortcutsBtn').addEventListener('click', handleSaveShortcuts);
        document.getElementById('resetShortcutsBtn').addEventListener('click', handleResetShortcuts);
    }

    function handleSaveShortcuts(e) {
        e.preventDefault();
        const newActions = [];
        let isValid = true;
        const nameRegex = /^[a-zA-Z0-9\s!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]*$/;

        for (let i = 0; i < 4; i++) {
            const icon = document.getElementById(`shortcut-emoji-${i}`).value.trim();
            const text = document.getElementById(`shortcut-name-${i}`).value.trim();
            const type = document.querySelector(`input[name="actionType-${i}"]:checked`).value;
            
            let value;
            if (type === 'page') {
                value = document.getElementById(`shortcut-page-${i}`).value;
            } else { // url
                value = document.getElementById(`shortcut-url-${i}`).value.trim();
                if (value && !value.startsWith('http://') && !value.startsWith('https://')) {
                     value = 'https://' + value;
                }
            }

            if (!text) {
                showNotification(`Name for Shortcut ${i + 1} cannot be empty.`, 'error');
                isValid = false; break;
            }
            if(!nameRegex.test(text)){
                showNotification(`Name for Shortcut ${i+1} contains invalid characters.`, 'error');
                isValid = false; break;
            }
            if (type === 'url' && !value) {
                showNotification(`URL for Shortcut ${i + 1} cannot be empty.`, 'error');
                isValid = false; break;
            }

            newActions.push({ icon: icon || 'üîó', text, type, value });
        }

        if (isValid) {
            localStorage.setItem(QUICK_ACTIONS_STORAGE_KEY, JSON.stringify(newActions));
            if (window.updateQuickActionsWidget) {
                window.updateQuickActionsWidget();
            }
            shortcutSettingsModal.classList.remove('modal-open');
            showNotification('Shortcuts updated successfully!', 'success');
        }
    }

    function handleResetShortcuts() {
        localStorage.removeItem(QUICK_ACTIONS_STORAGE_KEY);
        if (window.updateQuickActionsWidget) {
            window.updateQuickActionsWidget();
        }
        shortcutSettingsModal.classList.remove('modal-open');
        showNotification('Shortcuts have been reset to default.', 'info');
    }
    // --- END: New Shortcut Modal Logic ---

    // --- Card Templates ---
    const availableCardTemplates = [
      {
        templateId: 'weather_large_widget', title: 'Weather Forecast', icon: 'üå¶Ô∏è', type: 'medium',
        onMount: async (cardElement) => {
         const forecastEl = cardElement.querySelector('.forecast-large');
         const currentIconEl = cardElement.querySelector('.weather-icon-large');
         const currentTempEl = cardElement.querySelector('.temp-large');
         const currentConditionEl = cardElement.querySelector('.condition-large');
         const feelsLikeValueEl = cardElement.querySelector('.feels-like-value');
         const humidityValueEl = cardElement.querySelector('.humidity-value');
         const windValueEl = cardElement.querySelector('.wind-value');
         const locationDisplayEl = cardElement.querySelector('.location-large');

         const refreshBtn = cardElement.querySelector('.weather-refresh-btn');
         const settingsBtn = cardElement.querySelector('.weather-settings-btn');
         const refreshImg = refreshBtn ? refreshBtn.querySelector('img') : null;
         let fullDailyForecastData = null;
         let currentApparentTemp = null;
         let currentHumidity = null;
         
         if (settingsBtn) {
             settingsBtn.addEventListener('click', openWeatherSettingsModal);
         }

         const displayErrorInCard = (message) => {
          currentConditionEl.textContent = message; currentIconEl.textContent = '‚ö†Ô∏è'; currentTempEl.textContent = '--¬∞';
          if(feelsLikeValueEl) feelsLikeValueEl.textContent = '--¬∞';
          if(humidityValueEl) humidityValueEl.textContent = '--%';
          if(windValueEl) windValueEl.textContent = '--';
          if(locationDisplayEl) locationDisplayEl.textContent = "Error";
          forecastEl.innerHTML = `<p style="color:red; text-align:center; font-size:0.9em;">${message}</p>`;
          if (refreshBtn) {
            refreshBtn.disabled = false;
            if (refreshImg) {
                refreshImg.classList.remove('refreshing');
                refreshBtn.classList.add('spin-back');
                refreshImg.addEventListener('animationend', () => {
                    refreshBtn.classList.remove('spin-back');
                    refreshImg.style.transform = '';
                }, { once: true });
            }
          }
         };

         async function actualFetchAndDisplayWeather() {
          const { latitude, longitude, label } = weatherSettings.location;
          const { units } = weatherSettings;

          if (refreshBtn) {
            refreshBtn.disabled = true;
            refreshBtn.classList.remove('spin-back');
            if (refreshImg) {
                refreshImg.classList.remove('spin-back');
                refreshImg.classList.add('refreshing');
            }
          }
          currentIconEl.textContent = '‚è≥';
          currentConditionEl.textContent = 'Fetching...';

          try {
            const tempUnitParam = units === 'metric' ? 'celsius' : 'fahrenheit';
            const windSpeedUnitParam = units === 'metric' ? 'kmh' : 'mph';
            const dailyParams = "weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum,precipitation_probability_max,wind_speed_10m_max,sunrise,sunset,daylight_duration,wind_direction_10m_dominant";
            const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,relative_humidity_2m,apparent_temperature,weather_code,wind_speed_10m&daily=${dailyParams}&temperature_unit=${tempUnitParam}&wind_speed_unit=${windSpeedUnitParam}&timezone=auto&forecast_days=7`;
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error(`API Error: ${response.status}`);
            const data = await response.json();

            const cw = data.current;
            const cwCodeInfo = WMO_CODES[cw.weather_code] || { description: "Unknown", icon: "‚ùì" };
            const tempSuffix = units === 'metric' ? '¬∞C' : '¬∞F';
            const speedSuffix = units === 'metric' ? 'km/h' : 'mph';

            currentTempEl.textContent = `${Math.round(cw.temperature_2m)}${tempSuffix}`;
            currentIconEl.textContent = cwCodeInfo.icon;
            currentConditionEl.textContent = cwCodeInfo.description;
            
            currentApparentTemp = cw.apparent_temperature;
            currentHumidity = cw.relative_humidity_2m;

            if (feelsLikeValueEl) feelsLikeValueEl.textContent = `${Math.round(currentApparentTemp)}${tempSuffix}`;
            if (humidityValueEl) humidityValueEl.textContent = `${currentHumidity}%`;
            if (windValueEl) windValueEl.textContent = `${Math.round(cw.wind_speed_10m)}${speedSuffix}`;
            if (locationDisplayEl) locationDisplayEl.textContent = label;

            forecastEl.innerHTML = '';
            fullDailyForecastData = data.daily;

            if (fullDailyForecastData && fullDailyForecastData.time && fullDailyForecastData.time.length > 0) {
              for (let i = 0; i < fullDailyForecastData.time.length; i++) {
                const dayCodeInfo = WMO_CODES[fullDailyForecastData.weather_code[i]] || { description: "Unknown", icon: "‚ùì" };
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('forecast-day');
                dayDiv.dataset.dayIndex = i;

                const currentDayDateString = fullDailyForecastData.time[i];
                const parts = currentDayDateString.split('-').map(s => parseInt(s, 10));
                const utcDateForForecastDay = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2], 12, 0, 0));
                const dayName = i === 0 ? "Today" : utcDateForForecastDay.toLocaleDateString(undefined, { weekday: 'short', timeZone: data.timezone });

                dayDiv.innerHTML = `
                  <span class="day-name">${dayName}</span>
                  <span class="icon">${dayCodeInfo.icon}</span>
                  <span class="temps">${Math.round(fullDailyForecastData.temperature_2m_max[i])}¬∞/${Math.round(fullDailyForecastData.temperature_2m_min[i])}¬∞</span>
                `;
                dayDiv.addEventListener('click', function() {
                  const dayIndex = parseInt(this.dataset.dayIndex);
                  if (fullDailyForecastData) {
                      const daySpecificData = {
                          dateStr: fullDailyForecastData.time[dayIndex],
                          weatherCode: fullDailyForecastData.weather_code[dayIndex],
                          tempMax: fullDailyForecastData.temperature_2m_max[dayIndex],
                          tempMin: fullDailyForecastData.temperature_2m_min[dayIndex],
                          precipSum: fullDailyForecastData.precipitation_sum ? fullDailyForecastData.precipitation_sum[dayIndex] : 'N/A',
                          precipProb: fullDailyForecastData.precipitation_probability_max ? fullDailyForecastData.precipitation_probability_max[dayIndex] : 'N/A',
                          windSpeedMax: fullDailyForecastData.wind_speed_10m_max ? fullDailyForecastData.wind_speed_10m_max[dayIndex] : 'N/A',
                          sunrise: fullDailyForecastData.sunrise ? fullDailyForecastData.sunrise[dayIndex] : 'N/A',
                          sunset: fullDailyForecastData.sunset ? fullDailyForecastData.sunset[dayIndex] : 'N/A',
                          daylightDuration: fullDailyForecastData.daylight_duration ? fullDailyForecastData.daylight_duration[dayIndex] : 'N/A',
                          windDirection: fullDailyForecastData.wind_direction_10m_dominant ? fullDailyForecastData.wind_direction_10m_dominant[dayIndex] : 'N/A'
                      };
                      openForecastModal(daySpecificData, data.timezone, units, speedSuffix, currentApparentTemp, currentHumidity);
                  }
                });
                forecastEl.appendChild(dayDiv);
              }
            } else {
              forecastEl.innerHTML = "<p>No forecast data available.</p>";
            }
          } catch (error) {
            console.error("Weather API fetch error:", error);
            displayErrorInCard(error.message || "Could not fetch weather.");
          } finally {
              if (refreshBtn) {
                  refreshBtn.disabled = false;
                  if (refreshImg) {
                      refreshImg.classList.remove('refreshing');
                      refreshBtn.classList.add('spin-back');
                      refreshImg.addEventListener('animationend', () => {
                          refreshBtn.classList.remove('spin-back');
                          refreshImg.style.transform = '';
                      }, { once: true });
                  }
              }
          }
         }
         
         cardElement.updateWeather = actualFetchAndDisplayWeather;

         async function initializeWeather() {
          currentIconEl.textContent = 'üìç';
          currentConditionEl.textContent = 'Locating...';
          if (locationDisplayEl) locationDisplayEl.textContent = 'Acquiring location...';

          const settingsLoaded = loadWeatherSettings();
          
          if (settingsLoaded) {
              await actualFetchAndDisplayWeather();
              if (navigator.geolocation) {
                  navigator.geolocation.getCurrentPosition(pos => {
                      userCoords = { latitude: pos.coords.latitude, longitude: pos.coords.longitude };
                  }, () => {}, { timeout: 5000, enableHighAccuracy: false });
              }
          } else {
              if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                  async (position) => {
                    userCoords = { latitude: position.coords.latitude, longitude: position.coords.longitude };
                    const { label, country_code } = await fetchCityName(userCoords.latitude, userCoords.longitude);
                    
                    weatherSettings.location = {
                        label: label,
                        latitude: userCoords.latitude,
                        longitude: userCoords.longitude
                    };
                    weatherSettings.units = (country_code === 'us') ? 'imperial' : 'metric';
                    
                    saveWeatherSettings();
                    await actualFetchAndDisplayWeather();
                  },
                  async (error) => {
                    console.warn(`Geolocation error (${error.code}): ${error.message}`);
                    showNotification(`Geolocation failed: ${error.message}. Using default location.`, 'error', 4000);
                    await actualFetchAndDisplayWeather();
                  },
                  { timeout: 10000, enableHighAccuracy: false }
                );
              } else {
                showNotification("Geolocation not available. Using default location.", "info", 4000);
                await actualFetchAndDisplayWeather();
              }
          }
         }

         if (refreshBtn) {
          refreshBtn.addEventListener('click', actualFetchAndDisplayWeather);
         }
         initializeWeather();
         setInterval(actualFetchAndDisplayWeather, 30 * 60 * 1000);
        }
      },
      {
        templateId: 'clock_widget', title: 'Current Time', icon: 'üïí', type: 'medium',
        onMount: (cardElement) => {
          const timeEl = cardElement.querySelector('#clockTime');
          const dateEl = cardElement.querySelector('#clockDate');
          const dayOfYearEl = cardElement.querySelector('#clockDayOfYear');
          const weekNumEl = cardElement.querySelector('#clockWeekNum');

          function updateClock() {
            const now = new Date();
            timeEl.textContent = now.toLocaleTimeString();
            dateEl.textContent = now.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            const start = new Date(now.getFullYear(), 0, 0);
            const diff = (now - start) + ((start.getTimezoneOffset() - now.getTimezoneOffset()) * 60 * 1000);
            const oneDay = 1000 * 60 * 60 * 24;
            const dayOfYear = Math.floor(diff / oneDay);
            if (dayOfYearEl) dayOfYearEl.textContent = `Day: ${dayOfYear}`;

            const tempDate = new Date(now.valueOf());
            tempDate.setDate(tempDate.getDate() + 3 - (tempDate.getDay() + 6) % 7);
            const week1 = new Date(tempDate.getFullYear(), 0, 4);
            const weekNumber = 1 + Math.round(((tempDate.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
            if (weekNumEl) weekNumEl.textContent = `Week: ${weekNumber}`;
          }
          updateClock();
          setInterval(updateClock, 1000);
        }
      },
      {
        templateId: 'stopwatch_widget', title: 'Stopwatch', icon: '‚è±Ô∏è', type: 'small',
        onMount: (cardElement) => {
            const STORAGE_KEY = '4sp_stopwatchState_v4';
            const display = cardElement.querySelector('.stopwatch-display');
            const startBtn = cardElement.querySelector('button[data-action="start"]');
            const pauseBtn = cardElement.querySelector('button[data-action="pause"]');
            const resetBtn = cardElement.querySelector('button[data-action="reset"]');

            let state = { startTime: null, elapsedTime: 0, isRunning: false };
            let intervalId = null;

            function saveState() {
                if (state.isRunning) {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify({
                        startTime: state.startTime,
                        elapsedTime: state.elapsedTime,
                        isRunning: true
                    }));
                } else {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify({
                        startTime: null,
                        elapsedTime: state.elapsedTime,
                        isRunning: false
                    }));
                }
            }
            
            function formatTime(ms) {
                const totalSeconds = Math.floor(ms / 1000);
                const centiseconds = Math.floor((ms % 1000) / 10).toString().padStart(2, '0');

                const weeks = Math.floor(totalSeconds / 604800);
                const days = Math.floor((totalSeconds % 604800) / 86400);
                const hours = Math.floor((totalSeconds % 86400) / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;

                const pad = (num) => num.toString().padStart(2, '0');

                const timePart = `${pad(hours)}:${pad(minutes)}:${pad(seconds)}.${centiseconds}`;

                if (weeks > 0) {
                    return `${weeks}:${pad(days)}:${timePart}`;
                }
                if (days > 0) {
                    return `${days}:${timePart}`;
                }
                return timePart;
            }

            function updateDisplay() {
                const totalElapsed = state.elapsedTime + (state.isRunning ? (Date.now() - state.startTime) : 0);
                display.textContent = formatTime(totalElapsed);
            }
            
            function start() {
                if (state.isRunning) return;
                state.isRunning = true;
                state.startTime = Date.now();
                
                startBtn.style.display = 'none';
                pauseBtn.style.display = 'inline-block';
                
                intervalId = setInterval(updateDisplay, 50);
                saveState();
            }

            function pause() {
                if (!state.isRunning) return;
                clearInterval(intervalId);
                state.elapsedTime += Date.now() - state.startTime;
                state.isRunning = false;

                startBtn.style.display = 'inline-block';
                pauseBtn.style.display = 'none';
                saveState();
            }

            function reset() {
                clearInterval(intervalId);
                state = { startTime: null, elapsedTime: 0, isRunning: false };
                localStorage.removeItem(STORAGE_KEY);
                updateDisplay();
                startBtn.style.display = 'inline-block';
                pauseBtn.style.display = 'none';
            }
            
            function loadState() {
                const saved = JSON.parse(localStorage.getItem(STORAGE_KEY));
                if (!saved) return;
                
                state.elapsedTime = saved.elapsedTime || 0;
                
                if (saved.isRunning && saved.startTime) {
                    const timePassed = Date.now() - saved.startTime;
                    state.elapsedTime += timePassed;
                    start();
                } else {
                    updateDisplay();
                }
            }

            startBtn.addEventListener('click', start);
            pauseBtn.addEventListener('click', pause);
            resetBtn.addEventListener('click', reset);
            
            loadState();
        }
      },
      {
        templateId: 'timer_widget', title: 'Timer', icon: '‚åõ', type: 'small',
        onMount: (cardElement) => {
            const STORAGE_KEY = '4sp_timerState_v4';
            const wInput = cardElement.querySelector('#timer-w');
            const dInput = cardElement.querySelector('#timer-d');
            const hInput = cardElement.querySelector('#timer-h');
            const mInput = cardElement.querySelector('#timer-m');
            const sInput = cardElement.querySelector('#timer-s');
            const display = cardElement.querySelector('.timer-display-value');
            const inputsContainer = cardElement.querySelector('.timer-inputs');
            const startBtn = cardElement.querySelector('button[data-action="start"]');
            const pauseBtn = cardElement.querySelector('button[data-action="pause"]');
            const resetBtn = cardElement.querySelector('button[data-action="reset"]');

            let state = { targetTime: null, remainingTime: 0, isRunning: false };
            let intervalId = null;

            function formatTime(ms) {
                if (ms < 0) ms = 0;
                const totalSeconds = Math.round(ms / 1000);

                const weeks = Math.floor(totalSeconds / 604800);
                const days = Math.floor((totalSeconds % 604800) / 86400);
                const hours = Math.floor((totalSeconds % 86400) / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;

                const pad = (num) => num.toString().padStart(2, '0');

                const timePart = `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;

                if (weeks > 0) {
                    return `${weeks}:${pad(days)}:${timePart}`;
                }
                if (days > 0) {
                    return `${days}:${timePart}`;
                }
                return timePart;
            }

            function updateDisplay() {
                const remaining = state.isRunning ? state.targetTime - Date.now() : state.remainingTime;
                display.textContent = formatTime(remaining);

                if (state.isRunning && remaining <= 0) {
                    finish();
                }
            }

            function updateFromInputs() {
                if (state.isRunning) return;
                const w = parseInt(wInput.value) || 0;
                const d = parseInt(dInput.value) || 0;
                const h = parseInt(hInput.value) || 0;
                const m = parseInt(mInput.value) || 0;
                const s = parseInt(sInput.value) || 0;
                
                const ONE_WEEK_MS = 7 * 24 * 60 * 60 * 1000;
                let totalMs = (w * 7 * 24 * 60 * 60 * 1000) +
                                    (d * 24 * 60 * 60 * 1000) +
                                    (h * 60 * 60 * 1000) +
                                    (m * 60 * 1000) +
                                    (s * 1000);
                
                if (totalMs > ONE_WEEK_MS) {
                    totalMs = ONE_WEEK_MS;
                    wInput.value = 1;
                    dInput.value = 0; hInput.value = 0; mInput.value = 0; sInput.value = 0;
                    showNotification("Timer capped at maximum of 1 week.", "info");
                }

                state.remainingTime = totalMs;
                updateDisplay();
            }

            function toggleUI(isRunning) {
                inputsContainer.classList.toggle('hidden', isRunning);
                startBtn.style.display = isRunning ? 'none' : 'inline-block';
                pauseBtn.style.display = isRunning ? 'inline-block' : 'none';
            }

            function start() {
                if (state.isRunning) return;
                if (state.remainingTime <= 0) {
                    showNotification("Please set a timer duration.", "info");
                    return;
                }
                
                state.isRunning = true;
                state.targetTime = Date.now() + state.remainingTime;
                
                intervalId = setInterval(updateDisplay, 100);
                toggleUI(true);
                localStorage.setItem(STORAGE_KEY, JSON.stringify({ targetTime: state.targetTime }));
            }

            function pause() {
                if (!state.isRunning) return;
                clearInterval(intervalId);
                state.remainingTime = state.targetTime - Date.now();
                state.isRunning = false;
                toggleUI(false);
                localStorage.setItem(STORAGE_KEY, JSON.stringify({ remainingTime: state.remainingTime }));
            }

            function reset() {
                clearInterval(intervalId);
                state.isRunning = false;
                toggleUI(false);
                updateFromInputs();
                localStorage.removeItem(STORAGE_KEY);
            }

            function finish() {
                showNotification('Timer Finished!', 'success');
                try { new Audio('https://interactive-examples.mdn.mozilla.net/media/cc0-audio/bell-ringing-01.mp3').play(); } catch(e) {}
                reset();
            }

            function loadState() {
                const saved = JSON.parse(localStorage.getItem(STORAGE_KEY));
                if (!saved) {
                    updateFromInputs();
                    return;
                };

                if (saved.targetTime) { // Was running
                    state.targetTime = saved.targetTime;
                    state.remainingTime = state.targetTime - Date.now();
                    if (state.remainingTime > 0) {
                        start();
                    } else {
                        reset();
                    }
                } else if (saved.remainingTime) { // Was paused
                    state.remainingTime = saved.remainingTime;
                    updateDisplay();
                }
            }

            [wInput, dInput, hInput, mInput, sInput].forEach(input => {
                input.addEventListener('input', updateFromInputs);
            });
            
            startBtn.addEventListener('click', start);
            pauseBtn.addEventListener('click', pause);
            resetBtn.addEventListener('click', reset);
            
            loadState();
        }
      },
      {
        templateId: 'quick_actions_widget', title: 'Shortcuts', icon: '‚ö°', type: 'small',
        onMount: (cardElement) => {
            const settingsBtn = cardElement.querySelector('.quick-actions-settings-btn');
            const contentContainer = cardElement.querySelector('.quick-actions-list');

            const renderAndAttachListeners = (actions) => {
                contentContainer.innerHTML = actions.map(action => {
                    const sanitizedText = action.text.replace(/"/g, '&quot;');
                    return `
                        <button data-type="${action.type}" data-value="${action.value}">
                            <span class="icon">${action.icon}</span>
                            <span class="text">${action.text}</span>
                            <span class="arrow">‚Üí</span>
                        </button>`;
                }).join('');

                contentContainer.querySelectorAll('button').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const { type, value } = btn.dataset;
                        if (type === 'url') {
                            window.open(value, '_blank');
                        } else if (type === 'page') {
                            const page = pageSuggestions.find(p => p.url === value);
                            if (page && page.action) {
                                page.action(); // For scroll actions
                            } else {
                                window.location.href = value; // For regular pages
                            }
                        }
                    });
                });
            };

            const updateUI = () => {
                const savedActions = localStorage.getItem(QUICK_ACTIONS_STORAGE_KEY);
                currentQuickActions = savedActions ? JSON.parse(savedActions) : [...defaultQuickActions];
                renderAndAttachListeners(currentQuickActions);
            };

            window.updateQuickActionsWidget = updateUI; // So modal can call it
            updateUI(); // Initial render

            if (settingsBtn) {
                settingsBtn.addEventListener('click', () => {
                    populateShortcutModal();
                    shortcutSettingsModal.classList.add('modal-open');
                });
            }
        }
      }
    ];

    function getContentGenerator(templateId) {
        switch (templateId) {
            case 'weather_large_widget': return () => `
                <div class="weather-large-content">
                    <div class="current-weather-layout">
                        <span class="weather-icon-large">‚è≥</span>
                        <div class="current-weather-main-info">
                            <span class="temp-large">--¬∞</span>
                            <span class="condition-large">Loading...</span>
                        </div>
                        <div class="current-weather-details-aside">
                            <p>Feels like: <span class="feels-like-value">--¬∞</span></p>
                            <p>Humidity: <span class="humidity-value">--%</span></p>
                            <p>Wind: <span class="wind-value">--</span></p>
                            <p>Location: <span class="location-large">${weatherSettings.location.label || 'N/A'}</span></p>
                        </div>
                    </div>
                    <div class="forecast-large"></div>
                    <small style="text-align:center; display:block; margin-top:auto; color:#aaa; font-size:0.7em;">Weather by Open-Meteo.com</small>
                </div>`;
            case 'clock_widget': return () => `
                <div class="clock-display" id="clockTime">00:00:00</div>
                <div class="date-display" id="clockDate">Monday, January 1, 2024</div>
                <div class="additional-time-info">
                    <span id="clockDayOfYear">Day: ---</span> | <span id="clockWeekNum">Week: --</span>
                </div>`;
            case 'stopwatch_widget': return () => `
                <div class="stopwatch-display">00:00:00.00</div>
                <div class="controls-flex">
                    <button data-action="start">Start</button>
                    <button data-action="pause" style="display:none;">Pause</button>
                    <button data-action="reset">Reset</button>
                </div>`;
            case 'timer_widget': return () => `
                <div class="timer-display-value">00:00:00</div>
                <div class="timer-inputs">
                    <input type="number" id="timer-w" placeholder="W" min="0" max="1" value="0"> :
                    <input type="number" id="timer-d" placeholder="D" min="0" max="6" value="0"> :
                    <input type="number" id="timer-h" placeholder="HH" min="0" max="23" value="0"> :
                    <input type="number" id="timer-m" placeholder="MM" min="0" max="59" value="0"> :
                    <input type="number" id="timer-s" placeholder="SS" min="0" max="59" value="0">
                </div>
                <div class="controls-flex">
                    <button data-action="start">Start</button>
                    <button data-action="pause" style="display:none;">Pause</button>
                    <button data-action="reset">Reset</button>
                </div>`;
            case 'quick_actions_widget': return () => `
                <div class="quick-actions-list">
                    </div>`;
            default: return () => '';
        }
    }


    // --- Authentication & Initial Load ---
    firebase.auth().onAuthStateChanged(async user => {
      if (!user) {
        return location.href = '../login.html';
      }
      document.getElementById('userEmail').textContent = user.email;
      try {
        const userDocRef = dbRef();
        if (!userDocRef) return;
        const doc = await userDocRef.get();
        const userData = doc.exists ? doc.data() : {};
        userNameEl.textContent = userData.username || user.displayName || 'Welcome User';
        setupFixedDashboardLayout();
        updateMarquees();
        setTimeout(() => {
          document.querySelectorAll('.dashboard-card').forEach((card, index) => {
            card.style.animationDelay = `${index * 0.08}s`;
            card.classList.add('fade-in');
          });
        }, 100);
      } catch (error) {
        console.error('Error loading user data:', error);
        setupFixedDashboardLayout();
      }
    });

    function updateMarquees() {
      marqueeEls.forEach(el => {
        el.classList.remove('marquee-active');
        void el.offsetWidth;
        el.classList.add('marquee-active');
      });
    }

    function createCardDOMElement(template) {
      const newCard = document.createElement('div');
      newCard.classList.add('dashboard-card');
      newCard.dataset.id = `${template.templateId}_${Date.now()}`;
      newCard.dataset.templateId = template.templateId;
      newCard.dataset.cardType = template.type || 'full';
      const header = document.createElement('div');
      header.classList.add('card-header');
      const iconEl = document.createElement('div');
      iconEl.classList.add('card-icon');
      iconEl.textContent = template.icon;
      const titleEl = document.createElement('h4');
      titleEl.classList.add('card-title');
      titleEl.textContent = template.title;
      header.appendChild(iconEl);
      header.appendChild(titleEl);

      const buttonContainer = document.createElement('div');
      buttonContainer.className = 'card-header-buttons';

      if (template.templateId === 'weather_large_widget') {
        const settingsButton = document.createElement('button');
        settingsButton.className = 'weather-action-btn weather-settings-btn';
        settingsButton.title = 'Weather Settings';
        const settingsImg = document.createElement('img');
        settingsImg.src = '../images/gear-dark.png';
        settingsImg.alt = 'Settings';
        settingsButton.appendChild(settingsImg);
        
        const refreshButton = document.createElement('button');
        refreshButton.className = 'weather-action-btn weather-refresh-btn';
        refreshButton.title = 'Refresh Weather';
        const refreshImg = document.createElement('img');
        refreshImg.src = '../images/refresh-dark.png';
        refreshImg.alt = 'Refresh';
        refreshButton.appendChild(refreshImg);

        buttonContainer.appendChild(settingsButton);
        buttonContainer.appendChild(refreshButton);
        header.appendChild(buttonContainer);
      } else if (template.templateId === 'quick_actions_widget') {
          const settingsButton = document.createElement('button');
          settingsButton.className = 'weather-action-btn quick-actions-settings-btn';
          settingsButton.title = 'Edit Shortcuts';
          const settingsImg = document.createElement('img');
          settingsImg.src = '../images/gear-dark.png';
          settingsImg.alt = 'Settings';
          settingsButton.appendChild(settingsImg);
          buttonContainer.appendChild(settingsButton);
          header.appendChild(buttonContainer);
      }
      
      const contentWrapper = document.createElement('div');
      contentWrapper.classList.add('card-content-inner');
      contentWrapper.innerHTML = getContentGenerator(template.templateId)();
      
      newCard.appendChild(header);
      newCard.appendChild(contentWrapper);
      
      if (template.onMount) {
        setTimeout(() => {
          try {
            template.onMount(newCard);
          } catch (e) {
            console.error(`Error during onMount for card ${template.templateId}:`, e);
            const contentInner = newCard.querySelector('.card-content-inner');
            if (contentInner) {
                contentInner.innerHTML = `<p style="color: red; text-align: center; padding: 20px;">Failed to load widget content.</p>`;
            }
          }
        }, 0);
      }
      return newCard;
    }

    function addCardToDashboard(templateId) {
      const template = availableCardTemplates.find(t => t.templateId === templateId);
      if (!template) {
        console.warn(`Template ${templateId} not found.`);
        return;
      }
      const cardDom = createCardDOMElement(template);
      dashboardGrid.appendChild(cardDom);
    }

    function setupFixedDashboardLayout() {
        dashboardGrid.innerHTML = '';
        availableCardTemplates.forEach(template => addCardToDashboard(template.templateId));
    }

    function showNotification(message, type = 'info', duration = 3000) {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      Object.assign(notification.style, {
        position: 'fixed', bottom: '20px', right: '20px', padding: '12px 20px',
        borderRadius: '8px', color: 'white', fontWeight: '600', zIndex: '10000',
        transform: 'translateY(150%)', transition: 'transform 0.4s ease-in-out, background 0.3s',
        boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
        fontFamily: 'PrimaryFont, sans-serif'
      });
      const colors = {
        success: 'linear-gradient(135deg, #28a745, #20c997)',
        error: 'linear-gradient(135deg, #dc3545, #e83e8c)',
        info: 'linear-gradient(135deg, #6720bd, #8a2be2)'
      };
      notification.style.background = colors[type] || colors.info;
      document.body.appendChild(notification);
      setTimeout(() => { notification.style.transform = 'translateY(0)'; }, 100);
      setTimeout(() => {
        notification.style.transform = 'translateY(150%)';
        setTimeout(() => { if (document.body.contains(notification)) document.body.removeChild(notification); }, 400);
      }, duration);
    }

    window.addEventListener('resize', () => { setTimeout(updateMarquees, 300); });
    
    document.addEventListener('DOMContentLoaded', () => {
      document.documentElement.style.scrollBehavior = 'smooth';

      // --- START: Search Bar Logic ---
      const searchInput = document.getElementById('dashboardSearch');
      const suggestionsContainer = document.getElementById('searchSuggestions');
      const searchContainer = document.querySelector('.search-container');

      if (searchInput && suggestionsContainer && searchContainer) {
        searchInput.addEventListener('input', function() {
          const query = this.value.toLowerCase().trim();
          suggestionsContainer.innerHTML = '';

          if (query.length === 0) {
            suggestionsContainer.style.display = 'none';
            return;
          }

          const filteredSuggestions = pageSuggestions.filter(item =>
            item.name.toLowerCase().includes(query)
          );

          if (filteredSuggestions.length > 0) {
            filteredSuggestions.forEach(item => {
              const suggestionElement = document.createElement('a');
              suggestionElement.className = 'suggestion-item';
              suggestionElement.textContent = item.name;
              suggestionElement.href = item.url;

              suggestionElement.addEventListener('click', function(e) {
                if (item.action) {
                  e.preventDefault(); // Prevent navigating to '#'
                  item.action();
                  suggestionsContainer.style.display = 'none';
                  searchInput.value = ''; // Optional: clear input after action
                }
              });

              suggestionsContainer.appendChild(suggestionElement);
            });
            suggestionsContainer.style.display = 'block';
          } else {
            suggestionsContainer.style.display = 'none';
          }
        });

        // Hide suggestions when clicking anywhere else on the page
        document.addEventListener('click', function(event) {
          if (!searchContainer.contains(event.target)) {
            suggestionsContainer.style.display = 'none';
          }
        });
      }
      // --- END: Search Bar Logic ---
      
      // --- START: Battery Status Logic ---
      const batteryStatusContainer = document.getElementById('battery-status');
      const chargingStatusEl = document.getElementById('battery-charging-status');
      const levelEl = document.getElementById('battery-level');

      function updateBatteryUI(battery) {
          if (!batteryStatusContainer || !chargingStatusEl || !levelEl) return;

          batteryStatusContainer.style.display = 'flex';

          chargingStatusEl.textContent = battery.charging ? '‚ö° Charging' : 'üîã Discharging';
          if (battery.charging) {
              batteryStatusContainer.classList.add('charging');
          } else {
              batteryStatusContainer.classList.remove('charging');
          }
          
          const percentage = Math.floor(battery.level * 100);
          levelEl.textContent = `Percentage: ${percentage}%`;

          levelEl.classList.remove('low', 'critical', 'very-critical');
          if (percentage <= 3) {
              levelEl.classList.add('very-critical');
          } else if (percentage <= 10) {
              levelEl.classList.add('critical');
          } else if (percentage <= 20) {
              levelEl.classList.add('low');
          }
      }

      if ('getBattery' in navigator) {
          navigator.getBattery().then(battery => {
              updateBatteryUI(battery);
              battery.addEventListener('chargingchange', () => updateBatteryUI(battery));
              battery.addEventListener('levelchange', () => updateBatteryUI(battery));
          }).catch(err => {
              console.error('Battery API could not be accessed:', err);
              if (batteryStatusContainer) batteryStatusContainer.style.display = 'none';
          });
      } else {
        if (batteryStatusContainer) batteryStatusContainer.style.display = 'none';
¬† ¬† ¬† }
¬† ¬† ¬† // --- END: Battery Status Logic ---

¬† ¬† ¬† // Logout and Sidebar Logic
¬† ¬† ¬† document.getElementById('logoutBtn').addEventListener('click', () => {
¬† ¬† ¬† ¬† firebase.auth().signOut();
¬† ¬† ¬† });
¬† ¬† ¬† document.getElementById('signOutLink').addEventListener('click', (e) => {
¬† ¬† ¬† ¬† e.preventDefault();
¬† ¬† ¬† ¬† firebase.auth().signOut();
¬† ¬† ¬† });
¬† ¬† ¬† const sidebar = document.getElementById('sidebar');
¬† ¬† ¬† document.getElementById('toggleSidebar').addEventListener('click', () => {
¬† ¬† ¬† ¬† sidebar.classList.toggle('collapsed');
¬† ¬† ¬† ¬† updateMarquees();
¬† ¬† ¬† });
¬† ¬† });
¬† </script>

</body>
</html>
