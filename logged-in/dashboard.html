<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>4SP - DASHBOARD</title>
  <link rel="stylesheet" href="../css/style.css" />
  <style>
    /* --- Dashboard Layout --- */
    body.dashboard-page {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      margin: 0;
      font-family: 'PrimaryFont', sans-serif;
    }
    .dashboard-container {
      display: flex;
      flex: 1;
    }

    /* --- Sidebar: full / collapsed --- */
    .sidebar {
      width: 200px;
      background: linear-gradient(180deg, #333 0%, #2a2a2a 100%);
      color: #fff;
      padding: 20px 10px;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #444;
      transition: width 0.5s ease-in-out;
      position: relative;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }
    .sidebar.collapsed {
      width: 85px;
    }
    #toggleSidebar {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: none;
      border: none;
      color: #fff;
      font-size: 1.2em;
      cursor: pointer;
      padding: 4px;
      transition: transform 0.5s ease-in-out;
    }
    .sidebar.collapsed #toggleSidebar {
      transform: translateX(-50%) rotate(180deg);
    }

    /* --- Sidebar Navigation --- */
    .sidebar nav ul { list-style: none; padding: 0; margin: 60px 0 0; }
    .sidebar nav li { margin-bottom: 10px; }
    .sidebar nav a {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      color: #fff;
      text-decoration: none;
      border-radius: 8px;
      transition: all 0.3s ease;
      font-family: 'PrimaryFont', sans-serif;
      text-transform: uppercase;
      position: relative;
      overflow: hidden;
    }
    .sidebar nav a::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transition: left 0.5s;
    }
    .sidebar nav a:hover::before {
      left: 100%;
    }
    .sidebar nav a.active,
    .sidebar nav a:hover {
      background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
      transform: translateX(5px);
    }
    .sidebar nav a .icon {
      font-size: 1.2em;
      width: 24px;
      text-align: center;
    }
    .sidebar nav a .label {
      margin-left: 10px;
      white-space: nowrap;
    }
    .sidebar.collapsed nav a {
      justify-content: center;
      padding: 10px 0;
    }
    .sidebar.collapsed nav a .label {
      display: none;
    }

    /* --- User Info & Marquee --- */
    .user-info {
      text-align: center;
      margin: 60px 0 30px;
      border-bottom: 1px solid #555;
      padding-bottom: 20px;
      overflow: visible;
    }
    .marquee-container {
      overflow: hidden;
      white-space: nowrap;
      position: relative;
      width: 100%;
      height: 1.8em;
      line-height: 1.8em;
    }
    .marquee-content {
      display: inline-block;
      padding-left: 100%;
      transform: translateX(0);
      animation: none;
      line-height: 1.8em;
    }
    .marquee-active {
      animation: scroll-left 12s linear infinite;
    }
    .sidebar.collapsed .marquee-active {
      animation-duration: 20s;
    }
    @keyframes scroll-left {
      0%   { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }
    .user-info .username {
      font-family: 'PrimaryFont', sans-serif;
      font-size: 1.3em;
      margin-bottom: 8px;
      line-height: 0.2em;
      font-weight: bold;
    }
    .user-info .email {
      font-family: 'SecondaryFont', sans-serif;
      font-size: 0.9em;
      color: #bbb;
    }

    /* --- Main Content & Controls --- */
    .main-content {
      flex: 1;
      padding: 40px;
      background: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
      overflow-y: auto;
      position: relative;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 40px;
      background: white;
      padding: 20px 30px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      border: 1px solid rgba(103, 32, 189, 0.1);
    }

    .dashboard-title {
      margin: 0;
      font-size: 2.2em;
      font-weight: bold;
      background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .dashboard-controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .control-btn {
      background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
      border: none;
      color: #fff;
      padding: 10px 18px;
      border-radius: 15px;
      font-family: 'PrimaryFont', sans-serif;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9em;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: relative;
      overflow: hidden;
    }

    .control-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    .control-btn:hover::before {
      left: 100%;
    }

    .control-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(103, 32, 189, 0.3);
    }

    .control-btn.secondary {
      background: linear-gradient(135deg, #555 0%, #777 100%);
    }
    #addCardBtn { /* Specific styling if needed for the add button */
        background: linear-gradient(135deg, #17a2b8 0%, #1f95a3 100%);
    }
    #addCardBtn:hover {
        box-shadow: 0 8px 25px rgba(23, 162, 184, 0.3);
    }


    .control-btn.secondary:hover {
      box-shadow: 0 8px 25px rgba(85, 85, 85, 0.3);
    }

    /* --- Dashboard Grid System --- */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 25px;
      position: relative;
      transition: all 0.3s ease;
    }

    .dashboard-grid.editing::before {
      content: '';
      position: absolute;
      top: -12px;
      left: -12px;
      right: -12px;
      bottom: -12px;
      background-image:
        linear-gradient(rgba(103,32,189,0.10) 1px, transparent 1px),
        linear-gradient(90deg, rgba(103,32,189,0.10) 1px, transparent 1px);
      background-size: 60px 60px;
      opacity: 0;
      transition: opacity 0.3s ease-in-out;
      pointer-events: none;
      z-index: 0;
      border-radius: 10px;
    }

    .dashboard-grid.editing.edit-active::before { opacity: 0.4; }
    .dashboard-grid.editing.dragging-active::before { opacity: 0.7; }


    /* --- Enhanced Dashboard Cards --- */
    .dashboard-card {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 6px 30px rgba(0,0,0,0.08);
      border: 1px solid rgba(103, 32, 189, 0.1);
      cursor: pointer;
      /* transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); Remove to let JS handle transform/opacity animations */
      position: relative;
      overflow: hidden;
      user-select: none;
      z-index: 2;
      display: flex;
      flex-direction: column;
      min-height: 200px;
    }

    .dashboard-card::before { /* Hover shine effect */
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(103, 32, 189, 0.05), transparent);
      transition: left 0.6s ease;
    }

    .dashboard-card:hover::before { left: 100%; }

    .dashboard-card:hover:not(.dragging) { /* Hover scale effect, not when dragging */
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 15px 40px rgba(103, 32, 189, 0.15);
      border-color: rgba(103, 32, 189, 0.3);
       transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                  box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                  border-color 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .dashboard-grid.editing .dashboard-card {
      cursor: grab;
      border: 2px dashed rgba(103, 32, 189, 0.3);
    }

    .dashboard-card.dragging { /* Base style for dragging, animation overrides transform/opacity */
      cursor: grabbing;
      z-index: 1000;
      box-shadow: 0 20px 50px rgba(0,0,0,0.25);
      /* opacity and transform are handled by popUp animation */
    }

    @keyframes popUp {
        0% { transform: scale(1) rotate(0deg); opacity: 1; }
        100% { transform: scale(1.05) rotate(3deg); opacity: 0.7; }
    }
    @keyframes settleDown {
        0% { transform: scale(1.05) rotate(3deg); opacity: 0.7; }
        100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }


    .dashboard-card-placeholder {
      background-color: rgba(103, 32, 189, 0.08);
      border: 2px dashed rgba(103, 32, 189, 0.5);
      border-radius: 20px;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(103, 32, 189, 0.7);
      font-style: italic;
      transition: height 0.2s ease-out, opacity 0.2s ease-out;
      z-index: 1;
    }


    .card-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid rgba(103, 32, 189, 0.1);
    }
    .card-icon {
      font-size: 2.5em;
      margin-right: 15px;
      background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      filter: drop-shadow(0 2px 4px rgba(103, 32, 189, 0.2));
    }
    .card-title { font-size: 1.6em; font-weight: bold; margin: 0; color: #333; }
    .card-description { color: #666; font-size: 1em; line-height: 1.6; margin-bottom: 20px; flex-grow: 1; }
    .card-stats { display: flex; justify-content: space-between; margin-top: auto; padding-top: 15px; border-top: 1px solid rgba(0,0,0,0.05); }
    .stat-item { text-align: center; flex: 1; }
    .stat-value { font-size: 1.8em; font-weight: bold; color: #6720bd; display: block; }
    .stat-label { font-size: 0.8em; color: #999; text-transform: uppercase; letter-spacing: 0.5px; }
    .card-badge { position: absolute; top: 15px; right: 15px; background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.75em; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }

    /* --- Quick Actions Section --- */
    .quick-actions { background: white; border-radius: 20px; padding: 25px; margin-bottom: 30px; box-shadow: 0 6px 30px rgba(0,0,0,0.08); border: 1px solid rgba(103, 32, 189, 0.1); }
    .quick-actions h3 { margin: 0 0 20px 0; font-size: 1.4em; color: #333; display: flex; align-items: center; }
    .quick-actions h3::before { content: '‚ö°'; margin-right: 10px; font-size: 1.2em; }
    .action-buttons { display: flex; gap: 15px; flex-wrap: wrap; }
    .action-btn { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 2px solid rgba(103, 32, 189, 0.2); color: #6720bd; padding: 12px 20px; border-radius: 15px; font-family: 'PrimaryFont', sans-serif; cursor: pointer; transition: all 0.3s ease; font-weight: 600; display: flex; align-items: center; gap: 8px; }
    .action-btn:hover { background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%); color: white; transform: translateY(-2px); box-shadow: 0 8px 25px rgba(103, 32, 189, 0.3); }

    /* --- Add Card Modal Styles --- */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.6);
      animation: fadeInModal 0.3s ease-out;
    }
    @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }

    .modal-content {
      background-color: #fefefe;
      margin: 8% auto; /* More top margin */
      padding: 25px;
      border: 1px solid #888;
      width: 70%;
      max-width: 900px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      position: relative;
    }
    .close-button {
      color: #aaa;
      position: absolute;
      top: 15px;
      right: 25px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close-button:hover, .close-button:focus { color: #333; text-decoration: none; }
    .modal-content h2 { margin-top:0; color: #6720bd; text-align: center; margin-bottom: 20px;}
    .modal-body { display: flex; max-height: 60vh; } /* Limit height of body */
    .modal-sidebar {
      width: 220px; /* Slightly wider */
      padding-right: 20px;
      border-right: 1px solid #eee;
      overflow-y: auto; /* Scroll if categories exceed height */
    }
    .modal-sidebar h3 { margin-top: 0; color: #333; margin-bottom: 15px; }
    .modal-sidebar ul { list-style: none; padding: 0; }
    .modal-sidebar li {
      padding: 10px 12px; /* More padding */
      cursor: pointer;
      border-radius: 8px; /* More rounded */
      margin-bottom: 8px;
      color: #555;
      transition: background-color 0.2s, color 0.2s;
      font-size: 0.95em;
    }
    .modal-sidebar li:hover, .modal-sidebar li.active {
      background-color: #6720bd;
      color: white;
    }
    .modal-card-selection {
      flex: 1;
      padding-left: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); /* Slightly wider mini cards */
      gap: 20px;
      overflow-y: auto; /* Scroll if cards exceed height */
    }
    .mini-card {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      background-color: #fff;
      transition: transform 0.2s, box-shadow 0.2s;
      display: flex; /* For better alignment */
      flex-direction: column;
      justify-content: center; /* Center content vertically */
      min-height: 120px; /* Ensure consistent height */
    }
    .mini-card:hover {
      transform: translateY(-5px) scale(1.03);
      box-shadow: 0 8px 15px rgba(103, 32, 189, 0.15);
      border-color: #6720bd;
    }
    .mini-card .icon { font-size: 2.2em; margin-bottom: 10px; display: block; color: #6720bd; }
    .mini-card h4 { margin: 0 0 8px 0; font-size: 1.1em; color: #333;}
    .mini-card p { font-size: 0.85em; color: #777; margin: 0; line-height: 1.3;}


    /* --- Responsive Design --- */
    @media (max-width: 768px) {
      .dashboard-grid { grid-template-columns: 1fr; }
      .dashboard-header { flex-direction: column; gap: 20px; text-align: center; }
      .dashboard-controls { justify-content: center; }
      .main-content { padding: 20px; }
      .modal-content { width: 90%; margin: 15% auto; }
      .modal-body { flex-direction: column; max-height: 70vh;}
      .modal-sidebar { width: 100%; border-right: none; border-bottom: 1px solid #eee; padding-right: 0; margin-bottom:15px; max-height: 150px;}
      .modal-card-selection { padding-left: 0; }
    }

    /* --- Animation Classes --- */
    .fade-in { animation: fadeIn 0.6s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .slide-in { animation: slideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
    @keyframes slideIn { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  </style>
</head>

<body class="dashboard-page">
  <header class="main-header light-bg">
    <div class="container">
      <div class="logo">
        <a href="../index.html">
          <img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer"/>
        </a>
      </div>
      <div class="auth-buttons">
        <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button>
        <button id="logoutBtn" class="btn btn-login">LOG OUT</button>
      </div>
    </div>
  </header>

  <div class="dashboard-container">
    <aside class="sidebar slide-in" id="sidebar">
      <button id="toggleSidebar">‚ò∞</button>
      <div class="user-info">
        <div class="marquee-container"><span id="userName" class="marquee-content username">Loading‚Ä¶</span></div>
        <div class="marquee-container"><span id="userEmail" class="marquee-content email">Loading‚Ä¶</span></div>
      </div>
      <nav>
        <ul>
          <li><a href="dashboard.html" class="active"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
          <li><a href="proxies.html"><span class="icon">üõ°Ô∏è</span><span class="label">Proxies</span></a></li>
          <li><a href="soundboard.html"><span class="icon">üéµ</span><span class="label">Soundboard</span></a></li>
          <li><a href="games.html"><span class="icon">üéÆ</span><span class="label">Games</span></a></li>
          <li><a href="others.html"><span class="icon">‚ú®</span><span class="label">Others</span></a></li>
          <li><a href="settings.html"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a></li>
          <li><a href="#" id="signOutLink"><span class="icon">üîí</span><span class="label">LOG OUT</span></a></li>
        </ul>
      </nav>
    </aside>

    <main class="main-content fade-in">
      <div class="dashboard-header">
        <h2 class="dashboard-title">Dashboard</h2>
        <div class="dashboard-controls">
          <button id="addCardBtn" class="control-btn">+ Add Card</button>
          <button id="resetLayoutBtn" class="control-btn secondary">Reset Layout</button>
          <button id="editDashboard" class="control-btn">Edit Layout</button>
        </div>
      </div>

      <div class="quick-actions">
        <h3>Quick Actions</h3>
        <div class="action-buttons">
          <button class="action-btn" onclick="window.location.href='proxies.html'"><span>üõ°Ô∏è</span> Launch Proxy</button>
          <button class="action-btn" onclick="window.location.href='games.html'"><span>üéÆ</span> Play Games</button>
          <button class="action-btn" onclick="window.location.href='soundboard.html'"><span>üéµ</span> Open Soundboard</button>
          <button class="action-btn" onclick="window.location.href='settings.html'"><span>‚öôÔ∏è</span> Settings</button>
        </div>
      </div>

      <div class="dashboard-grid" id="dashboardGrid">
        <div class="dashboard-card" data-id="proxies" data-page="proxies.html">
          <div class="card-badge">Active</div><div class="card-header"><div class="card-icon">üõ°Ô∏è</div><h4 class="card-title">Proxies</h4></div>
          <p class="card-description">Secure web Browse through encrypted proxy servers. Access blocked content safely and anonymously.</p>
          <div class="card-stats"><div class="stat-item"><span class="stat-value">24</span><span class="stat-label">Servers</span></div><div class="stat-item"><span class="stat-value">99.9%</span><span class="stat-label">Uptime</span></div><div class="stat-item"><span class="stat-value">Fast</span><span class="stat-label">Speed</span></div></div>
        </div>
        <div class="dashboard-card" data-id="soundboard" data-page="soundboard.html">
          <div class="card-badge">New</div><div class="card-header"><div class="card-icon">üéµ</div><h4 class="card-title">Soundboard</h4></div>
          <p class="card-description">Interactive audio experience with a collection of sound effects, music, and audio clips for entertainment.</p>
          <div class="card-stats"><div class="stat-item"><span class="stat-value">150+</span><span class="stat-label">Sounds</span></div><div class="stat-item"><span class="stat-value">8</span><span class="stat-label">Categories</span></div><div class="stat-item"><span class="stat-value">HD</span><span class="stat-label">Quality</span></div></div>
        </div>
        <div class="dashboard-card" data-id="games" data-page="games.html">
          <div class="card-badge">Popular</div><div class="card-header"><div class="card-icon">üéÆ</div><h4 class="card-title">Games</h4></div>
          <p class="card-description">Extensive collection of browser-based games including classics, puzzles, and modern titles for endless entertainment.</p>
          <div class="card-stats"><div class="stat-item"><span class="stat-value">500+</span><span class="stat-label">Games</span></div><div class="stat-item"><span class="stat-value">12</span><span class="stat-label">Genres</span></div><div class="stat-item"><span class="stat-value">Free</span><span class="stat-label">Play</span></div></div>
        </div>
        <div class="dashboard-card" data-id="others" data-page="others.html">
          <div class="card-header"><div class="card-icon">‚ú®</div><h4 class="card-title">Others</h4></div>
          <p class="card-description">Additional tools and utilities including calculators, converters, and other helpful applications for productivity.</p>
          <div class="card-stats"><div class="stat-item"><span class="stat-value">25+</span><span class="stat-label">Tools</span></div><div class="stat-item"><span class="stat-value">Daily</span><span class="stat-label">Updated</span></div><div class="stat-item"><span class="stat-value">Useful</span><span class="stat-label">Features</span></div></div>
        </div>
        <div class="dashboard-card" data-id="settings" data-page="settings.html">
          <div class="card-header"><div class="card-icon">‚öôÔ∏è</div><h4 class="card-title">Settings</h4></div>
          <p class="card-description">Customize your experience with personal preferences, account management, and system configuration options.</p>
          <div class="card-stats"><div class="stat-item"><span class="stat-value">Profile</span><span class="stat-label">Manage</span></div><div class="stat-item"><span class="stat-value">Theme</span><span class="stat-label">Customize</span></div><div class="stat-item"><span class="stat-value">Privacy</span><span class="stat-label">Control</span></div></div>
        </div>
      </div>
      <p style="text-align: center; color: #666; margin-top: 40px; font-style: italic;">Drag cards to rearrange. Use "Edit Layout" for customization. Click "+ Add Card" for more widgets.</p>
    </main>
  </div>

  <div id="addCardModal" class="modal">
    <div class="modal-content">
      <span class="close-button" id="closeModalBtn">&times;</span>
      <h2>Add New Card to Dashboard</h2>
      <div class="modal-body">
        <aside class="modal-sidebar">
          <h3>Categories</h3>
          <ul id="cardCategories">
            <li data-category="all" class="active">All Widgets</li>
            <li data-category="info">Info Widgets</li>
            <li data-category="tools">Productivity Tools</li>
            <li data-category="media">Media Players</li>
            <li data-category="fun">Fun Stuff</li>
          </ul>
        </aside>
        <main class="modal-card-selection" id="miniCardContainer">
          </main>
      </div>
    </div>
  </div>


  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="../firebase-config.js"></script>
  <script>
    const dbRef = () => db.collection('users').doc(firebase.auth().currentUser.uid);
    let editMode = false;
    let draggedElement = null;
    let placeholderElement = null;
    let touchStartY = 0;
    let touchStartX = 0;

    const marqueeEls = document.querySelectorAll('.marquee-content');
    const dashboardGrid = document.getElementById('dashboardGrid');
    const editBtn = document.getElementById('editDashboard');
    const addCardBtnElement = document.getElementById('addCardBtn'); // Renamed to avoid conflict
    const resetLayoutBtn = document.getElementById('resetLayoutBtn');

    // --- Add Card Modal Elements ---
    const addCardModal = document.getElementById('addCardModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const miniCardContainer = document.getElementById('miniCardContainer');
    const cardCategoriesList = document.getElementById('cardCategories');

    const availableCardTemplates = [
        { templateId: 'weather_widget', title: 'Weather', icon: '‚òÄÔ∏è', description: 'Live weather updates for your chosen city.', category: 'info', htmlContent: '<p>Configure weather widget...</p>', stats: [{value:'24¬∞C', label:'Temp'}, {value:'City', label:'Now'}] },
        { templateId: 'world_clock', title: 'World Clock', icon: '‚è∞', description: 'Keep track of different time zones.', category: 'info', htmlContent: '<p>Clock display here...</p>', stats: [{value:'Local', label:'Time'}] },
        { templateId: 'notes_padas', title: 'Quick Notes', icon: 'üìù', description: 'A simple pad for your thoughts.', category: 'tools', htmlContent: '<textarea style="width:95%; height: 80px; border: 1px solid #eee; border-radius:5px; padding:8px; font-family: inherit; margin-top:5px;" placeholder="Type here..."></textarea>', stats: [] },
        { templateId: 'rss_feedsa', title: 'RSS Feed', icon: 'üì∞', description: 'Latest headlines from your favorite source.', category: 'info', htmlContent: '<p>RSS feed content...</p>', stats: [{value:'5', label:'New'}] },
        { templateId: 'calc_tool', title: 'Calculator', icon: 'üßÆ', description: 'For quick calculations.', category: 'tools', htmlContent: '<p>Calculator UI...</p>', stats: [] },
        { templateId: 'music_player', title: 'Music Player', icon: 'üéß', description: 'Mini music player widget.', category: 'media', htmlContent: '<p>Music controls...</p>', stats: [{value:'Paused', label:'State'}] },
        { templateId: 'image_gallery', title: 'Image Gallery', icon: 'üñºÔ∏è', description: 'Small image slideshow.', category: 'media', htmlContent: '<p>Gallery placeholder...</p>', stats: [] },
        { templateId: 'daily_quote', title: 'Daily Quote', icon: '‚ùù‚ùû', description: 'Get inspired daily.', category: 'fun', htmlContent: '<p>Quote of the day...</p>', stats: [] },
    ];


    firebase.auth().onAuthStateChanged(async user => { /* ... (existing auth logic) ... */
      if (!user) { return location.href = '../login.html'; }
      document.getElementById('userEmail').textContent = user.email;
      try {
        const doc = await dbRef().get();
        const userData = doc.exists ? doc.data() : {};
        document.getElementById('userName').textContent = userData.username || user.displayName || 'Welcome User';
        if (userData.dashboardLayout) {
          // IMPORTANT: For full custom card persistence, loadSavedLayout would need to dynamically create cards
          // For now, it only reorders existing HTML cards. Custom cards added via UI are session-only.
          loadSavedLayout(userData.dashboardLayout);
        }
        updateMarquees();
        setTimeout(() => {
          document.querySelectorAll('.dashboard-card').forEach((card, index) => {
            card.style.animationDelay = `${index * 0.1}s`;
            card.classList.add('fade-in');
          });
        }, 300);
      } catch (error) { console.error('Error loading user data:', error); }
    });

    const handleLogout = () => { /* ... (existing logout logic) ... */
        firebase.auth().signOut().then(() => location.href = '../login.html').catch(error => console.error('Logout error:', error));
    };
    document.getElementById('logoutBtn').onclick = handleLogout;
    document.getElementById('signOutLink').onclick = handleLogout;

    const toggleSidebarBtn = document.getElementById('toggleSidebar');
    const sidebar = document.getElementById('sidebar');
    toggleSidebarBtn.addEventListener('click', () => { /* ... (existing sidebar toggle) ... */
        sidebar.classList.toggle('collapsed');
        setTimeout(updateMarquees, 550);
    });

    editBtn.addEventListener('click', () => {
      editMode = !editMode;
      dashboardGrid.classList.toggle('editing', editMode);
      dashboardGrid.classList.toggle('edit-active', editMode);
      editBtn.textContent = editMode ? 'Save Layout' : 'Edit Layout';
      editBtn.classList.toggle('secondary', !editMode); // Add secondary when NOT editing (Save button is primary)
      if (editMode) {
        showEditingHints();
      } else {
        hideEditingHints();
        removeDragPlaceholder();
        saveLayout();
      }
    });

    // --- Add Card Modal Logic ---
    function openAddCardModal() {
        populateMiniCards('all');
        addCardModal.style.display = 'block';
        document.body.style.overflow = 'hidden'; // Prevent background scroll
    }
    function closeAddCardModal() {
        addCardModal.style.display = 'none';
        document.body.style.overflow = '';
    }
    addCardBtnElement.addEventListener('click', openAddCardModal);
    closeModalBtn.addEventListener('click', closeAddCardModal);
    window.addEventListener('click', (event) => { // Close modal if clicked outside
        if (event.target == addCardModal) {
            closeAddCardModal();
        }
    });

    function populateMiniCards(filterCategory = 'all') {
        miniCardContainer.innerHTML = '';
        availableCardTemplates
            .filter(card => filterCategory === 'all' || card.category === filterCategory)
            .forEach(template => {
                const mini = document.createElement('div');
                mini.classList.add('mini-card');
                mini.dataset.templateId = template.templateId;
                mini.innerHTML = `
                    <span class="icon">${template.icon}</span>
                    <h4>${template.title}</h4>
                    <p>${template.description.substring(0, 40)}...</p>
                `;
                mini.addEventListener('click', () => addCardToDashboard(template.templateId));
                miniCardContainer.appendChild(mini);
            });
    }

    cardCategoriesList.addEventListener('click', (e) => {
        if (e.target.tagName === 'LI') {
            const currentActive = cardCategoriesList.querySelector('li.active');
            if(currentActive) currentActive.classList.remove('active');
            e.target.classList.add('active');
            populateMiniCards(e.target.dataset.category);
        }
    });

    function addCardToDashboard(templateId) {
        const template = availableCardTemplates.find(t => t.templateId === templateId);
        if (!template) return;
        closeAddCardModal();

        const newCard = document.createElement('div');
        const newCardId = `custom_${template.templateId}_${Date.now()}`;
        newCard.classList.add('dashboard-card');
        newCard.dataset.id = newCardId;
        newCard.dataset.templateId = template.templateId;

        let statsHTML = '';
        if (template.stats && template.stats.length > 0) {
            statsHTML = '<div class="card-stats">';
            template.stats.forEach(stat => {
                statsHTML += `<div class="stat-item"><span class="stat-value">${stat.value}</span><span class="stat-label">${stat.label}</span></div>`;
            });
            statsHTML += '</div>';
        }

        newCard.innerHTML = `
            ${template.badge ? `<div class="card-badge">${template.badge}</div>` : ''}
            <div class="card-header">
                <div class="card-icon">${template.icon}</div>
                <h4 class="card-title">${template.title}</h4>
            </div>
            <p class="card-description">${template.htmlContent || template.description}</p>
            ${statsHTML}
        `;

        newCard.style.opacity = '0';
        newCard.style.transform = 'scale(0.5)';
        dashboardGrid.appendChild(newCard);

        newCard.draggable = true;
        newCard.addEventListener('dragstart', handleDragStart);
        newCard.addEventListener('dragend', handleDragEnd);
        newCard.addEventListener('touchstart', handleTouchStart, { passive: false });
        newCard.addEventListener('touchmove', handleTouchMove, { passive: false });
        newCard.addEventListener('touchend', handleTouchEnd);
        newCard.addEventListener('touchcancel', handleTouchEnd);

        requestAnimationFrame(() => {
            newCard.style.transition = 'opacity 0.4s ease, transform 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28)';
            newCard.style.opacity = '1';
            newCard.style.transform = 'scale(1)';
            newCard.addEventListener('transitionend', () => newCard.style.transition = '', {once: true});
        });
        showNotification(`"${template.title}" added. Save layout to persist changes.`, 'success', 4000);
    }


    resetLayoutBtn.addEventListener('click', () => { /* ... (existing reset logic) ... */
        if (confirm('Are you sure you want to reset your dashboard layout to default? This will remove any unsaved custom cards.')) {
            resetToDefaultLayout();
        }
    });

    function ensureDragPlaceholder() { /* ... (existing placeholder logic) ... */
        if (!placeholderElement) {
            placeholderElement = document.createElement('div');
            placeholderElement.classList.add('dashboard-card-placeholder');
        }
        if (draggedElement) {
            placeholderElement.style.height = `${draggedElement.offsetHeight}px`;
        } else {
            placeholderElement.style.minHeight = '200px';
        }
        return placeholderElement;
    }
    function removeDragPlaceholder() { /* ... (existing placeholder logic) ... */
        if (placeholderElement && placeholderElement.parentNode) {
            placeholderElement.parentNode.removeChild(placeholderElement);
        }
    }

    function initializeDragAndDrop() { /* ... (existing init D&D) ... */
        document.querySelectorAll('.dashboard-card').forEach(card => {
            card.draggable = true;
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);
            card.addEventListener('touchstart', handleTouchStart, { passive: false });
            card.addEventListener('touchmove', handleTouchMove, { passive: false });
            card.addEventListener('touchend', handleTouchEnd);
            card.addEventListener('touchcancel', handleTouchEnd);
            card.addEventListener('click', (e) => {
              if (!editMode && card.dataset.page && !draggedElement) {
                window.location.href = card.dataset.page;
              }
            });
        });
        dashboardGrid.addEventListener('dragover', handleDragOver);
        dashboardGrid.addEventListener('drop', handleDrop);
    }

    function handleDragStart(e) {
        if (!editMode) { e.preventDefault(); return; }
        draggedElement = e.target.closest('.dashboard-card');
        if (!draggedElement) { e.preventDefault(); return; }

        draggedElement.classList.add('dragging'); // For z-index, cursor
        draggedElement.style.animation = 'popUp 0.3s ease forwards';

        dashboardGrid.classList.add('dragging-active');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', draggedElement.dataset.id);
    }

    function handleDragEnd(e) {
        if (draggedElement) { // If drag was cancelled and not handled by drop
            if(draggedElement.style.animation.includes('popUp')) { // Check if it's still "popped"
                draggedElement.style.animation = 'settleDown 0.3s ease-out forwards';
                draggedElement.addEventListener('animationend', () => {
                    draggedElement.classList.remove('dragging');
                    if(draggedElement.style.animation.includes('settleDown')) draggedElement.style.animation = '';
                    draggedElement = null;
                }, { once: true });
            } else { // It was likely handled by drop, or never fully started
                 draggedElement.classList.remove('dragging');
                 draggedElement = null;
            }
        }
        removeDragPlaceholder();
        dashboardGrid.classList.remove('dragging-active');
    }

    function handleDragOver(e) { /* ... (existing dragover with placeholder) ... */
        if (!editMode || !draggedElement) return;
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        const ph = ensureDragPlaceholder();
        const afterElement = getDragAfterElement(dashboardGrid, e.clientY);
        if (afterElement == null) {
            if (dashboardGrid.lastChild !== ph) dashboardGrid.appendChild(ph);
        } else {
            if (afterElement !== ph) dashboardGrid.insertBefore(ph, afterElement);
        }
    }

    function handleDrop(e) {
        e.preventDefault();
        if (!editMode || !draggedElement || !placeholderElement || !placeholderElement.parentNode) {
            removeDragPlaceholder(); return;
        }
        placeholderElement.parentNode.replaceChild(draggedElement, placeholderElement);

        if (draggedElement) {
            draggedElement.classList.remove('dragging'); // Remove for non-animation styles
            draggedElement.style.animation = 'settleDown 0.3s ease-out forwards';
            draggedElement.addEventListener('animationend', () => {
                if(draggedElement.style.animation.includes('settleDown')) draggedElement.style.animation = '';
            }, { once: true });
        }
        // dragEnd will nullify draggedElement and clean up other classes
    }

    function handleTouchStart(e) { /* ... (Similar to dragStart, apply popUp) ... */
        if (!editMode) return;
        draggedElement = e.target.closest('.dashboard-card');
        if (!draggedElement) return;
        e.preventDefault();
        const touch = e.touches[0];
        touchStartX = touch.clientX; touchStartY = touch.clientY;
        draggedElement.classList.add('dragging');
        draggedElement.style.animation = 'popUp 0.3s ease forwards';
        dashboardGrid.classList.add('dragging-active');
    }
    function handleTouchMove(e) { /* ... (Similar to dragOver) ... */
        if (!editMode || !draggedElement) return;
        e.preventDefault();
        const touch = e.touches[0];
        const ph = ensureDragPlaceholder();
        const afterElement = getDragAfterElement(dashboardGrid, touch.clientY);
        if (afterElement == null) {
            if (dashboardGrid.lastChild !== ph) dashboardGrid.appendChild(ph);
        } else {
            if (afterElement !== ph) dashboardGrid.insertBefore(ph, afterElement);
        }
    }
    function handleTouchEnd(e) { /* ... (Similar to drop & dragEnd combined) ... */
        if (!editMode || !draggedElement) {
            if (placeholderElement && placeholderElement.parentNode) removeDragPlaceholder();
            if(draggedElement) draggedElement.classList.remove('dragging');
            dashboardGrid.classList.remove('dragging-active');
            draggedElement = null;
            return;
        }
        if (placeholderElement && placeholderElement.parentNode) {
            placeholderElement.parentNode.replaceChild(draggedElement, placeholderElement);
            if (draggedElement) {
                draggedElement.classList.remove('dragging');
                draggedElement.style.animation = 'settleDown 0.3s ease-out forwards';
                draggedElement.addEventListener('animationend', () => {
                    if(draggedElement.style.animation.includes('settleDown')) draggedElement.style.animation = '';
                }, { once: true });
            }
        } else { // Touch ended without valid placeholder drop
             if (draggedElement) { // Settle it back if it was popped
                draggedElement.style.animation = 'settleDown 0.3s ease-out forwards';
                draggedElement.addEventListener('animationend', () => {
                    draggedElement.classList.remove('dragging');
                    if(draggedElement.style.animation.includes('settleDown')) draggedElement.style.animation = '';
                }, { once: true });
            }
        }
        removeDragPlaceholder();
        dashboardGrid.classList.remove('dragging-active');
        draggedElement = null;
        touchStartX = 0; touchStartY = 0;
    }


    function getDragAfterElement(container, y) { /* ... (existing logic) ... */
        const draggableElements = [...container.querySelectorAll('.dashboard-card:not(.dragging):not(.dashboard-card-placeholder)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else { return closest; }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }
    function updateMarquees() { /* ... (existing logic) ... */
        marqueeEls.forEach(el => {
            const container = el.parentElement;
            if (!container || container.offsetWidth === 0) { setTimeout(() => updateMarquees(), 100); return; }
            const containerWidth = container.offsetWidth;
            const contentWidth = el.scrollWidth;
            el.classList.remove('marquee-active');
            if (contentWidth > containerWidth) { setTimeout(() => { el.classList.add('marquee-active'); }, 50); }
        });
    }

    async function saveLayout() { /* ... (existing save logic - needs update for custom card persistence) ... */
      // CURRENTLY SAVES ORDER OF ALL CARDS, INCLUDING SESSION-ONLY CUSTOM CARDS.
      // FOR FULL PERSISTENCE OF CUSTOM CARDS, THIS FUNCTION AND LOADLAYOUT NEED TO HANDLE
      // CARD TEMPLATE IDs AND RECREATE CUSTOM CARDS ON LOAD.
      try {
        const cards = [...dashboardGrid.querySelectorAll('.dashboard-card')];
        // For persistent custom cards, map should store { id: card.dataset.id, templateId: card.dataset.templateId (if custom) }
        const layout = cards.map(card => card.dataset.id);
        await dbRef().update({ dashboardLayout: layout, lastLayoutUpdate: firebase.firestore.FieldValue.serverTimestamp() });
        showNotification('Layout saved successfully!', 'success');
      } catch (error) { console.error('Error saving layout:', error); showNotification('Failed to save layout', 'error');}
    }

    function loadSavedLayout(layout) { /* ... (existing load logic - needs update for custom card persistence) ... */
      // CURRENTLY ONLY REORDERS CARDS ALREADY IN HTML.
      // TO LOAD SAVED CUSTOM CARDS, THIS WOULD NEED TO:
      // 1. Iterate 'layout' which would be an array of objects {id, templateId}
      // 2. For each, check if card with 'id' exists. If not, call a version of 'addCardToDashboard(templateId, id)'
      // 3. Then reorder. This is a significant change.
      const cardMap = new Map();
      [...dashboardGrid.querySelectorAll('.dashboard-card')].forEach(card => cardMap.set(card.dataset.id, card));
      const fragment = document.createDocumentFragment();
      layout.forEach(cardId => { // cardId here would be an object if custom cards were fully persistent
        if (cardMap.has(cardId)) { // Simple check for now
          fragment.appendChild(cardMap.get(cardId));
          cardMap.delete(cardId);
        }
      });
      cardMap.forEach(card => fragment.appendChild(card));
      dashboardGrid.innerHTML = '';
      dashboardGrid.appendChild(fragment);
      initializeDragAndDrop(); // Re-attach listeners to all cards, including reordered ones
    }

    function resetToDefaultLayout() { /* ... (existing reset logic, will remove session-only cards) ... */
        // This will effectively remove any dynamically added cards as they are not in the default HTML structure.
        dashboardGrid.innerHTML = ''; // Clear all cards, including dynamically added ones.

        const defaultOrder = ['proxies', 'soundboard', 'games', 'others', 'settings'];
        const defaultCardsHTML = `
            <div class="dashboard-card" data-id="proxies" data-page="proxies.html">
              <div class="card-badge">Active</div><div class="card-header"><div class="card-icon">üõ°Ô∏è</div><h4 class="card-title">Proxies</h4></div>
              <p class="card-description">Secure web Browse through encrypted proxy servers. Access blocked content safely and anonymously.</p>
              <div class="card-stats"><div class="stat-item"><span class="stat-value">24</span><span class="stat-label">Servers</span></div><div class="stat-item"><span class="stat-value">99.9%</span><span class="stat-label">Uptime</span></div><div class="stat-item"><span class="stat-value">Fast</span><span class="stat-label">Speed</span></div></div>
            </div>
            <div class="dashboard-card" data-id="soundboard" data-page="soundboard.html">
              <div class="card-badge">New</div><div class="card-header"><div class="card-icon">üéµ</div><h4 class="card-title">Soundboard</h4></div>
              <p class="card-description">Interactive audio experience with a collection of sound effects, music, and audio clips for entertainment.</p>
              <div class="card-stats"><div class="stat-item"><span class="stat-value">150+</span><span class="stat-label">Sounds</span></div><div class="stat-item"><span class="stat-value">8</span><span class="stat-label">Categories</span></div><div class="stat-item"><span class="stat-value">HD</span><span class="stat-label">Quality</span></div></div>
            </div>
            <div class="dashboard-card" data-id="games" data-page="games.html">
              <div class="card-badge">Popular</div><div class="card-header"><div class="card-icon">üéÆ</div><h4 class="card-title">Games</h4></div>
              <p class="card-description">Extensive collection of browser-based games including classics, puzzles, and modern titles for endless entertainment.</p>
              <div class="card-stats"><div class="stat-item"><span class="stat-value">500+</span><span class="stat-label">Games</span></div><div class="stat-item"><span class="stat-value">12</span><span class="stat-label">Genres</span></div><div class="stat-item"><span class="stat-value">Free</span><span class="stat-label">Play</span></div></div>
            </div>
            <div class="dashboard-card" data-id="others" data-page="others.html">
              <div class="card-header"><div class="card-icon">‚ú®</div><h4 class="card-title">Others</h4></div>
              <p class="card-description">Additional tools and utilities including calculators, converters, and other helpful applications for productivity.</p>
              <div class="card-stats"><div class="stat-item"><span class="stat-value">25+</span><span class="stat-label">Tools</span></div><div class="stat-item"><span class="stat-value">Daily</span><span class="stat-label">Updated</span></div><div class="stat-item"><span class="stat-value">Useful</span><span class="stat-label">Features</span></div></div>
            </div>
            <div class="dashboard-card" data-id="settings" data-page="settings.html">
              <div class="card-header"><div class="card-icon">‚öôÔ∏è</div><h4 class="card-title">Settings</h4></div>
              <p class="card-description">Customize your experience with personal preferences, account management, and system configuration options.</p>
              <div class="card-stats"><div class="stat-item"><span class="stat-value">Profile</span><span class="stat-label">Manage</span></div><div class="stat-item"><span class="stat-value">Theme</span><span class="stat-label">Customize</span></div><div class="stat-item"><span class="stat-value">Privacy</span><span class="stat-label">Control</span></div></div>
            </div>
        `;
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = defaultCardsHTML.trim();

        const fragment = document.createDocumentFragment();
        defaultOrder.forEach(id => {
            const card = tempDiv.querySelector(`.dashboard-card[data-id="${id}"]`);
            if (card) {
                fragment.appendChild(card.cloneNode(true));
            }
        });
        dashboardGrid.appendChild(fragment);
        initializeDragAndDrop(); // Re-initialize for the newly added default cards
        saveLayout();
        showNotification('Layout reset to default. Custom cards removed.', 'success');
    }


    function showEditingHints() { /* ... (existing hints logic) ... */
        const cards = document.querySelectorAll('.dashboard-card');
        cards.forEach((card, index) => {
            card.style.animation = 'none'; card.offsetHeight;
            setTimeout(() => { card.style.animation = 'pulse 2s infinite'; }, index * 100);
        });
        showNotification('Drag cards to rearrange. Click "Save Layout" or press ESC when done.', 'info', 5000);
    }
    function hideEditingHints() { /* ... (existing hints logic) ... */
        document.querySelectorAll('.dashboard-card').forEach(card => { card.style.animation = ''; });
    }
    function showNotification(message, type = 'info', duration = 3000) { /* ... (existing notification logic) ... */
      const notification = document.createElement('div');
      notification.className = `notification ${type}`; notification.textContent = message;
      Object.assign(notification.style, { position: 'fixed', bottom: '20px', right: '20px', padding: '12px 20px', borderRadius: '8px', color: 'white', fontWeight: '600', zIndex: '10000', transform: 'translateY(150%)', transition: 'transform 0.4s ease-in-out', boxShadow: '0 4px 12px rgba(0,0,0,0.15)' });
      const colors = { success: 'linear-gradient(135deg, #28a745, #20c997)', error: 'linear-gradient(135deg, #dc3545, #e83e8c)', info: 'linear-gradient(135deg, #6720bd, #8a2be2)' };
      notification.style.background = colors[type] || colors.info;
      document.body.appendChild(notification);
      setTimeout(() => { notification.style.transform = 'translateY(0)'; }, 100);
      setTimeout(() => { notification.style.transform = 'translateY(150%)'; setTimeout(() => { if (document.body.contains(notification)) document.body.removeChild(notification); }, 400); }, duration);
    }

    const pulseStyle = document.createElement('style'); /* ... (existing pulse style) ... */
    pulseStyle.textContent = `@keyframes pulse { 0% { box-shadow: 0 6px 30px rgba(103, 32, 189, 0.08); transform: scale(1); } 50% { box-shadow: 0 10px 35px rgba(103, 32, 189, 0.20); transform: scale(1.01); } 100% { box-shadow: 0 6px 30px rgba(103, 32, 189, 0.08); transform: scale(1); } }`;
    document.head.appendChild(pulseStyle);

    document.addEventListener('keydown', (e) => { /* ... (existing keydown logic) ... */
        if (e.key === 'Escape' && editMode) { editBtn.click(); }
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'e') { e.preventDefault(); editBtn.click(); }
        if (e.key === 'Escape' && addCardModal.style.display === 'block') { closeAddCardModal(); } // ESC for modal
    });
    window.addEventListener('resize', () => { setTimeout(updateMarquees, 300); });
    document.addEventListener('DOMContentLoaded', () => { /* ... (existing DOMContentLoaded) ... */
        initializeDragAndDrop();
        document.documentElement.style.scrollBehavior = 'smooth';
        const imagesToPreload = ['../images/logo-dark.png'];
        imagesToPreload.forEach(src => { (new Image()).src = src; });
    });
    if ('performance' in window && window.PerformanceObserver) { /* ... (existing perf observer) ... */
      const observer = new PerformanceObserver((list) => { for (const entry of list.getEntries()) { if (entry.name === 'first-contentful-paint') console.log(`FCP: ${Math.round(entry.startTime)}ms`); } });
      observer.observe({type: 'paint', buffered: true});
      window.addEventListener('load', () => { console.log(`Dashboard fully loaded in ${Math.round(performance.now())}ms`); if ('PerformanceLongAnimationFrameTiming' in window) { new PerformanceObserver(list => { for (const entry of list.getEntries()) console.warn('Long Animation Frame:', entry); }).observe({type: 'long-animation-frame', buffered: true}); } });
    }
  </script>
</body>
</html>
