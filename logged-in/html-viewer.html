<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>4SP - HTML Viewer</title>
    <link rel="stylesheet" href="../css/style.css" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <style>
        /* --- Dashboard Layout --- */
        body.dashboard-page {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
            font-family: 'PrimaryFont', sans-serif;
        }
        .dashboard-container {
            display: flex;
            flex: 1;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 200px;
            background: linear-gradient(180deg, #333 0%, #2a2a2a 100%);
            color: #fff;
            padding: 20px 10px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #444;
            transition: width 0.5s ease-in-out;
            position: relative;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .sidebar.collapsed {
            width: 85px;
        }
        #toggleSidebar {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: none;
            border: none;
            color: #fff;
            font-size: 1.2em;
            cursor: pointer;
            padding: 4px;
            transition: transform 0.5s ease-in-out;
        }
        .sidebar.collapsed #toggleSidebar {
            transform: translateX(-50%) rotate(180deg);
        }
        .sidebar nav ul {
            list-style: none;
            padding: 0;
            margin: 60px 0 0;
        }
        .sidebar nav li {
            margin-bottom: 10px;
        }
        .sidebar nav a {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: #fff;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-family: 'PrimaryFont', sans-serif;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
        }
        .sidebar nav a::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }
        .sidebar nav a:hover::before {
            left: 100%;
        }
        .sidebar nav a.active,
        .sidebar nav a:hover {
            background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            transform: translateX(5px);
        }
        .sidebar nav a .icon {
            font-size: 1.2em;
            width: 24px;
            text-align: center;
        }
        .sidebar nav a .label {
            margin-left: 10px;
            white-space: nowrap;
        }
        .sidebar.collapsed nav a {
            justify-content: center;
            padding: 10px 0;
        }
        .sidebar.collapsed nav a .label {
            display: none;
        }
        .user-info {
            text-align: center;
            margin: 60px 0 30px;
            border-bottom: 1px solid #555;
            padding-bottom: 20px;
            overflow: visible;
        }
        .marquee-container {
            overflow: hidden;
            white-space: nowrap;
            position: relative;
            width: 100%;
            height: 1.8em;
            line-height: 1.8em;
        }
        .marquee-content {
            display: inline-block;
            padding-left: 100%;
            transform: translateX(0);
            animation: none;
            line-height: 1.8em;
        }
        .marquee-active {
            animation: scroll-left 12s linear infinite;
        }
        .sidebar.collapsed .marquee-active {
            animation-duration: 20s;
        }
        @keyframes scroll-left {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
        .user-info .username {
            font-family: 'PrimaryFont', sans-serif;
            font-size: 1.3em;
            margin-bottom: 8px;
            line-height: 0.2em;
            font-weight: bold;
        }
        .user-info .email {
            font-family: 'SecondaryFont', sans-serif;
            font-size: 0.9em;
            color: #bbb;
        }

        /* --- Main Content & Header --- */
        .main-content {
            flex: 1;
            padding: 30px;
            background: linear-gradient(135deg, #f0f2f5 0%, #e8eaf0 100%);
            overflow-y: auto;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid rgba(103, 32, 189, 0.1);
            flex-shrink: 0;
        }
        .dashboard-title {
            margin: 0;
            font-size: 2.0em;
            font-weight: bold;
            background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* --- HTML Viewer Specific Styles --- */
        .html-viewer-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            gap: 20px;
        }
        .viewer-controls, .cloud-save-controls {
            background: #fff;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        .viewer-controls button, .cloud-save-controls button, .viewer-controls input[type="file"] {
            background: linear-gradient(135deg, #6720bd 0%, #8a2be2 100%);
            border: none; color: #fff; padding: 10px 15px; border-radius: 8px;
            font-family: 'PrimaryFont', sans-serif; cursor: pointer; transition: all 0.3s ease;
            font-size: 0.9em; font-weight: 600;
        }
        .viewer-controls button:hover, .cloud-save-controls button:hover {
            transform: translateY(-2px); box-shadow: 0 6px 15px rgba(103, 32, 189, 0.25);
        }
        .viewer-controls input[type="file"] {
            padding: 8px;
        }
        #importFileBtn {
            padding: 10px 15px;
            background: linear-gradient(135deg, #17a2b8 0%, #1f95a3 100%);
        }
        #importFileBtn:hover {
            box-shadow: 0 6px 15px rgba(23, 162, 184, 0.3);
        }
        #exportHtmlBtn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        #exportHtmlBtn:hover {
            box-shadow: 0 6px 15px rgba(40, 167, 69, 0.3);
        }
        #saveLocalBtn {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        }
        #saveLocalBtn:hover {
            box-shadow: 0 6px 15px rgba(255, 193, 7, 0.3);
        }
        #previewHalfBtn, #previewFullBtn {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        }
        #previewHalfBtn:hover, #previewFullBtn:hover {
            box-shadow: 0 6px 15px rgba(0, 123, 255, 0.3);
        }
        #htmlCodeEditor {
            flex-grow: 1;
            width: 100%;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Roboto', monospace; /* Changed to monospace for code */
            font-size: 1em;
            line-height: 1.6;
            resize: vertical;
            min-height: 300px;
            box-sizing: border-box;
        }
        .char-count-display {
            font-size: 0.85em;
            color: #555;
            text-align: right;
            padding: 5px 0;
        }

        .preview-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid #ccc;
            border-radius: 8px;
            overflow: hidden; /* Important for iframe */
        }
        #previewIframe {
            width: 100%;
            flex-grow: 1;
            border: none;
            background-color: #f9f9f9;
        }

        .cloud-saves-section {
            background: #fff;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .cloud-saves-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        .cloud-saves-header h3 {
            margin-top: 0;
            margin-bottom: 0;
            color: #333;
            font-size: 1.2em;
        }

        #refreshCloudSavesBtn {
            background: none;
            border: none;
            padding: 5px;
            border-radius: 50%;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
            width: auto;
            height: auto;
        }
        #refreshCloudSavesBtn img {
            width: 18px;
            height: 18px;
            display: block;
        }
        #refreshCloudSavesBtn:hover {
            background-color: rgba(103, 32, 189, 0.1);
        }
        #refreshCloudSavesBtn:disabled {
            cursor: not-allowed;
            opacity: 0.5;
            background-color: transparent;
        }
        @keyframes spin-clockwise {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #refreshCloudSavesBtn.refreshing img {
            animation: spin-clockwise 0.8s linear infinite;
        }
        #refreshCloudSavesBtn.refreshing:disabled {
            opacity: 0.8;
        }

        .cloud-stats {
            font-size: 0.85em;
            color: #555;
            margin-bottom: 15px;
        }
        #cloudSaveName {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 0.9em;
            flex-grow: 1;
            min-width: 150px;
        }
        #cloudSavesList {
            list-style: none;
            padding: 0;
            max-height: 200px;
            overflow-y: auto;
        }
        #cloudSavesList li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.9em;
            animation: fadeInListItem 0.4s ease-out forwards;
        }
        #cloudSavesList li.loading-item {
            text-align: center;
            color: #777;
            font-style: italic;
            padding: 20px;
            animation: none;
            border-bottom: none;
        }
        #cloudSavesList li:last-child:not(.loading-item) {
            border-bottom: none;
        }
        .save-info { flex-grow: 1; margin-right: 10px; }
        .save-name { font-weight: 600; color: #6720bd; }
        .save-details { font-size: 0.8em; color: #777; }
        .save-actions { display: flex; flex-shrink: 0; }
        .save-actions button {
            background: none;
            border: 1px solid transparent;
            padding: 5px 8px;
            border-radius: 8px;
            cursor: pointer;
            margin-left: 8px;
            font-size: 0.85em;
            transition: all 0.2s;
            font-family: 'PrimaryFont', sans-serif;
            text-transform: uppercase;
            white-space: nowrap;
        }
        .save-actions .open-save-btn { color: #28a745; border-color: #28a745; }
        .save-actions .open-save-btn:hover { background: #28a745; color: white;}
        .save-actions .edit-save-name-btn { color: #1f95a3; border-color: #1f95a3; }
        .save-actions .edit-save-name-btn:hover { background: #1f95a3; color: white;}
        .save-actions .delete-save-btn { color: #dc3545; border-color: #dc3545;}
        .save-actions .delete-save-btn:hover { background: #dc3545; color: white;}

        #statusMessages {
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            font-size: 0.9em;
            text-align: center;
        }
        .status-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb;}
        .status-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;}
        .status-warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba;}
        .status-info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb;}

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .main-content { padding: 15px; }
            .dashboard-header { padding: 15px 20px; margin-bottom: 15px;}
            .dashboard-title { font-size: 1.8em; }
            .viewer-controls, .cloud-save-controls { flex-direction: column; align-items: stretch; }
            .viewer-controls input[type="text"], .cloud-save-controls input[type="text"] { width: 100%; }
            #htmlCodeEditor { min-height: 250px; }
            #cloudSavesList li { flex-direction: column; align-items: flex-start; }
            .save-info { margin-right: 0; margin-bottom: 8px; }
            .save-actions { width: 100%; justify-content: flex-start; }
            .save-actions button { margin-left: 0; margin-right: 8px; }
            .save-actions button:first-child { margin-left: 0; }
        }

        /* Animation for fade-in */
        .fade-in { animation: fadeInGeneral 0.5s ease-out; }
        @keyframes fadeInGeneral { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .slide-in { animation: slideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes slideIn { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Animation for list items */
        @keyframes fadeInListItem {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="dashboard-page">
    <header class="main-header light-bg">
        <div class="container">
            <div class="logo">
                <a href="../index.html">
                    <img src="../images/logo-dark.png" alt="4SP Logo" style="cursor:pointer" />
                </a>
            </div>
            <div class="auth-buttons">
                <button class="btn btn-login" onclick="window.location.href='../index.html'">HOME</button>
                <button id="logoutBtn" class="btn btn-login">LOG OUT</button>
            </div>
        </div>
    </header>

    <div class="dashboard-container">
        <aside class="sidebar slide-in" id="sidebar">
            <button id="toggleSidebar">‚ò∞</button>
            <div class="user-info">
                <div class="marquee-container">
                    <span id="userName" class="marquee-content username">Loading‚Ä¶</span>
                </div>
                <div class="marquee-container">
                    <span id="userEmail" class="marquee-content email">Loading‚Ä¶</span>
                </div>
            </div>
            <nav>
                <ul>
                    <li><a href="dashboard.html"><span class="icon">üè†</span><span class="label">Dashboard</span></a></li>
                    <li><a href="proxies.html"><span class="icon">üõ°Ô∏è</span><span class="label">Proxies</span></a></li>
                    <li><a href="soundboard.html"><span class="icon">üéµ</span><span class="label">Soundboard</span></a></li>
                    <li><a href="games.html"><span class="icon">üéÆ</span><span class="label">Games</span></a></li>
                    <li><a href="others.html" class="active"><span class="icon">‚ú®</span><span class="label">Others</span></a></li>
                    <li><a href="settings.html"><span class="icon">‚öôÔ∏è</span><span class="label">Settings</span></a></li>
                    <li><a href="#" id="signOutLink"><span class="icon">üîí</span><span class="label">LOG OUT</span></a></li>
                </ul>
            </nav>
        </aside>

        <main class="main-content fade-in">
            <div class="dashboard-header">
                <h2 class="dashboard-title">HTML Viewer</h2>
            </div>

            <div class="html-viewer-container">
                <div class="viewer-controls">
                    <input type="file" id="importFile" accept=".html,.htm,.txt" style="display: none;">
                    <button id="importFileBtn" onclick="document.getElementById('importFile').click();">Import HTML</button>
                    <button id="exportHtmlBtn">Export HTML</button>
                    <button id="saveLocalBtn">Save Locally</button>
                    <button id="previewHalfBtn">Preview (Half)</button>
                    <button id="previewFullBtn">Preview (Full)</button>
                </div>

                <textarea id="htmlCodeEditor" placeholder="Enter your HTML code here..."></textarea>
                <div class="char-count-display"><span id="charCount">0</span> characters</div>

                <div class="preview-area">
                    <iframe id="previewIframe" title="HTML Preview"></iframe>
                </div>

                <div class="cloud-saves-section">
                    <div class="cloud-saves-header">
                        <h3>Cloud Projects</h3>
                        <button id="refreshCloudSavesBtn" title="Refresh Cloud Projects">
                            <img src="../images/refresh-dark.png" alt="Refresh Saves">
                        </button>
                    </div>
                    <div class="cloud-stats">
                        Projects: <span id="cloudSaveSlotsUsed">0</span>/<span id="cloudSlotsTotal">25</span> |
                        Characters: <span id="cloudCharCountUsed">0</span>/<span id="cloudCharLimitDisplay">1,000,000</span>
                    </div>
                    <div class="cloud-save-controls">
                        <input type="text" id="cloudSaveName" placeholder="Enter project name for cloud">
                        <button id="saveCloudBtn">Save Project to Cloud</button>
                    </div>
                    <ul id="cloudSavesList">
                    </ul>
                </div>
                <div id="statusMessages"></div>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <script>
        const OWNER_EMAILS = ["4simpleproblems@gmail.com", "belkwy30@minerva.sparcc.org"];
        let IS_OWNER_ACCOUNT = false;

        const BASE_MAX_CLOUD_SAVES = 25; // Increased to 25
        const BASE_MAX_CLOUD_CHARS = 1000000;
        let MAX_CLOUD_SAVES = BASE_MAX_CLOUD_SAVES;
        let MAX_CLOUD_CHARS = BASE_MAX_CLOUD_CHARS;


        // --- DOM Elements ---
        const htmlCodeEditor = document.getElementById('htmlCodeEditor');
        const charCountEl = document.getElementById('charCount');
        const importFileEl = document.getElementById('importFile');
        const exportHtmlBtn = document.getElementById('exportHtmlBtn');
        const saveLocalBtn = document.getElementById('saveLocalBtn');
        const previewHalfBtn = document.getElementById('previewHalfBtn');
        const previewFullBtn = document.getElementById('previewFullBtn');
        const previewIframe = document.getElementById('previewIframe');
        const saveCloudBtn = document.getElementById('saveCloudBtn');
        const cloudSaveNameEl = document.getElementById('cloudSaveName');
        const cloudSavesListEl = document.getElementById('cloudSavesList');
        const cloudSaveSlotsUsedEl = document.getElementById('cloudSaveSlotsUsed');
        const cloudSlotsTotalEl = document.getElementById('cloudSlotsTotal');
        const cloudCharCountUsedEl = document.getElementById('cloudCharCountUsed');
        const cloudCharLimitDisplayEl = document.getElementById('cloudCharLimitDisplay');
        const refreshCloudSavesBtn = document.getElementById('refreshCloudSavesBtn');
        const statusMessagesEl = document.getElementById('statusMessages');
        const marqueeEls = document.querySelectorAll('.marquee-content');
        const sidebarUserNameEl = document.getElementById('userName');
        const sidebarUserEmailEl = document.getElementById('userEmail');


        // --- Firebase Refs ---
        let currentUser = null;
        // Adjusted Firestore collection to 'HTML' as requested
        const userHtmlProjectsDocRef = () => currentUser ? firebase.firestore().collection('HTML').doc(currentUser.uid) : null;
        const userProfileDocRef = () => currentUser ? firebase.firestore().collection('users').doc(currentUser.uid) : null;


        // --- Utility Functions ---
        function updateCloudLimitUI() {
            if (IS_OWNER_ACCOUNT) {
                MAX_CLOUD_SAVES = BASE_MAX_CLOUD_SAVES * 2;
                MAX_CLOUD_CHARS = BASE_MAX_CLOUD_CHARS * 2;
                cloudSlotsTotalEl.textContent = MAX_CLOUD_SAVES;
                cloudCharLimitDisplayEl.textContent = MAX_CLOUD_CHARS.toLocaleString();
            } else {
                MAX_CLOUD_SAVES = BASE_MAX_CLOUD_SAVES;
                MAX_CLOUD_CHARS = BASE_MAX_CLOUD_CHARS;
                cloudSlotsTotalEl.textContent = MAX_CLOUD_SAVES;
                cloudCharLimitDisplayEl.textContent = MAX_CLOUD_CHARS.toLocaleString();
            }
        }

        function showStatusMessage(message, type = 'info', duration = 4000) {
            statusMessagesEl.textContent = message;
            statusMessagesEl.className = '';
            statusMessagesEl.classList.add(`status-${type}`);
            statusMessagesEl.style.display = 'block';
            if (duration) {
                setTimeout(() => { statusMessagesEl.style.display = 'none'; }, duration);
            }
        }

        function bytesToSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function updateCharacterCount() {
            charCountEl.textContent = htmlCodeEditor.value.length.toLocaleString();
        }

        // --- Sidebar User Info & Toggle ---
        function updateMarquees() {
            marqueeEls.forEach(el => {
                el.classList.remove('marquee-active');
                void el.offsetWidth;
                el.classList.add('marquee-active');
            });
        }
        document.addEventListener('DOMContentLoaded', () => {
            const sidebar = document.getElementById('sidebar');
            const toggleSidebarBtn = document.getElementById('toggleSidebar');
            if (toggleSidebarBtn && sidebar) {
                toggleSidebarBtn.addEventListener('click', () => {
                    sidebar.classList.toggle('collapsed');
                    setTimeout(updateMarquees, 550);
                });
            }
            const navLinks = document.querySelectorAll('.sidebar nav a');
            navLinks.forEach(link => {
                link.classList.remove('active');
                const currentPageName = window.location.pathname.split('/').pop();
                // Ensure 'html-viewer.html' activates the 'Others' link
                if (currentPageName === 'html-viewer.html' || (link.getAttribute('href') === 'others.html' && currentPageName === 'others.html') ) {
                     const othersLink = Array.from(navLinks).find(l => l.getAttribute('href') === 'others.html');
                     if (othersLink) othersLink.classList.add('active');
                } else if (link.getAttribute('href') === currentPageName) {
                     link.classList.add('active');
                }
            });
        });
        const handleLogout = () => {
            firebase.auth().signOut().then(() => {
                location.href = '../login.html';
            }).catch(error => {
                console.error('Logout error:', error);
                showStatusMessage('Logout error: ' + error.message, 'error');
            });
        };
        document.getElementById('logoutBtn').onclick = handleLogout;
        document.getElementById('signOutLink').onclick = handleLogout;


        // --- HTML Viewer Functionality ---
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                htmlCodeEditor.value = e.target.result;
                updateCharacterCount();
                showStatusMessage(`File "${file.name}" imported successfully.`, 'success');
                renderPreview(); // Render preview after import
            };
            reader.onerror = () => {
                showStatusMessage(`Error reading file "${file.name}".`, 'error');
            };
            reader.readAsText(file);
            event.target.value = null;
        }

        function handleExportHtml() {
            const content = htmlCodeEditor.value;
            if (!content.trim()) {
                showStatusMessage('Nothing to export.', 'warning');
                return;
            }
            let fileName = prompt("Enter filename (e.g., myPage.html):", "index.html");
            if (!fileName) return;
            const blob = new Blob([content], { type: 'text/html;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
            showStatusMessage(`HTML exported as "${fileName}".`, 'success');
        }

        function handleLocalSave() {
            try {
                localStorage.setItem('html_viewer_localCopy', htmlCodeEditor.value);
                showStatusMessage('HTML saved locally in your browser. Be cautious, this can be cleared with browser data.', 'warning', 6000);
            } catch (e) {
                showStatusMessage('Failed to save locally. Storage might be full or disabled.', 'error');
                console.error("Local save error:", e);
            }
        }

        function loadLocalSave() {
            const localHtml = localStorage.getItem('html_viewer_localCopy');
            if (localHtml !== null) {
                htmlCodeEditor.value = localHtml;
                updateCharacterCount();
                renderPreview(); // Render preview after loading local save
            }
        }

        function renderPreview() {
            const doc = previewIframe.contentWindow.document;
            doc.open();
            doc.write(htmlCodeEditor.value);
            doc.close();
        }

        function openFullscreenPreview() {
            const win = window.open('about:blank', '_blank');
            if (win) {
                win.document.write(htmlCodeEditor.value);
                win.document.close();
            } else {
                showStatusMessage('Pop-up blocked! Please allow pop-ups for this site to view fullscreen.', 'error');
            }
        }

        let isRefreshingCloudSaves = false;

        // Helper function to sort saves consistently
        function sortSaves(savesArray) {
            return savesArray.sort((a, b) => {
                const timeA = a.timestamp && typeof a.timestamp.toDate === 'function' ? a.timestamp.toDate().getTime() : (a.timestamp && a.timestamp.seconds ? a.timestamp.seconds * 1000 : 0);
                const timeB = b.timestamp && typeof b.timestamp.toDate === 'function' ? b.timestamp.toDate().getTime() : (b.timestamp && b.timestamp.seconds ? b.timestamp.seconds * 1000 : 0);
                return timeB - timeA; // Newest first
            });
        }


        async function refreshCloudSavesDisplay(showLoadingMessageInList = true) {
            if (isRefreshingCloudSaves) return;
            isRefreshingCloudSaves = true;

            if (showLoadingMessageInList) {
                cloudSavesListEl.innerHTML = '<li class="loading-item">Loading...</li>';
            }
            refreshCloudSavesBtn.classList.add('refreshing');
            refreshCloudSavesBtn.disabled = true;


            if (!currentUser) {
                if (showLoadingMessageInList || cloudSavesListEl.innerHTML.includes('Loading...')) {
                    cloudSavesListEl.innerHTML = '<li>Login to see cloud projects.</li>';
                }
                cloudSaveSlotsUsedEl.textContent = '0';
                cloudCharCountUsedEl.textContent = '0';
                isRefreshingCloudSaves = false;
                refreshCloudSavesBtn.classList.remove('refreshing');
                refreshCloudSavesBtn.disabled = false;
                return;
            }
            const docRef = userHtmlProjectsDocRef();
            if (!docRef) {
                console.error("refreshCloudSavesDisplay: docRef is null.");
                if (showLoadingMessageInList || cloudSavesListEl.innerHTML.includes('Loading...')) {
                    cloudSavesListEl.innerHTML = '<li>Error: User reference not found for cloud projects.</li>';
                }
                isRefreshingCloudSaves = false;
                refreshCloudSavesBtn.classList.remove('refreshing');
                refreshCloudSavesBtn.disabled = false;
                return;
            }

            try {
                const docSnap = await docRef.get();
                cloudSavesListEl.innerHTML = '';

                if (docSnap && typeof docSnap.exists === 'boolean' && docSnap.exists) {
                    const data = docSnap.data();
                    let saves = data && data.htmlProjects ? data.htmlProjects : []; // Adjusted field name
                    saves = sortSaves(saves); // Sort saves
                    let totalChars = 0;

                    if (saves.length === 0) {
                        cloudSavesListEl.innerHTML = '<li>No cloud projects yet.</li>';
                    }

                    saves.forEach((save, index) => {
                        totalChars += save.charCount || 0;
                        const li = document.createElement('li');

                        let saveDate = 'N/A';
                        if (save.timestamp) {
                            if (typeof save.timestamp.toDate === 'function') {
                                saveDate = save.timestamp.toDate().toLocaleString();
                            } else if (save.timestamp.seconds) {
                                saveDate = new Date(save.timestamp.seconds * 1000).toLocaleString();
                            } else if (save.timestamp instanceof Date) {
                                saveDate = save.timestamp.toLocaleString();
                            }
                        }

                        li.innerHTML = `
                            <div class="save-info">
                                <span class="save-name">${save.name || `Project ${index + 1}`}</span>
                                <div class="save-details">
                                    Chars: ${(save.charCount || 0).toLocaleString()} | Size: ${bytesToSize(new Blob([save.content || '']).size)} | Saved: ${saveDate}
                                </div>
                            </div>
                            <div class="save-actions">
                                <button class="edit-save-name-btn" data-index="${index}">Edit Name</button>
                                <button class="open-save-btn" data-index="${index}">Open</button>
                                <button class="delete-save-btn" data-index="${index}">Delete</button>
                            </div>
                        `;
                        cloudSavesListEl.appendChild(li);
                    });

                    cloudSaveSlotsUsedEl.textContent = saves.length;
                    cloudCharCountUsedEl.textContent = totalChars.toLocaleString();

                    cloudSavesListEl.querySelectorAll('.open-save-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => openCloudSave(parseInt(e.target.dataset.index)));
                    });
                    cloudSavesListEl.querySelectorAll('.edit-save-name-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => handleEditSaveName(parseInt(e.target.dataset.index)));
                    });
                    cloudSavesListEl.querySelectorAll('.delete-save-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => deleteCloudSave(parseInt(e.target.dataset.index)));
                    });
                } else {
                    cloudSavesListEl.innerHTML = '<li>No cloud project data found. Start saving!</li>';
                    cloudSaveSlotsUsedEl.textContent = '0';
                    cloudCharCountUsedEl.textContent = '0';
                }
            } catch (error) {
                console.error("Error in refreshCloudSavesDisplay:", error);
                showStatusMessage('Error fetching cloud projects: ' + error.message, 'error');
                cloudSavesListEl.innerHTML = `<li>Error loading projects. Check console.</li>`;
            } finally {
                isRefreshingCloudSaves = false;
                refreshCloudSavesBtn.classList.remove('refreshing');
                refreshCloudSavesBtn.disabled = false;
            }
        }

        async function handleCloudSave() {
            if (!currentUser) {
                showStatusMessage('You must be logged in to save to the cloud.', 'error');
                return;
            }
            const saveName = cloudSaveNameEl.value.trim() || `HTML-Project-${new Date().toISOString().slice(0,10)}`;
            const contentToSave = htmlCodeEditor.value;
            const charCountToSave = contentToSave.length;

            const docRef = userHtmlProjectsDocRef(); // Adjusted Firestore reference
            if (!docRef) {
                showStatusMessage('Error: Cannot get user reference for cloud save.', 'error');
                return;
            }

            try {
                saveCloudBtn.textContent = 'Saving...';
                saveCloudBtn.disabled = true;

                await firebase.firestore().runTransaction(async (transaction) => {
                    const docSnap = await transaction.get(docRef);
                    let cloudSaves = [];
                    let currentTotalChars = 0;

                    if (docSnap.exists) {
                        const data = docSnap.data();
                        if (data) {
                            cloudSaves = data.htmlProjects || []; // Adjusted field name
                            currentTotalChars = cloudSaves.reduce((sum, s) => sum + (s.charCount || 0), 0);
                        }
                    }
                    if (cloudSaves.length >= MAX_CLOUD_SAVES) {
                        throw new Error(`Cloud project limit of ${MAX_CLOUD_SAVES} slots reached. Please delete an existing project.`);
                    }
                    if (currentTotalChars + charCountToSave > MAX_CLOUD_CHARS) {
                        throw new Error(`Saving this project would exceed the total character limit of ${MAX_CLOUD_CHARS.toLocaleString()}. Current: ${currentTotalChars.toLocaleString()}, Adding: ${charCountToSave.toLocaleString()}`);
                    }

                    const newSave = {
                        name: saveName,
                        content: contentToSave,
                        charCount: charCountToSave,
                        timestamp: new Date()
                    };
                    cloudSaves.push(newSave);

                    if (docSnap.exists) {
                        transaction.update(docRef, { htmlProjects: cloudSaves }); // Adjusted field name
                    } else {
                        transaction.set(docRef, { htmlProjects: cloudSaves }); // Adjusted field name
                    }
                });

                showStatusMessage(`"${saveName}" sent to cloud for saving!`, 'success');
                cloudSaveNameEl.value = '';
                await refreshCloudSavesDisplay(false);

            } catch (error) {
                console.error("Error saving to cloud:", error);
                showStatusMessage(`Cloud save error: ${error.message}`, 'error', 6000);
            } finally {
                saveCloudBtn.textContent = 'Save Project to Cloud';
                saveCloudBtn.disabled = false;
            }
        }

        async function openCloudSave(index) {
            if (!currentUser) {
                showStatusMessage('Please log in to open cloud projects.', 'info');
                return;
            }
            const currentLocalHtml = localStorage.getItem('html_viewer_localCopy');
            const currentEditorContent = htmlCodeEditor.value;
            let unsavedChanges = false;

            if (currentEditorContent !== (localStorage.getItem(`html_viewer_cloud_opened_content_${currentUser.uid}`) || currentLocalHtml || "")) {
                unsavedChanges = true;
            }

            if (unsavedChanges) {
                if (!confirm("You have unsaved changes in the editor. Are you sure you want to open a cloud project and overwrite them? Consider saving locally or to the cloud first.")) {
                    return;
                }
            }

            const docRef = userHtmlProjectsDocRef(); // Adjusted Firestore reference
            if (!docRef) return;
            try {
                const docSnap = await docRef.get();
                if (docSnap.exists) {
                    const data = docSnap.data();
                    let saves = data.htmlProjects || []; // Adjusted field name
                    saves = sortSaves(saves); // Ensure consistent sort order

                    if (saves[index]) {
                        htmlCodeEditor.value = saves[index].content;
                        cloudSaveNameEl.value = saves[index].name;
                        updateCharacterCount();
                        localStorage.setItem('html_viewer_localCopy', saves[index].content);
                        localStorage.setItem(`html_viewer_cloud_opened_content_${currentUser.uid}`, saves[index].content);
                        showStatusMessage(`Opened "${saves[index].name}" from cloud. Also updated local browser copy.`, 'success');
                        renderPreview(); // Render preview after opening
                    } else {
                        showStatusMessage('Selected project not found. It might have been deleted.', 'warning');
                    }
                } else {
                    showStatusMessage('No cloud data found to open from.', 'warning');
                }
            } catch (error) {
                console.error("Error opening cloud save:", error);
                showStatusMessage('Error opening cloud project: ' + error.message, 'error');
            }
        }

        async function handleEditSaveName(index) {
            if (!currentUser) {
                showStatusMessage('Please log in to edit project names.', 'info');
                return;
            }
            const docRef = userHtmlProjectsDocRef(); // Adjusted Firestore reference
            if (!docRef) {
                showStatusMessage('Error: User reference not found.', 'error');
                return;
            }

            try {
                let originalName = '';
                const tempDocSnap = await docRef.get();
                if (tempDocSnap.exists) {
                    let tempSaves = tempDocSnap.data().htmlProjects || []; // Adjusted field name
                    tempSaves = sortSaves(tempSaves);
                    if (tempSaves[index]) {
                        originalName = tempSaves[index].name;
                    } else {
                        showStatusMessage('Project not found or index out of bounds.', 'error');
                        return;
                    }
                } else {
                    showStatusMessage('No cloud data found.', 'error');
                    return;
                }

                const newName = prompt("Enter new name for this project:", originalName);

                if (newName === null) {
                    return;
                }
                if (newName.trim() === "") {
                    showStatusMessage('Project name cannot be empty.', 'warning');
                    return;
                }
                if (newName.trim() === originalName) {
                    showStatusMessage('Name is unchanged.', 'info');
                    return;
                }

                await firebase.firestore().runTransaction(async (transaction) => {
                    const docSnap = await transaction.get(docRef);
                    if (!docSnap.exists) throw new Error("User data not found.");

                    let cloudSaves = docSnap.data().htmlProjects || []; // Adjusted field name
                    cloudSaves = sortSaves(cloudSaves);

                    if (index < 0 || index >= cloudSaves.length) {
                        throw new Error("Invalid project index during transaction.");
                    }

                    cloudSaves[index].name = newName.trim();
                    transaction.update(docRef, { htmlProjects: cloudSaves }); // Adjusted field name
                });

                showStatusMessage(`Project renamed to "${newName.trim()}" successfully.`, 'success');
                await refreshCloudSavesDisplay(false);

            } catch (error) {
                console.error("Error editing project name:", error);
                showStatusMessage(`Error editing name: ${error.message}`, 'error');
            }
        }

        async function deleteCloudSave(index) {
            if (!currentUser) {
                showStatusMessage('Please log in to delete cloud projects.', 'info');
                return;
            }

            const docRef = userHtmlProjectsDocRef(); // Adjusted Firestore reference
            if (!docRef) return;

            let saveNameToDelete = `Project at index ${index}`;
            try {
                const initialDocSnap = await docRef.get();
                if (initialDocSnap.exists) {
                    let initialSaves = initialDocSnap.data().htmlProjects || []; // Adjusted field name
                    initialSaves = sortSaves(initialSaves);
                    if (initialSaves[index] && initialSaves[index].name) {
                        saveNameToDelete = `"${initialSaves[index].name}"`;
                    }
                }

                if (!confirm(`Are you sure you want to delete the cloud project ${saveNameToDelete}? This action cannot be undone.`)) {
                    return;
                }

                await firebase.firestore().runTransaction(async (transaction) => {
                    const docSnap = await transaction.get(docRef);
                    if (!docSnap.exists) throw new Error("User data not found for deletion.");

                    let cloudSaves = docSnap.data().htmlProjects || []; // Adjusted field name
                    cloudSaves = sortSaves(cloudSaves);

                    if (index < 0 || index >= cloudSaves.length) throw new Error("Invalid project index for deletion after sort.");

                    cloudSaves.splice(index, 1);
                    transaction.update(docRef, { htmlProjects: cloudSaves }); // Adjusted field name
                });

                showStatusMessage(`Cloud project ${saveNameToDelete} deleted successfully.`, 'success');
                await refreshCloudSavesDisplay(false);

            } catch (error) {
                console.error("Error deleting cloud save:", error);
                showStatusMessage(`Error deleting cloud project: ${error.message}`, 'error');
            }
        }


        // --- Authentication & Initial Load ---
        firebase.auth().onAuthStateChanged(async user => {
            currentUser = user;

            if (user) {
                IS_OWNER_ACCOUNT = OWNER_EMAILS.includes(user.email);
                updateCloudLimitUI();

                if (sidebarUserEmailEl) sidebarUserEmailEl.textContent = user.email;

                const userProfRef = userProfileDocRef();
                if (userProfRef) {
                    try {
                        const userProfileSnap = await userProfRef.get();
                        if (userProfileSnap.exists) {
                            const userProfileData = userProfileSnap.data();
                            if (sidebarUserNameEl) sidebarUserNameEl.textContent = userProfileData.username || user.displayName || user.email.split('@')[0];
                        } else {
                            if (sidebarUserNameEl) sidebarUserNameEl.textContent = user.displayName || user.email.split('@')[0];
                        }
                    } catch (error) {
                        console.error("Error fetching user profile for username:", error);
                        if (sidebarUserNameEl) sidebarUserNameEl.textContent = user.displayName || user.email.split('@')[0];
                    }
                } else {
                    if (sidebarUserNameEl) sidebarUserNameEl.textContent = user.displayName || user.email.split('@')[0];
                }

                loadLocalSave();
                await refreshCloudSavesDisplay(true);
            } else {
                IS_OWNER_ACCOUNT = false;
                updateCloudLimitUI();

                if (sidebarUserNameEl) sidebarUserNameEl.textContent = 'Not Logged In';
                if (sidebarUserEmailEl) sidebarUserEmailEl.textContent = 'Please log in';
                cloudSavesListEl.innerHTML = '<li>Please log in to manage cloud projects.</li>';
                cloudSaveSlotsUsedEl.textContent = '0';
                cloudCharCountUsedEl.textContent = '0';
                showStatusMessage('Please log in to use cloud features and save HTML projects.', 'info', null);
            }
            updateMarquees();
        });


        // --- Event Listeners ---
        htmlCodeEditor.addEventListener('input', () => {
            updateCharacterCount();
            renderPreview(); // Live preview
        });
        importFileEl.addEventListener('change', handleFileImport);
        exportHtmlBtn.addEventListener('click', handleExportHtml);
        saveLocalBtn.addEventListener('click', handleLocalSave);
        previewHalfBtn.addEventListener('click', renderPreview);
        previewFullBtn.addEventListener('click', openFullscreenPreview);
        saveCloudBtn.addEventListener('click', handleCloudSave);
        refreshCloudSavesBtn.addEventListener('click', () => refreshCloudSavesDisplay(true));

        updateCharacterCount();
        updateCloudLimitUI();
        renderPreview(); // Initial render of empty iframe
    </script>
</body>
</html>
