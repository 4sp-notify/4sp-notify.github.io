<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join Class - Notify</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-poppins { font-family: 'Poppins', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="invite-container" class="w-full max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg text-center">
        <!-- Loading State -->
        <div id="loading-view">
            <h2 class="text-xl font-bold text-gray-800 font-poppins">Loading Invitation...</h2>
            <p class="text-gray-500 mt-2">Please wait a moment.</p>
        </div>
        
        <!-- Logged Out View -->
        <div id="logged-out-view" class="hidden">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4">
                <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197M15 21a6 6 0 006-6v-1a3 3 0 00-3-3H6a3 3 0 00-3 3v1a6 6 0 006 6z" /></svg>
             </div>
             <h2 class="text-2xl font-bold font-poppins text-gray-900">Join the Class</h2>
             <p class="text-gray-600 mt-2">To accept this invitation, please log in or create an account.</p>
             <div class="mt-6 space-y-3">
                 <a id="login-redirect-btn" href="#" class="block w-full px-4 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-sm hover:bg-blue-700">Log In</a>
                 <a id="signup-redirect-btn" href="#" class="block w-full px-4 py-2 text-gray-600 font-medium rounded-lg hover:bg-gray-100">Sign Up</a>
             </div>
        </div>

        <!-- Logged In View -->
        <div id="content-view" class="hidden">
             <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4">
                <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197M15 21a6 6 0 006-6v-1a3 3 0 00-3-3H6a3 3 0 00-3 3v1a6 6 0 006 6z" /></svg>
             </div>
             <h2 class="text-2xl font-bold font-poppins text-gray-900">You're invited!</h2>
             <p class="text-gray-600 mt-2">You have been invited to join the class:</p>
             <p id="class-name" class="text-xl font-semibold text-blue-600 my-4"></p>
             <div id="action-buttons" class="mt-6 space-y-3">
                 <button id="join-btn" class="w-full px-4 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                     Accept Invitation
                 </button>
                 <button id="decline-btn" class="w-full px-4 py-2 text-gray-600 font-medium rounded-lg hover:bg-gray-100">
                     Decline
                 </button>
             </div>
             <div id="message-area" class="mt-4 text-sm"></div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            function onFirebaseReady(callback) {
                const interval = setInterval(() => {
                    if (typeof firebase !== 'undefined' && typeof firebase.initializeApp === 'function' && typeof firebaseConfig !== 'undefined') {
                        clearInterval(interval);
                        callback();
                    }
                }, 50);
            }

            onFirebaseReady(() => {
                const app = firebase.initializeApp(firebaseConfig);
                const auth = firebase.auth();
                const db = firebase.firestore();

                const loadingView = document.getElementById('loading-view');
                const loggedOutView = document.getElementById('logged-out-view');
                const contentView = document.getElementById('content-view');
                const classNameEl = document.getElementById('class-name');
                const actionButtons = document.getElementById('action-buttons');
                const messageArea = document.getElementById('message-area');
                const joinBtn = document.getElementById('join-btn');
                const declineBtn = document.getElementById('decline-btn');

                const params = new URLSearchParams(window.location.search);
                const classId = params.get('classId');

                if (!classId) {
                    displayMessage("error", "No class invitation found. The link may be invalid.");
                    return;
                }

                auth.onAuthStateChanged(async user => {
                    if (!user) {
                        loadingView.classList.add('hidden');
                        loggedOutView.classList.remove('hidden');
                        const inviteUrl = window.location.href;
                        document.getElementById('login-redirect-btn').href = `login.html?redirectTo=${encodeURIComponent(inviteUrl)}`;
                        document.getElementById('signup-redirect-btn').href = `signup.html?redirectTo=${encodeURIComponent(inviteUrl)}`;
                        return;
                    }

                    const classRef = db.collection('classes').doc(classId);
                    const classDoc = await classRef.get();

                    if (!classDoc.exists) {
                        displayMessage("error", "This class does not exist or may have been deleted.");
                        return;
                    }

                    const classData = classDoc.data();
                    classNameEl.textContent = classData.name;
                    
                    const isTeacher = classData.teacherId === user.uid;
                    const isStudent = classData.studentIds && classData.studentIds.includes(user.uid);

                    if (isTeacher || isStudent) {
                        displayMessage("info", "You are already a member of this class.");
                        actionButtons.innerHTML = `<a href="dashboard.html" class="block w-full px-4 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-sm hover:bg-blue-700">Go to Dashboard</a>`;
                    } else {
                        loadingView.classList.add('hidden');
                        contentView.classList.remove('hidden');
                    }

                    joinBtn.addEventListener('click', async () => {
                        joinBtn.disabled = true;
                        joinBtn.textContent = 'Joining...';
                        try {
                            await classRef.update({
                                studentIds: firebase.firestore.FieldValue.arrayUnion(user.uid)
                            });
                            displayMessage("success", "Successfully joined the class! Redirecting...");
                            setTimeout(() => window.location.href = 'dashboard.html', 2000);
                        } catch (error) {
                            console.error("Error joining class: ", error);
                            displayMessage("error", "Could not join the class. Please try again.");
                            joinBtn.disabled = false;
                            joinBtn.textContent = 'Accept Invitation';
                        }
                    });

                    declineBtn.addEventListener('click', () => {
                        displayMessage("info", "Invitation declined. You can close this page.");
                        actionButtons.innerHTML = `<a href="dashboard.html" class="block w-full px-4 py-2 text-gray-600 font-medium rounded-lg hover:bg-gray-100">Go to Dashboard</a>`;
                    });
                });

                function displayMessage(type, text, showContent = true) {
                    loadingView.classList.add('hidden');
                    loggedOutView.classList.add('hidden');
                    if (showContent) {
                         contentView.classList.remove('hidden');
                         actionButtons.classList.add('hidden');
                         messageArea.textContent = text;
                         if (type === 'error') messageArea.className = 'mt-4 text-sm text-red-600';
                         if (type === 'success') messageArea.className = 'mt-4 text-sm text-green-600';
                         if (type === 'info') messageArea.className = 'mt-4 text-sm text-gray-500';
                    } else {
                        contentView.innerHTML = `<p class="text-lg font-semibold ${type === 'error' ? 'text-red-600' : 'text-gray-800'}">${text}</p>`
                        contentView.classList.remove('hidden');
                    }
                }
            });
        });
    </script>
</body>
</html>

