<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join Class - Notify</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' https://cdn.tailwindcss.com https://www.gstatic.com https://apis.google.com https://accounts.google.com 'unsafe-inline' 'unsafe-eval';
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
        font-src 'self' https://fonts.gstatic.com;
        img-src 'self' data: https://www.gstatic.com https://lh3.googleusercontent.com;
        connect-src 'self' https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://www.googleapis.com;
        frame-src 'self' https://accounts.google.com https://content.googleapis.com;
    ">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-poppins { font-family: 'Poppins', sans-serif; }
        .btn-bubbly { transition: transform 0.1s ease-out; }
        .btn-bubbly:active { transform: scale(0.95); }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-lg border border-gray-200 text-center">
        <div id="loader-container" class="hidden">
            <div class="flex flex-col items-center justify-center space-y-4">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                <p class="text-gray-600">Loading class details...</p>
            </div>
        </div>

        <div id="class-details-container" class="hidden">
            <h1 class="text-3xl font-bold font-poppins text-gray-800">Join <span id="class-name"></span></h1>
            <p class="mt-2 text-gray-600">You've been invited to join this class.</p>
            <p class="mt-4 text-lg font-semibold text-gray-700">Please choose your role:</p>
            
            <div class="mt-6 flex flex-col space-y-4">
                <button id="join-as-student" class="flex items-center justify-center w-full px-6 py-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors duration-150 btn-bubbly">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M12 4.354a4 4 0 100 5.292M12 11.292a4 4 0 110 5.292M12 11.292a4 4 0 100 5.292m-5.656-7.071l-.707.707m1.414-1.414l.707-.707m-1.414 1.414l-7.071 7.071a1 1 0 000 1.414l.707.707a1 1 0 001.414 0L12 13.414l7.071 7.071a1 1 0 001.414 0l.707-.707a1 1 0 000-1.414l-7.071-7.071m-4.243-4.243l-.707.707m1.414-1.414l.707-.707m-1.414 1.414l-4.95 4.95m4.95-4.95l-4.95 4.95m9.9 0l-4.95-4.95"></path></svg>
                    Join as a Student
                </button>
                <button id="join-as-teacher" class="flex items-center justify-center w-full px-6 py-4 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition-colors duration-150 btn-bubbly">
                    <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    Join as a Teacher
                </button>
            </div>
            
            <p id="role-selection-message" class="mt-4 text-red-500 hidden">Please select a role to continue.</p>
            <p id="gsi-container" class="mt-6 flex justify-center hidden">
                <button id="gsi-button" class="g_id_signin" data-type="standard" data-size="large" data-theme="outline" data-text="sign_in_with" data-shape="rectangular" data-logo_alignment="left"></button>
            </p>
        </div>

        <div id="error-container" class="hidden">
            <h1 class="text-3xl font-bold font-poppins text-red-600">Error</h1>
            <p id="error-message" class="mt-4 text-red-500"></p>
        </div>
    </div>
    
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            let selectedRole = null;
            let classId = null;

            const loaderContainer = document.getElementById('loader-container');
            const classDetailsContainer = document.getElementById('class-details-container');
            const errorContainer = document.getElementById('error-container');
            const errorMessage = document.getElementById('error-message');
            const classNameEl = document.getElementById('class-name');
            const joinAsStudentBtn = document.getElementById('join-as-student');
            const joinAsTeacherBtn = document.getElementById('join-as-teacher');
            const gsiContainer = document.getElementById('gsi-container');
            const gsiButton = document.getElementById('gsi-button');
            const roleSelectionMessage = document.getElementById('role-selection-message');

            function showLoader() {
                loaderContainer.classList.remove('hidden');
                classDetailsContainer.classList.add('hidden');
                errorContainer.classList.add('hidden');
            }

            function showClassDetails(name) {
                classNameEl.textContent = name;
                loaderContainer.classList.add('hidden');
                classDetailsContainer.classList.remove('hidden');
                errorContainer.classList.add('hidden');
            }

            function showError(message) {
                errorMessage.textContent = message;
                loaderContainer.classList.add('hidden');
                classDetailsContainer.classList.add('hidden');
                errorContainer.classList.remove('hidden');
            }

            // Function to handle URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            classId = urlParams.get('classId');

            if (!classId) {
                showError('No class ID provided in the invitation link.');
                return;
            }

            let firebaseApp, auth, db, googleProvider;
            
            function onFirebaseReady(callback) {
                const interval = setInterval(() => {
                    if (typeof firebase !== 'undefined' && typeof firebase.initializeApp === 'function' && typeof firebaseConfig !== 'undefined') {
                        clearInterval(interval);
                        callback();
                    }
                }, 50);
            }
            
            onFirebaseReady(async () => {
                firebaseApp = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                googleProvider = new firebase.auth.GoogleAuthProvider();

                showLoader();

                try {
                    const classDoc = await db.collection('classes').doc(classId).get();
                    if (!classDoc.exists) {
                        showError('The class you are trying to join does not exist.');
                        return;
                    }

                    const classData = classDoc.data();
                    showClassDetails(classData.name);
                } catch (e) {
                    console.error("Error fetching class data:", e);
                    showError('Failed to load class details. Please check your network connection.');
                }
            });

            function handleGoogleSignIn() {
                if (!selectedRole) {
                    roleSelectionMessage.classList.remove('hidden');
                    return;
                }

                auth.signInWithPopup(googleProvider).then(async (result) => {
                    const user = result.user;
                    const userRef = db.collection('users').doc(user.uid);
                    const userDoc = await userRef.get();

                    if (!userDoc.exists) {
                        await userRef.set({
                            username: user.displayName,
                            email: user.email,
                            photoURL: user.photoURL,
                            role: selectedRole
                        });
                    } else {
                        // User exists, update role if different and they selected a new role
                        await userRef.update({
                            role: selectedRole // This ensures their role is set based on their selection on this page
                        });
                    }

                    await addCurrentUserToClass(user.uid, selectedRole);

                    alert(`Successfully joined the class as a ${selectedRole}! Redirecting...`);
                    window.location.href = 'index.html';
                }).catch((error) => {
                    console.error("Google Sign-In Error:", error);
                    alert(`Failed to sign in: ${error.message}`);
                });
            }

            async function addCurrentUserToClass(uid, role) {
                const classRef = db.collection('classes').doc(classId);
                const classDoc = await classRef.get();
                if (classDoc.exists) {
                    const classData = classDoc.data();
                    if (role === 'student') {
                        if (!classData.studentIds.includes(uid)) {
                            await classRef.update({
                                studentIds: firebase.firestore.FieldValue.arrayUnion(uid)
                            });
                        }
                    } else if (role === 'teacher') {
                        if (!classData.teacherIds.includes(uid) && classData.teacherId !== uid) {
                            await classRef.update({
                                teacherIds: firebase.firestore.FieldValue.arrayUnion(uid)
                            });
                        }
                    }
                }
            }
            
            joinAsStudentBtn.addEventListener('click', () => {
                selectedRole = 'student';
                joinAsStudentBtn.classList.add('bg-blue-700', 'ring-2', 'ring-blue-500');
                joinAsTeacherBtn.classList.remove('bg-indigo-700', 'ring-2', 'ring-indigo-500');
                gsiContainer.classList.remove('hidden');
                roleSelectionMessage.classList.add('hidden');
                
                gsiButton.addEventListener('click', handleGoogleSignIn, { once: true });
            });

            joinAsTeacherBtn.addEventListener('click', () => {
                selectedRole = 'teacher';
                joinAsTeacherBtn.classList.add('bg-indigo-700', 'ring-2', 'ring-indigo-500');
                joinAsStudentBtn.classList.remove('bg-blue-700', 'ring-2', 'ring-blue-500');
                gsiContainer.classList.remove('hidden');
                roleSelectionMessage.classList.add('hidden');

                gsiButton.addEventListener('click', handleGoogleSignIn, { once: true });
            });
        });
    </script>
</body>
</html>
