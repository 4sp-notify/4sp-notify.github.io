<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join Class - Notify</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-poppins { font-family: 'Poppins', sans-serif; }
        .role-button {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .role-button.selected {
            border-color: #2563eb;
            background-color: #eff6ff;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="invite-container" class="w-full max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg text-center">
        <div id="loading-view">
            <h2 class="text-xl font-bold text-gray-800 font-poppins">Loading Invitation...</h2>
            <p class="text-gray-500 mt-2">Please wait a moment.</p>
        </div>
        
        <div id="content-view" class="hidden">
             <div id="icon-container" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4">
                <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 006-6v-1a3 3 0 00-3-3H6a3 3 0 00-3 3v1a6 6 0 006 6z" /></svg>
             </div>
             <h2 class="text-2xl font-bold font-poppins text-gray-900">You're invited!</h2>
             <p id="invite-message" class="text-gray-600 mt-2">You have been invited to join the class:</p>
             <p id="class-name" class="text-xl font-semibold text-blue-600 my-4"></p>
             <div id="action-buttons" class="mt-6 space-y-3">
                 <button id="join-btn" class="w-full px-4 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                     Accept Invitation
                 </button>
                 <button id="decline-btn" class="w-full px-4 py-2 text-gray-600 font-medium rounded-lg hover:bg-gray-100">
                     Decline
                 </button>
             </div>
             <div id="message-area" class="mt-4 text-sm"></div>
        </div>

        <div id="role-selection-view" class="hidden">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4">
                <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 006-6v-1a3 3 0 00-3-3H6a3 3 0 00-3 3v1a6 6 0 006 6z" /></svg>
             </div>
             <h2 class="text-2xl font-bold font-poppins text-gray-900">Join the Class</h2>
             <p class="text-gray-600 mt-2">First, tell us who you are in this class.</p>
             <div class="mt-6 flex space-x-4">
                 <button type="button" data-role="teacher" class="role-button flex-1 text-center py-3 px-4 border-2 border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100">Teacher</button>
                 <button type="button" data-role="student" class="role-button flex-1 text-center py-3 px-4 border-2 border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100">Student</button>
             </div>
             <p id="role-error" class="text-red-500 text-xs mt-2 hidden">Please select a role.</p>
             <div id="auth-buttons" class="mt-6 hidden">
                 <button id="google-login-btn" class="group relative w-full flex justify-center items-center py-2 px-4 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <img src="images/google-icon.png" class="h-5 w-5 mr-2" alt="Google icon">
                    <span id="google-auth-text">Continue with Google</span>
                 </button>
                 <p class="text-xs text-gray-500 italic mt-2">
                     Only use this if you have a Google account associated with the email invitation.
                 </p>
             </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="../firebase-config.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loadingView = document.getElementById('loading-view');
            const contentView = document.getElementById('content-view');
            const roleSelectionView = document.getElementById('role-selection-view');
            const classNameEl = document.getElementById('class-name');
            const actionButtons = document.getElementById('action-buttons');
            const messageArea = document.getElementById('message-area');
            const joinBtn = document.getElementById('join-btn');
            const declineBtn = document.getElementById('decline-btn');
            const roleButtons = document.querySelectorAll('.role-button');
            const authButtonsDiv = document.getElementById('auth-buttons');
            const googleLoginBtn = document.getElementById('google-login-btn');
            const roleErrorEl = document.getElementById('role-error');

            const params = new URLSearchParams(window.location.search);
            const classId = params.get('classId');
            let selectedRole = '';

            function onFirebaseReady(callback) {
                const interval = setInterval(() => {
                    if (typeof firebase !== 'undefined' && typeof firebase.initializeApp === 'function' && typeof firebaseConfig !== 'undefined') {
                        clearInterval(interval);
                        callback();
                    }
                }, 50);
            }

            onFirebaseReady(() => {
                const app = firebase.initializeApp(firebaseConfig);
                const auth = firebase.auth();
                const db = firebase.firestore();

                if (!classId) {
                    displayMessage("error", "No class invitation found. The link may be invalid.", false);
                    return;
                }

                auth.onAuthStateChanged(async user => {
                    loadingView.classList.add('hidden');
                    
                    const classRef = db.collection('classes').doc(classId);
                    const classDoc = await classRef.get();
                    if (!classDoc.exists) {
                        displayMessage("error", "This invitation link has expired because the class has been deleted.", false);
                        return;
                    }

                    const classData = classDoc.data();
                    classNameEl.textContent = classData.name;

                    if (!user) {
                        roleSelectionView.classList.remove('hidden');
                    } else {
                         const isTeacher = classData.teacherId === user.uid || (classData.teacherIds || []).includes(user.uid);
                         const isStudent = classData.studentIds && classData.studentIds.includes(user.uid);
                         
                         if (isTeacher || isStudent) {
                             displayMessage("info", "You are already a member of this class.");
                             actionButtons.innerHTML = `<a href="dashboard.html" class="block w-full px-4 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-sm hover:bg-blue-700">Go to Dashboard</a>`;
                         } else {
                             contentView.classList.remove('hidden');
                             joinBtn.addEventListener('click', () => handleJoin(user.uid, db, classRef));
                         }
                    }
                });

                roleButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        roleButtons.forEach(btn => btn.classList.remove('selected'));
                        button.classList.add('selected');
                        selectedRole = button.dataset.role;
                        roleErrorEl.classList.add('hidden');
                        authButtonsDiv.classList.remove('hidden');
                        document.getElementById('google-auth-text').textContent = `Continue as a ${selectedRole}`;
                    });
                });

                googleLoginBtn.addEventListener('click', async () => {
                    if (!selectedRole) {
                        roleErrorEl.classList.remove('hidden');
                        return;
                    }
                    const provider = new firebase.auth.GoogleAuthProvider();
                    try {
                        const result = await auth.signInWithPopup(provider);
                        const user = result.user;
                        const userDocRef = db.collection('users').doc(user.uid);
                        const userDoc = await userDocRef.get();

                        if (!userDoc.exists) {
                             const username = user.displayName.replace(/\s/g, '').toLowerCase() || `user${Math.random().toString(36).substring(2, 7)}`;
                             await userDocRef.set({
                                uid: user.uid,
                                username: username,
                                username_lowercase: username.toLowerCase(),
                                email: user.email,
                                role: selectedRole,
                                createdAt: new Date(),
                                emailVerified: true
                             });
                        }
                        handleJoin(user.uid, db, db.collection('classes').doc(classId));
                    } catch (error) {
                        console.error("Google login error:", error);
                        displayMessage("error", "Failed to sign in with Google. Please try again.");
                    }
                });
                
                declineBtn.addEventListener('click', () => {
                    displayMessage("info", "Invitation declined. You can close this page.", true, false);
                    actionButtons.innerHTML = `<a href="dashboard.html" class="block w-full px-4 py-2 text-gray-600 font-medium rounded-lg hover:bg-gray-100">Go to Dashboard</a>`;
                });
            });

            async function handleJoin(uid, db, classRef) {
                joinBtn.disabled = true;
                joinBtn.textContent = 'Joining...';
                try {
                    const userRef = db.collection('users').doc(uid);
                    await db.runTransaction(async transaction => {
                        const userDoc = await transaction.get(userRef);
                        if (!userDoc.exists) throw new Error("User document does not exist!");
                        const classDocData = await transaction.get(classRef);
                        if (!classDocData.exists) throw new Error("Class document does not exist!");
                        
                        const currentStudentIds = classDocData.data().studentIds || [];
                        if (currentStudentIds.includes(uid)) {
                             displayMessage("info", "You are already a member of this class. Redirecting...", true, false);
                             setTimeout(() => window.location.href = 'dashboard.html', 2000);
                             throw new Error("Already a member");
                        }

                        transaction.update(classRef, { studentIds: firebase.firestore.FieldValue.arrayUnion(uid) });
                    });
                    
                    displayMessage("success", "Successfully joined the class! Redirecting...", true, false);
                    setTimeout(() => window.location.href = 'dashboard.html', 2000);
                } catch (error) {
                    console.error("Error joining class: ", error);
                    if (error.message !== "Already a member") {
                        displayMessage("error", "Could not join the class. Please try again.", true, false);
                        joinBtn.disabled = false;
                        joinBtn.textContent = 'Accept Invitation';
                    }
                }
            }
            
            function displayMessage(type, text, showContent = true, showButtons = true) {
                loadingView.classList.add('hidden');
                roleSelectionView.classList.add('hidden');
                
                if (showContent) {
                     contentView.classList.remove('hidden');
                     messageArea.textContent = text;
                     if (showButtons) actionButtons.classList.remove('hidden'); else actionButtons.classList.add('hidden');
                     if (type === 'error') messageArea.className = 'mt-4 text-sm text-red-600';
                     if (type === 'success') messageArea.className = 'mt-4 text-sm text-green-600';
                     if (type === 'info') messageArea.className = 'mt-4 text-sm text-gray-500';
                } else {
                    contentView.innerHTML = `<p class="text-lg font-semibold ${type === 'error' ? 'text-red-600' : 'text-gray-800'}">${text}</p>`
                    contentView.classList.remove('hidden');
                }
            }
        });
    </script>
</body>
</html>
