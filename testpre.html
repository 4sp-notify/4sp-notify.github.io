<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notify | Dashboard</title>
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' https://cdn.tailwindcss.com https://www.gstatic.com https://apis.google.com https://accounts.google.com https://cdnjs.cloudflare.com 'unsafe-inline' 'unsafe-eval';
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net;
        font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net;
        img-src 'self' data: https://www.gstatic.com https://lh3.googleusercontent.com;
        connect-src 'self' https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://www.googleapis.com https://content.googleapis.com https://classroom.googleapis.com;
        frame-src 'self' https://accounts.google.com https://content.googleapis.com https://content-classroom.googleapis.com;
    ">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css">

    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script> <style>
        /* Base styling using Inter and Poppins fonts */
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        .font-poppins { font-family: 'Poppins', sans-serif; }
        
        /* Custom input style */
        .app-input {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb; /* gray-50 */
        }
        .app-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 1px #3b82f6;
            outline: none;
            background-color: white;
        }

        button, a.btn-bubbly, input, select, textarea { font-family: 'Inter', sans-serif; }
        h1, h2, h3, h4, .font-poppins { font-family: 'Poppins', sans-serif; }

        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px;}
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .main-layout { height: calc(100vh - 4rem); }

        /* Animations */
        .fade-enter-from, .fade-leave-to { opacity: 0; transform: scale(0.95); }
        .fade-enter-active, .fade-leave-active { transition: opacity 200ms ease-out, transform 200ms ease-out; }
        .fade-enter-to, .fade-leave-from { opacity: 1; transform: scale(1); }
        
        .btn-bubbly { transition: transform 0.1s ease-out; }
        .btn-bubbly:active { transform: scale(0.95); }

        .user-profile-menu-container { transition: transform 0.2s ease-out, opacity 0.2s ease-out; transform-origin: top right; }
        .menu-item-icon { display: inline-flex; width: 1.25rem; height: 1.25rem; margin-right: 0.75rem; align-items: center; justify-content: center; }
        
        .hand-status-card { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        .raise-hand-btn { box-shadow: 0 4px 15px 0 rgba(59, 130, 246, 0.4); transition: all 0.3s ease; }
        .raise-hand-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px 0 rgba(59, 130, 246, 0.5); }
        
        /* Combined notification badge */
        .class-notification-badge {
            position: absolute; top: 4px; right: 8px; min-width: 1.5rem; height: 1.5rem; border-radius: 9999px;
            color: white; font-size: 0.75rem; font-weight: bold; display: inline-flex; align-items: center;
            justify-content: center; padding: 0 0.375rem;
        }
        .badge-hands { background-color: #ef4444; /* red-500 */ }
        .badge-requests { background-color: #8b5cf6; /* violet-500 */ }
        .badge-multiple { background: linear-gradient(45deg, #ef4444, #8b5cf6); }

        /* Icon button with tooltip styles */
        .tooltip-container { position: relative; display: flex; flex-direction: column; align-items: center; }
        .tooltip-button { width: 3rem; height: 3rem; border-radius: 0.75rem; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; transition: background-color 0.2s, color 0.2s; }
        .tooltip-text {
            visibility: hidden; opacity: 0; width: max-content; background-color: #1f2937; color: #fff; text-align: center;
            border-radius: 0.375rem; padding: 4px 8px; position: absolute; z-index: 10; bottom: -28px; font-size: 0.75rem;
            font-weight: 500; transition: opacity 0.2s ease-out; pointer-events: none;
        }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
        
        /* Redesigned Schedule Picker */
        .schedule-time-input-container { display: flex; align-items: center; }
        .schedule-time-input { width: 100px; text-align: center; font-family: 'Poppins', sans-serif; font-weight: 500; }
        .period-selector { display: flex; margin-left: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.5rem; overflow: hidden; }
        .period-btn { padding: 0.75rem 1rem; border: none; background-color: #f9fafb; color: #6b7280; cursor: pointer; transition: background-color 0.2s, color 0.2s; font-family: 'Inter', sans-serif;}
        .period-btn.active { background-color: #3b82f6; color: white; }

        /* Custom styles for the new co-teacher request and hand queue action buttons */
        .request-action-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        .request-action-group button {
            width: 80px; /* fixed width for better alignment */
            padding: 0.5rem 0.5rem;
            font-size: 0.75rem; /* text-xs */
        }
        .comment-split-btn {
            display: flex;
            flex-direction: column;
            padding: 0; /* reset padding for split buttons */
        }
        .comment-split-btn button {
            width: 100%;
            padding: 0.25rem 0.5rem;
            border-radius: 0;
            line-height: 1;
        }
        .comment-split-btn button:first-child {
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }
        .comment-split-btn button:last-child {
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
        }
        /* Style for the fixed settings view content - REMOVED SETTINGS-CONTENT-WRAPPER */
        /* To prevent content shift, we apply padding to the main scrollable area */
        #main-content-area {
            padding-right: 18px; /* Fixed padding to account for potential scrollbar width */
        }
    </style>
</head>
<body class="bg-slate-100 h-screen overflow-hidden">

    <div class="flex flex-col h-full">
        <header class="bg-white border-b border-gray-200 shadow-sm sticky top-0 z-30 h-16 flex-shrink-0">
            <div class="max-w-full mx-auto px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <a href="index.html" class="flex items-center space-x-3">
                        <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                        <h1 class="text-xl font-bold text-gray-800">Notify</h1>
                    </a>
                    <div class="relative">
                        <button id="user-profile-btn" type="button" class="btn-bubbly flex items-center justify-center w-10 h-10 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform duration-150 hover:scale-105">
                             <img id="user-profile-pic" class="w-full h-full rounded-lg object-cover hidden" src="" alt="User profile picture">
                             <div id="user-profile-initial" class="w-full h-full rounded-lg flex items-center justify-center bg-gradient-to-br from-blue-600 to-indigo-700 text-white font-bold text-lg hidden"></div>
                        </button>
                        <div id="user-profile-menu" class="user-profile-menu-container absolute right-0 mt-2 w-72 rounded-xl shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden" role="menu">
                            <div class="p-4 bg-gray-50 border-b border-gray-100 rounded-t-xl">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <img id="user-profile-pic-menu" class="h-12 w-12 rounded-full object-cover hidden" src="" alt="">
                                        <div id="user-profile-initial-menu" class="h-12 w-12 rounded-full flex items-center justify-center bg-gradient-to-br from-blue-600 to-indigo-700 text-white font-bold text-xl hidden"></div>
                                    </div>
                                    <div class="ml-3 min-w-0">
                                        <div id="user-display-name-container" class="marquee-container"><p id="user-display-name-menu" class="text-lg font-bold font-poppins text-gray-800 truncate">Loading...</p></div>
                                        <div id="user-email-container" class="marquee-container"><p id="user-email-menu" class="text-sm text-gray-500 truncate">Loading...</p></div>
                                    </div>
                                </div>
                            </div>
                            <div class="py-1" role="none">
                                <a href="settings.html" class="font-medium text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100 flex items-center" role="menuitem" tabindex="-1">
                                    <span class="menu-item-icon"><i class="fa-solid fa-sliders text-gray-400"></i></span>
                                    <span>Settings</span>
                                </a>
                                <a href="#" id="logout-btn" class="font-medium text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100 flex items-center" role="menuitem" tabindex="-1">
                                    <span class="menu-item-icon"><i class="fa-solid fa-right-from-bracket text-gray-400"></i></span>
                                    <span>Logout</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="flex flex-1 main-layout overflow-hidden">
            <aside class="w-72 bg-white border-r border-gray-200 flex flex-col flex-shrink-0">
                <div id="class-list-container" class="flex-grow p-4 overflow-y-auto custom-scrollbar">
                    <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3 px-2">My Classes</h2>
                    <ul id="class-list" class="space-y-1"></ul>
                    <div id="no-classes-sidebar" class="text-center text-sm text-gray-500 mt-4 hidden"><p>No classes yet.</p></div>
                </div>
                <div id="teacher-sidebar-actions" class="p-4 border-t border-gray-200 hidden">
                    <button id="new-class-btn" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-150 flex items-center justify-center space-x-2 btn-bubbly"><i class="fa-solid fa-plus w-5 h-5"></i><span>New Class</span></button>
                    <button id="join-class-btn-main" class="mt-2 w-full bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors duration-150 flex items-center justify-center space-x-2 btn-bubbly text-sm"><i class="fa-solid fa-user-plus w-5 h-5"></i><span>Join Class</span></button>
                </div>
            </aside>
            <main class="flex-1 flex flex-col overflow-hidden">
                <div id="main-content-area" class="flex-1 overflow-y-scroll bg-slate-100 p-6 sm:p-8 custom-scrollbar"></div>
            </main>
        </div>
    </div>
    
    <div id="modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-60 z-40 hidden"></div>
    <div id="modal-container" class="fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none"></div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let currentUser = null, userData = null, currentClassId = null, currentRoster = null;
            let allLoadedClasses = {}, classQueues = {}, classRequests = {}, unsubscribes = [], queueUnsubscribers = {};
            let currentClassView = 'overview';

            const mainContentArea = document.getElementById('main-content-area');
            const classListEl = document.getElementById('class-list');
            const modalContainer = document.getElementById('modal-container');
            const modalBackdrop = document.getElementById('modal-backdrop');

            function onFirebaseReady(callback) { const i = setInterval(() => { if (typeof firebase !== 'undefined') { clearInterval(i); callback(); } }, 50); }

            onFirebaseReady(() => {
                const app = firebase.initializeApp(firebaseConfig);
                const auth = firebase.auth();
                const db = firebase.firestore();
                const FieldValue = firebase.firestore.FieldValue; // Alias for brevity

                auth.onAuthStateChanged(user => {
                    if (user) { currentUser = user; fetchUserData(user.uid); } 
                    else { window.location.href = 'login.html'; }
                });

                async function fetchUserData(uid) {
                    const doc = await db.collection('users').doc(uid).get();
                    if (doc.exists) {
                        userData = { uid, ...doc.data() };
                        updateProfileUI(currentUser, userData);
                        listenForClasses(uid);
                        renderMainContent();
                        initializeScheduleChecker();
                        initializeRequestRecycler(); // NEW: Start request recycler
                    } else { auth.signOut(); }
                }
                
                function updateProfileUI(user, data) {
                    document.getElementById('user-display-name-menu').textContent = data.username;
                    document.getElementById('user-email-menu').textContent = user.email;
                    const pics = [document.getElementById('user-profile-pic'), document.getElementById('user-profile-pic-menu')];
                    const initials = [document.getElementById('user-profile-initial'), document.getElementById('user-profile-initial-menu')];
                    if (user.photoURL) {
                        pics.forEach(el => { el.src = user.photoURL; el.classList.remove('hidden'); });
                        initials.forEach(el => el.classList.add('hidden'));
                    } else {
                        const i = data.username.charAt(0).toUpperCase();
                        initials.forEach(el => { el.textContent = i; el.classList.remove('hidden'); });
                        pics.forEach(el => el.classList.add('hidden'));
                    }
                    document.getElementById('teacher-sidebar-actions').classList.toggle('hidden', data.role !== 'teacher');
                }

                function updateGlobalUI() {
                    updateDocumentTitle();
                    renderClassList(Object.values(allLoadedClasses));
                }
                
                function updateDocumentTitle() {
                    let handsCount = 0, requestsCount = 0;
                    if (userData && allLoadedClasses && classQueues && classRequests) {
                        for (const id in allLoadedClasses) {
                            const cls = allLoadedClasses[id];
                            if (cls) {
                                const isOwner = cls.teacherId === userData.uid;
                                const isCoTeacher = (cls.teacherIds || []).includes(userData.uid);
                                if(isOwner || isCoTeacher) handsCount += (classQueues[id] || []).length;
                                // Only count 'pending' requests for the badge
                                if(isOwner) requestsCount += (classRequests[id] || []).filter(req => req.status === 'pending').length;
                            }
                        }
                    }
                    const totalCount = handsCount + requestsCount;
                    document.title = totalCount > 0 ? `(${totalCount}) Notify | Dashboard` : 'Notify | Dashboard';
                }

                function listenForClasses(uid) {
                    unsubscribes.forEach(unsub => unsub()); unsubscribes = [];
                    Object.values(queueUnsubscribers).forEach(unsub => unsub()); queueUnsubscribers = {};
                    allLoadedClasses = {};

                    const process = (snapshot) => {
                        snapshot.docChanges().forEach(change => {
                            const id = change.doc.id, data = { id, ...change.doc.data() };
                            if (change.type === 'removed') {
                                delete allLoadedClasses[id]; delete classQueues[id]; delete classRequests[id];
                                if (queueUnsubscribers[id]) { queueUnsubscribers[id](); delete queueUnsubscribers[id]; }
                            } else {
                                allLoadedClasses[id] = data;
                                const isOwner = data.teacherId === uid;
                                const isCoTeacher = (data.teacherIds || []).includes(uid);
                                if ((isOwner || isCoTeacher) && !queueUnsubscribers[`hands_${id}`]) {
                                    queueUnsubscribers[`hands_${id}`] = db.collection('classes').doc(id).collection('raisedHands')
                                        .onSnapshot(qSnap => {
                                            classQueues[id] = qSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                                            updateGlobalUI();
                                            if(currentClassId === id) renderMainContent();
                                        });
                                }
                                if(isOwner && !queueUnsubscribers[`requests_${id}`]){
                                    // NEW: Listen to all, then filter 'pending' for count and 'recyclable' for reuse
                                    queueUnsubscribers[`requests_${id}`] = db.collection('classes').doc(id).collection('coTeacherRequests')
                                        .onSnapshot(rSnap => {
                                            classRequests[id] = rSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                                            updateGlobalUI();
                                            if(currentClassId === id) renderMainContent();
                                        });
                                }
                            }
                        });
                        updateGlobalUI();
                    };
                    unsubscribes.push(db.collection('classes').where('teacherId', '==', uid).onSnapshot(process));
                    unsubscribes.push(db.collection('classes').where('studentIds', 'array-contains', uid).onSnapshot(process));
                    unsubscribes.push(db.collection('classes').where('teacherIds', 'array-contains', uid).onSnapshot(process));
                }
                
                function renderClassList(classes) {
                    document.getElementById('no-classes-sidebar').classList.toggle('hidden', classes.length > 0);
                    classListEl.innerHTML = '';
                    classes.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0)).forEach(cls => {
                        const li = document.createElement('li');
                        const isActive = currentClassId === cls.id;
                        const activeClasses = isActive ? 'bg-blue-100 text-blue-800 font-semibold' : 'text-gray-700 hover:bg-slate-100 hover:text-gray-900';
                        
                        const handsCount = classQueues[cls.id]?.length || 0;
                        // Filter requests to only count pending ones for the badge
                        const reqCount = (classRequests[cls.id] || []).filter(req => req.status === 'pending').length;
                        
                        // Determine user role relative to this class
                        const isOwner = cls.teacherId === userData.uid;
                        const isCoTeacher = (cls.teacherIds || []).includes(userData.uid);
                        const isStudent = (cls.studentIds || []).includes(userData.uid) && !isOwner && !isCoTeacher;
                        
                        let buttonsHtml = '';
                        if (isStudent) { // Feature 1: Add a settings dropdown button for students
                            buttonsHtml = `
                                <div class="relative z-10" onclick="event.stopPropagation();">
                                    <button data-class-id="${cls.id}" data-action="settings-menu" class="p-1 rounded-full text-gray-400 hover:text-gray-600 hover:bg-gray-200 transition-colors btn-bubbly">
                                        <i class="fa-solid fa-gear text-sm"></i>
                                    </button>
                                </div>
                            `;
                        } else { // Keep the badge for teachers/co-teachers
                            let badge = '';
                            if(handsCount > 0 && reqCount > 0) badge = `<span class="class-notification-badge badge-multiple">${handsCount + reqCount}</span>`;
                            else if(handsCount > 0) badge = `<span class="class-notification-badge badge-hands">${handsCount}</span>`;
                            else if(reqCount > 0) badge = `<span class="class-notification-badge badge-requests">${reqCount}</span>`;
                            buttonsHtml = badge;
                        }

                        li.innerHTML = `
                            <button data-class-id="${cls.id}" class="w-full text-left px-3 py-2.5 rounded-md font-medium text-sm transition-colors btn-bubbly relative flex justify-between items-center ${activeClasses}">
                                <span class="${isStudent ? 'pr-8' : ''}">${escapeHtml(cls.name)}</span>
                                ${buttonsHtml}
                            </button>
                        `;
                        classListEl.appendChild(li);
                    });
                }
                
                async function selectClass(id) {
                    currentClassId = id; currentClassView = 'overview'; currentRoster = null;
                    if (id) await fetchRosterData(allLoadedClasses[id]);
                    renderMainContent();
                }

                async function fetchRosterData(data) {
                    if (!data) return;
                    const ids = [data.teacherId, ...(data.teacherIds || []), ...(data.studentIds || [])].filter(id => id);
                    if (ids.length === 0) { currentRoster = { owner: {}, coTeachers: [], students: [] }; return; }
                    
                    const userBatches = [];
                    for (let i = 0; i < ids.length; i += 10) {
                        userBatches.push(ids.slice(i, i + 10));
                    }

                    const users = {};
                    for(const batch of userBatches){
                        const docs = await db.collection('users').where(firebase.firestore.FieldPath.documentId(), 'in', batch).get();
                        docs.forEach(doc => { users[doc.id] = doc.data(); });
                    }

                    currentRoster = {
                        owner: { id: data.teacherId, ...users[data.teacherId] },
                        coTeachers: (data.teacherIds || []).map(id => ({ id, ...users[id] })),
                        students: (data.studentIds || []).map(id => ({ id, ...users[id] }))
                    };
                }

                // NEW: Schedule Helper Functions
                function isTimeInSchedule(enableAt, disableAt) {
                    if (!enableAt || !disableAt) return true; // No meaningful schedule set means always active

                    const now = new Date();
                    const currentMinutes = now.getHours() * 60 + now.getMinutes();

                    const [hE, mE] = enableAt.split(':').map(Number);
                    const [hD, mD] = disableAt.split(':').map(Number);

                    const enableMinutes = hE * 60 + mE;
                    const disableMinutes = hD * 60 + mD;

                    if (enableMinutes === disableMinutes) {
                        return true; // Enable and disable are the same time, treat as always enabled
                    }

                    if (enableMinutes < disableMinutes) {
                        // Simple case: 08:00 to 17:00 (no midnight wrap)
                        return currentMinutes >= enableMinutes && currentMinutes < disableMinutes;
                    } else {
                        // Wrap-around case: 22:00 to 02:00
                        // Time is in schedule if it's after enable OR before disable
                        return currentMinutes >= enableMinutes || currentMinutes < disableMinutes;
                    }
                }

                function getEffectiveHandRaisingStatus(cls, isOwner) {
                    const hasSchedule = cls.schedule?.enableAt && cls.schedule?.disableAt;
                    const dbEnabled = cls.handRaisingEnabled;

                    if (!hasSchedule) {
                        return { 
                            enabled: dbEnabled, 
                            override: false, 
                            message: dbEnabled ? '' : 'Manually Paused'
                        };
                    }
                    
                    const isScheduledTime = isTimeInSchedule(cls.schedule.enableAt, cls.schedule.disableAt);
                    let effectiveEnabled = isScheduledTime;
                    let override = false;
                    let message = '';

                    if (isScheduledTime) {
                        if (!dbEnabled) { // Scheduled ON, but DB is OFF -> Manual override to PAUSE
                            effectiveEnabled = false;
                            override = true;
                            message = isOwner ? 'Manually Paused (Override Schedule)' : 'Paused by Teacher (Override)';
                        } else {
                            // Effective ON, no override
                        }
                    } else { // Not scheduled time
                        effectiveEnabled = false;
                        message = 'Paused (Outside Schedule)';

                        if (dbEnabled) { // Scheduled OFF, but DB is ON -> Manual override to RESUME
                            effectiveEnabled = true;
                            override = true;
                            message = isOwner ? 'Manually Resumed (Override Schedule)' : 'Resumed by Teacher (Override)';
                        }
                    }

                    return { 
                        enabled: effectiveEnabled, 
                        override: override, 
                        message: message 
                    };
                }

                function renderMainContent() {
                    if (currentClassId && allLoadedClasses[currentClassId]) {
                        const data = allLoadedClasses[currentClassId];
                        const queue = classQueues[currentClassId] || [];
                        // Filter requests to only show pending ones on the requests tab
                        const pendingRequests = (classRequests[currentClassId] || []).filter(req => req.status === 'pending'); 
                        const isOwner = data.teacherId === userData.uid;
                        const isCoTeacher = (data.teacherIds || []).includes(userData.uid);
                        // Pass pending requests to the template
                        mainContentArea.innerHTML = TPL.classView(data, userData, isOwner, isCoTeacher, queue, pendingRequests, currentClassView, currentRoster);
                        document.body.dispatchEvent(new CustomEvent('mainContentRendered'));
                    } else { mainContentArea.innerHTML = TPL.emptyState(userData); }
                }

                function showModal(html) { modalContainer.innerHTML = html; modalBackdrop.classList.remove('hidden'); const d = modalContainer.firstElementChild; d.classList.add('fade-enter-from'); setTimeout(() => d.classList.remove('fade-enter-from'), 10); }
                function hideModal() { const d=modalContainer.firstElementChild; if(d){d.classList.add('fade-leave-to');modalBackdrop.classList.add('fade-leave-to');setTimeout(() => {modalContainer.innerHTML='';modalBackdrop.classList.add('hidden');modalBackdrop.classList.remove('fade-leave-to');}, 200);}}
                function escapeHtml(text) { if(typeof text!=='string')return'';const d=document.createElement('div');d.textContent=text;return d.innerHTML; }
                
                async function createNewClass(name) { const code=Math.random().toString(36).substring(2,10).toUpperCase(); const coTeacherCode = 'T' + Math.random().toString(36).substring(2,9).toUpperCase(); await db.collection('classes').add({name,teacherId:currentUser.uid,teacherIds:[],code,coTeacherCode,studentIds:[],pendingStudentEmails:[],handRaisingEnabled:true,schedule:{enableAt:'',disableAt:''},scheduleLastActionDate:'',createdAt:FieldValue.serverTimestamp()});hideModal();}
                async function joinClass(code) {
                    const studentQuery = db.collection('classes').where('code', '==', code).limit(1).get();
                    const teacherQuery = db.collection('classes').where('coTeacherCode', '==', code).limit(1).get();
                    const [studentSnap, teacherSnap] = await Promise.all([studentQuery, teacherQuery]);
                    
                    if (teacherSnap.empty && studentSnap.empty) { showModal(TPL.messageModal('Error','Invalid class code.','red')); return; }
                    
                    if (!teacherSnap.empty) { // Co-teacher join
                        const classDoc = teacherSnap.docs[0];
                        const classData = classDoc.data();
                        if (userData.role !== 'teacher') { showModal(TPL.messageModal('Access Denied', 'Only users with a teacher account can join with this code.', 'red')); return; }
                        const isMember = classData.teacherId === currentUser.uid || (classData.teacherIds || []).includes(currentUser.uid);
                        if (isMember) { showModal(TPL.messageModal('Already Enrolled', `You are already a teacher in ${classData.name}.`, 'yellow')); return; }
                        hideModal();
                        showModal(TPL.requestCoTeacherModal(classDoc.id, classData.name));
                    } else { // Student join
                        const classDoc = studentSnap.docs[0];
                        const classData = classDoc.data();
                        const isMember = classData.teacherId === currentUser.uid || (classData.teacherIds || []).includes(currentUser.uid) || (classData.studentIds || []).includes(currentUser.uid);
                        if(isMember){ showModal(TPL.messageModal('Already Enrolled',`You are already a member of ${classData.name}.`,'yellow')); return; }
                        
                        // Any user type can join as a student with the student code
                        await db.collection('classes').doc(classDoc.id).update({studentIds:FieldValue.arrayUnion(currentUser.uid)});
                        hideModal();
                        showModal(TPL.messageModal('Success',`Successfully joined class: ${classData.name} as a student!`,'green'));
                    }
                }

                // NEW: Logic to find a recyclable request slot
                async function findRecyclableRequestSlot(classId) {
                    const recyclableSnap = await db.collection('classes').doc(classId).collection('coTeacherRequests')
                        .where('status', '==', 'recyclable')
                        .limit(1)
                        .get();
                    
                    if (!recyclableSnap.empty) {
                        return recyclableSnap.docs[0].id;
                    }
                    return currentUser.uid; // Default to using the user's ID as the doc ID
                }

                // UPDATED: requestCoTeacher to use recyclable slot
                async function requestCoTeacher(classId, comment) {
                    const docId = await findRecyclableRequestSlot(classId); // Find or use current user's ID
                    
                    const requestData = {
                        requesterName: userData.username,
                        comment: comment,
                        status: 'pending',
                        requestedAt: FieldValue.serverTimestamp(),
                        // NEW: Ensure all fields are set for a fresh request, even if recycling
                        requesterEmail: currentUser.email, // Good to have for the teacher
                        requesterId: currentUser.uid // Store actual requester ID
                    };

                    await db.collection('classes').doc(classId).collection('coTeacherRequests').doc(docId).set(requestData);
                    hideModal();
                    showModal(TPL.messageModal('Request Sent', 'Your request to join as a co-teacher has been sent to the class owner.', 'green'));
                }

                // UPDATED: handleCoTeacherRequest to use full fields
                async function handleCoTeacherRequest(classId, requestDocId, action) {
                    const requestRef = db.collection('classes').doc(classId).collection('coTeacherRequests').doc(requestDocId);
                    
                    const requestDoc = await requestRef.get();
                    if (!requestDoc.exists) return; // Should not happen

                    const requesterId = requestDoc.data().requesterId; // Get the actual requester ID

                    if(action === 'accept'){
                        await db.collection('classes').doc(classId).update({ teacherIds: FieldValue.arrayUnion(requesterId) });
                        await requestRef.update({ status: 'accepted' });
                    } else if (action === 'deny') {
                        await requestRef.update({ status: 'denied' });
                    } else if (action === 'comment-edit' || action === 'comment-delete') {
                         showModal(TPL.messageModal('Feature Update', 'Commenting on requests is a planned feature! This button is currently for demonstration.', 'yellow'));
                         return; // Placeholder for future comment logic
                    }
                    // For accept/deny, hide the modal and re-render the main content
                    hideModal();
                    renderMainContent(); 
                }
                
                async function raiseHand(id,q){await db.collection('classes').doc(id).collection('raisedHands').doc(currentUser.uid).set({studentName:userData.username,studentPhotoURL:currentUser.photoURL||'',question:q||'',raisedAt:FieldValue.serverTimestamp()});hideModal();}
                async function lowerHand(id,studentId=currentUser.uid){await db.collection('classes').doc(id).collection('raisedHands').doc(studentId).delete();}
                async function lowerAllHands(id){const s=await db.collection('classes').doc(id).collection('raisedHands').get();const b=db.batch();s.docs.forEach(d=>b.delete(d.ref));await b.commit();}
                
                // FIXED: toggleHandRaising to include immediate UI update
                async function toggleHandRaising(id, status, buttonEl) {
                    // Immediate UI update (NEW)
                    if (buttonEl) {
                        buttonEl.classList.toggle('bg-yellow-100', !status);
                        buttonEl.classList.toggle('text-yellow-600', !status);
                        buttonEl.classList.toggle('hover:bg-yellow-200', !status);
                        buttonEl.classList.toggle('bg-gray-200', status);
                        buttonEl.classList.toggle('text-gray-600', status);
                        buttonEl.classList.toggle('hover:bg-gray-300', status);
                        
                        const icon = buttonEl.querySelector('i');
                        if (icon) {
                            icon.classList.toggle('fa-hand', !status);
                            icon.classList.toggle('fa-hand-sparkles', status);
                        }
                        
                        const tooltip = buttonEl.closest('.tooltip-container').querySelector('.tooltip-text');
                        if (tooltip) {
                            tooltip.textContent = !status ? 'Pause Raising' : 'Resume Raising';
                        }
                    }
                    // DB update
                    await db.collection('classes').doc(id).update({ handRaisingEnabled: !status });
                    // onSnapshot listener will handle the full re-render and UI changes eventually.
                }

                async function handleChangeClassName(id,name){const today=new Date().toISOString().split('T')[0];const key=`classNameChanges_${id}`;let changes;try{changes=JSON.parse(localStorage.getItem(key))||{};}catch(e){changes={};}if(changes.date!==today){changes={date:today,count:0};}if(changes.count>=3){showModal(TPL.messageModal('Limit Reached','You can only change the class name 3 times per day.','red'));return;}await db.collection('classes').doc(id).update({name});changes.count++;localStorage.setItem(key,JSON.stringify(changes));showModal(TPL.messageModal('Success','Class name updated!','green'));}
                // FIXED: handleSaveSchedule now takes 24-hour time strings directly from the template logic
                async function handleSaveSchedule(id,enable,disable){ 
                    await db.collection('classes').doc(id).update({ 
                        schedule:{enableAt:enable,disableAt:disable},
                        scheduleLastActionDate: '' 
                    }); 
                    showModal(TPL.messageModal('Success','Schedule saved!','green')); 
                }

                // FIXED: deleteSchedule now clears input boxes
                async function deleteSchedule(id) {
                    await db.collection('classes').doc(id).update({ 
                        'schedule.enableAt': '', 
                        'schedule.disableAt': '' 
                    });
                    // NEW: Clear the text boxes
                    const enableInput = document.getElementById('enable-time-input');
                    const disableInput = document.getElementById('disable-time-input');
                    if (enableInput) {
                        enableInput.value = '';
                        enableInput.dataset.time24hr = '';
                        enableInput.dataset.digits = '';
                        const periodBtns = enableInput.closest('.schedule-time-input-container').querySelectorAll('.period-btn');
                        periodBtns.forEach(btn => btn.classList.remove('active'));
                    }
                    if (disableInput) {
                        disableInput.value = '';
                        disableInput.dataset.time24hr = '';
                        disableInput.dataset.digits = '';
                        const periodBtns = disableInput.closest('.schedule-time-input-container').querySelectorAll('.period-btn');
                        periodBtns.forEach(btn => btn.classList.remove('active'));
                    }
                    showModal(TPL.messageModal('Success', 'Schedule has been removed.', 'green'));
                }

                async function removeUserFromClass(id, userId) { 
                    const data = allLoadedClasses[id]; 
                    if ((data.teacherIds || []).includes(userId)) { 
                        await db.collection('classes').doc(id).update({ teacherIds: FieldValue.arrayRemove(userId) }); 
                    } else if ((data.studentIds || []).includes(userId)) { 
                        await db.collection('classes').doc(id).update({ studentIds: FieldValue.arrayRemove(userId) }); 
                    } 
                    await fetchRosterData(allLoadedClasses[id]); 
                    renderMainContent(); 
                }

                async function handleDeleteClass(id){const s=await db.collection('classes').doc(id).collection('raisedHands').get();const b=db.batch();s.docs.forEach(d=>b.delete(d.ref));b.delete(db.collection('classes').doc(id));await b.commit();hideModal();selectClass(null);}
                
                let scheduleInterval = null;
                function initializeScheduleChecker() { 
                    if (scheduleInterval) clearInterval(scheduleInterval); 
                    scheduleInterval = setInterval(() => { 
                        const now = new Date(); 
                        const todayStr = now.toISOString().split('T')[0]; 
                        if (!userData || userData.role !== 'teacher') return; 
                        for (const classId in allLoadedClasses) { 
                            const cls = allLoadedClasses[classId]; 
                            if (cls.teacherId === userData.uid) { // Only the owner handles auto-disabling 
                                if (cls.schedule?.disableAt) { 
                                    // Check for auto-disable logic (using DB handRaisingEnabled as the override state) 
                                    const effectiveStatus = getEffectiveHandRaisingStatus(cls, true); 
                                    // If scheduled time is over (effective status is disabled), and the teacher has not overridden it 
                                    // and the DB still says it's enabled (meaning it hasn't been auto-disabled today yet). 
                                    if (!effectiveStatus.enabled && !effectiveStatus.override && cls.handRaisingEnabled && cls.scheduleLastActionDate !== todayStr) { 
                                        console.log(`Auto-disabling for ${cls.name} due to schedule end.`); 
                                        // Set the DB to disabled and record the date to prevent further action today 
                                        db.collection('classes').doc(classId).update({ 
                                            scheduleLastActionDate: todayStr, 
                                            handRaisingEnabled: false 
                                        }); 
                                        lowerAllHands(classId); // Lower hands when auto-disabling 
                                    } 
                                } 
                            } 
                        } 
                    }, 60000); // Check every minute 
                } 

                // NEW: Request Recycler Logic
                let recyclerInterval = null; 
                function initializeRequestRecycler() { 
                    if (recyclerInterval) clearInterval(recyclerInterval); 
                    recyclerInterval = setInterval(async () => { 
                        const now = new Date();
                        const thirtyDaysAgo = new Date(now.setDate(now.getDate() - 30));
                        
                        // Find all requests older than 30 days that are 'accepted' or 'denied'
                        const ownerClasses = Object.values(allLoadedClasses).filter(cls => cls.teacherId === userData?.uid);

                        for(const cls of ownerClasses){
                            const oldRequestsSnap = await db.collection('classes').doc(cls.id).collection('coTeacherRequests')
                                .where('requestedAt', '<', thirtyDaysAgo)
                                .where('status', 'in', ['accepted', 'denied'])
                                .get();
                            
                            const batch = db.batch();
                            oldRequestsSnap.docs.forEach(doc => {
                                // Update status to 'recyclable' instead of deleting
                                batch.update(doc.ref, { status: 'recyclable' });
                            });
                            await batch.commit();
                        }

                    }, 24 * 60 * 60 * 1000); // Run once per day
                }

                // NEW: Student settings functions (Feature 2)
                async function saveStudentNickname(classId, nickname) {
                    const classRef = db.collection('classes').doc(classId);
                    const updateData = {};

                    if (nickname && nickname.trim() !== '') {
                        updateData[`studentNicknames.${currentUser.uid}`] = nickname.trim();
                    } else {
                        // If nickname is empty, remove it from the map
                        updateData[`studentNicknames.${currentUser.uid}`] = FieldValue.delete();
                    }

                    await classRef.update(updateData);
                    // Force re-fetch of class data to update sidebar and roster
                    await fetchRosterData(allLoadedClasses[classId]); 
                    hideModal();
                    showModal(TPL.messageModal('Success', 'Your class nickname has been updated!', 'green'));
                    
                    // Re-render to update the current view if it was the settings view
                    if (currentClassView === 'settings') renderMainContent();
                }

                async function leaveClass(classId) {
                    await db.collection('classes').doc(classId).update({ 
                        studentIds: FieldValue.arrayRemove(currentUser.uid) 
                    });
                    
                    await lowerHand(classId, currentUser.uid); // Also remove any pending hands

                    hideModal();
                    showModal(TPL.messageModal('Class Left', 'You have successfully left the class.', 'green'));
                    selectClass(null); // Return to empty state
                }

                // --- TEMPLATES (TPL) ---
                const TPL = {
                    // A general message/info/error modal
                    messageModal: (title, message, color = 'blue') => `
                        <div class="modal-dialog max-w-sm pointer-events-auto">
                            <div class="bg-white rounded-xl shadow-2xl p-6 text-center">
                                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full ${color === 'red' ? 'bg-red-100' : color === 'yellow' ? 'bg-yellow-100' : color === 'green' ? 'bg-green-100' : 'bg-blue-100'}">
                                    <i class="fa-solid fa-circle-${color === 'red' ? 'xmark' : color === 'yellow' ? 'exclamation' : color === 'green' ? 'check' : 'info'} text-xl ${color === 'red' ? 'text-red-600' : color === 'yellow' ? 'text-yellow-600' : color === 'green' ? 'text-green-600' : 'text-blue-600'}"></i>
                                </div>
                                <h3 class="mt-4 text-lg font-bold font-poppins text-gray-900">${escapeHtml(title)}</h3>
                                <p class="mt-2 text-sm text-gray-500">${escapeHtml(message)}</p>
                                <div class="mt-4">
                                    <button onclick="hideModal()" class="w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 btn-bubbly">OK</button>
                                </div>
                            </div>
                        </div>
                    `,

                    // Modal for creating a new class (Teacher feature)
                    newClassModal: () => `
                        <div class="modal-dialog max-w-md pointer-events-auto">
                            <div class="bg-white rounded-xl shadow-2xl p-6">
                                <h3 class="text-xl font-bold font-poppins text-gray-900 mb-4">Create New Class</h3>
                                <input id="new-class-name" type="text" placeholder="Enter Class Name (e.g., Algebra 1 - Period 3)" class="app-input w-full">
                                <div class="mt-6 flex justify-end space-x-3">
                                    <button onclick="hideModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors btn-bubbly">Cancel</button>
                                    <button id="create-class-submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors btn-bubbly">Create Class</button>
                                </div>
                            </div>
                        </div>
                    `,

                    // Modal for joining a class
                    joinClassModal: (isTeacher) => `
                        <div class="modal-dialog max-w-md pointer-events-auto">
                            <div class="bg-white rounded-xl shadow-2xl p-6">
                                <h3 class="text-xl font-bold font-poppins text-gray-900 mb-4">${isTeacher ? 'Join/Request Class' : 'Join Class'}</h3>
                                <p class="text-sm text-gray-500 mb-4">Enter the **Student Code** to join as a student, or the **Co-Teacher Code** to request to join as a co-teacher (if you are a teacher).</p>
                                <input id="join-class-code" type="text" placeholder="Enter Class Code" class="app-input w-full uppercase">
                                <div class="mt-6 flex justify-end space-x-3">
                                    <button onclick="hideModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors btn-bubbly">Cancel</button>
                                    <button id="join-class-submit" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors btn-bubbly">Join Class</button>
                                </div>
                            </div>
                        </div>
                    `,

                    // Modal for co-teacher request
                    requestCoTeacherModal: (classId, className) => `
                        <div class="modal-dialog max-w-md pointer-events-auto">
                            <div class="bg-white rounded-xl shadow-2xl p-6">
                                <h3 class="text-xl font-bold font-poppins text-gray-900 mb-4">Request Co-Teacher Status</h3>
                                <p class="text-sm text-gray-700 mb-4">You are requesting to join **${escapeHtml(className)}** as a co-teacher. Add a brief message for the class owner.</p>
                                <textarea id="request-comment" rows="3" placeholder="I would like to co-teach this class because..." class="app-input w-full"></textarea>
                                <div class="mt-6 flex justify-end space-x-3">
                                    <button onclick="hideModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors btn-bubbly">Cancel</button>
                                    <button data-class-id="${classId}" id="send-request-submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors btn-bubbly">Send Request</button>
                                </div>
                            </div>
                        </div>
                    `,

                    // Modal for students to raise a hand
                    raiseHandModal: (classId) => `
                        <div class="modal-dialog max-w-md pointer-events-auto">
                            <div class="bg-white rounded-xl shadow-2xl p-6">
                                <h3 class="text-xl font-bold font-poppins text-gray-900 mb-4">Raise Hand</h3>
                                <p class="text-sm text-gray-500 mb-4">What's your question or comment? (Optional)</p>
                                <textarea id="hand-question" rows="3" placeholder="e.g., 'Can you re-explain step 3?'" class="app-input w-full"></textarea>
                                <div class="mt-6 flex justify-end space-x-3">
                                    <button onclick="hideModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors btn-bubbly">Cancel</button>
                                    <button data-class-id="${classId}" id="raise-hand-submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors btn-bubbly">Raise Hand</button>
                                </div>
                            </div>
                        </div>
                    `,
                    
                    // Modal for teachers to view a raised hand
                    viewHandModal: (hand) => `
                        <div class="modal-dialog max-w-lg pointer-events-auto">
                            <div class="bg-white rounded-xl shadow-2xl p-6">
                                <h3 class="text-xl font-bold font-poppins text-gray-900 mb-4">Question from ${escapeHtml(hand.studentName)}</h3>
                                <div class="flex items-center space-x-3 mb-4">
                                    <img src="${hand.studentPhotoURL || '/default-avatar.png'}" class="h-10 w-10 rounded-full object-cover" alt="Student Photo">
                                    <p class="text-sm text-gray-500">${hand.studentName} asked ${moment(hand.raisedAt.toDate()).fromNow()}</p>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                    <p class="text-gray-800">${escapeHtml(hand.question) || 'No question provided.'}</p>
                                </div>
                                <div class="mt-6 flex justify-end space-x-3">
                                    <button onclick="hideModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors btn-bubbly">Close</button>
                                    <button data-class-id="${hand.classId}" data-student-id="${hand.id}" id="lower-hand-submit" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors btn-bubbly">Lower Hand</button>
                                </div>
                            </div>
                        </div>
                    `,
                    
                    // Simple modal to confirm leaving the class (Feature 2)
                    confirmLeaveClassModal: (classId, className) => `
                        <div class="modal-dialog max-w-sm pointer-events-auto">
                            <div class="bg-white rounded-xl shadow-2xl p-6 text-center">
                                <i class="fa-solid fa-triangle-exclamation text-3xl mb-3 text-red-600"></i>
                                <h3 class="mt-2 text-lg font-bold font-poppins text-gray-900">Are you sure?</h3>
                                <p class="mt-2 text-sm text-gray-500">You are about to leave the class **${escapeHtml(className)}**. This action cannot be undone.</p>
                                <div class="mt-4 flex justify-center space-x-3">
                                    <button onclick="hideModal()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors btn-bubbly">Cancel</button>
                                    <button data-class-id="${classId}" id="confirm-leave-class-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors btn-bubbly">Yes, Leave Class</button>
                                </div>
                            </div>
                        </div>
                    `,

                    // --- Teacher Template Placeholders (Required by renderMainContent) ---
                    handQueue: (cls, queue) => {
                        if(queue.length === 0) return `<div class="text-center p-8 text-gray-500"><i class="fa-solid fa-check-circle text-3xl mb-3 text-green-500"></i><p>The queue is empty. Good job!</p></div>`;
                        return queue.map(hand => `
                            <li class="flex justify-between items-center p-4 bg-white border-b hover:bg-gray-50">
                                <div class="flex items-center">
                                    <img src="${hand.studentPhotoURL || '/default-avatar.png'}" class="h-10 w-10 rounded-full object-cover mr-3" alt="Student Photo">
                                    <div>
                                        <p class="font-semibold text-gray-800">${escapeHtml(hand.studentName)}</p>
                                        <p class="text-sm text-gray-500 truncate max-w-xs">${escapeHtml(hand.question) || 'No question provided.'}</p>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button data-class-id="${cls.id}" data-hand-id="${hand.id}" data-action="view" class="px-3 py-1 text-sm bg-blue-500 text-white rounded-lg hover:bg-blue-600 btn-bubbly">View</button>
                                    <button data-class-id="${cls.id}" data-hand-id="${hand.id}" data-action="lower" class="px-3 py-1 text-sm bg-red-500 text-white rounded-lg hover:bg-red-600 btn-bubbly">Done</button>
                                </div>
                            </li>
                        `).join('');
                    },
                    
                    teacherRequestsView: (classId, pendingRequests, allRequests) => {
                        if(pendingRequests.length === 0) return `<p class="text-center text-gray-500 mt-8">No pending co-teacher requests.</p>`;
                        return pendingRequests.map(req => `
                            <li class="flex justify-between items-start p-4 bg-white border-b hover:bg-gray-50">
                                <div>
                                    <p class="font-semibold text-gray-800">${escapeHtml(req.requesterName)}</p>
                                    <p class="text-sm text-gray-500">${escapeHtml(req.requesterEmail)}</p>
                                    <p class="text-sm italic mt-2 text-gray-600">"${escapeHtml(req.comment) || 'No comment provided.'}"</p>
                                    <p class="text-xs text-gray-400 mt-1">${moment(req.requestedAt.toDate()).fromNow()}</p>
                                </div>
                                <div class="request-action-group">
                                    <button data-request-id="${req.id}" data-action="accept" class="bg-green-500 text-white rounded-lg hover:bg-green-600 btn-bubbly">Accept</button>
                                    <button data-request-id="${req.id}" data-action="deny" class="bg-red-500 text-white rounded-lg hover:bg-red-600 btn-bubbly">Deny</button>
                                    <div class="comment-split-btn mt-2">
                                        <button data-request-id="${req.id}" data-action="comment-edit" class="bg-blue-500 text-white hover:bg-blue-600 btn-bubbly"><i class="fa-solid fa-comment"></i> Edit</button>
                                        <button data-request-id="${req.id}" data-action="comment-delete" class="bg-gray-500 text-white hover:bg-gray-600 btn-bubbly"><i class="fa-solid fa-trash"></i> Del</button>
                                    </div>
                                </div>
                            </li>
                        `).join('');
                    },
                    
                    teacherControls: (cls, status, isOwner) => `
                        <div class="tooltip-container">
                            <button data-class-id="${cls.id}" id="toggle-hand-raising-btn" data-status="${status.enabled}" class="tooltip-button ${status.enabled ? 'bg-gray-200 text-gray-600 hover:bg-gray-300' : 'bg-yellow-100 text-yellow-600 hover:bg-yellow-200'} btn-bubbly">
                                <i class="fa-solid ${status.enabled ? 'fa-hand-sparkles' : 'fa-hand-slash'}"></i>
                            </button>
                            <span class="tooltip-text">${status.enabled ? 'Pause Raising' : 'Resume Raising'}</span>
                        </div>
                        ${isOwner ? `
                            <div class="tooltip-container">
                                <button onclick="currentClassView='settings'; renderMainContent();" class="tooltip-button bg-blue-100 text-blue-600 hover:bg-blue-200 btn-bubbly">
                                    <i class="fa-solid fa-gear"></i>
                                </button>
                                <span class="tooltip-text">Class Settings</span>
                            </div>
                        ` : ''}
                    `,
                    
                    // --- The Main Content Views ---
                    
                    // Default dashboard when no class is selected
                    emptyState: (userData) => `
                        <div class="max-w-3xl mx-auto mt-16 text-center">
                            <svg class="mx-auto h-16 w-16 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7m-9 6h4m-2-2v4m-5 3h10a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10z" />
                            </svg>
                            <h3 class="mt-4 text-2xl font-bold font-poppins text-gray-900">Welcome to Notify!</h3>
                            <p class="mt-1 text-base text-gray-500">
                                Select a class from the sidebar to begin, or ${userData.role === 'teacher' ? 'create a new class' : 'join an existing class'}.
                            </p>
                            <div class="mt-6 flex justify-center space-x-4">
                                ${userData.role === 'teacher' ? 
                                    `<button onclick="showModal(TPL.newClassModal())" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 btn-bubbly">
                                        <i class="fa-solid fa-plus -ml-1 mr-2 h-5 w-5"></i> New Class
                                    </button>` : ''}
                                <button onclick="showModal(TPL.joinClassModal(${userData.role === 'teacher'}))" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 btn-bubbly">
                                    <i class="fa-solid fa-user-plus -ml-1 mr-2 h-5 w-5"></i> Join Class
                                </button>
                            </div>
                        </div>
                    `,

                    // Class View: The main content container that switches between tabs
                    classView: (cls, userData, isOwner, isCoTeacher, queue, pendingRequests, view, roster) => {
                        const isTeacherRole = isOwner || isCoTeacher;
                        const isStudent = (cls.studentIds || []).includes(userData.uid) && !isTeacherRole;
                        const status = getEffectiveHandRaisingStatus(cls, isOwner);
                        const activeTabClasses = (tab) => view === tab ? 'border-blue-600 text-blue-600 font-semibold' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300';
                        
                        let content = '';
                        // Determine which view content to render
                        if (view === 'overview') content = TPL.overviewView(cls.id, cls, isTeacherRole, status.enabled, status.message, queue, isStudent);
                        else if (view === 'roster') content = TPL.rosterView(cls.id, roster, isOwner);
                        else if (view === 'schedule') content = TPL.scheduleView(cls);
                        else if (view === 'requests' && isTeacherRole) content = TPL.teacherRequestsView(cls.id, pendingRequests, classRequests[cls.id] || []);
                        else if (view === 'my-requests' && isStudent) { // Feature 3: Student My Requests tab
                            const myRequests = (classRequests[cls.id] || []).filter(req => req.requesterId === userData.uid);
                            content = TPL.myRequestsView(cls.id, myRequests);
                        } else if (view === 'settings') {
                            // Feature 1: Student settings tab (or fallback to teacher settings)
                             if (isStudent) content = TPL.studentSettingsView(cls, userData);
                             else content = TPL.classSettingsView(cls); // Teacher settings
                        } else {
                             content = TPL.overviewView(cls.id, cls, isTeacherRole, status.enabled, status.message, queue, isStudent); // Fallback to overview
                        }

                        return `
                            <div class="max-w-7xl mx-auto w-full">
                                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                                    <div class="flex justify-between items-start mb-4">
                                        <div>
                                            <h2 class="text-3xl font-bold font-poppins text-gray-900">${escapeHtml(cls.name)}</h2>
                                            <p class="text-sm text-gray-500 mt-1">
                                                ${isTeacherRole ? `Student Code: <span class="font-mono font-bold text-gray-700">${cls.code}</span>` : `Teacher: ${roster?.owner?.username || 'Loading...'}`}
                                                ${isOwner ? ` | Co-Teacher Code: <span class="font-mono font-bold text-gray-700">${cls.coTeacherCode}</span>` : ''}
                                            </p>
                                            ${isStudent && cls.studentNicknames?.[userData.uid] ? `<p class="text-sm text-blue-500 mt-1">Your Class Nickname: ${escapeHtml(cls.studentNicknames[userData.uid])}</p>` : ''}
                                        </div>
                                        
                                        <div class="flex space-x-2">
                                             ${isTeacherRole ? TPL.teacherControls(cls, status, isOwner) : ''}
                                        </div>
                                    </div>

                                    <div class="border-b border-gray-200">
                                        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                                            <button data-tab="overview" onclick="currentClassView='overview'; renderMainContent();" class="whitespace-nowrap py-3 px-1 border-b-2 ${activeTabClasses('overview')} text-sm transition-colors">Overview</button>
                                            <button data-tab="roster" onclick="currentClassView='roster'; renderMainContent();" class="whitespace-nowrap py-3 px-1 border-b-2 ${activeTabClasses('roster')} text-sm transition-colors">Roster</button>
                                            
                                            ${isTeacherRole ? `
                                                <button data-tab="schedule" onclick="currentClassView='schedule'; renderMainContent();" class="whitespace-nowrap py-3 px-1 border-b-2 ${activeTabClasses('schedule')} text-sm transition-colors">Schedule</button>
                                                <button data-tab="requests" onclick="currentClassView='requests'; renderMainContent();" class="whitespace-nowrap py-3 px-1 border-b-2 ${activeTabClasses('requests')} text-sm transition-colors">Co-Teacher Requests (${pendingRequests.length})</button>
                                                <button data-tab="settings" onclick="currentClassView='settings'; renderMainContent();" class="whitespace-nowrap py-3 px-1 border-b-2 ${activeTabClasses('settings')} text-sm transition-colors"><i class="fa-solid fa-gear mr-1"></i> Settings</button>
                                            ` : `
                                                <button data-tab="my-requests" onclick="currentClassView='my-requests'; renderMainContent();" class="whitespace-nowrap py-3 px-1 border-b-2 ${activeTabClasses('my-requests')} text-sm transition-colors">My Requests</button>
                                                <button data-tab="settings" onclick="currentClassView='settings'; renderMainContent();" class="whitespace-nowrap py-3 px-1 border-b-2 ${activeTabClasses('settings')} text-sm transition-colors"><i class="fa-solid fa-gear mr-1"></i> Settings</button>
                                            `}
                                        </nav>
                                    </div>
                                </div>

                                <div id="class-content-area" class="pb-8">
                                    ${content}
                                </div>
                            </div>
                        `;
                    },

                    // Class View - Overview Tab (Student/Teacher)
                    overviewView: (classId, data, isTeacherRole, handRaisingEnabled, handRaisingMessage, queue, isStudent) => {
                        let content = '';
                        const handCount = queue.length;
                        const handStatusClass = handRaisingEnabled ? 'bg-green-600' : 'bg-red-600';
                        const handStatusIcon = handRaisingEnabled ? 'fa-hand-sparkles' : 'fa-hand-slash';
                        const handStatusText = handRaisingEnabled ? 'Raising Enabled' : 'Raising Paused';
                        const handStatusMessage = handRaisingMessage ? `<p class="text-xs text-gray-500 mt-2 italic">${handRaisingMessage}</p>` : '';
                        const handMessage = isStudent && handRaisingEnabled && queue.find(h => h.id === userData.uid) ? `
                            <div class="bg-yellow-100 border border-yellow-300 text-yellow-800 p-4 rounded-lg mb-6">
                                <i class="fa-solid fa-exclamation-triangle mr-2"></i> Your hand is already raised.
                            </div>
                        ` : '';
                        
                        if (isTeacherRole) {
                            content = `
                                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                    <div class="lg:col-span-1 p-6 rounded-xl shadow-lg hand-status-card">
                                        <div class="flex items-center">
                                            <i class="${handStatusIcon} text-4xl mr-4 ${handStatusClass} text-white p-3 rounded-full"></i>
                                            <div>
                                                <h3 class="text-lg font-bold font-poppins text-gray-800">${handStatusText}</h3>
                                                ${handStatusMessage}
                                            </div>
                                        </div>
                                        <div class="mt-4 flex justify-between items-center border-t border-gray-300 pt-4">
                                            <p class="text-sm text-gray-600">Total Students: ${data.studentIds?.length || 0}</p>
                                            <p class="text-sm text-gray-600">Co-Teachers: ${data.teacherIds?.length || 0}</p>
                                        </div>
                                    </div>
                                    
                                    <div class="lg:col-span-2 bg-white rounded-xl shadow-lg">
                                        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                                            <h3 class="text-xl font-bold font-poppins text-gray-900">Hand Queue (${handCount})</h3>
                                            <button data-class-id="${classId}" ${handCount === 0 ? 'disabled' : ''} id="lower-all-hands-btn" class="px-3 py-1 text-sm bg-red-100 text-red-600 rounded-lg hover:bg-red-200 disabled:opacity-50 transition-colors btn-bubbly">Lower All</button>
                                        </div>
                                        <ul class="divide-y divide-gray-100 max-h-96 overflow-y-auto">
                                            ${TPL.handQueue(data, queue)}
                                        </ul>
                                    </div>
                                </div>
                            `;
                        } else { // Student View
                            const hasHandRaised = queue.find(h => h.id === userData.uid);
                            content = `
                                <div class="max-w-lg mx-auto p-6 bg-white rounded-xl shadow-lg text-center">
                                    <i class="${handStatusIcon} text-5xl mx-auto ${handStatusClass} text-white p-4 rounded-full mb-4"></i>
                                    <h3 class="text-xl font-bold font-poppins text-gray-900">${handStatusText}</h3>
                                    ${handStatusMessage}
                                    
                                    ${handMessage}
                                    
                                    <div class="mt-6">
                                        ${hasHandRaised ? `
                                            <button data-class-id="${classId}" id="lower-hand-student-btn" class="raise-hand-btn bg-red-600 text-white font-bold py-3 px-8 rounded-full hover:bg-red-700 transition-colors duration-300">
                                                <i class="fa-solid fa-hand-fist mr-2"></i> Lower Hand
                                            </button>
                                        ` : `
                                            <button data-class-id="${classId}" id="raise-hand-student-btn" ${!handRaisingEnabled ? 'disabled' : ''} class="raise-hand-btn bg-blue-600 text-white font-bold py-3 px-8 rounded-full hover:bg-blue-700 transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                                                <i class="fa-solid fa-hand mr-2"></i> Raise Hand
                                            </button>
                                        `}
                                    </div>
                                </div>
                            `;
                        }
                        return content;
                    },

                    // Class View - Roster Tab
                    rosterView: (classId, roster, isOwner) => {
                        if (!roster) return `<p class="text-center text-gray-500 mt-8">Loading roster...</p>`;

                        const renderUser = (user, role) => {
                            const isSelf = user.id === userData.uid;
                            const nickname = classId && allLoadedClasses[classId]?.studentNicknames?.[user.id] ? 
                                ` (<span class="text-blue-500 italic">${escapeHtml(allLoadedClasses[classId].studentNicknames[user.id])}</span>)` : '';
                            return `
                                <li class="flex justify-between items-center p-4 bg-white border-b hover:bg-gray-50">
                                    <div class="flex items-center space-x-3">
                                        <img src="${user.photoURL || '/default-avatar.png'}" class="h-10 w-10 rounded-full object-cover" alt="User Photo">
                                        <div>
                                            <p class="font-semibold text-gray-800">${escapeHtml(user.username)} ${isSelf ? '(You)' : ''} ${role === 'student' ? nickname : ''}</p>
                                            <p class="text-sm text-gray-500">${user.email}</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <span class="text-sm font-medium ${role === 'owner' ? 'text-blue-600' : role === 'coTeacher' ? 'text-green-600' : 'text-gray-500'}">
                                            ${role === 'owner' ? 'Owner' : role === 'coTeacher' ? 'Co-Teacher' : 'Student'}
                                        </span>
                                        ${isOwner && !isSelf && role !== 'owner' ? `
                                            <button data-user-id="${user.id}" data-action="remove" class="text-red-500 hover:text-red-700 transition-colors btn-bubbly">
                                                <i class="fa-solid fa-user-minus"></i>
                                            </button>
                                        ` : ''}
                                    </div>
                                </li>
                            `;
                        };
                        
                        const ownerHtml = roster.owner ? renderUser(roster.owner, 'owner') : '';
                        const coTeachersHtml = roster.coTeachers.map(u => renderUser(u, 'coTeacher')).join('');
                        const studentsHtml = roster.students.map(u => renderUser(u, 'student')).join('');

                        return `
                            <div class="max-w-4xl mx-auto">
                                <h3 class="text-xl font-bold font-poppins text-gray-900 mb-4">Class Roster</h3>
                                <ul class="rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                                    ${ownerHtml}
                                    ${coTeachersHtml}
                                    ${studentsHtml}
                                </ul>
                            </div>
                        `;
                    },

                    // Class View - Schedule Tab (Teacher only)
                    scheduleView: (cls) => {
                        const { enableAt, disableAt } = cls.schedule || {};
                        const [enableH24, enableM] = enableAt ? enableAt.split(':').map(Number) : [null, null];
                        const [disableH24, disableM] = disableAt ? disableAt.split(':').map(Number) : [null, null];
                        
                        const format12Hour = (h24, m) => {
                            if (h24 === null) return { time: '', period: '' };
                            let h = h24 % 12;
                            const period = h24 >= 12 ? 'PM' : 'AM';
                            if (h === 0) h = 12;
                            return { time: `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`, period };
                        };

                        const enable12 = format12Hour(enableH24, enableM);
                        const disable12 = format12Hour(disableH24, disableM);

                        return `
                            <div class="max-w-4xl mx-auto">
                                <h3 class="text-xl font-bold font-poppins text-gray-900 mb-4">Hand Raising Schedule</h3>
                                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                                    <p class="text-sm text-gray-600 mb-4">Set a schedule for when students are allowed to raise their hands. Outside of this time, hand-raising will be paused. Teachers can override this setting manually.</p>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <label for="enable-time-input" class="block text-sm font-medium text-gray-700 mb-2">Enable Hand-Raising At:</label>
                                            <div class="schedule-time-input-container">
                                                <input id="enable-time-input" type="text" placeholder="HH:MM" maxlength="5" data-time-type="enable" data-time24hr="${enableAt || ''}" data-digits="${(enable12.time || '').replace(':', '')}" value="${enable12.time}" class="app-input schedule-time-input">
                                                <div class="period-selector">
                                                    <button data-value="AM" data-input="enable-time-input" class="period-btn ${enable12.period === 'AM' ? 'active' : ''}">AM</button>
                                                    <button data-value="PM" data-input="enable-time-input" class="period-btn ${enable12.period === 'PM' ? 'active' : ''}">PM</button>
                                                </div>
                                            </div>
                                        </div>

                                        <div>
                                            <label for="disable-time-input" class="block text-sm font-medium text-gray-700 mb-2">Disable Hand-Raising At:</label>
                                            <div class="schedule-time-input-container">
                                                <input id="disable-time-input" type="text" placeholder="HH:MM" maxlength="5" data-time-type="disable" data-time24hr="${disableAt || ''}" data-digits="${(disable12.time || '').replace(':', '')}" value="${disable12.time}" class="app-input schedule-time-input">
                                                <div class="period-selector">
                                                    <button data-value="AM" data-input="disable-time-input" class="period-btn ${disable12.period === 'AM' ? 'active' : ''}">AM</button>
                                                    <button data-value="PM" data-input="disable-time-input" class="period-btn ${disable12.period === 'PM' ? 'active' : ''}">PM</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mt-8 pt-4 border-t border-gray-200 flex justify-between items-center">
                                        <div>
                                            <button data-class-id="${cls.id}" id="delete-schedule-btn" class="px-4 py-2 text-red-600 bg-red-50 border border-red-300 rounded-lg hover:bg-red-100 transition-colors btn-bubbly text-sm">Delete Schedule</button>
                                        </div>
                                        <button data-class-id="${cls.id}" id="save-schedule-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors btn-bubbly">Save Schedule</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    },

                    // Class View - Teacher Settings Tab (Placeholder)
                    classSettingsView: (cls) => {
                        return `
                            <div class="max-w-4xl mx-auto">
                                <h3 class="text-xl font-bold font-poppins text-gray-900 mb-4">Teacher Class Settings</h3>
                                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                                    <p class="text-sm text-gray-500">This area contains class-wide settings. For time settings, please use the **Schedule** tab.</p>
                                    
                                    <div class="mt-4">
                                        <label for="class-name-input" class="block text-sm font-medium text-gray-700 mb-2">Class Name:</label>
                                        <div class="flex space-x-3">
                                            <input id="class-name-input" type="text" value="${escapeHtml(cls.name)}" class="app-input flex-1">
                                            <button data-class-id="${cls.id}" id="change-class-name-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors btn-bubbly">Save</button>
                                        </div>
                                        <p class="text-xs text-gray-400 mt-1">Can be changed 3 times per day.</p>
                                    </div>

                                    <div class="mt-8 pt-4 border-t border-red-200 flex justify-between items-center">
                                        <p class="text-sm font-medium text-red-600">Danger Zone</p>
                                        <button data-class-id="${cls.id}" id="delete-class-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors btn-bubbly">Delete Class</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    },
                    
                    // Class View - Student Settings Tab (Feature 1 & 2)
                    studentSettingsView: (cls, userData) => {
                        const studentNickname = cls.studentNicknames?.[userData.uid] || userData.username;

                        return `
                            <div class="max-w-4xl mx-auto">
                                <h3 class="text-xl font-bold font-poppins text-gray-900 mb-4">Personal Class Settings: ${escapeHtml(cls.name)}</h3>
                                <div class="space-y-6">
                                    <div class="p-6 border border-gray-200 rounded-xl shadow-md bg-white">
                                        <h4 class="font-semibold text-gray-800 mb-2">Personal Class Nickname</h4>
                                        <p class="text-sm text-gray-500 mb-3">Set a nickname that only teachers of this class can see. Your real name (${escapeHtml(userData.username)}) is still visible to all class staff.</p>
                                        <input id="student-nickname-input-view" type="text" value="${escapeHtml(studentNickname)}" placeholder="${escapeHtml(userData.username)}" class="app-input w-full">
                                        <div class="mt-4 flex justify-end">
                                            <button data-class-id="${cls.id}" id="save-nickname-btn-view" class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors btn-bubbly">Save Nickname</button>
                                        </div>
                                    </div>

                                    <div class="p-6 border border-red-300 rounded-xl shadow-md bg-red-50">
                                        <h4 class="font-semibold text-red-700 mb-2">Danger Zone</h4>
                                        <p class="text-sm text-red-500 mb-3">Leaving this class is permanent. You will need a new class code to rejoin.</p>
                                        <div class="flex justify-end">
                                            <button data-class-id="${cls.id}" id="leave-class-btn-view" class="px-4 py-2 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700 transition-colors btn-bubbly">Leave Class</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    },
                    
                    // Template for My Requests View (Feature 3)
                    myRequestsView: (classId, myRequests) => {
                        // Group requests by status
                        const groupedRequests = myRequests.reduce((acc, req) => {
                            acc[req.status] = acc[req.status] || [];
                            acc[req.status].push(req);
                            return acc;
                        }, {});
                        
                        const statusOrder = ['pending', 'accepted', 'denied'];
                        const statusLabels = {
                            pending: { label: 'Pending', icon: 'fa-solid fa-hourglass-half', color: 'text-yellow-600 border-yellow-300 bg-yellow-50' },
                            accepted: { label: 'Accepted', icon: 'fa-solid fa-circle-check', color: 'text-green-600 border-green-300 bg-green-50' },
                            denied: { label: 'Denied', icon: 'fa-solid fa-circle-xmark', color: 'text-red-600 border-red-300 bg-red-50' },
                        };

                        let content = '';

                        if (myRequests.length === 0) {
                            content = `<p class="text-center text-gray-500 mt-8">You have not sent any co-teacher requests yet for this class.</p>`;
                        } else {
                            content = statusOrder.map(status => {
                                const requests = groupedRequests[status] || [];
                                if (requests.length === 0) return '';
                                
                                const { label, icon, color } = statusLabels[status];

                                const requestList = requests.map(req => `
                                    <li class="p-4 border-b border-gray-100 last:border-b-0 flex justify-between items-center">
                                        <div>
                                            <p class="font-medium text-gray-900">Request to join ${escapeHtml(allLoadedClasses[classId]?.name || 'Unknown Class')}</p>
                                            <p class="text-sm text-gray-500 italic mt-1">
                                                "${escapeHtml(req.comment) || 'No comment provided.'}"
                                            </p>
                                            <p class="text-xs text-gray-400 mt-2">
                                                Requested: ${moment(req.requestedAt.toDate()).format('MMMM D, YYYY')}
                                            </p>
                                        </div>
                                        <span class="inline-flex items-center text-xs font-semibold px-3 py-1.5 rounded-full ${color}">
                                            <i class="${icon} mr-1"></i>
                                            ${label}
                                        </span>
                                    </li>
                                `).join('');

                                return `
                                    <div class="mb-8">
                                        <h4 class="text-lg font-bold font-poppins text-gray-800 mb-3 flex items-center">
                                            <i class="${icon} ${color} mr-2"></i> ${label} Requests (${requests.length})
                                        </h4>
                                        <ul class="bg-white rounded-lg shadow-md border border-gray-200 divide-y divide-gray-100">
                                            ${requestList}
                                        </ul>
                                    </div>
                                `;
                            }).join('');
                        }

                        return `
                            <div class="max-w-4xl mx-auto">
                                <h2 class="text-2xl font-bold font-poppins text-gray-900 mb-6">My Co-Teacher Requests</h2>
                                ${content}
                            </div>
                        `;
                    },
                };

                // --- EVENT LISTENERS AND DELEGATION ---

                document.addEventListener('click', async (e) => {
                    const id = e.target.closest('[data-class-id]')?.dataset.classId || currentClassId;
                    
                    if(e.target.closest('#logout-btn')) {
                        await auth.signOut();
                        return;
                    }
                    if(e.target.closest('#user-profile-btn')) {
                        document.getElementById('user-profile-menu').classList.toggle('hidden');
                        return;
                    }
                    if(e.target.closest('button[data-class-id]')) {
                        if(e.target.closest('button[data-class-id]').dataset.classId !== currentClassId){
                            await selectClass(e.target.closest('button[data-class-id]').dataset.classId);
                        }
                    }

                    // MODAL HANDLERS
                    if (e.target.closest('#new-class-btn')) { showModal(TPL.newClassModal()); return; }
                    if (e.target.closest('#join-class-btn-main')) { showModal(TPL.joinClassModal(userData.role === 'teacher')); return; }

                    if (e.target.id === 'create-class-submit') {
                        const name = document.getElementById('new-class-name').value.trim();
                        if(name){ await createNewClass(name); } else { showModal(TPL.messageModal('Error', 'Class name cannot be empty.','red')); }
                        return;
                    }

                    if (e.target.id === 'join-class-submit') {
                        const code = document.getElementById('join-class-code').value.trim().toUpperCase();
                        if(code){ await joinClass(code); } else { showModal(TPL.messageModal('Error', 'Class code cannot be empty.','red')); }
                        return;
                    }
                    
                    if (e.target.id === 'send-request-submit') {
                        const comment = document.getElementById('request-comment').value.trim();
                        await requestCoTeacher(e.target.dataset.classId, comment);
                        return;
                    }

                    if (e.target.id === 'raise-hand-submit') {
                        const question = document.getElementById('hand-question').value.trim();
                        await raiseHand(e.target.dataset.classId, question);
                        return;
                    }

                    // CLASS VIEW HANDLERS
                    if (e.target.id === 'raise-hand-student-btn') {
                        showModal(TPL.raiseHandModal(e.target.dataset.classId));
                        return;
                    }
                    if (e.target.id === 'lower-hand-student-btn') {
                        await lowerHand(e.target.dataset.classId);
                        return;
                    }
                    if (e.target.id === 'lower-hand-submit') { // Teacher modal lower hand
                        await lowerHand(e.target.dataset.classId, e.target.dataset.studentId);
                        return;
                    }
                    if (e.target.id === 'lower-all-hands-btn') {
                         if (confirm('Are you sure you want to lower ALL hands in this class?')) {
                             await lowerAllHands(e.target.dataset.classId);
                         }
                         return;
                    }
                    if (e.target.id === 'toggle-hand-raising-btn') {
                        const status = e.target.dataset.status === 'true';
                        await toggleHandRaising(e.target.dataset.classId, status, e.target);
                        return;
                    }

                    // ROSTER REMOVAL HANDLER
                    if (e.target.closest('[data-action="remove"]')) {
                        const removeBtn = e.target.closest('[data-action="remove"]');
                        if (confirm('Are you sure you want to remove this user from the class?')) {
                            await removeUserFromClass(id, removeBtn.dataset.userId);
                        }
                        return;
                    }

                    // TEACHER REQUEST HANDLER
                    if (e.target.closest('.request-action-group button')) {
                        const reqBtn = e.target.closest('.request-action-group button');
                        await handleCoTeacherRequest(id, reqBtn.dataset.requestId, reqBtn.dataset.action);
                        return;
                    }
                    
                    // TEACHER SETTINGS HANDLERS
                    if(e.target.id === 'change-class-name-btn'){
                        const name = document.getElementById('class-name-input').value.trim();
                        if(name) { await handleChangeClassName(id, name); } else { showModal(TPL.messageModal('Error', 'Class name cannot be empty.','red')); }
                        return;
                    }
                    if(e.target.id === 'delete-class-btn'){
                         if (confirm('WARNING: Are you absolutely sure you want to delete this class? This is permanent!')) {
                             await handleDeleteClass(id);
                         }
                         return;
                    }

                    // SCHEDULE HANDLERS
                    if (e.target.id === 'save-schedule-btn') {
                        const enableInput = document.getElementById('enable-time-input');
                        const disableInput = document.getElementById('disable-time-input');
                        const enableTime = enableInput?.dataset.time24hr || '';
                        const disableTime = disableInput?.dataset.time24hr || '';
                        
                        if (enableTime || disableTime) {
                           await handleSaveSchedule(id, enableTime, disableTime);
                        } else {
                           showModal(TPL.messageModal('Error', 'Please set both an enable and a disable time, or use the delete button to clear the schedule.','red'));
                        }
                        return;
                    }
                    if (e.target.id === 'delete-schedule-btn') {
                        await deleteSchedule(id);
                        return;
                    }
                    
                    // NEW: STUDENT SETTINGS HANDLERS (for sidebar/modal)
                    // 1. Sidebar Settings Button (for students)
                    const sidebarSettingsBtn = e.target.closest('[data-action="settings-menu"]');
                    if (sidebarSettingsBtn) {
                        const classId = sidebarSettingsBtn.dataset.classId;
                        const cls = allLoadedClasses[classId];
                        // Render the content directly in the main area (it's a view now, not a modal)
                        currentClassView = 'settings'; 
                        await selectClass(classId);
                        return;
                    }
                    
                    // 2. Save Nickname in Modal (If we were using a modal, we aren't using this block anymore)
                    // We'll use the view handlers for all settings changes
                    
                    // 3. Confirm Leave Class (for students)
                    if (e.target.id === 'confirm-leave-class-btn') {
                        const classId = e.target.dataset.classId;
                        await leaveClass(classId);
                        return;
                    }
                    
                    // HANDLERS FOR TEACHER VIEW ACTIONS (view hand modal)
                    if (e.target.closest('[data-action="view"]')) {
                        const handId = e.target.closest('[data-hand-id]').dataset.handId;
                        const classId = e.target.closest('[data-class-id]').dataset.classId;
                        const hand = classQueues[classId].find(h => h.id === handId);
                        if (hand) {
                            showModal(TPL.viewHandModal({ ...hand, classId }));
                        }
                        return;
                    }

                });
                
                // Hide user profile menu on outside click
                document.addEventListener('click', (e) => {
                    const profileMenu = document.getElementById('user-profile-menu');
                    const profileBtn = document.getElementById('user-profile-btn');
                    if (profileMenu && !profileMenu.contains(e.target) && !profileBtn.contains(e.target)) {
                        profileMenu.classList.add('hidden');
                    }
                });

                document.body.addEventListener('mainContentRendered', () => {
                    // Schedule time input logic (copied from original file)
                    const timeInputs = document.querySelectorAll('.schedule-time-input');
                    timeInputs.forEach(input => {
                        // Initialize period buttons
                        const initialTime24 = input.dataset.time24hr;
                        const periodBtns = input.closest('.schedule-time-input-container').querySelectorAll('.period-btn');
                        
                        if (initialTime24) {
                            const [h24] = initialTime24.split(':').map(Number);
                            const period = h24 >= 12 ? 'PM' : 'AM';
                            periodBtns.forEach(btn => {
                                btn.classList.toggle('active', btn.dataset.value === period);
                            });
                        }

                        periodBtns.forEach(btn => {
                            btn.onclick = (e) => {
                                e.preventDefault();
                                const targetInput = document.getElementById(e.target.dataset.input);
                                const period = e.target.dataset.value;
                                
                                periodBtns.forEach(b => b.classList.remove('active'));
                                e.target.classList.add('active');

                                let [h, m] = (targetInput.value || '12:00').split(':').map(Number);
                                if (isNaN(h)) h = 12;
                                if (isNaN(m)) m = 0;

                                let h24 = h;
                                if (period === 'PM' && h !== 12) h24 += 12;
                                if (period === 'AM' && h === 12) h24 = 0;
                                
                                targetInput.dataset.time24hr = `${String(h24).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
                            };
                        });
                        
                        input.addEventListener('input', (e) => {
                            // Only allow digits and colon
                            e.target.value = e.target.value.replace(/[^0-9:]/g, '');
                            
                            // Prevent sequential colons
                            if (e.target.value.includes('::')) {
                                e.target.value = e.target.value.replace('::', ':');
                            }
                            
                            // Auto-insert colon
                            let value = e.target.value;
                            if (value.length === 2 && !value.includes(':') && input.dataset.digits.length < 2) {
                                e.target.value = value + ':';
                            }
                            
                            input.dataset.digits = e.target.value.replace(':', '');
                        });

                        input.addEventListener('blur', (e) => {
                            if (!e.target.value) {
                                e.target.dataset.time24hr = '';
                                e.target.dataset.digits = '';
                                periodBtns.forEach(btn => btn.classList.remove('active'));
                                return;
                            }
                            
                            let [h, m] = e.target.value.split(':').map(Number);
                            
                            // Clean up based on 12-hour display logic
                            if (isNaN(h) || h < 1 || h > 12) h = 12;
                            if (isNaN(m) || m < 0 || m > 59) m = 0;
                            const finalValue = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                            e.target.value = finalValue;
                            input.dataset.digits = finalValue.replace(':', '');
                            
                            // Crucial: Update the 24hr time on blur
                            const periodEl = e.target.closest('.schedule-time-input-container').querySelector('.period-btn.active');
                            const period = periodEl ? periodEl.dataset.value : 'AM'; // Default to AM if none active
                            let h24 = h;
                            if (period === 'PM' && h !== 12) h24 += 12;
                            if (period === 'AM' && h === 12) h24 = 0;
                            input.dataset.time24hr = `${String(h24).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
                        });
                    });
                    
                    // NEW: Handlers for Student Settings View buttons (Feature 1 & 2)
                    const saveNicknameViewBtn = document.getElementById('save-nickname-btn-view');
                    if (saveNicknameViewBtn) {
                        saveNicknameViewBtn.onclick = async () => {
                            const classId = saveNicknameViewBtn.dataset.classId;
                            const nickname = document.getElementById('student-nickname-input-view').value;
                            await saveStudentNickname(classId, nickname);
                        };
                    }

                    const leaveClassViewBtn = document.getElementById('leave-class-btn-view');
                    if (leaveClassViewBtn) {
                        leaveClassViewBtn.onclick = () => {
                            const classId = leaveClassViewBtn.dataset.classId;
                            const className = allLoadedClasses[classId]?.name || 'this class';
                            showModal(TPL.confirmLeaveClassModal(classId, className));
                        };
                    }
                });
            });
        });
    </script>
</body>
</html>
