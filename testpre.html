<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Setup Template</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script href="../firebase-config.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-8">

    <div id="app" class="max-w-xl mx-auto bg-white p-6 rounded-xl shadow-lg">
        <h1 class="text-2xl font-bold text-gray-800 mb-4">Firebase Initialization Status</h1>
        <div id="status-message" class="text-sm p-4 rounded-lg bg-indigo-50 text-indigo-700">Initializing Firebase...</div>
        <div class="mt-4 p-4 border border-gray-200 rounded-lg space-y-2 text-sm text-gray-700">
            <p><strong>App ID (Used in Firestore paths):</strong> <code id="display-app-id" class="font-mono bg-gray-100 p-1 rounded">Loading...</code></p>
            <p><strong>User ID (Authenticated User):</strong> <code id="display-user-id" class="font-mono bg-gray-100 p-1 rounded">Loading...</code></p>
        </div>
        <button id="test-button" class="mt-6 w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150" disabled>
            (Wait for Auth)
        </button>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set log level to Debug for visibility in the console (optional but helpful)
        setLogLevel('Debug');

        // --- MANDATORY Firebase Configuration Retrieval ---
        // We MUST use the global variables provided by the environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        let firebaseConfig = {};
        try {
            // The configuration is passed as a JSON string in the global variable.
            firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        } catch (e) {
            console.error("Error parsing __firebase_config:", e);
        }

        // Check if config is available
        if (Object.keys(firebaseConfig).length === 0) {
            console.error("Firebase configuration is missing or invalid. Check the environment variables.");
            document.getElementById('status-message').textContent = "ERROR: Firebase config missing.";
        }
        // ----------------------------------------------------


        // 1. Initialize Firebase App
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // References to DOM elements
        const statusMessage = document.getElementById('status-message');
        const displayAppId = document.getElementById('display-app-id');
        const displayUserId = document.getElementById('display-user-id');
        const testButton = document.getElementById('test-button');

        let isAuthReady = false;

        // 2. Handle Authentication
        async function handleAuth() {
            try {
                // We MUST use the __initial_auth_token if it exists.
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    // Fallback to anonymous sign-in if the custom token is not available
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth error:", error);
                statusMessage.textContent = `Authentication failed: ${error.message}`;
                statusMessage.classList.replace('bg-indigo-50', 'bg-red-100');
                statusMessage.classList.replace('text-indigo-700', 'text-red-700');
            }
        }

        // 3. Set up Auth State Listener
        onAuthStateChanged(auth, (user) => {
            isAuthReady = true;
            displayAppId.textContent = appId;
            
            if (user) {
                const userId = user.uid;
                statusMessage.textContent = `SUCCESS! Firebase and Auth initialized. You are signed in.`;
                statusMessage.classList.replace('bg-indigo-50', 'bg-green-100');
                statusMessage.classList.replace('text-indigo-700', 'text-green-700');
                displayUserId.textContent = userId;
                testButton.textContent = 'Auth Ready!';
                testButton.disabled = false;
                
                // Now you can use 'db' and 'userId' to perform Firestore operations
                console.log(`Current User ID: ${userId}`);
                console.log(`Database instance ready:`, db);

            } else {
                // User is signed out (this should ideally not happen if signInWithCustomToken succeeds)
                displayUserId.textContent = 'Not Signed In';
                statusMessage.textContent = 'Auth state changed: User is signed out.';
                statusMessage.classList.replace('bg-indigo-50', 'bg-yellow-100');
                statusMessage.classList.replace('text-indigo-700', 'text-yellow-700');
                
                // If signed out, try to sign in again immediately
                handleAuth();
            }
        });

        // Initial sign-in attempt
        handleAuth();
    </script>
</body>
</html>
