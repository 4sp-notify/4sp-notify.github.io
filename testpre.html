<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notify | Dashboard</title>
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' https://cdn.tailwindcss.com https://www.gstatic.com https://apis.google.com https://accounts.google.com 'unsafe-inline' 'unsafe-eval';
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net;
        font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net;
        img-src 'self' data: https://www.gstatic.com https://lh3.googleusercontent.com;
        connect-src 'self' https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://www.googleapis.com https://content.googleapis.com https://classroom.googleapis.com;
        frame-src 'self' https://accounts.google.com https://content.googleapis.com https://content-classroom.googleapis.com;
    ">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css">

    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        /* Base styling using Inter and Poppins fonts */
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        .font-poppins { font-family: 'Poppins', sans-serif; }
        
        /* Custom input style */
        .app-input {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb; /* gray-50 */
        }
        .app-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 1px #3b82f6;
            outline: none;
            background-color: white;
        }

        button, a.btn-bubbly, input, select, textarea { font-family: 'Inter', sans-serif; }
        h1, h2, h3, h4, .font-poppins { font-family: 'Poppins', sans-serif; }

        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px;}
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .main-layout { height: calc(100vh - 4rem); }

        /* Animations */
        .fade-enter-from, .fade-leave-to { opacity: 0; transform: scale(0.95); }
        .fade-enter-active, .fade-leave-active { transition: opacity 200ms ease-out, transform 200ms ease-out; }
        .fade-enter-to, .fade-leave-from { opacity: 1; transform: scale(1); }
        
        .btn-bubbly { transition: transform 0.1s ease-out; }
        .btn-bubbly:active { transform: scale(0.95); }

        .user-profile-menu-container { transition: transform 0.2s ease-out, opacity 0.2s ease-out; transform-origin: top right; }
        .menu-item-icon { display: inline-flex; width: 1.25rem; height: 1.25rem; margin-right: 0.75rem; align-items: center; justify-content: center; }
        
        .hand-status-card { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        .raise-hand-btn { box-shadow: 0 4px 15px 0 rgba(59, 130, 246, 0.4); transition: all 0.3s ease; }
        .raise-hand-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px 0 rgba(59, 130, 246, 0.5); }
        
        /* Combined notification badge */
        .class-notification-badge {
            position: absolute; top: 4px; right: 8px; min-width: 1.5rem; height: 1.5rem; border-radius: 9999px;
            color: white; font-size: 0.75rem; font-weight: bold; display: inline-flex; align-items: center;
            justify-content: center; padding: 0 0.375rem;
        }
        .badge-hands { background-color: #ef4444; /* red-500 */ }
        .badge-requests { background-color: #8b5cf6; /* violet-500 */ }
        .badge-multiple { background: linear-gradient(45deg, #ef4444, #8b5cf6); }

        /* Icon button with tooltip styles */
        .tooltip-container { position: relative; display: flex; flex-direction: column; align-items: center; }
        .tooltip-button { width: 3rem; height: 3rem; border-radius: 0.75rem; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; transition: background-color 0.2s, color 0.2s; }
        .tooltip-text {
            visibility: hidden; opacity: 0; width: max-content; background-color: #1f2937; color: #fff; text-align: center;
            border-radius: 0.375rem; padding: 4px 8px; position: absolute; z-index: 10; bottom: -28px; font-size: 0.75rem;
            font-weight: 500; transition: opacity 0.2s ease-out; pointer-events: none;
        }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
        
        /* Redesigned Schedule Picker */
        .schedule-time-input-container { display: flex; align-items: center; }
        .schedule-time-input { width: 100px; text-align: center; font-family: 'Poppins', sans-serif; font-weight: 500; }
        .period-selector { display: flex; margin-left: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.5rem; overflow: hidden; }
        .period-btn { padding: 0.75rem 1rem; border: none; background-color: #f9fafb; color: #6b7280; cursor: pointer; transition: background-color 0.2s, color 0.2s; font-family: 'Inter', sans-serif;}
        .period-btn.active { background-color: #3b82f6; color: white; }

        /* NEW: Dynamic Button Styles for Teacher Actions */
        .action-btn {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .action-btn.accept { background-color: #10b981; color: white; } /* Green */
        .action-btn.accept:hover { background-color: #059669; }
        .action-btn.deny { background-color: #ef4444; color: white; } /* Red */
        .action-btn.deny:hover { background-color: #dc2626; }
        .action-btn.comment { background-color: white; color: #1f2937; border: 1px solid #d1d5db; } /* White/Grey */
        .action-btn.comment:hover { background-color: #f3f4f6; }
        .action-btn.comment .icon-color { color: #9ca3af; } /* Light grey icon */

        /* NEW: Comment Button Split State */
        .comment-split-btn {
            position: relative;
            width: 100%;
            border-radius: 0.5rem;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .comment-split-btn > div {
            width: 100%;
            height: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .comment-split-btn .edit-half { top: 0; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .comment-split-btn .delete-half { bottom: 0; }
        
    </style>
</head>
<body class="bg-slate-100 h-screen overflow-hidden">

    <div class="flex flex-col h-full">
        <header class="bg-white border-b border-gray-200 shadow-sm sticky top-0 z-30 h-16 flex-shrink-0">
            <div class="max-w-full mx-auto px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <a href="index.html" class="flex items-center space-x-3">
                        <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                        <h1 class="text-xl font-bold text-gray-800">Notify</h1>
                    </a>
                    <div class="relative">
                        <button id="user-profile-btn" type="button" class="btn-bubbly flex items-center justify-center w-10 h-10 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform duration-150 hover:scale-105">
                             <img id="user-profile-pic" class="w-full h-full rounded-lg object-cover hidden" src="" alt="User profile picture">
                             <div id="user-profile-initial" class="w-full h-full rounded-lg flex items-center justify-center bg-gradient-to-br from-blue-600 to-indigo-700 text-white font-bold text-lg hidden"></div>
                        </button>
                        <div id="user-profile-menu" class="user-profile-menu-container absolute right-0 mt-2 w-72 rounded-xl shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden" role="menu">
                            <div class="p-4 bg-gray-50 border-b border-gray-100 rounded-t-xl">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <img id="user-profile-pic-menu" class="h-12 w-12 rounded-full object-cover hidden" src="" alt="">
                                        <div id="user-profile-initial-menu" class="h-12 w-12 rounded-full flex items-center justify-center bg-gradient-to-br from-blue-600 to-indigo-700 text-white font-bold text-xl hidden"></div>
                                    </div>
                                    <div class="ml-3 min-w-0">
                                        <div id="user-display-name-container" class="marquee-container"><p id="user-display-name-menu" class="text-lg font-bold font-poppins text-gray-800 truncate">Loading...</p></div>
                                        <div id="user-email-container" class="marquee-container"><p id="user-email-menu" class="text-sm text-gray-500 truncate">Loading...</p></div>
                                    </div>
                                </div>
                            </div>
                            <div class="py-1" role="none">
                                <a href="settings.html" class="font-medium text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100 flex items-center" role="menuitem" tabindex="-1">
                                    <span class="menu-item-icon"><i class="fa-solid fa-sliders text-gray-400"></i></span>
                                    <span>Settings</span>
                                </a>
                                <a href="#" id="logout-btn" class="font-medium text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100 flex items-center" role="menuitem" tabindex="-1">
                                    <span class="menu-item-icon"><i class="fa-solid fa-right-from-bracket text-gray-400"></i></span>
                                    <span>Logout</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="flex flex-1 main-layout overflow-hidden">
            <aside class="w-72 bg-white border-r border-gray-200 flex flex-col flex-shrink-0">
                <div id="class-list-container" class="flex-grow p-4 overflow-y-auto custom-scrollbar">
                    <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3 px-2">My Classes</h2>
                    <ul id="class-list" class="space-y-1"></ul>
                    <div id="no-classes-sidebar" class="text-center text-sm text-gray-500 mt-4 hidden"><p>No classes yet.</p></div>
                </div>
                <div id="teacher-sidebar-actions" class="p-4 border-t border-gray-200 hidden">
                    <button id="new-class-btn" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-150 flex items-center justify-center space-x-2 btn-bubbly"><i class="fa-solid fa-plus w-5 h-5"></i><span>New Class</span></button>
                    <button id="join-class-btn-main" class="mt-2 w-full bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors duration-150 flex items-center justify-center space-x-2 btn-bubbly text-sm"><i class="fa-solid fa-user-plus w-5 h-5"></i><span>Join Class</span></button>
                </div>
            </aside>
            <main class="flex-1 flex flex-col overflow-hidden">
                <div id="main-content-area" class="flex-1 overflow-y-auto bg-slate-100 p-6 sm:p-8 custom-scrollbar"></div>
            </main>
        </div>
    </div>
    
    <div id="modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-60 z-40 hidden"></div>
    <div id="modal-container" class="fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none"></div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>

    <script>
        // FIX 1: TPL Definition - Replaced the missing external file with an inline object 
        // containing placeholder functions. You must replace the 'return' strings with your actual HTML templates.
        const TPL = {
            classView: (data, userData, isOwner, isCoTeacher, isStudent, queue, requests, currentClassView, currentRoster) => {
                return `<div class="p-8 bg-white rounded-lg shadow-xl"><h2 class="text-2xl font-bold">Class View: ${data.name}</h2><p>View: ${currentClassView}. REPLACE THIS WITH REAL TEMPLATE.</p></div>`;
            },
            emptyState: (userData) => {
                return `<div class="p-12 bg-white rounded-lg shadow-xl text-center"><h2 class="text-3xl font-bold text-gray-800">Welcome, ${userData.username}</h2><p class="mt-4 text-gray-600">You don't have a class selected or are not in any classes. Select one from the sidebar or create/join a new one.</p></div>`;
            },
            messageModal: (title, message, color) => {
                return `<div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full pointer-events-auto transition-all"><h3 class="text-xl font-bold text-${color}-600">${title}</h3><p class="mt-2 text-gray-700">${message}</p><button onclick="hideModal()" class="mt-4 w-full bg-${color}-600 text-white py-2 rounded-lg">Close</button></div>`;
            },
            newClassModal: () => {
                return `<div class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full pointer-events-auto transition-all"><h3 class="text-2xl font-bold text-gray-800">Create New Class</h3><input id="new-class-name" class="app-input mt-4 w-full" placeholder="Class Name"><button id="create-new-class-btn" class="mt-4 w-full bg-blue-600 text-white py-2 rounded-lg">Create Class</button></div>`;
            },
            joinClassModal: () => {
                return `<div class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full pointer-events-auto transition-all"><h3 class="text-2xl font-bold text-gray-800">Join Class</h3><input id="join-class-code" class="app-input mt-4 w-full" placeholder="Class Code"><button id="submit-join-class-btn" class="mt-4 w-full bg-green-600 text-white py-2 rounded-lg">Join</button></div>`;
            },
            requestCoTeacherModal: (classId, className) => {
                return `<div class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full pointer-events-auto transition-all"><h3 class="text-2xl font-bold text-gray-800">Request Co-Teacher Access</h3><p class="mt-2 text-gray-600">Class: ${className}</p><textarea id="co-teacher-comment" class="app-input mt-4 w-full" placeholder="Optional Comment"></textarea><button data-class-id="${classId}" id="submit-co-teacher-request" class="mt-4 w-full bg-blue-600 text-white py-2 rounded-lg">Send Request</button></div>`;
            },
            raiseHandModal: (classId) => {
                return `<div class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full pointer-events-auto transition-all"><h3 class="text-2xl font-bold text-gray-800">Raise Hand</h3><textarea id="raise-hand-question" class="app-input mt-4 w-full" placeholder="Your question (optional)"></textarea><button id="submit-raise-hand-btn" class="mt-4 w-full bg-blue-600 text-white py-2 rounded-lg">Raise Hand</button></div>`;
            },
            ownerSettingsModal: (cls) => {
                 return `<div class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full pointer-events-auto transition-all"><h3 class="text-2xl font-bold text-gray-800">Owner Settings: ${cls.name}</h3><button id="edit-class-name-btn" class="mt-4 w-full bg-gray-200 py-2 rounded-lg">Edit Name</button><button id="schedule-class-btn" class="mt-2 w-full bg-gray-200 py-2 rounded-lg">Schedule Hand Raising</button><button id="gclassroom-import-btn" class="mt-2 w-full bg-gray-200 py-2 rounded-lg">Google Classroom Import</button><button id="confirm-delete-class-btn" class="mt-4 w-full bg-red-600 text-white py-2 rounded-lg">Delete Class</button></div>`;
            },
            coTeacherSettingsModal: (cls) => {
                return `<div class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full pointer-events-auto transition-all"><h3 class="text-2xl font-bold text-gray-800">Co-Teacher Settings: ${cls.name}</h3><button id="set-local-class-name-btn" class="mt-4 w-full bg-gray-200 py-2 rounded-lg">Set Local Nickname</button><button id="leave-class-btn" class="mt-2 w-full bg-red-600 text-white py-2 rounded-lg">Leave Class</button></div>`;
            },
            editClassNameModal: (classId, currentName) => {
                return `<div class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full pointer-events-auto transition-all"><h3 class="text-2xl font-bold text-gray-800">Edit Class Name</h3><input id="edit-class-name-input" class="app-input mt-4 w-full" value="${currentName}" placeholder="New Class Name"><button id="confirm-change-class-name-btn" class="mt-4 w-full bg-blue-600 text-white py-2 rounded-lg">Save</button></div>`;
            },
            setLocalClassNameModal: (classId, currentLocalName) => {
                 return `<div class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full pointer-events-auto transition-all"><h3 class="text-2xl font-bold text-gray-800">Set Local Nickname</h3><input id="set-local-class-name-input" class="app-input mt-4 w-full" value="${currentLocalName}" placeholder="Your private nickname for this class"><button id="save-local-class-name-btn" class="mt-4 w-full bg-blue-600 text-white py-2 rounded-lg">Save</button></div>`;
            },
            scheduleHandRaisingModal: (classId, schedule) => {
                const enable = schedule.enableAt || ''; const disable = schedule.disableAt || '';
                return `<div class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full pointer-events-auto transition-all"><h3 class="text-2xl font-bold text-gray-800">Schedule Hand Raising</h3><p class="mt-2">Enable At: <input type="time" id="schedule-enable-time" value="${enable}" class="app-input"></p><p class="mt-2">Disable At: <input type="time" id="schedule-disable-time" value="${disable}" class="app-input"></p><button id="save-schedule-btn" class="mt-4 w-full bg-blue-600 text-white py-2 rounded-lg">Save Schedule</button><button id="delete-schedule-btn" class="mt-2 w-full bg-gray-300 py-2 rounded-lg">Clear Schedule</button></div>`;
            },
            gClassroomImportModal: () => {
                return `<div class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full pointer-events-auto transition-all"><h3 class="text-2xl font-bold text-gray-800">Google Classroom Import</h3><p>Google Classroom integration UI goes here. REPLACE THIS TEMPLATE.</p></div>`;
            },
            confirmLeaveClassModal: (classId, className) => {
                return `<div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full pointer-events-auto transition-all"><h3 class="text-xl font-bold text-red-600">Confirm Leave</h3><p class="mt-2 text-gray-700">Are you sure you want to leave ${className}?</p><button data-class-id="${classId}" id="confirm-leave-class-btn" class="mt-4 w-full bg-red-600 text-white py-2 rounded-lg">Yes, Leave Class</button></div>`;
            },
            confirmRemoveUserModal: (classId, userId, username) => {
                return `<div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full pointer-events-auto transition-all"><h3 class="text-xl font-bold text-red-600">Confirm Removal</h3><p class="mt-2 text-gray-700">Are you sure you want to remove ${username} from the class?</p><button data-user-id="${userId}" id="confirm-remove-user-btn" class="mt-4 w-full bg-red-600 text-white py-2 rounded-lg">Yes, Remove User</button></div>`;
            },
            confirmDeleteClassModal: (classId, className) => {
                return `<div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full pointer-events-auto transition-all"><h3 class="text-xl font-bold text-red-600">Confirm Deletion</h3><p class="mt-2 text-gray-700">Are you absolutely sure you want to delete ${className} and all its data? This cannot be undone.</p><button data-class-id="${classId}" id="confirm-delete-class-btn" class="mt-4 w-full bg-red-600 text-white py-2 rounded-lg">Yes, Delete Class</button></div>`;
            },
            commentHandModal: (classId, studentId, currentComment) => {
                return `<div class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full pointer-events-auto transition-all"><h3 class="text-2xl font-bold text-gray-800">Add Comment</h3><textarea id="hand-comment-input" class="app-input mt-4 w-full" placeholder="Private comment for the student">${currentComment || ''}</textarea><button data-class-id="${classId}" data-student-id="${studentId}" id="submit-hand-comment-btn" class="mt-4 w-full bg-blue-600 text-white py-2 rounded-lg">Save Comment</button></div>`;
            }
        };


        document.addEventListener('DOMContentLoaded', () => {
            let currentUser = null, userData = null, currentClassId = null, currentRoster = null;
            let allLoadedClasses = {}, classQueues = {}, classRequests = {}, unsubscribes = [], queueUnsubscribers = {};
            let currentClassView = 'overview';

            const mainContentArea = document.getElementById('main-content-area');
            const classListEl = document.getElementById('class-list');
            const modalContainer = document.getElementById('modal-container');
            const modalBackdrop = document.getElementById('modal-backdrop');

            function onFirebaseReady(callback) { 
                const i = setInterval(() => { 
                    if (typeof firebase !== 'undefined') { 
                        clearInterval(i); 
                        callback(); 
                    } 
                }, 50); 
            }

            onFirebaseReady(() => {
                const app = firebase.initializeApp(firebaseConfig);
                const auth = firebase.auth();
                const db = firebase.firestore();

                auth.onAuthStateChanged(user => {
                    if (user) { currentUser = user; fetchUserData(user.uid); } 
                    else { window.location.href = 'login.html'; }
                });

                async function fetchUserData(uid) {
                    const doc = await db.collection('users').doc(uid).get();
                    if (doc.exists) {
                        userData = { uid, ...doc.data() };
                        updateProfileUI(currentUser, userData);
                        listenForClasses(uid);
                        renderMainContent();
                        initializeScheduleChecker();
                    } else { auth.signOut(); }
                }
                
                function updateProfileUI(user, data) {
                    document.getElementById('user-display-name-menu').textContent = data.username;
                    document.getElementById('user-email-menu').textContent = user.email;
                    const pics = [document.getElementById('user-profile-pic'), document.getElementById('user-profile-pic-menu')];
                    const initials = [document.getElementById('user-profile-initial'), document.getElementById('user-profile-initial-menu')];
                    if (user.photoURL) {
                        pics.forEach(el => { el.src = user.photoURL; el.classList.remove('hidden'); });
                        initials.forEach(el => el.classList.add('hidden'));
                    } else {
                        const i = data.username.charAt(0).toUpperCase();
                        initials.forEach(el => { el.textContent = i; el.classList.remove('hidden'); });
                        pics.forEach(el => el.classList.add('hidden'));
                    }
                    document.getElementById('teacher-sidebar-actions').classList.toggle('hidden', data.role !== 'teacher');
                }

                function updateGlobalUI() {
                    updateDocumentTitle();
                    renderClassList(Object.values(allLoadedClasses));
                }
                
                function updateDocumentTitle() {
                    let handsCount = 0, requestsCount = 0;
                    if (userData && allLoadedClasses && classQueues && classRequests) {
                        for (const id in allLoadedClasses) {
                            const cls = allLoadedClasses[id];
                            if (cls) {
                                const isOwner = cls.teacherId === userData.uid;
                                const isCoTeacher = (cls.teacherIds || []).includes(userData.uid);
                                if(isOwner || isCoTeacher) handsCount += (classQueues[id] || []).filter(h => !h.status || h.status === 'pending').length;
                                if(isOwner) requestsCount += (classRequests[id] || []).length;
                            }
                        }
                    }
                    const totalCount = handsCount + requestsCount;
                    document.title = totalCount > 0 ? `(${totalCount}) Notify | Dashboard` : 'Notify | Dashboard';
                }

                function listenForClasses(uid) {
                    unsubscribes.forEach(unsub => unsub()); unsubscribes = [];
                    Object.values(queueUnsubscribers).forEach(unsub => unsub()); queueUnsubscribers = {};
                    allLoadedClasses = {};

                    const process = (snapshot) => {
                        snapshot.docChanges().forEach(change => {
                            const id = change.doc.id, data = { id, ...change.doc.data() };
                            if (change.type === 'removed') {
                                delete allLoadedClasses[id]; delete classQueues[id]; delete classRequests[id];
                                if (queueUnsubscribers[id]) { queueUnsubscribers[id](); delete queueUnsubscribers[id]; }
                                if (queueUnsubscribers[`${id}_student_listen`]) { queueUnsubscribers[`${id}_student_listen`](); delete queueUnsubscribers[`${id}_student_listen`]; }
                            } else {
                                allLoadedClasses[id] = data;
                                const isOwner = data.teacherId === uid;
                                const isCoTeacher = (data.teacherIds || []).includes(uid);
                                
                                if ((isOwner || isCoTeacher) && !queueUnsubscribers[`hands_${id}`]) {
                                    queueUnsubscribers[`hands_${id}`] = db.collection('classes').doc(id).collection('raisedHands')
                                        .orderBy('raisedAt', 'asc')
                                        .onSnapshot(qSnap => {
                                            classQueues[id] = qSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                                            updateGlobalUI();
                                            if(currentClassId === id) renderMainContent();
                                        });
                                }
                                if(isOwner && !queueUnsubscribers[`requests_${id}`]){
                                    queueUnsubscribers[`requests_${id}`] = db.collection('classes').doc(id).collection('coTeacherRequests')
                                        .where('status','==','pending')
                                        .onSnapshot(rSnap => {
                                            classRequests[id] = rSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                                            updateGlobalUI();
                                            if(currentClassId === id) renderMainContent();
                                        });
                                }
                                if((!isOwner && !isCoTeacher) && !queueUnsubscribers[`${id}_student_listen`]){
                                     queueUnsubscribers[`${id}_student_listen`] = db.collection('classes').doc(id).collection('raisedHands').doc(uid)
                                        .onSnapshot(dSnap => {
                                            if(currentClassId === id) renderMainContent();
                                        });
                                }
                            }
                        });
                        updateGlobalUI();
                    };
                    unsubscribes.push(db.collection('classes').where('teacherId', '==', uid).onSnapshot(process));
                    unsubscribes.push(db.collection('classes').where('studentIds', 'array-contains', uid).onSnapshot(process));
                    unsubscribes.push(db.collection('classes').where('teacherIds', 'array-contains', uid).onSnapshot(process));
                }
                
                function renderClassList(classes) {
                    document.getElementById('no-classes-sidebar').classList.toggle('hidden', classes.length > 0);
                    classListEl.innerHTML = '';
                    classes.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0)).forEach(cls => {
                        const li = document.createElement('li');
                        const isActive = currentClassId === cls.id;
                        const activeClasses = isActive ? 'bg-blue-100 text-blue-800 font-semibold' : 'text-gray-700 hover:bg-slate-100 hover:text-gray-900';
                        
                        const handsCount = (classQueues[cls.id] || []).filter(h => !h.status || h.status === 'pending').length;
                        const reqCount = classRequests[cls.id]?.length || 0;
                        let badge = '';
                        if(handsCount > 0 && reqCount > 0) badge = `<span class="class-notification-badge badge-multiple">${handsCount + reqCount}</span>`;
                        else if(handsCount > 0) badge = `<span class="class-notification-badge badge-hands">${handsCount}</span>`;
                        else if(reqCount > 0) badge = `<span class="class-notification-badge badge-requests">${reqCount}</span>`;

                        li.innerHTML = `<button data-class-id="${cls.id}" class="w-full text-left px-3 py-2.5 rounded-md font-medium text-sm transition-colors btn-bubbly relative flex justify-between items-center ${activeClasses}"><span>${escapeHtml(cls.name)}</span>${badge}</button>`;
                        classListEl.appendChild(li);
                    });
                }
                
                async function selectClass(id) {
                    currentClassView = 'overview'; currentRoster = null;
                    if (id) {
                        currentClassId = id;
                        await fetchRosterData(allLoadedClasses[id]);
                    } else {
                        currentClassId = null;
                    }
                    renderMainContent();
                }

                async function fetchRosterData(data) {
                    if (!data) return;
                    const ids = [data.teacherId, ...(data.teacherIds || []), ...(data.studentIds || [])].filter(id => id);
                    if (ids.length === 0) { currentRoster = { owner: {}, coTeachers: [], students: [] }; return; }
                    
                    const userBatches = [];
                    for (let i = 0; i < ids.length; i += 10) {
                        userBatches.push(ids.slice(i, i + 10));
                    }

                    const users = {};
                    for(const batch of userBatches){
                        const docs = await db.collection('users').where(firebase.firestore.FieldPath.documentId(), 'in', batch).get();
                        docs.forEach(doc => { users[doc.id] = doc.data(); });
                    }

                    currentRoster = {
                        owner: { id: data.teacherId, ...users[data.teacherId] },
                        coTeachers: (data.teacherIds || []).map(id => ({ id, ...users[id] })),
                        students: (data.studentIds || []).map(id => ({ id, ...users[id] }))
                    };
                }

                function renderMainContent() {
                    if (currentClassId && allLoadedClasses[currentClassId]) {
                        const data = allLoadedClasses[currentClassId];
                        const queue = classQueues[data.id] || [];
                        const requests = classRequests[data.id] || [];
                        const isOwner = data.teacherId === userData.uid;
                        const isCoTeacher = (data.teacherIds || []).includes(userData.uid);
                        const isStudent = !isOwner && !isCoTeacher && (data.studentIds || []).includes(userData.uid);
                        mainContentArea.innerHTML = TPL.classView(data, userData, isOwner, isCoTeacher, isStudent, queue, requests, currentClassView, currentRoster);
                        document.body.dispatchEvent(new CustomEvent('mainContentRendered'));
                    } else { mainContentArea.innerHTML = TPL.emptyState(userData); }
                }

                function showModal(html) { modalContainer.innerHTML = html; modalBackdrop.classList.remove('hidden'); const d = modalContainer.firstElementChild; d.classList.add('fade-enter-from'); setTimeout(() => d.classList.remove('fade-enter-from'), 10); }
                function hideModal() { const d=modalContainer.firstElementChild; if(d){d.classList.add('fade-leave-to');modalBackdrop.classList.add('fade-leave-to');setTimeout(() => {modalContainer.innerHTML='';modalBackdrop.classList.add('hidden');modalBackdrop.classList.remove('fade-leave-to');}, 200);}}
                function escapeHtml(text) { if(typeof text!=='string')return'';const d=document.createElement('div');d.textContent=text;return d.innerHTML; }
                
                async function createNewClass(name) { const code=Math.random().toString(36).substring(2,10).toUpperCase(); const coTeacherCode = 'T' + Math.random().toString(36).substring(2,9).toUpperCase(); await db.collection('classes').add({name,teacherId:currentUser.uid,teacherIds:[],studentIds:[],code,coTeacherCode,pendingStudentEmails:[],handRaisingEnabled:true,schedule:{enableAt:'',disableAt:''},scheduleLastActionDate:'',createdAt:firebase.firestore.FieldValue.serverTimestamp()});hideModal();}
                async function joinClass(code) {
                    const studentQuery = db.collection('classes').where('code', '==', code).limit(1).get();
                    const teacherQuery = db.collection('classes').where('coTeacherCode', '==', code).limit(1).get();
                    const [studentSnap, teacherSnap] = await Promise.all([studentQuery, teacherQuery]);
                    
                    if (teacherSnap.empty && studentSnap.empty) { showModal(TPL.messageModal('Error','Invalid class code.','red')); return; }
                    
                    if (!teacherSnap.empty) { // Co-teacher join
                        const classDoc = teacherSnap.docs[0];
                        const classData = classDoc.data();
                        if (userData.role !== 'teacher') { showModal(TPL.messageModal('Access Denied', 'Only users with a teacher account can join with this code.', 'red')); return; }
                        const isMember = classData.teacherId === currentUser.uid || (classData.teacherIds || []).includes(currentUser.uid);
                        if (isMember) { showModal(TPL.messageModal('Already Enrolled', `You are already a teacher in ${classData.name}.`, 'yellow')); return; }
                        hideModal();
                        showModal(TPL.requestCoTeacherModal(classDoc.id, classData.name));
                    } else { // Student join
                        const classDoc = studentSnap.docs[0];
                        const classData = classDoc.data();
                        const isMember = classData.teacherId === currentUser.uid || (classData.teacherIds || []).includes(currentUser.uid) || (classData.studentIds || []).includes(currentUser.uid);
                        if(isMember){ showModal(TPL.messageModal('Already Enrolled',`You are already a member of ${classData.name}.`,'yellow')); return; }
                        
                        await db.collection('classes').doc(classDoc.id).update({studentIds:firebase.firestore.FieldValue.arrayUnion(currentUser.uid)});
                        hideModal();
                        showModal(TPL.messageModal('Success',`Successfully joined class: ${classData.name} as a student!`,'green'));
                    }
                }

                async function requestCoTeacher(classId, comment) {
                    await db.collection('classes').doc(classId).collection('coTeacherRequests').doc(currentUser.uid).set({
                        requesterName: userData.username,
                        comment: comment,
                        status: 'pending',
                        requestedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    hideModal();
                    showModal(TPL.messageModal('Request Sent', 'Your request to join as a co-teacher has been sent to the class owner.', 'green'));
                }
                
                async function handleCoTeacherRequest(classId, requesterId, action) {
                    const requestRef = db.collection('classes').doc(classId).collection('coTeacherRequests').doc(requesterId);
                    if(action === 'accept'){
                        await db.collection('classes').doc(classId).update({ teacherIds: firebase.firestore.FieldValue.arrayUnion(requesterId) });
                        await requestRef.update({ status: 'accepted' });
                    } else {
                        await requestRef.update({ status: 'denied' });
                    }
                }
                
                async function raiseHand(id,q){
                    const isEnabled = allLoadedClasses[id].handRaisingEnabled;
                    const now = new Date();
                    const todayStr = now.toISOString().split('T')[0];
                    const cls = allLoadedClasses[id];
                    let isScheduledOff = false;

                    if(cls.schedule?.disableAt && cls.scheduleLastActionDate !== todayStr){
                        const [hours, minutes] = cls.schedule.disableAt.split(':');
                        const disableTime = new Date();
                        disableTime.setHours(hours, minutes, 0, 0);
                        if (now > disableTime) {
                            isScheduledOff = true;
                            console.log(`Schedule auto-disabling for ${cls.name} at ${cls.schedule.disableAt}. Rejecting raise hand.`);
                            await db.collection('classes').doc(id).update({ scheduleLastActionDate: todayStr, handRaisingEnabled: false });
                            lowerAllHands(id);
                        }
                    }

                    if (!isEnabled || isScheduledOff) {
                        showModal(TPL.messageModal('Hand Raising Paused', isScheduledOff ? 'Hand raising is currently paused due to the class schedule.' : 'Hand raising is currently paused by the teacher.', 'yellow'));
                        return;
                    }

                    const existingHand = await db.collection('classes').doc(id).collection('raisedHands').doc(currentUser.uid).get();
                    if(existingHand.exists){
                        await db.collection('classes').doc(id).collection('raisedHands').doc(currentUser.uid).update({ question: q || '', raisedAt: firebase.firestore.FieldValue.serverTimestamp(), status: 'pending' });
                        showModal(TPL.messageModal('Hand Updated', 'Your existing raised hand question has been updated.', 'green'));
                        hideModal();
                        return;
                    }
                    
                    await db.collection('classes').doc(id).collection('raisedHands').doc(currentUser.uid).set({studentName:userData.username,studentPhotoURL:currentUser.photoURL||'',question:q||'',raisedAt:firebase.firestore.FieldValue.serverTimestamp(), status: 'pending'});hideModal();}

                async function lowerHand(id,studentId=currentUser.uid){await db.collection('classes').doc(id).collection('raisedHands').doc(studentId).delete();}
                async function lowerAllHands(id){const s=await db.collection('classes').doc(id).collection('raisedHands').get();const b=db.batch();s.docs.forEach(d=>b.delete(d.ref));await b.commit();}
                
                async function toggleHandRaising(id,status){
                    const todayStr = new Date().toISOString().split('T')[0];
                    await db.collection('classes').doc(id).update({handRaisingEnabled:status, scheduleLastActionDate: todayStr});
                    if(!status) {
                        await lowerAllHands(id);
                    }
                }
                
                async function handleChangeClassName(id,name){
                    const today=new Date().toISOString().split('T')[0];
                    const key=`classNameChanges_${id}`;
                    let changes = {};
                    try {
                        changes=JSON.parse(localStorage.getItem(key))||{};
                    } catch(e) {
                        changes={}; // CATCH ADDED HERE
                    }

                    if(changes.date!==today){changes={date:today,count:0};}
                    if(changes.count>=3){showModal(TPL.messageModal('Limit Reached','You can only change the class name 3 times per day.','red'));return;}
                    await db.collection('classes').doc(id).update({name});
                    changes.count++;
                    localStorage.setItem(key,JSON.stringify(changes));
                    showModal(TPL.messageModal('Success','Class name updated!','green'));
                }
                
                async function handleSaveSchedule(id,enable,disable){
                    const todayStr = new Date().toISOString().split('T')[0];
                    await db.collection('classes').doc(id).update({schedule:{enableAt:enable,disableAt:disable}, scheduleLastActionDate: todayStr});
                    showModal(TPL.messageModal('Success','Schedule saved!','green'));
                }
                async function deleteSchedule(id) { 
                    const todayStr = new Date().toISOString().split('T')[0];
                    await db.collection('classes').doc(id).update({ 'schedule.enableAt': '', 'schedule.disableAt': '', scheduleLastActionDate: todayStr }); 
                    showModal(TPL.messageModal('Success', 'Schedule has been removed.', 'green')); 
                }
                
                async function removeUserFromClass(id, userId) { 
                    const data = allLoadedClasses[id]; 
                    if (data.teacherId === userId) { showModal(TPL.messageModal('Cannot Remove Owner', 'The class owner cannot be removed this way. You must delete the class.', 'red')); return; }
                    if ((data.teacherIds || []).includes(userId)) { await db.collection('classes').doc(id).update({ teacherIds: firebase.firestore.FieldValue.arrayRemove(userId) }); } 
                    else if ((data.studentIds || []).includes(userId)) { await db.collection('classes').doc(id).update({ studentIds: firebase.firestore.FieldValue.arrayRemove(userId) }); } 
                    await fetchRosterData(allLoadedClasses[id]); 
                    renderMainContent(); 
                }
                async function handleDeleteClass(id){
                    const isOwner = allLoadedClasses[id].teacherId === userData.uid;
                    if(!isOwner) { showModal(TPL.messageModal('Access Denied', 'Only the class owner can delete the class.', 'red')); return; }

                    const s=await db.collection('classes').doc(id).collection('raisedHands').get();const b=db.batch();s.docs.forEach(d=>b.delete(d.ref));b.delete(db.collection('classes').doc(id));await b.commit();hideModal();selectClass(null);}

                let scheduleInterval = null;
                function initializeScheduleChecker() {
                    if (scheduleInterval) clearInterval(scheduleInterval);
                    scheduleInterval = setInterval(() => {
                        const now = new Date();
                        const todayStr = now.toISOString().split('T')[0];
                        if (!userData || userData.role !== 'teacher') return;

                        for (const classId in allLoadedClasses) {
                            const cls = allLoadedClasses[classId];
                            if (cls.teacherId === userData.uid) {
                                
                                if (cls.schedule?.disableAt && cls.handRaisingEnabled) {
                                    if (cls.scheduleLastActionDate === todayStr) continue;

                                    const [hours, minutes] = cls.schedule.disableAt.split(':');
                                    const disableTime = new Date();
                                    disableTime.setHours(hours, minutes, 0, 0);

                                    if (now > disableTime) {
                                        console.log(`Auto-disabling for ${cls.name} at ${cls.schedule.disableAt}`);
                                        db.collection('classes').doc(classId).update({ scheduleLastActionDate: todayStr, handRaisingEnabled: false });
                                        lowerAllHands(classId);
                                    }
                                }

                                if (cls.schedule?.enableAt && cls.schedule?.disableAt && cls.scheduleLastActionDate !== todayStr) {
                                    const [enableHours, enableMinutes] = cls.schedule.enableAt.split(':');
                                    const enableTime = new Date();
                                    enableTime.setHours(enableHours, enableMinutes, 0, 0);

                                    if (now >= enableTime && !cls.handRaisingEnabled) {
                                         console.log(`Auto-enabling for ${cls.name} at ${cls.schedule.enableAt}`);
                                         db.collection('classes').doc(classId).update({ scheduleLastActionDate: todayStr, handRaisingEnabled: true });
                                    }
                                }
                            }
                        }
                    }, 60000);
                }
                
                let gapiLoaded=false,googleAuth=null;
                const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/classroom/v1/rest';
                const SCOPES = 'https://www.googleapis.com/auth/classroom.courses.readonly https://www.googleapis.com/auth/classroom.rosters.readonly';
                async function initializeGAPI(apiKey,clientId){
                    if(gapiLoaded)return Promise.resolve();
                    return new Promise((resolve,reject)=>{
                        const checkGAPI=()=>{
                            if(typeof gapi!=='undefined'&&gapi.load){
                                gapi.load('client',async()=>{
                                    try{
                                        await gapi.client.init({apiKey,discoveryDocs:[DISCOVERY_DOC]});
                                        googleAuth=google.accounts.oauth2.initTokenClient({client_id:clientId,scope:SCOPES,callback:''});
                                        gapiLoaded=true;
                                        resolve();
                                    }catch(e){
                                        reject(e);
                                    }
                                });
                            }else{
                                setTimeout(checkGAPI,100);
                            }
                        };
                        checkGAPI();
                    });
                }
                function requestAccessToken(){return new Promise((resolve,reject)=>{try{googleAuth.callback=async(res)=>{if(res.error)return reject(new Error(res.error));gapi.client.setToken({access_token:res.access_token});try{await listGoogleCourses();}catch(e){reject(e);}}};googleAuth.requestAccessToken();}catch(e){reject(e);}});}
                
                // FIX 2: The code was truncated here. The incomplete function logic is commented out/removed 
                // and replaced with the closing structure for proper JavaScript execution.

                /*
                // --- TRUNCATED FUNCTIONS (COMMENTED OUT FOR SYNTAX FIX) ---
                async function listGoogleCourses(){const listEl=document.getElementById('g-import-list');const loadingEl=document.getElementById('g-import-loading');const errorEl=document.getElementById('g-import-error');try{loadingEl.textContent='Loading courses...';const response=await gapi.client.classroom.courses.list({teacher...} 
                // --- END TRUNCATED CODE ---
                */
                
                // A simplified handleAction is needed for the event listeners to work without the full logic
                async function handleAction(classId, studentId, action, commentText = null) { 
                    const handRef = db.collection('classes').doc(classId).collection('raisedHands').doc(studentId); 
                    if (action === 'accept') { await handRef.update({ status: 'accepted' }); }
                    else if (action === 'deny') { await handRef.update({ status: 'denied' }); }
                    else if (action === 'comment') { await handRef.update({ status: 'comment', comment: commentText }); }
                    else if (action === 'delete_comment') { await handRef.update({ comment: firebase.firestore.FieldValue.delete(), status: 'pending' }); }
                    else if (action === 'dismiss') { await handRef.update({ status: 'dismissed' }); }
                    else if (action === 'resolve') { await handRef.update({ status: 'resolved' }); }
                }

                // --- EVENT HANDLERS (MUST BE INSIDE onFirebaseReady) ---

                // User Profile Menu Toggle
                document.getElementById('user-profile-btn')?.addEventListener('click', () => {
                    const menu = document.getElementById('user-profile-menu');
                    menu.classList.toggle('hidden');
                    if (!menu.classList.contains('hidden')) {
                        menu.classList.add('fade-enter-active');
                        menu.classList.remove('fade-leave-to');
                        setTimeout(() => menu.classList.remove('fade-enter-active'), 200);
                    } else {
                        menu.classList.add('fade-leave-to');
                        setTimeout(() => menu.classList.remove('fade-leave-to'), 200);
                    }
                });
                
                // Logout Button
                document.getElementById('logout-btn')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    auth.signOut();
                });

                // Class Selection
                document.getElementById('class-list-container')?.addEventListener('click', (e) => {
                    const btn = e.target.closest('[data-class-id]');
                    if (btn) {
                        selectClass(btn.dataset.classId);
                    }
                });

                // Modal Close Event Listeners
                modalBackdrop.addEventListener('click', hideModal);
                document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && !modalBackdrop.classList.contains('hidden')) hideModal(); });

                // Sidebar Actions
                document.getElementById('new-class-btn')?.onclick = () => { showModal(TPL.newClassModal()); };
                document.getElementById('join-class-btn-main')?.onclick = () => { showModal(TPL.joinClassModal()); };

                // Event delegation for main content area actions
                document.body.addEventListener('mainContentRendered', () => {
                    // Hand raising buttons (for students)
                    document.getElementById('raise-hand-btn-trigger')?.onclick = () => { showModal(TPL.raiseHandModal(currentClassId)); };
                    document.getElementById('lower-hand-btn-trigger')?.onclick = () => { lowerHand(currentClassId); };

                    // Class settings buttons (for teachers)
                    document.getElementById('class-settings-btn')?.onclick = () => { 
                        if(allLoadedClasses[currentClassId].teacherId === userData.uid) {
                            showModal(TPL.ownerSettingsModal(allLoadedClasses[currentClassId]));
                        } else {
                            showModal(TPL.coTeacherSettingsModal(allLoadedClasses[currentClassId]));
                        }
                    };
                    document.getElementById('roster-view-btn')?.onclick = () => { currentClassView = 'roster'; renderMainContent(); };
                    document.getElementById('queue-view-btn')?.onclick = () => { currentClassView = 'overview'; renderMainContent(); };
                    document.getElementById('requests-view-btn')?.onclick = () => { currentClassView = 'requests'; renderMainContent(); };
                    document.getElementById('gclassroom-import-btn')?.onclick = () => { showModal(TPL.gClassroomImportModal()); };
                    document.getElementById('leave-class-btn')?.onclick = () => { showModal(TPL.confirmLeaveClassModal(currentClassId, allLoadedClasses[currentClassId].name)); };

                    // Button handlers that require modal access (inside body.addEventListener)
                    document.getElementById('create-new-class-btn')?.onclick = () => {
                        const name = document.getElementById('new-class-name').value.trim();
                        if (name) { createNewClass(name); }
                    };
                    document.getElementById('submit-join-class-btn')?.onclick = () => {
                        const code = document.getElementById('join-class-code').value.trim();
                        if (code) { joinClass(code); }
                    };
                    document.getElementById('submit-raise-hand-btn')?.onclick = () => {
                        const q = document.getElementById('raise-hand-question')?.value.trim();
                        raiseHand(currentClassId, q);
                    };
                    document.getElementById('submit-co-teacher-request')?.onclick = () => {
                        const classId = document.getElementById('submit-co-teacher-request').dataset.classId;
                        const comment = document.getElementById('co-teacher-comment').value.trim();
                        requestCoTeacher(classId, comment);
                    };
                    
                    document.getElementById('confirm-delete-class-btn')?.onclick = () => { 
                        handleDeleteClass(currentClassId); 
                    };

                    document.getElementById('toggle-hand-raising-btn')?.onclick = (e) => {
                        const status = e.target.dataset.status === 'false';
                        toggleHandRaising(currentClassId, status);
                    };

                    document.getElementById('edit-class-name-btn')?.onclick = () => { showModal(TPL.editClassNameModal(currentClassId, allLoadedClasses[currentClassId].name)); };
                    document.getElementById('set-local-class-name-btn')?.onclick = () => { showModal(TPL.setLocalClassNameModal(currentClassId, userData.localNameForClass?.[currentClassId] || '')); };
                    document.getElementById('schedule-class-btn')?.onclick = () => { showModal(TPL.scheduleHandRaisingModal(currentClassId, allLoadedClasses[currentClassId].schedule)); };
                    
                    document.getElementById('confirm-change-class-name-btn')?.onclick = () => {
                        const newName = document.getElementById('edit-class-name-input').value.trim();
                        if (newName && newName !== allLoadedClasses[currentClassId].name) {
                            handleChangeClassName(currentClassId, newName);
                        } else {
                            hideModal();
                        }
                    };

                    document.getElementById('save-local-class-name-btn')?.onclick = async () => {
                        const newName = document.getElementById('set-local-class-name-input').value.trim();
                        await db.collection('users').doc(currentUser.uid).update({ [`localNameForClass.${currentClassId}`]: newName || firebase.firestore.FieldValue.delete() });
                        userData.localNameForClass = userData.localNameForClass || {};
                        userData.localNameForClass[currentClassId] = newName || null;
                        showModal(TPL.messageModal('Success','Local name updated!','green'));
                        hideModal();
                        renderMainContent();
                    };

                    document.getElementById('confirm-leave-class-btn')?.onclick = async (e) => {
                        const id = e.target.dataset.classId;
                        await db.collection('classes').doc(id).update({ studentIds: firebase.firestore.FieldValue.arrayRemove(userData.uid) });
                        hideModal();
                        selectClass(null);
                        showModal(TPL.messageModal('Success', 'You have successfully left the class.', 'green'));
                    };

                    document.getElementById('confirm-delete-comment-btn')?.onclick = (e) => {
                        const id = e.target.dataset.classId;
                        const studentId = e.target.dataset.studentId;
                        handleAction(id, studentId, 'delete_comment');
                        hideModal();
                    };

                    document.getElementById('save-schedule-btn')?.onclick = () => {
                        const enableAt = document.getElementById('schedule-enable-time').value.trim();
                        const disableAt = document.getElementById('schedule-disable-time').value.trim();
                        handleSaveSchedule(currentClassId, enableAt, disableAt);
                    };

                    document.getElementById('delete-schedule-btn')?.onclick = () => {
                        deleteSchedule(currentClassId);
                    };

                    // Roster actions
                    document.querySelectorAll('.remove-user-btn').forEach(btn => {
                        btn.onclick = (e) => {
                            const userId = e.currentTarget.dataset.userId;
                            showModal(TPL.confirmRemoveUserModal(currentClassId, userId, currentRoster.students.find(s => s.id === userId)?.username || currentRoster.coTeachers.find(t => t.id === userId)?.username));
                        };
                    });
                    document.getElementById('confirm-remove-user-btn')?.onclick = (e) => {
                        removeUserFromClass(currentClassId, e.target.dataset.userId);
                        hideModal();
                    };

                    // Hand queue actions
                    document.querySelectorAll('.hand-action-btn').forEach(btn => {
                        btn.onclick = (e) => {
                            const { classId, studentId, action } = e.currentTarget.dataset;
                            if (action === 'comment') {
                                showModal(TPL.commentHandModal(classId, studentId, classQueues[classId].find(h => h.id === studentId)?.comment));
                            } else {
                                handleAction(classId, studentId, action);
                            }
                        };
                    });
                    
                    document.getElementById('submit-hand-comment-btn')?.onclick = (e) => {
                        const { classId, studentId } = e.target.dataset;
                        const commentText = document.getElementById('hand-comment-input').value.trim();
                        handleAction(classId, studentId, 'comment', commentText);
                        hideModal();
                    };

                    // Co-teacher requests actions
                    document.querySelectorAll('.request-action-btn').forEach(btn => {
                        btn.onclick = (e) => {
                            const { classId, requesterId, action } = e.currentTarget.dataset;
                            handleCoTeacherRequest(classId, requesterId, action);
                        };
                    });
                });
            });
        });
    </script>
</body>
</html>
