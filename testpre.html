<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notify | Loading...</title>
    
    <!-- Using a simplified CSP for demonstration; keep the original if stricter policies are required in the final environment -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' https://cdn.tailwindcss.com https://www.gstatic.com https://apis.google.com https://accounts.google.com 'unsafe-inline' 'unsafe-eval' https://kit.fontawesome.com;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net https://kit.fontawesome.com;
        font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net https://kit.fontawesome.com;
        img-src 'self' data: https://www.gstatic.com https://lh3.googleusercontent.com;
        connect-src 'self' https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://www.googleapis.com https://content.googleapis.com https://classroom.googleapis.com;
        frame-src 'self' https://accounts.google.com https://content.googleapis.com https://content-classroom.googleapis.com;
    ">
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load Font Awesome Icons -->
    <script src="https://kit.fontawesome.com/c5e93c8378.js" crossorigin="anonymous"></script>

    <!-- Configure Tailwind to use Inter font and custom theme -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    borderRadius: {
                        'squircle': '30%', // Custom rounded corner style
                    }
                }
            }
        }
    </script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom CSS for the split comment button and time input -->
    <style>
        .split-button-container {
            display: grid;
            grid-template-rows: 1fr 1fr;
            height: 100%;
            width: 100%;
            overflow: hidden;
            border-radius: 0.75rem; /* Equivalent to rounded-xl */
        }
        .split-button-top, .split-button-bottom {
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.15s;
        }
        .split-button-top {
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        .time-input-group {
            position: relative;
        }
        .time-input {
            font-variant-numeric: tabular-nums;
            letter-spacing: 0.1rem;
        }
        /* Style for the container background when a menu is open */
        .menu-active {
            background-color: #f7f9fb;
        }
    </style>
</head>

<body class="bg-gray-50 font-sans min-h-screen flex flex-col items-center">
    <!-- Main Application Container -->
    <div id="app-container" class="w-full max-w-xl p-4 sm:p-6 lg:p-8">
        <!-- Main UI will be injected here by render() -->
        <div class="text-center py-10 text-gray-500" id="loading-spinner">
            <i class="fas fa-spinner fa-spin text-2xl"></i>
            <p class="mt-2">Loading dashboard and authenticating...</p>
        </div>
    </div>

    <!-- Modals for Commenting and Messaging -->
    <div id="modal-container"></div>
    
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase Configuration (provided by the environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // State Variables
        let db;
        let auth;
        let userId = null;
        let userRole = 'unknown'; // 'teacher', 'co-teacher', 'student'
        let classData = null;
        let requests = [];
        let view = 'requests'; // 'requests', 'settings', 'co-teachers', 'help', 'student_settings'
        let currentRequestFilter = 'unanswered'; // 'unanswered', 'accepted', 'denied', 'commented'
        let isHandRaisingPaused = false;
        let classId = 'defaultClass'; // Assuming the app focuses on one class
        let localClassName = localStorage.getItem(`localClassName_${classId}`) || 'My Class';

        // Helper Functions
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        // --- Core UI Functions ---

        function showMessage(message, isError = false) {
            const modalContainer = $('#modal-container');
            const color = isError ? 'bg-red-500' : 'bg-green-500';
            const modal = document.createElement('div');
            modal.className = `fixed top-5 left-1/2 transform -translate-x-1/2 p-4 rounded-lg shadow-xl text-white z-50 transition-opacity duration-300 ${color}`;
            modal.textContent = message;
            modalContainer.appendChild(modal);

            setTimeout(() => {
                modal.classList.add('opacity-0');
                modal.addEventListener('transitionend', () => modal.remove());
            }, 3000);
        }

        // Sets the current view and updates the dynamic buttons
        function setView(newView) {
            view = newView;
            render();
            // Ensure body class is updated for background change in menu views
            if (['settings', 'co-teachers', 'help', 'student_settings'].includes(newView)) {
                $('body').classList.add('menu-active');
            } else {
                $('body').classList.remove('menu-active');
            }
        }
        
        // Updates the browser tab title to show unanswered request count
        function updateDocumentTitle() {
            const unansweredCount = requests.filter(r => r.status === 'unanswered').length;
            const prefix = unansweredCount > 0 ? `(${unansweredCount}) ` : '';
            const title = `${prefix}${localClassName} | Notify`;
            document.title = title;
        }

        // Real-time listener for tab focus change to ensure title is updated
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                updateDocumentTitle();
            }
        });

        // Function to safely extract request data based on current filter
        function getFilteredRequests() {
            let filtered = requests.filter(r => {
                if (userRole === 'student') {
                    // Students only see their requests made today
                    const today = new Date().toDateString();
                    const requestDate = new Date(r.timestamp?.toDate() || new Date()).toDateString();
                    if (requestDate !== today || r.userId !== userId) {
                        return false;
                    }
                }
                
                // General category filtering
                switch (currentRequestFilter) {
                    case 'unanswered':
                        return r.status === 'unanswered';
                    case 'accepted':
                        return r.status === 'accepted';
                    case 'denied':
                        return r.status === 'denied';
                    case 'commented':
                        return r.status === 'commented';
                    default:
                        return true;
                }
            }).sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0)); // Sort newest first

            return filtered;
        }

        // --- FIREBASE LISTENERS & DATA FETCHING ---

        // Checks if current time is within schedule period (Hand Raising ON)
        function checkSchedule() {
            if (!classData || !classData.schedule) {
                isHandRaisingPaused = false; // Default to ON if no schedule
                return;
            }

            const { start_time, end_time } = classData.schedule;
            if (!start_time || !end_time) {
                isHandRaisingPaused = false;
                return;
            }

            const now = new Date();
            const nowMinutes = now.getHours() * 60 + now.getMinutes();

            const [startH, startM] = start_time.split(':').map(Number);
            const [endH, endM] = end_time.split(':').map(Number);

            const startMinutes = startH * 60 + startM;
            const endMinutes = endM === 0 && endH === 0 ? 24 * 60 : endH * 60 + endM; // Handle 00:00 as midnight end

            // Paused period is from end_time to start_time (or end_time to 23:59 and 00:00 to start_time)
            let isScheduledTime = false;
            
            if (startMinutes <= endMinutes) {
                // Normal schedule (e.g., 9:00 to 15:00)
                isScheduledTime = nowMinutes >= startMinutes && nowMinutes < endMinutes;
            } else {
                // Overnight schedule (e.g., 22:00 to 08:00)
                isScheduledTime = nowMinutes >= startMinutes || nowMinutes < endMinutes;
            }

            // Hand raising is AUTO-ON during the scheduled time, and AUTO-PAUSED otherwise.
            isHandRaisingPaused = !isScheduledTime;
            render();
        }

        // Firestore subscription for class data
        function subscribeToClassData() {
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'classes', classId);

            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    classData = docSnap.data();
                    
                    // Determine User Role
                    const teachers = classData.teachers || [];
                    const coTeachers = classData.coTeachers || [];

                    if (teachers.includes(userId)) {
                        userRole = 'teacher';
                    } else if (coTeachers.includes(userId)) {
                        userRole = 'co-teacher';
                    } else {
                        userRole = 'student';
                    }
                    
                    // Check initial paused state based on schedule
                    checkSchedule(); 
                    
                } else {
                    // Class not found or deleted (Handle a simple error state, maybe force a redirect/exit)
                    console.error('Class document not found.');
                    classData = null;
                }
                // Initial render once class data is available
                render();
            }, (error) => {
                console.error("Error listening to class data:", error);
                showMessage('Failed to load class data.', true);
            });
        }
        
        // Firestore subscription for requests
        function subscribeToRequests() {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'requests'));

            onSnapshot(q, (snapshot) => {
                requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateDocumentTitle();
                render();
            }, (error) => {
                console.error("Error listening to requests:", error);
                showMessage('Failed to load requests.', true);
            });
        }
        
        // Set up interval to check schedule (e.g., every minute)
        setInterval(checkSchedule, 60000); // Check every 60 seconds

        // --- REQUEST ACTIONS (TEACHER/CO-TEACHER) ---

        async function acceptRequest(requestId) {
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'requests', requestId);
                await updateDoc(docRef, { 
                    status: 'accepted',
                    responseTimestamp: serverTimestamp(),
                    responderId: userId
                });
                showMessage('Request accepted!');
            } catch (error) {
                console.error("Error accepting request:", error);
                showMessage('Failed to accept request.', true);
            }
        }

        async function denyRequest(requestId) {
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'requests', requestId);
                await updateDoc(docRef, { 
                    status: 'denied',
                    responseTimestamp: serverTimestamp(),
                    responderId: userId
                });
                showMessage('Request denied.');
            } catch (error) {
                console.error("Error denying request:", error);
                showMessage('Failed to deny request.', true);
            }
        }

        function promptComment(requestId, existingComment = '') {
            const modalContainer = $('#modal-container');
            const isEdit = existingComment !== '';
            
            const modalHTML = `
                <div id="comment-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">${isEdit ? 'Edit Comment' : 'Add Comment'}</h3>
                        <textarea id="comment-text" class="w-full h-24 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Type your comment here..." maxlength="200">${existingComment}</textarea>
                        <div class="flex justify-end space-x-3 mt-4">
                            <button id="cancel-comment" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150">Cancel</button>
                            <button id="submit-comment" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-150">${isEdit ? 'Save' : 'Comment'}</button>
                        </div>
                    </div>
                </div>
            `;
            modalContainer.innerHTML = modalHTML;
            const modal = $('#comment-modal');
            const commentTextarea = $('#comment-text');

            $('#cancel-comment').addEventListener('click', () => modal.remove());
            $('#submit-comment').addEventListener('click', async () => {
                const comment = commentTextarea.value.trim();
                if (comment) {
                    await updateComment(requestId, comment);
                    modal.remove();
                } else {
                    showMessage('Comment cannot be empty.', true);
                }
            });
        }

        async function updateComment(requestId, comment) {
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'requests', requestId);
                await updateDoc(docRef, {
                    status: 'commented',
                    comment: comment,
                    responseTimestamp: serverTimestamp(),
                    responderId: userId
                });
                showMessage(comment ? 'Comment added/updated.' : 'Comment deleted.', comment ? false : true);
            } catch (error) {
                console.error("Error updating comment:", error);
                showMessage('Failed to update comment.', true);
            }
        }
        
        async function deleteComment(requestId) {
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'requests', requestId);
                await updateDoc(docRef, {
                    status: 'unanswered', // Revert status
                    comment: '',          // Clear comment
                    responseTimestamp: deleteField(), // Clear response time
                    responderId: deleteField()       // Clear responder
                });
                showMessage('Comment deleted successfully. Request status reverted to unanswered.');
            } catch (error) {
                console.error("Error deleting comment:", error);
                showMessage('Failed to delete comment.', true);
            }
        }
        
        // --- STUDENT ACTIONS ---

        async function createRequest() {
            if (isHandRaisingPaused) {
                showMessage('Hand raising is currently paused due to class schedule.', true);
                return;
            }
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'requests'), {
                    userId: userId,
                    userName: classData?.studentNames?.[userId] || 'Anonymous Student',
                    message: 'Need assistance.',
                    status: 'unanswered',
                    timestamp: serverTimestamp()
                });
                showMessage('Your request has been sent!');
            } catch (error) {
                console.error("Error creating request:", error);
                showMessage('Failed to create request.', true);
            }
        }
        
        // Student: Save local class name
        function saveLocalClassName(newName) {
            localClassName = newName;
            localStorage.setItem(`localClassName_${classId}`, newName);
            updateDocumentTitle();
            showMessage('Class name updated locally.');
            render();
        }

        // Student: Leave class (removes them from student list/name map)
        async function leaveClass() {
            const confirmLeave = window.confirm("Are you sure you want to leave this class? You will lose your customized name and won't see requests.");
            if (!confirmLeave) return;

            try {
                await runTransaction(db, async (transaction) => {
                    const classDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'classes', classId);
                    const classDoc = await transaction.get(classDocRef);
                    if (!classDoc.exists()) {
                        throw "Class does not exist!";
                    }
                    
                    const newStudentNames = { ...classDoc.data().studentNames };
                    delete newStudentNames[userId];

                    transaction.update(classDocRef, {
                        studentNames: newStudentNames
                    });
                });
                // Clear local storage and force userRole to unknown/redirect
                localStorage.removeItem(`localClassName_${classId}`);
                userId = null;
                userRole = 'unknown';
                // Reload or show a 'You have left' message
                $('body').innerHTML = '<div class="text-center py-20 text-gray-500">You have left the class.</div>';

            } catch (error) {
                console.error("Error leaving class:", error);
                showMessage('Failed to leave class.', true);
            }
        }

        // --- SETTINGS ACTIONS (TEACHER/CO-TEACHER) ---

        // Deletes the entire class document (only for Teacher)
        async function deleteClass() {
            if (userRole !== 'teacher') {
                showMessage('Only the teacher can delete the class.', true);
                return;
            }

            const confirmDelete = window.confirm("WARNING: Are you absolutely sure you want to delete this entire class? This cannot be undone.");
            if (!confirmDelete) return;

            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'classes', classId));
                showMessage('Class deleted successfully.');
                // Optionally redirect or show a "Class deleted" screen
                $('body').innerHTML = '<div class="text-center py-20 text-gray-500">Class has been deleted.</div>';
            } catch (error) {
                console.error("Error deleting class:", error);
                showMessage('Failed to delete class.', true);
            }
        }

        // Saves the hand raising pause state (for Teacher/Co-Teacher)
        async function toggleHandRaisingPause() {
            if (isHandRaisingPaused) {
                // If paused by schedule, user can't manually override
                if (classData?.schedule) {
                    showMessage('Hand raising status is currently dictated by the schedule. Manual override is disabled.', true);
                    return;
                }
            }

            const newState = !isHandRaisingPaused;
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'classes', classId), {
                    isHandRaisingPaused: newState
                });
                // isHandRaisingPaused will be updated by the listener, but we can set it locally for immediate feedback
                isHandRaisingPaused = newState;
                render();
            } catch (error) {
                console.error("Error toggling pause state:", error);
                showMessage('Failed to toggle hand raising.', true);
            }
        }

        async function saveSchedule() {
            const startTimeInput = $('#schedule-start-time');
            const endTimeInput = $('#schedule-end-time');
            
            const start_time = startTimeInput.value;
            const end_time = endTimeInput.value;

            if (!start_time || !end_time) {
                showMessage('Please set both start and end times for the schedule.', true);
                return;
            }

            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'classes', classId), {
                    schedule: { start_time, end_time }
                });
                showMessage('Class schedule saved successfully! Hand-raising will now follow the schedule.');
                checkSchedule(); // Re-run check immediately
            } catch (error) {
                console.error("Error saving schedule:", error);
                showMessage('Failed to save schedule.', true);
            }
        }


        // --- UI Rendering Functions ---

        // Renders the main view based on user role and current view state
        function render() {
            const container = $('#app-container');
            if (!userId) {
                container.innerHTML = `<div class="text-center py-10 text-gray-500"><i class="fas fa-exclamation-triangle text-2xl"></i><p class="mt-2">Authentication failed. Please reload.</p></div>`;
                return;
            }
            
            if (userRole === 'unknown' || !classData) {
                container.innerHTML = `<div class="text-center py-10 text-gray-500"><i class="fas fa-user-circle text-2xl"></i><p class="mt-2">Welcome! Determining your role...</p></div>`;
                return;
            }
            
            // Base layout structure
            let html = `
                ${renderHeader()}
                ${renderMainContent()}
            `;
            
            container.innerHTML = html;
            attachEventListeners();
        }

        // Renders the top navigation bar with dynamic buttons
        function renderHeader() {
            const isMenu = ['settings', 'co-teachers', 'help', 'student_settings'].includes(view);
            const isTeacherView = userRole === 'teacher' || userRole === 'co-teacher';
            
            const topButtons = [
                { id: 'settings', icon: 'fas fa-cog', title: 'Settings', role: isTeacherView ? 'teacher,co-teacher' : 'student' },
                { id: 'co-teachers', icon: 'fas fa-user-friends', title: 'Co-Teachers', role: 'teacher,co-teacher' },
                { id: 'help', icon: 'fas fa-question-circle', title: 'Help', role: 'teacher,co-teacher' },
            ].filter(btn => btn.role.includes(userRole));


            const mainNavHTML = topButtons.map(btn => {
                const isActiveMenu = view === btn.id;
                
                // If in a menu view, the button becomes a blue 'Home' button
                if (isMenu) {
                    const icon = isActiveMenu ? 'fas fa-home' : btn.icon;
                    const bgClass = isActiveMenu ? 'bg-blue-600 text-white shadow-lg' : 'bg-gray-200 text-gray-600';
                    const action = isActiveMenu ? `setView('requests')` : `setView('${btn.id}')`;
                    
                    return `
                        <button onclick="${action}" class="flex-1 h-12 ${bgClass} rounded-xl transition duration-200">
                            <i class="${icon} text-lg"></i>
                        </button>
                    `;
                } else {
                    // Normal view - grey buttons
                    return `
                        <button onclick="setView('${btn.id}')" class="flex-1 h-12 bg-gray-200 text-gray-600 rounded-xl hover:bg-gray-300 transition duration-200">
                            <i class="${btn.icon} text-lg"></i>
                        </button>
                    `;
                }
            }).join('');


            return `
                <div class="flex items-center justify-between mb-6">
                    <h1 class="text-2xl font-bold text-gray-800">${localClassName}</h1>
                    <div class="flex space-x-3 w-3/4">
                        ${userRole === 'student' ? `
                            <button onclick="createRequest()" class="h-12 w-12 bg-blue-600 text-white rounded-xl shadow-lg hover:bg-blue-700 transition duration-200">
                                <i class="fas fa-plus text-lg"></i>
                            </button>
                            <button onclick="setView('student_settings')" class="h-12 w-12 bg-gray-200 text-gray-600 rounded-xl hover:bg-gray-300 transition duration-200">
                                <i class="fas fa-cog text-lg"></i>
                            </button>
                        ` : mainNavHTML}
                    </div>
                </div>
            `;
        }
        
        // Renders the main content area (requests, settings, etc.)
        function renderMainContent() {
            switch (view) {
                case 'settings':
                    return renderSettingsMenu();
                case 'co-teachers':
                    return renderCoTeachersMenu();
                case 'help':
                    return renderHelpMenu();
                case 'student_settings':
                    return renderStudentSettingsMenu();
                case 'requests':
                default:
                    return renderRequestsList();
            }
        }

        // Renders the schedule section of the settings menu
        function renderScheduleSection() {
            const schedule = classData?.schedule || {};
            const start = schedule.start_time || '09:00';
            const end = schedule.end_time || '15:00';

            // Placeholder time input logic (will be attached via JS)
            return `
                <div class="space-y-4 p-6 bg-white rounded-xl shadow-md mt-6">
                    <h4 class="text-xl font-semibold text-gray-800 border-b pb-2">Schedule Management</h4>
                    <p class="text-sm text-gray-600 mb-4">Set a period when hand raising will be automatically turned ON. It will be paused outside this period.</p>
                    
                    <div class="flex items-center justify-between space-x-4">
                        <label class="text-gray-700 font-medium">Start Time:</label>
                        <div class="time-input-group w-1/3">
                            <input type="text" id="schedule-start-time" value="${start}" data-digits="${start.replace(':', '')}" 
                                class="time-input w-full p-2 border border-gray-300 rounded-lg text-center focus:ring-2 focus:ring-blue-500" maxlength="4">
                        </div>
                        
                        <label class="text-gray-700 font-medium">End Time:</label>
                        <div class="time-input-group w-1/3">
                            <input type="text" id="schedule-end-time" value="${end}" data-digits="${end.replace(':', '')}" 
                                class="time-input w-full p-2 border border-gray-300 rounded-lg text-center focus:ring-2 focus:ring-blue-500" maxlength="4">
                        </div>
                    </div>
                    
                    <button onclick="saveSchedule()" class="w-full mt-4 py-2 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 shadow-md">
                        Save Schedule
                    </button>
                </div>
            `;
        }

        // Renders the settings menu (Teacher/Co-Teacher)
        function renderSettingsMenu() {
            const isTeacher = userRole === 'teacher';
            return `
                <h2 class="text-3xl font-extrabold text-gray-900 mb-6">Settings</h2>
                
                <div class="space-y-6">
                    <!-- Class ID Display -->
                    <div class="p-4 bg-white rounded-xl shadow-md border-l-4 border-blue-500">
                        <p class="text-sm font-medium text-gray-500">Class ID</p>
                        <p class="text-lg font-mono text-gray-800 break-all">${classId}</p>
                    </div>

                    <!-- Hand Raising Toggle -->
                    ${renderHandRaisingToggle()}

                    <!-- Schedule Management -->
                    ${renderScheduleSection()}

                    <!-- Dangerous Actions -->
                    <div class="p-6 bg-red-50 rounded-xl border border-red-200">
                        <h4 class="text-xl font-semibold text-red-700 mb-4">Dangerous Zone</h4>
                        ${isTeacher ? `
                            <button onclick="deleteClass()" class="w-full py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition duration-150 shadow-md">
                                <i class="fas fa-trash mr-2"></i> Delete Class (Teacher Only)
                            </button>
                        ` : `
                            <p class="text-sm text-red-500">Co-teachers cannot delete the class.</p>
                        `}
                    </div>
                </div>
            `;
        }

        // Renders the student specific settings menu
        function renderStudentSettingsMenu() {
            const currentLocalName = localStorage.getItem(`localClassName_${classId}`) || '';

            return `
                <h2 class="text-3xl font-extrabold text-gray-900 mb-6">Student Settings</h2>
                
                <div class="space-y-6">
                    <!-- Local Name Setting -->
                    <div class="p-6 bg-white rounded-xl shadow-md">
                        <h4 class="text-xl font-semibold text-gray-800 mb-4">Personal Class Nickname</h4>
                        <p class="text-sm text-gray-600 mb-3">Set a local name for this class (only visible to you).</p>
                        <input type="text" id="local-name-input" value="${currentLocalName}" placeholder="e.g., Algebra 1"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="save-local-name-btn" class="w-full mt-3 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition duration-150 shadow-md">
                            Save Nickname
                        </button>
                    </div>

                    <!-- Leave Class Action -->
                    <div class="p-6 bg-red-50 rounded-xl border border-red-200">
                        <h4 class="text-xl font-semibold text-red-700 mb-4">Leave Class</h4>
                        <p class="text-sm text-red-500 mb-3">This will remove you from the class's student list.</p>
                        <button onclick="leaveClass()" class="w-full py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition duration-150 shadow-md">
                            <i class="fas fa-sign-out-alt mr-2"></i> Leave Class
                        </button>
                    </div>
                </div>
            `;
        }

        // Renders the Co-Teachers menu
        function renderCoTeachersMenu() {
            // Placeholder content for Co-Teachers management
            const coTeachers = classData?.coTeachers || [];
            return `
                <h2 class="text-3xl font-extrabold text-gray-900 mb-6">Co-Teachers (${coTeachers.length})</h2>
                <div class="space-y-4">
                    <p class="text-gray-600">This section is for managing co-teachers. Add/Remove functionality would be implemented here.</p>
                    <ul class="space-y-2">
                        ${coTeachers.map(id => `<li class="p-3 bg-white rounded-lg shadow-sm font-mono text-sm break-all">${id}</li>`).join('')}
                    </ul>
                </div>
            `;
        }

        // Renders the help menu
        function renderHelpMenu() {
            return `
                <h2 class="text-3xl font-extrabold text-gray-900 mb-6">Help & Documentation</h2>
                <div class="space-y-4">
                    <p class="text-gray-600">Detailed information about the dashboard features, roles, and troubleshooting.</p>
                    <div class="p-4 bg-yellow-50 rounded-xl border border-yellow-200">
                        <p class="font-semibold text-yellow-800">Your User ID:</p>
                        <p class="font-mono text-sm break-all">${userId}</p>
                    </div>
                </div>
            `;
        }
        
        // Renders the hand raising toggle button (Teacher/Co-Teacher view)
        function renderHandRaisingToggle() {
            const isPaused = isHandRaisingPaused;
            const buttonClass = isPaused ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600';
            const icon = isPaused ? 'fas fa-play' : 'fas fa-pause';
            const text = isPaused ? 'Resume Hand Raising' : 'Pause Hand Raising';
            
            let statusText = isPaused ? 'Currently Paused' : 'Currently Active';
            if (classData?.schedule) {
                statusText += ' (Scheduled)';
            }

            return `
                <div class="p-6 bg-white rounded-xl shadow-md">
                    <p class="text-sm font-medium text-gray-500">Hand Raising Status: <span class="font-semibold ${isPaused ? 'text-red-600' : 'text-green-600'}">${statusText}</span></p>
                    <button onclick="toggleHandRaisingPause()" class="w-full mt-3 py-3 text-white rounded-lg font-semibold transition duration-150 shadow-lg ${buttonClass}">
                        <i class="${icon} mr-2"></i> ${text}
                    </button>
                </div>
            `;
        }

        // Renders the main requests view
        function renderRequestsList() {
            const filteredRequests = getFilteredRequests();
            const isTeacherView = userRole === 'teacher' || userRole === 'co-teacher';
            
            const filterButtons = ['Unanswered', 'Accepted', 'Denied', 'Commented on'].map(title => {
                const key = title.toLowerCase().replace(' ', '_');
                const isActive = currentRequestFilter === key.replace('_on', '');
                const baseClass = 'px-3 py-1 text-sm font-medium rounded-full transition duration-150 whitespace-nowrap';
                const activeClass = 'bg-blue-600 text-white shadow-md';
                const inactiveClass = 'bg-gray-200 text-gray-700 hover:bg-gray-300';
                
                return `
                    <button onclick="setCurrentRequestFilter('${key.replace('_on', '')}')" class="${baseClass} ${isActive ? activeClass : inactiveClass}">
                        ${title}
                    </button>
                `;
            }).join('');
            
            return `
                <!-- Hand Raising Status Alert (Student View) -->
                ${userRole === 'student' && isHandRaisingPaused ? `
                    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 rounded-lg" role="alert">
                        <p class="font-bold">Hand Raising Paused</p>
                        <p class="text-sm">Requests cannot be created at this time due to the class schedule.</p>
                    </div>
                ` : ''}

                <!-- Teacher/Co-Teacher Hand Raising Toggle -->
                ${isTeacherView ? renderHandRaisingToggle() : ''}

                <!-- Request Filters -->
                <div class="flex space-x-2 overflow-x-auto py-2 my-4">
                    ${filterButtons}
                </div>

                <!-- Request List -->
                <h3 class="text-xl font-bold text-gray-800 mb-4">${currentRequestFilter.charAt(0).toUpperCase() + currentRequestFilter.slice(1).replace('_', ' ')} Requests (${filteredRequests.length})</h3>
                <div class="space-y-4">
                    ${filteredRequests.length > 0 ? 
                        filteredRequests.map(request => renderRequestCard(request, isTeacherView)).join('') : 
                        `<div class="text-center py-10 text-gray-500">No requests in this category.</div>`
                    }
                </div>
            `;
        }
        
        // Renders a single request card
        function renderRequestCard(request, isTeacherView) {
            const time = request.timestamp ? new Date(request.timestamp.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Pending';
            const studentName = request.userName || 'Unknown Student';
            
            const actionButtons = isTeacherView ? renderActionButtons(request) : '';

            return `
                <div class="bg-white p-4 rounded-xl shadow-lg flex justify-between items-center transition duration-200 border-l-4 
                    ${request.status === 'accepted' ? 'border-green-500' : request.status === 'denied' ? 'border-red-500' : request.status === 'commented' ? 'border-blue-500' : 'border-yellow-500'}">
                    
                    <div class="flex-1 min-w-0">
                        <p class="text-lg font-semibold text-gray-900 truncate">${studentName}</p>
                        <p class="text-sm text-gray-500 mt-1">${time}</p>
                        ${request.comment ? `<p class="text-xs italic text-blue-600 mt-2 p-1 bg-blue-50 rounded-md">Comment: ${request.comment}</p>` : ''}
                    </div>
                    
                    ${actionButtons}
                </div>
            `;
        }

        // Renders the 3 squircle action buttons for a request (Teacher/Co-Teacher)
        function renderActionButtons(request) {
            const { id, comment } = request;
            
            const commentButton = comment ? 
                // Split Button (Edit/Delete)
                `
                <div class="split-button-container w-full h-full bg-blue-100 rounded-xl shadow-md">
                    <div class="split-button-top hover:bg-blue-200" onclick="promptComment('${id}', '${comment.replace(/'/g, "\\'")}')">
                        <i class="fas fa-edit text-blue-600 text-lg"></i>
                    </div>
                    <div class="split-button-bottom hover:bg-blue-200" onclick="deleteComment('${id}')">
                        <i class="fas fa-trash-alt text-blue-600 text-lg"></i>
                    </div>
                </div>
                ` :
                // Single Comment Button (Add)
                `
                <button onclick="promptComment('${id}')" class="w-full h-full bg-white text-gray-700 rounded-xl shadow-md hover:bg-gray-100 transition duration-150">
                    <i class="fas fa-comment text-gray-500 text-lg"></i>
                </button>
                `;

            return `
                <div class="flex space-x-2 ml-4 h-12">
                    <!-- Accept Button -->
                    <button onclick="acceptRequest('${id}')" class="w-12 h-12 bg-green-500 text-white rounded-xl shadow-md hover:bg-green-600 transition duration-150">
                        <i class="fas fa-thumbs-up text-lg"></i>
                    </button>
                    
                    <!-- Comment Button (Split/Single) -->
                    <div class="w-12 h-12">
                        ${commentButton}
                    </div>
                    
                    <!-- Deny Button -->
                    <button onclick="denyRequest('${id}')" class="w-12 h-12 bg-red-500 text-white rounded-xl shadow-md hover:bg-red-600 transition duration-150">
                        <i class="fas fa-thumbs-down text-lg"></i>
                    </button>
                </div>
            `;
        }

        // --- Attach Listeners to Rendered Elements ---

        function setCurrentRequestFilter(filter) {
            currentRequestFilter = filter;
            render();
        }

        function attachEventListeners() {
            // Attach listeners for Student Settings
            if (view === 'student_settings') {
                const saveBtn = $('#save-local-name-btn');
                const nameInput = $('#local-name-input');
                if (saveBtn && nameInput) {
                    saveBtn.onclick = () => saveLocalClassName(nameInput.value);
                }
            }

            // Attach listeners for Time Input in Settings
            if (view === 'settings') {
                const timeInputs = $$('.time-input');
                timeInputs.forEach(input => {
                    input.addEventListener('keydown', (e) => {
                        let currentDigits = input.dataset.digits || '';

                        // Only allow digits and backspace/delete
                        if (e.key.length === 1 && /\d/.test(e.key)) {
                            if (currentDigits.length < 4) {
                                currentDigits += e.key;
                            }
                        } else if (e.key === 'Backspace' || e.key === 'Delete') {
                            currentDigits = currentDigits.slice(0, -1);
                        } else if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                            e.preventDefault();
                            // Basic time increment logic (too complex to fully implement here, leaving as a basic feature)
                        } else if (e.key.length === 1 && !e.ctrlKey && !e.metaKey) {
                            e.preventDefault(); // Prevent other keys from typing
                        }

                        // Time validation and formatting
                        if (currentDigits.length > 0) {
                            let padded = currentDigits.padStart(4, '0');
                            
                            let h_str = padded.slice(0, 2);
                            let m_str = padded.slice(2, 4);
                            
                            // Basic 12/24 hour validation (using 24h internal logic for simplicity, though the previous snippet seemed to use 12h)
                            if (parseInt(h_str, 10) > 23) h_str = '23';
                            if (parseInt(m_str, 10) > 59) m_str = '59';

                            const formattedValue = `${h_str}:${m_str}`;
                            input.value = formattedValue;
                            input.dataset.digits = currentDigits;
                        } else {
                            input.value = '';
                            input.dataset.digits = '';
                        }
                    });

                    input.addEventListener('blur', (e) => {
                        let val = e.target.value.replace(/[^0-9]/g, '');
                        if (val.length === 0) {
                            e.target.value = '09:00'; // Default if empty
                            e.target.dataset.digits = '0900';
                            return;
                        }
                        // Pad and format on blur
                        const padded = val.padStart(4, '0');
                        let h = parseInt(padded.slice(0, 2), 10);
                        let m = parseInt(padded.slice(2, 4), 10);

                        if (h > 23) h = 23;
                        if (m > 59) m = 59;
                        
                        const finalValue = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                        e.target.value = finalValue;
                        e.target.dataset.digits = finalValue.replace(':', '');
                    });
                });
            }
        }


        // --- Initialization ---

        async function init() {
            setLogLevel('Debug');
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Auth setup
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        subscribeToClassData();
                        subscribeToRequests();
                        checkSchedule(); // Initial schedule check
                    } else {
                        // User signed out or failed auth
                        $('#loading-spinner').innerHTML = `<i class="fas fa-exclamation-triangle text-2xl"></i><p class="mt-2">Authentication failed. Please reload.</p>`;
                    }
                });
                
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                $('#loading-spinner').innerHTML = `<i class="fas fa-exclamation-triangle text-2xl"></i><p class="mt-2">Failed to initialize. Check console for details.</p>`;
            }
        }

        // Expose functions globally for HTML event handlers
        window.setView = setView;
        window.saveSchedule = saveSchedule;
        window.deleteClass = deleteClass;
        window.toggleHandRaisingPause = toggleHandRaisingPause;
        window.acceptRequest = acceptRequest;
        window.denyRequest = denyRequest;
        window.promptComment = promptComment;
        window.deleteComment = deleteComment;
        window.createRequest = createRequest;
        window.leaveClass = leaveClass;
        window.setCurrentRequestFilter = setCurrentRequestFilter;

        // Start the application
        window.onload = init;
    </script>
</body>
</html>
