<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notify | Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Slate-50 */
        }
        .time-input-container {
            position: relative;
            display: inline-block;
        }
        /* Custom styles for squircle action buttons */
        .squircle {
            border-radius: 30%; /* Approximates a squircle shape */
        }
        /* Custom styles for split comment button */
        .split-button-container {
            border-radius: 0.75rem; /* Rounded edges for the container */
            overflow: hidden;
            width: 4rem; /* Fixed width for the button group */
            height: 4rem; /* Fixed height for the button group */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .split-button-top {
            height: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1); /* Separator */
        }
        .split-button-bottom {
            height: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* Ensure the main action buttons are appropriately sized */
        .action-button {
            width: 4rem;
            height: 4rem;
        }
        .time-input-container input[type="text"] {
            font-size: 2rem;
            text-align: center;
            padding: 0.5rem;
            border: none;
            outline: none;
            width: 8rem;
            background: transparent;
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen flex flex-col items-center">
        <!-- Initial Loading State to prevent white screen -->
        <div class="mt-20 text-center">
            <i class="fa-solid fa-spinner fa-spin text-4xl text-blue-500"></i>
            <p class="mt-4 text-gray-600">Loading Application and Authenticating...</p>
        </div>
    </div>

    <!-- Modals for Commenting, Deletion, etc. -->
    <div id="modal-container"></div>
    <!-- Message container for toasts -->
    <div id="message-container" class="fixed top-4 right-4 z-50"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, arrayUnion, arrayRemove, getDoc, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Global Variables (Mandatory Canvas Setup) ---
        // Retrieving mandatory environment variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let firebaseConfig;
        try {
            firebaseConfig = JSON.parse(firebaseConfigString);
        } catch (e) {
            console.error("Failed to parse firebase config. Using empty object.", e);
            firebaseConfig = {};
        }

        let app, db, auth;
        let userId = null;
        let userRole = null; // 'teacher', 'coTeacher', 'student', 'pending'
        let currentClassId = null;
        let currentView = 'dashboard';
        let classData = null;
        let classRequests = [];
        let currentFilter = 'Pending'; // 'Pending', 'Accepted', 'Denied', 'Commented'
        let unsubscribeRequests = null;
        let unsubscribeClass = null;
        let isAuthReady = false; // Flag to ensure rendering only happens after auth check

        // --- Firestore Paths ---
        const getClassPath = (id) => `artifacts/${appId}/public/data/classes/${id}`;
        const getRequestsCollectionPath = (classId) => `artifacts/${appId}/public/data/classes/${classId}/requests`;
        const getUserProfilePath = (uid) => `artifacts/${appId}/users/${uid}/profile/teacher`;

        // --- Utility Functions ---

        const formatTimestamp = (timestamp) => {
            if (!timestamp) return 'No Time';
            // Check if it's a Firestore Timestamp object before calling toDate()
            const date = typeof timestamp.toDate === 'function' ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        };
        
        const formatTime = (date) => {
            const h = String(date.getHours()).padStart(2, '0');
            const m = String(date.getMinutes()).padStart(2, '0');
            return `${h}:${m}`;
        };

        const updateDocumentTitle = (unansweredCount) => {
            const baseTitle = 'Notify | Dashboard';
            document.title = unansweredCount > 0 
                ? `(${unansweredCount}) ${baseTitle}` 
                : baseTitle;
        };

        const isTeacher = () => userRole === 'teacher' || userRole === 'coTeacher';
        const canManage = () => userRole === 'teacher';
        
        // --- Toast/Message Renderer ---
        const renderMessage = (message, type = 'info') => {
            const container = document.getElementById('message-container');
            const colorMap = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };
            const iconMap = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            
            const toast = document.createElement('div');
            toast.className = `p-4 mb-3 rounded-lg shadow-lg text-white ${colorMap[type]} transition-opacity duration-300 opacity-0 transform translate-x-full max-w-xs`;
            toast.innerHTML = `<i class="fa-solid ${iconMap[type]} mr-2"></i>${message}`;
            
            container.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('opacity-0', 'translate-x-full');
                toast.classList.add('opacity-100', 'translate-x-0');
            }, 10);

            // Animate out and remove
            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-x-0');
                toast.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        };

        // --- Data Subscription Management ---

        const unsubscribeAll = () => {
            if (unsubscribeRequests) {
                unsubscribeRequests();
                unsubscribeRequests = null;
            }
            if (unsubscribeClass) {
                unsubscribeClass();
                unsubscribeClass = null;
            }
        };

        const subscribeToClass = async (classId) => {
            unsubscribeAll();
            currentClassId = classId;

            unsubscribeClass = onSnapshot(doc(db, getClassPath(classId)), (docSnap) => {
                if (docSnap.exists()) {
                    classData = docSnap.data();
                    setLocalClassName(classId, classData.className);
                    subscribeToRequests(classId);
                    renderApp(); // Re-render when class settings change
                } else {
                    console.error("Class does not exist.");
                    classData = null;
                    currentClassId = null;
                    userRole = 'pending';
                    renderMessage('The class was deleted or you were removed.', 'error');
                    navigate('classSelector');
                }
            }, (error) => {
                console.error("Error subscribing to class:", error);
                renderMessage('Failed to load class data.', 'error');
            });
        };
        
        const subscribeToRequests = (classId) => {
            if (unsubscribeRequests) unsubscribeRequests();

            const requestsRef = collection(db, getRequestsCollectionPath(classId));
            const q = query(requestsRef);
            
            unsubscribeRequests = onSnapshot(q, (snapshot) => {
                classRequests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Sort by creation time (ascending)
                classRequests.sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));
                
                const unansweredCount = classRequests.filter(r => r.status === 'Pending').length;
                updateDocumentTitle(unansweredCount);
                renderApp();
            }, (error) => {
                console.error("Error subscribing to requests:", error);
                renderMessage('Failed to load request data.', 'error');
            });
        };

        // --- Core Authentication and Initialization ---

        const initializeFirebase = async () => {
            renderLogin('Connecting to services...'); 
            
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Firebase configuration is missing or malformed.");
                }
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');
                console.log("Firebase services initialized.");

                // 1. Set up Auth State Listener (Handles state change after sign-in)
                onAuthStateChanged(auth, async (user) => {
                    isAuthReady = true;
                    if (user) {
                        userId = user.uid;
                        await checkUserRole();
                        renderApp();
                    } else {
                        // This branch runs if initial sign-in fails or user signs out
                        userId = null;
                        userRole = null;
                        unsubscribeAll();
                        renderLogin('Ready to sign in...');
                    }
                });

                // 2. Perform Initial Sign-in (Triggers the listener above)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token. Awaiting role check...");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously. Awaiting role check...");
                }

            } catch (error) {
                console.error("Initialization Failed:", error);
                renderLogin(`Error: ${error.message}. Please check the console for details.`, true); 
            }
        };

        const checkUserRole = async () => {
            if (!userId) return;

            // 1. Check if user is a teacher
            const teacherDoc = await getDoc(doc(db, getUserProfilePath(userId)));

            if (teacherDoc.exists() && teacherDoc.data().currentClassId) {
                userRole = 'teacher';
                currentClassId = teacherDoc.data().currentClassId;
                await subscribeToClass(currentClassId);
                return;
            }

            // 2. Check if user is a co-teacher or student
            const classesRef = collection(db, `artifacts/${appId}/public/data/classes`);
            const q = query(classesRef, where("members", "array-contains", userId));
            const snapshot = await getDocs(q);

            if (!snapshot.empty) {
                const classDoc = snapshot.docs[0];
                currentClassId = classDoc.id;
                
                const data = classDoc.data();
                if (data.coTeachers && data.coTeachers.includes(userId)) {
                    userRole = 'coTeacher';
                } else {
                    userRole = 'student';
                }
                await subscribeToClass(currentClassId);
                return;
            }

            // 3. User is new or has no active class
            userRole = 'pending';
            currentClassId = null;
            currentView = 'classSelector';
        };
        
        const navigate = (view, newClassId = currentClassId) => {
            currentView = view;
            if (newClassId && newClassId !== currentClassId) {
                currentClassId = newClassId;
                subscribeToClass(currentClassId);
            } else {
                renderApp();
            }
        };

        // --- Request Action Handlers (Kept) ---

        const raiseHand = async (topic) => {
            if (!currentClassId || !userId) return;
            try {
                // Check if already pending request exists
                const existing = classRequests.find(r => r.userId === userId && r.status === 'Pending');
                if (existing) {
                    return renderMessage('You already have a pending request.', 'info');
                }

                await addDoc(collection(db, getRequestsCollectionPath(currentClassId)), {
                    userId: userId,
                    topic: topic || 'General Question',
                    timestamp: new Date(),
                    status: 'Pending',
                    comment: null
                });
                renderMessage('Hand raised! A teacher will be with you shortly.', 'success');
                // Close modal
                document.getElementById('modal-container').innerHTML = '';
            } catch (error) {
                console.error("Error raising hand:", error);
                renderMessage('Failed to raise hand.', 'error');
            }
        };

        const handleRequestAction = async (requestId, status, comment = null) => {
            if (!currentClassId || !isTeacher()) return;
            try {
                const requestRef = doc(db, getRequestsCollectionPath(currentClassId), requestId);
                const updates = {
                    status: status,
                    actionedBy: userId,
                    actionedAt: new Date(),
                };
                if (comment !== null) {
                    updates.comment = comment;
                }
                await updateDoc(requestRef, updates);
                renderMessage(`Request updated to: ${status}`, 'success');
                // Close modal if open
                document.getElementById('modal-container').innerHTML = '';
            } catch (error) {
                console.error(`Error updating request to ${status}:`, error);
                renderMessage(`Failed to update request status to ${status}.`, 'error');
            }
        };

        const deleteComment = async (requestId) => {
            if (!currentClassId || !isTeacher()) return;
            try {
                const requestRef = doc(db, getRequestsCollectionPath(currentClassId), requestId);
                await updateDoc(requestRef, {
                    comment: null,
                    status: 'Accepted' // Revert status after comment removal
                });
                renderMessage('Comment deleted and request status reset to Accepted.', 'success');
            } catch (error) {
                console.error("Error deleting comment:", error);
                renderMessage('Failed to delete comment.', 'error');
            }
        };

        const showCommentModal = (request) => {
            const currentComment = request.comment || '';
            const action = request.status === 'Commented' ? 'Edit' : 'Add';
            
            const modalHTML = `
                <div class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50">
                    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md m-4 transform transition-all duration-300 scale-100">
                        <h3 class="text-xl font-bold mb-4 text-gray-800">${action} Comment for Request #${request.id.substring(0, 5)}...</h3>
                        <p class="mb-4 text-sm text-gray-600">Topic: ${request.topic}</p>
                        <textarea id="comment-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" rows="4" placeholder="Enter your feedback or instructions here...">${currentComment}</textarea>
                        <div class="flex justify-end space-x-3 mt-4">
                            <button onclick="document.getElementById('modal-container').innerHTML = ''" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150 font-medium">Cancel</button>
                            <button id="submit-comment" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-150 font-medium">${action} Comment</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').innerHTML = modalHTML;
            
            const commentInput = document.getElementById('comment-input');
            const submitButton = document.getElementById('submit-comment');

            submitButton.onclick = () => {
                const comment = commentInput.value.trim();
                if (comment) {
                    handleRequestAction(request.id, 'Commented', comment);
                } else {
                    renderMessage('Comment cannot be empty.', 'error');
                }
            };
        };

        // --- Class Management Handlers (Kept) ---

        const createClass = async (className) => {
            if (!className) return renderMessage('Please enter a class name.', 'error');
            try {
                const classRef = doc(collection(db, `artifacts/${appId}/public/data/classes`));
                const newClassData = {
                    className: className,
                    teacherId: userId,
                    coTeachers: [],
                    members: [userId],
                    handRaisingEnabled: true,
                    isScheduleEnabled: false,
                    scheduleStart: '09:00',
                    scheduleEnd: '15:00',
                };
                await setDoc(classRef, newClassData);

                // Update teacher profile
                await setDoc(doc(db, getUserProfilePath(userId)), { currentClassId: classRef.id }, { merge: true });
                
                renderMessage(`Class "${className}" created successfully! ID: ${classRef.id}`, 'success');
                navigate('dashboard', classRef.id);
            } catch (error) {
                console.error("Error creating class:", error);
                renderMessage('Failed to create class. Check console for details.', 'error');
            }
        };

        const joinClass = async (classId) => {
            if (!classId) return renderMessage('Please enter a Class ID.', 'error');
            try {
                const classRef = doc(db, getClassPath(classId));
                const docSnap = await getDoc(classRef);
                
                if (!docSnap.exists()) {
                    return renderMessage('Class ID not found.', 'error');
                }
                const existingData = docSnap.data();
                
                // Add user to members array
                await updateDoc(classRef, {
                    members: arrayUnion(userId)
                });
                
                // If the user is a teacher, update their profile
                if (userRole === 'teacher') {
                     await setDoc(doc(db, getUserProfilePath(userId)), { currentClassId: classId }, { merge: true });
                }

                renderMessage(`Successfully joined class: ${existingData.className}`, 'success');
                navigate('dashboard', classId);
            } catch (error) {
                console.error("Error joining class:", error);
                renderMessage('Failed to join class. Check console for details.', 'error');
            }
        };

        const deleteClass = async () => {
            if (!currentClassId || userRole !== 'teacher') return;
            const className = classData?.className || 'Class';
            
            if (!window.confirm(`Are you sure you want to permanently delete the class: "${className}"? This action cannot be undone.`)) return;

            try {
                // 1. Remove class ID from teacher's profile
                await updateDoc(doc(db, getUserProfilePath(userId)), { currentClassId: null });

                // 2. Delete the class document
                await deleteDoc(doc(db, getClassPath(currentClassId)));

                // 3. Delete all requests (Optional, but good cleanup)
                // Note: Deleting subcollections is complex in Firestore. This is a placeholder.
                // For simplicity, we just delete the parent, but real-world apps need a batch delete/cloud function.

                unsubscribeAll();
                classData = null;
                currentClassId = null;
                renderMessage(`Class "${className}" deleted successfully.`, 'success');
                navigate('classSelector');
            } catch (error) {
                console.error("Error deleting class:", error);
                renderMessage('Failed to delete class.', 'error');
            }
        };

        const leaveClass = async () => {
            if (!currentClassId || userRole === 'teacher') return;
            const className = classData?.className || 'Class';

            if (!window.confirm(`Are you sure you want to leave the class: "${className}"?`)) return;

            try {
                const classRef = doc(db, getClassPath(currentClassId));

                // 1. Remove user from members/coTeachers
                await updateDoc(classRef, {
                    members: arrayRemove(userId),
                    coTeachers: arrayRemove(userId)
                });

                unsubscribeAll();
                classData = null;
                currentClassId = null;
                renderMessage(`Successfully left class: "${className}".`, 'success');
                navigate('classSelector');
            } catch (error) {
                console.error("Error leaving class:", error);
                renderMessage('Failed to leave class.', 'error');
            }
        };

        const addCoTeacher = async (coTeacherId) => {
            if (!coTeacherId || !currentClassId || userRole !== 'teacher') return;
            try {
                await updateDoc(doc(db, getClassPath(currentClassId)), {
                    coTeachers: arrayUnion(coTeacherId),
                    members: arrayUnion(coTeacherId) // Ensure they are a member too
                });
                renderMessage('Co-Teacher added successfully.', 'success');
                document.getElementById('co-teacher-id-input').value = '';
            } catch (error) {
                console.error("Error adding co-teacher:", error);
                renderMessage('Failed to add co-teacher.', 'error');
            }
        };

        const removeCoTeacher = async (coTeacherId) => {
            if (!coTeacherId || !currentClassId || userRole !== 'teacher') return;
            try {
                await updateDoc(doc(db, getClassPath(currentClassId)), {
                    coTeachers: arrayRemove(coTeacherId),
                });
                renderMessage('Co-Teacher removed successfully.', 'success');
            } catch (error) {
                console.error("Error removing co-teacher:", error);
                renderMessage('Failed to remove co-teacher.', 'error');
            }
        };

        const saveSchedule = async () => {
            if (!currentClassId || !canManage()) return;
            const isEnabled = document.getElementById('schedule-toggle').checked;
            const start = document.getElementById('schedule-start').value;
            const end = document.getElementById('schedule-end').value;

            try {
                await updateDoc(doc(db, getClassPath(currentClassId)), {
                    isScheduleEnabled: isEnabled,
                    scheduleStart: start,
                    scheduleEnd: end,
                });
                renderMessage('Schedule settings saved.', 'success');
            } catch (error) {
                console.error("Error saving schedule:", error);
                renderMessage('Failed to save schedule settings.', 'error');
            }
        };

        const toggleHandRaising = async () => {
            if (!currentClassId || !canManage()) return;
            try {
                const newState = !classData.handRaisingEnabled;
                await updateDoc(doc(db, getClassPath(currentClassId)), {
                    handRaisingEnabled: newState
                });
                renderMessage(`Hand raising is now ${newState ? 'enabled' : 'disabled'}.`, 'success');
            } catch (error) {
                console.error("Error toggling hand raising:", error);
                renderMessage('Failed to toggle hand raising.', 'error');
            }
        };
        
        // --- Input Handler (Time Format) ---
        const setupTimeInput = () => {
             document.querySelectorAll('.time-input-container input[type="text"]').forEach(input => {
                // Initialize internal state
                if (!input.dataset.digits) {
                    input.dataset.digits = input.value.replace(':', '').padStart(4, '0');
                }

                input.addEventListener('input', (e) => {
                    const input = e.target;
                    let currentDigits = input.dataset.digits || '';
                    const lastChar = e.data;
                    
                    if (/[0-9]/.test(lastChar)) {
                        currentDigits += lastChar;
                        if (currentDigits.length > 4) {
                            currentDigits = currentDigits.slice(-4);
                        }
                    } else if (e.inputType === 'deleteContentBackward') {
                        currentDigits = currentDigits.slice(0, -1);
                    } else if (lastChar === ':') {
                        // Ignore explicit colon input
                        return;
                    }
                    
                    input.dataset.digits = currentDigits;
                    const padded = currentDigits.padStart(4, '0');

                    let h_str = padded.slice(0, 2);
                    let m_str = padded.slice(2, 4);
                    
                    // Basic validation for time (24hr format in code, 12hr in UI just for simplicity, sticking to 24hr here as its simpler for time ranges)
                    if (parseInt(h_str, 10) > 23) h_str = '23';
                    if (parseInt(m_str, 10) > 59) m_str = '59';

                    const formattedValue = `${h_str}:${m_str}`;
                    if (input.value !== formattedValue) {
                        input.value = formattedValue;
                    }
                });

                input.addEventListener('blur', (e) => {
                    const input = e.target;
                    let [h_str, m_str] = input.value.split(':');
                    
                    let h = parseInt(h_str, 10);
                    let m = parseInt(m_str, 10);

                    if (isNaN(h) || h < 0 || h > 23) h = 9; // Default 9
                    if (isNaN(m) || m < 0 || m > 59) m = 0; // Default 0

                    const finalValue = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    input.value = finalValue;
                    input.dataset.digits = finalValue.replace(':', '');
                });
            });
        };

        // --- View Rendering ---

        const renderLogin = (message, isError = false) => {
            const container = document.getElementById('app');
            container.className = "min-h-screen flex flex-col items-center bg-gray-50";
            container.innerHTML = `
                <div class="w-full max-w-md p-6 mt-20 bg-white rounded-xl shadow-lg text-center border-t-4 border-${isError ? 'red' : 'blue'}-500">
                    <h2 class="text-2xl font-bold ${isError ? 'text-red-600' : 'text-blue-600'}">${isError ? 'Authentication Error' : 'Initializing Application'}</h2>
                    <p class="text-gray-600 mt-4">${message}</p>
                    ${!isError ? '<i class="fa-solid fa-spinner fa-spin text-4xl text-blue-500 mt-6"></i>' : ''}
                    <p class="text-xs text-gray-400 mt-6">User ID: ${userId || 'N/A'}</p>
                </div>
            `;
        };

        const renderHeader = () => {
            const className = classData?.className || 'Class Dashboard';
            const teacherName = userRole === 'teacher' ? ' (You)' : '';
            
            return `
                <header class="w-full bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-10 rounded-b-xl">
                    <div class="flex items-center space-x-3">
                        <i class="fa-solid fa-bell text-blue-500 text-3xl"></i>
                        <h1 class="text-2xl font-semibold text-gray-800">Notify: ${className}</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm font-medium text-gray-600 hidden sm:inline">
                            Role: ${userRole === 'teacher' ? 'Teacher' : userRole === 'coTeacher' ? 'Co-Teacher' : 'Student'}
                        </span>
                        ${currentView === 'dashboard' ? `
                            <button onclick="navigate('settings')" title="Settings" class="text-gray-500 hover:text-blue-600 transition p-2 rounded-full bg-gray-100 hover:bg-gray-200">
                                <i class="fa-solid fa-cog text-xl"></i>
                            </button>
                        ` : `
                            <button onclick="navigate('dashboard')" title="Dashboard" class="text-gray-500 hover:text-blue-600 transition p-2 rounded-full bg-gray-100 hover:bg-gray-200">
                                <i class="fa-solid fa-home text-xl"></i>
                            </button>
                        `}
                    </div>
                </header>
            `;
        };

        const renderRequestItem = (request) => {
            const isStudentRequest = request.userId === userId;
            const isActionable = isTeacher() && request.status === 'Pending';
            const statusColor = {
                'Pending': 'bg-yellow-100 text-yellow-800 border-yellow-300',
                'Accepted': 'bg-green-100 text-green-800 border-green-300',
                'Denied': 'bg-red-100 text-red-800 border-red-300',
                'Commented': 'bg-blue-100 text-blue-800 border-blue-300',
            };
            const statusIcon = {
                'Pending': 'fa-hourglass-half',
                'Accepted': 'fa-check',
                'Denied': 'fa-times',
                'Commented': 'fa-comment'
            };

            const actions = isTeacher() ? `
                <div class="flex space-x-2 mt-3 sm:mt-0 sm:ml-auto">
                    ${isActionable ? `
                        <button onclick="handleRequestAction('${request.id}', 'Accepted')" title="Accept" class="squircle action-button bg-green-500 text-white hover:bg-green-600 transition">
                            <i class="fa-solid fa-check"></i>
                        </button>
                        <button onclick="handleRequestAction('${request.id}', 'Denied')" title="Deny" class="squircle action-button bg-red-500 text-white hover:bg-red-600 transition">
                            <i class="fa-solid fa-times"></i>
                        </button>
                        <button onclick="showCommentModal(${JSON.stringify(request).replace(/"/g, '&quot;')})" title="Comment" class="squircle action-button bg-blue-500 text-white hover:bg-blue-600 transition">
                            <i class="fa-solid fa-comment-dots"></i>
                        </button>
                    ` : `
                        <button onclick="showCommentModal(${JSON.stringify(request).replace(/"/g, '&quot;')})" title="${request.comment ? 'View/Edit Comment' : 'Add Comment'}" class="squircle action-button bg-gray-500 text-white hover:bg-gray-600 transition">
                            <i class="fa-solid fa-comment"></i>
                        </button>
                    `}
                </div>
            ` : '';

            const commentSection = request.comment ? `
                <div class="mt-4 p-3 bg-gray-50 rounded-lg border border-gray-200 relative">
                    <p class="text-sm font-semibold text-blue-700"><i class="fa-solid fa-quote-left mr-2"></i>Teacher Comment:</p>
                    <p class="text-gray-700 text-sm mt-1 ml-1">${request.comment}</p>
                    ${isTeacher() ? `
                        <button onclick="deleteComment('${request.id}')" title="Delete Comment" class="absolute top-2 right-2 text-red-400 hover:text-red-600 transition">
                            <i class="fa-solid fa-trash-alt"></i>
                        </button>
                    ` : ''}
                </div>
            ` : '';

            return `
                <div class="bg-white p-5 rounded-xl shadow-md border border-gray-200 mb-4 flex flex-col sm:flex-row sm:items-center justify-between transition-all duration-300 hover:shadow-lg">
                    <div class="flex-grow">
                        <div class="flex items-center space-x-3 mb-2">
                            <span class="px-3 py-1 text-xs font-semibold rounded-full ${statusColor[request.status]} border">
                                <i class="fa-solid ${statusIcon[request.status]} mr-1"></i> ${request.status}
                            </span>
                            ${isStudentRequest ? '<span class="text-xs font-bold text-blue-600">Your Request</span>' : ''}
                        </div>
                        <p class="text-lg font-semibold text-gray-800">${request.topic}</p>
                        <p class="text-xs text-gray-500 mt-1">
                            Requested by: <span class="font-mono text-gray-700">${request.userId.substring(0, 8)}...</span> 
                            at ${formatTimestamp(request.timestamp)}
                        </p>
                        ${commentSection}
                    </div>
                    ${actions}
                </div>
            `;
        };

        const renderRequestFilterButtons = () => {
            const filters = ['Pending', 'Accepted', 'Denied', 'Commented'];
            
            const buttonHTML = filters.map(filter => {
                const isActive = currentFilter === filter;
                const baseClass = 'px-4 py-2 text-sm font-medium rounded-full transition duration-150';
                const activeClass = 'bg-blue-600 text-white shadow-md';
                const inactiveClass = 'bg-gray-200 text-gray-700 hover:bg-gray-300';
                
                return `
                    <button 
                        onclick="setCurrentFilter('${filter}')" 
                        class="${baseClass} ${isActive ? activeClass : inactiveClass}"
                    >
                        ${filter} 
                        (${classRequests.filter(r => r.status === filter).length})
                    </button>
                `;
            }).join('');

            return `
                <div class="flex flex-wrap gap-2 mb-6">
                    ${buttonHTML}
                </div>
            `;
        };
        
        // Helper function for the filter buttons
        window.setCurrentFilter = (filter) => {
            currentFilter = filter;
            renderApp();
        };

        const renderDashboard = () => {
            if (!classData) {
                return '<div class="p-6 text-center text-gray-500">Loading class data...</div>';
            }

            const isScheduleActive = classData.isScheduleEnabled;
            const handRaisingEnabled = classData.handRaisingEnabled;
            
            const now = new Date();
            const nowTime = formatTime(now);
            
            const isOutsideSchedule = isScheduleActive && (nowTime < classData.scheduleStart || nowTime > classData.scheduleEnd);
            const isHandRaisingAllowed = handRaisingEnabled && !isOutsideSchedule;

            const filteredRequests = classRequests.filter(r => {
                if (isTeacher()) {
                    return r.status === currentFilter;
                } else {
                    // Students only see their own requests
                    return r.userId === userId;
                }
            });

            const requestListHTML = filteredRequests.length > 0
                ? filteredRequests.map(renderRequestItem).join('')
                : `<p class="text-center text-gray-500 p-8 bg-white rounded-xl shadow-md">No ${isTeacher() ? currentFilter : 'your'} requests found.</p>`;

            const studentStatusMessage = () => {
                if (isScheduleActive) {
                    if (isOutsideSchedule) {
                        return `<div class="p-3 bg-red-100 text-red-700 rounded-lg text-sm mb-4"><i class="fa-solid fa-clock mr-2"></i>Hand raising is currently disabled outside of the set class time (${classData.scheduleStart} - ${classData.scheduleEnd}).</div>`;
                    }
                }
                if (!handRaisingEnabled) {
                     return `<div class="p-3 bg-red-100 text-red-700 rounded-lg text-sm mb-4"><i class="fa-solid fa-lock mr-2"></i>Hand raising has been disabled by the teacher.</div>`;
                }
                return '';
            };
            
            return `
                ${renderHeader()}
                <main class="w-full max-w-4xl p-4 flex-grow">
                    <div class="text-xs text-gray-500 mb-4 bg-white p-3 rounded-lg shadow-sm">
                        <span class="font-semibold text-gray-700">Class ID:</span> 
                        <span class="font-mono text-blue-600 select-all cursor-pointer">${currentClassId}</span> 
                        <i class="fa-solid fa-clone ml-2 text-sm hover:text-blue-500 cursor-pointer" onclick="navigator.clipboard.writeText('${currentClassId}'); renderMessage('Class ID copied!', 'info');"></i>
                        <span class="ml-4 font-semibold text-gray-700">Your User ID:</span> 
                        <span class="font-mono text-blue-600 select-all cursor-pointer">${userId}</span> 
                    </div>

                    ${isTeacher() ? `
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Live Queue</h2>
                        ${renderRequestFilterButtons()}
                        ${requestListHTML}
                    ` : `
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Raise Hand</h2>
                        
                        ${studentStatusMessage()}

                        <div class="p-6 bg-white rounded-xl shadow-lg mb-6">
                            <button 
                                onclick="showRaiseHandModal()" 
                                ${!isHandRaisingAllowed ? 'disabled' : ''}
                                class="w-full py-4 text-xl font-bold rounded-xl transition duration-200 
                                ${isHandRaisingAllowed ? 'bg-blue-600 text-white hover:bg-blue-700 active:ring-4 active:ring-blue-300' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}"
                            >
                                <i class="fa-solid fa-hand-paper mr-3"></i> 
                                ${isHandRaisingAllowed ? 'Raise My Hand' : 'Disabled'}
                            </button>
                            <p class="text-center text-sm text-gray-500 mt-3">Click to send a notification to your teacher.</p>
                        </div>
                        
                        <h2 class="text-xl font-bold text-gray-800 mb-4 mt-8">My Request History</h2>
                        ${classRequests.filter(r => r.userId === userId).length > 0 
                            ? classRequests.filter(r => r.userId === userId).map(renderRequestItem).join('') 
                            : '<p class="text-center text-gray-500 p-8 bg-white rounded-xl shadow-md">No requests sent yet.</p>'}
                    `}
                </main>
            `;
        };

        const showRaiseHandModal = () => {
            const modalHTML = `
                <div class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50">
                    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md m-4">
                        <h3 class="text-2xl font-bold mb-4 text-gray-800">What do you need help with?</h3>
                        <textarea id="topic-input" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150" rows="3" placeholder="e.g., Struggling with question 5 on the worksheet..."></textarea>
                        <div class="flex justify-end space-x-3 mt-4">
                            <button onclick="document.getElementById('modal-container').innerHTML = ''" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150 font-medium">Cancel</button>
                            <button id="submit-hand-raise" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-150 font-medium">
                                <i class="fa-solid fa-paper-plane mr-2"></i> Send Request
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').innerHTML = modalHTML;

            document.getElementById('submit-hand-raise').onclick = () => {
                const topic = document.getElementById('topic-input').value.trim() || 'General Question';
                raiseHand(topic);
            };
        };

        const renderSettings = () => {
            if (!classData) return '';
            
            const handRaisingToggleChecked = classData.handRaisingEnabled ? 'checked' : '';
            const scheduleToggleChecked = classData.isScheduleEnabled ? 'checked' : '';
            const isTeacherRole = userRole === 'teacher';
            const isCoTeacherRole = userRole === 'coTeacher';

            const scheduleSection = canManage() ? `
                <div class="bg-white p-6 rounded-xl shadow-lg mb-6 border-l-4 border-yellow-500">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800 flex justify-between items-center">
                        Class Schedule Restrictions
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="schedule-toggle" ${scheduleToggleChecked} class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-yellow-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-yellow-500"></div>
                            <span class="ml-3 text-sm font-medium text-gray-900">Enabled</span>
                        </label>
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">Hand raising will only be allowed between the specified times if enabled.</p>
                    <div class="flex flex-wrap gap-4 items-center mb-4">
                        <div class="flex items-center space-x-2 time-input-container">
                            <label for="schedule-start" class="text-sm font-medium text-gray-700">Start Time:</label>
                            <input type="text" id="schedule-start" value="${classData.scheduleStart || '09:00'}" maxlength="5" placeholder="HH:MM" data-digits="${classData.scheduleStart?.replace(':', '') || '0900'}" class="w-20 text-center border border-gray-300 rounded-lg p-2 focus:ring-yellow-500 focus:border-yellow-500" />
                        </div>
                        <div class="flex items-center space-x-2 time-input-container">
                            <label for="schedule-end" class="text-sm font-medium text-gray-700">End Time:</label>
                            <input type="text" id="schedule-end" value="${classData.scheduleEnd || '15:00'}" maxlength="5" placeholder="HH:MM" data-digits="${classData.scheduleEnd?.replace(':', '') || '1500'}" class="w-20 text-center border border-gray-300 rounded-lg p-2 focus:ring-yellow-500 focus:border-yellow-500" />
                        </div>
                    </div>
                    <button onclick="saveSchedule()" class="mt-2 px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition font-medium">Save Schedule</button>
                </div>
            ` : '';

            const coTeacherManagement = isTeacherRole ? `
                <div class="bg-white p-6 rounded-xl shadow-lg mb-6 border-l-4 border-purple-500">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">Co-Teacher Management</h3>
                    ${renderCoTeachers()}
                    <div class="mt-4 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                        <input type="text" id="co-teacher-id-input" placeholder="Enter Co-Teacher User ID" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500" />
                        <button onclick="addCoTeacher(document.getElementById('co-teacher-id-input').value.trim())" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-medium">Add Co-Teacher</button>
                    </div>
                </div>
            ` : '';

            const dangerZone = isTeacherRole ? `
                <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-red-500">
                    <h3 class="text-xl font-semibold mb-4 text-red-700">Danger Zone</h3>
                    <p class="text-sm text-gray-600 mb-4">Permanently delete this class. This action cannot be undone.</p>
                    <button onclick="deleteClass()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-medium">Delete Class: ${classData.className}</button>
                </div>
            ` : isCoTeacherRole || userRole === 'student' ? `
                <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-red-500">
                    <h3 class="text-xl font-semibold mb-4 text-red-700">Leave Class</h3>
                    <p class="text-sm text-gray-600 mb-4">You will lose access to the live request queue and student view.</p>
                    <button onclick="leaveClass()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-medium">Leave Class: ${classData.className}</button>
                </div>
            ` : '';


            return `
                ${renderHeader()}
                <main class="w-full max-w-4xl p-4 flex-grow">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Class Settings</h2>
                    
                    <div class="bg-white p-6 rounded-xl shadow-lg mb-6 border-l-4 border-blue-500">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Class Info</h3>
                        <p class="text-sm text-gray-600 mb-2">Class ID: <span class="font-mono text-blue-600 select-all">${currentClassId}</span></p>
                        <p class="text-sm text-gray-600">Your User ID: <span class="font-mono text-blue-600 select-all">${userId}</span></p>
                    </div>

                    ${canManage() ? `
                        <div class="bg-white p-6 rounded-xl shadow-lg mb-6 border-l-4 border-green-500">
                            <h3 class="text-xl font-semibold mb-4 text-gray-800 flex justify-between items-center">
                                Hand Raising Status
                                <button onclick="toggleHandRaising()" class="px-3 py-1 text-sm font-medium rounded-full ${classData.handRaisingEnabled ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'} hover:shadow-md transition">
                                    ${classData.handRaisingEnabled ? 'Disable' : 'Enable'}
                                </button>
                            </h3>
                            <p class="text-lg font-bold ${classData.handRaisingEnabled ? 'text-green-600' : 'text-red-600'}">
                                <i class="fa-solid fa-${classData.handRaisingEnabled ? 'check-circle' : 'ban'} mr-2"></i>
                                Hand Raising is currently ${classData.handRaisingEnabled ? 'ACTIVE' : 'DISABLED'}
                            </p>
                        </div>
                    ` : ''}

                    ${scheduleSection}
                    ${coTeacherManagement}
                    ${dangerZone}
                </main>
            `;
        };

        const renderCoTeachers = () => {
            const coTeachers = classData?.coTeachers || [];
            if (coTeachers.length === 0) {
                return '<p class="text-sm text-gray-500 mb-4">There are no co-teachers for this class yet.</p>';
            }

            return `
                <ul class="mb-4 space-y-2">
                    ${coTeachers.map(id => `
                        <li class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-200">
                            <span class="font-mono text-sm text-purple-600">${id}</span>
                            <button onclick="removeCoTeacher('${id}')" title="Remove Co-Teacher" class="text-red-400 hover:text-red-600 transition">
                                <i class="fa-solid fa-user-slash"></i>
                            </button>
                        </li>
                    `).join('')}
                </ul>
            `;
        };

        const renderClassSelector = () => {
             const userIdDisplay = userId ? `<span class="font-mono text-blue-600 select-all">${userId}</span>` : 'N/A';
            return `
                <div class="w-full max-w-md p-6 mt-12 bg-white rounded-xl shadow-2xl border-t-4 border-blue-500">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4 text-center">Welcome!</h2>
                    <p class="text-sm text-gray-600 mb-6 text-center">Your User ID: ${userIdDisplay}</p>

                    <div class="space-y-6">
                        <!-- Join Class Section -->
                        <div class="border border-gray-200 p-4 rounded-lg bg-gray-50">
                            <h3 class="text-xl font-semibold text-gray-800 mb-3 flex items-center"><i class="fa-solid fa-link mr-2 text-blue-500"></i> Join a Class</h3>
                            <p class="text-sm text-gray-600 mb-3">Enter the Class ID provided by your teacher.</p>
                            <input type="text" id="join-class-id" placeholder="Class ID" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-3" />
                            <button onclick="joinClass(document.getElementById('join-class-id').value.trim())" class="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                                <i class="fa-solid fa-user-plus mr-2"></i> Join Class
                            </button>
                        </div>

                        <!-- Create Class Section (Teacher Only) -->
                        <div class="border border-gray-200 p-4 rounded-lg bg-gray-50">
                            <h3 class="text-xl font-semibold text-gray-800 mb-3 flex items-center"><i class="fa-solid fa-graduation-cap mr-2 text-green-500"></i> Create New Class</h3>
                            <p class="text-sm text-gray-600 mb-3">Only teachers should create a new class.</p>
                            <input type="text" id="create-class-name" placeholder="Class Name (e.g., Math 101)" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 mb-3" />
                            <button onclick="createClass(document.getElementById('create-class-name').value.trim())" class="w-full py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium">
                                <i class="fa-solid fa-plus mr-2"></i> Create Class
                            </button>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderApp = () => {
            if (!isAuthReady) {
                renderLogin('Waiting for authentication check...');
                return;
            }

            const container = document.getElementById('app');
            container.className = "min-h-screen flex flex-col items-center w-full";
            
            let content = '';

            if (currentClassId && classData) {
                if (currentView === 'dashboard') {
                    content = renderDashboard();
                } else if (currentView === 'settings') {
                    content = renderSettings();
                }
            } else {
                content = renderClassSelector();
            }

            container.innerHTML = content;
            setupTimeInput(); // Re-run time input setup after rendering settings view
        };

        // --- Expose functions globally for HTML event handlers ---
        window.navigate = navigate;
        window.joinClass = joinClass;
        window.createClass = createClass;
        window.raiseHand = raiseHand;
        window.handleRequestAction = handleRequestAction;
        window.showCommentModal = showCommentModal;
        window.deleteComment = deleteComment;
        window.deleteClass = deleteClass;
        window.leaveClass = leaveClass;
        window.addCoTeacher = addCoTeacher;
        window.removeCoTeacher = removeCoTeacher;
        window.saveSchedule = saveSchedule;
        window.toggleHandRaising = toggleHandRaising;
        window.showRaiseHandModal = showRaiseHandModal;

        // --- Initialization on Load ---
        initializeFirebase();
        
    </script>
</body>
</html>
