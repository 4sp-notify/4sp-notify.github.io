<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notify | Dashboard</title>
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' https://cdn.tailwindcss.com https://www.gstatic.com https://apis.google.com https://accounts.google.com 'unsafe-inline' 'unsafe-eval';
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net;
        font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net;
        img-src 'self' data: https://www.gstatic.com https://lh3.googleusercontent.com;
        connect-src 'self' https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://www.googleapis.com https://content.googleapis.com https://classroom.googleapis.com;
        frame-src 'self' https://accounts.google.com https://content.googleapis.com https://content-classroom.googleapis.com;
    ">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css">

    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        /* Base styling using Inter and Poppins fonts */
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        .font-poppins { font-family: 'Poppins', sans-serif; }
        
        /* Custom input style */
        .app-input {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb; /* gray-50 */
        }
        .app-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 1px #3b82f6;
            outline: none;
            background-color: white;
        }

        button, a.btn-bubbly, input, select, textarea { font-family: 'Inter', sans-serif; }
        h1, h2, h3, h4, .font-poppins { font-family: 'Poppins', sans-serif; }

        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px;}
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .main-layout { height: calc(100vh - 4rem); }

        /* Animations */
        .fade-enter-from, .fade-leave-to { opacity: 0; transform: scale(0.95); }
        .fade-enter-active, .fade-leave-active { transition: opacity 200ms ease-out, transform 200ms ease-out; }
        .fade-enter-to, .fade-leave-from { opacity: 1; transform: scale(1); }
        
        .btn-bubbly { transition: transform 0.1s ease-out; }
        .btn-bubbly:active { transform: scale(0.95); }

        .user-profile-menu-container { transition: transform 0.2s ease-out, opacity 0.2s ease-out; transform-origin: top right; }
        .menu-item-icon { display: inline-flex; width: 1.25rem; height: 1.25rem; margin-right: 0.75rem; align-items: center; justify-content: center; }
        
        .hand-status-card { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        .raise-hand-btn { box-shadow: 0 4px 15px 0 rgba(59, 130, 246, 0.4); transition: all 0.3s ease; }
        .raise-hand-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px 0 rgba(59, 130, 246, 0.5); }
        
        /* Combined notification badge */
        .class-notification-badge {
            position: absolute; top: 4px; right: 8px; min-width: 1.5rem; height: 1.5rem; border-radius: 9999px;
            color: white; font-size: 0.75rem; font-weight: bold; display: inline-flex; align-items: center;
            justify-content: center; padding: 0 0.375rem;
        }
        .badge-hands { background-color: #ef4444; /* red-500 */ }
        .badge-requests { background-color: #8b5cf6; /* violet-500 */ }
        .badge-multiple { background: linear-gradient(45deg, #ef4444, #8b5cf6); }

        /* Icon button with tooltip styles */
        .tooltip-container { position: relative; display: flex; flex-direction: column; align-items: center; }
        .tooltip-button { width: 3rem; height: 3rem; border-radius: 0.75rem; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; transition: background-color 0.2s, color 0.2s; }
        .tooltip-text {
            visibility: hidden; opacity: 0; width: max-content; background-color: #1f2937; color: #fff; text-align: center;
            border-radius: 0.375rem; padding: 4px 8px; position: absolute; z-index: 10; bottom: -28px; font-size: 0.75rem;
            font-weight: 500; transition: opacity 0.2s ease-out; pointer-events: none;
        }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
        
        /* Redesigned Schedule Picker */
        .schedule-time-input-container { display: flex; align-items: center; }
        .schedule-time-input { width: 100px; text-align: center; font-family: 'Poppins', sans-serif; font-weight: 500; }
        .period-selector { display: flex; margin-left: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.5rem; overflow: hidden; }
        .period-btn { padding: 0.75rem 1rem; border: none; background-color: #f9fafb; color: #6b7280; cursor: pointer; transition: background-color 0.2s, color 0.2s; font-family: 'Inter', sans-serif;}
        .period-btn.active { background-color: #3b82f6; color: white; }

        /* Custom styles for the new co-teacher request and hand queue action buttons */
        .request-action-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        .request-action-group button {
            width: 80px; /* fixed width for better alignment */
            padding: 0.5rem 0.5rem;
            font-size: 0.75rem; /* text-xs */
        }
        .comment-split-btn {
            display: flex;
            flex-direction: column;
            padding: 0; /* reset padding for split buttons */
        }
        .comment-split-btn button {
            width: 100%;
            padding: 0.25rem 0.5rem;
            border-radius: 0;
            line-height: 1;
        }
        .comment-split-btn button:first-child {
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }
        .comment-split-btn button:last-child {
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
        }
        /* Style for the fixed settings view content - REMOVED SETTINGS-CONTENT-WRAPPER */
        /* To prevent content shift, we apply padding to the main scrollable area */
        #main-content-area {
            padding-right: 18px; /* Fixed padding to account for potential scrollbar width */
        }

        /* NEW: Fading Scroll Container for smooth gradient effect */
        .fading-scroll-container {
            position: relative;
            overflow: hidden;
            flex-grow: 1; 
            min-height: 0;
        }

        .fading-scroll-content {
            height: 100%;
            overflow-y: scroll;
            padding: 1px; /* To prevent content from being clipped by the mask */
            /* Add the custom mask for fading effect */
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 10%, black 90%, transparent 100%);
            mask-image: linear-gradient(to bottom, transparent 0%, black 10%, black 90%, transparent 100%);
        }
    </style>
</head>
<body class="bg-slate-100 h-screen overflow-hidden">

    <div class="flex flex-col h-full">
        <header class="bg-white border-b border-gray-200 shadow-sm sticky top-0 z-30 h-16 flex-shrink-0">
            <div class="max-w-full mx-auto px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <a href="index.html" class="flex items-center space-x-3">
                        <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                        <h1 class="text-xl font-bold text-gray-800">Notify</h1>
                    </a>
                    <div class="relative">
                        <button id="user-profile-btn" type="button" class="btn-bubbly flex items-center justify-center w-10 h-10 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform duration-150 hover:scale-105">
                             <img id="user-profile-pic" class="w-full h-full rounded-lg object-cover hidden" src="" alt="User profile picture">
                             <div id="user-profile-initial" class="w-full h-full rounded-lg flex items-center justify-center bg-gradient-to-br from-blue-600 to-indigo-700 text-white font-bold text-lg hidden"></div>
                        </button>
                        <div id="user-profile-menu" class="user-profile-menu-container absolute right-0 mt-2 w-72 rounded-xl shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden" role="menu">
                            <div class="p-4 bg-gray-50 border-b border-gray-100 rounded-t-xl">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <img id="user-profile-pic-menu" class="h-12 w-12 rounded-full object-cover hidden" src="" alt="">
                                        <div id="user-profile-initial-menu" class="h-12 w-12 rounded-full flex items-center justify-center bg-gradient-to-br from-blue-600 to-indigo-700 text-white font-bold text-xl hidden"></div>
                                    </div>
                                    <div class="ml-3 min-w-0">
                                        <div id="user-display-name-container" class="marquee-container"><p id="user-display-name-menu" class="text-lg font-bold font-poppins text-gray-800 truncate">Loading...</p></div>
                                        <div id="user-email-container" class="marquee-container"><p id="user-email-menu" class="text-sm text-gray-500 truncate">Loading...</p></div>
                                    </div>
                                </div>
                            </div>
                            <div class="py-1" role="none">
                                <a href="settings.html" class="font-medium text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100 flex items-center" role="menuitem" tabindex="-1">
                                    <span class="menu-item-icon"><i class="fa-solid fa-sliders text-gray-400"></i></span>
                                    <span>Settings</span>
                                </a>
                                <a href="#" id="logout-btn" class="font-medium text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100 flex items-center" role="menuitem" tabindex="-1">
                                    <span class="menu-item-icon"><i class="fa-solid fa-right-from-bracket text-gray-400"></i></span>
                                    <span>Logout</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="flex flex-1 main-layout overflow-hidden">
            <aside class="w-72 bg-white border-r border-gray-200 flex flex-col flex-shrink-0">
                <div id="class-list-container" class="flex-grow p-4 overflow-y-auto custom-scrollbar">
                    <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3 px-2">My Classes</h2>
                    <ul id="class-list" class="space-y-1"></ul>
                    <div id="no-classes-sidebar" class="text-center text-sm text-gray-500 mt-4 hidden"><p>No classes yet.</p></div>
                </div>
                <div id="teacher-sidebar-actions" class="p-4 border-t border-gray-200 hidden">
                    <button id="new-class-btn" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-150 flex items-center justify-center space-x-2 btn-bubbly"><i class="fa-solid fa-plus w-5 h-5"></i><span>New Class</span></button>
                    <button id="join-class-btn-main" class="mt-2 w-full bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors duration-150 flex items-center justify-center space-x-2 btn-bubbly text-sm"><i class="fa-solid fa-user-plus w-5 h-5"></i><span>Join Class</span></button>
                </div>
            </aside>
            <main class="flex-1 flex flex-col overflow-hidden">
                <div id="main-content-area" class="flex-1 overflow-y-scroll bg-slate-100 p-6 sm:p-8 custom-scrollbar"></div>
            </main>
        </div>
    </div>
    
    <div id="modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-60 z-40 hidden"></div>
    <div id="modal-container" class="fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none"></div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let currentUser = null, userData = null, currentClassId = null, currentRoster = null;
            let allLoadedClasses = {}, classQueues = {}, classRequests = {}, studentClassRequests = {}, unsubscribes = [], queueUnsubscribers = {}; // ADDED studentClassRequests
            let currentClassView = 'overview';
            const REQUEST_LIMIT_PER_MINUTE = 2; // NEW: Local limit for student requests

            const mainContentArea = document.getElementById('main-content-area');
            const classListEl = document.getElementById('class-list');
            const modalContainer = document.getElementById('modal-container');
            const modalBackdrop = document.getElementById('modal-backdrop');

            function onFirebaseReady(callback) { const i = setInterval(() => { if (typeof firebase !== 'undefined') { clearInterval(i); callback(); } }, 50); }

            onFirebaseReady(() => {
                const app = firebase.initializeApp(firebaseConfig);
                const auth = firebase.auth();
                const db = firebase.firestore();
                const FieldValue = firebase.firestore.FieldValue; // Alias for brevity

                auth.onAuthStateChanged(user => {
                    if (user) { currentUser = user; fetchUserData(user.uid); } 
                    else { window.location.href = 'login.html'; }
                });

                async function fetchUserData(uid) {
                    const doc = await db.collection('users').doc(uid).get();
                    if (doc.exists) {
                        userData = { uid, ...doc.data() };
                        updateProfileUI(currentUser, userData);
                        listenForClasses(uid);
                        renderMainContent();
                        initializeScheduleChecker();
                        initializeRequestRecycler(); // NEW: Start request recycler
                    } else { auth.signOut(); }
                }
                
                function updateProfileUI(user, data) {
                    document.getElementById('user-display-name-menu').textContent = data.username;
                    document.getElementById('user-email-menu').textContent = user.email;
                    const pics = [document.getElementById('user-profile-pic'), document.getElementById('user-profile-pic-menu')];
                    const initials = [document.getElementById('user-profile-initial'), document.getElementById('user-profile-initial-menu')];
                    if (user.photoURL) {
                        pics.forEach(el => { el.src = user.photoURL; el.classList.remove('hidden'); });
                        initials.forEach(el => el.classList.add('hidden'));
                    } else {
                        const i = data.username.charAt(0).toUpperCase();
                        initials.forEach(el => { el.textContent = i; el.classList.remove('hidden'); });
                        pics.forEach(el => el.classList.add('hidden'));
                    }
                    document.getElementById('teacher-sidebar-actions').classList.toggle('hidden', data.role !== 'teacher');
                }

                function updateGlobalUI() {
                    updateDocumentTitle();
                    renderClassList(Object.values(allLoadedClasses));
                }
                
                function updateDocumentTitle() {
                    let handsCount = 0, requestsCount = 0;
                    if (userData && allLoadedClasses && classQueues && classRequests) {
                        for (const id in allLoadedClasses) {
                            const cls = allLoadedClasses[id];
                            if (cls) {
                                const isOwner = cls.teacherId === userData.uid;
                                const isCoTeacher = (cls.teacherIds || []).includes(userData.uid);
                                if(isOwner || isCoTeacher) handsCount += (classQueues[id] || []).length;
                                // Only count 'pending' requests for the badge (Teacher view)
                                if(isOwner) requestsCount += (classRequests[id] || []).filter(req => req.status === 'pending').length;
                            }
                        }
                    }
                    const totalCount = handsCount + requestsCount;
                    document.title = totalCount > 0 ? `(${totalCount}) Notify | Dashboard` : 'Notify | Dashboard';
                }

                function listenForClasses(uid) {
                    unsubscribes.forEach(unsub => unsub()); unsubscribes = [];
                    Object.values(queueUnsubscribers).forEach(unsub => unsub()); queueUnsubscribers = {};
                    allLoadedClasses = {};

                    const process = (snapshot) => {
                        snapshot.docChanges().forEach(change => {
                            const id = change.doc.id, data = { id, ...change.doc.data() };
                            if (change.type === 'removed') {
                                delete allLoadedClasses[id]; delete classQueues[id]; delete classRequests[id]; delete studentClassRequests[id]; // UPDATED: Clear student requests
                                if (queueUnsubscribers[id]) { queueUnsubscribers[id](); delete queueUnsubscribers[id]; }
                            } else {
                                allLoadedClasses[id] = data;
                                const isOwner = data.teacherId === uid;
                                const isCoTeacher = (data.teacherIds || []).includes(uid);
                                
                                // Hands Queue Listener (For Teachers/Co-Teachers)
                                if ((isOwner || isCoTeacher) && !queueUnsubscribers[`hands_${id}`]) {
                                    queueUnsubscribers[`hands_${id}`] = db.collection('classes').doc(id).collection('raisedHands')
                                        .onSnapshot(qSnap => {
                                            classQueues[id] = qSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                                            updateGlobalUI();
                                            if(currentClassId === id) renderMainContent();
                                        });
                                }
                                
                                // Teacher Request Listener (For Owner to manage all requests)
                                if((isOwner || isCoTeacher) && !queueUnsubscribers[`requests_${id}`]){
                                    queueUnsubscribers[`requests_${id}`] = db.collection('classes').doc(id).collection('coTeacherRequests')
                                        .onSnapshot(rSnap => {
                                            classRequests[id] = rSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                                            updateGlobalUI();
                                            if(currentClassId === id) renderMainContent();
                                        });
                                }

                                // NEW: Student's Own Request Listener (For any user to track their own requests)
                                if(!queueUnsubscribers[`myRequests_${id}`]){
                                    queueUnsubscribers[`myRequests_${id}`] = db.collection('classes').doc(id).collection('coTeacherRequests')
                                        .where('requesterId', '==', uid) // Filter by the current user ID
                                        .onSnapshot(rSnap => {
                                            studentClassRequests[id] = rSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                                            updateGlobalUI();
                                            if(currentClassId === id) renderMainContent();
                                        });
                                }
                            }
                        });
                        updateGlobalUI();
                    };
                    unsubscribes.push(db.collection('classes').where('teacherId', '==', uid).onSnapshot(process));
                    unsubscribes.push(db.collection('classes').where('studentIds', 'array-contains', uid).onSnapshot(process));
                    unsubscribes.push(db.collection('classes').where('teacherIds', 'array-contains', uid).onSnapshot(process));
                }
                
                function renderClassList(classes) {
                    document.getElementById('no-classes-sidebar').classList.toggle('hidden', classes.length > 0);
                    classListEl.innerHTML = '';
                    classes.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0)).forEach(cls => {
                        const li = document.createElement('li');
                        const isActive = currentClassId === cls.id;
                        const activeClasses = isActive ? 'bg-blue-100 text-blue-800 font-semibold' : 'text-gray-700 hover:bg-slate-100 hover:text-gray-900';
                        
                        // NEW: Get personal name (local storage)
                        const personalName = localStorage.getItem(`personal_class_name_${cls.id}_${currentUser.uid}`) || cls.name;

                        const handsCount = classQueues[cls.id]?.length || 0;
                        // Filter requests to only count pending ones for the badge
                        const reqCount = (classRequests[cls.id] || []).filter(req => req.status === 'pending').length;
                        let badge = '';
                        if(handsCount > 0 && reqCount > 0) badge = `<span class="class-notification-badge badge-multiple">${handsCount + reqCount}</span>`;
                        else if(handsCount > 0) badge = `<span class="class-notification-badge badge-hands">${handsCount}</span>`;
                        else if(reqCount > 0) badge = `<span class="class-notification-badge badge-requests">${reqCount}</span>`;

                        li.innerHTML = `<button data-class-id="${cls.id}" class="w-full text-left px-3 py-2.5 rounded-md font-medium text-sm transition-colors btn-bubbly relative flex justify-between items-center ${activeClasses}"><span>${escapeHtml(personalName)}</span>${badge}</button>`;
                        classListEl.appendChild(li);
                    });
                }
                
                async function selectClass(id) {
                    currentClassId = id; currentClassView = 'overview'; currentRoster = null;
                    if (id) await fetchRosterData(allLoadedClasses[id]);
                    renderMainContent();
                }

                async function fetchRosterData(data) {
                    if (!data) return;
                    const ids = [data.teacherId, ...(data.teacherIds || []), ...(data.studentIds || [])].filter(id => id);
                    if (ids.length === 0) { currentRoster = { owner: {}, coTeachers: [], students: [] }; return; }
                    
                    const userBatches = [];
                    for (let i = 0; i < ids.length; i += 10) {
                        userBatches.push(ids.slice(i, i + 10));
                    }

                    const users = {};
                    for(const batch of userBatches){
                        const docs = await db.collection('users').where(firebase.firestore.FieldPath.documentId(), 'in', batch).get();
                        docs.forEach(doc => { users[doc.id] = doc.data(); });
                    }

                    currentRoster = {
                        owner: { id: data.teacherId, ...users[data.teacherId] },
                        coTeachers: (data.teacherIds || []).map(id => ({ id, ...users[id] })),
                        students: (data.studentIds || []).map(id => ({ id, ...users[id] }))
                    };
                }

                // NEW: Schedule Helper Functions (existing)
                function isTimeInSchedule(enableAt, disableAt) {
                    if (!enableAt || !disableAt) return true; // No meaningful schedule set means always active

                    const now = new Date();
                    const currentMinutes = now.getHours() * 60 + now.getMinutes();

                    const [hE, mE] = enableAt.split(':').map(Number);
                    const [hD, mD] = disableAt.split(':').map(Number);

                    const enableMinutes = hE * 60 + mE;
                    const disableMinutes = hD * 60 + mD;

                    if (enableMinutes === disableMinutes) {
                        return true; // Enable and disable are the same time, treat as always enabled
                    }

                    if (enableMinutes < disableMinutes) {
                        // Simple case: 08:00 to 17:00 (no midnight wrap)
                        return currentMinutes >= enableMinutes && currentMinutes < disableMinutes;
                    } else {
                        // Wrap-around case: 22:00 to 02:00
                        // Time is in schedule if it's after enable OR before disable
                        return currentMinutes >= enableMinutes || currentMinutes < disableMinutes;
                    }
                }

                function getEffectiveHandRaisingStatus(cls, isOwner) {
                    const hasSchedule = cls.schedule?.enableAt && cls.schedule?.disableAt;
                    const dbEnabled = cls.handRaisingEnabled;

                    if (!hasSchedule) {
                        return { 
                            enabled: dbEnabled, 
                            override: false, 
                            message: dbEnabled ? '' : 'Manually Paused'
                        };
                    }
                    
                    const isScheduledTime = isTimeInSchedule(cls.schedule.enableAt, cls.schedule.disableAt);
                    let effectiveEnabled = isScheduledTime;
                    let override = false;
                    let message = '';

                    if (isScheduledTime) {
                        if (!dbEnabled) { // Scheduled ON, but DB is OFF -> Manual override to PAUSE
                            effectiveEnabled = false;
                            override = true;
                            message = isOwner ? 'Manually Paused (Override Schedule)' : 'Paused by Teacher (Override)';
                        } else {
                            // Effective ON, no override
                        }
                    } else { // Not scheduled time
                        effectiveEnabled = false;
                        message = 'Paused (Outside Schedule)';

                        if (dbEnabled) { // Scheduled OFF, but DB is ON -> Manual override to RESUME
                            effectiveEnabled = true;
                            override = true;
                            message = isOwner ? 'Manually Resumed (Override Schedule)' : 'Resumed by Teacher (Override)';
                        }
                    }

                    return { 
                        enabled: effectiveEnabled, 
                        override: override, 
                        message: message 
                    };
                }

                function renderMainContent() {
                    if (currentClassId && allLoadedClasses[currentClassId]) {
                        const data = allLoadedClasses[currentClassId];
                        const queue = classQueues[currentClassId] || [];
                        // Filter requests to only show pending ones on the requests tab (Teacher/Owner View)
                        const pendingRequests = (classRequests[currentClassId] || []).filter(req => req.status === 'pending'); 
                        
                        // NEW: Get the current user's requests for this class (Student View)
                        const currentStudentRequests = studentClassRequests[currentClassId] || [];

                        const isOwner = data.teacherId === userData.uid;
                        const isCoTeacher = (data.teacherIds || []).includes(userData.uid);
                        const isStudent = (data.studentIds || []).includes(userData.uid); // NEW: Identify student role

                        // Pass all necessary data to the classView template
                        mainContentArea.innerHTML = TPL.classView(data, userData, isOwner, isCoTeacher, isStudent, queue, pendingRequests, currentStudentRequests, currentClassView, currentRoster);
                        document.body.dispatchEvent(new CustomEvent('mainContentRendered'));
                    } else { mainContentArea.innerHTML = TPL.emptyState(userData); }
                }

                function showModal(html) { modalContainer.innerHTML = html; modalBackdrop.classList.remove('hidden'); const d = modalContainer.firstElementChild; d.classList.add('fade-enter-from'); setTimeout(() => d.classList.remove('fade-enter-from'), 10); }
                function hideModal() { const d=modalContainer.firstElementChild; if(d){d.classList.add('fade-leave-to');modalBackdrop.classList.add('fade-leave-to');setTimeout(() => {modalContainer.innerHTML='';modalBackdrop.classList.add('hidden');modalBackdrop.classList.remove('fade-leave-to');}, 200);}}
                function escapeHtml(text) { if(typeof text!=='string')return'';const d=document.createElement('div');d.textContent=text;return d.innerHTML; }
                
                async function createNewClass(name) { const code=Math.random().toString(36).substring(2,10).toUpperCase(); const coTeacherCode = 'T' + Math.random().toString(36).substring(2,9).toUpperCase(); await db.collection('classes').add({name,teacherId:currentUser.uid,teacherIds:[],code,coTeacherCode,studentIds:[],pendingStudentEmails:[],handRaisingEnabled:true,schedule:{enableAt:'',disableAt:''},scheduleLastActionDate:'',createdAt:FieldValue.serverTimestamp()});hideModal();}
                async function joinClass(code) {
                    const studentQuery = db.collection('classes').where('code', '==', code).limit(1).get();
                    const teacherQuery = db.collection('classes').where('coTeacherCode', '==', code).limit(1).get();
                    const [studentSnap, teacherSnap] = await Promise.all([studentQuery, teacherQuery]);
                    
                    if (teacherSnap.empty && studentSnap.empty) { showModal(TPL.messageModal('Error','Invalid class code.','red')); return; }
                    
                    if (!teacherSnap.empty) { // Co-teacher join
                        const classDoc = teacherSnap.docs[0];
                        const classData = classDoc.data();
                        if (userData.role !== 'teacher') { showModal(TPL.messageModal('Access Denied', 'Only users with a teacher account can join with this code.', 'red')); return; }
                        const isMember = classData.teacherId === currentUser.uid || (classData.teacherIds || []).includes(currentUser.uid);
                        if (isMember) { showModal(TPL.messageModal('Already Enrolled', `You are already a teacher in ${classData.name}.`, 'yellow')); return; }
                        hideModal();
                        showModal(TPL.requestCoTeacherModal(classDoc.id, classData.name));
                    } else { // Student join
                        const classDoc = studentSnap.docs[0];
                        const classData = classDoc.data();
                        const isMember = classData.teacherId === currentUser.uid || (classData.teacherIds || []).includes(currentUser.uid) || (classData.studentIds || []).includes(currentUser.uid);
                        if(isMember){ showModal(TPL.messageModal('Already Enrolled',`You are already a member of ${classData.name}.`,'yellow')); return; }
                        
                        // Any user type can join as a student with the student code
                        await db.collection('classes').doc(classDoc.id).update({studentIds:FieldValue.arrayUnion(currentUser.uid)});
                        hideModal();
                        showModal(TPL.messageModal('Success',`Successfully joined class: ${classData.name} as a student!`,'green'));
                    }
                }

                // NEW: Logic to find a recyclable request slot
                async function findRecyclableRequestSlot(classId) {
                    const recyclableSnap = await db.collection('classes').doc(classId).collection('coTeacherRequests')
                        .where('status', '==', 'recyclable')
                        .limit(1)
                        .get();
                    
                    if (!recyclableSnap.empty) {
                        return recyclableSnap.docs[0].id;
                    }
                    return currentUser.uid + '_' + Date.now(); // Default to a unique ID
                }

                // UPDATED: requestCoTeacher to use recyclable slot (original logic for modal)
                async function requestCoTeacher(classId, comment) {
                    const docId = await findRecyclableRequestSlot(classId); // Find or use a unique ID
                    
                    const requestData = {
                        requesterName: userData.username,
                        comment: comment,
                        status: 'pending',
                        requestedAt: FieldValue.serverTimestamp(),
                        requesterEmail: currentUser.email,
                        requesterId: currentUser.uid // Store actual requester ID
                    };

                    await db.collection('classes').doc(classId).collection('coTeacherRequests').doc(docId).set(requestData);
                    hideModal();
                    showModal(TPL.messageModal('Request Sent', 'Your request to join as a co-teacher has been sent to the class owner.', 'green'));
                }

                // UPDATED: handleCoTeacherRequest to use full fields (existing)
                async function handleCoTeacherRequest(classId, requestDocId, action) {
                    const requestRef = db.collection('classes').doc(classId).collection('coTeacherRequests').doc(requestDocId);
                    
                    const requestDoc = await requestRef.get();
                    if (!requestDoc.exists) return; // Should not happen

                    const requesterId = requestDoc.data().requesterId; // Get the actual requester ID

                    if(action === 'accept'){
                        await db.collection('classes').doc(classId).update({ teacherIds: FieldValue.arrayUnion(requesterId) });
                        await requestRef.update({ status: 'accepted' });
                    } else if (action === 'deny') {
                        await requestRef.update({ status: 'denied' });
                    } else if (action === 'comment-edit' || action === 'comment-delete') {
                         showModal(TPL.messageModal('Feature Update', 'Commenting on requests is a planned feature! This button is currently for demonstration.', 'yellow'));
                         return; // Placeholder for future comment logic
                    }
                    // For accept/deny, hide the modal and re-render the main content
                    hideModal();
                    renderMainContent(); 
                }
                
                async function raiseHand(id,q){await db.collection('classes').doc(id).collection('raisedHands').doc(currentUser.uid).set({studentName:userData.username,studentPhotoURL:currentUser.photoURL||'',question:q||'',raisedAt:FieldValue.serverTimestamp()});hideModal();}
                async function lowerHand(id,studentId=currentUser.uid){await db.collection('classes').doc(id).collection('raisedHands').doc(studentId).delete();}
                async function lowerAllHands(id){const s=await db.collection('classes').doc(id).collection('raisedHands').get();const b=db.batch();s.docs.forEach(d=>b.delete(d.ref));await b.commit();}
                
                // FIXED: toggleHandRaising (existing)
                async function toggleHandRaising(id, status, buttonEl) {
                    // Immediate UI update (NEW)
                    if (buttonEl) {
                        buttonEl.classList.toggle('bg-yellow-100', !status);
                        buttonEl.classList.toggle('text-yellow-600', !status);
                        buttonEl.classList.toggle('hover:bg-yellow-200', !status);
                        buttonEl.classList.toggle('bg-gray-200', status);
                        buttonEl.classList.toggle('text-gray-600', status);
                        buttonEl.classList.toggle('hover:bg-gray-300', status);
                        
                        const icon = buttonEl.querySelector('i');
                        if (icon) {
                            icon.classList.toggle('fa-hand', !status);
                            icon.classList.toggle('fa-hand-sparkles', status);
                        }
                        
                        const tooltip = buttonEl.closest('.tooltip-container').querySelector('.tooltip-text');
                        if (tooltip) {
                            tooltip.textContent = !status ? 'Pause Raising' : 'Resume Raising';
                        }
                    }
                    // DB update
                    await db.collection('classes').doc(id).update({ handRaisingEnabled: !status });
                    // onSnapshot listener will handle the full re-render and UI changes eventually.
                }
                
                async function handleChangeClassName(id,name){const today=new Date().toISOString().split('T')[0];const key=`classNameChanges_${id}`;let changes;try{changes=JSON.parse(localStorage.getItem(key))||{};}catch(e){changes={};}if(changes.date!==today){changes={date:today,count:0};}if(changes.count>=3){showModal(TPL.messageModal('Limit Reached','You can only change the class name 3 times per day.','red'));return;}await db.collection('classes').doc(id).update({name});changes.count++;localStorage.setItem(key,JSON.stringify(changes));showModal(TPL.messageModal('Success','Class name updated!','green'));}
                
                // FIXED: handleSaveSchedule (existing)
                async function handleSaveSchedule(id,enable,disable){
                    await db.collection('classes').doc(id).update({
                        schedule:{enableAt:enable,disableAt:disable},
                        scheduleLastActionDate: ''
                    });
                    showModal(TPL.messageModal('Success','Schedule saved!','green'));
                }

                // FIXED: deleteSchedule (existing)
                async function deleteSchedule(id) { 
                    await db.collection('classes').doc(id).update({ 'schedule.enableAt': '', 'schedule.disableAt': '' }); 
                    
                    // NEW: Clear the text boxes
                    const enableInput = document.getElementById('enable-time-input');
                    const disableInput = document.getElementById('disable-time-input');

                    if (enableInput) {
                        enableInput.value = '';
                        enableInput.dataset.time24hr = '';
                        enableInput.dataset.digits = '';
                        const periodBtns = enableInput.closest('.schedule-time-input-container').querySelectorAll('.period-btn');
                        periodBtns.forEach(btn => btn.classList.remove('active'));
                    }

                    if (disableInput) {
                        disableInput.value = '';
                        disableInput.dataset.time24hr = '';
                        disableInput.dataset.digits = '';
                        const periodBtns = disableInput.closest('.schedule-time-input-container').querySelectorAll('.period-btn');
                        periodBtns.forEach(btn => btn.classList.remove('active'));
                    }

                    showModal(TPL.messageModal('Success', 'Schedule has been removed.', 'green')); 
                }
                async function removeUserFromClass(id, userId) { const data = allLoadedClasses[id]; if ((data.teacherIds || []).includes(userId)) { await db.collection('classes').doc(id).update({ teacherIds: FieldValue.arrayRemove(userId) }); } else if ((data.studentIds || []).includes(userId)) { await db.collection('classes').doc(id).update({ studentIds: FieldValue.arrayRemove(userId) }); } await fetchRosterData(allLoadedClasses[id]); renderMainContent(); }
                async function handleDeleteClass(id){const s=await db.collection('classes').doc(id).collection('raisedHands').get();const b=db.batch();s.docs.forEach(d=>b.delete(d.ref));b.delete(db.collection('classes').doc(id));await b.commit();hideModal();selectClass(null);}
                
                // NEW: Student Setting Logic
                function checkStudentRequestRateLimit(classId) {
                    const key = `request_limits_${classId}_${currentUser.uid}`;
                    let records;
                    try {
                        records = JSON.parse(localStorage.getItem(key)) || [];
                    } catch (e) {
                        records = [];
                    }

                    const now = Date.now();
                    // Filter out records older than 1 minute (60,000 milliseconds)
                    const recentRecords = records.filter(timestamp => now - timestamp < 60000);

                    if (recentRecords.length >= REQUEST_LIMIT_PER_MINUTE) {
                        // Calculate remaining time for user feedback
                        const timeElapsed = now - recentRecords[0];
                        const remainingTime = Math.ceil((60000 - timeElapsed) / 1000); // in seconds
                        return { allowed: false, remainingTime };
                    }

                    return { allowed: true, recentRecords, key };
                }

                async function studentSendRequest(classId, comment) {
                    const rateLimitCheck = checkStudentRequestRateLimit(classId);

                    if (!rateLimitCheck.allowed) {
                        showModal(TPL.messageModal('Rate Limit Exceeded', `You can only send ${REQUEST_LIMIT_PER_MINUTE} requests per minute. Try again in ${rateLimitCheck.remainingTime} seconds.`, 'red'));
                        return;
                    }

                    const docId = await findRecyclableRequestSlot(classId); // Reusing co-teacher request mechanism
                    
                    const requestData = {
                        requesterName: userData.username,
                        comment: comment,
                        status: 'pending',
                        requestedAt: FieldValue.serverTimestamp(),
                        requesterEmail: currentUser.email,
                        requesterId: currentUser.uid // Store actual requester ID
                    };

                    await db.collection('classes').doc(classId).collection('coTeacherRequests').doc(docId).set(requestData);
                    
                    // Apply local rate limit
                    const now = Date.now();
                    rateLimitCheck.recentRecords.push(now);
                    localStorage.setItem(rateLimitCheck.key, JSON.stringify(rateLimitCheck.recentRecords));

                    hideModal();
                    showModal(TPL.messageModal('Request Sent', 'Your request has been sent to the class owner.', 'green'));
                }

                async function handleStudentRenameClass(classId, newName) {
                    // Store personal class name locally
                    const key = `personal_class_name_${classId}_${currentUser.uid}`;
                    localStorage.setItem(key, newName);
                    hideModal();
                    // Update sidebar display immediately
                    renderClassList(Object.values(allLoadedClasses)); 
                    showModal(TPL.messageModal('Success', `Personal name set to: ${escapeHtml(newName)}`, 'green'));
                }

                async function handleStudentLeaveClass(classId) {
                    await db.collection('classes').doc(classId).update({
                        studentIds: FieldValue.arrayRemove(currentUser.uid)
                    });
                    // Remove local data
                    localStorage.removeItem(`personal_class_name_${classId}_${currentUser.uid}`);
                    hideModal();
                    // The listener will remove the class from allLoadedClasses.
                    selectClass(null); // Deselect class and trigger full re-render
                    showModal(TPL.messageModal('Success', 'You have successfully left the class.', 'green'));
                }


                let scheduleInterval = null;
                function initializeScheduleChecker() {
                    if (scheduleInterval) clearInterval(scheduleInterval);
                    scheduleInterval = setInterval(() => {
                        const now = new Date();
                        const todayStr = now.toISOString().split('T')[0];
                        if (!userData || userData.role !== 'teacher') return;
                        for (const classId in allLoadedClasses) {
                            const cls = allLoadedClasses[classId];
                            if (cls.teacherId === userData.uid) { // Only the owner handles auto-disabling
                                if (cls.schedule?.disableAt) {
                                    // Check for auto-disable logic (using DB handRaisingEnabled as the override state)
                                    const effectiveStatus = getEffectiveHandRaisingStatus(cls, true);
                                    // If scheduled time is over (effective status is disabled), and the teacher has not overridden it
                                    // and the DB still says it's enabled (meaning it hasn't been auto-disabled today yet).
                                    if (!effectiveStatus.enabled && !effectiveStatus.override && cls.handRaisingEnabled && cls.scheduleLastActionDate !== todayStr) {
                                        console.log(`Auto-disabling for ${cls.name} due to schedule end.`);
                                        // Set the DB to disabled and record the date to prevent further action today
                                        db.collection('classes').doc(classId).update({ scheduleLastActionDate: todayStr, handRaisingEnabled: false });
                                        lowerAllHands(classId); // Lower hands when auto-disabling
                                    }
                                }
                            }
                        }
                    }, 60000); // Check every minute
                }

                // NEW: Request Recycler Logic (existing)
                let recyclerInterval = null;
                function initializeRequestRecycler() {
                    if (recyclerInterval) clearInterval(recyclerInterval);
                    recyclerInterval = setInterval(() => {
                        if (!userData || userData.role !== 'teacher') return;
                        const twentyFourHoursAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
                        for (const classId in allLoadedClasses) {
                            const cls = allLoadedClasses[classId];
                            if (cls.teacherId === userData.uid) { // Only the owner recycles requests
                                recycleOldRequests(classId, twentyFourHoursAgo);
                            }
                        }
                    }, 5 * 60 * 1000); // Check every 5 minutes
                } 
                async function recycleOldRequests(classId, cutoffDate) {
                    const oldRequestsSnap = await db.collection('classes').doc(classId).collection('coTeacherRequests')
                        .where('status', 'in', ['accepted', 'denied']) // Only recycle closed requests
                        .get();
                    const batch = db.batch();
                    let recycledCount = 0;
                    oldRequestsSnap.docs.forEach(doc => {
                        const data = doc.data();
                        // Check if the request is older than 1 day
                        if (data.requestedAt && data.requestedAt.toDate() < cutoffDate) {
                            const ref = doc.ref;
                            batch.update(ref, { 
                                status: 'recyclable', 
                                requesterName: null, 
                                comment: null, 
                                requestedAt: null, 
                                requesterEmail: null, 
                                requesterId: null 
                            });
                            recycledCount++;
                        }
                    });
                    if (recycledCount > 0) {
                        await batch.commit();
                        console.log(`Recycled ${recycledCount} old co-teacher requests for class ${classId}.`);
                    }
                }
                let gapiLoaded=false,googleAuth=null; const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/classroom/v1/rest'; const SCOPES = 'https://www.googleapis.com/auth/classroom.courses.readonly https://www.googleapis.com/auth/classroom.rosters.readonly'; async function initializeGAPI(apiKey,clientId){if(gapiLoaded)return Promise.resolve();return new Promise((resolve,reject)=>{const checkGAPI=()=>{if(typeof gapi!=='undefined'&&gapi.load){gapi.load('client',async()=>{try{await gapi.client.init({apiKey,discoveryDocs:[DISCOVERY_DOC]});googleAuth=google.accounts.oauth2.initTokenClient({client_id:clientId,scope:SCOPES,callback:''});gapiLoaded=true;resolve();}catch(e){reject(e);}});}else{setTimeout(checkGAPI,100);}};checkGAPI();});} function requestAccessToken(){return new Promise((resolve,reject)=>{try{googleAuth.callback=async(res)=>{if(res.error)return reject(new Error(res.error));gapi.client.setToken({access_token:res.access_token});try{await listGoogleCourses();resolve();}catch(e){reject(e);}};}catch(e){reject(e);}});} async function handleGoogleImportClick(){showModal(TPL.googleImportModal());const loadingEl=document.getElementById('g-import-loading');const errorEl=document.getElementById('g-import-error');loadingEl.classList.remove('hidden');errorEl.classList.add('hidden');try{const secretsDoc=await db.collection('secrets').doc('wUTBTbjuNLueOFhgHXEE').get();if(!secretsDoc.exists)throw new Error("Secrets document not found.");const{GoogleClassroomAPIKey:apiKey,GoogleClientID:clientId}=secretsDoc.data();if(!apiKey||!clientId)throw new Error("Missing API Key or Client ID in secrets document.");await initializeGAPI(apiKey,clientId);await requestAccessToken();}catch(e){console.error('Google Classroom init error:',e);loadingEl.classList.add('hidden');errorEl.textContent=`Error: ${e.message}`;errorEl.classList.remove('hidden');}} async function listGoogleCourses(){const listEl=document.getElementById('g-import-list');const loadingEl=document.getElementById('g-import-loading');const errorEl=document.getElementById('g-import-error');const noneEl=document.getElementById('g-import-none');listEl.innerHTML='';loadingEl.classList.remove('hidden');errorEl.classList.add('hidden');noneEl.classList.add('hidden');try{const res=await gapi.client.classroom.courses.list({teacherId:'me'});const courses=res.result.courses||[];loadingEl.classList.add('hidden');if(courses.length===0){noneEl.classList.remove('hidden');return;}courses.forEach(course=>{const item=document.createElement('div');item.className='p-4 border rounded-lg flex items-center justify-between hover:bg-gray-50';item.innerHTML=`<div class="flex-1 min-w-0"><p class="text-lg font-semibold truncate">${escapeHtml(course.name)}</p><p class="text-sm text-gray-500 truncate">Section: ${escapeHtml(course.section||'N/A')}</p></div><button data-course-id="${course.id}" data-course-name="${escapeHtml(course.name)}" class="g-import-course-btn ml-4 bg-green-500 text-white font-medium py-2 px-4 rounded-lg hover:bg-green-600 transition-colors btn-bubbly">Import</button>`;listEl.appendChild(item);});}catch(e){console.error('Google Classroom API error:',e);loadingEl.classList.add('hidden');errorEl.textContent=`API Error: ${e.message}`;errorEl.classList.remove('hidden');}} async function importGoogleCourse(googleCourseId,notifyClassName){showModal(TPL.messageModal('Importing','Please wait while your class is imported. This may take a moment...','blue'));try{const rosterRes=await gapi.client.classroom.courses.students.list({courseId:googleCourseId});const students=rosterRes.result.students||[];const studentEmails=students.map(s=>s.profile.emailAddress);const code=Math.random().toString(36).substring(2,10).toUpperCase();const coTeacherCode = 'T' + Math.random().toString(36).substring(2,9).toUpperCase();await db.collection('classes').add({name:notifyClassName,teacherId:currentUser.uid,teacherIds:[],code,coTeacherCode,studentIds:[],pendingStudentEmails:studentEmails,handRaisingEnabled:true,schedule:{enableAt:'',disableAt:''},scheduleLastActionDate:'',createdAt:FieldValue.serverTimestamp()});showModal(TPL.messageModal('Success',`Class "${notifyClassName}" imported successfully! The students will be enrolled automatically. The enrollment code is: <strong>${code}</strong>`,'green'));}catch(e){console.error('Import error:',e);showModal(TPL.messageModal('Error',`Failed to import class: ${e.message}`,'red'));}}

                // --- TEMPLATE DEFINITIONS (TPL) ---
                const TPL = {
                    // Utility
                    messageModal: (title, message, color = 'blue') => `<div class="bg-white rounded-xl p-6 w-full max-w-sm pointer-events-auto shadow-2xl fade-enter-active" role="dialog" aria-modal="true"><h3 class="text-lg font-bold font-poppins ${color === 'red' ? 'text-red-600' : color === 'green' ? 'text-green-600' : 'text-blue-600'} mb-4">${title}</h3><p class="text-gray-700 mb-4">${message}</p><div class="flex justify-end"><button onclick="hideModal()" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors btn-bubbly">Close</button></div></div>`,
                    emptyState: (userData) => `<div class="p-10 text-center bg-white rounded-xl shadow"><i class="fa-solid fa-graduation-cap text-6xl text-blue-300 mb-4"></i><h2 class="text-2xl font-bold font-poppins text-gray-800 mb-2">Welcome, ${escapeHtml(userData.username)}!</h2><p class="text-gray-600 mb-6">It looks like you haven't joined or created any classes yet.</p><div class="space-x-4">${userData.role === 'teacher' ? `<button id="new-class-btn-empty" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors btn-bubbly"><i class="fa-solid fa-plus mr-2"></i> Create New Class</button>` : ''}<button id="join-class-btn-empty" class="bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors btn-bubbly"><i class="fa-solid fa-user-plus mr-2"></i> Join Class</button></div>${userData.role === 'teacher' ? `<button id="g-import-btn" class="mt-4 text-blue-600 hover:text-blue-800 text-sm font-medium transition-colors"><i class="fa-brands fa-google mr-1"></i> Import from Google Classroom</button>` : ''}</div>`,

                    // Modals
                    newClassModal: () => `<div class="bg-white rounded-xl p-6 w-full max-w-lg pointer-events-auto shadow-2xl fade-enter-active" role="dialog" aria-modal="true"><h3 class="text-xl font-bold font-poppins text-blue-600 mb-4">Create New Class</h3><input type="text" id="new-class-name-input" class="app-input w-full mb-6" placeholder="Enter Class Name (e.g., Algebra 1 - Period 3)" maxlength="50"><div class="flex justify-end space-x-3"><button onclick="hideModal()" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors btn-bubbly">Cancel</button><button id="create-class-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors btn-bubbly">Create Class</button></div></div>`,
                    joinClassModal: () => `<div class="bg-white rounded-xl p-6 w-full max-w-lg pointer-events-auto shadow-2xl fade-enter-active" role="dialog" aria-modal="true"><h3 class="text-xl font-bold font-poppins text-green-600 mb-4">Join Class</h3><p class="text-sm text-gray-600 mb-4">Enter the 8-digit **student** class code to join as a student, or the 9-character **co-teacher** code to send a request to join as a co-teacher.</p><input type="text" id="join-class-code-input" class="app-input w-full mb-6 uppercase" placeholder="Enter Class Code" maxlength="9"><div class="flex justify-end space-x-3"><button onclick="hideModal()" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors btn-bubbly">Cancel</button><button id="submit-join-class-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors btn-bubbly">Join Class</button></div></div>`,
                    requestCoTeacherModal: (classId, className) => `<div class="bg-white rounded-xl p-6 w-full max-w-lg pointer-events-auto shadow-2xl fade-enter-active" role="dialog" aria-modal="true"><h3 class="text-xl font-bold font-poppins text-blue-600 mb-4">Request Co-Teacher Access</h3><p class="text-gray-700 mb-4">You are requesting co-teacher access for class: **${escapeHtml(className)}**.</p><p class="text-sm text-gray-600 mb-4">Please include a brief message to the class owner:</p><textarea id="co-teacher-request-comment" class="app-input w-full resize-none mb-6" rows="3" placeholder="I would like to help manage the hands queue for this class."></textarea><div class="flex justify-end space-x-3"><button onclick="hideModal()" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors btn-bubbly">Cancel</button><button id="send-co-teacher-request-btn" data-class-id="${classId}" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors btn-bubbly">Send Request</button></div></div>`,
                    googleImportModal: () => `
                        <div class="bg-white rounded-xl p-6 w-full max-w-xl pointer-events-auto shadow-2xl fade-enter-active" role="dialog" aria-modal="true">
                            <h3 class="text-xl font-bold font-poppins text-blue-600 mb-4 flex items-center"><i class="fa-brands fa-google mr-2"></i> Import Google Classroom</h3>
                            <p class="text-gray-700 mb-4">Select the Google Classroom course you wish to import. This will create a new Notify class and automatically enroll your students.</p>
                            
                            <div id="g-import-loading" class="flex items-center justify-center p-8 text-blue-600 hidden">
                                <i class="fa-solid fa-spinner fa-spin mr-3"></i> Loading Google Courses...
                            </div>
                            <div id="g-import-error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative hidden mb-4"></div>
                            <div id="g-import-none" class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded relative hidden mb-4">No Google Classroom courses found.</div>

                            <div id="g-import-list" class="space-y-3 max-h-80 overflow-y-auto custom-scrollbar mb-6">
                                <div class="p-4 text-gray-500 text-sm">Please authorize the connection to see your courses.</div>
                            </div>
                            
                            <div class="flex justify-end space-x-3">
                                <button onclick="hideModal()" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors btn-bubbly">Close</button>
                            </div>
                        </div>
                    `,
                    importConfirmationModal: (googleCourseId, googleCourseName) => `
                        <div class="bg-white rounded-xl p-6 w-full max-w-md pointer-events-auto shadow-2xl fade-enter-active" role="dialog" aria-modal="true">
                            <h3 class="text-xl font-bold font-poppins text-green-600 mb-4">Confirm Import</h3>
                            <p class="text-gray-700 mb-4">You are about to import the Google Classroom course:</p>
                            <p class="text-lg font-semibold text-gray-800 mb-4">**${escapeHtml(googleCourseName)}**</p>
                            <p class="text-gray-700 mb-2">Enter a name for the new Notify class:</p>
                            <input type="text" id="import-class-name-input" class="app-input w-full mb-6" placeholder="${escapeHtml(googleCourseName)}" value="${escapeHtml(googleCourseName)}" maxlength="50">
                            <div class="flex justify-end space-x-3">
                                <button onclick="handleGoogleImportClick()" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors btn-bubbly">Back</button>
                                <button id="confirm-import-btn" data-google-id="${googleCourseId}" data-default-name="${escapeHtml(googleCourseName)}" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors btn-bubbly">Import Now</button>
                            </div>
                        </div>
                    `,

                    // Class Views
                    overview: (cls, isOwner, isCoTeacher, isStudent, queue) => {
                        const { enabled, override, message } = getEffectiveHandRaisingStatus(cls, isOwner);
                        const isTeacherRole = isOwner || isCoTeacher;
                        
                        // Hand raising card content
                        let handCard = '';
                        if (isTeacherRole) {
                            handCard = `
                                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-600">
                                    <div class="flex justify-between items-center mb-4">
                                        <h3 class="text-xl font-semibold font-poppins text-gray-800">Hand Raising Status</h3>
                                        ${isOwner ? `
                                            <div class="tooltip-container">
                                                <button id="toggle-hand-raising-btn" data-status="${enabled}" class="tooltip-button ${enabled ? 'bg-yellow-100 text-yellow-600 hover:bg-yellow-200' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}">
                                                    <i class="fa-solid ${enabled ? 'fa-hand' : 'fa-hand-sparkles'}"></i>
                                                </button>
                                                <span class="tooltip-text">${enabled ? 'Pause Raising' : 'Resume Raising'}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <div class="w-12 h-12 rounded-full flex items-center justify-center ${enabled ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'} text-2xl">
                                            <i class="fa-solid ${enabled ? 'fa-check' : 'fa-xmark'}"></i>
                                        </div>
                                        <div>
                                            <p class="text-2xl font-bold font-poppins text-gray-900">${enabled ? 'Active' : 'Paused'}</p>
                                            <p class="text-sm text-gray-500">${message || (enabled ? 'Students can currently raise their hands.' : 'Hand raising is currently paused.')}</p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else if (isStudent) {
                            // Student view: card shows current queue position or button to raise hand
                            let studentInQueue = queue.find(q => q.id === currentUser.uid);
                            handCard = `
                                <div class="bg-white p-6 rounded-xl shadow-lg hand-status-card border-t-4 ${enabled ? 'border-blue-600' : 'border-red-600'}">
                                    <h3 class="text-xl font-semibold font-poppins text-gray-800 mb-4">Your Hand Status</h3>
                                    ${!enabled && !studentInQueue ? `
                                        <div class="text-center p-4 bg-red-50 rounded-lg text-red-700 font-medium">
                                            <i class="fa-solid fa-lock mr-2"></i> Hand raising is currently **Paused**.
                                            <p class="text-xs mt-1 text-red-500">${message}</p>
                                        </div>
                                    ` : studentInQueue ? `
                                        <div class="text-center p-4 bg-yellow-50 rounded-lg text-yellow-700">
                                            <i class="fa-solid fa-clock-rotate-left mr-2"></i> Your hand is **Raised**.
                                            <p class="text-4xl font-extrabold font-poppins mt-2">${queue.findIndex(q => q.id === currentUser.uid) + 1}</p>
                                            <p class="text-sm font-medium">Position in Queue</p>
                                            ${studentInQueue.question ? `<p class="mt-3 text-xs italic text-gray-600">Note: ${escapeHtml(studentInQueue.question)}</p>` : ''}
                                        </div>
                                        <button data-class-id="${cls.id}" id="lower-hand-btn" class="w-full mt-4 bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors raise-hand-btn">Lower Hand</button>
                                    ` : `
                                        <button data-class-id="${cls.id}" id="raise-hand-btn" class="w-full bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors raise-hand-btn">Raise Hand Now</button>
                                    `}
                                </div>
                            `;
                        }

                        // Class Info card content
                        const classInfoCard = `
                            <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-gray-600">
                                <h3 class="text-xl font-semibold font-poppins text-gray-800 mb-4">Class Details</h3>
                                <dl class="divide-y divide-gray-100">
                                    <div class="py-3 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
                                        <dt class="text-sm font-medium leading-6 text-gray-500">Official Name</dt>
                                        <dd class="mt-1 text-sm leading-6 text-gray-800 sm:col-span-2 sm:mt-0">${escapeHtml(cls.name)}</dd>
                                    </div>
                                    <div class="py-3 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
                                        <dt class="text-sm font-medium leading-6 text-gray-500">Owner</dt>
                                        <dd class="mt-1 text-sm leading-6 text-gray-800 sm:col-span-2 sm:mt-0">${escapeHtml(currentRoster.owner.username)}</dd>
                                    </div>
                                    <div class="py-3 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
                                        <dt class="text-sm font-medium leading-6 text-gray-500">Student Code</dt>
                                        <dd class="mt-1 text-sm leading-6 text-gray-800 sm:col-span-2 sm:mt-0 font-mono">${escapeHtml(cls.code)}</dd>
                                    </div>
                                    <div class="py-3 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
                                        <dt class="text-sm font-medium leading-6 text-gray-500">Co-Teacher Code</dt>
                                        <dd class="mt-1 text-sm leading-6 text-gray-800 sm:col-span-2 sm:mt-0 font-mono">${isTeacherRole ? escapeHtml(cls.coTeacherCode) : 'Hidden'}</dd>
                                    </div>
                                    ${cls.schedule?.enableAt ? `
                                        <div class="py-3 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
                                            <dt class="text-sm font-medium leading-6 text-gray-500">Schedule</dt>
                                            <dd class="mt-1 text-sm leading-6 text-gray-800 sm:col-span-2 sm:mt-0">
                                                <span class="font-semibold">${cls.schedule.enableAt}</span> to <span class="font-semibold">${cls.schedule.disableAt}</span>
                                            </dd>
                                        </div>
                                    ` : ''}
                                </dl>
                            </div>
                        `;

                        return `
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
                                <div class="lg:col-span-2 space-y-6">
                                    ${handCard}
                                    </div>
                                <div class="lg:col-span-1 space-y-6">
                                    ${classInfoCard}
                                </div>
                            </div>
                        `;
                    },
                    
                    handsQueue: (cls, userData, queue, isTeacherRole) => {
                        if (!isTeacherRole) return `<div class="p-10 text-center bg-white rounded-xl shadow text-gray-500">Only teachers and co-teachers can view the hands queue.</div>`;
                        
                        const queueList = queue.map((hand, index) => `
                            <div class="flex items-center justify-between p-4 bg-white rounded-xl shadow-sm border border-gray-200">
                                <div class="flex items-center space-x-4">
                                    <span class="text-xl font-bold font-poppins text-blue-600 w-8 text-center">${index + 1}</span>
                                    <img class="w-10 h-10 rounded-full object-cover" src="${hand.studentPhotoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(hand.studentName)}&background=random&color=fff&size=40`}" alt="${hand.studentName}">
                                    <div>
                                        <p class="text-lg font-semibold text-gray-900">${escapeHtml(hand.studentName)}</p>
                                        ${hand.question ? `<p class="text-sm text-gray-600 italic mt-1 max-w-lg truncate">${escapeHtml(hand.question)}</p>` : `<p class="text-sm text-gray-400 italic">No question provided</p>`}
                                        <p class="text-xs text-gray-400 mt-1">${hand.raisedAt ? new Date(hand.raisedAt.seconds * 1000).toLocaleTimeString() : 'N/A'}</p>
                                    </div>
                                </div>
                                <div class="flex space-x-2 flex-shrink-0">
                                    <button data-student-id="${hand.id}" id="lower-hand-teacher-btn" class="bg-red-500 text-white font-medium py-2 px-4 rounded-lg hover:bg-red-600 transition-colors btn-bubbly text-sm">Dismiss</button>
                                </div>
                            </div>
                        `).join('');

                        return `
                            <div class="space-y-6">
                                <div class="flex justify-between items-center">
                                    <h2 class="text-3xl font-bold font-poppins text-gray-900">Hands Queue (${queue.length})</h2>
                                    ${queue.length > 0 ? `<button id="lower-all-hands-btn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors btn-bubbly text-sm"><i class="fa-solid fa-hand-fist mr-2"></i> Lower All Hands</button>` : ''}
                                </div>
                                
                                <div class="space-y-4">
                                    ${queue.length === 0 ? `<div class="p-10 text-center bg-white rounded-xl shadow text-gray-500"><i class="fa-solid fa-check-circle text-4xl text-green-400 mb-2"></i><p>The queue is clear! No hands are raised.</p></div>` : queueList}
                                </div>
                            </div>
                        `;
                    },

                    coTeacherRequestsView: (cls, pendingRequests, currentRoster) => {
                        const allRequests = classRequests[cls.id] || [];
                        const teacherRole = currentRoster.owner.id === currentUser.uid ? 'Owner' : 'Co-Teacher'; // Distinguish owner from co-teacher view

                        // Sort all requests by status (Pending first) and then by time (newest first)
                        const sortedRequests = allRequests.sort((a, b) => {
                            const statusOrder = { 'pending': 1, 'accepted': 2, 'denied': 3, 'recyclable': 4 };
                            if (statusOrder[a.status] !== statusOrder[b.status]) {
                                return statusOrder[a.status] - statusOrder[b.status];
                            }
                            // Sort by time within the same status
                            const aTime = a.requestedAt?.seconds || 0;
                            const bTime = b.requestedAt?.seconds || 0;
                            return bTime - aTime;
                        });

                        const requestCards = sortedRequests.map(req => {
                            const statusColor = {
                                'pending': 'bg-yellow-100 text-yellow-800 border-yellow-300',
                                'accepted': 'bg-green-100 text-green-800 border-green-300',
                                'denied': 'bg-red-100 text-red-800 border-red-300',
                                'recyclable': 'bg-gray-200 text-gray-600 border-gray-400'
                            };

                            let actions = '';
                            if (req.status === 'pending' && teacherRole === 'Owner') {
                                actions = `
                                    <div class="request-action-group">
                                        <button data-doc-id="${req.id}" id="accept-co-teacher-request-btn" class="bg-green-500 text-white hover:bg-green-600 rounded-lg btn-bubbly">Accept</button>
                                        <button data-doc-id="${req.id}" id="deny-co-teacher-request-btn" class="bg-red-500 text-white hover:bg-red-600 rounded-lg btn-bubbly">Deny</button>
                                    </div>
                                `;
                            } else if (req.status === 'pending' && teacherRole === 'Co-Teacher') {
                                actions = `<div class="text-sm text-gray-500 italic w-20 text-center">Owner only</div>`;
                            } else if (req.status === 'recyclable') {
                                actions = `<div class="text-xs text-gray-500 w-20 text-center">Recyclable slot</div>`;
                            } else {
                                actions = `
                                    <div class="comment-split-btn">
                                        <button data-doc-id="${req.id}" data-action="comment-edit" id="request-comment-btn" class="bg-gray-200 text-gray-700 hover:bg-gray-300 btn-bubbly">Comment</button>
                                        <button data-doc-id="${req.id}" data-action="comment-delete" id="request-comment-btn" class="bg-gray-200 text-gray-700 hover:bg-gray-300 btn-bubbly">Delete</button>
                                    </div>
                                `;
                            }

                            return `
                                <div class="flex items-center justify-between p-4 bg-white rounded-xl shadow-sm border ${req.status === 'pending' ? 'border-yellow-400 shadow-lg' : 'border-gray-200'}">
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center mb-2 space-x-3">
                                            <p class="text-lg font-semibold text-gray-900 truncate">${escapeHtml(req.requesterName || 'N/A')}</p>
                                            <span class="text-xs font-semibold px-3 py-1 rounded-full border ${statusColor[req.status] || 'bg-gray-200 text-gray-800'}">
                                                ${req.status.charAt(0).toUpperCase() + req.status.slice(1)}
                                            </span>
                                        </div>
                                        <p class="text-sm text-gray-600 italic max-w-2xl">${escapeHtml(req.comment || 'No comment provided.')}</p>
                                        <p class="text-xs text-gray-400 mt-2">${req.requesterEmail || 'No Email'}</p>
                                        <p class="text-xs text-gray-400">Requested: ${req.requestedAt ? new Date(req.requestedAt.seconds * 1000).toLocaleString() : 'N/A'}</p>
                                    </div>
                                    <div class="flex-shrink-0 ml-4">${actions}</div>
                                </div>
                            `;
                        }).join('');

                        return `
                            <div class="space-y-6">
                                <h2 class="text-3xl font-bold font-poppins text-gray-900 border-b pb-4">Co-Teacher Requests (${pendingRequests.length} Pending)</h2>
                                <div class="space-y-4">
                                    ${allRequests.length === 0 ? `<div class="p-10 text-center bg-white rounded-xl shadow text-gray-500"><i class="fa-solid fa-envelope-open-text text-4xl text-gray-400 mb-2"></i><p>There are no recorded co-teacher requests for this class.</p></div>` : requestCards}
                                </div>
                            </div>
                        `;
                    },

                    rosterCard: (user, role, classId, isOwner) => `
                        <li class="flex items-center justify-between p-4 bg-white rounded-xl shadow-sm border border-gray-200">
                            <div class="flex items-center space-x-4">
                                <img class="w-10 h-10 rounded-full object-cover" src="${user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.username)}&background=random&color=fff&size=40`}" alt="${user.username}">
                                <div>
                                    <p class="text-lg font-semibold text-gray-900">${escapeHtml(user.username)}</p>
                                    <p class="text-sm text-gray-500">${escapeHtml(user.email)}</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <span class="text-xs font-semibold px-3 py-1 rounded-full ${role === 'Owner' ? 'bg-indigo-100 text-indigo-800' : role === 'Co-Teacher' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}">${role}</span>
                                ${(isOwner && user.id !== currentUser.uid && role !== 'Owner') ? `
                                    <button data-user-id="${user.id}" id="remove-user-btn" class="bg-red-500 text-white font-medium py-1.5 px-3 rounded-lg hover:bg-red-600 transition-colors btn-bubbly text-xs">Remove</button>
                                ` : ''}
                            </div>
                        </li>
                    `,
                    
                    rosterView: (cls, userData, currentRoster) => {
                        const isOwner = cls.teacherId === userData.uid;
                        if (!currentRoster) return `<div class="p-10 text-center bg-white rounded-xl shadow text-gray-500">Loading roster data...</div>`;

                        const ownerList = TPL.rosterCard(currentRoster.owner, 'Owner', cls.id, isOwner);
                        const coTeachersList = currentRoster.coTeachers.map(u => TPL.rosterCard(u, 'Co-Teacher', cls.id, isOwner)).join('');
                        const studentsList = currentRoster.students.map(u => TPL.rosterCard(u, 'Student', cls.id, isOwner)).join('');

                        return `
                            <div class="space-y-8">
                                <h2 class="text-3xl font-bold font-poppins text-gray-900 border-b pb-4">Class Roster</h2>

                                <div class="space-y-4">
                                    <h3 class="text-xl font-semibold font-poppins text-gray-800 flex items-center"><i class="fa-solid fa-user-tie mr-2 text-indigo-600"></i> Owner</h3>
                                    <ul class="space-y-3">${ownerList}</ul>
                                </div>

                                <div class="space-y-4">
                                    <h3 class="text-xl font-semibold font-poppins text-gray-800 flex items-center"><i class="fa-solid fa-user-tag mr-2 text-blue-600"></i> Co-Teachers (${currentRoster.coTeachers.length})</h3>
                                    <ul class="space-y-3">
                                        ${currentRoster.coTeachers.length > 0 ? coTeachersList : '<li class="text-gray-500 p-4 bg-white rounded-xl shadow-sm border border-gray-200">No co-teachers assigned yet.</li>'}
                                    </ul>
                                </div>

                                <div class="space-y-4">
                                    <h3 class="text-xl font-semibold font-poppins text-gray-800 flex items-center"><i class="fa-solid fa-user-graduate mr-2 text-gray-600"></i> Students (${currentRoster.students.length})</h3>
                                    <ul class="space-y-3">
                                        ${currentRoster.students.length > 0 ? studentsList : '<li class="text-gray-500 p-4 bg-white rounded-xl shadow-sm border border-gray-200">No students enrolled yet.</li>'}
                                    </ul>
                                </div>
                            </div>
                        `;
                    },

                    settingsScheduleTab: (cls) => {
                        const [eH, eM, eP] = TPL.time24To12(cls.schedule?.enableAt || '00:00');
                        const [dH, dM, dP] = TPL.time24To12(cls.schedule?.disableAt || '00:00');

                        return `
                            <div class="space-y-6">
                                <div class="bg-white p-6 rounded-xl shadow">
                                    <h3 class="text-xl font-semibold font-poppins text-gray-800 mb-4 flex items-center"><i class="fa-solid fa-clock mr-3 text-blue-600"></i> Automatic Schedule</h3>
                                    <p class="text-gray-600 mb-4">Set a daily time window for when hand raising should be automatically **enabled**. Outside this time, it will be **paused**.</p>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Enable Hand Raising At:</label>
                                            ${TPL.timePicker('enable-time-input', eH, eM, eP, cls.schedule?.enableAt || '')}
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Disable Hand Raising At:</label>
                                            ${TPL.timePicker('disable-time-input', dH, dM, dP, cls.schedule?.disableAt || '')}
                                        </div>
                                    </div>
                                    <div class="flex justify-between">
                                        <div>
                                            <button id="delete-schedule-btn" class="text-red-500 hover:text-red-700 font-medium transition-colors text-sm py-2 px-4 rounded-lg"><i class="fa-solid fa-trash-can mr-2"></i> Remove Schedule</button>
                                        </div>
                                        <button id="save-schedule-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors btn-bubbly"><i class="fa-solid fa-floppy-disk mr-2"></i> Save Schedule</button>
                                    </div>
                                </div>
                                <div class="bg-white p-6 rounded-xl shadow">
                                    <h3 class="text-xl font-semibold font-poppins text-gray-800 mb-4 flex items-center"><i class="fa-solid fa-circle-info mr-3 text-gray-600"></i> Current Status Logic</h3>
                                    <p class="text-sm text-gray-600">The current hand raising status (Active/Paused) is determined by the schedule above, but can be manually **overridden** by the teacher at any time from the Overview tab.</p>
                                </div>
                            </div>
                        `;
                    },

                    settingsGeneralTab: (cls) => `
                        <div class="space-y-6">
                            <div class="bg-white p-6 rounded-xl shadow">
                                <h3 class="text-xl font-semibold font-poppins text-gray-800 mb-4 flex items-center"><i class="fa-solid fa-pen-to-square mr-3 text-blue-600"></i> Class Name</h3>
                                <p class="text-gray-600 mb-4">The official name for your class. You can change this up to 3 times per day.</p>
                                <div class="flex space-x-3">
                                    <input type="text" id="class-name-input" class="app-input flex-1" placeholder="Enter new class name" value="${escapeHtml(cls.name)}" maxlength="50">
                                    <button data-class-id="${cls.id}" id="rename-class-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-150 btn-bubbly">Update Name</button>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-xl shadow">
                                <h3 class="text-xl font-semibold font-poppins text-gray-800 mb-4 flex items-center"><i class="fa-solid fa-key mr-3 text-green-600"></i> Class Codes</h3>
                                <dl class="divide-y divide-gray-100">
                                    <div class="py-3 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
                                        <dt class="text-sm font-medium leading-6 text-gray-500">Student Join Code</dt>
                                        <dd class="mt-1 text-sm leading-6 text-gray-800 sm:col-span-2 sm:mt-0 font-mono">${escapeHtml(cls.code)}</dd>
                                    </div>
                                    <div class="py-3 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
                                        <dt class="text-sm font-medium leading-6 text-gray-500">Co-Teacher Join Code</dt>
                                        <dd class="mt-1 text-sm leading-6 text-gray-800 sm:col-span-2 sm:mt-0 font-mono">${escapeHtml(cls.coTeacherCode)}</dd>
                                    </div>
                                </dl>
                            </div>

                            <div class="bg-white p-6 rounded-xl shadow border-l-4 border-red-500">
                                <h3 class="text-xl font-semibold font-poppins text-gray-800 mb-4 flex items-center"><i class="fa-solid fa-trash-can mr-3 text-red-600"></i> Danger Zone</h3>
                                <p class="text-gray-600 mb-4">Permanently delete this class. This action cannot be undone and all data (hands queue, roster) will be lost.</p>
                                <button data-class-id="${cls.id}" id="delete-class-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors duration-150 btn-bubbly">Delete Class</button>
                            </div>
                        </div>
                    `,
                    
                    settingsView: (cls, currentRoster) => {
                        const isOwner = cls.teacherId === currentUser.uid;
                        if (!isOwner) return `<div class="p-10 text-center bg-white rounded-xl shadow text-gray-500">Only the class owner can access these settings.</div>`;

                        const tabs = [
                            { id: 'general', label: 'General', icon: 'fa-solid fa-circle-info' },
                            { id: 'schedule', label: 'Schedule', icon: 'fa-solid fa-calendar-days' },
                        ];
                        
                        let currentSubView = document.getElementById('settings-view-tab-container')?.dataset.currentTab || 'general';
                        
                        let content = '';
                        if (currentSubView === 'schedule') content = TPL.settingsScheduleTab(cls);
                        else content = TPL.settingsGeneralTab(cls);

                        return `
                            <div class="flex flex-col h-full">
                                <h2 class="text-3xl font-bold font-poppins text-gray-900 border-b pb-4">Class Settings: ${escapeHtml(cls.name)}</h2>

                                <div class="flex-shrink-0 border-b border-gray-200 mt-4">
                                    <nav id="settings-view-tab-container" data-current-tab="${currentSubView}" class="-mb-px flex space-x-8 px-2" aria-label="Tabs">
                                        ${tabs.map(tab => {
                                            const isActive = currentSubView === tab.id;
                                            const activeClasses = isActive ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300';
                                            return `
                                                <a href="#" data-tab="${tab.id}" class="settings-tab-btn group inline-flex items-center py-4 px-1 border-b-2 font-medium text-sm ${activeClasses}">
                                                    <i class="${tab.icon} mr-2"></i>
                                                    <span>${tab.label}</span>
                                                </a>
                                            `;
                                        }).join('')}
                                    </nav>
                                </div>
                                <div class="flex-1 pt-6 pb-2 min-h-0 overflow-auto">
                                    ${content}
                                </div>
                            </div>
                        `;
                    },
                    
                    // NEW: Student Settings View
                    studentSettings: (cls, userData) => {
                        const personalName = localStorage.getItem(`personal_class_name_${cls.id}_${currentUser.uid}`) || '';
                        return `
                            <div class="space-y-6">
                                <h2 class="text-3xl font-bold font-poppins text-gray-900 border-b pb-4">My Settings for "${escapeHtml(cls.name)}"</h2>
                                
                                <div class="bg-white p-6 rounded-xl shadow">
                                    <h3 class="text-xl font-semibold font-poppins text-gray-800 mb-4 flex items-center"><i class="fa-solid fa-signature mr-3 text-blue-600"></i> Set Personal Class Name</h3>
                                    <p class="text-gray-600 mb-4">Set a personal name for this class that only you will see in your sidebar.</p>
                                    <div class="flex space-x-3">
                                        <input type="text" id="personal-class-name-input" class="app-input flex-1" placeholder="e.g., Mr. Smith's Fun Class" value="${escapeHtml(personalName)}" maxlength="50">
                                        <button data-class-id="${cls.id}" id="rename-personal-class-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-150 btn-bubbly">Save Name</button>
                                    </div>
                                    ${personalName ? `<p class="text-sm text-gray-500 mt-2">Current Personal Name: ${escapeHtml(personalName)}</p>` : `<p class="text-sm text-gray-500 mt-2">Currently using the class's official name: ${escapeHtml(cls.name)}</p>`}
                                </div>

                                <div class="bg-white p-6 rounded-xl shadow border-l-4 border-red-500">
                                    <h3 class="text-xl font-semibold font-poppins text-gray-800 mb-4 flex items-center"><i class="fa-solid fa-person-walking-dashed-line-arrow-right mr-3 text-red-600"></i> Leave Class</h3>
                                    <p class="text-gray-600 mb-4">You can permanently un-enroll yourself from this class. This cannot be undone unless you rejoin with the class code.</p>
                                    <button data-class-id="${cls.id}" id="leave-class-btn-student" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors duration-150 btn-bubbly"><i class="fa-solid fa-person-walking-arrow-right mr-2"></i> Leave Class</button>
                                </div>
                            </div>
                        `;
                    },

                    // NEW: Student Requests View (with fading scroll and sending component)
                    studentRequestsView: (cls, requests) => {
                        const statusColor = {
                            'pending': 'bg-yellow-100 text-yellow-800 border-yellow-300',
                            'accepted': 'bg-green-100 text-green-800 border-green-300',
                            'denied': 'bg-red-100 text-red-800 border-red-300',
                            'recyclable': 'bg-gray-200 text-gray-600 border-gray-400'
                        };
                        
                        // Filter out 'recyclable' which are background slots
                        const displayRequests = requests.filter(req => req.status !== 'recyclable').sort((a, b) => (b.requestedAt?.seconds || 0) - (a.requestedAt?.seconds || 0));
                        
                        return `
                            <div class="space-y-6 h-full flex flex-col">
                                <h2 class="text-3xl font-bold font-poppins text-gray-900 border-b pb-4">My Requests for "${escapeHtml(cls.name)}"</h2>
                                
                                <div class="bg-white p-6 rounded-xl shadow flex items-start space-x-4">
                                    <div class="flex-1">
                                        <h3 class="text-xl font-semibold font-poppins text-gray-800 mb-2"><i class="fa-solid fa-paper-plane mr-2 text-violet-600"></i> Send a New Request</h3>
                                        <p class="text-gray-600 mb-4 text-sm">You can send up to **${REQUEST_LIMIT_PER_MINUTE}** requests per minute. This is for asking to be a co-teacher or other requests to the class owner.</p>
                                        <textarea id="student-new-request-comment" class="app-input w-full resize-none" rows="3" placeholder="Enter your request or message here... (e.g., I would like to be a co-teacher to help manage the hands queue)"></textarea>
                                    </div>
                                    <button data-class-id="${cls.id}" id="send-student-request-btn" class="mt-8 bg-violet-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-violet-700 transition-colors duration-150 btn-bubbly flex-shrink-0" style="height: 44px;"><i class="fa-solid fa-arrow-up-from-bracket mr-1"></i> Send</button>
                                </div>
                                
                                <div class="flex-1 bg-white p-6 rounded-xl shadow min-h-0 flex flex-col">
                                    <h3 class="text-xl font-semibold font-poppins text-gray-800 mb-4"><i class="fa-solid fa-clock-rotate-left mr-2 text-gray-600"></i> Request History</h3>
                                    <div class="flex-1 fading-scroll-container">
                                        <div id="student-request-history" class="fading-scroll-content space-y-3 custom-scrollbar">
                                            ${displayRequests.length === 0 ? `<div class="text-center text-gray-500 py-10">You have no recorded requests for this class.</div>` : ''}
                                            ${displayRequests.map(req => `
                                                <div class="border p-4 rounded-lg shadow-sm bg-slate-50">
                                                    <div class="flex justify-between items-center mb-2">
                                                        <span class="text-xs font-semibold px-3 py-1 rounded-full border ${statusColor[req.status] || 'bg-gray-200 text-gray-800'}">
                                                            Status: ${req.status.charAt(0).toUpperCase() + req.status.slice(1)}
                                                        </span>
                                                        <span class="text-xs text-gray-500">
                                                            ${req.requestedAt ? new Date(req.requestedAt.seconds * 1000).toLocaleString() : 'N/A'}
                                                        </span>
                                                    </div>
                                                    <p class="text-sm text-gray-800 italic">${escapeHtml(req.comment || 'No comment provided.')}</p>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    },

                    // NEW: Confirmation Modal for Leaving Class
                    confirmLeaveClassModal: (classId, className) => `
                        <div class="bg-white rounded-xl p-6 w-full max-w-sm pointer-events-auto shadow-2xl fade-enter-active" role="dialog" aria-modal="true">
                            <h3 class="text-lg font-bold font-poppins text-red-600 mb-4 flex items-center"><i class="fa-solid fa-triangle-exclamation mr-2"></i> Confirm Leave Class</h3>
                            <p class="text-gray-700 mb-6">Are you sure you want to leave **${escapeHtml(className)}**? You will need the class code to rejoin.</p>
                            <div class="flex justify-end space-x-3">
                                <button onclick="hideModal()" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors btn-bubbly">Cancel</button>
                                <button id="confirm-leave-class-btn" data-class-id="${classId}" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors btn-bubbly">Yes, Leave Class</button>
                            </div>
                        </div>
                    `,
                    
                    // Time Picker utility for Settings
                    timePicker: (id, h, m, p, time24hr) => `
                        <div class="schedule-time-input-container">
                            <input type="text" id="${id}" class="app-input schedule-time-input" placeholder="HH:MM" maxlength="5" 
                                value="${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}"
                                data-time24hr="${time24hr}"
                                data-digits="${String(h).padStart(2, '0')}${String(m).padStart(2, '0')}">
                            <div class="period-selector">
                                <button type="button" data-value="AM" class="period-btn ${p === 'AM' ? 'active' : ''}">AM</button>
                                <button type="button" data-value="PM" class="period-btn ${p === 'PM' ? 'active' : ''}">PM</button>
                            </div>
                        </div>
                    `,
                    time24To12: (time24) => {
                        if (!time24) return [12, 0, 'AM']; // Default to 12:00 AM
                        const [h24, m] = time24.split(':').map(Number);
                        let h12 = h24 % 12;
                        if (h12 === 0) h12 = 12;
                        const period = h24 < 12 ? 'AM' : 'PM';
                        return [h12, m, period];
                    },
                    
                    // UPDATED: classView to handle student views and add a settings button for students
                    classView: (cls, userData, isOwner, isCoTeacher, isStudent, queue, pendingRequests, currentStudentRequests, currentView, currentRoster) => {
                        // Use personal name in the header if available
                        const personalName = localStorage.getItem(`personal_class_name_${cls.id}_${currentUser.uid}`) || cls.name; 
                        
                        const isTeacherRole = isOwner || isCoTeacher;
                        
                        // Determine which tab is currently active, handling the special case for student settings
                        let effectiveView = currentView;
                        // If a student is on the teacher settings tab, switch them to student settings
                        if (effectiveView === 'settings' && isStudent && !isTeacherRole) {
                            effectiveView = 'student-settings';
                        }
                        
                        const tabs = [
                            { id: 'overview', label: 'Overview', icon: 'fa-solid fa-home' },
                            ...(isTeacherRole ? [{ id: 'hands', label: `Hands Queue (${queue.length})`, icon: 'fa-solid fa-hand' }] : []),
                            // Teacher Requests: only for owner/co-teacher, shows pending count
                            ...(isTeacherRole ? [{ id: 'requests', label: `Requests (${pendingRequests.length})`, icon: 'fa-solid fa-user-plus' }] : []),
                            // Student Requests: only for students who are not also teachers, shows personal requests
                            ...(!isTeacherRole && isStudent ? [{ id: 'requests', label: 'My Requests', icon: 'fa-solid fa-paper-plane' }] : []),
                            ...(isOwner ? [{ id: 'roster', label: 'Roster', icon: 'fa-solid fa-users' }] : []),
                            // Only show one settings tab
                            ...(isOwner ? [{ id: 'settings', label: 'Class Settings', icon: 'fa-solid fa-gear' }] : []),
                            ...(!isOwner && isStudent ? [{ id: 'student-settings', label: 'My Settings', icon: 'fa-solid fa-gear' }] : []),
                        ];

                        let content = '';
                        if (effectiveView === 'overview') content = TPL.overview(cls, isOwner, isCoTeacher, isStudent, queue);
                        else if (effectiveView === 'hands') content = TPL.handsQueue(cls, userData, queue, isTeacherRole);
                        // Teacher Requests: show if user is a teacher and the tab is 'requests'
                        else if (effectiveView === 'requests' && isTeacherRole) content = TPL.coTeacherRequestsView(cls, pendingRequests, currentRoster);
                        // Student Requests: show if user is a student and the tab is 'requests'
                        else if (effectiveView === 'requests' && isStudent) content = TPL.studentRequestsView(cls, currentStudentRequests); 
                        else if (effectiveView === 'roster') content = TPL.rosterView(cls, userData, currentRoster);
                        else if (effectiveView === 'settings') content = TPL.settingsView(cls, currentRoster);
                        // NEW: Student Settings View
                        else if (effectiveView === 'student-settings') content = TPL.studentSettings(cls, userData);
                        else content = TPL.overview(cls, isOwner, isCoTeacher, isStudent, queue);
                        
                        return `
                            <div class="flex flex-col h-full">
                                <div class="bg-white rounded-xl shadow p-6 mb-6 flex justify-between items-center">
                                    <div>
                                        <h2 class="text-3xl font-extrabold font-poppins text-gray-900">${escapeHtml(personalName)}</h2>
                                        <p class="text-sm font-medium text-gray-500">Teacher: ${escapeHtml(currentRoster.owner.username || cls.teacherId)}</p>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        </div>
                                </div>

                                <div class="flex-shrink-0 border-b border-gray-200">
                                    <nav class="-mb-px flex space-x-8 px-2" aria-label="Tabs">
                                        ${tabs.map(tab => {
                                            const isActive = effectiveView === tab.id;
                                            const activeClasses = isActive ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300';
                                            
                                            // Handle the click event to switch views
                                            return `
                                                <a href="#" data-view="${tab.id}" class="group inline-flex items-center py-4 px-1 border-b-2 font-medium text-sm ${activeClasses}" onclick="currentClassView='${tab.id}'; renderMainContent(); return false;">
                                                    <i class="${tab.icon} mr-2"></i>
                                                    <span>${tab.label}</span>
                                                </a>
                                            `;
                                        }).join('')}
                                    </nav>
                                </div>

                                <div class="flex-1 pt-6 pb-2 min-h-0 overflow-hidden">
                                    ${content}
                                </div>
                            </div>
                        `;
                    },
                };

                // Attach TPL functions to global scope so they can be called from within the templates (e.g. showModal)
                Object.assign(window, { 
                    ...TPL, selectClass, createNewClass, joinClass, requestCoTeacher, handleCoTeacherRequest, 
                    raiseHand, lowerHand, lowerAllHands, toggleHandRaising, handleChangeClassName, handleSaveSchedule, 
                    deleteSchedule, removeUserFromClass, handleDeleteClass, hideModal, handleGoogleImportClick, 
                    // NEW Student Handlers
                    studentSendRequest, handleStudentRenameClass, handleStudentLeaveClass
                });

                // --- EVENT LISTENERS (UPDATED) ---

                // User Profile Menu Toggle
                document.getElementById('user-profile-btn').addEventListener('click', () => {
                    document.getElementById('user-profile-menu').classList.toggle('hidden');
                });
                
                // General Click Listener (for delegation)
                document.body.addEventListener('click', async (e) => {
                    const target = e.target.closest('button, a');

                    // Sidebar Class Selection
                    if (target && target.dataset.classId && target.closest('#class-list')) {
                        const classId = target.dataset.classId;
                        if (currentClassId !== classId) {
                            await selectClass(classId);
                        }
                        return;
                    } 
                    
                    // Modals
                    if (target) {
                        if (target.id === 'new-class-btn' || target.id === 'new-class-btn-empty') {
                            showModal(TPL.newClassModal());
                            return;
                        } else if (target.id === 'join-class-btn-main' || target.id === 'join-class-btn-empty') {
                            showModal(TPL.joinClassModal());
                            return;
                        } else if (target.id === 'logout-btn') {
                            auth.signOut();
                            return;
                        } else if (target.id === 'g-import-btn') {
                            await handleGoogleImportClick();
                            return;
                        }
                    }

                    // Handlers that require currentClassId
                    if (currentClassId && allLoadedClasses[currentClassId]) {
                        const classData = allLoadedClasses[currentClassId];

                        // Overview (Student/Teacher Hands)
                        if (target && target.id === 'raise-hand-btn') {
                            // Show modal to ask for question
                            showModal(`
                                <div class="bg-white rounded-xl p-6 w-full max-w-lg pointer-events-auto shadow-2xl fade-enter-active" role="dialog" aria-modal="true">
                                    <h3 class="text-xl font-bold font-poppins text-blue-600 mb-4">Raise Hand</h3>
                                    <p class="text-gray-700 mb-4">You are raising your hand in **${escapeHtml(classData.name)}**.</p>
                                    <p class="text-sm text-gray-600 mb-4">Optionally, enter your question:</p>
                                    <textarea id="raise-hand-question" class="app-input w-full resize-none mb-6" rows="3" placeholder="My question is about..."></textarea>
                                    <div class="flex justify-end space-x-3">
                                        <button onclick="hideModal()" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors btn-bubbly">Cancel</button>
                                        <button id="confirm-raise-hand-btn" data-class-id="${currentClassId}" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors btn-bubbly">Confirm Raise Hand</button>
                                    </div>
                                </div>
                            `);
                            return;
                        } else if (target && target.id === 'lower-hand-btn') {
                            await lowerHand(currentClassId);
                            return;
                        }

                        // Hands Queue (Teacher Only)
                        if (target) {
                            if (target.id === 'lower-hand-teacher-btn') {
                                const studentId = target.dataset.userId || target.dataset.studentId;
                                await lowerHand(currentClassId, studentId);
                                return;
                            } else if (target.id === 'lower-all-hands-btn') {
                                await lowerAllHands(currentClassId);
                                return;
                            }
                        }

                        // Co-Teacher Requests (Owner Only)
                        if (target) {
                            if (target.id === 'accept-co-teacher-request-btn') {
                                await handleCoTeacherRequest(currentClassId, target.dataset.docId, 'accept');
                                return;
                            } else if (target.id === 'deny-co-teacher-request-btn') {
                                await handleCoTeacherRequest(currentClassId, target.dataset.docId, 'deny');
                                return;
                            } else if (target.id === 'request-comment-btn') {
                                await handleCoTeacherRequest(currentClassId, target.dataset.docId, target.dataset.action);
                                return;
                            }
                        }

                        // Roster (Owner Only)
                        if (target && target.id === 'remove-user-btn') {
                            const userId = target.dataset.userId;
                            // Confirmation modal could be added here
                            await removeUserFromClass(currentClassId, userId);
                            return;
                        }

                        // Class Settings (Owner Only)
                        if (target) {
                            if (target.classList.contains('settings-tab-btn')) {
                                const container = document.getElementById('settings-view-tab-container');
                                if (container) {
                                    container.dataset.currentTab = target.dataset.tab;
                                    renderMainContent();
                                }
                                return;
                            } else if (target.id === 'rename-class-btn') {
                                const newName = document.getElementById('class-name-input').value.trim();
                                if (newName) {
                                    await handleChangeClassName(currentClassId, newName);
                                } else {
                                    showModal(TPL.messageModal('Error', 'Class name cannot be empty.', 'red'));
                                }
                                return;
                            } else if (target.id === 'save-schedule-btn') {
                                const enableInput = document.getElementById('enable-time-input');
                                const disableInput = document.getElementById('disable-time-input');
                                const enableTime = enableInput ? enableInput.dataset.time24hr : '';
                                const disableTime = disableInput ? disableInput.dataset.time24hr : '';
                                
                                if (enableTime && disableTime) {
                                    await handleSaveSchedule(currentClassId, enableTime, disableTime);
                                } else {
                                    showModal(TPL.messageModal('Error', 'Please set both an enable time and a disable time, or remove the schedule.', 'red'));
                                }
                                return;
                            } else if (target.id === 'delete-schedule-btn') {
                                await deleteSchedule(currentClassId);
                                return;
                            } else if (target.id === 'delete-class-btn') {
                                // Confirmation modal could be added here
                                showModal(TPL.messageModal('Confirm Delete', `Are you sure you want to delete **${escapeHtml(classData.name)}**? This action is permanent.`, 'red'));
                                const modalBtn = document.querySelector('#modal-container button');
                                if (modalBtn) modalBtn.textContent = 'No, Cancel';
                                modalContainer.querySelector('.flex.justify-end').prepend(`<button data-class-id="${currentClassId}" id="confirm-delete-class-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors btn-bubbly mr-3">Yes, Delete</button>`);
                                return;
                            }
                            
                            // NEW: Student Settings Handlers
                            if (target.id === 'rename-personal-class-btn') {
                                const newName = document.getElementById('personal-class-name-input').value.trim();
                                await handleStudentRenameClass(currentClassId, newName);
                                return;
                            } else if (target.id === 'leave-class-btn-student') {
                                showModal(TPL.confirmLeaveClassModal(currentClassId, classData.name));
                                return;
                            } else if (target.id === 'send-student-request-btn') {
                                const comment = document.getElementById('student-new-request-comment').value.trim();
                                if (comment) {
                                    await studentSendRequest(currentClassId, comment);
                                } else {
                                    showModal(TPL.messageModal('Error', 'Please enter a request or comment.', 'red'));
                                }
                                return;
                            }
                        }
                    }
                });

                // Global Document Click Listener for Modals
                document.body.addEventListener('click', async (e) => {
                    const target = e.target.closest('button, a');

                    // Global Modal Actions (regardless of currentClassId)
                    if (target) {
                        if (target.id === 'create-class-btn') {
                            const name = document.getElementById('new-class-name-input').value.trim();
                            if (name) { await createNewClass(name); } 
                            else { showModal(TPL.messageModal('Error', 'Please enter a class name.', 'red')); }
                            return;
                        } else if (target.id === 'submit-join-class-btn') {
                            const code = document.getElementById('join-class-code-input').value.trim().toUpperCase();
                            if (code) { await joinClass(code); } 
                            else { showModal(TPL.messageModal('Error', 'Please enter a class code.', 'red')); }
                            return;
                        } else if (target.id === 'send-co-teacher-request-btn') {
                            const classId = target.dataset.classId;
                            const comment = document.getElementById('co-teacher-request-comment').value.trim();
                            if (comment) { await requestCoTeacher(classId, comment); }
                            else { showModal(TPL.messageModal('Error', 'Please enter a message for the class owner.', 'red')); }
                            return;
                        } else if (target.id === 'confirm-raise-hand-btn') {
                            const classId = target.dataset.classId;
                            const question = document.getElementById('raise-hand-question').value.trim();
                            await raiseHand(classId, question);
                            return;
                        } else if (target.id === 'confirm-delete-class-btn') {
                            await handleDeleteClass(target.dataset.classId);
                            return;
                        } else if (target.id === 'confirm-leave-class-btn') {
                            await handleStudentLeaveClass(target.dataset.classId);
                            return;
                        } else if (target.classList.contains('g-import-course-btn')) {
                            const googleId = target.dataset.courseId;
                            const courseName = target.dataset.courseName;
                            hideModal();
                            showModal(TPL.importConfirmationModal(googleId, courseName));
                            return;
                        } else if (target.id === 'confirm-import-btn') {
                            const googleId = target.dataset.googleId;
                            const className = document.getElementById('import-class-name-input').value.trim() || target.dataset.defaultName;
                            if (className) { await importGoogleCourse(googleId, className); } 
                            else { showModal(TPL.messageModal('Error', 'Class name cannot be empty.', 'red')); }
                            return;
                        }
                    }

                    // Handle hiding the profile menu if clicking outside
                    if (!e.target.closest('#user-profile-btn') && !e.target.closest('#user-profile-menu')) {
                        document.getElementById('user-profile-menu').classList.add('hidden');
                    }
                });


                // Listeners for Schedule Time Picker
                document.body.addEventListener('mainContentRendered', () => {
                    const periodBtns = document.querySelectorAll('.period-btn');
                    periodBtns.forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const button = e.currentTarget;
                            const container = button.closest('.schedule-time-input-container');
                            const input = container.querySelector('.schedule-time-input');
                            const period = button.dataset.value;

                            // Toggle active state
                            container.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                            button.classList.add('active');

                            // Convert current 12hr time to 24hr time and store in data-time24hr
                            let [h, m] = input.value.split(':').map(Number);
                            if (isNaN(h) || h < 1 || h > 12) h = 12; // Handle invalid hour
                            if (isNaN(m) || m < 0 || m > 59) m = 0; // Handle invalid minute

                            let h24 = h;
                            if (period === 'PM' && h !== 12) h24 += 12;
                            if (period === 'AM' && h === 12) h24 = 0;

                            input.dataset.time24hr = `${String(h24).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
                        });
                    });
                    
                    const timeInputs = document.querySelectorAll('.schedule-time-input');
                    timeInputs.forEach(input => {
                        input.addEventListener('input', (e) => {
                            // Only allow numbers and one colon
                            e.target.value = e.target.value.replace(/[^0-9:]/g, '');
                            const parts = e.target.value.split(':');
                            if (parts.length > 2) e.target.value = parts[0] + ':' + parts.slice(1).join('');
                        });

                        input.addEventListener('blur', (e) => {
                            if (!e.target.value.includes(':')) {
                                e.target.value = '12:00';
                                e.target.closest('.schedule-time-input-container').querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
                                e.target.closest('.schedule-time-input-container').querySelector('.period-btn[data-value="AM"]').classList.add('active');
                                return;
                            }
                            
                            let [h, m] = e.target.value.split(':').map(Number);
                            
                            // Clean up based on 12-hour display logic
                            if (isNaN(h) || h < 1 || h > 12) h = 12;
                            if (isNaN(m) || m < 0 || m > 59) m = 0;
                            const finalValue = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                            e.target.value = finalValue;
                            input.dataset.digits = finalValue.replace(':', '');
                            
                            // Crucial: Update the 24hr time on blur
                            const periodEl = e.target.closest('.schedule-time-input-container').querySelector('.period-btn.active');
                            const period = periodEl ? periodEl.dataset.value : 'AM'; // Default to AM if none active
                            let h24 = h;
                            if (period === 'PM' && h !== 12) h24 += 12;
                            if (period === 'AM' && h === 12) h24 = 0;
                            input.dataset.time24hr = `${String(h24).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
                        });
                    });
                });
            });
        });
    </script>
</body>
</html>
