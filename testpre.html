<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notify | Dashboard</title>
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' https://cdn.tailwindcss.com https://www.gstatic.com https://apis.google.com https://accounts.google.com 'unsafe-inline' 'unsafe-eval';
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net;
        font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net;
        img-src 'self' data: https://www.gstatic.com https://lh3.googleusercontent.com;
        connect-src 'self' https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://www.googleapis.com https://content.googleapis.com https://classroom.googleapis.com;
        frame-src 'self' https://accounts.google.com https://content.googleapis.com https://content-classroom.googleapis.com;
    ">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        /* Custom scrollbar for better aesthetics */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        /* Squircle button styling */
        .squircle-btn {
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        /* Utility for centering content in the main view */
        .main-content-view {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
            overflow-y: auto;
        }
        
        /* Style for the two-part action button (Comment/Delete) */
        .split-button {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            border-radius: 12px;
            overflow: hidden;
        }
        .split-button > button {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin: 0;
            border-radius: 0;
        }
        .split-button > button:first-child {
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        /* Time input format styling */
        .time-input {
            width: 90px;
            text-align: center;
            font-variant-numeric: tabular-nums;
        }
    </style>
</head>
<body class="h-screen w-screen flex overflow-hidden">

    <!-- Loading Screen / Initial Setup -->
    <div id="loading-screen" class="absolute inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-xl font-medium text-gray-700">Loading and Authenticating...</div>
    </div>

    <!-- Main Container -->
    <div id="app-container" class="flex flex-1 hidden">
        
        <!-- Sidebar (Teacher/Co-Teacher/Student) -->
        <div id="sidebar" class="w-20 bg-white border-r border-gray-200 flex flex-col items-center py-6 space-y-4">
            
            <!-- Logo (Top) -->
            <div class="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center text-white font-extrabold text-xl">
                N
            </div>
            
            <div class="flex-grow space-y-3">
                
                <!-- Main Queue Button (Always visible) -->
                <button id="queue-btn" class="menu-btn w-14 h-14 bg-gray-100 text-gray-500 hover:bg-gray-200 transition-colors squircle-btn" onclick="showScreen(isTeacher || isCoTeacher ? 'main-content-teacher' : 'main-content-student')">
                    <!-- Original HTML will be stored in data-original-html by JS -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M12 2v10"></path><path d="M18.4 6.6a9 9 0 0 1 0 10.8"></path><path d="M5.6 6.6a9 9 0 0 0 0 10.8"></path><path d="M1 18h22"></path></svg>
                </button>

                <!-- Teacher/Co-Teacher Only Buttons (Hidden by default, shown by JS) -->
                <div id="teacher-menu-buttons" class="hidden space-y-3">
                    <button id="cohorts-btn" class="menu-btn w-14 h-14 bg-gray-100 text-gray-500 hover:bg-gray-200 transition-colors squircle-btn" onclick="showScreen('cohorts-content', 'cohorts-btn')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    </button>
                    <button id="archive-btn" class="menu-btn w-14 h-14 bg-gray-100 text-gray-500 hover:bg-gray-200 transition-colors squircle-btn" onclick="showScreen('archive-content', 'archive-btn')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><rect x="3" y="4" width="18" height="4" rx="1"></rect><path d="M20 8v11a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V8"></path><path d="M10 12h4"></path></svg>
                    </button>
                </div>
            </div>

            <!-- Settings Button (Bottom) -->
            <button id="settings-btn" class="menu-btn w-14 h-14 bg-gray-100 text-gray-500 hover:bg-gray-200 transition-colors squircle-btn" onclick="showScreen('settings-content', 'settings-btn')">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.44a2 2 0 0 1-2 2h-.44a2 2 0 0 0-2 2v.44a2 2 0 0 1-2 2h-.44a2 2 0 0 0-2 2v.44a2 2 0 0 1 2 2h.44a2 2 0 0 0 2 2v.44a2 2 0 0 1 2 2h.44a2 2 0 0 0 2 2v.44a2 2 0 0 1 .44 0h.44a2 2 0 0 0 2-2v-.44a2 2 0 0 1 2-2h.44a2 2 0 0 0 2-2v-.44a2 2 0 0 1 2-2h.44a2 2 0 0 0 2-2v-.44a2 2 0 0 1-2-2h-.44a2 2 0 0 0-2-2v-.44a2 2 0 0 1-2-2v-.44a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            </button>
        </div>

        <!-- Main Content Area -->
        <div class="flex flex-col flex-1 bg-white">
            
            <!-- Top Bar -->
            <header class="h-16 flex items-center justify-between px-6 border-b border-gray-200">
                <div class="text-xl font-semibold text-gray-800" id="class-title-display">Class Name (ID: <span id="class-id-display"></span>)</div>
                <div class="flex items-center space-x-4">
                    <!-- User Avatar/Info (Placeholder) -->
                    <div class="text-gray-600">User: <span id="user-role-display" class="font-medium"></span> (<span id="user-id-display"></span>)</div>
                    
                    <!-- Hand Raise Toggle (Teacher/Co-Teacher ONLY) -->
                    <button id="hand-raise-toggle-btn" class="hidden w-14 h-10 transition-colors squircle-btn bg-gray-200 text-gray-600 hover:bg-gray-300" onclick="toggleHandRaising()">
                        <!-- Dynamic Icon will be here -->
                        <span id="hand-raise-toggle-icon" class="text-lg"></span>
                    </button>
                </div>
            </header>

            <!-- Screen Views (Hidden/Shown by JS) -->
            <div class="flex-1 overflow-hidden">

                <!-- 1. Teacher/Co-Teacher Main View (Hand Raise Queue) -->
                <div id="main-content-teacher" class="main-content-view custom-scroll" style="display: none;">
                    
                    <div class="w-full max-w-2xl mt-4">
                         <!-- NEW: Filter Buttons -->
                        <div id="teacher-filter-bar" class="flex justify-start space-x-3 mb-6">
                            <button class="filter-btn squircle-btn px-4 py-2 text-sm font-medium bg-blue-600 text-white" data-filter="Unanswered" onclick="setFilter('Unanswered')">Unanswered</button>
                            <button class="filter-btn squircle-btn px-4 py-2 text-sm font-medium bg-gray-100 text-gray-500 hover:bg-gray-200" data-filter="Accepted" onclick="setFilter('Accepted')">Accepted</button>
                            <button class="filter-btn squircle-btn px-4 py-2 text-sm font-medium bg-gray-100 text-gray-500 hover:bg-gray-200" data-filter="Denied" onclick="setFilter('Denied')">Denied</button>
                            <button class="filter-btn squircle-btn px-4 py-2 text-sm font-medium bg-gray-100 text-gray-500 hover:bg-gray-200" data-filter="Commented" onclick="setFilter('Commented')">Commented On</button>
                        </div>
                        
                        <h2 class="text-2xl font-bold mb-4 text-gray-800" id="teacher-queue-header">Hand Raise Queue (Unanswered)</h2>
                        
                        <div id="request-list-teacher" class="space-y-3">
                            <!-- Requests will be injected here -->
                            <div id="no-requests-message-teacher" class="text-center p-6 bg-gray-50 rounded-xl text-gray-500">No requests in this category.</div>
                        </div>
                    </div>
                </div>

                <!-- 2. Student Main View (Request Maker and History) -->
                <div id="main-content-student" class="main-content-view custom-scroll" style="display: none;">
                    <div class="w-full max-w-2xl mt-4">
                         <!-- NEW: Filter Buttons (Student) -->
                        <div id="student-filter-bar" class="flex justify-start space-x-3 mb-6">
                            <button class="filter-btn squircle-btn px-4 py-2 text-sm font-medium bg-blue-600 text-white" data-filter="Unanswered" onclick="setFilter('Unanswered')">Unanswered</button>
                            <button class="filter-btn squircle-btn px-4 py-2 text-sm font-medium bg-gray-100 text-gray-500 hover:bg-gray-200" data-filter="Accepted" onclick="setFilter('Accepted')">Accepted</button>
                            <button class="filter-btn squircle-btn px-4 py-2 text-sm font-medium bg-gray-100 text-gray-500 hover:bg-gray-200" data-filter="Denied" onclick="setFilter('Denied')">Denied</button>
                            <button class="filter-btn squircle-btn px-4 py-2 text-sm font-medium bg-gray-100 text-gray-500 hover:bg-gray-200" data-filter="Commented" onclick="setFilter('Commented')">Commented On</button>
                        </div>
                        
                        <h2 class="text-2xl font-bold mb-4 text-gray-800" id="student-queue-header">My Requests Today (Unanswered)</h2>
                        <div id="request-list-student" class="space-y-3">
                            <!-- Student's requests will be injected here -->
                             <div id="no-requests-message-student" class="text-center p-6 bg-gray-50 rounded-xl text-gray-500">You have no requests in this category today.</div>
                        </div>
                    </div>
                </div>

                <!-- 3. Cohorts Content (Teachers Only) -->
                <div id="cohorts-content" class="main-content-view" style="display: none;">
                    <div class="w-full max-w-2xl mt-4 p-6 bg-gray-50 rounded-xl">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Cohorts Management</h2>
                        <p class="text-gray-600">This section is for managing co-teachers and student groups. (Placeholder)</p>
                        <!-- Add Co-Teacher UI here -->
                        <div id="co-teacher-list" class="mt-4 space-y-2">
                             <!-- Co-teachers will be listed here -->
                        </div>
                    </div>
                </div>

                <!-- 4. Archive Content (Teachers Only) -->
                <div id="archive-content" class="main-content-view" style="display: none;">
                     <div class="w-full max-w-2xl mt-4 p-6 bg-gray-50 rounded-xl">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Archived Requests</h2>
                        <p class="text-gray-600">This section shows requests from previous days. (Placeholder)</p>
                    </div>
                </div>

                <!-- 5. Settings Content (Shared, but with role-specific options) -->
                <div id="settings-content" class="main-content-view" style="display: none;">
                    <div class="w-full max-w-2xl mt-4 p-6 bg-gray-50 rounded-xl space-y-8">
                        <h2 class="text-2xl font-bold text-gray-800">Settings</h2>

                        <!-- Teacher/Co-Teacher Section -->
                        <div id="teacher-settings-section" class="space-y-4 border-b pb-4 border-gray-200 hidden">
                             <h3 class="text-xl font-semibold text-gray-700">Class Management</h3>
                             
                             <!-- NEW: Class Schedule Setup -->
                            <div class="bg-white p-4 rounded-lg shadow-sm space-y-3">
                                <h4 class="text-lg font-medium text-gray-800">Class Schedule (Auto Hand-Raise)</h4>
                                <p class="text-sm text-gray-500">Hand raising will be automatically enabled during this period and paused outside of it.</p>
                                <div class="flex items-center space-x-4">
                                    <label class="text-sm font-medium">Start Time:</label>
                                    <input type="text" id="schedule-start-time" class="time-input p-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500" value="09:00" data-digits="0900" maxlength="5">
                                    <label class="text-sm font-medium">End Time:</label>
                                    <input type="text" id="schedule-end-time" class="time-input p-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500" value="10:00" data-digits="1000" maxlength="5">
                                    <button onclick="saveSchedule()" class="squircle-btn px-4 py-2 bg-blue-600 text-white text-sm hover:bg-blue-700 transition-colors">Save Schedule</button>
                                </div>
                                <p id="schedule-message" class="text-sm"></p>
                            </div>
                            
                            <!-- Delete Class Button (Teacher Only) -->
                             <button id="delete-class-btn" onclick="confirmDeleteClass()" class="squircle-btn px-4 py-2 bg-red-600 text-white hover:bg-red-700 transition-colors hidden">
                                Delete Class
                            </button>
                            <p id="delete-class-message" class="text-sm text-red-500 hidden">Only the class owner can delete the class.</p>
                        </div>

                         <!-- Student Section -->
                        <div id="student-settings-section" class="space-y-4 hidden">
                            <h3 class="text-xl font-semibold text-gray-700">Personal Settings</h3>
                            
                            <!-- NEW: Local Class Name -->
                            <div class="bg-white p-4 rounded-lg shadow-sm space-y-2">
                                <h4 class="text-lg font-medium text-gray-800">Set Local Class Name</h4>
                                <p class="text-sm text-gray-500">This name is only visible to you.</p>
                                <div class="flex items-center space-x-3">
                                    <input type="text" id="local-class-name-input" placeholder="e.g. My Math Class" class="flex-1 p-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                    <button onclick="saveLocalClassName()" class="squircle-btn px-4 py-2 bg-blue-600 text-white text-sm hover:bg-blue-700 transition-colors">Save</button>
                                </div>
                                 <p id="local-name-message" class="text-sm"></p>
                            </div>

                             <!-- NEW: Leave Class -->
                            <div class="bg-white p-4 rounded-lg shadow-sm">
                                <h4 class="text-lg font-medium text-red-600">Leave Class</h4>
                                <p class="text-sm text-gray-500 mb-3">You will no longer be able to submit requests for this class.</p>
                                <button onclick="confirmLeaveClass()" class="squircle-btn px-4 py-2 bg-red-600 text-white hover:bg-red-700 transition-colors">
                                    Leave This Class
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- Modals for Actions (Comment, Confirm Delete, Confirm Leave) -->
    <div id="modal-container" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm space-y-4">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800">Action</h3>
            <div id="modal-content">
                <!-- Content injected here (e.g., textarea for comment) -->
            </div>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" onclick="closeModal()" class="px-4 py-2 bg-gray-200 rounded-lg text-gray-700 hover:bg-gray-300">Cancel</button>
                <button id="modal-action-btn" class="px-4 py-2 bg-blue-600 rounded-lg text-white hover:bg-blue-700">Confirm</button>
            </div>
        </div>
    </div>
    
    <!-- Student Request Modal -->
     <div id="request-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md space-y-4">
            <h3 class="text-xl font-bold text-gray-800">Create New Request</h3>
            <textarea id="request-text-input" placeholder="What do you need help with?" class="w-full h-32 p-3 border rounded-lg focus:ring-blue-500 focus:border-blue-500 resize-none"></textarea>
            <div class="flex justify-end space-x-3">
                <button onclick="closeRequestModal()" class="px-4 py-2 bg-gray-200 rounded-lg text-gray-700 hover:bg-gray-300">Cancel</button>
                <button onclick="submitRequest()" class="px-4 py-2 bg-blue-600 rounded-lg text-white hover:bg-blue-700">Submit Request</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDocs, Timestamp, setLogLevel, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // NEW: Set log level for debugging
        setLogLevel('debug');

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Class ID is static for this app's context
        const CLASS_ID = 'test-class-001'; 
        
        // Firebase Instances
        let app, db, auth;
        
        // Global State Variables
        let userId = null;
        let isTeacher = false;
        let isCoTeacher = false;
        let classData = null;
        let isAuthReady = false;
        
        // NEW: Hand Raise State and Schedule
        let isPaused = true;
        let currentFilter = 'Unanswered';

        // Firestore Collection Paths
        const CLASS_COLLECTION_PATH = `artifacts/${appId}/public/data/classes`;
        const REQUEST_COLLECTION_PATH = `artifacts/${appId}/public/data/requests`;
        
        // --- Core Utility Functions ---

        /**
         * Closes the generic modal.
         */
        window.closeModal = () => {
            document.getElementById('modal-container').classList.add('hidden');
        };
        
        /**
         * Opens the student request modal.
         */
        window.openRequestModal = () => {
            if (isPaused) {
                alert('Hand raising is currently paused by the teacher.');
                return;
            }
            document.getElementById('request-modal').classList.remove('hidden');
            document.getElementById('request-text-input').value = '';
        }
        
        /**
         * Closes the student request modal.
         */
        window.closeRequestModal = () => {
            document.getElementById('request-modal').classList.add('hidden');
        }

        /**
         * NEW: Sets the active filter and re-renders the request list.
         * @param {string} filter 'Unanswered', 'Accepted', 'Denied', 'Commented'
         */
        window.setFilter = (filter) => {
            currentFilter = filter;
            const isTeacherView = isTeacher || isCoTeacher;
            const filterBarId = isTeacherView ? 'teacher-filter-bar' : 'student-filter-bar';
            const headerId = isTeacherView ? 'teacher-queue-header' : 'student-queue-header';
            
            document.getElementById(headerId).textContent = isTeacherView 
                ? `Hand Raise Queue (${filter})` 
                : `My Requests Today (${filter})`;

            // Update button styles
            document.querySelectorAll(`#${filterBarId} .filter-btn`).forEach(btn => {
                if (btn.dataset.filter === filter) {
                    btn.classList.remove('bg-gray-100', 'text-gray-500', 'hover:bg-gray-200');
                    btn.classList.add('bg-blue-600', 'text-white');
                } else {
                    btn.classList.add('bg-gray-100', 'text-gray-500', 'hover:bg-gray-200');
                    btn.classList.remove('bg-blue-600', 'text-white');
                }
            });
            
            // Re-run the snapshot listener or re-display existing data (better to re-run listener)
             if (isAuthReady) {
                 if (isTeacher || isCoTeacher) {
                     listenForTeacherRequests();
                 } else {
                     listenForStudentRequests();
                 }
            }
        };


        /**
         * Shows the requested screen and handles the blue home button conversion.
         * @param {string} screenId - ID of the content div to show.
         * @param {string} activeMenuButtonId - ID of the button pressed to get here.
         */
        window.showScreen = (screenId, activeMenuButtonId = 'queue-btn') => {
            document.querySelectorAll('[id$="-content"]').forEach(el => el.style.display = 'none');
            document.getElementById(screenId).style.display = 'flex';
            
            // Re-show the correct queue header
            if (screenId === 'main-content-teacher') {
                 document.getElementById('teacher-queue-header').textContent = `Hand Raise Queue (${currentFilter})`;
            } else if (screenId === 'main-content-student') {
                document.getElementById('student-queue-header').textContent = `My Requests Today (${currentFilter})`;
            }

            // NEW: Blue Home Button Logic
            document.querySelectorAll('.menu-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-700');
                btn.classList.add('bg-gray-100', 'text-gray-500', 'hover:bg-gray-200');
                
                // Restore original icon/text and click handler if they were stored
                if (btn.dataset.originalHtml) {
                    btn.innerHTML = btn.dataset.originalHtml;
                }
                btn.onclick = window[`${btn.id.split('-')[0]}Action`] || (() => showScreen(btn.id.replace('btn', 'content'), btn.id));
            });
            
            const activeBtn = document.getElementById(activeMenuButtonId);
            
            // Check if we are moving to a sub-menu (not the main queue)
            if (activeBtn && screenId !== 'main-content-teacher' && screenId !== 'main-content-student') {
                
                // 1. Store original HTML and click handler
                if (!activeBtn.dataset.originalHtml) {
                    activeBtn.dataset.originalHtml = activeBtn.innerHTML;
                }
                
                // 2. Change style to blue
                activeBtn.classList.remove('bg-gray-100', 'text-gray-500', 'hover:bg-gray-200');
                activeBtn.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700');
                
                // 3. Replace icon/text with Home
                activeBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                        <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                `;
                
                // 4. Update click handler to return to the main queue
                activeBtn.onclick = () => showScreen(isTeacher || isCoTeacher ? 'main-content-teacher' : 'main-content-student');

            } else if (activeBtn) {
                // We are on the main queue screen, ensure queue button is in default style
                activeBtn.classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-700');
                activeBtn.classList.add('bg-gray-100', 'text-gray-500', 'hover:bg-gray-200');
            }
        }
        
        /**
         * NEW: Toggles the hand raising state (Pause/Resume) and updates the icon.
         */
        window.toggleHandRaising = async () => {
            if (!db || !(isTeacher || isCoTeacher)) return;

            const newPausedState = !isPaused;
            const classRef = doc(db, CLASS_COLLECTION_PATH, CLASS_ID);

            try {
                await updateDoc(classRef, { isPaused: newPausedState });
                // The onSnapshot listener will handle the global variable and UI update
            } catch (error) {
                console.error("Error toggling hand raising:", error);
            }
        };

        /**
         * NEW: Handles the automatic pause/resume based on schedule.
         * @param {Object} schedule - { start: 'HH:MM', end: 'HH:MM' }
         */
        const checkScheduleAndSetHandRaising = async (schedule) => {
            if (!db || !(isTeacher || isCoTeacher) || !schedule || !schedule.start || !schedule.end) {
                // If schedule is missing or user is not a teacher, just use the DB's isPaused state
                return; 
            }

            const now = new Date();
            const today = now.toDateString();
            
            // Create Date objects for schedule start and end today
            const [startH, startM] = schedule.start.split(':').map(Number);
            const [endH, endM] = schedule.end.split(':').map(Number);

            const startTime = new Date(today);
            startTime.setHours(startH, startM, 0, 0);

            const endTime = new Date(today);
            endTime.setHours(endH, endM, 0, 0);
            
            // Handle cross-day schedule (e.g., 23:00 to 01:00). Assuming start < end for simplicity for now.
            // If the user wants cross-day, 00:00-08:00 would be the start-end of the day period.
            
            const isWithinSchedule = now >= startTime && now <= endTime;
            const newPausedState = !isWithinSchedule;

            if (newPausedState !== isPaused) {
                 const classRef = doc(db, CLASS_COLLECTION_PATH, CLASS_ID);
                 await updateDoc(classRef, { isPaused: newPausedState });
            }
        }
        
        /**
         * NEW: Updates the hand raise button icon and text.
         */
        const updateHandRaiseButtonUI = () => {
             const toggleBtn = document.getElementById('hand-raise-toggle-btn');
             const toggleIcon = document.getElementById('hand-raise-toggle-icon');
             
             if (isPaused) {
                 // Paused: Show play/resume icon (triangle)
                 toggleBtn.classList.remove('bg-green-100', 'text-green-600');
                 toggleBtn.classList.add('bg-gray-200', 'text-gray-600');
                 toggleIcon.innerHTML = `
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 fill-current">
                         <polygon points="5 3 19 12 5 21 5 3"></polygon>
                     </svg>
                 `;
             } else {
                 // Active: Show pause icon (double bar)
                 toggleBtn.classList.remove('bg-gray-200', 'text-gray-600');
                 toggleBtn.classList.add('bg-green-100', 'text-green-600');
                 toggleIcon.innerHTML = `
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 fill-current">
                         <rect x="6" y="4" width="4" height="16"></rect>
                         <rect x="14" y="4" width="4" height="16"></rect>
                     </svg>
                 `;
             }
        }

        /**
         * NEW: Updates the teacher's browser tab title with the unanswered count.
         * @param {number} count - Number of unanswered requests.
         */
        const updateTitleBarNotification = (count) => {
            const baseTitle = 'Notify | Dashboard';
            if (count > 0) {
                document.title = `(${count}) ${baseTitle}`;
            } else {
                document.title = baseTitle;
            }
        };

        // --- Class & Request CRUD Functions ---

        /**
         * NEW: Student submits a new request.
         */
        window.submitRequest = async () => {
            if (!db || !userId) return;
            const text = document.getElementById('request-text-input').value.trim();
            if (!text) {
                alert('Please enter your request.');
                return;
            }
            
            closeRequestModal();
            
            try {
                await addDoc(collection(db, REQUEST_COLLECTION_PATH), {
                    classId: CLASS_ID,
                    studentId: userId,
                    requestText: text,
                    status: 'Unanswered', // New status field
                    comment: null,
                    timestamp: Timestamp.fromDate(new Date())
                });
                alert('Request submitted successfully!');
            } catch (e) {
                console.error("Error adding document: ", e);
                alert('Failed to submit request.');
            }
        }
        
        /**
         * NEW: Teacher/Co-Teacher accepts a request.
         * @param {string} requestId 
         */
        window.acceptRequest = async (requestId) => {
            if (!db || !(isTeacher || isCoTeacher)) return;
            const requestRef = doc(db, REQUEST_COLLECTION_PATH, requestId);
            try {
                await updateDoc(requestRef, {
                    status: 'Accepted',
                    resolvedBy: userId,
                    resolvedAt: Timestamp.fromDate(new Date())
                });
            } catch (e) {
                console.error("Error accepting request: ", e);
            }
        };

        /**
         * NEW: Teacher/Co-Teacher denies a request.
         * @param {string} requestId 
         */
        window.denyRequest = async (requestId) => {
            if (!db || !(isTeacher || isCoTeacher)) return;
            const requestRef = doc(db, REQUEST_COLLECTION_PATH, requestId);
            try {
                await updateDoc(requestRef, {
                    status: 'Denied',
                    resolvedBy: userId,
                    resolvedAt: Timestamp.fromDate(new Date())
                });
            } catch (e) {
                console.error("Error denying request: ", e);
            }
        };

        /**
         * NEW: Teacher/Co-Teacher comments on a request.
         * @param {string} requestId 
         * @param {string} currentComment 
         * @param {boolean} isEdit 
         */
        window.commentRequest = (requestId, currentComment = '', isEdit = false) => {
            if (!db || !(isTeacher || isCoTeacher)) return;
            
            document.getElementById('modal-title').textContent = isEdit ? 'Edit Comment' : 'Add Comment';
            document.getElementById('modal-content').innerHTML = `
                <textarea id="comment-input" class="w-full h-24 p-2 border rounded-lg resize-none" placeholder="Enter your comment...">${currentComment}</textarea>
            `;
            document.getElementById('modal-action-btn').textContent = isEdit ? 'Save Edit' : 'Add Comment';
            document.getElementById('modal-action-btn').onclick = async () => {
                const newComment = document.getElementById('comment-input').value.trim();
                if (newComment) {
                     const requestRef = doc(db, REQUEST_COLLECTION_PATH, requestId);
                     await updateDoc(requestRef, {
                        status: 'Commented',
                        comment: newComment,
                        commentedBy: userId,
                        commentedAt: Timestamp.fromDate(new Date())
                    });
                    closeModal();
                } else {
                    alert("Comment cannot be empty.");
                }
            };
            document.getElementById('modal-container').classList.remove('hidden');
        };

         /**
         * NEW: Teacher/Co-Teacher deletes a comment.
         * @param {string} requestId 
         */
        window.deleteComment = (requestId) => {
            if (!db || !(isTeacher || isCoTeacher)) return;
            
            document.getElementById('modal-title').textContent = 'Confirm Delete';
            document.getElementById('modal-content').innerHTML = `
                <p>Are you sure you want to delete this comment? The request will return to "Unanswered" status.</p>
            `;
            document.getElementById('modal-action-btn').textContent = 'Delete';
            document.getElementById('modal-action-btn').classList.remove('bg-blue-600', 'hover:bg-blue-700');
            document.getElementById('modal-action-btn').classList.add('bg-red-600', 'hover:bg-red-700');
            document.getElementById('modal-action-btn').onclick = async () => {
                 const requestRef = doc(db, REQUEST_COLLECTION_PATH, requestId);
                 await updateDoc(requestRef, {
                    status: 'Unanswered', // Reset status
                    comment: null,
                    commentedBy: null,
                    commentedAt: null
                });
                closeModal();
            };
            document.getElementById('modal-container').classList.remove('hidden');
        };


        // --- Display & Listeners ---

        /**
         * Renders the list of requests for the given view (Teacher or Student).
         * @param {Array<Object>} requests - List of request objects.
         * @param {boolean} isTeacherView - True if rendering for teacher/co-teacher.
         */
        const displayRequests = (requests, isTeacherView) => {
            const listId = isTeacherView ? 'request-list-teacher' : 'request-list-student';
            const noMessageId = isTeacherView ? 'no-requests-message-teacher' : 'no-requests-message-student';
            const listEl = document.getElementById(listId);
            listEl.innerHTML = '';
            
            if (requests.length === 0) {
                 document.getElementById(noMessageId).style.display = 'block';
                 listEl.appendChild(document.getElementById(noMessageId));
                 return;
            }
            document.getElementById(noMessageId).style.display = 'none';

            requests.forEach(req => {
                const statusColor = {
                    'Accepted': 'border-green-500', 
                    'Denied': 'border-red-500', 
                    'Commented': 'border-yellow-500', 
                    'Unanswered': 'border-blue-500'
                }[req.status] || 'border-gray-300';
                
                const timeString = req.timestamp?.toDate().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) || 'Unknown Time';

                let actionsHtml = '';

                if (isTeacherView) {
                    // NEW: Teacher/Co-Teacher action buttons
                    if (req.status === 'Unanswered') {
                        actionsHtml = `
                            <div class="flex space-x-2 h-full">
                                <button onclick="acceptRequest('${req.id}')" class="squircle-btn w-12 h-12 bg-green-500 text-white hover:bg-green-600 transition-colors" title="Accept">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M20 6 9 17l-5-5"/></svg>
                                </button>
                                <button onclick="commentRequest('${req.id}', '')" class="squircle-btn w-12 h-12 bg-white text-gray-400 hover:bg-gray-100 transition-colors border border-gray-200" title="Add Comment">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                                </button>
                                <button onclick="denyRequest('${req.id}')" class="squircle-btn w-12 h-12 bg-red-500 text-white hover:bg-red-600 transition-colors" title="Deny">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                                </button>
                            </div>
                        `;
                    } else if (req.status === 'Commented') {
                        // Split Comment Button
                        actionsHtml = `
                            <div class="split-button w-12 h-full bg-white border border-gray-300">
                                <button onclick="commentRequest('${req.id}', '${req.comment.replace(/'/g, "\\'")}', true)" class="text-xs font-semibold text-blue-600 hover:bg-blue-50 transition-colors" title="Edit Comment">
                                    Edit
                                </button>
                                <button onclick="deleteComment('${req.id}')" class="text-xs font-semibold text-red-600 hover:bg-red-50 transition-colors" title="Delete Comment">
                                    Delete
                                </button>
                            </div>
                        `;
                    } else {
                         // Resolved states (Accepted/Denied) - just show resolution info
                         actionsHtml = `<div class="text-xs text-gray-500 flex flex-col items-end">
                            <span class="font-semibold">${req.status}</span>
                            <span>By: ${req.resolvedBy.substring(0, 4)}...</span>
                        </div>`;
                    }
                } else {
                    // Student View: Show status
                    actionsHtml = `<span class="text-sm font-semibold">${req.status}</span>`;
                }

                const commentDisplay = req.comment ? `<p class="text-sm text-gray-600 mt-2 p-2 bg-gray-100 rounded-lg"><strong>Comment:</strong> ${req.comment}</p>` : '';

                const requestCard = document.createElement('div');
                requestCard.className = `p-4 bg-white rounded-xl shadow-lg border-l-4 ${statusColor}`;
                requestCard.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-base font-medium text-gray-800">${req.requestText}</p>
                            ${isTeacherView ? `<p class="text-xs text-gray-500 mt-1">Student: ${req.studentId.substring(0, 8)}</p>` : ''}
                        </div>
                        <div class="flex flex-col items-end space-y-1">
                            <span class="text-sm font-semibold text-gray-700">${timeString}</span>
                            ${actionsHtml}
                        </div>
                    </div>
                    ${commentDisplay}
                `;
                listEl.appendChild(requestCard);
            });
        };
        
        /**
         * Helper to get Firestore query for requests based on the current filter and user role.
         * @returns {Query}
         */
        const getRequestQuery = () => {
             const baseRef = collection(db, REQUEST_COLLECTION_PATH);
             let q = query(baseRef, where('classId', '==', CLASS_ID));
             
             // 1. Filter by Today (for both roles)
             const startOfToday = new Date();
             startOfToday.setHours(0, 0, 0, 0);
             q = query(q, where('timestamp', '>=', Timestamp.fromDate(startOfToday)));

             // 2. Filter by Student ID (for student view)
             if (!isTeacher && !isCoTeacher) {
                 q = query(q, where('studentId', '==', userId));
             }

             // 3. Filter by Status (for both roles)
             if (currentFilter === 'Unanswered') {
                q = query(q, where('status', '==', 'Unanswered'));
             } else if (currentFilter === 'Accepted') {
                 q = query(q, where('status', '==', 'Accepted'));
             } else if (currentFilter === 'Denied') {
                 q = query(q, where('status', '==', 'Denied'));
             } else if (currentFilter === 'Commented') {
                 q = query(q, where('status', '==', 'Commented'));
             }

             // Ensure order by timestamp for queue/history
             // NOTE: Firestore requires an index for this combination, but we proceed assuming one exists or JS sorting is fallback.
             // q = query(q, orderBy('timestamp', 'asc')); 
             
             return q;
        }

        /**
         * Sets up the real-time listener for Teacher/Co-Teacher requests.
         */
        const listenForTeacherRequests = () => {
            if (!db) return;
            
            // Listener for the current filtered queue
            const queueQuery = getRequestQuery();
            onSnapshot(queueQuery, (snapshot) => {
                const requests = [];
                snapshot.forEach(doc => requests.push({ id: doc.id, ...doc.data() }));
                
                // Sort by timestamp if not handled by Firestore index (newest first for teacher queue)
                requests.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)); 

                displayRequests(requests, true);
            }, (error) => console.error("Error listening to teacher queue:", error));
            
            // NEW: Listener for ALL Unanswered requests to update the title bar
            const unansweredQuery = query(collection(db, REQUEST_COLLECTION_PATH), 
                where('classId', '==', CLASS_ID), 
                where('status', '==', 'Unanswered')
            );
             onSnapshot(unansweredQuery, (snapshot) => {
                 updateTitleBarNotification(snapshot.size);
            }, (error) => console.error("Error listening to unanswered for title bar:", error));
        };
        
        /**
         * Sets up the real-time listener for Student's requests.
         */
        const listenForStudentRequests = () => {
            if (!db || !userId) return;

             const studentQuery = getRequestQuery();
             onSnapshot(studentQuery, (snapshot) => {
                const requests = [];
                snapshot.forEach(doc => requests.push({ id: doc.id, ...doc.data() }));
                
                // Sort by timestamp (newest first for student history)
                requests.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)); 
                
                displayRequests(requests, false);
            }, (error) => console.error("Error listening to student requests:", error));
        };


        // --- Settings & Auth Logic ---
        
        /**
         * NEW: Saves the class schedule to Firestore.
         */
        window.saveSchedule = async () => {
            if (!db || !(isTeacher || isCoTeacher)) return;
            
            const startInput = document.getElementById('schedule-start-time');
            const endInput = document.getElementById('schedule-end-time');
            
            const start = startInput.value;
            const end = endInput.value;
            const messageEl = document.getElementById('schedule-message');
            
            // Basic format validation (should be handled by input listeners, but safety check)
            if (!/^\d{2}:\d{2}$/.test(start) || !/^\d{2}:\d{2}$/.test(end)) {
                 messageEl.textContent = 'Invalid time format (must be HH:MM).';
                 messageEl.classList.remove('text-green-600');
                 messageEl.classList.add('text-red-600');
                 return;
            }

            const classRef = doc(db, CLASS_COLLECTION_PATH, CLASS_ID);
            try {
                // Ensure class exists and update/create schedule field
                await setDoc(classRef, {
                    schedule: { start, end }
                }, { merge: true });
                messageEl.textContent = `Schedule saved! Class is active from ${start} to ${end}.`;
                messageEl.classList.remove('text-red-600');
                messageEl.classList.add('text-green-600');
            } catch (e) {
                console.error("Error saving schedule:", e);
                messageEl.textContent = 'Failed to save schedule.';
                messageEl.classList.remove('text-green-600');
                messageEl.classList.add('text-red-600');
            }
        };
        
        /**
         * NEW: Saves student's local class name to localStorage.
         */
        window.saveLocalClassName = () => {
            const input = document.getElementById('local-class-name-input');
            const messageEl = document.getElementById('local-name-message');
            const localName = input.value.trim();
            
            if (localName) {
                localStorage.setItem(`notify_local_class_name_${CLASS_ID}`, localName);
                document.getElementById('class-title-display').textContent = `${localName} (ID: ${CLASS_ID})`;
                messageEl.textContent = 'Local class name saved successfully!';
                messageEl.classList.remove('text-red-600');
                messageEl.classList.add('text-green-600');
            } else {
                 localStorage.removeItem(`notify_local_class_name_${CLASS_ID}`);
                 document.getElementById('class-title-display').textContent = `${classData?.className || 'Class Name'} (ID: ${CLASS_ID})`;
                 messageEl.textContent = 'Local class name cleared.';
                 messageEl.classList.remove('text-red-600');
                 messageEl.classList.add('text-green-600');
            }
        };

        /**
         * NEW: Confirms and executes leaving the class (Student Only).
         */
        window.confirmLeaveClass = () => {
            if (!db || isTeacher || isCoTeacher) return;
            
            document.getElementById('modal-title').textContent = 'Confirm Leave Class';
            document.getElementById('modal-content').innerHTML = `
                <p>Are you sure you want to leave <strong>${classData?.className || 'this class'}</strong>?</p>
                <p class="text-sm text-red-500 mt-2">You will need a new invite link to rejoin.</p>
            `;
            document.getElementById('modal-action-btn').textContent = 'Leave Class';
            document.getElementById('modal-action-btn').classList.remove('bg-blue-600', 'hover:bg-blue-700');
            document.getElementById('modal-action-btn').classList.add('bg-red-600', 'hover:bg-red-700');
            document.getElementById('modal-action-btn').onclick = async () => {
                // In a real app, this would involve deleting the user's membership record.
                // For this structure, we'll just sign them out and clear local data.
                closeModal();
                try {
                    localStorage.removeItem(`notify_local_class_name_${CLASS_ID}`);
                    await signOut(auth);
                    // The onAuthStateChanged listener will handle the UI update (reload or show signup)
                } catch (e) {
                    console.error("Error leaving class:", e);
                    alert("Could not leave class due to an error.");
                }
            };
            document.getElementById('modal-container').classList.remove('hidden');
        };

        /**
         * Confirms and executes class deletion (Teacher Only - Owner).
         */
        window.confirmDeleteClass = () => {
            if (!db || !isTeacher) return; // Only true owner can delete
            
            document.getElementById('modal-title').textContent = 'Confirm Class Deletion';
            document.getElementById('modal-content').innerHTML = `
                <p class="font-bold text-red-600">WARNING: This action is permanent.</p>
                <p>Are you absolutely sure you want to delete the class <strong>${classData?.className || 'this class'}</strong>?</p>
            `;
            document.getElementById('modal-action-btn').textContent = 'DELETE PERMANENTLY';
            document.getElementById('modal-action-btn').classList.remove('bg-blue-600', 'hover:bg-blue-700');
            document.getElementById('modal-action-btn').classList.add('bg-red-600', 'hover:bg-red-700');
            document.getElementById('modal-action-btn').onclick = async () => {
                closeModal();
                try {
                    // Delete the class document
                    await deleteDoc(doc(db, CLASS_COLLECTION_PATH, CLASS_ID));
                    
                    // In a real app, you would also delete all related requests, coTeachers, etc.
                    
                    // After deletion, sign out the user
                    await signOut(auth);
                    // UI will reload or redirect
                    alert("Class deleted successfully.");
                } catch (e) {
                    console.error("Error deleting class:", e);
                    alert("Failed to delete class. Check console for details.");
                }
            };
            document.getElementById('modal-container').classList.remove('hidden');
        };

        /**
         * Main initialization logic.
         */
        const init = async () => {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 1. Initial Authentication
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // 2. Auth State Listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = userId.substring(0, 8) + '...';

                        const classRef = doc(db, CLASS_COLLECTION_PATH, CLASS_ID);
                        
                        // Set up a real-time listener for class data
                        onSnapshot(classRef, (docSnap) => {
                            if (docSnap.exists()) {
                                classData = docSnap.data();
                                const classOwnerId = classData.ownerId;
                                const coTeachers = classData.coTeachers || [];

                                // Determine user role
                                isTeacher = userId === classOwnerId; // The actual class owner
                                isCoTeacher = coTeachers.includes(userId) && userId !== classOwnerId; // A co-teacher but not the owner

                                // Update class info
                                const localName = localStorage.getItem(`notify_local_class_name_${CLASS_ID}`);
                                document.getElementById('class-id-display').textContent = CLASS_ID;
                                document.getElementById('class-title-display').textContent = `${localName || classData.className || 'Class Name'} (ID: ${CLASS_ID})`;
                                
                                // Update user role display
                                let role = 'Student';
                                if (isTeacher) {
                                    role = 'Teacher (Owner)';
                                } else if (isCoTeacher) {
                                    role = 'Co-Teacher';
                                }
                                document.getElementById('user-role-display').textContent = role;

                                // Update Hand Raise State (NEW: Listen to DB)
                                isPaused = classData.isPaused !== undefined ? classData.isPaused : true; // Default to true if not set
                                updateHandRaiseButtonUI();
                                
                                // Check and run schedule automation (Teacher/Co-Teacher only)
                                if (isTeacher || isCoTeacher) {
                                    if (classData.schedule) {
                                         // Update schedule inputs in settings
                                        document.getElementById('schedule-start-time').value = classData.schedule.start;
                                        document.getElementById('schedule-end-time').value = classData.schedule.end;
                                        checkScheduleAndSetHandRaising(classData.schedule);
                                        // Set an interval to run this check every minute
                                        // Note: For a true background service, a server is required, but this is a browser-side compromise.
                                        setInterval(() => checkScheduleAndSetHandRaising(classData.schedule), 60000); 
                                    }
                                }

                                // Update Settings UI based on role
                                document.getElementById('teacher-settings-section').classList.toggle('hidden', !(isTeacher || isCoTeacher));
                                document.getElementById('student-settings-section').classList.toggle('hidden', (isTeacher || isCoTeacher));
                                
                                // NEW: Co-Teacher Restriction
                                document.getElementById('delete-class-btn').classList.toggle('hidden', !isTeacher);
                                document.getElementById('delete-class-message').classList.toggle('hidden', isTeacher);


                                // Final UI setup after class data is loaded
                                document.getElementById('app-container').classList.remove('hidden');
                                document.getElementById('loading-screen').classList.add('hidden');
                                
                                document.getElementById('hand-raise-toggle-btn').classList.toggle('hidden', !(isTeacher || isCoTeacher));
                                document.getElementById('teacher-menu-buttons').classList.toggle('hidden', !(isTeacher || isCoTeacher));
                                
                                // Show the initial screen and start listeners
                                if (!isAuthReady) {
                                    if (isTeacher || isCoTeacher) {
                                        showScreen('main-content-teacher');
                                        listenForTeacherRequests();
                                    } else {
                                        showScreen('main-content-student');
                                        listenForStudentRequests();
                                    }
                                    isAuthReady = true;
                                    setFilter('Unanswered'); // Apply default filter
                                    
                                    // Load local class name for student settings
                                    if (!isTeacher && !isCoTeacher) {
                                        document.getElementById('local-class-name-input').value = localName || '';
                                    }
                                }
                            } else {
                                // Class doesn't exist (e.g., deleted), log out.
                                await signOut(auth);
                                alert("Class not found. Signing out.");
                            }
                        }, (error) => console.error("Error listening to class data:", error));

                    } else {
                        // User logged out/no user. Show login/signup screen (or just a message).
                        document.getElementById('loading-screen').innerHTML = '<div class="text-xl font-medium text-red-500">You are logged out or the initial token was invalid. Please restart the environment.</div>';
                        document.getElementById('loading-screen').classList.remove('hidden');
                        document.getElementById('app-container').classList.add('hidden');
                        userId = null;
                        isTeacher = false;
                        isCoTeacher = false;
                        isAuthReady = false;
                    }
                });

            } catch (error) {
                console.error("Initialization Error:", error);
                document.getElementById('loading-screen').innerHTML = `<div class="text-xl font-medium text-red-500">Error initializing: ${error.message}</div>`;
            }
        };
        
        // Time Input Formatting (Keep existing logic)
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.time-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    let currentDigits = (e.target.value.replace(/[^0-9]/g, '')).substring(0, 4);

                    // Logic to handle auto-advancing and digit limits
                    if (e.inputType === 'deleteContentBackward') {
                         // Allow backspace
                    } else if (e.data && /[0-9]/.test(e.data)) {
                        // If user is typing
                        if (currentDigits.length > input.dataset.digits.length) {
                             if (currentDigits.length === 1 && parseInt(currentDigits, 10) > 1) {
                                 // Auto-pad single large digit in hour to 2 digits
                                currentDigits = `0${currentDigits}`;
                            } else if (currentDigits.length === 3 && parseInt(currentDigits.substring(2, 3), 10) > 5) {
                                // Auto-pad single large digit in minute to 2 digits
                                currentDigits = `${currentDigits.substring(0, 2)}0${currentDigits.substring(2, 3)}`;
                            }
                        }
                    } else if (e.inputType === 'insertText' && e.data === ':') {
                         // Ignore explicit colon input
                        e.preventDefault();
                    }
                    
                    input.dataset.digits = currentDigits;
                    const padded = currentDigits.padStart(4, '0');

                    let h_str = padded.slice(0, 2);
                    let m_str = padded.slice(2, 4);
                    
                    // Constrain hours to 1-12 (assuming 12-hour format based on old code)
                    if (parseInt(h_str, 10) > 12) h_str = '12';
                    if (parseInt(h_str, 10) === 0) h_str = '00';
                    // Constrain minutes to 0-59
                    if (parseInt(m_str, 10) > 59) m_str = '59';

                    const formattedValue = `${h_str}:${m_str}`;
                    if (input.value !== formattedValue) {
                        input.value = formattedValue;
                    }
                });

                input.addEventListener('blur', (e) => {
                    let [h, m] = e.target.value.split(':').map(Number);
                    if (isNaN(h) || h < 1 || h > 12) h = 12;
                    if (isNaN(m) || m < 0 || m > 59) m = 0;
                    const finalValue = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    e.target.value = finalValue;
                    input.dataset.digits = finalValue.replace(':', '');
                });
            });
            
            // NEW: Add click handler for the student's request plus button
            if (document.getElementById('settings-btn') && document.getElementById('queue-btn')) {
                 const studentQueueContent = document.getElementById('main-content-student');
                 const studentPlusBtn = document.createElement('button');
                 studentPlusBtn.id = 'new-request-btn';
                 // Blue plus button style (matching other buttons)
                 studentPlusBtn.className = 'w-14 h-14 bg-blue-600 text-white hover:bg-blue-700 transition-colors squircle-btn absolute bottom-6 right-6 z-10 hidden';
                 studentPlusBtn.setAttribute('onclick', 'openRequestModal()');
                 studentPlusBtn.innerHTML = `
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                         <path d="M12 5v14"/><path d="M5 12h14"/>
                     </svg>
                 `;
                 
                 // Append the plus button to the main student content area, visible only on the queue screen
                 studentQueueContent.parentElement.appendChild(studentPlusBtn);
                 
                 // Observer to show/hide the button when the student queue is active
                 const observer = new MutationObserver((mutationsList, observer) => {
                    for(const mutation of mutationsList) {
                        if (mutation.attributeName === 'style') {
                            const isVisible = studentQueueContent.style.display !== 'none';
                            studentPlusBtn.classList.toggle('hidden', !isVisible);
                        }
                    }
                 });
                 observer.observe(studentQueueContent, { attributes: true });
            }

            init(); // Start the Firebase application
        });
    </script>
</body>
</html>
