<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notify | Dashboard</title>
    
    <!-- Load Tailwind CSS and Inter Font -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Load Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        .time-input {
            transition: all 0.2s;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Global Message Box -->
    <div id="message-box" class="fixed top-5 right-5 z-50 transition-transform duration-500 transform translate-x-full">
        <!-- Messages appear here -->
    </div>

    <!-- Modals Container -->
    <div id="modals-container">
        <!-- Modals for Comment, Create Request, Confirm Delete, etc., will be dynamically inserted here -->
    </div>

    <!-- Top Bar -->
    <header class="bg-white shadow-md p-4 sticky top-0 z-20">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <h1 class="text-2xl font-bold text-gray-800">Notify</h1>
                <p id="class-info" class="text-gray-500 font-medium">Class ID: Loading...</p>
            </div>

            <!-- Main Navigation Buttons -->
            <div id="main-nav-buttons" class="flex items-center space-x-3 text-lg font-medium">
                <button id="requests-btn" data-view="requests" class="nav-btn bg-blue-600 text-white rounded-xl px-4 py-2 transition-colors duration-300">Requests</button>
                <button id="students-btn" data-view="students" class="nav-btn text-gray-700 hover:bg-gray-100 rounded-xl px-4 py-2 transition-colors duration-300">Students</button>
                <button id="settings-btn" data-view="settings" class="nav-btn text-gray-700 hover:bg-gray-100 rounded-xl px-4 py-2 transition-colors duration-300">Settings</button>
            </div>
            
            <!-- Dynamic Role-Based Actions -->
            <div class="flex items-center space-x-4">
                <!-- Teacher/Co-Teacher Hand Raising Pause/Resume Button (Dynamic Icon/Color) -->
                <button id="teacher-pause-resume-btn" onclick="toggleHandRaisingPause()" title="Pause/Resume Hand Raising" class="hidden w-16 h-16 sm:w-20 sm:h-20 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-2xl shadow-lg transition-all duration-300 transform hover:scale-105">
                    <!-- Icon will be set by JS (fa-hand-raised or fa-pause) -->
                    <i id="hand-icon" class="fa-solid fa-hand-raised text-2xl sm:text-3xl text-blue-600"></i>
                </button>
                
                <!-- Student View: Request (+) and Settings -->
                <div id="student-actions" class="hidden flex items-center space-x-3">
                    <button id="student-new-request-btn" title="Make a New Request" class="w-16 h-16 sm:w-20 sm:h-20 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl shadow-lg transition-all duration-300 transform hover:scale-105" onclick="showCreateRequestModal()">
                        <i class="fa-solid fa-plus text-2xl sm:text-3xl"></i>
                    </button>
                    <button id="student-settings-btn" title="Personal Settings" onclick="showStudentSettings()" class="w-16 h-16 sm:w-20 sm:h-20 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-2xl shadow-lg transition-all duration-300 transform hover:scale-105">
                        <i class="fa-solid fa-gear text-2xl sm:text-3xl"></i>
                    </button>
                </div>
                
                <!-- User Profile Placeholder -->
                <div id="user-profile" class="text-gray-600">
                    <i class="fa-solid fa-user-circle text-2xl"></i>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Requests Section -->
        <section id="requests-section" class="space-y-6">
            <h2 class="text-3xl font-extrabold text-gray-800">Class Requests</h2>
            
            <!-- Request Filtering Buttons -->
            <div id="request-filters" class="flex flex-wrap gap-2 p-3 bg-white rounded-xl shadow-inner border border-gray-100">
                <button data-status="Unanswered" class="filter-btn bg-blue-600 text-white font-semibold rounded-lg px-4 py-2 text-sm transition-colors duration-200 shadow">Unanswered</button>
                <button data-status="Accepted" class="filter-btn text-gray-700 hover:bg-gray-100 rounded-lg px-4 py-2 text-sm transition-colors duration-200">Accepted</button>
                <button data-status="Denied" class="filter-btn text-gray-700 hover:bg-gray-100 rounded-lg px-4 py-2 text-sm transition-colors duration-200">Denied</button>
                <button data-status="Commented on" class="filter-btn text-gray-700 hover:bg-gray-100 rounded-lg px-4 py-2 text-sm transition-colors duration-200">Commented on</button>
            </div>

            <!-- Requests List -->
            <div id="requests-list" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                <p class="text-center text-gray-500 col-span-full">Loading requests...</p>
            </div>
        </section>

        <!-- Students Section (Hidden by Default) -->
        <section id="students-section" class="hidden space-y-6">
            <h2 class="text-3xl font-extrabold text-gray-800">Class Students</h2>
            <div id="students-list" class="grid gap-4 md:grid-cols-3 lg:grid-cols-4">
                <!-- Student cards will be populated here -->
                <p class="text-center text-gray-500 col-span-full">Loading students...</p>
            </div>
        </section>

        <!-- Settings Section (Hidden by Default) -->
        <section id="settings-section" class="hidden space-y-6">
            <h2 class="text-3xl font-extrabold text-gray-800">Class Settings</h2>

            <!-- Main Settings Menu -->
            <div id="main-settings-menu" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                
                <!-- Schedule Settings Card -->
                <div onclick="showScheduleSettings()" class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 cursor-pointer hover:shadow-xl transition-shadow duration-300">
                    <div class="flex items-center space-x-3 mb-2">
                        <i class="fa-solid fa-calendar-alt text-xl text-indigo-500"></i>
                        <h3 class="text-xl font-semibold text-gray-800">Schedule Management</h3>
                    </div>
                    <p class="text-gray-600">Set class times for automatic hand-raising control.</p>
                </div>
                
                <!-- Other settings cards go here -->

                <!-- Delete Class Button (Teacher Only) -->
                <button id="delete-class-btn" onclick="confirmDeleteClass()" class="hidden bg-red-500 text-white font-semibold p-4 rounded-xl shadow-lg hover:bg-red-600 transition-colors duration-300">
                    Delete Class (Teacher Only)
                </button>
            </div>
            
            <!-- Schedule Settings Sub-View (Hidden by default) -->
            <div id="schedule-view" class="p-6 bg-white rounded-xl shadow-lg hidden">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">Class Schedule</h3>
                <p class="text-gray-600 mb-6 border-l-4 border-blue-200 pl-3 py-1">Hand raising is **automatically enabled** during this period, and **paused** outside of it.</p>
                
                <div class="space-y-6 max-w-sm">
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <label for="schedule-start-time" class="block text-base font-medium text-gray-700 mb-2">Start Time (HH:MM)</label>
                        <input type="text" id="schedule-start-time" placeholder="08:30" data-digits="" maxlength="5" class="time-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-xl tracking-wider">
                    </div>

                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <label for="schedule-end-time" class="block text-base font-medium text-gray-700 mb-2">End Time (HH:MM)</label>
                        <input type="text" id="schedule-end-time" placeholder="15:00" data-digits="" maxlength="5" class="time-input w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-xl tracking-wider">
                    </div>
                </div>
                
                <button onclick="saveSchedule()" class="mt-8 px-8 py-3 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700 transition-colors shadow-md transform hover:scale-[1.01]">Save Schedule</button>
            </div>

        </section>
        
    </main>
    
    <!-- FOOTER PLACEHOLDER (optional) -->


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, query, where, addDoc, serverTimestamp, deleteField, getDoc,
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // Set log level to debug for detailed console output
        setLogLevel('debug');

        // --- Global Variables (Mandatory Canvas/Firebase setup) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, db, auth;
        let classId = 'defaultClassId'; // Will be set on initialization
        let userRole = 'Student'; // 'Teacher', 'Co-Teacher', or 'Student'
        let currentHandRaisingState = true; // true = enabled, false = paused
        let activeView = 'requests'; // 'requests', 'students', 'settings'
        let currentRequestFilter = 'Unanswered';
        let scheduleInterval;
        let currentUnansweredCount = 0;
        
        window.requestsData = [];
        window.studentsData = [];
        
        const REQUEST_STATUSES = {
            UNANSWERED: 'Unanswered',
            ACCEPTED: 'Accepted',
            DENIED: 'Denied',
            COMMENTED_ON: 'Commented on'
        };
        
        // --- Utility Functions for Firestore Paths ---
        const CLASS_DOC_PATH = (appId) => `artifacts/${appId}/public/data/classes/${classId}`;
        const REQUESTS_COL_PATH = (appId) => `artifacts/${appId}/public/data/requests`;
        const STUDENTS_COL_PATH = (appId) => `artifacts/${appId}/public/data/students`; // Storing students globally for easy lookup
        
        // --- UI Message and Modal Handlers ---

        function showMessage(message, type = 'success') {
            const box = document.getElementById('message-box');
            if (!box) return;
            
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'warning' ? 'bg-yellow-500' : 'bg-red-500';
            const html = `
                <div class="${bgColor} text-white p-3 rounded-lg shadow-xl mb-3 transform transition-all duration-300 opacity-0 scale-95" role="alert">
                    <p class="font-semibold">${message}</p>
                </div>
            `;
            box.insertAdjacentHTML('afterbegin', html);
            
            const newMessage = box.querySelector('div');
            setTimeout(() => {
                newMessage.classList.remove('opacity-0', 'scale-95');
                newMessage.classList.add('opacity-100', 'scale-100');
            }, 10);

            setTimeout(() => {
                newMessage.classList.remove('opacity-100', 'scale-100');
                newMessage.classList.add('opacity-0', 'scale-95');
                newMessage.addEventListener('transitionend', () => newMessage.remove());
            }, 5000);
        }

        function showModal(id, content) {
            const modalsContainer = document.getElementById('modals-container');
            const modalHtml = `
                <div id="${id}" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300">
                    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full transform transition-transform duration-300 scale-95">
                        ${content}
                    </div>
                </div>
            `;
            modalsContainer.innerHTML = modalHtml;
            setTimeout(() => {
                document.getElementById(id).classList.add('opacity-100');
                document.querySelector(`#${id} > div`).classList.remove('scale-95');
            }, 10);
        }

        function hideModal(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.classList.remove('opacity-100');
                document.querySelector(`#${id} > div`).classList.add('scale-95');
                modal.addEventListener('transitionend', () => modal.remove(), { once: true });
            }
        }
        
        // --- Time Utility Functions for Schedule ---

        function getCurrentTimeAsMinutes() {
            const now = new Date();
            return now.getHours() * 60 + now.getMinutes();
        }

        function parseTimeInputToMinutes(timeString) {
            if (!timeString || timeString.indexOf(':') === -1) return -1;
            const [hStr, mStr] = timeString.split(':');
            const h = parseInt(hStr, 10);
            const m = parseInt(mStr, 10);
            
            if (isNaN(h) || isNaN(m)) return -1;

            // This logic is based on the 12-hour input format (HH:MM from 01:00 to 12:59)
            // To compare with 24h current minutes, we assume a typical school day 
            // where all times are between 6:00 AM (360) and 10:00 PM (1320).
            let h_24 = h;
            if (h === 12) h_24 = 0; // Treat 12:XX as 00:XX temporarily
            
            let minutes_from_midnight = h_24 * 60 + m;
            
            // Adjust based on typical school hours (8 AM to 4 PM is most common)
            // If the time is < 8:00 (e.g., 1:00), assume it's 1:00 PM (afternoon class)
            if (minutes_from_midnight < 8 * 60) { 
                minutes_from_midnight += 12 * 60; // Convert to PM
            }
            // If the adjusted time is greater than 20:00 (8 PM), revert to AM.
            if (minutes_from_midnight > 20 * 60) {
                 minutes_from_midnight -= 12 * 60; 
            }
            
            return minutes_from_midnight; // This is a necessary simplification
        }

        // --- Core Application Logic ---

        // 1. Hand Raising & Schedule
        function updateHandRaisingButtonUI(isEnabled) {
            const btn = document.getElementById('teacher-pause-resume-btn');
            const icon = document.getElementById('hand-icon');
            if (!btn || !icon) return;
            
            currentHandRaisingState = isEnabled; // Update local state
            
            if (isEnabled) {
                icon.className = 'fa-solid fa-hand-raised text-2xl sm:text-3xl text-blue-600';
                btn.classList.remove('bg-gray-100');
                btn.classList.add('bg-white', 'border-2', 'border-blue-600');
            } else {
                icon.className = 'fa-solid fa-pause text-2xl sm:text-3xl text-gray-500';
                btn.classList.remove('bg-white', 'border-2', 'border-blue-600');
                btn.classList.add('bg-gray-100');
            }
        }

        async function toggleHandRaisingPause() {
            if (!db || !classId) return console.error('DB not initialized or classId missing.');
            if (userRole === 'Student') return showMessage('Only teachers and co-teachers can pause hand raising.', 'warning');

            const newStatus = !currentHandRaisingState;
            try {
                await updateDoc(doc(db, CLASS_DOC_PATH(appId)), {
                    isHandRaisingGloballyEnabled: newStatus
                });
                showMessage(`Hand raising ${newStatus ? 'resumed' : 'paused'} for the class.`);
            } catch (error) {
                console.error('Error toggling hand raising:', error);
                showMessage('Error: Could not toggle hand raising status.', 'error');
            }
        }
        
        async function checkAndApplySchedule(scheduleStart, scheduleEnd) {
            if (!scheduleStart || !scheduleEnd || userRole === 'Student') return;

            const currentMinutes = getCurrentTimeAsMinutes();
            const startMinutes = parseTimeInputToMinutes(scheduleStart);
            const endMinutes = parseTimeInputToMinutes(scheduleEnd);
            
            if (startMinutes === -1 || endMinutes === -1) return;

            let shouldBeEnabled = false;

            // Schedule logic: Enabled from start time (inclusive) up to end time (exclusive).
            if (startMinutes < endMinutes) {
                // E.g., 9:00 (540) to 11:00 (660). Current 10:00 (600) -> ON. Current 12:00 (720) -> OFF.
                shouldBeEnabled = (currentMinutes >= startMinutes && currentMinutes < endMinutes);
            } else {
                // Wrap-around case (e.g., 23:00 to 07:00). Not typical for school, but safer.
                // E.g., 23:00 (1380) to 01:00 (60). Current 00:00 (0) -> ON. Current 10:00 (600) -> OFF.
                shouldBeEnabled = (currentMinutes >= startMinutes || currentMinutes < endMinutes);
            }

            if (shouldBeEnabled && !currentHandRaisingState) {
                await updateDoc(doc(db, CLASS_DOC_PATH(appId)), { isHandRaisingGloballyEnabled: true });
                // showMessage('Automatic Schedule: Hand raising is now ON.'); // Too noisy
            } else if (!shouldBeEnabled && currentHandRaisingState) {
                await updateDoc(doc(db, CLASS_DOC_PATH(appId)), { isHandRaisingGloballyEnabled: false });
                // showMessage('Automatic Schedule: Hand raising is now OFF (Scheduled Pause).'); // Too noisy
            }
        }

        // 2. Schedule Management Functions
        async function saveSchedule() {
            if (userRole === 'Student') return showMessage('Students cannot modify the class schedule.', 'warning');
            
            const startInput = document.getElementById('schedule-start-time');
            const endInput = document.getElementById('schedule-end-time');
            const scheduleStart = startInput.value;
            const scheduleEnd = endInput.value;
            
            if (!scheduleStart || !scheduleEnd) {
                return showMessage('Please enter both start and end times for the schedule.', 'warning');
            }

            try {
                await setDoc(doc(db, CLASS_DOC_PATH(appId)), {
                    scheduleStart,
                    scheduleEnd
                }, { merge: true });
                showMessage('Class schedule saved successfully. Automatic hand raising is now active.');
            } catch (error) {
                console.error('Error saving schedule:', error);
                showMessage('Error: Could not save schedule.', 'error');
            }
        }

        // 3. Navigation and UI Switching
        function switchView(newView, isSubView = false) {
            activeView = newView;
            const sections = ['requests-section', 'students-section', 'settings-section'];
            const navBtns = document.querySelectorAll('.nav-btn');
            
            // 1. Reset all main buttons
            navBtns.forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white', 'font-bold');
                btn.classList.add('text-gray-700', 'hover:bg-gray-100');
                if (btn.dataset.view === 'settings') {
                    btn.textContent = 'Settings'; // Reset Settings button text
                }
            });

            // 2. Hide all main sections
            sections.forEach(id => {
                const section = document.getElementById(id);
                if (section) section.classList.add('hidden');
            });

            // 3. Set active view
            const activeSection = document.getElementById(`${newView}-section`);
            const activeBtn = document.querySelector(`.nav-btn[data-view="${newView}"]`);

            if (activeSection) activeSection.classList.remove('hidden');
            
            // 4. Style the active button
            if (activeBtn) {
                activeBtn.classList.remove('text-gray-700', 'hover:bg-gray-100');
                activeBtn.classList.add('bg-blue-600', 'text-white', 'font-bold');
            }

            // 5. Handle Sub-View (Home Button) logic
            const settingsBtn = document.getElementById('settings-btn');
            if (settingsBtn && newView === 'settings') {
                if (isSubView) {
                    settingsBtn.textContent = 'Home';
                    settingsBtn.onclick = () => {
                        // Hide sub-view, show main settings menu
                        document.getElementById('schedule-view').classList.add('hidden');
                        document.getElementById('main-settings-menu').classList.remove('hidden');
                        switchView('settings', false);
                    };
                } else {
                    settingsBtn.onclick = () => switchView('settings');
                }
            }
        }
        
        function showScheduleSettings() {
            document.getElementById('main-settings-menu').classList.add('hidden');
            document.getElementById('schedule-view').classList.remove('hidden');
            switchView('settings', true); // Switches to settings view and turns the button into Home
        }
        
        // 4. Student Actions
        
        function showStudentSettings() {
            const localName = localStorage.getItem(`notify_local_name_${classId}`) || '';
            const modalContent = `
                <h3 class="text-xl font-bold mb-4">Student Settings</h3>
                <div class="space-y-4">
                    <div>
                        <label for="local-name-input" class="block text-sm font-medium text-gray-700">Personal Class Name (Local)</label>
                        <input type="text" id="local-name-input" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="My Awesome Class" value="${localName}">
                    </div>
                    <button onclick="saveLocalClassName()" class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700 transition-colors">Save Local Name</button>
                    <button onclick="confirmLeaveClass()" class="w-full px-4 py-2 bg-red-600 text-white font-semibold rounded-xl hover:bg-red-700 transition-colors">Leave Class</button>
                </div>
            `;
            showModal('StudentSettingsModal', modalContent);
        }

        function saveLocalClassName() {
            const localName = document.getElementById('local-name-input').value.trim();
            if (localName) {
                localStorage.setItem(`notify_local_name_${classId}`, localName);
                showMessage('Local class name saved successfully!');
            } else {
                localStorage.removeItem(`notify_local_name_${classId}`);
                showMessage('Local class name cleared.');
            }
            hideModal('StudentSettingsModal');
        }

        function confirmLeaveClass() {
            showModal('ConfirmLeaveModal', `
                <h3 class="text-xl font-bold mb-4 text-red-600">Are you sure?</h3>
                <p class="mb-6">Leaving this class will remove your access. You will need a new invite code to rejoin.</p>
                <div class="flex justify-end space-x-3">
                    <button onclick="hideModal('ConfirmLeaveModal')" class="px-4 py-2 bg-gray-200 rounded-xl hover:bg-gray-300">Cancel</button>
                    <button onclick="leaveClass()" class="px-4 py-2 bg-red-600 text-white rounded-xl hover:bg-red-700">Leave Class</button>
                </div>
            `);
        }

        function leaveClass() {
            hideModal('ConfirmLeaveModal');
            localStorage.removeItem('classId');
            localStorage.removeItem(`notify_local_name_${classId}`);
            window.location.reload(); // Force a full app reset/redirect
        }
        
        function showCreateRequestModal() {
            if (!currentHandRaisingState) {
                return showMessage('Hand raising is currently paused by the teacher.', 'warning');
            }
            
            const modalContent = `
                <h3 class="text-xl font-bold mb-4 text-blue-600">New Request for Help</h3>
                <p class="text-gray-600 mb-4">What do you need help with?</p>
                <textarea id="request-message-input" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., I'm stuck on problem 3..."></textarea>
                <div class="flex justify-end space-x-3 mt-4">
                    <button onclick="hideModal('CreateRequestModal')" class="px-4 py-2 bg-gray-200 rounded-xl hover:bg-gray-300">Cancel</button>
                    <button onclick="submitNewRequest()" class="px-4 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700">Submit Request</button>
                </div>
            `;
            showModal('CreateRequestModal', modalContent);
        }

        async function submitNewRequest() {
            const message = document.getElementById('request-message-input').value.trim();
            if (!message) {
                return showMessage('Please enter a message for your request.', 'warning');
            }

            try {
                await addDoc(collection(db, REQUESTS_COL_PATH(appId)), {
                    userId: auth.currentUser.uid,
                    message: message,
                    requestedAt: serverTimestamp(),
                    status: REQUEST_STATUSES.UNANSWERED
                });
                showMessage('Your request has been submitted!');
                hideModal('CreateRequestModal');
            } catch (error) {
                console.error('Error submitting request:', error);
                showMessage('Error submitting request.', 'error');
            }
        }
        
        // 5. Request Action Handlers (Teacher/Co-Teacher)
        
        async function handleRequestAction(event, requestId, newStatus, commentText = null) {
            if (userRole === 'Student') return showMessage('You cannot change the status of requests.', 'warning');
            
            const requestRef = doc(db, REQUESTS_COL_PATH(appId), requestId);
            const updateData = {
                status: newStatus,
                answeredAt: serverTimestamp(),
                answeredBy: auth.currentUser.uid
            };
            
            if (commentText !== null) {
                updateData.commentText = commentText;
            } else if (newStatus !== REQUEST_STATUSES.COMMENTED_ON) {
                // Clear comment if accepting or denying
                updateData.commentText = deleteField();
            }
            
            try {
                await updateDoc(requestRef, updateData);
                showMessage(`Request status updated to ${newStatus}.`);
                hideModal('CommentModal');
            } catch (error) {
                console.error('Error updating request status:', error);
                showMessage('Error updating request status.', 'error');
            }
        }

        function showCommentModal(requestId, currentComment = '') {
            const isEdit = !!currentComment;
            const action = isEdit ? 'Edit' : 'Add';

            const modalContent = `
                <h3 class="text-xl font-bold mb-4 text-blue-600">${action} Comment</h3>
                <textarea id="comment-text-area" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500" placeholder="Type your comment...">${currentComment}</textarea>
                <div class="flex justify-end space-x-3">
                    <button onclick="hideModal('CommentModal')" class="px-4 py-2 bg-gray-200 rounded-xl hover:bg-gray-300">Cancel</button>
                    <button onclick="saveComment('${requestId}')" class="px-4 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700">Save Comment</button>
                </div>
            `;
            showModal('CommentModal', modalContent);
        }

        function saveComment(requestId) {
            const commentText = document.getElementById('comment-text-area').value.trim();
            if (!commentText) {
                return showMessage('Comment cannot be empty.', 'warning');
            }
            handleRequestAction(null, requestId, REQUEST_STATUSES.COMMENTED_ON, commentText);
        }

        function editComment(requestId) {
            const request = window.requestsData.find(r => r.id === requestId);
            if (request) showCommentModal(requestId, request.commentText || '');
        }

        function deleteComment(requestId) {
            showModal('ConfirmDeleteCommentModal', `
                <h3 class="text-xl font-bold mb-4 text-red-600">Delete Comment?</h3>
                <p class="mb-6">This will delete the comment and set the request status back to Unanswered.</p>
                <div class="flex justify-end space-x-3">
                    <button onclick="hideModal('ConfirmDeleteCommentModal')" class="px-4 py-2 bg-gray-200 rounded-xl hover:bg-gray-300">Cancel</button>
                    <button onclick="performDeleteComment('${requestId}')" class="px-4 py-2 bg-red-600 text-white rounded-xl hover:bg-red-700">Delete</button>
                </div>
            `);
        }

        async function performDeleteComment(requestId) {
            hideModal('ConfirmDeleteCommentModal');
            const requestRef = doc(db, REQUESTS_COL_PATH(appId), requestId);
            try {
                await updateDoc(requestRef, {
                    status: REQUEST_STATUSES.UNANSWERED,
                    commentText: deleteField(),
                    answeredAt: deleteField(),
                    answeredBy: deleteField()
                });
                showMessage('Comment deleted and request set to Unanswered.');
            } catch (error) {
                console.error('Error deleting comment:', error);
                showMessage('Error deleting comment.', 'error');
            }
        }
        
        // 6. Request Rendering and Filtering
        
        function updateFilterButtonUI(activeStatus) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.dataset.status === activeStatus) {
                    btn.classList.remove('text-gray-700', 'hover:bg-gray-100', 'shadow');
                    btn.classList.add('bg-blue-600', 'text-white', 'shadow-md');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white', 'shadow-md');
                    btn.classList.add('text-gray-700', 'hover:bg-gray-100');
                }
            });
        }
        
        function renderRequests(requests) {
            window.requestsData = requests; // Store all data
            const list = document.getElementById('requests-list');
            if (!list) return;
            list.innerHTML = '';
            
            const now = new Date();
            const today = now.toDateString();

            const filteredRequests = requests.filter(request => {
                const requestedDate = request.requestedAt ? new Date(request.requestedAt.toDate()).toDateString() : today;
                
                // Student filter: only today's requests by this user
                if (userRole === 'Student') {
                    if (request.userId !== auth.currentUser.uid || requestedDate !== today) {
                        return false;
                    }
                }
                
                // Status filter
                if (currentRequestFilter === REQUEST_STATUSES.UNANSWERED) {
                    return request.status === REQUEST_STATUSES.UNANSWERED;
                }
                return request.status === currentRequestFilter;
            });
            
            updateFilterButtonUI(currentRequestFilter);

            if (filteredRequests.length === 0) {
                list.innerHTML = `<p class="text-center text-gray-500 col-span-full p-8">No requests found in the "${currentRequestFilter}" category for ${userRole === 'Student' ? 'today' : 'the class'}.</p>`;
                return;
            }

            filteredRequests.sort((a, b) => a.requestedAt.toDate() - b.requestedAt.toDate());

            filteredRequests.forEach(request => {
                const student = window.studentsData.find(s => s.id === request.userId);
                const userName = student ? (student.displayName || `Student ${request.userId.substring(0, 4)}`) : 'Unknown User';
                const timestamp = request.requestedAt ? new Date(request.requestedAt.toDate()).toLocaleTimeString() : 'N/A';
                
                let actionsHtml = '';
                let statusBadgeColor = 'bg-gray-200 text-gray-700';

                if (request.status === REQUEST_STATUSES.ACCEPTED) { statusBadgeColor = 'bg-green-100 text-green-700'; }
                else if (request.status === REQUEST_STATUSES.DENIED) { statusBadgeColor = 'bg-red-100 text-red-700'; }
                else if (request.status === REQUEST_STATUSES.COMMENTED_ON) { statusBadgeColor = 'bg-blue-100 text-blue-700'; }
                
                const statusBadge = `<span class="text-xs font-medium px-2 py-1 rounded-full ${statusBadgeColor}">${request.status}</span>`;
                
                if (userRole !== 'Student') {
                    // Teacher/Co-Teacher Actions
                    const hasComment = !!request.commentText;
                    
                    let commentButtonHtml;
                    if (hasComment) {
                        // Split button design for Edit/Delete
                        commentButtonHtml = `
                            <div class="group relative w-12 h-12 rounded-xl border border-gray-300 shadow-md overflow-hidden bg-white hover:shadow-lg transition-shadow">
                                <button onclick="editComment('${request.id}')" title="Edit Comment" class="w-full h-1/2 bg-white text-gray-700 hover:bg-gray-100 transition-colors flex items-center justify-center">
                                    <i class="fa-solid fa-pencil text-xs"></i>
                                </button>
                                <button onclick="deleteComment('${request.id}')" title="Delete Comment" class="w-full h-1/2 bg-red-50 text-red-600 hover:bg-red-100 transition-colors flex items-center justify-center border-t border-gray-100">
                                    <i class="fa-solid fa-trash text-xs"></i>
                                </button>
                            </div>
                        `;
                    } else {
                        // Standard comment button
                        commentButtonHtml = `
                            <button onclick="showCommentModal('${request.id}', '')" title="Add Comment" class="w-12 h-12 bg-white text-gray-600 border border-gray-200 rounded-xl hover:bg-gray-100 transition-colors shadow-md">
                                <i class="fa-solid fa-comment"></i>
                            </button>
                        `;
                    }

                    actionsHtml = `
                        <div class="flex space-x-3 mt-4">
                            <!-- Accept -->
                            <button onclick="handleRequestAction(event, '${request.id}', '${REQUEST_STATUSES.ACCEPTED}')" title="Accept" class="w-12 h-12 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-colors shadow-md">
                                <i class="fa-solid fa-thumbs-up"></i>
                            </button>
                            
                            <!-- Comment/Split Button -->
                            ${commentButtonHtml}
                            
                            <!-- Deny -->
                            <button onclick="handleRequestAction(event, '${request.id}', '${REQUEST_STATUSES.DENIED}')" title="Deny" class="w-12 h-12 bg-red-500 text-white rounded-xl hover:bg-red-600 transition-colors shadow-md">
                                <i class="fa-solid fa-thumbs-down"></i>
                            </button>
                        </div>
                    `;
                }

                const listItem = document.createElement('div');
                listItem.className = 'bg-white p-5 rounded-xl shadow-lg border-t-4 border-blue-500 hover:shadow-xl transition-shadow duration-200';
                listItem.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-xl font-bold text-gray-800">${userName}</p>
                            <p class="text-sm text-gray-500 mt-0.5">Requested at ${timestamp}</p>
                        </div>
                        ${statusBadge}
                    </div>
                    <p class="mt-4 text-gray-700 border-l-2 border-gray-200 pl-3 italic">${request.message || 'Help requested.'}</p>
                    ${request.commentText ? `<p class="mt-3 text-sm text-blue-600 border-l-4 border-blue-200 pl-3 pt-1">Comment: ${request.commentText}</p>` : ''}
                    ${actionsHtml}
                `;
                list.appendChild(listItem);
            });
        }
        
        // 7. Tab Title Notification
        
        function updateDocumentTitle(count) {
            if (userRole === 'Student') return;
            
            if (count > 0 && count !== currentUnansweredCount) {
                document.title = `Notify | (${count}) New Request${count > 1 ? 's' : ''}`;
            } else if (count === 0 && currentUnansweredCount > 0) {
                document.title = 'Notify | Dashboard';
            }
            currentUnansweredCount = count;
        }

        // --- Firebase Listeners and Initialization ---

        function setupClassDataListener() {
            const classRef = doc(db, CLASS_DOC_PATH(appId));

            onSnapshot(classRef, async (docSnap) => {
                if (docSnap.exists()) {
                    const classData = docSnap.data();
                    
                    // 1. Update global hand raising state UI
                    const isEnabled = classData.isHandRaisingGloballyEnabled !== false; // Default to true
                    updateHandRaisingButtonUI(isEnabled);
                    
                    // 2. Load schedule into settings UI
                    const startInput = document.getElementById('schedule-start-time');
                    const endInput = document.getElementById('schedule-end-time');
                    
                    if (startInput) startInput.value = classData.scheduleStart || '';
                    if (endInput) endInput.value = classData.scheduleEnd || '';
                    
                    // 3. Start schedule check interval (for Teacher/Co-Teacher only)
                    clearInterval(scheduleInterval);
                    if (userRole !== 'Student' && classData.scheduleStart && classData.scheduleEnd) {
                        checkAndApplySchedule(classData.scheduleStart, classData.scheduleEnd);
                        scheduleInterval = setInterval(() => {
                            checkAndApplySchedule(classData.scheduleStart, classData.scheduleEnd);
                        }, 60000); 
                    }
                } else {
                    // Create class doc if it doesn't exist (e.g., this is the first time the teacher is creating it)
                    await setDoc(classRef, {
                        className: 'New Class',
                        isHandRaisingGloballyEnabled: true,
                        scheduleStart: '',
                        scheduleEnd: ''
                    }, { merge: true }).catch(e => console.error("Error creating class doc:", e));
                }
            }, (error) => {
                console.error("Error listening to class document:", error);
            });
        }

        function setupRequestsListener() {
            const q = collection(db, REQUESTS_COL_PATH(appId));

            onSnapshot(q, (snapshot) => {
                const requests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Calculate Unanswered Count (for all roles to filter correctly, but title only for teachers)
                const unansweredCount = requests.filter(r => r.status === REQUEST_STATUSES.UNANSWERED).length;
                updateDocumentTitle(unansweredCount);

                renderRequests(requests);
            }, (error) => {
                console.error("Error listening to requests:", error);
            });
        }
        
        function setupStudentsListener() {
            const q = collection(db, STUDENTS_COL_PATH(appId));
            onSnapshot(q, (snapshot) => {
                window.studentsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderStudents();
                renderRequests(window.requestsData); // Re-render requests to update student names
            }, (error) => {
                console.error("Error listening to students:", error);
            });
        }
        
        function renderStudents() {
            const list = document.getElementById('students-list');
            if (!list) return;
            list.innerHTML = '';
            
            if (window.studentsData.length === 0) {
                list.innerHTML = `<p class="text-center text-gray-500 col-span-full p-8">No student data available.</p>`;
                return;
            }

            window.studentsData.forEach(student => {
                // Determine if they are in the class (basic check for public data)
                const isMember = student.classId === classId; 
                if (isMember) {
                    const studentCard = document.createElement('div');
                    studentCard.className = 'bg-white p-5 rounded-xl shadow-md border border-gray-100';
                    studentCard.innerHTML = `
                        <p class="text-xl font-bold text-gray-800">${student.displayName || 'Unnamed Student'}</p>
                        <p class="text-sm text-gray-500 mt-1">ID: ${student.id.substring(0, 8)}...</p>
                        <p class="text-sm text-indigo-500 mt-2 font-medium">Role: ${student.role}</p>
                    `;
                    list.appendChild(studentCard);
                }
            });
        }

        async function initFirebase() {
            if (Object.keys(firebaseConfig).length === 0) {
                return console.error("Firebase config is empty. Cannot initialize.");
            }
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
            }
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // Set classId from storage or default
                    classId = localStorage.getItem('classId') || 'class_a1b2c3d4';
                    document.getElementById('class-info').textContent = `Class ID: ${classId}`;
                    
                    // Fetch or set user data (role and display name)
                    const userRef = doc(db, STUDENTS_COL_PATH(appId), user.uid);
                    const userSnap = await getDoc(userRef);
                    
                    if (userSnap.exists()) {
                        const userData = userSnap.data();
                        userRole = userData.role || 'Student';
                        document.getElementById('user-profile').innerHTML = `<span class="font-bold">${userRole}</span> (${user.uid.substring(0, 4)}...)`;
                    } else {
                         // Default student creation (Assuming for this single file app, new users are students)
                         userRole = 'Student';
                         await setDoc(userRef, { 
                            role: userRole, 
                            displayName: `Student ${user.uid.substring(0, 4)}`,
                            classId: classId
                         });
                         document.getElementById('user-profile').innerHTML = `<span class="font-bold">${userRole}</span> (${user.uid.substring(0, 4)}...)`;
                    }
                    
                    // Role-based UI updates
                    if (userRole === 'Teacher' || userRole === 'Co-Teacher') {
                        document.getElementById('teacher-pause-resume-btn').classList.remove('hidden');
                        document.getElementById('student-actions').classList.add('hidden');
                        if (userRole !== 'Teacher') {
                            const deleteBtn = document.getElementById('delete-class-btn');
                            if (deleteBtn) deleteBtn.classList.add('hidden'); // Co-teachers cannot delete
                        } else {
                             const deleteBtn = document.getElementById('delete-class-btn');
                            if (deleteBtn) deleteBtn.classList.remove('hidden');
                        }
                    } else {
                        document.getElementById('teacher-pause-resume-btn').classList.add('hidden');
                        document.getElementById('student-actions').classList.remove('hidden');
                    }

                    // Setup Listeners
                    setupClassDataListener();
                    setupStudentsListener();
                    setupRequestsListener();

                } else {
                    console.log("No user signed in.");
                    // In a real app, this would redirect to a login/class entry page
                }
            });
        }
        
        // --- Time Input Formatting Logic (Re-used/Improved) ---
        function setupTimeInputs() {
            document.querySelectorAll('.time-input').forEach(input => {
                // Ensure a default data-digits is set for consistency
                if (!input.dataset.digits) {
                    input.dataset.digits = input.value.replace(':', '').padStart(4, '0');
                }

                input.addEventListener('input', (e) => {
                    const cleaned = e.target.value.replace(/[^0-9]/g, '');
                    let currentDigits = cleaned;

                    if (currentDigits.length > 4) {
                        currentDigits = currentDigits.slice(0, 4);
                    }
                    
                    let h_str = currentDigits.slice(0, 2);
                    let m_str = currentDigits.slice(2, 4);
                    
                    let h = parseInt(h_str, 10);
                    let m = parseInt(m_str, 10);
                    
                    // Input restrictions for 12-hour format: 1-12 for hour, 0-59 for minute
                    if (h < 1 || h > 12) {
                        h_str = String(Math.min(Math.max(h, 1), 12)).padStart(2, '0');
                    }
                    if (m > 59) {
                        m_str = '59';
                    }

                    let formattedValue = '';
                    if (currentDigits.length > 2) {
                        formattedValue = `${h_str}:${m_str}`;
                    } else {
                         formattedValue = h_str;
                    }
                    
                    e.target.value = formattedValue;
                    input.dataset.digits = currentDigits;
                });
                
                // Final validation on blur to ensure HH:MM format
                input.addEventListener('blur', (e) => {
                    let [h_str, m_str] = e.target.value.split(':');
                    
                    let h = parseInt(h_str, 10);
                    let m = parseInt(m_str, 10);

                    if (isNaN(h) || h < 1 || h > 12) h = 12; // Default to 12 if invalid
                    if (isNaN(m) || m < 0 || m > 59) m = 0;
                    
                    const finalValue = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    e.target.value = finalValue;
                    input.dataset.digits = finalValue.replace(':', '');
                });
            });
        }

        // --- Event Listeners and Initializers ---
        
        // Add click listener to main nav buttons
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                switchView(e.target.dataset.view);
            });
        });
        
        // Add click listener to request filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const status = e.target.dataset.status;
                if (status) {
                    currentRequestFilter = status;
                    renderRequests(window.requestsData); // Re-render with new filter
                }
            });
        });

        window.onload = function() {
            initFirebase();
            setupTimeInputs();
            switchView('requests'); // Ensure requests is the initial view
        };
        
        // Expose functions for inline use (Teacher/Co-Teacher actions, Student actions)
        window.toggleHandRaisingPause = toggleHandRaisingPause;
        window.saveSchedule = saveSchedule;
        window.showScheduleSettings = showScheduleSettings;
        window.handleRequestAction = handleRequestAction;
        window.showCommentModal = showCommentModal;
        window.saveComment = saveComment;
        window.editComment = editComment;
        window.deleteComment = deleteComment;
        window.performDeleteComment = performDeleteComment;
        window.showCreateRequestModal = showCreateRequestModal;
        window.submitNewRequest = submitNewRequest;
        window.showStudentSettings = showStudentSettings;
        window.saveLocalClassName = saveLocalClassName;
        window.confirmLeaveClass = confirmLeaveClass;
        window.leaveClass = leaveClass;
        window.hideModal = hideModal;
        
    </script>
</body>
</html>
