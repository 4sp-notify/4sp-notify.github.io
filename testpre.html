<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notify | Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome Icons CDN (for squircle buttons and icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        #app-container {
            width: 100%;
            max-width: 1200px;
            margin: 1rem;
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            min-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        /* Custom Squircle buttons style */
        .squircle-btn {
            border-radius: 25%; /* Making it a squircle-like shape */
            transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        .squircle-btn:hover {
            opacity: 0.9;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        /* Style for the split comment button */
        .split-button-container {
            display: flex;
            flex-direction: column;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        .split-button {
            padding: 0.5rem 0.75rem;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .split-button:first-child {
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- Main application content will be rendered here -->
        <div id="app" class="p-6">
            <div class="text-center py-10 text-gray-500">Loading application...</div>
        </div>

        <!-- Hidden Modal for Commenting/Editing/Deleting -->
        <div id="modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden justify-center items-center z-50">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg mx-4">
                <h3 id="modal-title" class="text-xl font-bold mb-4 text-gray-800">Add Comment</h3>
                <textarea id="modal-textarea" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-4" placeholder="Type your comment here..."></textarea>
                <div class="flex justify-end space-x-3">
                    <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                    <button id="modal-primary-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">Save</button>
                </div>
            </div>
        </div>

        <!-- Hidden Alert/Confirmation Modal -->
        <div id="alert-modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden justify-center items-center z-50">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm mx-4">
                <h3 id="alert-modal-title" class="text-xl font-bold mb-4 text-gray-800">Confirm Action</h3>
                <p id="alert-modal-message" class="text-gray-600 mb-6">Are you sure you want to proceed?</p>
                <div class="flex justify-end space-x-3">
                    <button onclick="closeAlertModal(false)" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                    <button id="alert-modal-primary-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase Log Level for debugging
        setLogLevel('error');

        // --- GLOBAL VARIABLES & STATE ---
        const appElement = document.getElementById('app');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const alertModalBackdrop = document.getElementById('alert-modal-backdrop');
        
        let app = null;
        let db = null;
        let auth = null;
        
        // Use provided global variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // Initial state
        let state = {
            isAuthReady: false,
            userId: null,
            role: 'student', // Default role
            classId: 'class-abc-123', // Placeholder class ID
            className: 'Math 101: Algebra',
            currentView: 'dashboard',
            isHandRaisingPaused: false,
            requests: [], // Array of { id, studentName, timestamp, status, comment }
            selectedCategory: 'Unanswered', // Unanswered, Accepted, Denied, Commented on
            schedule: { start: '08:00', end: '16:00' }, // 24-hour format
            studentLocalClassName: null,
        };

        let requestUnsub = null;
        let classUnsub = null;
        let userSettingsUnsub = null;
        let roleUnsub = null;

        // Utility to convert 24hr string ('08:00') to Date object today
        const timeToDate = (timeStr) => {
            const [h, m] = timeStr.split(':').map(Number);
            const date = new Date();
            date.setHours(h, m, 0, 0);
            return date;
        };

        // --- FIREBASE INITIALIZATION AND AUTH ---
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await new Promise((resolve) => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        unsubscribe(); // Stop listening after the first event
                        if (user) {
                            // User signed in successfully
                        } else {
                            // Sign in using the custom token or anonymously
                            const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                            if (token) {
                                await signInWithCustomToken(auth, token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        }
                        state.userId = auth.currentUser?.uid || crypto.randomUUID();
                        state.isAuthReady = true;
                        startListeners();
                        resolve();
                    });
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                appElement.innerHTML = `<div class="text-center py-10 text-red-600">Failed to load: ${error.message}</div>`;
            }
        }

        // --- FIREBASE LISTENERS (REAL-TIME DATA) ---
        function startListeners() {
            if (!state.isAuthReady || !db || !state.userId || !state.classId) return;
            
            // 1. Listen to Class Settings (Public Data)
            const classDocRef = doc(db, `artifacts/${appId}/public/data/classes`, state.classId);
            classUnsub = onSnapshot(classDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Scheduling Logic (4)
                    let newPauseState = data.isHandRaisingPaused || false;
                    
                    if (data.scheduleStart && data.scheduleEnd) {
                        state.schedule.start = data.scheduleStart;
                        state.schedule.end = data.scheduleEnd;

                        const now = new Date();
                        const start = timeToDate(data.scheduleStart);
                        const end = timeToDate(data.scheduleEnd);

                        // If start > end, it spans overnight.
                        // Example: Start 22:00, End 08:00. Pause time is 08:00 to 22:00
                        if (start > end) {
                            // Schedule is ON between (start and midnight) OR (midnight and end)
                            const isScheduledOn = (now >= start && now <= timeToDate('23:59')) || (now >= timeToDate('00:00') && now <= end);
                            // Pause is enforced when schedule is OFF
                            newPauseState = !isScheduledOn; 
                        } else {
                            // Schedule is ON between start and end.
                            // Pause is enforced when schedule is OFF
                            newPauseState = now < start || now > end;
                        }
                    } else {
                        // If no schedule is set, use the manually set pause state
                        newPauseState = data.isHandRaisingPaused || false;
                    }

                    // Only update the state if the calculated pause state is different
                    if (state.isHandRaisingPaused !== newPauseState) {
                        state.isHandRaisingPaused = newPauseState;
                        render();
                    }
                    
                    state.className = data.name || state.className;
                } else {
                    // Initialize class data if it doesn't exist
                    setDoc(classDocRef, {
                        name: state.className,
                        teacherId: state.userId,
                        coTeachers: [],
                        isHandRaisingPaused: false,
                        scheduleStart: '08:00',
                        scheduleEnd: '16:00',
                    }, { merge: true });
                }
                render();
            });

            // 2. Listen to User Role (Simulated/Placeholder for simplicity)
            // In a real app, this would be determined upon successful auth.
            // For now, let's assume if the class's teacherId matches userId, they are the teacher.
            // This is a simplified approach. In a real app, you'd check a user profile document.
            if (state.classId === 'class-abc-123' && state.userId.startsWith('mockTeacher')) {
                 state.role = 'teacher';
            } else {
                 state.role = 'student';
            }

            // 3. Listen to User's Private Settings (Student Local Name)
            const userSettingsDocRef = doc(db, `artifacts/${appId}/users/${state.userId}/settings`, 'custom_names');
            userSettingsUnsub = onSnapshot(userSettingsDocRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data()[state.classId]) {
                    state.studentLocalClassName = docSnap.data()[state.classId];
                } else {
                    state.studentLocalClassName = null;
                }
                render();
            });


            // 4. Listen to Requests (Public Data)
            const requestsColRef = collection(db, `artifacts/${appId}/public/data/requests`);
            const q = query(requestsColRef, where("classId", "==", state.classId));

            let lastRequestCount = 0;
            let initialLoad = true;
            requestUnsub = onSnapshot(q, (snapshot) => {
                const newRequests = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    newRequests.push({
                        id: doc.id,
                        ...data,
                        timestamp: data.timestamp ? data.timestamp.toDate() : new Date(0), // Convert Firestore Timestamp to JS Date
                    });
                });

                // Sort by timestamp (newest first)
                newRequests.sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());
                state.requests = newRequests;

                // Tab Title Update Logic (for Teachers)
                const unansweredCount = newRequests.filter(r => r.status === 'unanswered').length;
                if (state.role !== 'student' && unansweredCount > lastRequestCount && !initialLoad && document.visibilityState === 'hidden') {
                    // Only update if count increased and tab is hidden
                    document.title = `(${unansweredCount}) Notify | ${state.className} Requests`;
                } else if (state.role !== 'student' && unansweredCount === 0) {
                    document.title = `Notify | ${state.className} Dashboard`;
                } else if (state.role !== 'student' && document.title.startsWith('(') && document.visibilityState === 'visible') {
                     // Reset title when teacher returns to visible tab
                     document.title = `Notify | ${state.className} Dashboard`;
                } else if (state.role === 'student') {
                    document.title = state.studentLocalClassName ? `Notify | ${state.studentLocalClassName}` : `Notify | ${state.className}`;
                }
                
                lastRequestCount = unansweredCount;
                initialLoad = false;
                
                render();
            }, (error) => {
                console.error("Error listening to requests:", error);
                appElement.innerHTML = `<div class="text-center py-10 text-red-600">Error loading requests.</div>`;
            });
        }

        // --- HANDLERS ---
        window.setView = (view) => {
            state.currentView = view;
            render();
        };

        window.toggleHandRaisingPause = async () => {
            if (state.role === 'student') return;
            const classDocRef = doc(db, `artifacts/${appId}/public/data/classes`, state.classId);
            
            // Immediately update Firestore with the manual toggle state
            const newPausedState = !state.isHandRaisingPaused;
            state.isHandRaisingPaused = newPausedState; // Optimistic update
            render();

            try {
                // If a schedule is active, the listener will recalculate the actual state.
                // However, we still save the *manual* state to allow manual override control.
                await updateDoc(classDocRef, {
                    isHandRaisingPaused: newPausedState,
                });
            } catch (error) {
                console.error("Failed to toggle hand raising:", error);
            }
        };

        window.submitNewRequest = async () => {
            if (state.isHandRaisingPaused) {
                showAlertModal("Hand Raising Paused", "The teacher has paused the hand raising feature for now. Please wait until it is resumed.", "Close", () => closeAlertModal(false), null, "bg-gray-500 hover:bg-gray-600");
                return;
            }
            if (state.role !== 'student') return;

            const requestsColRef = collection(db, `artifacts/${appId}/public/data/requests`);
            
            // Simple check to prevent spamming
            const hasUnanswered = state.requests.some(r => r.studentId === state.userId && r.status === 'unanswered');
            if (hasUnanswered) {
                 showAlertModal("Request Pending", "You already have an unanswered request. Please wait for the teacher's response.", "Got It", () => closeAlertModal(false), null, "bg-yellow-500 hover:bg-yellow-600");
                 return;
            }

            try {
                await addDoc(requestsColRef, {
                    classId: state.classId,
                    studentId: state.userId,
                    studentName: 'Student ' + state.userId.substring(0, 4), // Mock student name
                    status: 'unanswered',
                    timestamp: serverTimestamp(),
                    comment: null,
                    date: new Date().toISOString().substring(0, 10), // YYYY-MM-DD
                });
                render();
            } catch (error) {
                console.error("Failed to submit request:", error);
            }
        };

        window.handleTeacherAction = async (requestId, action, initialComment = '') => {
            const requestRef = doc(db, `artifacts/${appId}/public/data/requests`, requestId);

            if (action === 'accept') {
                await updateDoc(requestRef, { status: 'accepted', comment: null });
            } else if (action === 'deny') {
                await updateDoc(requestRef, { status: 'denied', comment: null });
            } else if (action === 'comment') {
                openModal('Add Comment', async (comment) => {
                    await updateDoc(requestRef, { status: 'commented', comment: comment || null });
                    closeModal();
                }, initialComment);
            } else if (action === 'editComment') {
                openModal('Edit Comment', async (comment) => {
                    await updateDoc(requestRef, { status: 'commented', comment: comment || null });
                    closeModal();
                }, initialComment);
            } else if (action === 'deleteComment') {
                showAlertModal(
                    "Delete Comment", 
                    "Are you sure you want to delete this comment and mark the request as unanswered?", 
                    "Delete", 
                    async () => {
                        await updateDoc(requestRef, { status: 'unanswered', comment: null });
                        closeAlertModal(true);
                    }, 
                    () => closeAlertModal(false), 
                    "bg-red-600 hover:bg-red-700"
                );
            }
        };

        window.saveSchedule = async () => {
            if (state.role === 'student') return;

            const startInput = document.getElementById('schedule-start').value;
            const endInput = document.getElementById('schedule-end').value;

            // Simple validation
            if (!startInput || !endInput) {
                showAlertModal("Error", "Please enter both start and end times.", "OK", () => closeAlertModal(false), null, "bg-red-600");
                return;
            }
            
            const classDocRef = doc(db, `artifacts/${appId}/public/data/classes`, state.classId);
            try {
                await updateDoc(classDocRef, {
                    scheduleStart: startInput,
                    scheduleEnd: endInput,
                });
                showAlertModal("Schedule Saved", "The hand-raising schedule has been successfully updated.", "OK", () => closeAlertModal(false), null, "bg-green-600");
            } catch (e) {
                console.error("Error saving schedule:", e);
                showAlertModal("Error", "Could not save schedule due to a technical error.", "OK", () => closeAlertModal(false), null, "bg-red-600");
            }
        };

        window.saveStudentLocalName = async () => {
             if (state.role !== 'student') return;
             const newName = document.getElementById('student-local-name').value.trim();
             const userSettingsDocRef = doc(db, `artifacts/${appId}/users/${state.userId}/settings`, 'custom_names');

             try {
                await setDoc(userSettingsDocRef, {
                    [state.classId]: newName || null // Save null to clear the name
                }, { merge: true });
                showAlertModal("Name Saved", "Your local class name has been updated.", "OK", () => closeAlertModal(false), null, "bg-green-600");
             } catch (e) {
                 console.error("Error saving local name:", e);
             }
        };

        window.leaveClass = () => {
            if (state.role !== 'student') return;

            showAlertModal(
                "Leave Class", 
                "Are you sure you want to leave this class? You will need the class code to re-join.", 
                "Leave", 
                () => {
                    // This logic would typically remove the user from a class array
                    // For this simple example, we'll just clear their local name and reset the view
                    const userSettingsDocRef = doc(db, `artifacts/${appId}/users/${state.userId}/settings`, 'custom_names');
                    updateDoc(userSettingsDocRef, { [state.classId]: deleteField() }).then(() => {
                        state.studentLocalClassName = null;
                        state.classId = null; // Essentially logs them out of the class view
                        setView('dashboard');
                        closeAlertModal(true);
                    });
                }, 
                () => closeAlertModal(false), 
                "bg-red-600 hover:bg-red-700"
            );
        };

        // --- MODAL & ALERT FUNCTIONS ---
        let modalCallback = null;
        window.openModal = (title, callback, initialValue = '') => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-textarea').value = initialValue;
            document.getElementById('modal-primary-btn').onclick = () => {
                if (modalCallback) {
                    modalCallback(document.getElementById('modal-textarea').value);
                }
            };
            modalCallback = callback;
            modalBackdrop.classList.remove('hidden');
            modalBackdrop.classList.add('flex');
        };
        window.closeModal = () => {
            modalBackdrop.classList.add('hidden');
            modalBackdrop.classList.remove('flex');
            modalCallback = null;
        };

        let alertConfirmCallback = null;
        let alertCancelCallback = null;
        window.showAlertModal = (title, message, confirmText, confirmCallback, cancelCallback, confirmBgClass = "bg-blue-600 hover:bg-blue-700") => {
            document.getElementById('alert-modal-title').textContent = title;
            document.getElementById('alert-modal-message').textContent = message;
            
            const confirmBtn = document.getElementById('alert-modal-primary-btn');
            confirmBtn.textContent = confirmText;
            confirmBtn.className = `px-4 py-2 text-white rounded-lg transition ${confirmBgClass}`; // Apply custom color
            
            alertConfirmCallback = confirmCallback;
            alertCancelCallback = cancelCallback;
            
            confirmBtn.onclick = () => {
                if (alertConfirmCallback) alertConfirmCallback();
            };

            const cancelBtn = alertModalBackdrop.querySelector('button:first-child');
            if (cancelCallback) {
                cancelBtn.style.display = '';
                cancelBtn.onclick = () => { if (alertCancelCallback) alertCancelCallback(); };
            } else {
                 // Hide cancel button if no cancel action is provided
                cancelBtn.style.display = 'none';
            }

            alertModalBackdrop.classList.remove('hidden');
            alertModalBackdrop.classList.add('flex');
        };
        window.closeAlertModal = (executed = false) => {
            alertModalBackdrop.classList.add('hidden');
            alertModalBackdrop.classList.remove('flex');
        };


        // --- RENDERING FUNCTIONS ---

        // Renders the top navigation bar
        function renderNav() {
            const isTeacher = state.role !== 'student';
            const teacherActions = isTeacher ? `
                <button onclick="toggleHandRaisingPause()" 
                        class="squircle-btn w-16 h-16 flex items-center justify-center text-xl transition-colors
                            ${state.isHandRaisingPaused ? 'bg-green-500 hover:bg-green-600 text-white' : 'bg-red-500 hover:bg-red-600 text-white'}"
                        title="${state.isHandRaisingPaused ? 'Resume Hand Raising' : 'Pause Hand Raising'}">
                    <i class="fa-solid ${state.isHandRaisingPaused ? 'fa-play' : 'fa-pause'}"></i>
                </button>
            ` : `
                <button onclick="submitNewRequest()" class="squircle-btn w-16 h-16 flex items-center justify-center text-3xl transition-colors bg-blue-500 hover:bg-blue-600 text-white" title="Create New Request">
                    <i class="fa-solid fa-plus"></i>
                </button>
            `;

            const navItems = [
                { view: 'dashboard', icon: 'fa-table-columns', label: 'Dashboard' },
                { view: 'classes', icon: 'fa-graduation-cap', label: 'Classes' },
                { view: 'settings', icon: 'fa-cog', label: 'Settings' }
            ];

            const navButtons = navItems.map(item => {
                const isSelected = state.currentView === item.view;
                const baseClasses = "squircle-btn w-16 h-16 flex items-center justify-center text-xl transition-colors shadow-lg";

                let btnContent;
                let btnClasses;
                
                if (isSelected) {
                    // Selected button converts to a blue Home button
                    btnContent = `<i class="fa-solid fa-house"></i>`;
                    btnClasses = `${baseClasses} bg-blue-500 text-white hover:bg-blue-600`;
                } else {
                    // Unselected buttons are gray
                    btnContent = `<i class="fa-solid ${item.icon}"></i>`;
                    btnClasses = `${baseClasses} bg-gray-200 text-gray-700 hover:bg-gray-300`;
                }
                
                return `
                    <button onclick="setView('${isSelected ? 'dashboard' : item.view}')" class="${btnClasses}" title="${isSelected ? 'Home' : item.label}">
                        ${btnContent}
                    </button>
                `;
            }).join('');

            return `
                <header class="flex justify-between items-center p-4 border-b border-gray-200 sticky top-0 bg-white z-10">
                    <h1 class="text-2xl font-bold text-gray-800">${state.studentLocalClassName || state.className}</h1>
                    <div class="flex space-x-3 items-center">
                        ${isTeacher ? `
                            <span class="text-sm font-medium ${state.isHandRaisingPaused ? 'text-red-500' : 'text-green-500'}">
                                Hand Raising: ${state.isHandRaisingPaused ? 'Paused' : 'Active'}
                            </span>
                        ` : ''}
                        ${teacherActions}
                        ${navButtons}
                    </div>
                </header>
            `;
        }

        // Renders the request category filter buttons
        function renderCategoryButtons() {
            const categories = ['Unanswered', 'Accepted', 'Denied', 'Commented on'];
            return `
                <div class="flex space-x-2 mb-6 overflow-x-auto pb-2">
                    ${categories.map(category => {
                        const isSelected = state.selectedCategory === category;
                        const count = state.requests.filter(r => {
                             if (category === 'Unanswered') {
                                 // Unanswered: status is exactly 'unanswered'
                                 return r.status === 'unanswered';
                             } else if (category === 'Accepted') {
                                 // Accepted: status is 'accepted'
                                 return r.status === 'accepted';
                             } else if (category === 'Denied') {
                                 // Denied: status is 'denied'
                                 return r.status === 'denied';
                             } else if (category === 'Commented on') {
                                 // Commented on: status is 'commented'
                                 return r.status === 'commented';
                             }
                             return false;
                        }).length;

                        return `
                            <button onclick="state.selectedCategory = '${category}'; render();"
                                class="squircle-btn px-4 py-2 min-w-32 text-sm font-medium transition-colors border-2
                                    ${isSelected ? 'bg-blue-500 text-white border-blue-500' : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-100'}">
                                ${category} (${count})
                            </button>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Renders a single request card for the teacher view
        function renderTeacherRequestCard(request) {
            const timestampStr = request.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // Comment button logic (3)
            let commentButtonHTML;
            if (request.comment) {
                // Split button for Edit/Delete
                commentButtonHTML = `
                    <div class="split-button-container w-16 h-16 flex-shrink-0">
                        <button onclick="handleTeacherAction('${request.id}', 'editComment', '${request.comment.replace(/'/g, "\\'")}')" 
                                class="split-button bg-gray-100 hover:bg-gray-200 text-gray-700 flex-1 flex items-center justify-center text-sm" 
                                title="Edit Comment">
                            <i class="fa-solid fa-pencil-alt text-xs"></i>
                        </button>
                        <button onclick="handleTeacherAction('${request.id}', 'deleteComment')" 
                                class="split-button bg-gray-200 hover:bg-gray-300 text-red-500 flex-1 flex items-center justify-center text-sm" 
                                title="Delete Comment">
                            <i class="fa-solid fa-trash-alt text-xs"></i>
                        </button>
                    </div>
                `;
            } else {
                // Single button for Comment
                commentButtonHTML = `
                    <button onclick="handleTeacherAction('${request.id}', 'comment')" 
                            class="squircle-btn w-16 h-16 flex items-center justify-center text-2xl transition-colors bg-white hover:bg-gray-100 text-gray-600 border border-gray-300 flex-shrink-0" 
                            title="Add Comment">
                        <i class="fa-solid fa-comment-dots"></i>
                    </button>
                `;
            }

            return `
                <div class="flex items-center justify-between p-4 bg-white rounded-xl shadow-md mb-3 border-l-4 border-yellow-500">
                    <div>
                        <p class="font-semibold text-lg text-gray-800">${request.studentName}</p>
                        <p class="text-sm text-gray-500">Requested at: ${timestampStr}</p>
                        ${request.comment ? `<p class="text-sm mt-1 text-blue-600 italic">Comment: ${request.comment}</p>` : ''}
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="handleTeacherAction('${request.id}', 'accept')" 
                                class="squircle-btn w-16 h-16 flex items-center justify-center text-2xl transition-colors bg-green-500 hover:bg-green-600 text-white flex-shrink-0" 
                                title="Accept Request">
                            <i class="fa-solid fa-thumbs-up"></i>
                        </button>
                        ${commentButtonHTML}
                        <button onclick="handleTeacherAction('${request.id}', 'deny')" 
                                class="squircle-btn w-16 h-16 flex items-center justify-center text-2xl transition-colors bg-red-500 hover:bg-red-600 text-white flex-shrink-0" 
                                title="Deny Request">
                            <i class="fa-solid fa-thumbs-down"></i>
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Renders the main dashboard content based on the user role
        function renderDashboard() {
            const isTeacher = state.role !== 'student';
            const filteredRequests = state.requests.filter(r => {
                if (isTeacher) {
                    if (state.selectedCategory === 'Unanswered') {
                        return r.status === 'unanswered';
                    }
                    return r.status === state.selectedCategory.toLowerCase().replace(' on', '');
                } else {
                    // Student view only shows today's requests
                    const today = new Date().toISOString().substring(0, 10);
                    return r.studentId === state.userId && r.date === today;
                }
            });

            const listTitle = isTeacher ? `${state.selectedCategory} Requests` : `Your Requests Today`;

            let requestListHTML;
            if (filteredRequests.length > 0) {
                requestListHTML = filteredRequests.map(r => 
                    isTeacher ? renderTeacherRequestCard(r) : renderStudentRequestCard(r)
                ).join('');
            } else {
                 requestListHTML = `
                    <div class="text-center py-12 text-gray-500 bg-gray-50 rounded-xl">
                        ${isTeacher ? `No ${state.selectedCategory.toLowerCase()} requests.` : `You have no requests for today.`}
                    </div>
                 `;
            }

            const teacherViewContent = `
                <div class="p-6">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Request Queue</h2>
                    ${renderCategoryButtons()}
                    <h3 class="text-xl font-medium text-gray-700 mb-4">${listTitle} (${filteredRequests.length})</h3>
                    <div id="request-list">
                        ${requestListHTML}
                    </div>
                </div>
            `;

            const studentViewContent = `
                <div class="p-6">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">Your Recent Activity</h2>
                    <p class="mb-6 text-gray-600">Use the blue plus button <i class="fa-solid fa-plus text-blue-500"></i> in the corner to send a new request to the teacher.</p>
                    <h3 class="text-xl font-medium text-gray-700 mb-4">${listTitle} (${filteredRequests.length})</h3>
                    <div id="student-request-list">
                         ${requestListHTML}
                    </div>
                </div>
            `;

            return isTeacher ? teacherViewContent : studentViewContent;
        }

        // Renders a single request card for the student view
        function renderStudentRequestCard(request) {
            const timestampStr = request.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            let statusColor = 'bg-yellow-100 text-yellow-800 border-yellow-500';
            let statusIcon = 'fa-hourglass-half';
            
            if (request.status === 'accepted') {
                statusColor = 'bg-green-100 text-green-800 border-green-500';
                statusIcon = 'fa-check-circle';
            } else if (request.status === 'denied') {
                statusColor = 'bg-red-100 text-red-800 border-red-500';
                statusIcon = 'fa-times-circle';
            } else if (request.status === 'commented') {
                statusColor = 'bg-blue-100 text-blue-800 border-blue-500';
                statusIcon = 'fa-comment-dots';
            }

            return `
                <div class="flex items-center justify-between p-4 ${statusColor} rounded-xl shadow-sm mb-3 border-l-4">
                    <div>
                        <p class="font-semibold text-gray-800">Request at ${timestampStr}</p>
                        <p class="text-sm text-gray-600 flex items-center">
                            <i class="fa-solid ${statusIcon} mr-2"></i> Status: 
                            <span class="capitalize font-medium ml-1">${request.status.replace('ed', 'ed ')}</span>
                        </p>
                        ${request.comment ? `<p class="text-sm mt-1 text-blue-700 italic">Teacher Comment: ${request.comment}</p>` : ''}
                    </div>
                </div>
            `;
        }


        // Renders the settings view
        function renderSettings() {
            const isTeacher = state.role !== 'student';
            const isCoTeacher = isTeacher && state.userId !== 'mockTeacher-123'; // Simplified check
            
            const teacherSettings = `
                <div class="mb-8 p-6 bg-gray-50 rounded-xl">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Hand Raising Schedule</h3>
                    <p class="text-sm text-gray-600 mb-4">Set a period when hand raising should be automatically active. It will be paused outside this period.</p>
                    <div class="flex space-x-4 items-end">
                        <div class="flex-1">
                            <label for="schedule-start" class="block text-sm font-medium text-gray-700 mb-1">Start Time (24h)</label>
                            <input type="time" id="schedule-start" value="${state.schedule.start}" 
                                class="time-input w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="flex-1">
                            <label for="schedule-end" class="block text-sm font-medium text-gray-700 mb-1">End Time (24h)</label>
                            <input type="time" id="schedule-end" value="${state.schedule.end}" 
                                class="time-input w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <button onclick="saveSchedule()" 
                                class="px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">Save Schedule</button>
                    </div>
                </div>

                <div class="p-6 bg-gray-50 rounded-xl">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Class Management</h3>
                    <button onclick="showAlertModal('Delete Class', 'This will permanently delete the class and all associated data. Are you absolutely sure?', 'Delete', () => console.log('Delete Class Logic Here (Admin Only)'), () => closeAlertModal(false), 'bg-red-600 hover:bg-red-700')"
                            class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition disabled:opacity-50"
                            ${isCoTeacher ? 'disabled' : ''}>
                        <i class="fa-solid fa-trash-alt mr-2"></i> Delete Class (Teacher Only)
                    </button>
                    ${isCoTeacher ? '<p class="text-sm text-red-500 mt-2">Co-teachers are not allowed to delete a class.</p>' : ''}
                </div>
            `;

            const studentSettings = `
                <div class="mb-8 p-6 bg-gray-50 rounded-xl">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Personal Class Name</h3>
                    <p class="text-sm text-gray-600 mb-4">Set a local nickname for this class, e.g., "Mondays Math Class".</p>
                    <div class="flex space-x-4 items-end">
                        <div class="flex-1">
                            <label for="student-local-name" class="block text-sm font-medium text-gray-700 mb-1">Class Nickname</label>
                            <input type="text" id="student-local-name" value="${state.studentLocalClassName || ''}" 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                placeholder="${state.className}">
                        </div>
                        <button onclick="saveStudentLocalName()" 
                                class="px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                            <i class="fa-solid fa-save mr-2"></i> Save Name
                        </button>
                    </div>
                </div>
                
                <div class="p-6 bg-white border border-red-200 rounded-xl">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Leave Class</h3>
                    <p class="text-sm text-gray-600 mb-4">Leaving this class will remove you from the roster until you re-join with a code.</p>
                    <button onclick="leaveClass()" 
                            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-medium">
                        <i class="fa-solid fa-sign-out-alt mr-2"></i> Leave Class
                    </button>
                </div>
            `;
            
            return `
                <div class="p-6">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Settings</h2>
                    <p class="text-sm text-gray-500 mb-6">User ID: ${state.userId}</p>
                    ${isTeacher ? teacherSettings : studentSettings}
                </div>
            `;
        }

        // Main render function
        window.render = () => {
            if (!state.isAuthReady) {
                appElement.innerHTML = `<div class="text-center py-10 text-gray-500">Authenticating and loading data...</div>`;
                return;
            }

            const headerHTML = renderNav();
            let contentHTML;

            switch (state.currentView) {
                case 'settings':
                    contentHTML = renderSettings();
                    break;
                case 'classes':
                    contentHTML = `<div class="p-6"><h2 class="text-3xl font-bold text-gray-800">Classes</h2><p class="text-gray-500">Manage your classes here.</p></div>`;
                    break;
                case 'profile':
                    contentHTML = `<div class="p-6"><h2 class="text-3xl font-bold text-gray-800">Profile</h2><p class="text-gray-500">Your user profile information.</p></div>`;
                    break;
                case 'dashboard':
                default:
                    contentHTML = renderDashboard();
                    break;
            }

            appElement.innerHTML = headerHTML + contentHTML;
            
            // Re-attach time input listeners after rendering settings if needed
            if (state.currentView === 'settings' && state.role !== 'student') {
                attachTimeInputListeners();
            }
        };
        
        // --- TIME INPUT LOGIC (Preserved and adapted for Settings) ---
        function attachTimeInputListeners() {
            const timeInputs = document.querySelectorAll('.time-input');
            timeInputs.forEach(input => {
                // Ensure handlers are only added once
                if (input.dataset.listenersAttached) return; 
                input.dataset.listenersAttached = 'true';

                // Initial data setup
                let [h_init, m_init] = input.value.split(':').map(Number);
                if (isNaN(h_init)) h_init = 12;
                if (isNaN(m_init)) m_init = 0;
                input.value = `${String(h_init).padStart(2, '0')}:${String(m_init).padStart(2, '0')}`;
                input.dataset.digits = input.value.replace(':', '');


                input.addEventListener('input', (e) => {
                    const value = e.target.value.replace(/[^0-9]/g, '');
                    let currentDigits = value.substring(0, 4);

                    if (e.inputType === 'deleteContentBackward') {
                        currentDigits = currentDigits.slice(0, -1);
                    }

                    if (currentDigits.length > 4) {
                        currentDigits = currentDigits.slice(0, 4);
                    }
                    
                    input.dataset.digits = currentDigits;
                    const padded = currentDigits.padStart(4, '0');

                    let h_str = padded.slice(0, 2);
                    let m_str = padded.slice(2, 4);
                    
                    // 24-hour format validation
                    if (parseInt(h_str, 10) > 23) h_str = '23';
                    if (parseInt(m_str, 10) > 59) m_str = '59';

                    const formattedValue = `${h_str}:${m_str}`;
                    if (input.value !== formattedValue) {
                        input.value = formattedValue;
                    }
                });

                input.addEventListener('blur', (e) => {
                    let [h, m] = e.target.value.split(':').map(Number);
                    if (isNaN(h) || h < 0 || h > 23) h = 8; // Default to 08:00
                    if (isNaN(m) || m < 0 || m > 59) m = 0;
                    const finalValue = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    e.target.value = finalValue;
                    input.dataset.digits = finalValue.replace(':', '');
                });
            });
        }
        
        // --- INITIALIZATION ---
        initializeFirebase();
    </script>
</body>
</html>
