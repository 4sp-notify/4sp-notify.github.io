<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notify | Dashboard</title>
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' https://cdn.tailwindcss.com https://www.gstatic.com https://apis.google.com https://accounts.google.com 'unsafe-inline' 'unsafe-eval';
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net;
        font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net;
        img-src 'self' data: https://www.gstatic.com https://lh3.googleusercontent.com;
        connect-src 'self' https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://www.googleapis.com https://content.googleapis.com https://classroom.googleapis.com;
        frame-src 'self' https://accounts.google.com https://content.googleapis.com https://content-classroom.googleapis.com;
    ">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        :root {
            --sidebar-width: 6rem;
            --topbar-height: 4rem;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7; /* Light background */
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        .app-container {
            display: flex;
            height: 100vh;
        }
        .sidebar {
            width: var(--sidebar-width);
            background-color: #ffffff; /* White background for sidebar */
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 2rem;
            gap: 1.5rem;
            z-index: 10;
        }
        .main-view {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .topbar {
            height: var(--topbar-height);
            background-color: #ffffff; /* White background for topbar */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            padding: 0 2rem;
            justify-content: space-between;
            z-index: 5;
        }
        .content {
            flex-grow: 1;
            padding: 2rem;
            overflow-y: auto;
            background-color: #f7f7f7;
        }
        .squircle-btn {
            width: 4rem;
            height: 4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 1.25rem; /* More rounded corners */
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .squircle-btn:hover {
            opacity: 0.9;
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }
        .time-input-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .time-input {
            width: 6rem;
            text-align: center;
        }

        /* Custom Styles for Request Actions to maintain squircle shape */
        .action-squircle-btn {
            width: 3.5rem;
            height: 3.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.8rem;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .action-squircle-btn:hover {
            opacity: 0.9;
        }

        .filter-btn {
            font-size: 0.75rem;
            padding: 0.5rem 1rem;
            border-radius: 1.25rem;
            transition: all 0.2s;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 400px;
        }
    </style>
</head>
<body>
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50 transition-opacity duration-300" style="display: flex;">
        <div class="flex flex-col items-center">
            <i class="fa-solid fa-sync fa-spin text-4xl text-blue-600"></i>
            <p class="mt-4 text-gray-700 font-semibold">Loading data...</p>
        </div>
    </div>

    <div class="app-container" style="display: none;" id="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo font-extrabold text-2xl text-blue-600">N</div>
            
            <!-- Dashboard/Home Button -->
            <button id="dashboard-btn" class="squircle-btn bg-blue-600 text-white" data-view="dashboard">
                <i class="fa-solid fa-house text-2xl"></i>
            </button>

            <!-- 3 Menu Buttons (Settings, Class, Users) - Dynamic on selected view -->
            <button id="settings-btn" class="squircle-btn text-gray-600 bg-gray-100" data-view="settings">
                <i class="fa-solid fa-gear text-2xl"></i>
            </button>
            <button id="class-btn" class="squircle-btn text-gray-600 bg-gray-100" data-view="class">
                <i class="fa-solid fa-chalkboard text-2xl"></i>
            </button>
            <button id="users-btn" class="squircle-btn text-gray-600 bg-gray-100" data-view="users">
                <i class="fa-solid fa-users text-2xl"></i>
            </button>

            <!-- Teacher/Co-Teacher ONLY: Pause/Resume Hands Button -->
            <button id="toggle-pause-btn" class="squircle-btn text-white mt-auto hidden" title="Toggle Hand Raising Status">
                <!-- Icon will be set dynamically in JS (fa-pause or fa-play) -->
                <i id="pause-icon" class="fa-solid text-2xl"></i>
            </button>

            <!-- Logout Button -->
            <button id="logout-btn" class="squircle-btn bg-red-100 text-red-600 mb-4" title="Logout">
                <i class="fa-solid fa-right-from-bracket text-2xl"></i>
            </button>
        </div>

        <!-- Main View -->
        <div class="main-view">
            <!-- Topbar -->
            <div class="topbar">
                <h1 class="text-2xl font-semibold text-gray-800">
                    <span id="current-view-title">Dashboard</span>
                    <span class="text-sm text-gray-500 font-normal ml-2" id="user-role-display"></span>
                </h1>
                <div class="flex items-center space-x-4">
                    <!-- Avatar/Profile Placeholder -->
                    <div id="profile-area" class="flex items-center space-x-2">
                        <span id="user-name" class="font-medium text-gray-700">User</span>
                        <div class="w-10 h-10 bg-blue-200 rounded-full flex items-center justify-center text-blue-700 font-bold">
                            <i class="fa-solid fa-user"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content">
                <div id="main-content">
                    <!-- Dashboard View (Teacher/Co-Teacher) -->
                    <div id="dashboard-teacher-view" class="space-y-6 hidden">
                        <div class="p-6 bg-white rounded-xl shadow-md">
                            <h2 class="text-xl font-bold mb-4 text-gray-800">Requests</h2>

                            <!-- Filter Buttons -->
                            <div class="flex space-x-2 mb-4">
                                <button class="filter-btn bg-blue-600 text-white" data-filter="unanswered" id="filter-unanswered">Unanswered</button>
                                <button class="filter-btn bg-gray-100 text-gray-600" data-filter="accepted" id="filter-accepted">Accepted</button>
                                <button class="filter-btn bg-gray-100 text-gray-600" data-filter="denied" id="filter-denied">Denied</button>
                                <button class="filter-btn bg-gray-100 text-gray-600" data-filter="commented" id="filter-commented">Commented on</button>
                            </div>

                            <!-- Request List -->
                            <div id="teacher-request-list" class="space-y-3">
                                <!-- Requests will be inserted here by JS -->
                            </div>

                            <p id="no-requests-msg" class="text-gray-500 mt-4 hidden">No requests in this category.</p>
                        </div>
                    </div>

                    <!-- Dashboard View (Student) -->
                    <div id="dashboard-student-view" class="space-y-6 hidden">
                        <div class="p-6 bg-white rounded-xl shadow-md">
                            <h2 class="text-xl font-bold mb-4 text-gray-800">Your Requests Today</h2>

                            <!-- New + Button and Settings for Students -->
                            <div class="flex justify-between items-center mb-6">
                                <button id="student-create-request-btn" class="action-squircle-btn bg-blue-600 text-white" title="Create New Request">
                                    <i class="fa-solid fa-plus text-xl"></i>
                                </button>
                                <button id="student-settings-btn" class="action-squircle-btn bg-gray-100 text-gray-600" title="Class Settings">
                                    <i class="fa-solid fa-gear text-xl"></i>
                                </button>
                            </div>

                            <!-- Student Filter Buttons -->
                            <div class="flex space-x-2 mb-4">
                                <button class="filter-btn bg-blue-600 text-white" data-filter="unanswered" id="student-filter-unanswered">Unanswered</button>
                                <button class="filter-btn bg-gray-100 text-gray-600" data-filter="accepted" id="student-filter-accepted">Accepted</button>
                                <button class="filter-btn bg-gray-100 text-gray-600" data-filter="denied" id="filter-denied">Denied</button>
                                <button class="filter-btn bg-gray-100 text-gray-600" data-filter="commented" id="student-filter-commented">Commented on</button>
                            </div>

                            <!-- Student Request List -->
                            <div id="student-request-list" class="space-y-3">
                                <!-- Student requests for today will be inserted here by JS -->
                            </div>
                            <p id="no-student-requests-msg" class="text-gray-500 mt-4 hidden">You have no requests today.</p>

                            <!-- Hand Raising Status -->
                            <div id="hand-raise-status" class="mt-6 p-4 bg-gray-100 rounded-lg text-center font-medium">
                                Hand raising is currently <span id="current-status" class="text-green-600">ON</span>.
                            </div>
                        </div>
                    </div>


                    <!-- Settings View -->
                    <div id="settings-view" class="space-y-6 hidden">
                        <div class="p-6 bg-white rounded-xl shadow-md">
                            <h2 class="text-xl font-bold mb-4 text-gray-800">Class Settings</h2>
                            
                            <!-- Teacher/Co-Teacher Schedule Section -->
                            <div id="teacher-schedule-section" class="border-t pt-4 mt-4 hidden">
                                <h3 class="text-lg font-semibold mb-3 text-gray-800">Hand Raising Schedule</h3>
                                <p class="text-gray-600 mb-4">Set the period when hand-raising is automatically enabled (it will be paused from end time to start time).</p>
                                
                                <div class="space-y-4">
                                    <!-- Start Time -->
                                    <div class="flex items-center space-x-4">
                                        <label for="start-time" class="w-20 text-gray-700">Start Time</label>
                                        <div class="time-input-container">
                                            <input type="text" id="start-time" class="time-input border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500 transition" value="09:00" data-digits="0900" maxlength="4">
                                            <span class="text-sm text-gray-500">24-hour format: HHMM</span>
                                        </div>
                                    </div>
                                    <!-- End Time -->
                                    <div class="flex items-center space-x-4">
                                        <label for="end-time" class="w-20 text-gray-700">End Time</label>
                                        <div class="time-input-container">
                                            <input type="text" id="end-time" class="time-input border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500 transition" value="17:00" data-digits="1700" maxlength="4">
                                            <span class="text-sm text-gray-500">24-hour format: HHMM</span>
                                        </div>
                                    </div>

                                    <button id="save-schedule-btn" class="mt-4 bg-blue-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-blue-700 transition">Save Schedule</button>
                                </div>
                            </div>
                            
                            <!-- Student Local Name Section -->
                            <div id="student-local-name-section" class="border-t pt-4 mt-4 hidden">
                                <h3 class="text-lg font-semibold mb-3 text-gray-800">Personal Class Settings</h3>
                                <p class="text-gray-600 mb-4">Set a local name for this class (only visible to you).</p>
                                
                                <div class="flex items-center space-x-4">
                                    <label for="local-name-input" class="w-20 text-gray-700">Local Name</label>
                                    <input type="text" id="local-name-input" placeholder="e.g., Algebra 1-A" class="flex-grow border border-gray-300 rounded-lg p-2 focus:ring-blue-500 focus:border-blue-500 transition">
                                    <button id="save-local-name-btn" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-blue-700 transition">Save</button>
                                </div>
                            </div>

                            <!-- Delete Class Button (Teacher Only) -->
                            <div id="delete-class-section" class="border-t pt-4 mt-4 hidden">
                                <h3 class="text-lg font-semibold mb-3 text-red-600">Danger Zone</h3>
                                <button id="delete-class-btn" class="bg-red-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-red-700 transition">Delete Class</button>
                                <p class="text-sm text-gray-500 mt-2">This action is permanent and only available to the class teacher.</p>
                            </div>

                            <!-- Student Leave Class Button -->
                            <div id="leave-class-section" class="border-t pt-4 mt-4 hidden">
                                <h3 class="text-lg font-semibold mb-3 text-red-600">Class Membership</h3>
                                <button id="leave-class-btn" class="bg-red-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-red-700 transition">Leave Class</button>
                                <p class="text-sm text-gray-500 mt-2">You will no longer be a member of this class.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Class View -->
                    <div id="class-view" class="space-y-6 hidden">
                        <div class="p-6 bg-white rounded-xl shadow-md">
                            <h2 class="text-xl font-bold mb-4 text-gray-800">Class Management</h2>
                            <p>Content for Class Management goes here.</p>
                        </div>
                    </div>

                    <!-- Users View -->
                    <div id="users-view" class="space-y-6 hidden">
                        <div class="p-6 bg-white rounded-xl shadow-md">
                            <h2 class="text-xl font-bold mb-4 text-gray-800">User List</h2>
                            <p>Content for User List goes here.</p>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->

    <!-- Generic Modal Container (used for all dialogs: requests, comments, confirmations) -->
    <div id="general-modal" class="modal hidden">
        <div id="general-modal-content" class="modal-content">
            <!-- Modal content loaded via JS -->
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDocs, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase Log Level
        setLogLevel('debug');

        // Global Variables from Canvas Environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let userData = { role: 'student', name: 'Student', classes: [] }; // Default role
        let classSettings = { isHandRaisingPaused: false, scheduleStartTime: '09:00', scheduleEndTime: '17:00', teacherId: null, coTeachers: [] };
        let currentView = 'dashboard';
        let currentFilter = 'unanswered';
        let currentRequests = [];
        let requestsUnsubscribe = null;
        let settingsUnsubscribe = null;
        let scheduleInterval = null;
        let originalTitle = document.title;
        let isAuthReady = false;

        // --- Core Firebase Initialization and Auth ---

        async function initFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing.");
                    return;
                }
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        await fetchUserDataAndSettings();
                        setupRealtimeListeners();
                    } else {
                        await handleInitialAuth();
                    }
                    isAuthReady = true;
                    hideLoading();
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                hideLoading();
            }
        }

        async function handleInitialAuth() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Initial authentication failed:", error);
                // Fallback for anonymous users if custom token fails
                try {
                     await signInAnonymously(auth);
                } catch (anonError) {
                    console.error("Anonymous sign-in also failed:", anonError);
                }
            }
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
        }

        // --- Data Fetching and Realtime Listeners ---

        async function fetchUserDataAndSettings() {
            if (!userId) return;

            // 1. Fetch User Data (Role/Name) - Assuming initial setup grants roles
            // For this example, we'll assign roles based on a simple heuristic or a hardcoded teacher ID
            // In a real app, this would come from an external service or a 'users' collection.
            const TEACHER_ID = 'teacher_user_id'; // Placeholder for the teacher's actual UID

            // For demonstration, assign Teacher/Co-Teacher role
            if (userId === TEACHER_ID) {
                userData.role = 'teacher';
                userData.name = 'Class Teacher';
            } else if (classSettings.coTeachers.includes(userId)) {
                userData.role = 'co-teacher';
                userData.name = 'Co-Teacher';
            } else {
                 userData.role = 'student';
                 userData.name = `Student ${userId.substring(0, 4)}`; // Default name for students
            }

            // 2. Fetch Student Local Settings (Private Data)
            if (userData.role === 'student') {
                 const studentLocalDocRef = doc(db, `artifacts/${appId}/users/${userId}/settings/local`);
                 const studentLocalSnap = await getDoc(studentLocalDocRef);
                 if (studentLocalSnap.exists()) {
                    const localData = studentLocalSnap.data();
                    if (localData.localClassName) {
                        document.getElementById('local-name-input').value = localData.localClassName;
                    }
                 }
            }

            updateUIForRole();
            renderView(currentView); // Initial render after data load
        }

        function setupRealtimeListeners() {
            if (requestsUnsubscribe) requestsUnsubscribe();
            if (settingsUnsubscribe) settingsUnsubscribe();

            // Realtime listener for Class Settings
            const classSettingsDocRef = doc(db, `artifacts/${appId}/public/data/classSettings/main`);
            settingsUnsubscribe = onSnapshot(classSettingsDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    classSettings = { ...classSettings, ...docSnap.data() };
                } else {
                    // Initialize if not exists (old class without feature)
                    setDoc(classSettingsDocRef, classSettings);
                }
                updateHandRaisePauseButton(classSettings.isHandRaisingPaused);
                updateHandRaiseStatusUI(classSettings.isHandRaisingPaused);
                updateScheduleUI(classSettings.scheduleStartTime, classSettings.scheduleEndTime);
                
                // Set teacherId if null (first time running)
                if (!classSettings.teacherId && userData.role === 'teacher') {
                    updateDoc(classSettingsDocRef, { teacherId: userId });
                    classSettings.teacherId = userId;
                }

                // Start or update schedule interval
                if (scheduleInterval) clearInterval(scheduleInterval);
                scheduleInterval = setInterval(checkScheduleAndToggle, 60000); // Check every minute

            }, (error) => console.error("Error listening to class settings:", error));

            // Realtime listener for Requests
            const requestsColRef = collection(db, `artifacts/${appId}/public/data/requests`);
            const requestsQuery = query(requestsColRef);

            requestsUnsubscribe = onSnapshot(requestsQuery, (snapshot) => {
                const newRequests = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                currentRequests = newRequests.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds); // Sort by newest first

                updateTeacherNotification(currentRequests);
                renderView(currentView); // Re-render the current view
            }, (error) => console.error("Error listening to requests:", error));
        }

        // --- UI Rendering and View Management ---

        function updateUIForRole() {
            document.getElementById('user-role-display').textContent = userData.role.toUpperCase();
            document.getElementById('user-name').textContent = userData.name;

            const isTeacherOrCoTeacher = userData.role === 'teacher' || userData.role === 'co-teacher';

            // Sidebar: Toggle Pause Button Visibility
            document.getElementById('toggle-pause-btn').classList.toggle('hidden', !isTeacherOrCoTeacher);

            // Settings View: Toggle Teacher/Student Sections
            document.getElementById('teacher-schedule-section').classList.toggle('hidden', !isTeacherOrCoTeacher);
            document.getElementById('delete-class-section').classList.toggle('hidden', userData.role !== 'teacher'); // Teacher ONLY
            document.getElementById('student-local-name-section').classList.toggle('hidden', userData.role !== 'student');
            document.getElementById('leave-class-section').classList.toggle('hidden', userData.role !== 'student');

            // Dashboard View Toggle
            document.getElementById('dashboard-teacher-view').classList.toggle('hidden', userData.role === 'student');
            document.getElementById('dashboard-student-view').classList.toggle('hidden', userData.role !== 'student');
        }

        function renderView(view) {
            currentView = view;
            const views = {
                'dashboard': [document.getElementById('dashboard-teacher-view'), document.getElementById('dashboard-student-view')],
                'settings': [document.getElementById('settings-view')],
                'class': [document.getElementById('class-view')],
                'users': [document.getElementById('users-view')]
            };
            
            // Hide all views
            Object.values(views).flat().forEach(el => el.classList.add('hidden'));

            // Show current view(s)
            views[view].forEach(el => el.classList.remove('hidden'));

            // Update Header Title
            const titleMap = { 'dashboard': 'Dashboard', 'settings': 'Settings', 'class': 'Class', 'users': 'Users' };
            document.getElementById('current-view-title').textContent = titleMap[view];

            // Update Sidebar Buttons (Dynamic Home Button)
            ['settings', 'class', 'users'].forEach(btnView => {
                const btn = document.getElementById(`${btnView}-btn`);
                if (btnView === view) {
                    // Is current view, make it the blue "Home" button
                    btn.classList.remove('bg-gray-100', 'text-gray-600');
                    btn.classList.add('bg-blue-600', 'text-white');
                    btn.querySelector('i').className = 'fa-solid fa-arrow-left text-2xl'; // Back icon
                } else {
                    // Not current view, make it the grey menu button
                    btn.classList.add('bg-gray-100', 'text-gray-600');
                    btn.classList.remove('bg-blue-600', 'text-white');
                    const iconMap = { 'settings': 'fa-gear', 'class': 'fa-chalkboard', 'users': 'fa-users' };
                    btn.querySelector('i').className = `fa-solid ${iconMap[btnView]} text-2xl`;
                }
            });

            // The Dashboard button is always blue/home icon, but changes function based on context
            const dashboardBtn = document.getElementById('dashboard-btn');
            if (view === 'dashboard') {
                 // Nothing special, it's just the current active menu item (though visually different)
            } else {
                // When in a menu, dashboard button acts like the main navigation point
            }

            // Render request list for current role/filter
            if (view === 'dashboard') {
                if (userData.role === 'student') {
                    renderStudentRequests();
                } else {
                    renderTeacherRequests();
                }
            }
        }

        function renderTeacherRequests() {
            const container = document.getElementById('teacher-request-list');
            container.innerHTML = '';
            
            const filteredRequests = currentRequests.filter(r => {
                // Filter logic: 'unanswered' status excludes 'accepted', 'denied', 'commented'
                if (currentFilter === 'unanswered') {
                    return r.status === 'unanswered';
                }
                return r.status === currentFilter;
            });

            if (filteredRequests.length === 0) {
                document.getElementById('no-requests-msg').classList.remove('hidden');
                return;
            } else {
                document.getElementById('no-requests-msg').classList.add('hidden');
            }

            filteredRequests.forEach(request => {
                const requestElement = document.createElement('div');
                requestElement.className = 'flex justify-between items-center p-4 bg-gray-50 border border-gray-200 rounded-lg shadow-sm';
                
                const time = new Date(request.timestamp.seconds * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                requestElement.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-semibold text-gray-800">${request.studentName || 'Student'} <span class="text-sm text-gray-500 ml-2">(${time})</span></p>
                        ${request.status !== 'unanswered' ? `<p class="text-xs font-medium mt-1 uppercase text-blue-500">Status: ${request.status}</p>` : ''}
                        ${request.comment ? `<p class="text-sm text-gray-600 mt-1 italic">Comment: ${request.comment}</p>` : ''}
                    </div>
                    <!-- Action Buttons -->
                    <div class="flex space-x-2 ml-4">
                        <button class="action-squircle-btn bg-green-500 text-white" onclick="handleRequestAction('${request.id}', 'accepted')">
                            <i class="fa-solid fa-thumbs-up text-xl"></i>
                        </button>
                        <button class="action-squircle-btn bg-white text-gray-600 border border-gray-300" onclick="openCommentModal('${request.id}', '${request.comment || ''}')">
                            <i class="fa-solid fa-comment text-xl"></i>
                        </button>
                        <button class="action-squircle-btn bg-red-500 text-white" onclick="handleRequestAction('${request.id}', 'denied')">
                            <i class="fa-solid fa-thumbs-down text-xl"></i>
                        </button>
                    </div>
                `;
                container.appendChild(requestElement);
            });
        }

        function renderStudentRequests() {
            const container = document.getElementById('student-request-list');
            container.innerHTML = '';

            const today = new Date().toDateString();
            
            const filteredRequests = currentRequests.filter(r => {
                // Filter by current student and requests made today
                const requestDate = new Date(r.timestamp.seconds * 1000).toDateString();
                const isToday = requestDate === today;

                // Filter logic
                if (r.studentId !== userId || !isToday) return false;

                if (currentFilter === 'unanswered') {
                    return r.status === 'unanswered';
                }
                return r.status === currentFilter;
            });

            if (filteredRequests.length === 0) {
                document.getElementById('no-student-requests-msg').classList.remove('hidden');
                return;
            } else {
                document.getElementById('no-student-requests-msg').classList.add('hidden');
            }

            filteredRequests.forEach(request => {
                const requestElement = document.createElement('div');
                let statusColor = 'text-gray-500';
                if (request.status === 'accepted') statusColor = 'text-green-600';
                if (request.status === 'denied') statusColor = 'text-red-600';
                if (request.status === 'commented') statusColor = 'text-blue-600';

                const time = new Date(request.timestamp.seconds * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                requestElement.className = 'flex justify-between items-center p-4 bg-gray-50 border border-gray-200 rounded-lg shadow-sm';
                requestElement.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-semibold text-gray-800">Request at <span class="text-sm text-gray-500">${time}</span></p>
                        <p class="text-sm font-medium mt-1 uppercase ${statusColor}">Status: ${request.status}</p>
                        ${request.comment ? `<p class="text-sm text-gray-600 mt-1 italic">Teacher Comment: ${request.comment}</p>` : ''}
                    </div>
                `;
                container.appendChild(requestElement);
            });

            // Update hand raising status UI
            updateHandRaiseStatusUI(classSettings.isHandRaisingPaused);
        }

        // --- Class Settings Logic ---

        function updateScheduleUI(start, end) {
             document.getElementById('start-time').value = start;
             document.getElementById('end-time').value = end;
        }

        async function saveSchedule() {
            const startTime = document.getElementById('start-time').value;
            const endTime = document.getElementById('end-time').value;

            // Simple validation
            if (!/^\d{2}:\d{2}$/.test(startTime) || !/^\d{2}:\d{2}$/.test(endTime)) {
                openAlertDialog('Error', 'Please use a valid HH:MM time format.');
                return;
            }

            const classSettingsDocRef = doc(db, `artifacts/${appId}/public/data/classSettings/main`);
            await updateDoc(classSettingsDocRef, {
                scheduleStartTime: startTime,
                scheduleEndTime: endTime
            });
            openAlertDialog('Success', 'Schedule saved successfully!');
        }
        
        // Schedule logic to automatically toggle pause state
        async function checkScheduleAndToggle() {
            if (!isAuthReady || userData.role === 'student') return;

            const now = new Date();
            const currentTimeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            const startStr = classSettings.scheduleStartTime;
            const endStr = classSettings.scheduleEndTime;

            const isDuringSchedule = (currentTimeStr >= startStr && currentTimeStr < endStr);
            const shouldBePaused = !isDuringSchedule;
            
            if (shouldBePaused !== classSettings.isHandRaisingPaused) {
                // Only write if the state needs to change
                const classSettingsDocRef = doc(db, `artifacts/${appId}/public/data/classSettings/main`);
                await updateDoc(classSettingsDocRef, { isHandRaisingPaused: shouldBePaused });
                console.log(`[Schedule] Hand raising automatically set to: ${shouldBePaused ? 'PAUSED' : 'ACTIVE'}`);
            }
        }

        // --- Hand Raising Pause Toggle ---

        function updateHandRaisePauseButton(isPaused) {
            const btn = document.getElementById('toggle-pause-btn');
            const icon = document.getElementById('pause-icon');
            
            if (isPaused) {
                icon.className = 'fa-solid fa-play text-2xl';
                btn.classList.remove('bg-blue-600');
                btn.classList.add('bg-green-600');
                btn.title = 'Resume Hand Raising';
            } else {
                icon.className = 'fa-solid fa-pause text-2xl';
                btn.classList.remove('bg-green-600');
                btn.classList.add('bg-blue-600');
                btn.title = 'Pause Hand Raising';
            }
        }

        async function toggleHandRaising() {
             if (userData.role !== 'teacher' && userData.role !== 'co-teacher') return;
             
             const classSettingsDocRef = doc(db, `artifacts/${appId}/public/data/classSettings/main`);
             await updateDoc(classSettingsDocRef, { isHandRaisingPaused: !classSettings.isHandRaisingPaused });
        }
        
        function updateHandRaiseStatusUI(isPaused) {
            const statusEl = document.getElementById('current-status');
            if (isPaused) {
                statusEl.textContent = 'PAUSED';
                statusEl.classList.remove('text-green-600');
                statusEl.classList.add('text-red-600');
            } else {
                statusEl.textContent = 'ON';
                statusEl.classList.remove('text-red-600');
                statusEl.classList.add('text-green-600');
            }
        }

        // --- Teacher Request Actions (Global scope for inline HTML calls) ---

        window.handleRequestAction = async (requestId, newStatus, comment = null) => {
            if (userData.role === 'student') return; // Should not happen in teacher view

            const requestDocRef = doc(db, `artifacts/${appId}/public/data/requests/${requestId}`);
            const updateData = { status: newStatus };
            if (comment !== null) {
                updateData.comment = comment;
            } else if (newStatus !== 'commented') {
                updateData.comment = null; // Clear comment on Accept/Deny
            }
            
            await updateDoc(requestDocRef, updateData);
        };

        // --- Comment Modal Logic ---
        
        window.openCommentModal = (requestId, existingComment) => {
            const modalContent = document.getElementById('general-modal-content');
            
            const isEditing = existingComment !== '';
            
            modalContent.innerHTML = `
                <h3 class="text-xl font-bold mb-4 text-gray-800">${isEditing ? 'Edit Comment' : 'Add Comment'}</h3>
                <textarea id="comment-textarea" class="w-full h-24 p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Enter your comment...">${existingComment}</textarea>
                
                <div class="flex justify-between items-center mt-4">
                    <button class="bg-gray-200 text-gray-800 font-medium py-2 px-4 rounded-lg hover:bg-gray-300 transition" onclick="closeModal()">Cancel</button>
                    <div class="flex space-x-2">
                        ${isEditing ? `<button class="bg-red-500 text-white font-medium py-2 px-4 rounded-lg hover:bg-red-600 transition" onclick="deleteComment('${requestId}')"><i class="fa-solid fa-trash mr-1"></i> Delete</button>` : ''}
                        <button class="bg-blue-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-blue-700 transition" onclick="saveComment('${requestId}', ${isEditing})">${isEditing ? 'Update Comment' : 'Submit Comment'}</button>
                    </div>
                </div>
            `;
            document.getElementById('general-modal').classList.remove('hidden');
        };

        window.saveComment = async (requestId, isEditing) => {
            const comment = document.getElementById('comment-textarea').value.trim();
            if (comment) {
                await handleRequestAction(requestId, 'commented', comment);
            } else if (isEditing) {
                // If editing and comment is empty, treat as deletion
                await deleteComment(requestId, false); 
            }
            closeModal();
        };

        window.deleteComment = async (requestId, close = true) => {
            await handleRequestAction(requestId, 'unanswered', null); // Move back to unanswered, clear comment
            if (close) closeModal();
        };

        // --- Student Request Logic ---

        window.createStudentRequest = async () => {
             if (classSettings.isHandRaisingPaused) {
                openAlertDialog('Hand Raising Paused', 'Hand raising is currently paused by the teacher.');
                return;
             }
             
             try {
                 const requestsColRef = collection(db, `artifacts/${appId}/public/data/requests`);
                 await addDoc(requestsColRef, {
                     studentId: userId,
                     studentName: userData.name,
                     timestamp: serverTimestamp(),
                     status: 'unanswered',
                     comment: null
                 });
                 openAlertDialog('Request Sent!', 'Your request has been added to the queue.');
             } catch (error) {
                 console.error("Error creating request:", error);
                 openAlertDialog('Error', 'Failed to submit request. Please try again.');
             }
        }

        // --- Student Settings Logic ---
        
        async function saveLocalClassName() {
            const localName = document.getElementById('local-name-input').value.trim();
            const studentLocalDocRef = doc(db, `artifacts/${appId}/users/${userId}/settings/local`);
            
            await setDoc(studentLocalDocRef, { localClassName: localName }, { merge: true });
            userData.name = localName || `Student ${userId.substring(0, 4)}`; // Update local state for immediate feedback
            document.getElementById('user-name').textContent = userData.name;
            openAlertDialog('Success', 'Local class name saved!');
        }

        async function leaveClass() {
             const studentLocalDocRef = doc(db, `artifacts/${appId}/users/${userId}/settings/local`);
             // In a true implementation, you'd manage a list of classes. Here, we delete the entire local setting for simplicity.
             await deleteDoc(studentLocalDocRef);
             
             // Sign out or redirect to re-auth
             await auth.signOut();
             location.reload(); // Force a full refresh
        }

        // --- Teacher Delete Class (Restricted) ---

        async function deleteClass() {
             if (userData.role !== 'teacher') {
                openAlertDialog('Permission Denied', 'Only the class teacher can delete the class.');
                return;
             }

             // Confirmation Modal
             openConfirmDialog('Confirm Deletion', 'Are you absolutely sure you want to delete this class? This action is permanent and will delete ALL requests and settings.', async () => {
                 const classSettingsDocRef = doc(db, `artifacts/${appId}/public/data/classSettings/main`);
                 await deleteDoc(classSettingsDocRef);
                 // Delete all requests (requires advanced query/batch writes, simplified for demo)
                 
                 openAlertDialog('Class Deleted', 'The class settings have been deleted. You will be logged out.');
                 await auth.signOut();
                 location.reload();
             });
        }


        // --- Teacher Tab Notification ---

        function updateTeacherNotification(requests) {
            if (userData.role === 'student') return;

            const unansweredCount = requests.filter(r => r.status === 'unanswered').length;
            
            if (unansweredCount > 0) {
                document.title = `(${unansweredCount}) New | ${originalTitle}`;
            } else {
                document.title = originalTitle;
            }
        }

        // --- General Modal/Dialog Functions ---

        function openAlertDialog(title, message) {
            const modalContent = document.getElementById('general-modal-content');
            modalContent.innerHTML = `
                <h3 class="text-xl font-bold mb-4 text-gray-800">${title}</h3>
                <p class="text-gray-700 mb-6">${message}</p>
                <div class="flex justify-end">
                    <button class="bg-blue-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-blue-700 transition" onclick="closeModal()">OK</button>
                </div>
            `;
            document.getElementById('general-modal').classList.remove('hidden');
        }
        
        function openConfirmDialog(title, message, onConfirm) {
            const modalContent = document.getElementById('general-modal-content');
            modalContent.innerHTML = `
                <h3 class="text-xl font-bold mb-4 text-red-600">${title}</h3>
                <p class="text-gray-700 mb-6">${message}</p>
                <div class="flex justify-end space-x-2">
                    <button class="bg-gray-200 text-gray-800 font-medium py-2 px-4 rounded-lg hover:bg-gray-300 transition" onclick="closeModal()">Cancel</button>
                    <button class="bg-red-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-red-700 transition" id="confirm-action-btn">Confirm</button>
                </div>
            `;
            document.getElementById('confirm-action-btn').onclick = () => { onConfirm(); closeModal(); };
            document.getElementById('general-modal').classList.remove('hidden');
        }

        window.closeModal = () => {
            document.getElementById('general-modal').classList.add('hidden');
            document.getElementById('general-modal-content').innerHTML = '';
        };

        // --- Event Listeners ---

        document.addEventListener('DOMContentLoaded', () => {
            initFirebase();

            // Navigation Button Listeners
            document.getElementById('dashboard-btn').addEventListener('click', () => renderView('dashboard'));
            document.getElementById('settings-btn').addEventListener('click', () => renderView('settings'));
            document.getElementById('class-btn').addEventListener('click', () => renderView('class'));
            document.getElementById('users-btn').addEventListener('click', () => renderView('users'));
            document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());

            // Teacher/Co-Teacher Action Listeners
            document.getElementById('toggle-pause-btn')?.addEventListener('click', toggleHandRaising);
            document.getElementById('save-schedule-btn')?.addEventListener('click', saveSchedule);
            document.getElementById('delete-class-btn')?.addEventListener('click', deleteClass);
            
            // Student Action Listeners
            document.getElementById('student-create-request-btn')?.addEventListener('click', createStudentRequest);
            document.getElementById('student-settings-btn')?.addEventListener('click', () => renderView('settings'));
            document.getElementById('save-local-name-btn')?.addEventListener('click', saveLocalClassName);
            document.getElementById('leave-class-btn')?.addEventListener('click', leaveClass);
            
            // Teacher Filter Listeners
            document.querySelectorAll('#dashboard-teacher-view .filter-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const newFilter = e.target.dataset.filter;
                    currentFilter = newFilter;
                    document.querySelectorAll('#dashboard-teacher-view .filter-btn').forEach(btn => {
                        if (btn.dataset.filter === newFilter) {
                            btn.classList.add('bg-blue-600', 'text-white');
                            btn.classList.remove('bg-gray-100', 'text-gray-600');
                        } else {
                            btn.classList.remove('bg-blue-600', 'text-white');
                            btn.classList.add('bg-gray-100', 'text-gray-600');
                        }
                    });
                    renderTeacherRequests();
                });
            });
            
            // Student Filter Listeners
            document.querySelectorAll('#dashboard-student-view .filter-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const newFilter = e.target.dataset.filter;
                    currentFilter = newFilter;
                    document.querySelectorAll('#dashboard-student-view .filter-btn').forEach(btn => {
                        if (btn.dataset.filter === newFilter) {
                            btn.classList.add('bg-blue-600', 'text-white');
                            btn.classList.remove('bg-gray-100', 'text-gray-600');
                        } else {
                            btn.classList.remove('bg-blue-600', 'text-white');
                            btn.classList.add('bg-gray-100', 'text-gray-600');
                        }
                    });
                    renderStudentRequests();
                });
            });

            // --- Time Input Formatting Logic (Preserved and enhanced for 24hr format) ---
            document.querySelectorAll('.time-input').forEach(input => {
                const parseTime = (value) => {
                    let digits = value.replace(/[^0-9]/g, '');
                    if (digits.length > 4) digits = digits.substring(0, 4);
                    return digits.padStart(4, '0');
                }

                input.addEventListener('input', (e) => {
                    const originalDigits = e.target.dataset.digits || '0000';
                    let currentDigits = parseTime(e.target.value);
                    
                    // Simple replacement logic for 24-hour format (HHMM)
                    let h_str = currentDigits.slice(0, 2);
                    let m_str = currentDigits.slice(2, 4);

                    let h = parseInt(h_str, 10);
                    let m = parseInt(m_str, 10);

                    if (h > 23) h_str = '23';
                    if (m > 59) m_str = '59';

                    h_str = String(h).padStart(2, '0');
                    m_str = String(m).padStart(2, '0');
                    
                    const formattedValue = `${h_str}:${m_str}`;
                    
                    if (input.value !== formattedValue) {
                        input.value = formattedValue;
                    }
                    input.dataset.digits = formattedValue.replace(':', '');
                });

                input.addEventListener('blur', (e) => {
                    let [h_str, m_str] = e.target.value.split(':');
                    
                    let h = parseInt(h_str, 10) || 0;
                    let m = parseInt(m_str, 10) || 0;
                    
                    if (h > 23) h = 23;
                    if (h < 0) h = 0;
                    if (m > 59) m = 59;
                    if (m < 0) m = 0;

                    const finalValue = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    e.target.value = finalValue;
                    input.dataset.digits = finalValue.replace(':', '');
                });
            });
            // --- End Time Input Logic ---
        });
    </script>
</body>
</html>
