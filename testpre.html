<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notify | Dashboard</title>
    <!-- Tailwind CSS is loaded for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* This style block ensures the original squircle look is maintained */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7; /* Very light gray */
        }
        /* Custom styles to maintain the squircle shape for buttons */
        .squircle {
            /* The original squircle shape is maintained with a strong border-radius */
            border-radius: 30%; 
            transition: all 0.2s;
        }
        .squircle:hover {
            opacity: 0.9;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        /* Style for the custom modal (Alert/Confirm replacement) */
        .modal {
            background-color: rgba(0, 0, 0, 0.4);
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transform: translateY(0);
            transition: transform 0.3s ease-in-out;
        }
        .hidden {
            display: none !important;
        }
        
        /* Specific styling for the comment split button to maintain squircle look */
        .comment-split-container {
            position: relative;
            /* Ensures the container matches the squircle height/width */
            height: 100%; 
        }
        .comment-btn-top {
            /* Top half of the comment button */
            border-bottom-left-radius: 0 !important;
            border-bottom-right-radius: 0 !important;
            height: 50%;
            display: flex;
            align-items: flex-end; /* Keeps icon centered in the top half */
            justify-content: center;
        }
        .comment-btn-bottom {
            /* Bottom half for delete comment */
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50%;
            border-top-left-radius: 0 !important;
            border-top-right-radius: 0 !important;
            display: flex;
            align-items: flex-start; /* Keeps icon centered in the bottom half */
            justify-content: center;
        }

        /* Ensure fixed width for time input for consistency */
        .time-input {
            width: 100px;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Main Application Container -->
    <div id="app-container" class="max-w-7xl mx-auto pt-8 pb-16 px-4 sm:px-6 lg:px-8">
        
        <!-- Top Navigation (Teacher/Co-Teacher View - The Topbar) -->
        <!-- This structure maintains the layout of one button group left, one button group right -->
        <div id="teacher-nav" class="flex justify-between items-center mb-10 space-x-4">
            
            <!-- Left: Hand Raising Button (DYNAMIC ICON/COLOR) -->
            <button id="pause-hands-btn" class="p-3 bg-gray-200 text-gray-700 hover:bg-gray-300 rounded-lg shadow-md flex items-center space-x-2 transition duration-150 ease-in-out">
                <!-- Initial State: Paused (Pause icon, Gray/Normal) -->
                <i id="pause-icon" class="fas fa-pause"></i>
                <span id="pause-text">Pause Hand Raising</span>
            </button>

            <!-- Right: Action Buttons (Squircle shape, DYNAMIC COLOR/ICON) -->
            <div class="flex space-x-4">
                
                <!-- Settings Button (or Home) -->
                <button id="nav-settings-btn" onclick="navigateTo('settings-teacher')" class="p-3 bg-gray-200 text-gray-700 hover:bg-gray-300 squircle shadow-md">
                    <i id="settings-icon" class="fas fa-cog text-xl"></i>
                </button>

                <!-- Co-Teachers Button (or Home) -->
                <button id="nav-co-teachers-btn" onclick="navigateTo('co-teachers')" class="p-3 bg-gray-200 text-gray-700 hover:bg-gray-300 squircle shadow-md">
                    <i id="co-teachers-icon" class="fas fa-users text-xl"></i>
                </button>

                <!-- Classes Button (or Home) -->
                <button id="nav-classes-btn" onclick="navigateTo('classes-teacher')" class="p-3 bg-gray-200 text-gray-700 hover:bg-gray-300 squircle shadow-md">
                    <i id="classes-icon" class="fas fa-chalkboard-teacher text-xl"></i>
                </button>
            </div>
        </div>

        <!-- Top Navigation (Student View - The Topbar) -->
        <div id="student-nav" class="flex justify-between items-center mb-10 space-x-4 hidden">
            <!-- Blue Plus Button to Create Request -->
            <button id="create-request-btn" onclick="createRequestModal()" class="p-3 bg-blue-500 text-white hover:bg-blue-600 rounded-full shadow-lg flex items-center justify-center transition duration-150 ease-in-out w-12 h-12">
                <i class="fas fa-plus text-xl"></i>
            </button>

            <!-- Settings Button (Student) -->
            <button id="nav-student-settings-btn" onclick="navigateTo('settings-student')" class="p-3 bg-gray-200 text-gray-700 hover:bg-gray-300 squircle shadow-md">
                <i id="student-settings-icon" class="fas fa-cog text-xl"></i>
            </button>
        </div>


        <!-- Main Content Area (Simulates the main panel/sidebar content) -->
        <div id="content-area" class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl">
            
            <!-- Welcome/Role Indicator -->
            <h1 class="text-3xl font-extrabold text-gray-900 mb-6">
                <span id="role-indicator">Loading...</span> | <span id="current-user-id"></span>
            </h1>
            <p id="auth-status" class="text-sm text-gray-500 mb-8"></p>

            <!-- Loading Spinner -->
            <div id="loading-spinner" class="flex justify-center items-center py-10">
                <i class="fas fa-circle-notch fa-spin text-4xl text-blue-500"></i>
            </div>
            
            <!-- Teacher/Co-Teacher Main View (Requests List) -->
            <div id="main-teacher" class="hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Live Requests</h2>
                <!-- Filter Buttons (New Feature) -->
                <div id="request-filters-teacher" class="flex space-x-2 mb-6 overflow-x-auto pb-2">
                    <!-- Filters populated by JS -->
                </div>
                <div id="requests-list-container" class="space-y-4">
                    <!-- Requests populate here -->
                    <p id="no-requests-msg-teacher" class="text-gray-500 hidden">No unanswered requests at this time.</p>
                </div>
            </div>

            <!-- Student Main View (Today's Requests) -->
            <div id="main-student" class="hidden">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Your Requests Today</h2>
                <!-- Filter Buttons (New Feature) -->
                <div id="request-filters-student" class="flex space-x-2 mb-6 overflow-x-auto pb-2">
                    <!-- Filters populated by JS -->
                </div>
                <div id="student-requests-list" class="space-y-4">
                    <!-- Student's requests populate here -->
                    <p id="no-requests-msg-student" class="text-gray-500 hidden">You haven't made any requests today.</p>
                </div>
            </div>

            <!-- Settings Menu (Teacher/Co-Teacher) -->
            <div id="settings-teacher-view" class="hidden max-w-2xl mx-auto">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Class Settings</h2>
                
                <div class="space-y-6">
                    <!-- Schedule Section (New Feature) -->
                    <div class="bg-gray-50 p-6 rounded-lg shadow-inner">
                        <h3 class="text-xl font-medium text-gray-700 mb-4 border-b pb-2">Class Schedule (Auto Hand-Raising)</h3>
                        <p class="text-sm text-gray-500 mb-4">Hand-raising will be automatically enabled during this period and paused outside of it. (24-hour format: HH:MM)</p>
                        
                        <div class="flex justify-between items-center space-x-4 mb-4 p-2">
                            <label for="start-time-input" class="font-medium text-gray-700 w-1/3 py-2">Start Time:</label>
                            <input type="text" id="start-time-input" class="time-input p-2 border border-gray-300 rounded-md text-lg font-mono focus:ring-blue-500 focus:border-blue-500" value="08:00" maxlength="5">
                        </div>
                        <div class="flex justify-between items-center space-x-4 mb-6 p-2">
                            <label for="end-time-input" class="font-medium text-gray-700 w-1/3 py-2">End Time:</label>
                            <input type="text" id="end-time-input" class="time-input p-2 border border-gray-300 rounded-md text-lg font-mono focus:ring-blue-500 focus:border-blue-500" value="09:00" maxlength="5">
                        </div>

                        <button onclick="saveSchedule()" class="w-full bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition duration-150">Save Schedule</button>
                    </div>

                    <!-- Delete Class Section (Teacher Only Permission) -->
                    <div id="delete-class-section" class="bg-red-50 p-6 rounded-lg shadow-inner border border-red-300">
                        <h3 class="text-xl font-medium text-red-700 mb-4">Danger Zone</h3>
                        <p class="text-sm text-red-500 mb-4">Permanently delete this class. This action cannot be undone.</p>
                        <button onclick="deleteClass()" class="w-full bg-red-500 text-white p-3 rounded-lg hover:bg-red-600 transition duration-150">Delete Class</button>
                    </div>
                </div>
            </div>

            <!-- Co-Teachers Menu -->
            <div id="co-teachers-view" class="hidden max-w-2xl mx-auto">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Manage Co-Teachers</h2>
                <div id="co-teachers-list" class="space-y-4">
                    <!-- Co-teachers listed here -->
                </div>
            </div>

            <!-- Classes Menu -->
            <div id="classes-teacher-view" class="hidden max-w-2xl mx-auto">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Your Classes</h2>
                <div id="classes-list" class="space-y-4">
                    <!-- Classes listed here -->
                </div>
            </div>
            
            <!-- Settings Menu (Student View - New Feature) -->
            <div id="settings-student-view" class="hidden max-w-2xl mx-auto">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Student Class Settings</h2>
                
                <div class="space-y-6">
                    <!-- Local Name Setting -->
                    <div class="bg-gray-50 p-6 rounded-lg shadow-inner">
                        <h3 class="text-xl font-medium text-gray-700 mb-4 border-b pb-2">Local Class Name</h3>
                        <p class="text-sm text-gray-500 mb-4">Set a personal name for this class (only visible to you).</p>
                        <input type="text" id="local-name-input" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., 'My Period 3 Math'">
                        <button onclick="saveLocalName()" class="w-full mt-4 bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition duration-150">Save Local Name</button>
                    </div>

                    <!-- Leave Class Option -->
                    <div class="bg-red-50 p-6 rounded-lg shadow-inner border border-red-300">
                        <h3 class="text-xl font-medium text-red-700 mb-4">Leave Class</h3>
                        <p class="text-sm text-red-500 mb-4">You will be removed from this class.</p>
                        <button onclick="leaveClass()" class="w-full bg-red-500 text-white p-3 rounded-lg hover:bg-red-600 transition duration-150">Leave Class</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Modal for Request Details (Teacher/Co-Teacher) -->
    <div id="request-detail-modal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white w-full max-w-lg rounded-xl shadow-2xl p-6">
            <h3 class="text-2xl font-bold mb-4">Request Detail</h3>
            <p class="mb-2 text-gray-700"><strong>Student:</strong> <span id="modal-student-name"></span></p>
            <p class="mb-4 text-gray-700"><strong>Time:</strong> <span id="modal-request-time"></span></p>
            <p class="p-4 bg-gray-50 rounded-lg border border-gray-200 text-gray-800 min-h-[60px] max-h-48 overflow-y-auto">
                <span id="modal-request-text"></span>
            </p>

            <!-- Teacher/Co-Teacher Action Buttons (New Squircle Buttons) -->
            <div id="teacher-actions" class="mt-6 flex justify-between space-x-3 h-14">
                
                <!-- Accept Button (Green Thumbs Up) -->
                <button id="accept-btn" onclick="handleRequestAction('Accepted')" class="squircle p-3 flex-1 bg-green-500 text-white hover:bg-green-600 shadow-lg">
                    <i class="fas fa-thumbs-up text-2xl mx-auto"></i>
                </button>
                
                <!-- Comment Button (Toggle Split Button) -->
                <div class="flex-1 comment-split-container">
                    <button id="comment-btn-edit" onclick="openCommentEditor()" class="squircle p-3 w-full h-full bg-white text-gray-700 border border-gray-300 hover:bg-gray-100 shadow-lg flex items-center justify-center">
                        <i class="fas fa-comment text-2xl mx-auto"></i>
                    </button>
                    <!-- Bottom half for delete comment -->
                    <button id="comment-btn-delete" onclick="handleRequestAction('Commented', true)" class="comment-btn-bottom bg-gray-200 text-red-500 hover:bg-gray-300 hidden">
                        <i class="fas fa-trash-alt text-sm"></i>
                    </button>
                </div>
                
                <!-- Deny Button (Red Thumbs Down) -->
                <button id="deny-btn" onclick="handleRequestAction('Denied')" class="squircle p-3 flex-1 bg-red-500 text-white hover:bg-red-600 shadow-lg">
                    <i class="fas fa-thumbs-down text-2xl mx-auto"></i>
                </button>
            </div>

            <!-- Comment Input/Editor -->
            <div id="comment-editor" class="mt-6 hidden">
                <textarea id="comment-input" rows="3" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Add a comment..."></textarea>
                <div class="flex justify-end space-x-2 mt-2">
                    <button onclick="closeCommentEditor()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button onclick="handleRequestAction('Commented')" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Save Comment</button>
                </div>
            </div>

            <!-- Modal Close Button -->
            <div class="flex justify-end mt-4">
                <button onclick="closeModal('request-detail-modal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal for Student Request Creation -->
    <div id="create-request-modal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white w-full max-w-sm rounded-xl shadow-2xl p-6">
            <h3 class="text-2xl font-bold mb-4">New Request</h3>
            <textarea id="new-request-input" rows="4" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Type your question or request for the teacher..."></textarea>
            
            <div id="request-error" class="text-red-500 text-sm mt-2 hidden"></div>

            <div class="flex justify-end space-x-2 mt-4">
                <button onclick="closeModal('create-request-modal')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button onclick="submitNewRequest()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Submit Request</button>
            </div>
        </div>
    </div>

    <!-- Universal Message Modal -->
    <div id="message-modal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white w-full max-w-xs rounded-xl shadow-2xl p-6 text-center">
            <p id="message-text" class="text-lg font-medium mb-4"></p>
            <button onclick="closeModal('message-modal')" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">OK</button>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDoc, Timestamp, getDocs, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Log level for Firestore debugging
        setLogLevel('debug'); 

        // --- GLOBAL VARIABLES (Provided by Environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- FIREBASE INITIALIZATION AND AUTH ---
        let app;
        let db;
        let auth;
        let userId;

        // Mock Class ID for demonstration. 
        const CLASS_ID = 'example_class_123';
        const CLASS_DOC_PATH = `/artifacts/${appId}/public/data/classes/${CLASS_ID}`;

        // --- APPLICATION STATE ---
        let isAuthReady = false;
        let isTeacher = false;
        let isCoTeacher = false;
        let isStudent = false;
        let isRaisingHandsPaused = true; // Initial state
        let currentFilter = 'Unanswered';
        let currentRequest = null; // Stores the request object currently viewed in the modal
        let lastTitleUpdate = 0; // Timestamp for last tab title change

        // --- DOM Elements ---
        const teacherNav = document.getElementById('teacher-nav');
        const studentNav = document.getElementById('student-nav');
        const roleIndicator = document.getElementById('role-indicator');
        const currentUserIdDisplay = document.getElementById('current-user-id');
        const loadingSpinner = document.getElementById('loading-spinner');
        const requestsListTeacher = document.getElementById('requests-list-container');
        const studentRequestsList = document.getElementById('student-requests-list');
        const pauseHandsBtn = document.getElementById('pause-hands-btn');
        const pauseIcon = document.getElementById('pause-icon');
        const pauseText = document.getElementById('pause-text');
        const deleteClassSection = document.getElementById('delete-class-section');
        const noRequestsMsgTeacher = document.getElementById('no-requests-msg-teacher');
        const noRequestsMsgStudent = document.getElementById('no-requests-msg-student');
        
        const teacherViews = {
            'main-teacher': document.getElementById('main-teacher'),
            'settings-teacher': document.getElementById('settings-teacher-view'),
            'co-teachers': document.getElementById('co-teachers-view'),
            'classes-teacher': document.getElementById('classes-teacher-view'),
        };
        const studentViews = {
            'main-student': document.getElementById('main-student'),
            'settings-student': document.getElementById('settings-student-view'),
        };
        const allViews = { ...teacherViews, ...studentViews };
        const filterContainers = {
            teacher: document.getElementById('request-filters-teacher'),
            student: document.getElementById('request-filters-student')
        };
        
        // --- UTILITY FUNCTIONS ---
        
        // Converts current time to a 4-digit HHMM string (24hr format)
        function getCurrentTimeCode() {
            const now = new Date();
            const h = String(now.getHours()).padStart(2, '0');
            const m = String(now.getMinutes()).padStart(2, '0');
            return `${h}${m}`;
        }

        // Converts 4-digit code (HHMM) to 24-hour minutes from midnight
        function timeCodeToMinutes(code) {
            const h = parseInt(code.slice(0, 2), 10);
            const m = parseInt(code.slice(2, 4), 10);
            return h * 60 + m;
        }

        function formatRequestTime(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate();
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function showMessage(text) {
            document.getElementById('message-text').textContent = text;
            document.getElementById('message-modal').classList.remove('hidden');
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        // --- AUTH & ROLE MANAGEMENT ---

        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                await setPersistence(auth, browserLocalPersistence);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        await determineUserRole(userId);
                        isAuthReady = true;
                        loadingSpinner.classList.add('hidden');
                        
                        // Set up listeners based on role
                        if (isTeacher || isCoTeacher) {
                            setupTeacherListeners();
                            navigateTo('main-teacher');
                        } else if (isStudent) {
                            setupStudentListeners();
                            navigateTo('main-student');
                        } else {
                            // If role is undefined, sign out and sign in anonymously
                            await signOut(auth);
                            await signInAnonymously(auth);
                            showMessage("You are not part of this class. Please contact your teacher.");
                            loadingSpinner.classList.add('hidden');
                        }
                        updateUIBasedOnRole();
                        updatePauseButton(isRaisingHandsPaused); // Initial sync

                    } else {
                        // Not signed in, attempt custom token sign-in or anonymous sign-in
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (e) {
                            console.error("Auth failed:", e);
                            showMessage("Could not connect to the classroom. Please check your connection.");
                        }
                    }
                });
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                showMessage("Application setup failed. Check console for details.");
            }
        }

        async function determineUserRole(uid) {
            currentUserIdDisplay.textContent = `User ID: ${uid}`;
            
            const classRef = doc(db, CLASS_DOC_PATH);
            const classSnap = await getDoc(classRef);

            if (!classSnap.exists()) {
                // If class doesn't exist, we can't determine role, assume student or new user
                isStudent = true;
                return;
            }

            const classData = classSnap.data();
            const coTeacherIds = classData.coTeacherIds || [];
            
            isTeacher = classData.teacherId === uid;
            isCoTeacher = coTeacherIds.includes(uid);
            
            // If not explicitly T/CT, and a student roster existed, we might check that. 
            // For now, we assume if not T/CT, they are a student if the class exists.
            isStudent = !isTeacher && !isCoTeacher; 

            // Initial sync of hand-raising state and schedule
            isRaisingHandsPaused = classData.isRaisingHandsPaused ?? true;
            
            // Pre-fill schedule inputs
            const schedule = classData.schedule;
            if (schedule) {
                document.getElementById('start-time-input').value = `${schedule.startTime.slice(0, 2)}:${schedule.startTime.slice(2, 4)}`;
                document.getElementById('end-time-input').value = `${schedule.endTime.slice(0, 2)}:${schedule.endTime.slice(2, 4)}`;
            }
        }

        function updateUIBasedOnRole() {
            if (isTeacher) {
                roleIndicator.textContent = "Role: Teacher";
                teacherNav.classList.remove('hidden');
                studentNav.classList.add('hidden');
                deleteClassSection.classList.remove('hidden'); // Teacher can delete
                renderFilterButtons('teacher');
            } else if (isCoTeacher) {
                roleIndicator.textContent = "Role: Co-Teacher";
                teacherNav.classList.remove('hidden');
                studentNav.classList.add('hidden');
                deleteClassSection.classList.add('hidden'); // Co-teacher cannot delete
                renderFilterButtons('teacher');
            } else if (isStudent) {
                roleIndicator.textContent = "Role: Student";
                teacherNav.classList.add('hidden');
                studentNav.classList.remove('hidden');
                renderFilterButtons('student');
            } else {
                roleIndicator.textContent = "Role: Unknown";
            }
        }

        // --- NAVIGATION & VIEW MANAGEMENT ---
        
        // Maps button ID parts to their original icons
        const originalNav = {
            'settings': { icon: 'fa-cog', id: 'nav-settings-btn' },
            'co-teachers': { icon: 'fa-users', id: 'nav-co-teachers-btn' },
            'classes': { icon: 'fa-chalkboard-teacher', id: 'nav-classes-btn' }
        };

        function setNavButtonToHome(buttonIdPart, isActive) {
            const btn = document.getElementById(originalNav[buttonIdPart].id);
            if (!btn) return;
            const iconElement = btn.querySelector('i');

            if (isActive) {
                // Change to blue 'Home' button
                btn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                btn.classList.add('bg-blue-500', 'text-white', 'hover:bg-blue-600');
                iconElement.className = 'fas fa-home text-xl';
                btn.setAttribute('onclick', `MapsTo('main-teacher')`);
            } else {
                // Revert to original grey button
                btn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                btn.classList.remove('bg-blue-500', 'text-white', 'hover:bg-blue-600');
                iconElement.className = `fas ${originalNav[buttonIdPart].icon} text-xl`;
                btn.setAttribute('onclick', `MapsTo('${buttonIdPart}-view' in teacherViews ? '${buttonIdPart}-view' : '${buttonIdPart}')`);
            }
        }

        function navigateTo(viewName) {
            // Hide all content views
            Object.values(allViews).forEach(view => view.classList.add('hidden'));

            // Show the requested view
            const targetView = allViews[viewName] || allViews[`${viewName}-view`];
            if (targetView) {
                targetView.classList.remove('hidden');
            } else {
                console.error('Unknown view:', viewName);
                return;
            }

            // Handle Teacher/Co-Teacher Navigation Buttons (Home Button Logic)
            if (isTeacher || isCoTeacher) {
                const isMainView = viewName.startsWith('main');
                const navButtonParts = ['settings', 'co-teachers', 'classes'];
                
                navButtonParts.forEach(part => {
                    const isActive = viewName.includes(part);
                    setNavButtonToHome(part, isActive && !isMainView);
                });

                if (viewName === 'main-teacher') {
                    renderRequests(); // Rerender on return to main
                }
            }
        }

        // --- REQUEST FILTERING ---

        function renderFilterButtons(role) {
            const filters = ["Unanswered", "Accepted", "Denied", "Commented on"];
            const container = filterContainers[role];
            container.innerHTML = '';

            filters.forEach(filter => {
                const btn = document.createElement('button');
                btn.textContent = filter;
                btn.className = `px-4 py-2 rounded-full font-medium text-sm transition duration-150 ease-in-out whitespace-nowrap`;
                
                if (filter === currentFilter) {
                    btn.classList.add('bg-blue-500', 'text-white', 'shadow-md');
                } else {
                    btn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                }
                
                btn.onclick = () => {
                    currentFilter = filter;
                    renderFilterButtons(role); // Re-render to update active state
                    renderRequests(); // Re-render requests list
                    if (role === 'student') renderStudentRequests();
                };
                container.appendChild(btn);
            });
        }

        // --- HAND RAISING / PAUSE TOGGLE ---

        function updatePauseButton(isPaused) {
            isRaisingHandsPaused = isPaused;
            if (isPaused) {
                // PAUSED state: Gray/Default styling, Pause icon
                pauseIcon.classList.replace('fa-play', 'fa-pause');
                pauseText.textContent = 'Pause Hand Raising'; 
                pauseHandsBtn.classList.remove('bg-green-500', 'text-white', 'hover:bg-green-600');
                pauseHandsBtn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            } else {
                // ENABLED state: Green styling, Play icon
                pauseIcon.classList.replace('fa-pause', 'fa-play');
                pauseText.textContent = 'Resume Hand Raising'; 
                pauseHandsBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                pauseHandsBtn.classList.add('bg-green-500', 'text-white', 'hover:bg-green-600');
            }
        }

        pauseHandsBtn.addEventListener('click', async () => {
            if (!isAuthReady || !db) return showMessage("App not ready.");
            const newPauseState = !isRaisingHandsPaused;
            
            // Optimistic UI update (will be reverted by listener on error)
            updatePauseButton(newPauseState); 
            
            try {
                const classRef = doc(db, CLASS_DOC_PATH);
                await updateDoc(classRef, { isRaisingHandsPaused: newPauseState });
            } catch (error) {
                console.error("Error toggling hand raising status:", error);
                updatePauseButton(!newPauseState); // Revert on error
                showMessage("Failed to update status.");
            }
        });


        // --- FIREBASE LISTENERS ---

        function setupTeacherListeners() {
            // Listener 1: Real-time Requests
            const requestsRef = collection(db, CLASS_DOC_PATH, 'requests');
            const q = query(requestsRef);

            onSnapshot(q, (snapshot) => {
                const allRequests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderRequests(allRequests);
                checkForNewRequests(allRequests);
            }, (error) => {
                console.error("Error listening to requests:", error);
            });
            
            // Listener 2: Real-time Class Data (Schedule & Pause Status)
            const classRef = doc(db, CLASS_DOC_PATH);
            onSnapshot(classRef, (docSnap) => {
                if (docSnap.exists() && isAuthReady) {
                    const data = docSnap.data();
                    
                    // 1. Update pause state dynamically (using the new status field)
                    const newPauseState = data.isRaisingHandsPaused ?? true;
                    updatePauseButton(newPauseState);

                    // 2. Schedule logic check
                    checkScheduleAndToggleHands(data.schedule);
                }
            }, (error) => {
                console.error("Error listening to class data:", error);
            });
        }

        function setupStudentListeners() {
            // Listener 1: Real-time Class Data for pause status
            const classRef = doc(db, CLASS_DOC_PATH);
            onSnapshot(classRef, (docSnap) => {
                if (docSnap.exists() && isAuthReady) {
                    const data = docSnap.data();
                    const newPauseState = data.isRaisingHandsPaused ?? true;
                    updatePauseButton(newPauseState);
                }
            }, (error) => {
                console.error("Error listening to class data:", error);
            });
            
            // Listener 2: Student's requests (for today)
            const requestsRef = collection(db, CLASS_DOC_PATH, 'requests');
            const startOfToday = Timestamp.fromDate(new Date(new Date().setHours(0, 0, 0, 0)));

            const q = query(requestsRef, 
                where('studentId', '==', userId), 
                where('timestamp', '>=', startOfToday)
            );

            onSnapshot(q, (snapshot) => {
                const studentRequests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderStudentRequests(studentRequests);
            }, (error) => {
                console.error("Error listening to student's requests:", error);
            });
        }
        
        // --- REQUEST RENDERING & UI UPDATES ---

        let allTeacherRequests = [];
        
        function checkForNewRequests(allRequests) {
            const unansweredCount = allRequests.filter(r => r.status === 'Unanswered').length;
            
            // Tab title logic (Teacher/Co-Teacher only)
            if (isTeacher || isCoTeacher) {
                const baseTitle = "Notify | Dashboard";
                if (unansweredCount > 0) {
                    document.title = `(${unansweredCount}) New Request${unansweredCount > 1 ? 's' : ''}! | ${baseTitle}`;
                    lastTitleUpdate = Date.now();
                } else if (Date.now() - lastTitleUpdate > 5000) {
                    // Only revert after 5 seconds to prevent flicker
                    document.title = baseTitle;
                }
            }
        }

        function renderRequests(allRequests = allTeacherRequests) {
            if (!isAuthReady) return;
            allTeacherRequests = allRequests;
            requestsListTeacher.innerHTML = '';
            
            const filteredRequests = allRequests.filter(request => {
                const status = request.status || 'Unanswered';
                if (currentFilter === 'Unanswered') {
                    return status === 'Unanswered';
                }
                return status === currentFilter;
            }).sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());

            noRequestsMsgTeacher.classList.toggle('hidden', filteredRequests.length > 0);

            filteredRequests.forEach(request => {
                const element = document.createElement('div');
                element.className = 'flex justify-between items-center p-4 bg-gray-50 rounded-lg shadow hover:bg-gray-100 cursor-pointer';
                element.onclick = () => openRequestDetail(request);
                
                const timeStr = formatRequestTime(request.timestamp);
                
                element.innerHTML = `
                    <div class="flex flex-col">
                        <span class="font-semibold text-gray-800">${request.studentName || 'Student'}</span>
                        <span class="text-sm text-gray-500">${request.requestText.substring(0, 50)}...</span>
                    </div>
                    <div class="text-right">
                        <span class="text-xs font-mono text-gray-600">${timeStr}</span>
                        ${request.status !== 'Unanswered' ? `<span class="ml-2 px-2 py-0.5 text-xs rounded-full ${getStatusClasses(request.status)}">${request.status}</span>` : ''}
                    </div>
                `;
                requestsListTeacher.appendChild(element);
            });
        }
        
        function renderStudentRequests(studentRequests) {
            if (!isAuthReady) return;
            studentRequestsList.innerHTML = '';

            const filteredRequests = studentRequests.filter(request => {
                const status = request.status || 'Unanswered';
                if (currentFilter === 'Unanswered') {
                    return status === 'Unanswered';
                }
                return status === currentFilter;
            }).sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());

            noRequestsMsgStudent.classList.toggle('hidden', filteredRequests.length > 0);

            filteredRequests.forEach(request => {
                const element = document.createElement('div');
                element.className = 'flex justify-between items-center p-4 bg-gray-50 rounded-lg shadow';
                
                const timeStr = formatRequestTime(request.timestamp);
                
                element.innerHTML = `
                    <div class="flex flex-col">
                        <span class="font-semibold text-gray-800">${request.requestText.substring(0, 50)}...</span>
                        ${request.comment ? `<span class="text-sm text-blue-500 mt-1"><i class="fas fa-comment text-xs mr-1"></i> ${request.comment.substring(0, 30)}...</span>` : ''}
                    </div>
                    <div class="text-right">
                        <span class="text-xs font-mono text-gray-600">${timeStr}</span>
                        <span class="ml-2 px-2 py-0.5 text-xs rounded-full ${getStatusClasses(request.status)}">${request.status}</span>
                    </div>
                `;
                studentRequestsList.appendChild(element);
            });
        }

        function getStatusClasses(status) {
            switch(status) {
                case 'Accepted': return 'bg-green-100 text-green-700';
                case 'Denied': return 'bg-red-100 text-red-700';
                case 'Commented on': return 'bg-yellow-100 text-yellow-700';
                default: return 'bg-blue-100 text-blue-700';
            }
        }
        
        // --- TEACHER ACTIONS ---
        
        function openRequestDetail(request) {
            currentRequest = request;
            document.getElementById('modal-student-name').textContent = request.studentName || request.studentId;
            document.getElementById('modal-request-time').textContent = formatRequestTime(request.timestamp);
            document.getElementById('modal-request-text').textContent = request.requestText;
            
            const comment = request.comment;
            const commentBtnEdit = document.getElementById('comment-btn-edit');
            const commentBtnDelete = document.getElementById('comment-btn-delete');
            const commentEditor = document.getElementById('comment-editor');
            const commentInput = document.getElementById('comment-input');
            
            // Reset state
            commentEditor.classList.add('hidden');
            commentInput.value = comment || '';
            
            // Dynamic comment button state
            if (comment) {
                // If comment exists, use the split button style (top for edit, bottom for delete)
                commentBtnDelete.classList.remove('hidden');
                commentBtnEdit.classList.add('comment-btn-top');
                commentBtnEdit.classList.remove('h-full');
            } else {
                // If no comment, use the full button style
                commentBtnDelete.classList.add('hidden');
                commentBtnEdit.classList.remove('comment-btn-top');
                commentBtnEdit.classList.add('h-full');
            }
            
            document.getElementById('request-detail-modal').classList.remove('hidden');
        }

        function openCommentEditor() {
            const commentEditor = document.getElementById('comment-editor');
            commentEditor.classList.remove('hidden');
            document.getElementById('comment-input').focus();
        }

        function closeCommentEditor() {
            document.getElementById('comment-editor').classList.add('hidden');
            // Re-open the request detail to ensure the button split state is correct after potential cancel
            if (currentRequest) {
                openRequestDetail(currentRequest); 
            }
        }

        async function handleRequestAction(status, isDeleteComment = false) {
            if (!currentRequest) return;
            const requestRef = doc(db, CLASS_DOC_PATH, 'requests', currentRequest.id);
            const updateData = {
                status: status,
                teacherId: userId,
                comment: currentRequest.comment // Keep existing comment unless explicitly changed
            };
            
            if (status === 'Commented') {
                const commentInput = document.getElementById('comment-input').value.trim();
                
                if (isDeleteComment) {
                    updateData.comment = null;
                } else if (commentInput.length > 0) {
                    updateData.comment = commentInput;
                    closeCommentEditor();
                } else {
                    // If the user tries to save an empty comment on a non-deleted status
                    if (!currentRequest.comment) {
                         showMessage("Comment cannot be empty.");
                         return;
                    }
                    // If they clear the input, treat it as deleting the comment
                    updateData.comment = null;
                }
            } else {
                 // For Accepted/Denied, clear comment
                 updateData.comment = null;
            }

            try {
                await updateDoc(requestRef, updateData);
                closeModal('request-detail-modal');
                currentRequest = null;
                showMessage(`Request successfully ${status.toLowerCase()}.`);
            } catch (e) {
                console.error("Error updating request status:", e);
                showMessage("Failed to update request status. Check permissions.");
            }
        }

        // --- STUDENT ACTIONS ---
        
        function createRequestModal() {
            if (isRaisingHandsPaused) {
                showMessage("Hand raising is currently paused by the teacher.");
                return;
            }
            document.getElementById('create-request-modal').classList.remove('hidden');
            document.getElementById('new-request-input').value = '';
            document.getElementById('new-request-input').focus();
        }

        async function submitNewRequest() {
            const requestText = document.getElementById('new-request-input').value.trim();
            const errorElement = document.getElementById('request-error');

            if (requestText.length === 0) {
                errorElement.textContent = "Please enter your request.";
                errorElement.classList.remove('hidden');
                return;
            }
            errorElement.classList.add('hidden');

            try {
                const requestsCollection = collection(db, CLASS_DOC_PATH, 'requests');
                
                // Mock student name for display on teacher's side
                const studentName = 'Student ' + userId.substring(0, 4);

                await addDoc(requestsCollection, {
                    studentId: userId,
                    studentName: studentName,
                    requestText: requestText,
                    timestamp: Timestamp.now(),
                    status: 'Unanswered', 
                    comment: null
                });

                closeModal('create-request-modal');
                showMessage("Your request has been sent!");

            } catch (e) {
                console.error("Error submitting request:", e);
                showMessage("Failed to submit request. Try again.");
            }
        }

        // --- SCHEDULE LOGIC ---

        // Input formatter logic for time inputs (24-hour HH:MM format enforced)
        document.querySelectorAll('.time-input').forEach(input => {
            input.addEventListener('input', (e) => {
                let currentDigits = e.target.value.replace(/\D/g, ''); 
                const maxDigits = 4;

                if (currentDigits.length > maxDigits) {
                    currentDigits = currentDigits.slice(0, maxDigits);
                }

                let h_str = currentDigits.slice(0, 2).padStart(2, '0');
                let m_str = currentDigits.slice(2, 4).padEnd(2, '0');

                // Basic validation for 24-hour format (00-23 hours, 00-59 minutes)
                let h = parseInt(h_str, 10);
                let m = parseInt(m_str, 10);

                if (h > 23) h_str = '23';
                if (m > 59) m_str = '59';

                const formattedValue = `${h_str}:${m_str}`;
                if (input.value !== formattedValue) {
                    input.value = formattedValue;
                }
            });

            input.addEventListener('blur', (e) => {
                let val = e.target.value.replace(/\D/g, '').padEnd(4, '0').slice(0, 4);
                let h = parseInt(val.slice(0, 2), 10);
                let m = parseInt(val.slice(2, 4), 10);

                // Final check and normalization to 24-hour format
                if (h > 23) h = 23;
                if (m > 59) m = 59;
                
                const finalValue = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                e.target.value = finalValue;
            });
        });

        async function saveSchedule() {
            if (!isAuthReady || !db) return showMessage("App not ready.");
            // Extract HHMM string without colon for storage
            const startTimeStorage = document.getElementById('start-time-input').value.replace(':', '');
            const endTimeStorage = document.getElementById('end-time-input').value.replace(':', '');

            try {
                const classRef = doc(db, CLASS_DOC_PATH);
                await setDoc(classRef, { 
                    schedule: {
                        startTime: startTimeStorage,
                        endTime: endTimeStorage
                    }
                }, { merge: true });
                showMessage("Class schedule saved successfully!");
            } catch (e) {
                console.error("Error saving schedule:", e);
                showMessage("Failed to save schedule.");
            }
        }

        async function checkScheduleAndToggleHands(schedule) {
            // Function to check and update hands-up state based on the schedule every minute
            if (!schedule || !isTeacher && !isCoTeacher) return;

            const startCode = schedule.startTime; 
            const endCode = schedule.endTime; 
            
            if (!startCode || !endCode || startCode.length !== 4 || endCode.length !== 4) {
                return; // Schedule incomplete
            }

            const nowCode = getCurrentTimeCode();
            
            const startMins = timeCodeToMinutes(startCode);
            const endMins = timeCodeToMinutes(endCode);
            let nowMins = timeCodeToMinutes(nowCode);
            
            let shouldBeEnabled = false;

            // Check if current time is within the schedule period (handles midnight crossing)
            if (startMins <= endMins) {
                shouldBeEnabled = (nowMins >= startMins && nowMins < endMins);
            } else {
                shouldBeEnabled = (nowMins >= startMins || nowMins < endMins);
            }

            const newPauseState = !shouldBeEnabled;

            if (isAuthReady && newPauseState !== isRaisingHandsPaused) {
                try {
                    const classRef = doc(db, CLASS_DOC_PATH);
                    // Only update if the state needs to change
                    await updateDoc(classRef, { isRaisingHandsPaused: newPauseState });
                } catch (e) {
                    console.error("Error auto-toggling hand raising:", e);
                }
            }

            // Set a timeout to run this check at the start of the next minute
            const now = new Date();
            const delay = (60 - now.getSeconds()) * 1000 + (1000 - now.getMilliseconds());
            
            setTimeout(() => {
                // Re-trigger the check
                checkScheduleAndToggleHands(schedule); 
            }, delay); 
        }

        // --- Class Deletion (Teacher Only Placeholder) ---
        
        function deleteClass() {
            showMessage("Are you absolutely sure you want to delete this class? This cannot be undone.\n\n(Note: In a real app, this would be a detailed confirmation modal.)");
        }
        
        // --- STUDENT SETTINGS ---

        async function saveLocalName() {
            const localName = document.getElementById('local-name-input').value.trim();
            const userDocPath = `/artifacts/${appId}/users/${userId}/class_settings/${CLASS_ID}`;
            
            try {
                const userRef = doc(db, userDocPath);
                await setDoc(userRef, { localClassName: localName }, { merge: true });
                showMessage(`Local class name saved as "${localName}".`);
            } catch (e) {
                console.error("Error saving local name:", e);
                showMessage("Failed to save local name.");
            }
        }

        async function leaveClass() {
            showMessage("Are you sure you want to leave this class?\n\n(Note: In a real app, this would be a detailed confirmation modal.)");
        }

        // --- INITIALIZATION ---
        initFirebase();
    </script>
</body>
</html>
