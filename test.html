<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Notify</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-poppins { font-family: 'Poppins', sans-serif; }
        /* Custom scrollbar for a cleaner look in settings */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
        /* To make the main content area scrollable without affecting the topbar */
        .main-layout {
            height: calc(100vh - 4rem); /* 4rem is the height of the header */
        }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden">

    <!-- App Container -->
    <div class="flex flex-col h-full">

        <!-- Header -->
        <header class="bg-white border-b border-gray-200 shadow-sm sticky top-0 z-20 h-16 flex-shrink-0">
            <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <a href="index.html" class="flex items-center space-x-3">
                        <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                        <h1 class="text-xl font-bold text-gray-800">Notify</h1>
                    </a>
                    <div class="relative">
                        <button id="user-profile-btn" type="button" class="flex items-center justify-center w-10 h-10 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                             <img id="user-profile-pic" class="w-full h-full rounded-lg object-cover hidden" src="" alt="User profile picture">
                             <div id="user-profile-initial" class="w-full h-full rounded-lg flex items-center justify-center bg-gradient-to-br from-blue-600 to-indigo-700 text-white font-bold text-lg hidden">
                                 <!-- Initial will be set here -->
                             </div>
                        </button>
                        <!-- Dropdown Menu -->
                        <div id="user-profile-menu" class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden" role="menu" aria-orientation="vertical" tabindex="-1">
                            <div class="py-1" role="none">
                                <div class="flex items-center px-4 py-2">
                                     <div class="flex-shrink-0">
                                         <img id="user-profile-pic-menu" class="h-10 w-10 rounded-md object-cover hidden" src="" alt="">
                                         <div id="user-profile-initial-menu" class="h-10 w-10 rounded-md flex items-center justify-center bg-gradient-to-br from-blue-600 to-indigo-700 text-white font-bold text-lg hidden"></div>
                                     </div>
                                     <div class="ml-3 min-w-0">
                                         <p id="user-display-name-menu" class="text-sm font-semibold text-gray-800 truncate">Loading...</p>
                                         <p id="user-email-menu" class="text-xs text-gray-500 truncate">Loading...</p>
                                     </div>
                                </div>
                                <hr class="border-gray-200">
                                <a href="#" id="logout-btn" class="text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem" tabindex="-1">Logout</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Main Layout (Sidebar + Content) -->
        <div class="flex flex-1 main-layout overflow-hidden">

            <!-- Sidebar -->
            <aside class="w-64 bg-white border-r border-gray-200 flex flex-col flex-shrink-0">
                <!-- Class List -->
                <div id="class-list-container" class="flex-grow p-4 overflow-y-auto">
                    <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">My Classes</h2>
                    <ul id="class-list" class="space-y-2"></ul>
                    <div id="no-classes-sidebar" class="text-center text-sm text-gray-500 mt-4 hidden">
                        <p>You haven't joined or created any classes yet.</p>
                    </div>
                </div>
                <!-- Sidebar Actions (for teachers) -->
                <div id="teacher-sidebar-actions" class="p-4 border-t border-gray-200 hidden">
                    <button id="create-another-class-btn" class="w-full bg-blue-50 text-blue-700 font-semibold py-2 px-4 rounded-lg hover:bg-blue-100 transition-colors duration-150 flex items-center justify-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        <span>New Class</span>
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 flex flex-col overflow-hidden">
                 <!-- Main content area -->
                 <div class="flex-1 overflow-y-auto bg-gray-100 p-6">
                    <!-- Empty State View -->
                    <div id="empty-state-view" class="h-full flex items-center justify-center text-center">
                        <div>
                             <svg class="w-16 h-16 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                             <h2 class="mt-4 text-xl font-semibold text-gray-700">No Class Selected</h2>
                             <p class="mt-1 text-gray-500">Select a class from the sidebar to view details, or create/join a new one to get started.</p>
                             <div id="empty-state-actions" class="mt-6">
                                <button id="create-class-btn-main" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Create a Class</button>
                                <button id="join-class-btn-main" class="bg-white text-gray-700 font-bold py-2 px-4 rounded-lg border border-gray-300 hover:bg-gray-100 transition-colors ml-2">Join a Class</button>
                             </div>
                        </div>
                    </div>

                    <!-- Class Content View -->
                    <div id="class-content-view" class="hidden">
                        <!-- Class Header & Tabs -->
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-6">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h2 id="class-name-header" class="text-2xl font-bold text-gray-800"></h2>
                                    <div class="flex items-center space-x-2 mt-1">
                                        <p id="class-code-header" class="text-sm text-gray-500"></p>
                                        <button id="invite-link-btn" title="Copy Invite Link" class="hidden text-gray-400 hover:text-blue-600">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
                                        </button>
                                        <span id="invite-copied-msg" class="text-xs text-green-600 font-medium hidden">Copied!</span>
                                    </div>
                                </div>
                                <div id="class-tabs" class="border-b border-gray-200">
                                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                                        <button id="tab-requests" class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-blue-500 text-blue-600">Requests</button>
                                        <button id="tab-settings" class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Settings</button>
                                    </nav>
                                </div>
                            </div>
                        </div>

                        <!-- Requests View -->
                        <div id="requests-view">
                            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-800">Student Requests</h3>
                                <p class="text-gray-500 mt-2">This feature is coming soon. Students in this class will be able to raise their hands digitally, and their requests will appear here in real-time.</p>
                            </div>
                        </div>

                        <!-- Settings View -->
                        <div id="settings-view" class="hidden max-w-4xl mx-auto space-y-8 custom-scrollbar">
                           <!-- ... (All settings sections remain the same) ... -->
                           <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                               <h3 class="text-lg font-semibold text-gray-800 border-b pb-3 mb-4">General</h3>
                               <div class="space-y-4">
                                   <div>
                                       <label for="class-name-input" class="block text-sm font-medium text-gray-700">Class Name</label>
                                       <input type="text" id="class-name-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                   </div>
                                   <button id="save-class-name-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Save Changes</button>
                               </div>
                           </div>
                           <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                               <h3 class="text-lg font-semibold text-gray-800 border-b pb-3 mb-4">Class Schedule</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                   <div>
                                       <label for="start-time-input" class="block text-sm font-medium text-gray-700">Starts at</label>
                                       <input type="time" id="start-time-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                   </div>
                                   <div>
                                       <label for="end-time-input" class="block text-sm font-medium text-gray-700">Ends at</label>
                                       <input type="time" id="end-time-input" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                   </div>
                               </div>
                               <p class="mt-3 text-xs text-gray-500">Note: Schedule uses the local device's date and time and is assumed to apply on weekdays.</p>
                                <button id="save-schedule-btn" class="mt-4 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Save Schedule</button>
                           </div>
                           <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                               <h3 class="text-lg font-semibold text-gray-800 border-b pb-3 mb-4">Preset Hand-Raising Questions</h3>
                               <div id="preset-questions-list" class="space-y-3 mb-4"></div>
                               <div class="flex space-x-2">
                                   <input type="text" id="new-preset-input" placeholder="e.g., I need help with Question 5" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                   <button id="add-preset-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 whitespace-nowrap">Add Preset</button>
                               </div>
                           </div>
                            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                               <h3 class="text-lg font-semibold text-gray-800 border-b pb-3 mb-4">Manage Students</h3>
                               <ul id="student-roster-list" class="divide-y divide-gray-200"></ul>
                           </div>
                           <div class="bg-white p-6 rounded-lg shadow-sm border border-red-300">
                               <h3 class="text-lg font-semibold text-red-800 border-b border-red-200 pb-3 mb-4">Danger Zone</h3>
                               <div>
                                   <p class="text-sm text-gray-700">Deleting this class is a permanent action. All student data associated with this class will be lost, and students will be removed from the roster.</p>
                                   <button id="delete-class-btn" class="mt-4 bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">Delete This Class</button>
                               </div>
                           </div>
                        </div>
                    </div>
                 </div>
            </main>
        </div>
    </div>
    
    <!-- All Modals remain the same -->
    <!-- ... -->

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <script src="../firebase-config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof firebaseConfig === 'undefined') {
                console.error("Firebase config not found.");
                document.body.innerHTML = '<div class="text-center p-8">Error: Firebase configuration is missing.</div>';
                return;
            }

            const app = firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();

            let currentUser = null;
            let userData = null;
            let currentClassId = null;
            let currentClassData = null;

            // --- UI Elements ---
            const userProfileBtn = document.getElementById('user-profile-btn');
            const userProfileMenu = document.getElementById('user-profile-menu');
            const userProfilePic = document.getElementById('user-profile-pic');
            const userProfileInitial = document.getElementById('user-profile-initial');
            const userProfilePicMenu = document.getElementById('user-profile-pic-menu');
            const userProfileInitialMenu = document.getElementById('user-profile-initial-menu');
            const emptyStateView = document.getElementById('empty-state-view');
            const classContentView = document.getElementById('class-content-view');
            const tabRequests = document.getElementById('tab-requests');
            const tabSettings = document.getElementById('tab-settings');
            const requestsView = document.getElementById('requests-view');
            const settingsView = document.getElementById('settings-view');
            const inviteLinkBtn = document.getElementById('invite-link-btn');
            
            // --- Authentication & UI Setup ---
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    fetchUserData(user.uid);
                } else {
                    window.location.href = 'login.html';
                }
            });

            async function fetchUserData(uid) {
                const userDoc = await db.collection('users').doc(uid).get();
                if (userDoc.exists) {
                    userData = userDoc.data();
                    updateProfileUI(currentUser, userData);
                    listenForClasses(uid);
                } else {
                    console.error("User data not found in Firestore.");
                    auth.signOut();
                }
            }
            
            function updateProfileUI(user, data) {
                // Update profile menu details
                document.getElementById('user-display-name-menu').textContent = data.username;
                document.getElementById('user-email-menu').textContent = user.email;

                // Update profile button icon
                if (user.photoURL) {
                    userProfilePic.src = user.photoURL;
                    userProfilePicMenu.src = user.photoURL;
                    userProfilePic.classList.remove('hidden');
                    userProfilePicMenu.classList.remove('hidden');
                    userProfileInitial.classList.add('hidden');
                    userProfileInitialMenu.classList.add('hidden');
                } else {
                    const initial = data.username.charAt(0).toUpperCase();
                    userProfileInitial.textContent = initial;
                    userProfileInitialMenu.textContent = initial;
                    userProfileInitial.classList.remove('hidden');
                    userProfileInitialMenu.classList.remove('hidden');
                    userProfilePic.classList.add('hidden');
                    userProfilePicMenu.classList.add('hidden');
                }
                
                if (data.role === 'teacher') {
                    document.getElementById('teacher-sidebar-actions').classList.remove('hidden');
                    document.getElementById('empty-state-actions').children[1].style.display = 'none'; // Hide join for teacher in empty state
                } else {
                     document.getElementById('empty-state-actions').children[0].style.display = 'none'; // Hide create for student in empty state
                }
            }

            // --- Class Data Logic (largely unchanged, just adapted to new layout) ---
            function listenForClasses(uid) {
                db.collection('classes')
                  .where(`members.${uid}`, 'in', ['teacher', 'student'])
                  .onSnapshot(snapshot => {
                    document.getElementById('empty-state-actions').classList.toggle('hidden', !snapshot.empty);
                    if (snapshot.empty) {
                        displayNoClasses();
                        return;
                    }
                    const classes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderClassList(classes);
                    if(currentClassId) {
                        const updatedClassData = classes.find(c => c.id === currentClassId);
                        if(updatedClassData) selectClass(updatedClassData);
                        else resetToEmptyState();
                    }
                });
            }

            function displayNoClasses() {
                document.getElementById('class-list').innerHTML = '';
                document.getElementById('no-classes-sidebar').classList.remove('hidden');
                resetToEmptyState();
            }

            function renderClassList(classes) {
                document.getElementById('no-classes-sidebar').classList.add('hidden');
                const classListEl = document.getElementById('class-list');
                classListEl.innerHTML = '';
                classes.forEach(cls => {
                    const li = document.createElement('li');
                    const isActive = currentClassId === cls.id;
                    li.innerHTML = `<button data-class-id="${cls.id}" class="w-full text-left px-3 py-2 rounded-md font-medium text-sm transition-colors ${isActive ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:bg-gray-100 hover:text-gray-900'}">${cls.name}</button>`;
                    li.querySelector('button').addEventListener('click', () => selectClass(cls));
                    classListEl.appendChild(li);
                });
            }

            function resetToEmptyState() {
                currentClassId = null;
                currentClassData = null;
                emptyStateView.classList.remove('hidden');
                classContentView.classList.add('hidden');
            }

            function selectClass(classData) {
                currentClassId = classData.id;
                currentClassData = classData;
                
                const classListButtons = document.querySelectorAll('#class-list button');
                classListButtons.forEach(btn => {
                    const isActive = btn.dataset.classId === classData.id;
                    btn.classList.toggle('bg-blue-100', isActive);
                    btn.classList.toggle('text-blue-700', isActive);
                    btn.classList.toggle('text-gray-600', !isActive);
                });

                emptyStateView.classList.add('hidden');
                classContentView.classList.remove('hidden');
                document.getElementById('class-name-header').textContent = classData.name;
                document.getElementById('class-code-header').textContent = `Class Code: ${classData.code}`;
                
                inviteLinkBtn.classList.toggle('hidden', userData.role !== 'teacher');
                
                if(userData.role === 'teacher') {
                    tabSettings.classList.remove('hidden');
                    populateSettingsView(classData);
                } else {
                    tabSettings.classList.add('hidden');
                }
                
                populateRequestsView(classData);
                showRequestsView();
            }
            
            function showRequestsView() {
                requestsView.classList.remove('hidden');
                settingsView.classList.add('hidden');
                tabRequests.classList.add('border-blue-500', 'text-blue-600');
                tabSettings.classList.remove('border-blue-500', 'text-blue-600');
            }

            function showSettingsView() {
                requestsView.classList.add('hidden');
                settingsView.classList.remove('hidden');
                tabSettings.classList.add('border-blue-500', 'text-blue-600');
                tabRequests.classList.remove('border-blue-500', 'text-blue-600');
            }

            function populateRequestsView(data) { /* ... Placeholder ... */ }
            function populateSettingsView(data) { /* ... Same as before ... */ }
            async function populateStudentRoster(members) { /* ... Same as before ... */ }

            // --- Event Listeners ---
            userProfileBtn.addEventListener('click', () => {
                userProfileMenu.classList.toggle('hidden');
            });
            
            document.addEventListener('click', (event) => {
                if (!userProfileBtn.contains(event.target) && !userProfileMenu.contains(event.target)) {
                    userProfileMenu.classList.add('hidden');
                }
            });

            document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());
            tabRequests.addEventListener('click', showRequestsView);
            tabSettings.addEventListener('click', showSettingsView);

            inviteLinkBtn.addEventListener('click', () => {
                if (!currentClassId) return;
                const inviteURL = `${window.location.origin}/invite.html?classId=${currentClassId}`;
                navigator.clipboard.writeText(inviteURL).then(() => {
                    const msg = document.getElementById('invite-copied-msg');
                    msg.classList.remove('hidden');
                    setTimeout(() => msg.classList.add('hidden'), 2000);
                }).catch(err => {
                    console.error('Failed to copy invite link: ', err);
                    alert('Failed to copy link.');
                });
            });

        });
    </script>
</body>
</html>

