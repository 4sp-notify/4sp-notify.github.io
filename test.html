<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Notify</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJzL/G6S8jH9D/gU2FowM9I5yT8W4j6P3+9zW5gH6K9z5Yl+O0s/v6y4g==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    
    <style>
        /* General Styles */
        body { 
            font-family: 'Inter', sans-serif; 
            scroll-behavior: smooth; 
        }
        .font-poppins { 
            font-family: 'Poppins', sans-serif; 
        }
        .main-layout { 
            height: calc(100vh - 4rem); 
        }

        /* Cookie Overlay */
        .cookie-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease-out;
        }

        /* Cookie Icon Styles */
        .cookie-icon {
            color: #d1d5db; /* light-gray-300 */
            transition: transform 0.3s ease-out;
        }
        .cookie-accepted {
            transform: scale(1.1) rotate(5deg);
        }
        .cookie-denied {
            transform: scale(1.0);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { 
            width: 8px; 
        }
        .custom-scrollbar::-webkit-scrollbar-track { 
            background: #f1f5f9; 
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb { 
            background: #cbd5e1; 
            border-radius: 4px; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { 
            background: #94a3b8; 
        }

        /* Marquee Text Animation */
        .marquee-container { 
            overflow: hidden; 
            white-space: nowrap; 
        }
        .marquee { 
            display: inline-block; 
            padding-left: 100%; 
            animation: marquee 10s linear infinite; 
        }
        @keyframes marquee {
            0%   { transform: translate(0, 0); }
            100% { transform: translate(-100%, 0); }
        }

        /* Component Fade Animations */
        .fade-enter, .fade-leave-to { 
            opacity: 0; 
            transform: scale(0.95); 
        }
        .fade-enter-active, .fade-leave-active { 
            transition: opacity 200ms ease-out, transform 200ms ease-out; 
        }
        .fade-enter-to, .fade-leave { 
            opacity: 1; 
            transform: scale(1); 
        }
        
        /* Bubbly Button Animation */
        .btn-bubbly { 
            transition: transform 0.1s ease-out; 
        }
        .btn-bubbly:active { 
            transform: scale(0.95); 
        }

        /* Particle CSS */
        .particle {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: #fca5a5; /* Cookie color */
            border-radius: 50%;
            pointer-events: none;
            opacity: 0;
            animation: explode 0.8s forwards;
        }
        @keyframes explode {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--x), var(--y)) scale(0);
                opacity: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden">

    <!-- Cookie Consent Screen -->
    <div id="cookie-consent-overlay" class="cookie-overlay">
        <!-- Content will be inserted by TPL.cookieConsentModal on load -->
    </div>

    <!-- Main Application Content (Initially hidden until consent) -->
    <div id="app-main-content" class="flex flex-col h-full hidden">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 shadow-sm sticky top-0 z-30 h-16 flex-shrink-0">
            <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <a href="index.html" class="flex items-center space-x-3">
                        <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                        <h1 class="text-xl font-bold font-poppins text-gray-800">Notify</h1>
                    </a>
                    <div class="relative">
                        <button id="user-profile-btn" type="button" class="btn-bubbly flex items-center justify-center w-10 h-10 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform duration-150 hover:scale-105">
                             <img id="user-profile-pic" class="w-full h-full rounded-lg object-cover hidden" src="" alt="User profile picture">
                             <div id="user-profile-initial" class="w-full h-full rounded-lg flex items-center justify-center bg-gradient-to-br from-blue-600 to-indigo-700 text-white font-bold text-lg hidden"></div>
                        </button>
                        <div id="user-profile-menu" class="origin-top-right absolute right-0 mt-2 w-64 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden" role="menu">
                            <div class="py-1" role="none">
                                <div class="flex items-center px-4 py-3">
                                     <div class="flex-shrink-0">
                                         <img id="user-profile-pic-menu" class="h-10 w-10 rounded-md object-cover hidden" src="" alt="">
                                         <div id="user-profile-initial-menu" class="h-10 w-10 rounded-md flex items-center justify-center bg-gradient-to-br from-blue-600 to-indigo-700 text-white font-bold text-lg hidden"></div>
                                     </div>
                                     <div class="ml-3 min-w-0">
                                         <div id="user-display-name-container" class="marquee-container">
                                             <p id="user-display-name-menu" class="text-sm font-semibold font-poppins text-gray-800 truncate">Loading...</p>
                                         </div>
                                         <div id="user-email-container" class="marquee-container">
                                             <p id="user-email-menu" class="text-xs text-gray-500 truncate">Loading...</p>
                                         </div>
                                     </div>
                                </div>
                                <div class="border-t border-gray-100"></div>
                                <a href="settings.html" class="font-medium text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100 flex items-center" role="menuitem" tabindex="-1">
                                     <svg class="w-5 h-5 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                         <span>Account Settings</span>
                                    </a>
                                    <a href="#" id="logout-btn" class="font-medium text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100 flex items-center" role="menuitem" tabindex="-1">
                                         <svg class="w-5 h-5 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                                         <span>Logout</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>
            
            <div class="flex flex-1 main-layout overflow-hidden">
                <aside class="w-64 bg-white border-r border-gray-200 flex flex-col flex-shrink-0">
                    <div id="class-list-container" class="flex-grow p-4 overflow-y-auto custom-scrollbar">
                        <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">My Classes</h2>
                        <ul id="class-list" class="space-y-2"></ul>
                        <div id="no-classes-sidebar" class="text-center text-sm text-gray-500 mt-4 hidden">
                            <p>No classes yet.</p>
                        </div>
                    </div>
                    <div id="teacher-sidebar-actions" class="p-4 border-t border-gray-200 hidden">
                        <button id="new-class-btn" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-150 flex items-center justify-center space-x-2 btn-bubbly">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            <span>New Class</span>
                        </button>
                    </div>
                </aside>
                <main class="flex-1 flex flex-col overflow-hidden">
                     <div id="main-content-area" class="flex-1 overflow-y-auto bg-gray-100 p-6 sm:p-8 custom-scrollbar">
                         <!-- Dynamic Content Rendered by JavaScript -->
                     </div>
                </main>
            </div>
        </div>
        
        <!-- Modals Container -->
        <div id="modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-60 z-40 hidden"></div>
        <div id="modal-container" class="fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none">
            <!-- Modal Content Injected Here -->
        </div>
        
    <!-- Main Application Content End -->

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>
    
    <script>
        // Global variable to track if Firebase has been initialized
        let firebaseInitialized = false;

        function initializeApp() {
            if (firebaseInitialized) return;

            // Show main app content
            document.getElementById('app-main-content').classList.remove('hidden');

            const app = firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();
            firebaseInitialized = true;

            let currentUser = null;
            let userData = null;
            let currentClassId = null;
            let currentClassData = null;
            let unsubscribes = [];
            let allLoadedClasses = {};

            const userProfileBtn = document.getElementById('user-profile-btn');
            const userProfileMenu = document.getElementById('user-profile-menu');
            const mainContentArea = document.getElementById('main-content-area');

            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    fetchUserData(user.uid);
                } else {
                    window.location.href = 'login.html';
                }
            });

            async function fetchUserData(uid) {
                const userDoc = await db.collection('users').doc(uid).get();
                if (userDoc.exists) {
                    userData = { uid, ...userDoc.data() };
                    updateProfileUI(currentUser, userData);
                    listenForClasses(uid, userData.role);
                    renderMainContent();
                } else {
                    auth.signOut();
                }
            }

            function applyMarqueeIfNeeded(textEl, containerEl) {
                setTimeout(() => {
                    if (textEl.scrollWidth > containerEl.clientWidth) textEl.classList.add('marquee');
                    else textEl.classList.remove('marquee');
                }, 100);
            }

            function updateProfileUI(user, data) {
                const displayNameEl = document.getElementById('user-display-name-menu');
                const emailEl = document.getElementById('user-email-menu');
                if (displayNameEl && emailEl) {
                    displayNameEl.textContent = data.username;
                    emailEl.textContent = user.email;
                    applyMarqueeIfNeeded(displayNameEl, document.getElementById('user-display-name-container'));
                    applyMarqueeIfNeeded(emailEl, document.getElementById('user-email-container'));
                }
                
                const picEls = [document.getElementById('user-profile-pic'), document.getElementById('user-profile-pic-menu')];
                const initialEls = [document.getElementById('user-profile-initial'), document.getElementById('user-profile-initial-menu')];

                if (user.photoURL) {
                    picEls.forEach(el => { el.src = user.photoURL; el.classList.remove('hidden'); });
                    initialEls.forEach(el => el.classList.add('hidden'));
                } else {
                    const initial = data.username.charAt(0).toUpperCase();
                    initialEls.forEach(el => { el.textContent = initial; el.classList.remove('hidden'); });
                    picEls.forEach(el => el.classList.add('hidden'));
                }
                
                document.getElementById('teacher-sidebar-actions').classList.toggle('hidden', data.role !== 'teacher');
            }

            function listenForClasses(uid, role) {
                unsubscribes.forEach(unsub => unsub());
                unsubscribes = [];
                allLoadedClasses = {};

                const reRender = () => {
                    const classesArray = Object.values(allLoadedClasses);
                    renderClassList(classesArray);
                    if (currentClassId && !allLoadedClasses[currentClassId]) {
                        selectClass(null);
                    } else if (currentClassId) {
                        currentClassData = allLoadedClasses[currentClassId];
                        renderMainContent(document.querySelector('#class-tabs .border-blue-500')?.dataset.tab || 'requests');
                    } else {
                        renderMainContent();
                    }
                };
                
                const teacherQuery = db.collection('classes').where('teacherId', '==', uid);
                unsubscribes.push(teacherQuery.onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'removed') delete allLoadedClasses[change.doc.id];
                        else allLoadedClasses[change.doc.id] = { id: change.doc.id, ...change.doc.data() };
                    });
                    reRender();
                }));

                const studentQuery = db.collection('classes').where('studentIds', 'array-contains', uid);
                unsubscribes.push(studentQuery.onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                       if (change.type === 'removed') delete allLoadedClasses[change.doc.id];
                       else allLoadedClasses[change.doc.id] = { id: change.doc.id, ...change.doc.data() };
                    });
                    reRender();
                }));
            }

            function renderClassList(classes) {
                const classListEl = document.getElementById('class-list');
                document.getElementById('no-classes-sidebar').classList.toggle('hidden', classes.length > 0);
                classListEl.innerHTML = '';
                classes.sort((a,b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0)).forEach(cls => {
                    const li = document.createElement('li');
                    const isActive = currentClassId === cls.id;
                    li.innerHTML = `<button data-class-id="${cls.id}" class="w-full text-left px-3 py-2 rounded-md font-medium text-sm transition-colors btn-bubbly ${isActive ? 'bg-blue-100 text-blue-800 font-semibold' : 'text-gray-600 hover:bg-gray-100 hover:text-gray-900'}">${cls.name}</button>`;
                    classListEl.appendChild(li);
                });
            }
            
            function selectClass(classData) {
                currentClassId = classData ? classData.id : null;
                currentClassData = classData;
                renderClassList(Object.values(allLoadedClasses)); 
                renderMainContent();
            }

            function renderMainContent(tab = 'requests') {
                if (currentClassData) {
                    mainContentArea.innerHTML = TPL.classView(currentClassData, userData, tab);
                } else {
                    mainContentArea.innerHTML = TPL.emptyState(userData);
                }
            }
            
            document.body.addEventListener('click', e => {
                if (e.target.closest('#user-profile-btn')) {
                    toggleComponent('user-profile-menu');
                    return;
                }
                if (!e.target.closest('#user-profile-menu')) {
                    hideComponent('user-profile-menu');
                }
                if(e.target.closest('#logout-btn')) auth.signOut();
                
                const classBtn = e.target.closest('#class-list button');
                if (classBtn) selectClass(allLoadedClasses[classBtn.dataset.classId]);
                
                if(e.target.closest('#new-class-btn')) showModal(TPL.newClassChoiceModal());
                if(e.target.closest('#join-class-btn')) showModal(TPL.joinClassModal());
                
                const modalTarget = e.target.closest('.modal-content-area');
                if (modalTarget) {
                    if (e.target.closest('#create-manual-btn')) showModal(TPL.createClassModal());
                    if (e.target.closest('#import-gclass-btn')) handleGoogleImportClick();
                }

                if(e.target.closest('.modal-cancel-btn') || e.target.id === 'modal-backdrop') hideModal();

                if(e.target.closest('#invite-link-btn')) copyInviteLink();
                const tabBtn = e.target.closest('#class-tabs button');
                if(tabBtn) renderMainContent(tabBtn.dataset.tab);
                
                if(e.target.closest('#add-preset-btn')) addPresetQuestion();
                const removePresetBtn = e.target.closest('.remove-preset-btn');
                if(removePresetBtn) removePresetQuestion(removePresetBtn.dataset.preset);
                if(e.target.closest('#save-schedule-btn')) saveClassSchedule();
                if(e.target.closest('#delete-class-btn')) showModal(TPL.deleteConfirmModal(currentClassData));
                if(e.target.closest('#confirm-delete-class-btn')) deleteClass();
                
                const dropdownBtn = e.target.closest('.custom-dropdown-btn');
                if (dropdownBtn) {
                    const options = dropdownBtn.nextElementSibling;
                    options.classList.toggle('hidden');
                } else if (!e.target.closest('.custom-dropdown-options')) {
                    document.querySelectorAll('.custom-dropdown-options').forEach(el => el.classList.add('hidden'));
                }

                const dropdownOption = e.target.closest('.custom-dropdown-option');
                if (dropdownOption) {
                    const dropdown = dropdownOption.closest('.relative');
                    const btnText = dropdown.querySelector('.custom-dropdown-btn span');
                    btnText.textContent = dropdownOption.dataset.value;
                    dropdown.querySelector('.custom-dropdown-options').classList.add('hidden');
                }
                
                // Cookie consent button handling is outside of app initialization
                // as it runs before Firebase is guaranteed to be ready.
            });
            
            document.body.addEventListener('submit', e => {
                if(e.target.id === 'create-class-form') {
                    e.preventDefault();
                    const className = e.target.querySelector('#new-class-name').value.trim();
                    if(className) createNewClass(className);
                }
            });

            function copyInviteLink() {
                const inviteURL = `${window.location.origin}/invite.html?classId=${currentClassId}`;
                document.execCommand('copy');
                const msg = document.getElementById('invite-copied-msg');
                if (msg) {
                    msg.classList.remove('hidden');
                    setTimeout(() => msg.classList.add('hidden'), 2000);
                }
            }
            
            async function addPresetQuestion() {
                const input = document.getElementById('new-preset-input');
                const presetText = input.value.trim();
                if (!presetText || !currentClassId) return;
                
                await db.collection('classes').doc(currentClassId).update({
                    presetQuestions: firebase.firestore.FieldValue.arrayUnion(presetText)
                });
                input.value = '';
            }

            async function removePresetQuestion(presetText) {
                await db.collection('classes').doc(currentClassId).update({
                    presetQuestions: firebase.firestore.FieldValue.arrayRemove(presetText)
                });
            }
            
            async function saveClassSchedule() {
                const startHour = document.getElementById('start-hour').value;
                const startMinute = document.getElementById('start-minute').value;
                const startPeriod = document.getElementById('start-period-text').textContent;
                const endHour = document.getElementById('end-hour').value;
                const endMinute = document.getElementById('end-minute').value;
                const endPeriod = document.getElementById('end-period-text').textContent;
                
                const schedule = {
                    start: `${startHour}:${startMinute} ${startPeriod}`,
                    end: `${endHour}:${endMinute} ${endPeriod}`
                };
                
                await db.collection('classes').doc(currentClassId).update({ schedule });
                alert('Schedule saved!');
            }
            
            async function deleteClass() {
                await db.collection('classes').doc(currentClassId).delete();
                hideModal();
            }

            async function createNewClass(className) {
                const classCode = Math.random().toString(36).substring(2, 10).toUpperCase();
                await db.collection('classes').add({
                    name: className,
                    teacherId: currentUser.uid,
                    code: classCode,
                    studentIds: [],
                    presetQuestions: [],
                    schedule: { start: "09:00 AM", end: "03:00 PM" },
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                hideModal();
            }
            
            let gapiLoaded = false;
            let auth2Initialized = false;
            const SCOPE = 'https://www.googleapis.com/auth/classroom.courses.readonly https://www.googleapis.com/auth/classroom.rosters.readonly';

            function loadGoogleAPIs() {
                return new Promise((resolve, reject) => {
                    if (gapiLoaded) {
                        resolve();
                        return;
                    }
                    gapi.load('client', {
                        callback: () => {
                            gapi.load('auth2', {
                                callback: () => {
                                    gapiLoaded = true;
                                    resolve();
                                },
                                onerror: reject
                            });
                        },
                        onerror: reject
                    });
                });
            }

            // --- REWRITTEN AND ROBUST GOOGLE IMPORT LOGIC ---
            async function handleGoogleImportClick() {
                // Ensure the modal is immediately visible and showing connecting state
                showModal(TPL.googleImportModal());
                
                const loadingEl = document.getElementById('g-import-loading');
                const errorEl = document.getElementById('g-import-error');
                
                if (loadingEl) loadingEl.classList.remove('hidden');
                if (errorEl) errorEl.classList.add('hidden');

                try {
                    // 1. Pre-Check Authentication and Role (CRITICAL)
                    if (!currentUser || !currentUser.uid) {
                         throw new Error('User is not authenticated. Please log in first.');
                    }
                    if (userData.role !== 'teacher') {
                         throw new Error('Access Denied: Only teachers can import classes.');
                    }

                    // 2. Fetch Secrets from Firebase
                    let API_KEY, CLIENT_ID;
                    try {
                        const secretsDoc = await db.collection('secrets').doc('wUTBTbjuNLueOfhgHXEE').get();
                        
                        // Check 2a: Document Existence (this is the key check)
                        if (!secretsDoc.exists) {
                            console.error("Firebase Document Path Error: secrets/wUTBTbjuNLueOfhgHXEE");
                            throw new Error("MISSING FIREBASE SECRET: The required configuration document was not found at 'secrets/wUTBTbjuNLueOFhgHXEE'.");
                        }
                        
                        const secrets = secretsDoc.data();
                        API_KEY = secrets.GoogleClassroomAPIKey;
                        CLIENT_ID = secrets.GoogleClientID;

                        // Check 2b: Field Existence
                        if (!API_KEY || !CLIENT_ID) {
                            throw new Error("INCOMPLETE FIREBASE SECRET: API Key or Client ID fields are empty in the Firebase document.");
                        }
                    } catch (secretsError) {
                        console.error('Error fetching Firebase secrets:', secretsError);
                        // Permission denied usually means the rule is failing (even with correct data)
                        if (secretsError.code === 'permission-denied') {
                            throw new Error("SECURITY RULE FAILURE: Permission denied when accessing Firebase secrets. Please verify the 'teacher' role condition in your Firestore rules.");
                        }
                        // Re-throw other errors
                        throw secretsError;
                    }

                    // 3. Initialize Google APIs and Auth
                    await loadGoogleAPIs();
                    
                    if (!auth2Initialized) {
                        await gapi.client.init({
                            apiKey: API_KEY,
                            clientId: CLIENT_ID,
                            scope: SCOPE,
                            discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/classroom/v1/rest"]
                        });
                        auth2Initialized = true;
                    }
                    
                    // 4. Force Google Sign-In and Authorization
                    const auth2 = gapi.auth2.getAuthInstance();
                    
                    if (!auth2.isSignedIn.get()) {
                        try {
                            await auth2.signIn();
                        } catch (signInError) {
                            const errorDetails = signInError.details || signInError.message || 'Unknown sign-in failure.';
                            if (errorDetails.includes('Not a valid origin for the client')) {
                                throw new Error(`OAuth Misconfiguration: The application URL (${window.location.origin}) is not registered as an Authorized JavaScript Origin in your Google Cloud Console.`);
                            }
                            throw new Error('Google Sign-in failed: ' + errorDetails);
                        }
                    }
                    
                    // 5. Proceed to list courses
                    await listGoogleCourses();
                    
                } catch (error) {
                    console.error('Final Google import process failure:', error);
                    if (loadingEl) loadingEl.classList.add('hidden');
                    
                    const errorMessage = error.message || (error.result && error.result.error && error.result.error.message) || "Unknown error occurred while connecting to Google Classroom.";
                    
                    // Display detailed error in the modal
                    if (errorEl) {
                        errorEl.innerHTML = `<div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-red-800">Connection Failed</h3>
                                    <div class="mt-2 text-sm text-red-700">
                                        <p><strong>Error:</strong> ${errorMessage}</p>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                        errorEl.classList.remove('hidden');
                    }
                } finally {
                    const newClassBtn = document.getElementById('new-class-btn');
                    if (newClassBtn) {
                        newClassBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg><span>New Class</span>';
                        newClassBtn.disabled = false;
                    }
                }
            }
            
            async function listGoogleCourses() {
                const listEl = document.getElementById('g-import-list');
                const loadingEl = document.getElementById('g-import-loading');
                const errorEl = document.getElementById('g-import-error');

                try {
                    if (loadingEl) loadingEl.innerHTML = '<div class="text-center py-8"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div><p class="text-gray-600 mt-2">Fetching your courses...</p></div>';
                    
                    const response = await gapi.client.classroom.courses.list({ 
                        teacherId: 'me', 
                        courseStates: 'ACTIVE',
                        pageSize: 50
                    });
                    
                    if (loadingEl) loadingEl.classList.add('hidden');
                    const courses = response.result.courses || [];

                    if (courses.length > 0) {
                        const existingImports = new Set();
                        const existingClassesSnapshot = await db.collection('classes')
                            .where('teacherId', '==', currentUser.uid)
                            .get();
                        
                        existingClassesSnapshot.forEach(doc => {
                            const data = doc.data();
                            if (data.googleCourseId) {
                                existingImports.add(data.googleCourseId);
                            }
                        });

                        if (listEl) {
                            listEl.innerHTML = courses.map(course => {
                                const isImported = existingImports.has(course.id);
                                return `
                                    <li class="flex justify-between items-center p-3 bg-gray-50 rounded-md">
                                        <div class="flex-grow">
                                            <span class="font-medium text-gray-800">${course.name}</span>
                                            <p class="text-xs text-gray-500 mt-1">${course.descriptionHeading || 'No description'}</p>
                                            ${isImported ? '<p class="text-xs text-green-600 font-medium mt-1">✓ Already imported</p>' : ''}
                                        </div>
                                        <button 
                                            data-course-id="${course.id}" 
                                            data-course-name="${course.name}"
                                            class="import-g-class-btn ml-3 px-3 py-1 rounded-md text-sm transition-colors btn-bubbly ${isImported ? 'bg-gray-400 text-white cursor-not-allowed' : 'bg-blue-500 text-white hover:bg-blue-600'}"
                                            ${isImported ? 'disabled' : ''}
                                        >
                                            ${isImported ? 'Imported' : 'Import'}
                                        </button>
                                    </li>
                                `;
                            }).join('');
                            
                            document.querySelectorAll('.import-g-class-btn:not([disabled])').forEach(button => {
                                button.addEventListener('click', () => importGoogleClass(button.dataset.courseId, button.dataset.courseName));
                            });
                        }
                    } else {
                        if (listEl) listEl.innerHTML = '<p class="text-center text-gray-500 py-4">No active courses found in your Google Classroom.</p>';
                    }
                } catch (err) {
                    console.error('Error fetching Google Classroom courses:', err);
                    if (loadingEl) loadingEl.classList.add('hidden');
                    const errorMessage = err.result?.error?.message || err.message || 'Failed to fetch courses from Google Classroom.';
                    if (errorEl) {
                        errorEl.innerHTML = `<div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-red-800">Error Loading Courses</h3>
                                    <div class="mt-2 text-sm text-red-700">
                                        <p><strong>Error:</strong> ${errorMessage}</p>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                        errorEl.classList.remove('hidden');
                    }
                }
            }

            async function importGoogleClass(googleCourseId, googleCourseName) {
                const importBtn = document.querySelector(`.import-g-class-btn[data-course-id="${googleCourseId}"]`);
                if (!importBtn) return;
                
                const originalText = importBtn.textContent;
                
                try {
                    importBtn.textContent = 'Importing...';
                    importBtn.disabled = true;
                    importBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                    importBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');

                    const existingClass = await db.collection('classes')
                        .where('googleCourseId', '==', googleCourseId)
                        .where('teacherId', '==', currentUser.uid)
                        .limit(1)
                        .get();
                        
                    if (!existingClass.empty) {
                        throw new Error('This class has already been imported.');
                    }
                    
                    let students = [];
                    try {
                        importBtn.textContent = 'Fetching students...';
                        const studentsResponse = await gapi.client.classroom.courses.students.list({
                            courseId: googleCourseId,
                            pageSize: 100
                        });
                        
                        if (studentsResponse.result.students) {
                            students = studentsResponse.result.students.map(student => ({
                                email: student.profile.emailAddress,
                                name: student.profile.name.fullName,
                                googleId: student.userId
                            }));
                        }
                    } catch (studentError) {
                        console.warn('Could not fetch students:', studentError);
                    }
                    
                    importBtn.textContent = 'Creating class...';
                    
                    const classCode = Math.random().toString(36).substring(2, 10).toUpperCase();
                    const classRef = await db.collection('classes').add({
                        name: googleCourseName,
                        teacherId: currentUser.uid,
                        code: classCode,
                        googleCourseId: googleCourseId,
                        studentIds: [],
                        presetQuestions: [],
                        schedule: { start: "09:00 AM", end: "03:00 PM" },
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        importedFromGoogle: true,
                        importedStudentCount: students.length
                    });
                    
                    if (students.length > 0) {
                        importBtn.textContent = `Creating invitations (${students.length})...`;
                        
                        const batch = db.batch();
                        students.forEach(student => {
                            const inviteRef = db.collection('invitations').doc();
                            batch.set(inviteRef, {
                                classId: classRef.id,
                                studentEmail: student.email,
                                studentName: student.name,
                                googleStudentId: student.googleId,
                                status: 'pending',
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                createdBy: currentUser.uid
                            });
                        });
                        
                        await batch.commit();
                    }
                    
                    importBtn.textContent = 'Imported!';
                    importBtn.classList.add('bg-green-600');
                    importBtn.classList.remove('bg-gray-400');
                    
                    setTimeout(() => {
                        hideModal();
                    }, 1500);
                    
                    const studentText = students.length === 0 ? 'No students found' : 
                                     students.length === 1 ? '1 student invitation created' : 
                                     `${students.length} student invitations created`;
                    
                    alert(`Successfully imported "${googleCourseName}"!\n${studentText}`);
                    
                } catch (error) {
                    console.error("Error importing Google Classroom:", error);
                    importBtn.textContent = originalText;
                    importBtn.disabled = false;
                    importBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    importBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
                    
                    const errorMessage = error.message || 'Failed to import class';
                    alert(`Import failed: ${errorMessage}`);
                }
            }
            
            function showComponent(elementId) {
                const el = document.getElementById(elementId);
                if (!el || !el.classList.contains('hidden')) return;
                el.classList.remove('hidden');
                el.classList.add('fade-enter-active');
                setTimeout(() => el.classList.remove('fade-enter-active'), 200);
            }
            
            function hideComponent(elementId) {
                const el = document.getElementById(elementId);
                if (!el || el.classList.contains('hidden')) return;
                el.classList.add('fade-leave-active');
                setTimeout(() => {
                    el.classList.add('hidden');
                    el.classList.remove('fade-leave-active');
                }, 200);
            }

            function toggleComponent(elementId) {
                const el = document.getElementById(elementId);
                if (el.classList.contains('hidden')) showComponent(elementId);
                else hideComponent(elementId);
            }
            
            const modalContainer = document.getElementById('modal-container');
            const modalBackdrop = document.getElementById('modal-backdrop');
            function showModal(modalHTML) {
                modalContainer.innerHTML = modalHTML;
                modalBackdrop.classList.remove('hidden', 'fade-leave-to');
                modalBackdrop.classList.add('fade-enter-active');
                const modalDialog = modalContainer.firstElementChild;
                if (modalDialog) {
                    modalDialog.classList.add('fade-enter-active');
                    setTimeout(() => {
                        modalBackdrop.classList.remove('fade-enter-active');
                        modalDialog.classList.remove('fade-enter-active');
                    }, 200);
                }
            }
            
            function hideModal() {
                const modalDialog = modalContainer.firstElementChild;
                if(modalDialog) {
                    modalBackdrop.classList.add('fade-leave-active');
                    modalDialog.classList.add('fade-leave-active');
                    setTimeout(() => {
                        modalContainer.innerHTML = '';
                        modalBackdrop.classList.add('hidden');
                        modalBackdrop.classList.remove('fade-leave-active');
                    }, 200);
                }
            }

            // --- COOKIE CONSENT FUNCTIONS ---
            function createParticle(x, y) {
                const particle = document.createElement('div');
                particle.classList.add('particle');
                particle.style.left = `${x}px`;
                particle.style.top = `${y}px`;
                
                // Randomize trajectory within a 100px radius
                const angle = Math.random() * 2 * Math.PI;
                const distance = Math.random() * 100 + 50;
                particle.style.setProperty('--x', `${Math.cos(angle) * distance}px`);
                particle.style.setProperty('--y', `${Math.sin(angle) * distance}px`);
                
                document.body.appendChild(particle);
                setTimeout(() => particle.remove(), 800);
            }

            function acceptCookies() {
                localStorage.setItem('cookie_consent', 'accepted');
                const overlayEl = document.getElementById('cookie-consent-overlay');
                const iconEl = overlayEl.querySelector('#cookie-icon-bitten');
                
                if (iconEl) {
                    iconEl.classList.add('cookie-accepted');
                    // Create particle burst from the center of the icon
                    const rect = iconEl.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;

                    for (let i = 0; i < 20; i++) {
                        createParticle(centerX, centerY);
                    }
                }
                
                // Fade out the overlay and initialize the app
                overlayEl.style.opacity = '0';
                setTimeout(() => {
                    overlayEl.classList.add('hidden');
                    initializeApp();
                }, 500);
            }

            function denyCookies() {
                localStorage.setItem('cookie_consent', 'denied');
                const overlayEl = document.getElementById('cookie-consent-overlay');
                const iconBitten = overlayEl.querySelector('#cookie-icon-bitten');
                const iconWhole = overlayEl.querySelector('#cookie-icon-whole');
                const denyText = overlayEl.querySelector('#cookie-deny-text');
                const denyWarning = overlayEl.querySelector('#cookie-deny-warning');
                
                // Show denial warning
                if (denyWarning) denyWarning.classList.remove('hidden');
                
                // Hide bitten cookie and show whole cookie with a spring animation
                if (iconBitten) iconBitten.classList.add('hidden');
                if (iconWhole) {
                    iconWhole.classList.remove('hidden');
                    iconWhole.classList.add('cookie-denied');
                }
                
                // Hide main modal content and fade away the denial menu
                const modalContent = overlayEl.querySelector('.p-8');
                if (modalContent) modalContent.style.opacity = '0';

                // Prevent app initialization
                setTimeout(() => {
                    overlayEl.classList.add('hidden');
                    // Show a persistent, simple denial banner or keep app hidden until accepted
                    // For this exercise, we simply hide the overlay and rely on the local storage check
                }, 1500);
            }

            function checkCookieConsent() {
                const consent = localStorage.getItem('cookie_consent');
                const overlay = document.getElementById('cookie-consent-overlay');

                if (consent === 'accepted') {
                    // Start the app immediately
                    overlay.classList.add('hidden');
                    initializeApp();
                } else {
                    // Show consent screen (either denied or no choice)
                    overlay.innerHTML = TPL.cookieConsentModal();
                    // Keep app hidden until accepted
                }
            }
            // --- END COOKIE CONSENT FUNCTIONS ---

            const TPL = {
                cookieConsentModal: () => `
                    <div class="p-8 max-w-lg mx-auto bg-white rounded-xl shadow-2xl border border-gray-200 text-center">
                        <div id="cookie-icon-container" class="relative inline-block mb-4">
                            <!-- Bitten Cookie (Visible by default) -->
                            <i id="cookie-icon-bitten" class="fa-solid fa-cookie-bite fa-4x cookie-icon"></i>
                            <!-- Whole Cookie (Initially Hidden) -->
                            <i id="cookie-icon-whole" class="fa-solid fa-cookie fa-4x cookie-icon absolute top-0 left-0 hidden"></i>
                        </div>

                        <h2 class="text-3xl font-bold font-poppins text-gray-800 mb-2">Privacy Consent Required</h2>
                        <p class="text-gray-700 mb-6 leading-relaxed">
                            To function correctly and allow you to sign in securely and integrate with services like Google Classroom, this application needs your permission to store data (a "cookie") on your device.
                        </p>
                        <p id="cookie-deny-warning" class="text-sm font-medium text-red-600 mb-4 hidden">
                            **Warning:** Denying consent means the app cannot maintain your login session or save personalization like theme preferences, severely limiting functionality.
                        </p>
                        
                        <div class="flex justify-center space-x-4">
                            <button id="cookie-deny-btn" class="px-5 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition-colors btn-bubbly">
                                Deny Consent
                            </button>
                            <button id="cookie-accept-btn" class="px-5 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors btn-bubbly">
                                Accept & Continue
                            </button>
                        </div>
                    </div>
                `,
                emptyState: (user) => `
                    <div class="h-full flex items-center justify-center text-center fade-enter-active">
                        <div>
                            <svg class="w-16 h-16 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
                            <h2 class="mt-4 text-xl font-semibold text-gray-700">Welcome, ${user?.username || ''}!</h2>
                            <p class="mt-1 text-gray-500">Select a class from the sidebar or create a new one to get started.</p>
                        </div>
                    </div>
                `,
                classView: (cls, user, tab) => `
                    <div class="fade-enter-active">
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-6">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h2 id="class-name-header" class="text-2xl font-bold text-gray-800 font-poppins">${cls.name}</h2>
                                    <div class="flex items-center space-x-2 mt-1">
                                        <p class="text-sm text-gray-500">Code: ${cls.code}</p>
                                        ${cls.importedFromGoogle ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">Google Classroom</span>' : ''}
                                        ${user.role === 'teacher' ? `<button id="invite-link-btn" title="Copy Invite Link" class="text-gray-400 hover:text-blue-600 btn-bubbly"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg></button>` : ''}
                                        <span id="invite-copied-msg" class="text-xs text-green-600 font-medium hidden">Copied!</span>
                                    </div>
                                </div>
                                <div id="class-tabs" class="border-b border-gray-200">
                                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                                        <button data-tab="requests" class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm ${tab === 'requests' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}">Requests</button>
                                        ${user.role === 'teacher' ? `<button data-tab="settings" class="whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm ${tab === 'settings' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}">Settings</button>` : ''}
                                    </nav>
                                </div>
                            </div>
                        </div>
                        ${tab === 'requests' ? TPL.requestsView(cls) : TPL.settingsView(cls)}
                    </div>
                `,
                requestsView: (cls) => `<div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200"><h3 class="text-lg font-semibold text-gray-800">Student Requests</h3><p class="text-gray-500 mt-2">Coming Soon: A real-time list of student help requests will appear here.</p></div>`,
                settingsView: (cls) => `
                    <div class="max-w-4xl mx-auto space-y-8">
                        ${TPL.settingsGeneral(cls)}
                        ${TPL.settingsSchedule(cls)}
                        ${TPL.settingsPresets(cls)}
                        ${TPL.settingsDanger(cls)}
                    </div>`,
                settingsGeneral: (cls) => `<div class="bg-white p-6 rounded-lg shadow-sm border"><h3 class="text-lg font-semibold text-gray-800 border-b pb-3 mb-4 font-poppins">General</h3><div class="space-y-4"><div><label for="class-name-input" class="block text-sm font-medium text-gray-700">Class Name</label><input type="text" id="class-name-input" value="${cls.name}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></div><button class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 btn-bubbly">Save Changes</button></div></div>`,
                settingsSchedule: (cls) => {
                    const { start = '09:00 AM', end = '03:00 PM' } = cls.schedule || {};
                    const [startTime, startPeriod] = start.split(' ');
                    const [startHour, startMinute] = startTime.split(':');
                    const [endTime, endPeriod] = end.split(' ');
                    const [endHour, endMinute] = endTime.split(':');

                    const timeInputClasses = 'w-20 text-center font-medium font-poppins text-gray-800 bg-gray-50 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500';
                    const dropdownBtnClasses = 'relative w-24 cursor-pointer rounded-md border border-gray-300 bg-white py-2 pl-3 pr-10 text-left shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500';
                    const dropdownOptionsClasses = 'absolute z-10 mt-1 max-h-60 w-full overflow-auto rounded-md bg-white py-1 text-base shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none hidden';
                    const dropdownOptionClasses = 'cursor-pointer select-none relative py-2 pl-3 pr-9 text-gray-900 hover:bg-blue-50';

                    return `<div class="bg-white p-6 rounded-lg shadow-sm border"><h3 class="text-lg font-semibold text-gray-800 border-b pb-3 mb-4 font-poppins">Class Schedule</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="font-poppins"><label class="block text-sm font-medium text-gray-700">Starts at</label><div class="mt-1 flex items-center gap-2"><input type="text" id="start-hour" value="${startHour}" maxlength="2" class="${timeInputClasses}"><span class="text-gray-400 font-bold">:</span><input type="text" id="start-minute" value="${startMinute}" maxlength="2" class="${timeInputClasses}"><div class="relative"><button type="button" class="custom-dropdown-btn ${dropdownBtnClasses}"><span id="start-period-text">${startPeriod}</span><span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-2"><svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg></span></button><ul class="custom-dropdown-options ${dropdownOptionsClasses}"><li data-value="AM" class="${dropdownOptionClasses}">AM</li><li data-value="PM" class="${dropdownOptionClasses}">PM</li></ul></div></div></div><div class="font-poppins"><label class="block text-sm font-medium text-gray-700">Ends at</label><div class="mt-1 flex items-center gap-2"><input type="text" id="end-hour" value="${endHour}" maxlength="2" class="${timeInputClasses}"><span class="text-gray-400 font-bold">:</span><input type="text" id="end-minute" value="${endMinute}" maxlength="2" class="${timeInputClasses}"><div class="relative"><button type="button" class="custom-dropdown-btn ${dropdownBtnClasses}"><span id="end-period-text">${endPeriod}</span><span class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-2"><svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg></span></button><ul class="custom-dropdown-options ${dropdownOptionsClasses}"><li data-value="AM" class="${dropdownOptionClasses}">AM</li><li data-value="PM" class="${dropdownOptionClasses}">PM</li></ul></div></div></div></div><p class="mt-3 text-xs text-gray-500">Note: Uses local device time, assumed for weekdays.</p><button id="save-schedule-btn" class="mt-4 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 btn-bubbly">Save Schedule</button></div>`;
                },
                settingsPresets: (cls) => {
                    const presets = cls.presetQuestions || [];
                    return `<div class="bg-white p-6 rounded-lg shadow-sm border"><h3 class="text-lg font-semibold text-gray-800 border-b pb-3 mb-4 font-poppins">Preset Questions</h3><div id="preset-questions-list" class="space-y-3 mb-4">${presets.map(p => `<div class="flex items-center justify-between bg-gray-50 p-2 rounded-md"><span class="text-sm text-gray-800">${p}</span><button data-preset="${p}" class="remove-preset-btn text-gray-400 hover:text-red-600 btn-bubbly"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button></div>`).join('') || '<p class="text-sm text-gray-500">No preset questions added yet.</p>'}</div><div class="flex space-x-2"><input type="text" id="new-preset-input" placeholder="e.g., I need help with Question 5" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"><button id="add-preset-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 whitespace-nowrap btn-bubbly">Add</button></div></div>`;
                },
                settingsDanger: (cls) => `<div class="bg-red-50 p-6 rounded-lg border border-red-200"><h3 class="text-lg font-semibold text-red-800 border-b border-red-200 pb-3 mb-4 font-poppins">Danger Zone</h3><div><p class="text-sm text-red-700">Deleting this class is permanent. All associated data will be lost, and students will be removed.</p><button id="delete-class-btn" class="mt-4 bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 btn-bubbly">Delete This Class</button></div></div>`,
                newClassChoiceModal: () => `<div class="relative bg-white w-full max-w-md p-6 rounded-lg shadow-xl pointer-events-auto modal-content-area"><h3 class="text-xl font-semibold text-gray-800 font-poppins text-center">Add a New Class</h3><p class="text-center text-gray-500 mt-2">How would you like to create your class?</p><div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4"><button id="create-manual-btn" class="w-full flex flex-col items-center justify-center p-6 bg-gray-50 rounded-lg hover:bg-blue-50 hover:border-blue-300 border-2 border-dashed transition-colors btn-bubbly"><svg class="w-8 h-8 text-blue-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg><span class="font-semibold text-gray-700">Create Manually</span></button><button id="import-gclass-btn" class="w-full flex flex-col items-center justify-center p-6 bg-gray-50 rounded-lg hover:bg-green-50 hover:border-green-300 border-2 border-dashed transition-colors btn-bubbly"><img src="../images/google-classroom.png" class="w-8 h-8 mb-2" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"><svg class="w-8 h-8 text-green-600 mb-2 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span class="font-semibold text-gray-700">Import from Classroom</span></button></div><div class="mt-6 text-center"><button class="modal-cancel-btn text-sm text-gray-600 hover:text-gray-800">Cancel</button></div></div>`,
                createClassModal: () => `<div class="relative bg-white w-full max-w-md p-6 rounded-lg shadow-xl pointer-events-auto"><h3 class="text-xl font-semibold text-gray-800 font-poppins">Create New Class</h3><form id="create-class-form" class="mt-4 space-y-4"><div><label for="new-class-name" class="block text-sm font-medium text-gray-700">Class Name</label><input type="text" id="new-class-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></div><div class="flex justify-end space-x-3"><button type="button" class="modal-cancel-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 btn-bubbly">Cancel</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 btn-bubbly">Create</button></div></form></div>`,
                googleImportModal: () => `<div class="relative bg-white w-full max-w-2xl p-6 rounded-lg shadow-xl pointer-events-auto modal-content-area"><h3 class="text-xl font-semibold text-gray-800 font-poppins flex items-center"><svg class="w-6 h-6 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Import from Google Classroom</h3><div id="g-import-content" class="mt-4"><div id="g-import-loading" class="text-center py-8"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div><p class="text-gray-600 mt-2">Connecting to Google Classroom...</p></div><p id="g-import-error" class="text-center text-red-600 bg-red-50 p-4 rounded-lg hidden"></p><div id="g-import-list" class="mt-4 max-h-80 overflow-y-auto space-y-3 custom-scrollbar"></div></div><div class="flex justify-between items-center mt-6"><p class="text-xs text-gray-500">Students from imported classes will receive email invitations</p><button type="button" class="modal-cancel-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 btn-bubbly">Close</button></div></div>`,
                deleteConfirmModal: (cls) => `<div class="relative bg-white w-full max-w-md p-6 rounded-lg shadow-xl pointer-events-auto"><h3 class="text-xl font-semibold text-red-800 font-poppins">Delete Class</h3><p class="mt-2 text-gray-600">Are you sure you want to permanently delete "${cls.name}"? This action cannot be undone.</p><div class="mt-6 flex justify-end space-x-3"><button class="modal-cancel-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 btn-bubbly">Cancel</button><button id="confirm-delete-class-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 btn-bubbly">Yes, Delete</button></div></div>`
            };

        });

        // Run cookie check immediately when the document finishes loading.
        document.addEventListener('DOMContentLoaded', () => {
            const checkInterval = setInterval(() => {
                // Wait for Firebase configuration to be defined before calling checkCookieConsent
                if (typeof firebase !== 'undefined' && typeof firebase.initializeApp === 'function') {
                    clearInterval(checkInterval);
                    checkCookieConsent();
                }
            }, 100);
        });
    </script>
</body>
</html>
