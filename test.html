<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notify | Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        .card { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        /* Custom modal styles */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
    </style>
    <!-- 1. Google Platform API Load -->
    <script src="https://apis.google.com/js/api.js"></script>
</head>
<body class="p-6">

    <div id="auth-check" class="text-center p-8">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-500 mx-auto"></div>
        <p class="mt-3 text-gray-600">Loading application...</p>
    </div>

    <div id="main-content" class="hidden">
        <header class="flex justify-between items-center pb-6 border-b border-gray-200 mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Class Dashboard: <span id="class-title">Loading...</span></h1>
            <p id="user-info" class="text-sm text-gray-500">User ID: <span id="user-id"></span></p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Class Management Panel (Invite Links, Pause, Lower Hands, Schedule) -->
            <section class="lg:col-span-2 space-y-6">
                <div class="card bg-white p-6 rounded-xl space-y-4">
                    <h2 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-4">Class Controls & Invitations</h2>

                    <!-- Hand Raising State -->
                    <div class="flex items-center justify-between p-3 bg-indigo-50 rounded-lg">
                        <span class="font-medium text-indigo-800">Hand Raising:</span>
                        <div class="flex items-center space-x-2">
                            <span id="pause-status" class="font-bold text-green-600">Active</span>
                            <button id="pause-btn" class="bg-yellow-500 text-white py-1 px-3 rounded-lg font-semibold hover:bg-yellow-600 transition duration-150">Pause Hand Raising</button>
                        </div>
                    </div>
                    
                    <!-- Class End Cleanup -->
                    <div class="space-y-2 pt-2 border-t border-gray-100">
                        <div class="flex items-center justify-between">
                            <label for="class-end-time" class="text-sm font-medium text-gray-700">Class End Time (24h):</label>
                            <input type="text" id="class-end-time" class="time-input w-24 p-2 border border-gray-300 rounded-lg text-sm" placeholder="HH:MM" data-digits="">
                            <button id="set-schedule-btn" class="bg-green-500 text-white py-1 px-3 rounded-lg text-sm font-semibold hover:bg-green-600 transition duration-150">Set Schedule</button>
                            <button id="clear-schedule-btn" class="bg-gray-300 text-gray-800 py-1 px-3 rounded-lg text-sm font-semibold hover:bg-gray-400 transition duration-150">Clear</button>
                        </div>
                        <p class="text-xs text-gray-500" id="scheduled-status">No end time scheduled.</p>
                        <button id="lower-all-hands-btn" class="w-full mt-3 bg-red-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-red-600 transition duration-150">End Class: Lower All Hands</button>
                        <button id="gc-import-btn" class="w-full mt-3 bg-indigo-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-indigo-600 transition duration-150">Import Google Classroom Roster (Emails & Title)</button>
                        <p id="gc-status" class="text-xs text-center pt-1 text-gray-500">Ready to import.</p>
                    </div>

                    <!-- Invite Links -->
                    <div class="space-y-3 pt-4 border-t border-gray-100">
                        <h3 class="text-lg font-medium text-gray-700">Class Invite Links</h3>
                        
                        <!-- Student Invite Link -->
                        <div class="flex items-center space-x-2">
                            <input type="text" id="student-invite-link" readonly class="flex-grow p-2 border border-gray-300 rounded-lg text-sm bg-gray-50 cursor-pointer" value="Loading Student Link...">
                            <button onclick="copyToClipboard('student-invite-link')" class="bg-blue-500 text-white py-2 px-3 rounded-lg text-sm hover:bg-blue-600 transition duration-150">Copy</button>
                        </div>
                        <p class="text-xs text-gray-500">Share this link for students to join automatically.</p>

                        <!-- Co-Teacher Invite Link -->
                        <div class="flex items-center space-x-2 pt-2">
                            <input type="text" id="coteacher-invite-link" readonly class="flex-grow p-2 border border-gray-300 rounded-lg text-sm bg-gray-50 cursor-pointer" value="Loading Co-Teacher Link...">
                            <button onclick="copyToClipboard('coteacher-invite-link')" class="bg-blue-500 text-white py-2 px-3 rounded-lg text-sm hover:bg-blue-600 transition duration-150">Copy</button>
                        </div>
                        <p class="text-xs text-gray-500">Share this link for users to request Co-Teacher status.</p>
                    </div>

                </div>
            </section>
            
            <!-- Roster & Requests Panel -->
            <section class="lg:col-span-1 space-y-6">

                <!-- Co-Teacher Requests -->
                <div class="card bg-white p-6 rounded-xl">
                    <h2 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-4">Co-Teacher Requests (<span id="coteacher-request-count">0</span>)</h2>
                    <div id="coteacher-requests-list" class="space-y-3">
                        <p class="text-gray-500 text-sm">No pending requests.</p>
                    </div>
                </div>

                <!-- Roster Section -->
                <div class="card bg-white p-6 rounded-xl">
                    <h2 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-4">Class Roster</h2>
                    
                    <h3 class="font-bold text-gray-700 mb-1">Co-Teachers (<span id="coteacher-count">0</span>)</h3>
                    <div id="coteachers-list" class="space-y-1 pb-3 border-b border-gray-100">
                        <p class="text-gray-500 text-sm">No co-teachers assigned.</p>
                    </div>

                    <h3 class="font-bold text-gray-700 mt-3 mb-1">Students (<span id="student-count">0</span>)</h3>
                    <div id="students-list" class="space-y-1">
                        <p class="text-gray-500 text-sm">No students in roster.</p>
                    </div>
                </div>
            </section>
        </main>

        <!-- Raised Hand Requests -->
        <section class="mt-8">
            <div class="card bg-white p-6 rounded-xl">
                <h2 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-4">Raised Hand Requests (<span id="raised-hands-count">0</span>)</h2>
                <div id="raised-hands-container" class="space-y-4">
                    <p class="text-gray-500" id="no-hands-message">No hands currently raised.</p>
                    <!-- Student Hand Request Cards will go here -->
                </div>
            </div>
        </section>

    </div>

    <!-- Hand Request Modal (Accept/Deny) -->
    <div id="hand-request-modal" class="modal-overlay fixed inset-0 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-xl w-full max-w-sm card relative">
            <h3 class="text-lg font-bold mb-4">Hand Request</h3>
            <p class="text-gray-700 mb-4"><span id="hand-requester-name" class="font-semibold"></span> raised their hand.</p>
            <textarea id="hand-requester-comment" class="w-full p-2 border rounded-lg resize-none mb-4" rows="3" readonly placeholder="No comment provided."></textarea>
            
            <div class="flex justify-end space-x-3">
                <button id="deny-hand-btn" class="bg-red-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-red-600 transition duration-150">Deny</button>
                <button id="accept-hand-btn" class="bg-green-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-green-600 transition duration-150">Accept & Lower</button>
            </div>
            <button onclick="closeModal('hand-request-modal')" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>
    
    <!-- Google Classroom Selection Modal -->
    <div id="gc-select-modal" class="modal-overlay fixed inset-0 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-xl w-full max-w-md card relative">
            <h3 class="text-lg font-bold mb-4 border-b pb-2">Select Google Classroom</h3>
            <p class="text-sm text-gray-600 mb-4">Choose a class below to import its name and student roster into Notify.</p>
            
            <div id="gc-class-list" class="space-y-3 max-h-80 overflow-y-auto pr-2">
                <div class="text-center p-4">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500 mx-auto"></div>
                    <p class="mt-2 text-gray-500 text-sm">Loading your courses...</p>
                </div>
            </div>
            
            <div class="flex justify-end mt-4">
                <button onclick="closeModal('gc-select-modal')" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-lg font-semibold hover:bg-gray-400 transition duration-150">Cancel</button>
            </div>
            <button onclick="closeModal('gc-select-modal')" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, arrayRemove, arrayUnion, writeBatch, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('Debug');

        // --- Global Variables & Initialization ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, db, auth;
        // In a real multi-class app, the teacher would select this. For now, hardcode one class.
        const currentClassId = 'class_001'; 
        let currentUserId = null;
        let isTeacher = false;
        let activeHandRequestId = null; // Store the ID of the hand being processed in the modal
        
        // --- Google Classroom Configuration (REPLACE THIS DUMMY CLIENT ID) ---
        const GOOGLE_CLIENT_ID = 'YOUR_GOOGLE_CLIENT_ID'; // <<< REPLACE ME WITH YOUR REAL CLIENT ID
        const GC_SCOPES = [
            'https://www.googleapis.com/auth/classroom.courses.readonly',
            'https://www.googleapis.com/auth/classroom.roster.readonly',
            'profile',
            'email'
        ];

        // Status for Google API loading
        let gapiReady = false;

        // --- UI Elements ---
        const ui = {
            mainContent: document.getElementById('main-content'),
            authCheck: document.getElementById('auth-check'),
            classTitle: document.getElementById('class-title'),
            userIdDisplay: document.getElementById('user-id'),
            
            // Controls
            pauseStatus: document.getElementById('pause-status'),
            pauseBtn: document.getElementById('pause-btn'),
            lowerAllHandsBtn: document.getElementById('lower-all-hands-btn'),
            gcImportBtn: document.getElementById('gc-import-btn'),
            gcStatus: document.getElementById('gc-status'),
            
            // Scheduling
            classEndTimeInput: document.getElementById('class-end-time'),
            setScheduleBtn: document.getElementById('set-schedule-btn'),
            clearScheduleBtn: document.getElementById('clear-schedule-btn'),
            scheduledStatus: document.getElementById('scheduled-status'),

            // Invites
            studentInviteLink: document.getElementById('student-invite-link'),
            coteacherInviteLink: document.getElementById('coteacher-invite-link'),

            // Roster
            coteacherRequestCount: document.getElementById('coteacher-request-count'),
            coteacherRequestsList: document.getElementById('coteacher-requests-list'),
            coteacherCount: document.getElementById('coteacher-count'),
            coteachersList: document.getElementById('coteachers-list'),
            studentCount: document.getElementById('student-count'),
            studentsList: document.getElementById('students-list'),
            
            // Hands
            raisedHandsCount: document.getElementById('raised-hands-count'),
            raisedHandsContainer: document.getElementById('raised-hands-container'),
            noHandsMessage: document.getElementById('no-hands-message'),

            // Modals
            handRequestModal: document.getElementById('hand-request-modal'),
            handRequesterName: document.getElementById('hand-requester-name'),
            handRequesterComment: document.getElementById('hand-requester-comment'),
            acceptHandBtn: document.getElementById('accept-hand-btn'),
            denyHandBtn: document.getElementById('deny-hand-btn'),
            gcSelectModal: document.getElementById('gc-select-modal'),
            gcClassList: document.getElementById('gc-class-list'),
        };


        // --- Utility Functions ---

        window.copyToClipboard = (elementId) => {
            const input = document.getElementById(elementId);
            input.select();
            document.execCommand('copy');
            const originalValue = input.value;
            input.value = 'Copied!';
            setTimeout(() => input.value = originalValue, 1000);
        }

        window.openModal = (modalId) => document.getElementById(modalId).classList.remove('hidden');
        window.closeModal = (modalId) => document.getElementById(modalId).classList.add('hidden');
        
        // Time input formatting (24-hour time validation)
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.time-input').forEach(input => {
                input.dataset.digits = ''; // Initialize internal digits state

                input.addEventListener('keydown', (e) => {
                    const isDigit = e.key >= '0' && e.key <= '9';
                    const isControl = ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab'].includes(e.key);
                    
                    if (!isDigit && !isControl && e.key !== ':') {
                        e.preventDefault();
                    } else if (isDigit) {
                        e.preventDefault();
                        let currentDigits = input.dataset.digits;

                        // Max 4 digits
                        if (currentDigits.length < 4) {
                            currentDigits += e.key;
                        } else {
                            currentDigits = currentDigits.substring(1) + e.key;
                        }
                        
                        input.dataset.digits = currentDigits;
                        const padded = currentDigits.padStart(4, '0');

                        let h_str = padded.slice(0, 2);
                        let m_str = padded.slice(2, 4);
                        
                        // FIX: Ensure 24-hour validation (00-23)
                        if (parseInt(h_str, 10) > 23) h_str = '23'; 
                        if (parseInt(m_str, 10) > 59) m_str = '59';

                        const formattedValue = `${h_str}:${m_str}`;
                        if (input.value !== formattedValue) {
                            input.value = formattedValue;
                        }
                    }
                });

                input.addEventListener('blur', (e) => {
                    let [h, m] = e.target.value.split(':').map(Number);
                    // FIX: Ensure 24-hour validation (00-23)
                    if (isNaN(h) || h < 0 || h > 23) h = 0; 
                    if (isNaN(m) || m < 0 || m > 59) m = 0;
                    const finalValue = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    e.target.value = finalValue;
                    input.dataset.digits = finalValue.replace(':', '');
                });
            });
        });


        // --- Firestore References ---
        // Note: For simplicity, user/student profile data is stored in 'userData/profile'
        const getStudentDataRef = (studentId) => doc(db, 'artifacts', appId, 'users', studentId, 'userData', 'profile');
        
        // Public Data: Class configuration and roster
        const getClassRef = (classId) => doc(db, 'artifacts', appId, 'public', 'data', 'classes', classId);
        const getRosterCollection = (classId) => collection(db, 'artifacts', appId, 'public', 'data', 'classes', classId, 'roster');

        // Public Data: Hand raising and co-teacher requests
        const getHandRequestsCollection = () => collection(db, 'artifacts', appId, 'public', 'data', 'hand_requests');
        const getCoteacherRequestsCollection = () => collection(db, 'artifacts', appId, 'public', 'data', 'coteacher_requests');
        
        // Public Data: Invitation links (for easy lookup)
        const getInviteRef = (inviteId) => doc(db, 'artifacts', appId, 'public', 'data', 'invites', inviteId);
        
        
        // --- Core Initialization ---

        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authenticate
                if (authToken) {
                    await signInWithCustomToken(auth, authToken);
                } else {
                    await signInAnonymously(auth);
                }
                currentUserId = auth.currentUser.uid;
                ui.userIdDisplay.textContent = currentUserId;

                // Determine user role
                const userProfileSnap = await getDoc(getStudentDataRef(currentUserId));
                const userRole = userProfileSnap.exists() ? userProfileSnap.data().role : 'student'; 
                
                isTeacher = (userRole === 'teacher' || userRole === 'coteacher');
                
                if (isTeacher) {
                    // Initialize Google API Client here, so it's ready when the button is clicked
                    await loadGoogleApi(); 
                    setupListeners();
                    generateInviteLinks();
                    setupEventHandlers();
                } else {
                    ui.mainContent.innerHTML = '<div class="text-center p-12 card bg-red-100 rounded-xl"><p class="text-xl font-bold text-red-700">Access Denied</p><p class="text-red-600 mt-2">You do not have the required role (Teacher or Co-Teacher) to view this dashboard.</p></div>';
                }

                ui.authCheck.classList.add('hidden');
                ui.mainContent.classList.remove('hidden');

            } catch (error) {
                console.error("Firebase/Auth initialization failed:", error);
                ui.authCheck.innerHTML = `<p class="text-center text-xl text-red-600">Error loading app. See console for details.</p>`;
            }
        }
        
        // --- Invite Link Generation ---

        async function generateInviteLinks() {
            // These IDs must match what the student/coteacher app uses to look up the invite
            const studentInviteId = `class-${currentClassId}-student`;
            const coteacherInviteId = `class-${currentClassId}-coteacher`;

            // 1. Ensure the invite links exist in Firestore
            const batch = writeBatch(db);
            
            // Student Invite: Role 'student', Class ID linked
            batch.set(getInviteRef(studentInviteId), {
                classId: currentClassId,
                role: 'student',
                updatedAt: new Date().toISOString()
            }, { merge: true });

            // Co-Teacher Invite: Role 'request-coteacher', Class ID linked
            batch.set(getInviteRef(coteacherInviteId), {
                classId: currentClassId,
                role: 'request-coteacher',
                updatedAt: new Date().toISOString()
            }, { merge: true });

            await batch.commit();

            // 2. Display the links (assuming a single-page app structure where "join" is handled by parameters)
            const baseUrl = window.location.origin + window.location.pathname;
            ui.studentInviteLink.value = `${baseUrl}?join=${studentInviteId}`;
            ui.coteacherInviteLink.value = `${baseUrl}?join=${coteacherInviteId}`;
        }
        
        // --- Real-time Listeners (The core "API Gathering") ---

        function setupListeners() {
            // 1. Class Data Listener (Title, Pause Status, Scheduled End Time)
            onSnapshot(getClassRef(currentClassId), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    ui.classTitle.textContent = data.name || 'Untitled Class';
                    
                    // Pause Status
                    const isPaused = data.isPaused || false;
                    ui.pauseStatus.textContent = isPaused ? 'Paused' : 'Active';
                    ui.pauseStatus.classList.toggle('text-green-600', !isPaused);
                    ui.pauseStatus.classList.toggle('text-red-600', isPaused);
                    ui.pauseBtn.textContent = isPaused ? 'Resume Hand Raising' : 'Pause Hand Raising';
                    ui.pauseBtn.classList.toggle('bg-yellow-500', !isPaused);
                    ui.pauseBtn.classList.toggle('hover:bg-yellow-600', !isPaused);
                    ui.pauseBtn.classList.toggle('bg-green-500', isPaused);
                    ui.pauseBtn.classList.toggle('hover:bg-green-600', isPaused);

                    // Scheduled End Time
                    const scheduledTime = data.scheduledEndTime || null;
                    if (scheduledTime) {
                        ui.scheduledStatus.textContent = `Class auto-ends at ${scheduledTime} today.`;
                        ui.scheduledStatus.classList.remove('text-gray-500');
                        ui.scheduledStatus.classList.add('text-indigo-600');
                        ui.classEndTimeInput.value = scheduledTime;
                    } else {
                        ui.scheduledStatus.textContent = 'No end time scheduled.';
                        ui.scheduledStatus.classList.add('text-gray-500');
                        ui.scheduledStatus.classList.remove('text-indigo-600');
                        ui.classEndTimeInput.value = '';
                    }
                } else {
                    console.error("Class document does not exist!");
                    // Create a basic class document if it's missing (needed for Google Import)
                    setDoc(getClassRef(currentClassId), {
                        name: 'New Class',
                        isPaused: false,
                        ownerId: currentUserId
                    }, { merge: true });
                    ui.classTitle.textContent = 'New Class (Initializing)';
                }
            });

            // 2. Roster Listener (Students and Co-Teachers)
            onSnapshot(query(getRosterCollection(currentClassId), where('classId', '==', currentClassId)), async (querySnapshot) => {
                let students = [];
                let coteachers = [];
                
                querySnapshot.forEach(doc => {
                    const data = { id: doc.id, ...doc.data() };
                    if (data.role === 'student') {
                        students.push(data);
                    } else if (data.role === 'coteacher' || data.role === 'teacher') {
                        coteachers.push(data);
                    }
                });

                // Sort lists
                students.sort((a, b) => (a.displayName || a.id).localeCompare(b.displayName || b.id));
                coteachers.sort((a, b) => (a.displayName || a.id).localeCompare(b.displayName || b.id));
                
                // Render Co-Teachers
                ui.coteacherCount.textContent = coteachers.length;
                ui.coteachersList.innerHTML = '';
                if (coteachers.length === 0) {
                    ui.coteachersList.innerHTML = '<p class="text-gray-500 text-sm">No co-teachers assigned.</p>';
                } else {
                    coteachers.forEach(item => ui.coteachersList.appendChild(renderRosterItem(item, 'coteacher')));
                }

                // Render Students
                ui.studentCount.textContent = students.length;
                ui.studentsList.innerHTML = '';
                if (students.length === 0) {
                    ui.studentsList.innerHTML = '<p class="text-gray-500 text-sm">No students in roster.</p>';
                } else {
                    students.forEach(item => ui.studentsList.appendChild(renderRosterItem(item, 'student')));
                }
            });

            // 3. Raised Hands Listener
            onSnapshot(query(getHandRequestsCollection(), where('classId', '==', currentClassId)), (querySnapshot) => {
                const hands = [];
                querySnapshot.forEach(doc => {
                    hands.push({ id: doc.id, ...doc.data() });
                });

                // Sort by timestamp (oldest first)
                hands.sort((a, b) => a.timestamp - b.timestamp);
                
                ui.raisedHandsCount.textContent = hands.length;
                ui.raisedHandsContainer.innerHTML = '';
                ui.noHandsMessage.classList.toggle('hidden', hands.length > 0);

                hands.forEach(hand => {
                    ui.raisedHandsContainer.appendChild(renderHandRequest(hand));
                });
            });

            // 4. Co-Teacher Requests Listener
            onSnapshot(query(getCoteacherRequestsCollection(), where('classId', '==', currentClassId)), (querySnapshot) => {
                const requests = [];
                querySnapshot.forEach(doc => {
                    requests.push({ id: doc.id, ...doc.data() });
                });

                ui.coteacherRequestCount.textContent = requests.length;
                ui.coteacherRequestsList.innerHTML = '';
                if (requests.length === 0) {
                    ui.coteacherRequestsList.innerHTML = '<p class="text-gray-500 text-sm">No pending requests.</p>';
                } else {
                    requests.forEach(req => {
                        ui.coteacherRequestsList.appendChild(renderCoTeacherRequest(req));
                    });
                }
            });
        }

        // --- Rendering Functions ---

        function renderRosterItem(user, type) {
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between text-sm text-gray-700 p-1 rounded-md';
            
            const name = user.displayName || 'Unknown User';
            
            div.innerHTML = `
                <span class="truncate">${name}</span>
                <button data-user-id="${user.id}" data-user-role="${user.role}" class="text-xs text-red-500 hover:text-red-700 remove-user-btn">
                    Remove
                </button>
            `;
            return div;
        }

        function renderHandRequest(hand) {
            const timeRaised = new Date(hand.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            const card = document.createElement('div');
            card.className = 'flex justify-between items-center p-4 bg-yellow-50 rounded-xl border border-yellow-200';
            card.innerHTML = `
                <div>
                    <p class="font-semibold text-gray-800">${hand.displayName || 'Anonymous Student'}</p>
                    <p class="text-sm text-gray-500">${hand.comment ? hand.comment.substring(0, 50) + (hand.comment.length > 50 ? '...' : '') : 'No comment provided.'}</p>
                    <p class="text-xs text-yellow-700 mt-1">Raised at ${timeRaised}</p>
                </div>
                <button data-hand-id="${hand.id}" data-name="${hand.displayName || 'Anonymous Student'}" data-comment="${hand.comment || ''}" class="bg-indigo-500 text-white py-1 px-3 rounded-lg text-sm font-semibold hover:bg-indigo-600 transition duration-150 view-hand-btn">
                    View
                </button>
            `;
            return card;
        }

        function renderCoTeacherRequest(req) {
            const card = document.createElement('div');
            card.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-200';
            card.innerHTML = `
                <p class="text-sm font-medium text-gray-700">${req.displayName || 'Unknown User'}</p>
                <div class="space-x-2">
                    <button data-request-id="${req.id}" data-user-id="${req.userId}" class="bg-green-500 text-white py-1 px-2 rounded-lg text-xs font-semibold hover:bg-green-600 transition duration-150 accept-coteacher-btn">
                        Accept
                    </button>
                    <button data-request-id="${req.id}" class="bg-red-500 text-white py-1 px-2 rounded-lg text-xs font-semibold hover:bg-red-600 transition duration-150 deny-coteacher-btn">
                        Deny
                    </button>
                </div>
            `;
            return card;
        }

        // --- Action Handlers ---

        function setupEventHandlers() {
            ui.pauseBtn.addEventListener('click', togglePause);
            ui.lowerAllHandsBtn.addEventListener('click', lowerAllHands);
            ui.setScheduleBtn.addEventListener('click', setSchedule);
            ui.clearScheduleBtn.addEventListener('click', clearSchedule);
            ui.gcImportBtn.addEventListener('click', importFromGoogleClassroom);
            ui.acceptHandBtn.addEventListener('click', acceptAndLowerHand);
            ui.denyHandBtn.addEventListener('click', denyHand);

            // Delegated click handler for viewing raised hands
            ui.raisedHandsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('view-hand-btn')) {
                    const btn = e.target;
                    activeHandRequestId = btn.dataset.handId;
                    ui.handRequesterName.textContent = btn.dataset.name;
                    ui.handRequesterComment.value = btn.dataset.comment || 'No comment provided.';
                    openModal('hand-request-modal');
                }
            });

            // Delegated click handler for roster removal
            ui.studentsList.parentNode.addEventListener('click', async (e) => {
                if (e.target.classList.contains('remove-user-btn')) {
                    const userId = e.target.dataset.userId;
                    const role = e.target.dataset.userRole;
                    if (confirmModal(`Are you sure you want to remove this ${role} from the roster?`)) {
                        await removeUserFromRoster(userId);
                    }
                }
            });

            // Delegated click handler for co-teacher requests
            ui.coteacherRequestsList.addEventListener('click', async (e) => {
                if (e.target.classList.contains('accept-coteacher-btn')) {
                    const userId = e.target.dataset.userId;
                    const requestId = e.target.dataset.requestId;
                    await handleCoteacherRequest(userId, requestId, 'accept');
                } else if (e.target.classList.contains('deny-coteacher-btn')) {
                    const requestId = e.target.dataset.requestId;
                    await handleCoteacherRequest(null, requestId, 'deny');
                }
            });
        }
        
        // Custom confirm modal replacement (simple version for now)
        function confirmModal(message) {
            // NOTE: In a production app, you would use a custom modal here. 
            // Using window.confirm temporarily for quick testing of the logic flow.
            return window.confirm(message);
        }

        async function togglePause() {
            try {
                const classRef = getClassRef(currentClassId);
                const docSnap = await getDoc(classRef);
                const currentStatus = docSnap.exists() ? docSnap.data().isPaused : false;
                
                await updateDoc(classRef, {
                    isPaused: !currentStatus,
                    updatedAt: new Date().toISOString()
                });
                console.log(`Hand raising toggled to: ${!currentStatus}`);
            } catch (error) {
                console.error("Error toggling pause status:", error);
            }
        }

        async function lowerAllHands() {
            if (!confirmModal('Are you sure you want to clear ALL raised hands? This action cannot be undone.')) return;
            
            try {
                const handsQuery = query(getHandRequestsCollection(), where('classId', '==', currentClassId));
                const snapshot = await getDocs(handsQuery);
                
                const batch = writeBatch(db);
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                console.log('All hands successfully lowered.');

                // Also reset the scheduling
                await clearSchedule(false);

            } catch (error) {
                console.error("Error lowering all hands:", error);
            }
        }

        async function setSchedule() {
            const time = ui.classEndTimeInput.value;
            if (!time || !time.match(/^\d{2}:\d{2}$/)) {
                console.error("Invalid time format. Use HH:MM (24h).");
                return;
            }
            try {
                await updateDoc(getClassRef(currentClassId), {
                    scheduledEndTime: time,
                    updatedAt: new Date().toISOString()
                });
                console.log(`Class end time scheduled for ${time}.`);
            } catch (error) {
                console.error("Error setting schedule:", error);
            }
        }

        async function clearSchedule(showConfirm = true) {
            if (showConfirm && !confirmModal('Are you sure you want to clear the scheduled end time?')) return;
            
            try {
                await updateDoc(getClassRef(currentClassId), {
                    scheduledEndTime: null,
                    updatedAt: new Date().toISOString()
                });
                console.log('Class end time schedule cleared.');
            } catch (error) {
                console.error("Error clearing schedule:", error);
            }
        }


        async function acceptAndLowerHand() {
            if (!activeHandRequestId) return;
            try {
                // 1. Delete the hand request document (lowers the hand)
                await deleteDoc(doc(getHandRequestsCollection(), activeHandRequestId));
                
                // 2. You might add logic here to notify the student their hand was accepted
                
                closeModal('hand-request-modal');
                activeHandRequestId = null;
                console.log(`Hand request ${activeHandRequestId} accepted and lowered.`);
            } catch (error) {
                console.error("Error accepting and lowering hand:", error);
            }
        }

        async function denyHand() {
            if (!activeHandRequestId) return;
            try {
                // 1. Delete the hand request document (denies and lowers the hand)
                await deleteDoc(doc(getHandRequestsCollection(), activeHandRequestId));
                
                // 2. You might add logic here to notify the student their hand was denied
                
                closeModal('hand-request-modal');
                activeHandRequestId = null;
                console.log(`Hand request ${activeHandRequestId} denied and lowered.`);
            } catch (error) {
                console.error("Error denying hand:", error);
            }
        }

        async function handleCoteacherRequest(userId, requestId, action) {
            try {
                const batch = writeBatch(db);
                
                // 1. Delete the request document regardless of action
                batch.delete(doc(getCoteacherRequestsCollection(), requestId));

                if (action === 'accept' && userId) {
                    // 2. Update the user's role to 'coteacher' in their profile
                    batch.update(getStudentDataRef(userId), {
                        role: 'coteacher',
                        classId: arrayUnion(currentClassId) // Assuming classId is an array of classes the user is part of
                    });

                    // 3. Add the user to the class roster (if not already there)
                    batch.set(doc(getRosterCollection(currentClassId), userId), {
                        userId: userId,
                        role: 'coteacher',
                        displayName: 'Co-Teacher', // Placeholder, ideally should be fetched
                        classId: currentClassId 
                    }, { merge: true });

                    console.log(`Co-teacher request for user ${userId} accepted.`);
                } else {
                    console.log(`Co-teacher request ${requestId} denied.`);
                }

                await batch.commit();

            } catch (error) {
                console.error(`Error handling co-teacher request (${action}):`, error);
            }
        }

        async function removeUserFromRoster(userId) {
            try {
                const rosterDocRef = doc(getRosterCollection(currentClassId), userId);
                await deleteDoc(rosterDocRef);
                console.log(`User ${userId} removed from roster.`);

                // Optionally, you might also update their profile to remove classId from their list
                await updateDoc(getStudentDataRef(userId), {
                    classId: arrayRemove(currentClassId)
                }).catch(err => console.warn("Could not remove classId from user profile. User may not have a profile yet.", err));

            } catch (error) {
                console.error("Error removing user from roster:", error);
            }
        }
        
        // --- Google Classroom API Functions ---
        
        function loadGoogleApi() {
            return new Promise((resolve) => {
                // Check if gapi is available
                if (typeof gapi === 'undefined') {
                     console.error("Google API script not loaded. Check network and CSP.");
                     resolve();
                     return;
                }

                gapi.load('client:auth2', () => {
                    gapi.client.init({
                        clientId: GOOGLE_CLIENT_ID,
                        scope: GC_SCOPES.join(' '),
                        // discoveryDocs: ["https://classroom.googleapis.com/$discovery/rest?version=v1"] // Optional, but can improve performance
                    }).then(() => {
                        gapiReady = true;
                        console.log('Google API client loaded and initialized.');
                        resolve();
                    }).catch(error => {
                        console.error('Error initializing Google API client:', error);
                        ui.gcStatus.textContent = 'GC Import failed to initialize. Check console.';
                        resolve();
                    });
                });
            });
        }
        
        /**
         * Initiates the OAuth sign-in flow and returns the successful authentication result.
         */
        function handleAuthClick() {
            const authInstance = gapi.auth2.getAuthInstance();
            
            // Check if user is already signed in
            if (authInstance.isSignedIn.get()) {
                // Already signed in, check if permissions are granted for the required scope
                if (authInstance.currentUser.get().hasGrantedScopes(GC_SCOPES.join(' '))) {
                    console.log("Already signed in and scopes granted.");
                    return Promise.resolve(true);
                }
            }
            
            // Initiate sign-in flow (prompts user if not signed in or scopes not granted)
            return authInstance.signIn().then(
                googleUser => {
                    console.log("Google sign-in successful.");
                    return true;
                },
                error => {
                    console.error("Google sign-in failed:", error);
                    return false;
                }
            );
        }

        async function fetchGoogleCourses() {
            ui.gcStatus.textContent = 'Fetching courses...';
            try {
                // Ensure classroom API is loaded
                await gapi.client.load('classroom', 'v1');
                
                const response = await gapi.client.classroom.courses.list({
                    'teacherId': 'me' // List courses taught by the current user
                });

                const courses = response.result.courses || [];
                return courses.filter(c => c.courseState === 'ACTIVE');

            } catch (error) {
                console.error('Error fetching Google Classroom courses:', error);
                ui.gcStatus.textContent = 'Error fetching courses. Check console.';
                return [];
            }
        }

        async function fetchAndImportRoster(courseId, courseName) {
            closeModal('gc-select-modal');
            ui.gcStatus.textContent = `Importing ${courseName}...`;

            try {
                // 1. Fetch Students
                const studentsResponse = await gapi.client.classroom.courses.students.list({
                    courseId: courseId
                });
                const students = studentsResponse.result.students || [];

                // 2. Update Firestore Class Name
                await updateDoc(getClassRef(currentClassId), {
                    name: courseName,
                    googleCourseId: courseId,
                    updatedAt: new Date().toISOString()
                });

                // 3. Update Firestore Roster
                const batch = writeBatch(db);
                let importedCount = 0;

                for (const student of students) {
                    const profile = student.profile;
                    const studentUserId = `GC-${profile.id}`; // Prefix with 'GC-' to avoid ID collision
                    
                    // Skip teacher if they are in their own roster (based on email)
                    const currentUserEmail = gapi.auth2.getAuthInstance().currentUser.get().getBasicProfile().getEmail();
                    if (profile.emailAddress === currentUserEmail) continue; 

                    // Add/update roster entry
                    batch.set(doc(getRosterCollection(currentClassId), studentUserId), {
                        userId: studentUserId,
                        role: 'student',
                        displayName: profile.name.fullName,
                        email: profile.emailAddress,
                        source: 'Google Classroom',
                        classId: currentClassId,
                    }, { merge: true });
                    
                    // Add/update profile entry (useful if the student later joins our app)
                    batch.set(getStudentDataRef(studentUserId), {
                        displayName: profile.name.fullName,
                        email: profile.emailAddress,
                        role: 'student',
                        classId: arrayUnion(currentClassId)
                    }, { merge: true });
                    
                    importedCount++;
                }

                await batch.commit();
                ui.gcStatus.textContent = `Successfully imported ${importedCount} students from ${courseName}.`;
                ui.classTitle.textContent = courseName;

            } catch (error) {
                console.error('Error importing roster:', error);
                ui.gcStatus.textContent = 'Import failed. See console for details.';
            }
        }

        async function importFromGoogleClassroom() {
            // First, ensure the Google Client ID is configured
            if (GOOGLE_CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID') {
                ui.gcStatus.textContent = 'ERROR: Please replace "YOUR_GOOGLE_CLIENT_ID" in the code with your actual Client ID.';
                return;
            }

            // Check if the Google API client is ready
            if (!gapiReady) {
                 ui.gcStatus.textContent = 'Google API client is not yet loaded. Please wait.';
                 console.warn('Google API client not ready. Retrying initialization...');
                 // Attempt to re-initialize if needed
                 await loadGoogleApi();
                 if (!gapiReady) return; 
            }

            ui.gcStatus.textContent = 'Authenticating with Google...';

            try {
                // Start OAuth flow and wait for result
                const authSuccess = await handleAuthClick();

                if (authSuccess) {
                    // Fetch and display courses
                    const courses = await fetchGoogleCourses();
                    
                    if (courses.length === 0) {
                        ui.gcStatus.textContent = 'No active Google Classrooms found where you are the primary teacher.';
                        return;
                    }

                    // Render courses in the modal
                    ui.gcClassList.innerHTML = '';
                    courses.forEach(course => {
                        const btn = document.createElement('button');
                        btn.className = 'w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-indigo-50 transition duration-150';
                        btn.innerHTML = `<p class="font-semibold text-gray-800">${course.name}</p><p class="text-xs text-gray-500">${course.section || 'No section'}</p>`;
                        btn.onclick = () => fetchAndImportRoster(course.id, course.name);
                        ui.gcClassList.appendChild(btn);
                    });

                    // Show the selection modal
                    openModal('gc-select-modal');
                    ui.gcStatus.textContent = 'Select a class to import.';

                } else {
                    ui.gcStatus.textContent = 'Google Authentication failed or was cancelled.';
                }
            } catch (error) {
                console.error('Google Classroom Import failed:', error);
                ui.gcStatus.textContent = 'Google Import failed. Check console.';
            }
        }

        // Start the application
        initFirebase();

    </script>
</body>
</html>
