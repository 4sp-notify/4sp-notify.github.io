<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notify | Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        .card { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        /* Custom modal styles */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
    </style>
</head>
<body class="p-6">

    <div id="auth-check" class="text-center p-8">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-500 mx-auto"></div>
        <p class="mt-3 text-gray-600">Loading application...</p>
    </div>

    <div id="main-content" class="hidden">
        <header class="flex justify-between items-center pb-6 border-b border-gray-200 mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Class Dashboard: <span id="class-title">Loading...</span></h1>
            <p id="user-info" class="text-sm text-gray-500">User ID: <span id="user-id"></span></p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Class Management Panel (Invite Links, Pause, Lower Hands, Schedule) -->
            <section class="lg:col-span-2 space-y-6">
                <div class="card bg-white p-6 rounded-xl space-y-4">
                    <h2 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-4">Class Controls & Invitations</h2>

                    <!-- Hand Raising State -->
                    <div class="flex items-center justify-between p-3 bg-indigo-50 rounded-lg">
                        <span class="font-medium text-indigo-800">Hand Raising:</span>
                        <div class="flex items-center space-x-2">
                            <span id="pause-status" class="font-bold text-green-600">Active</span>
                            <button id="pause-btn" class="bg-yellow-500 text-white py-1 px-3 rounded-lg font-semibold hover:bg-yellow-600 transition duration-150">Pause Hand Raising</button>
                        </div>
                    </div>
                    
                    <!-- Class End Cleanup -->
                    <div class="space-y-2 pt-2 border-t border-gray-100">
                        <div class="flex items-center justify-between">
                            <label for="class-end-time" class="text-sm font-medium text-gray-700">Class End Time (24h):</label>
                            <input type="text" id="class-end-time" class="time-input w-24 p-2 border border-gray-300 rounded-lg text-sm" placeholder="HH:MM" data-digits="">
                            <button id="set-schedule-btn" class="bg-green-500 text-white py-1 px-3 rounded-lg text-sm font-semibold hover:bg-green-600 transition duration-150">Set Schedule</button>
                            <button id="clear-schedule-btn" class="bg-gray-300 text-gray-800 py-1 px-3 rounded-lg text-sm font-semibold hover:bg-gray-400 transition duration-150">Clear</button>
                        </div>
                        <p class="text-xs text-gray-500" id="scheduled-status">No end time scheduled.</p>
                        <button id="lower-all-hands-btn" class="w-full mt-3 bg-red-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-red-600 transition duration-150">End Class: Lower All Hands</button>
                    </div>

                    <!-- Invite Links -->
                    <div class="space-y-3 pt-4 border-t border-gray-100">
                        <h3 class="text-lg font-medium text-gray-700">Class Invite Links</h3>
                        
                        <!-- Student Invite Link -->
                        <div class="flex items-center space-x-2">
                            <input type="text" id="student-invite-link" readonly class="flex-grow p-2 border border-gray-300 rounded-lg text-sm bg-gray-50 cursor-pointer" value="Loading Student Link...">
                            <button onclick="copyToClipboard('student-invite-link')" class="bg-blue-500 text-white py-2 px-3 rounded-lg text-sm hover:bg-blue-600 transition duration-150">Copy</button>
                        </div>
                        <p class="text-xs text-gray-500">Share this link for students to join automatically.</p>

                        <!-- Co-Teacher Invite Link -->
                        <div class="flex items-center space-x-2 pt-2">
                            <input type="text" id="coteacher-invite-link" readonly class="flex-grow p-2 border border-gray-300 rounded-lg text-sm bg-gray-50 cursor-pointer" value="Loading Co-Teacher Link...">
                            <button onclick="copyToClipboard('coteacher-invite-link')" class="bg-blue-500 text-white py-2 px-3 rounded-lg text-sm hover:bg-blue-600 transition duration-150">Copy</button>
                        </div>
                        <p class="text-xs text-gray-500">Share this link for users to request Co-Teacher status.</p>
                    </div>

                </div>
            </section>
            
            <!-- Roster & Requests Panel -->
            <section class="lg:col-span-1 space-y-6">

                <!-- Co-Teacher Requests -->
                <div class="card bg-white p-6 rounded-xl">
                    <h2 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-4">Co-Teacher Requests (<span id="coteacher-request-count">0</span>)</h2>
                    <div id="coteacher-requests-list" class="space-y-3">
                        <p class="text-gray-500 text-sm">No pending requests.</p>
                    </div>
                </div>

                <!-- Roster Section -->
                <div class="card bg-white p-6 rounded-xl">
                    <h2 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-4">Class Roster</h2>
                    
                    <h3 class="font-bold text-gray-700 mb-1">Co-Teachers (<span id="coteacher-count">0</span>)</h3>
                    <div id="coteachers-list" class="space-y-1 pb-3 border-b border-gray-100">
                        <p class="text-gray-500 text-sm">No co-teachers assigned.</p>
                    </div>

                    <h3 class="font-bold text-gray-700 mt-3 mb-1">Students (<span id="student-count">0</span>)</h3>
                    <div id="students-list" class="space-y-1">
                        <p class="text-gray-500 text-sm">No students in roster.</p>
                    </div>
                </div>
            </section>
        </main>

        <!-- Raised Hand Requests -->
        <section class="mt-8">
            <div class="card bg-white p-6 rounded-xl">
                <h2 class="text-xl font-semibold text-gray-700 border-b pb-2 mb-4">Raised Hand Requests (<span id="raised-hands-count">0</span>)</h2>
                <div id="raised-hands-container" class="space-y-4">
                    <p class="text-gray-500" id="no-hands-message">No hands currently raised.</p>
                    <!-- Student Hand Request Cards will go here -->
                </div>
            </div>
        </section>

    </div>

    <!-- Hand Request Modal (Accept/Deny) -->
    <div id="hand-request-modal" class="modal-overlay fixed inset-0 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-xl w-full max-w-sm card">
            <h3 class="text-lg font-bold mb-4">Hand Request</h3>
            <p class="text-gray-700 mb-4"><span id="hand-requester-name" class="font-semibold"></span> raised their hand.</p>
            <textarea id="hand-requester-comment" class="w-full p-2 border rounded-lg resize-none mb-4" rows="3" readonly placeholder="No comment provided."></textarea>
            
            <div class="flex justify-end space-x-3">
                <button id="deny-hand-btn" class="bg-red-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-red-600 transition duration-150">Deny</button>
                <button id="accept-hand-btn" class="bg-green-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-green-600 transition duration-150">Accept & Lower</button>
            </div>
            <button onclick="closeModal('hand-request-modal')" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, query, where, arrayRemove, arrayUnion, writeBatch, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getGoogleClassroomAccessToken, getGoogleClassroomClasses, getGoogleClassroomCourseRoster } from "./google_classroom_api.js"; // Assuming a local file for GC API helpers

        setLogLevel('Debug');

        // --- Global Variables & Initialization ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, db, auth;
        let currentClassId = 'class_001'; // Placeholder: Assume a fixed class ID for simplicity
        let currentUserId = null;
        let isTeacher = false; // Flag to determine teacher/coteacher vs student view
        let isAuthReady = false;

        // --- UI Elements ---
        const ui = {
            mainContent: document.getElementById('main-content'),
            authCheck: document.getElementById('auth-check'),
            classTitle: document.getElementById('class-title'),
            userIdDisplay: document.getElementById('user-id'),
            
            // Controls
            pauseStatus: document.getElementById('pause-status'),
            pauseBtn: document.getElementById('pause-btn'),
            lowerAllHandsBtn: document.getElementById('lower-all-hands-btn'),
            
            // Scheduling
            classEndTimeInput: document.getElementById('class-end-time'),
            setScheduleBtn: document.getElementById('set-schedule-btn'),
            clearScheduleBtn: document.getElementById('clear-schedule-btn'),
            scheduledStatus: document.getElementById('scheduled-status'),

            // Invites
            studentInviteLink: document.getElementById('student-invite-link'),
            coteacherInviteLink: document.getElementById('coteacher-invite-link'),

            // Roster
            coteacherRequestCount: document.getElementById('coteacher-request-count'),
            coteacherRequestsList: document.getElementById('coteacher-requests-list'),
            coteacherCount: document.getElementById('coteacher-count'),
            coteachersList: document.getElementById('coteachers-list'),
            studentCount: document.getElementById('student-count'),
            studentsList: document.getElementById('students-list'),
            
            // Hands
            raisedHandsCount: document.getElementById('raised-hands-count'),
            raisedHandsContainer: document.getElementById('raised-hands-container'),
            noHandsMessage: document.getElementById('no-hands-message'),

            // Modal
            handRequestModal: document.getElementById('hand-request-modal'),
            handRequesterName: document.getElementById('hand-requester-name'),
            handRequesterComment: document.getElementById('hand-requester-comment'),
            acceptHandBtn: document.getElementById('accept-hand-btn'),
            denyHandBtn: document.getElementById('deny-hand-btn')
        };


        // --- Utility Functions ---

        // Clipboard function
        window.copyToClipboard = (elementId) => {
            const input = document.getElementById(elementId);
            input.select();
            document.execCommand('copy');
            const originalValue = input.value;
            input.value = 'Copied!';
            setTimeout(() => input.value = originalValue, 1000);
        }

        // Modal functions
        window.openModal = (modalId) => document.getElementById(modalId).classList.remove('hidden');
        window.closeModal = (modalId) => document.getElementById(modalId).classList.add('hidden');
        
        // Time input formatting (re-used from previous snippet)
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.time-input').forEach(input => {
                input.dataset.digits = ''; // Initialize internal digits state

                input.addEventListener('keydown', (e) => {
                    const isDigit = e.key >= '0' && e.key <= '9';
                    const isControl = ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab'].includes(e.key);
                    
                    if (!isDigit && !isControl && e.key !== ':') {
                        e.preventDefault();
                    } else if (isDigit) {
                        e.preventDefault();
                        let currentDigits = input.dataset.digits;

                        if (currentDigits.length < 4) {
                            currentDigits += e.key;
                        } else {
                            currentDigits = currentDigits.substring(1) + e.key;
                        }
                        
                        input.dataset.digits = currentDigits;
                        const padded = currentDigits.padStart(4, '0');

                        let h_str = padded.slice(0, 2);
                        let m_str = padded.slice(2, 4);
                        
                        if (parseInt(h_str, 10) > 23) h_str = '23'; // 24h format for scheduling
                        if (parseInt(h_str, 10) < 0) h_str = '00';
                        if (parseInt(m_str, 10) > 59) m_str = '59';

                        const formattedValue = `${h_str}:${m_str}`;
                        if (input.value !== formattedValue) {
                            input.value = formattedValue;
                        }
                    }
                });

                input.addEventListener('blur', (e) => {
                    let [h, m] = e.target.value.split(':').map(Number);
                    if (isNaN(h) || h < 0 || h > 23) h = 0; // 24h
                    if (isNaN(m) || m < 0 || m > 59) m = 0;
                    const finalValue = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    e.target.value = finalValue;
                    input.dataset.digits = finalValue.replace(':', '');
                });
            });
        });


        // --- Firestore References ---
        const getTeacherRef = (userId) => doc(db, 'artifacts', appId, 'users', userId, 'userData', 'profile');
        const getClassRef = (classId) => doc(db, 'artifacts', appId, 'public', 'data', 'classes', classId);
        const getStudentDataRef = (studentId) => doc(db, 'artifacts', appId, 'users', studentId, 'userData', 'profile');
        const getInviteRef = (inviteId) => doc(db, 'artifacts', appId, 'public', 'data', 'invites', inviteId);
        const getCoteacherRequestsCollection = () => collection(db, 'artifacts', appId, 'public', 'data', 'coteacher_requests');
        
        // --- Core Functions ---

        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (authToken) {
                    await signInWithCustomToken(auth, authToken);
                } else {
                    await signInAnonymously(auth);
                }
                currentUserId = auth.currentUser.uid;
                ui.userIdDisplay.textContent = currentUserId;

                // Check if user is teacher/coteacher
                const userProfileSnap = await getDoc(getStudentDataRef(currentUserId));
                const userRole = userProfileSnap.exists() ? userProfileSnap.data().role : 'student'; // Default to student
                
                isTeacher = (userRole === 'teacher' || userRole === 'coteacher');
                
                // For a dashboard, we assume the user is a teacher/coteacher and has a class ID
                if (isTeacher) {
                    // Start all listeners only if auth is ready and user is a teacher
                    setupListeners();
                    generateInviteLinks();
                } else {
                    ui.mainContent.innerHTML = '<p class="text-center text-xl text-red-600">You do not have permission to view this dashboard. Only teachers and co-teachers are allowed.</p>';
                }

                ui.authCheck.classList.add('hidden');
                ui.mainContent.classList.remove('hidden');

            } catch (error) {
                console.error("Firebase/Auth initialization failed:", error);
                ui.authCheck.innerHTML = `<p class="text-center text-xl text-red-600">Error loading app. See console for details.</p>`;
            }
        }
        
        // --- Invite Link Generation ---

        async function generateInviteLinks() {
            const batch = writeBatch(db);
            const classDocRef = getClassRef(currentClassId);
            const docSnap = await getDoc(classDocRef);
            const className = docSnap.exists() ? docSnap.data().title || 'Untitled Class' : 'Untitled Class';

            // Generate/Reuse IDs for predictable links
            const studentInviteId = `${currentClassId}_student`;
            const coteacherInviteId = `${currentClassId}_coteacher`;

            // 1. Student Link
            const studentRef = getInviteRef(studentInviteId);
            batch.set(studentRef, {
                classId: currentClassId,
                className: className,
                targetRole: 'student',
                createdAt: new Date().toISOString()
            }, { merge: true });
            
            // 2. Co-Teacher Link
            const coteacherRef = getInviteRef(coteacherInviteId);
            batch.set(coteacherRef, {
                classId: currentClassId,
                className: className,
                targetRole: 'coteacher',
                createdAt: new Date().toISOString()
            }, { merge: true });

            await batch.commit();

            const baseUrl = window.location.origin + '/invite.html?code=';
            ui.studentInviteLink.value = baseUrl + studentInviteId;
            ui.coteacherInviteLink.value = baseUrl + coteacherInviteId;
        }

        // --- Class Management Actions ---
        
        // Toggle Pause/Resume Hand Raising
        ui.pauseBtn.addEventListener('click', async () => {
            const classRef = getClassRef(currentClassId);
            const classSnap = await getDoc(classRef);
            if (!classSnap.exists()) return console.error("Class not found.");
            
            const isCurrentlyPaused = classSnap.data().isPaused || false;
            const newPauseState = !isCurrentlyPaused;

            await updateDoc(classRef, { isPaused: newPauseState });
            // UI update happens automatically via onSnapshot listener
        });
        
        // Lower All Hands
        ui.lowerAllHandsBtn.addEventListener('click', async () => {
            await lowerAllHands();
        });

        async function lowerAllHands() {
            const raisedHandsQuery = query(
                collection(db, 'artifacts', appId, 'public', 'data', 'students_status'),
                where('classId', '==', currentClassId),
                where('isRaised', '==', true)
            );

            const snapshot = await getDocs(raisedHandsQuery);
            const batch = writeBatch(db);

            snapshot.docs.forEach(docSnap => {
                // Delete the student_status document from the database
                batch.delete(docSnap.ref);
                // Note: The student's document (profile) should also be updated if it stores the hand status, 
                // but for real-time tracking, a separate 'students_status' collection is better for performance.
            });

            // Also clear the class end schedule
            await updateDoc(getClassRef(currentClassId), { classEndTime: null });

            await batch.commit();
            console.log("All hands lowered and status documents deleted.");
        }

        // --- Scheduling Hand Lowering ---

        ui.setScheduleBtn.addEventListener('click', async () => {
            const timeStr = ui.classEndTimeInput.value;
            if (!timeStr || timeStr.length !== 5 || !timeStr.includes(':')) {
                return alert('Please enter a valid time in HH:MM format (e.g., 23:59).');
            }

            const [h, m] = timeStr.split(':').map(Number);
            const now = new Date();
            let scheduledDate = new Date(now);
            scheduledDate.setHours(h, m, 0, 0);

            // If scheduled time is in the past, schedule for tomorrow
            if (scheduledDate.getTime() <= now.getTime()) {
                scheduledDate.setDate(scheduledDate.getDate() + 1);
            }

            await updateDoc(getClassRef(currentClassId), { 
                classEndTime: scheduledDate.toISOString() 
            });
            alert(`Class end scheduled for ${scheduledDate.toLocaleTimeString()}.`);
            // The UI will update via the class listener
        });

        ui.clearScheduleBtn.addEventListener('click', async () => {
            await updateDoc(getClassRef(currentClassId), { classEndTime: null });
            // The UI will update via the class listener
        });

        // --- Roster & Request Handlers ---

        async function handleCoTeacherRequest(requestId, action) {
            const requestRef = doc(getCoteacherRequestsCollection(), requestId);
            const requestSnap = await getDoc(requestRef);
            if (!requestSnap.exists()) return;
            
            const data = requestSnap.data();
            const classRef = getClassRef(currentClassId);

            if (action === 'accept') {
                const batch = writeBatch(db);
                
                // 1. Add to the co-teacher list on the class document
                batch.update(classRef, {
                    coteacherEmails: arrayUnion(data.requesterEmail)
                });

                // 2. Update the user's role/profile document
                const userProfileRef = getStudentDataRef(data.requesterId);
                batch.set(userProfileRef, { role: 'coteacher', activeClassId: currentClassId }, { merge: true });

                // 3. Delete the request
                batch.delete(requestRef);
                
                await batch.commit();
            } else if (action === 'deny') {
                // 1. Just delete the request
                await deleteDoc(requestRef);
            }
            // UI update happens automatically via onSnapshot listeners
        }

        // --- Hand Request Handlers (Modal Logic) ---

        let currentHandRequest = null;

        window.openHandRequestModal = (studentId, studentName, comment) => {
            currentHandRequest = studentId;
            ui.handRequesterName.textContent = studentName;
            ui.handRequesterComment.value = comment || 'No comment provided.';
            openModal('hand-request-modal');
        }

        ui.acceptHandBtn.addEventListener('click', async () => {
            if (!currentHandRequest) return;
            // Lower the hand (delete the status doc)
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students_status', currentHandRequest));
            closeModal('hand-request-modal');
            currentHandRequest = null;
        });

        ui.denyHandBtn.addEventListener('click', async () => {
            if (!currentHandRequest) return;
            // Lower the hand (delete the status doc) - denying is still lowering the hand from the queue
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students_status', currentHandRequest));
            closeModal('hand-request-modal');
            currentHandRequest = null;
        });

        // --- Firestore Listeners ---

        function setupListeners() {
            // 1. Class Data Listener (for Title, Pause Status, and Schedule)
            onSnapshot(getClassRef(currentClassId), (docSnap) => {
                if (!docSnap.exists()) {
                    ui.classTitle.textContent = "Class Not Found";
                    return;
                }

                const data = docSnap.data();
                ui.classTitle.textContent = data.title || 'Untitled Class';

                // Update Pause Status UI
                const isPaused = data.isPaused || false;
                ui.pauseStatus.textContent = isPaused ? 'Paused' : 'Active';
                ui.pauseStatus.classList.toggle('text-green-600', !isPaused);
                ui.pauseStatus.classList.toggle('text-red-600', isPaused);
                ui.pauseBtn.textContent = isPaused ? 'Resume Hand Raising' : 'Pause Hand Raising';

                // Update Schedule UI and check for cleanup
                const classEndTime = data.classEndTime;
                if (classEndTime) {
                    const scheduledTime = new Date(classEndTime);
                    ui.scheduledStatus.textContent = `Scheduled hand-lowering at ${scheduledTime.toLocaleTimeString()}.`;
                    ui.classEndTimeInput.value = `${String(scheduledTime.getHours()).padStart(2, '0')}:${String(scheduledTime.getMinutes()).padStart(2, '0')}`;
                    
                    // Automatic cleanup check
                    if (scheduledTime.getTime() <= new Date().getTime()) {
                        console.log("Scheduled class end time passed. Initiating lowerAllHands.");
                        lowerAllHands(); // Trigger cleanup
                    }
                } else {
                    ui.scheduledStatus.textContent = "No end time scheduled.";
                    ui.classEndTimeInput.value = '';
                }

                // Update Roster (Co-Teachers and Students)
                renderRoster(data.studentEmails || [], data.coteacherEmails || []);

            }, (error) => console.error("Error listening to class data:", error));


            // 2. Raised Hands Listener (students_status collection)
            const handsQuery = query(
                collection(db, 'artifacts', appId, 'public', 'data', 'students_status'),
                where('classId', '==', currentClassId),
                where('isRaised', '==', true)
            );

            onSnapshot(handsQuery, (snapshot) => {
                let handCards = '';
                const count = snapshot.size;
                ui.raisedHandsCount.textContent = count;
                ui.noHandsMessage.classList.toggle('hidden', count > 0);

                snapshot.docs.sort((a, b) => {
                    return new Date(a.data().timestamp) - new Date(b.data().timestamp);
                }).forEach(docSnap => {
                    const data = docSnap.data();
                    // studentId is the doc.id
                    handCards += `
                        <div class="p-4 bg-yellow-50 rounded-lg flex justify-between items-center border border-yellow-200">
                            <div>
                                <p class="font-semibold text-gray-800">${data.studentName || 'A Student'}</p>
                                <p class="text-sm text-gray-600">Raised at: ${new Date(data.timestamp).toLocaleTimeString()}</p>
                            </div>
                            <button onclick="openHandRequestModal('${docSnap.id}', '${data.studentName || 'A Student'}', '${data.comment || ''}')" 
                                    class="bg-indigo-600 text-white py-1 px-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150">
                                View Request
                            </button>
                        </div>
                    `;
                });

                ui.raisedHandsContainer.innerHTML = handCards;
            }, (error) => console.error("Error listening to raised hands:", error));
            
            
            // 3. Co-Teacher Requests Listener
            const requestsQuery = query(
                getCoteacherRequestsCollection(),
                where('classId', '==', currentClassId),
                where('status', '==', 'pending')
            );
            
            onSnapshot(requestsQuery, (snapshot) => {
                let requestCards = '';
                const count = snapshot.size;
                ui.coteacherRequestCount.textContent = count;

                if (count === 0) {
                    ui.coteacherRequestsList.innerHTML = '<p class="text-gray-500 text-sm">No pending requests.</p>';
                    return;
                }

                snapshot.docs.forEach(docSnap => {
                    const data = docSnap.data();
                    const requestId = docSnap.id;
                    requestCards += `
                        <div class="p-3 bg-blue-50 rounded-lg border border-blue-200">
                            <p class="font-semibold text-gray-800">${data.requesterEmail}</p>
                            <p class="text-xs text-gray-500 mb-2">Requested on: ${new Date(data.timestamp).toLocaleDateString()}</p>
                            <div class="flex space-x-2">
                                <button onclick="handleCoTeacherRequest('${requestId}', 'accept')" 
                                        class="bg-green-500 text-white text-xs py-1 px-2 rounded-lg hover:bg-green-600">Accept</button>
                                <button onclick="handleCoTeacherRequest('${requestId}', 'deny')" 
                                        class="bg-red-500 text-white text-xs py-1 px-2 rounded-lg hover:bg-red-600">Deny</button>
                            </div>
                        </div>
                    `;
                });
                ui.coteacherRequestsList.innerHTML = requestCards;

            }, (error) => console.error("Error listening to co-teacher requests:", error));
        }

        // --- Roster Rendering ---

        function renderRoster(studentEmails, coteacherEmails) {
            
            // Co-Teachers
            ui.coteacherCount.textContent = coteacherEmails.length;
            if (coteacherEmails.length === 0) {
                ui.coteachersList.innerHTML = '<p class="text-gray-500 text-sm">No co-teachers assigned.</p>';
            } else {
                ui.coteachersList.innerHTML = coteacherEmails.map(email => 
                    `<p class="text-sm p-1 bg-gray-50 rounded-md flex justify-between items-center">${email} <span class="text-indigo-600 font-medium text-xs">CO-TEACHER</span></p>`
                ).join('');
            }

            // Students
            ui.studentCount.textContent = studentEmails.length;
            if (studentEmails.length === 0) {
                ui.studentsList.innerHTML = '<p class="text-gray-500 text-sm">No students in roster.</p>';
            } else {
                ui.studentsList.innerHTML = studentEmails.map(email => 
                    `<p class="text-sm p-1 bg-gray-50 rounded-md">${email}</p>`
                ).join('');
            }
        }
        
        // --- Google Classroom Import Logic (Updated per Request) ---

        // This function is still hypothetical as it relies on a non-existent local file
        // google_classroom_api.js, but the logic is now focused on email/title.
        async function importFromGoogleClassroom() {
            try {
                // Step 1: Get Access Token (assuming this is handled securely and available)
                const accessToken = await getGoogleClassroomAccessToken(auth);
                if (!accessToken) {
                    console.error("Could not get Google Classroom Access Token.");
                    return;
                }

                // Step 2: Get Classes
                const courses = await getGoogleClassroomClasses(accessToken);
                // Prompt user to select a class (omitted UI for brevity, assuming first class)
                const selectedCourse = courses[0]; 

                if (!selectedCourse) return alert("No classes found in Google Classroom.");
                
                // Step 3: Get Roster (only need emails)
                const roster = await getGoogleClassroomCourseRoster(accessToken, selectedCourse.id);
                
                const studentEmails = roster.students.map(s => s.profile.emailAddress).filter(email => email);
                const classTitle = selectedCourse.name || 'Imported Class';

                // Step 4: Update Firestore with just the title and emails
                const classRef = getClassRef(currentClassId);
                await setDoc(classRef, {
                    title: classTitle,
                    studentEmails: studentEmails, // Pre-add users by email
                    teacherEmail: auth.currentUser.email,
                    isPaused: false,
                    classEndTime: null
                }, { merge: true });

                alert(`Successfully imported class: ${classTitle} with ${studentEmails.length} students (by email).`);

            } catch (e) {
                console.error("Google Classroom Import Failed:", e);
                alert("Google Classroom Import failed. See console for details.");
            }
        }
        
        // Expose handlers to global scope for inline HTML buttons
        window.handleCoTeacherRequest = handleCoTeacherRequest;

        // --- Start App ---
        initFirebase();
    </script>
</body>
</html>
