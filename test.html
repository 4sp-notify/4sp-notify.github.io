<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notify | Dashboard</title>
    <!-- Note: A comprehensive Content-Security-Policy is included for security -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' https://cdn.tailwindcss.com https://www.gstatic.com https://apis.google.com https://accounts.google.com 'unsafe-inline';
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net;
        font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net;
        img-src 'self' data: https://www.gstatic.com https://lh3.googleusercontent.com;
        connect-src 'self' https://firestore.googleapis.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://www.googleapis.com https://classroom.googleapis.com;
        frame-src 'self' https://accounts.google.com;
    ">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css">

    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        .font-poppins { font-family: 'Poppins', sans-serif; }
        
        .app-input { padding: 0.75rem 1rem; border-radius: 0.5rem; border: 1px solid #d1d5db; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; background-color: #f9fafb; }
        .app-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 1px #3b82f6; outline: none; background-color: white; }
        .btn-bubbly { transition: transform 0.1s ease-out; }
        .btn-bubbly:active { transform: scale(0.95); }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px;}
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .main-layout { height: calc(100vh - 4rem); }
        .fade-enter-from, .fade-leave-to { opacity: 0; transform: scale(0.95); }
        .fade-enter-active, .fade-leave-active { transition: opacity 200ms ease-out, transform 200ms ease-out; }
        .class-notification-badge { position: absolute; top: 4px; right: 8px; min-width: 1.5rem; height: 1.5rem; border-radius: 9999px; background-color: #ef4444; color: white; font-size: 0.75rem; font-weight: bold; display: inline-flex; align-items: center; justify-content: center; padding: 0 0.375rem; }
        .tooltip-container { position: relative; display: inline-block; }
        .tooltip-text { visibility: hidden; opacity: 0; width: max-content; background-color: #1f2937; color: #fff; text-align: center; border-radius: 0.375rem; padding: 4px 8px; position: absolute; z-index: 10; bottom: 125%; left: 50%; transform: translateX(-50%); font-size: 0.75rem; font-weight: 500; transition: opacity 0.2s ease-out; pointer-events: none; }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
        .schedule-time-input { width: 100px; text-align: center; font-family: 'Poppins', sans-serif; font-weight: 500; }
        .period-selector { display: flex; margin-left: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.5rem; overflow: hidden; }
        .period-btn { padding: 0.75rem 1rem; border: none; background-color: #f9fafb; color: #6b7280; cursor: pointer; transition: background-color 0.2s, color 0.2s; }
        .period-btn.active { background-color: #3b82f6; color: white; }
    </style>
</head>
<body class="bg-slate-100 h-screen overflow-hidden">

    <div class="flex flex-col h-full">
        <header class="bg-white border-b border-gray-200 shadow-sm sticky top-0 z-30 h-16 flex-shrink-0">
            <div class="max-w-full mx-auto px-6 lg-px-8">
                <div class="flex justify-between items-center h-16">
                    <a href="index.html" class="flex items-center space-x-3">
                        <svg class="w-7 h-7 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg>
                        <h1 class="text-xl font-bold text-gray-800">Notify</h1>
                    </a>
                    <div class="relative">
                        <button id="user-profile-btn" type="button" class="btn-bubbly flex items-center justify-center w-10 h-10 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform duration-150 hover:scale-105">
                             <img id="user-profile-pic" class="w-full h-full rounded-lg object-cover hidden" src="" alt="User profile picture">
                             <div id="user-profile-initial" class="w-full h-full rounded-lg flex items-center justify-center bg-gradient-to-br from-blue-600 to-indigo-700 text-white font-bold text-lg hidden"></div>
                        </button>
                        <div id="user-profile-menu" class="absolute right-0 mt-2 w-72 rounded-xl shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden transition-transform transform origin-top-right" role="menu">
                            <!-- User profile menu content will be injected by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="flex flex-1 main-layout overflow-hidden">
            <aside class="w-72 bg-white border-r border-gray-200 flex flex-col flex-shrink-0">
                <div class="flex-grow p-4 overflow-y-auto custom-scrollbar">
                    <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3 px-2">My Classes</h2>
                    <ul id="class-list" class="space-y-1"></ul>
                    <div id="no-classes-sidebar" class="text-center text-sm text-gray-500 mt-4 hidden"><p>No classes yet.</p></div>
                </div>
                <div id="sidebar-actions" class="p-4 border-t border-gray-200 space-y-2">
                    <button id="new-class-btn" class="hidden w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center space-x-2 btn-bubbly"><i class="fa-solid fa-plus w-5 h-5"></i><span>New Class</span></button>
                    <button id="join-class-btn-main" class="w-full bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center space-x-2 btn-bubbly"><i class="fa-solid fa-user-plus w-5 h-5"></i><span>Join Class</span></button>
                </div>
            </aside>
            <main class="flex-1 flex flex-col overflow-hidden">
                <div id="main-content-area" class="flex-1 overflow-y-auto bg-slate-100 p-6 sm:p-8 custom-scrollbar"></div>
            </main>
        </div>
    </div>
    
    <div id="modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-60 z-40 hidden"></div>
    <div id="modal-container" class="fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, onSnapshot, updateDoc, arrayUnion, addDoc, serverTimestamp, arrayRemove, deleteDoc, writeBatch, getDocs, FieldPath } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        
        // IMPORTANT: Replace this placeholder with your actual Firebase project configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // --- State Management ---
        let currentUser = null, userData = null, currentClassId = null, currentRoster = null;
        let allLoadedClasses = {}, classQueues = {}, coTeacherRequests = {};
        let unsubscribes = [], queueUnsubscribers = {}, requestUnsubscribers = {};
        let currentClassView = 'overview';

        // --- DOM Elements ---
        const mainContentArea = document.getElementById('main-content-area');
        const classListEl = document.getElementById('class-list');
        const modalContainer = document.getElementById('modal-container');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const userProfileMenu = document.getElementById('user-profile-menu');

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Utility Functions ---
        function escapeHtml(text) {
            if (typeof text !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showModal(html) {
            modalContainer.innerHTML = html;
            modalBackdrop.classList.remove('hidden');
            const modalDialog = modalContainer.firstElementChild;
            if (modalDialog) {
                modalDialog.classList.add('fade-enter-from');
                setTimeout(() => modalDialog.classList.remove('fade-enter-from'), 10);
            }
        }

        function hideModal() {
            const modalDialog = modalContainer.firstElementChild;
            if (modalDialog) {
                modalDialog.classList.add('fade-leave-to');
                modalBackdrop.classList.add('fade-leave-to');
                setTimeout(() => {
                    modalContainer.innerHTML = '';
                    modalBackdrop.classList.add('hidden');
                    modalBackdrop.classList.remove('fade-leave-to');
                }, 200);
            }
        }
        
        // --- Authentication ---
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                fetchUserData(user.uid);
            } else {
                window.location.href = 'login.html';
            }
        });

        async function fetchUserData(uid) {
            const userDoc = await getDoc(doc(db, 'users', uid));
            if (userDoc.exists()) {
                userData = { uid, ...userDoc.data() };
                updateProfileUI(currentUser, userData);
                listenForClasses(uid);
                renderMainContent();
            } else {
                signOut(auth);
            }
        }
        
        // --- Core Data Listening ---
        function listenForClasses(uid) {
            unsubscribes.forEach(unsub => unsub());
            Object.values(queueUnsubscribers).forEach(unsub => unsub());
            Object.values(requestUnsubscribers).forEach(unsub => unsub());
            unsubscribes = [];
            queueUnsubscribers = {};
            requestUnsubscribers = {};
            allLoadedClasses = {};

            const processSnapshot = (snapshot) => {
                snapshot.docChanges().forEach(change => {
                    const classId = change.doc.id;
                    const classData = { id: classId, ...change.doc.data() };
                    
                    if (change.type === 'removed') {
                        delete allLoadedClasses[classId];
                        if (queueUnsubscribers[classId]) { queueUnsubscribers[classId](); delete queueUnsubscribers[classId]; }
                        if (requestUnsubscribers[classId]) { requestUnsubscribers[classId](); delete requestUnsubscribers[classId]; }
                    } else {
                        allLoadedClasses[classId] = classData;
                        const isTeacher = classData.teacherId === uid || (classData.teacherIds || []).includes(uid);
                        if (isTeacher) {
                            if (!queueUnsubscribers[classId]) {
                                const q = query(collection(db, 'classes', classId, 'raisedHands'));
                                queueUnsubscribers[classId] = onSnapshot(q, qSnap => {
                                    classQueues[classId] = qSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                                    updateGlobalUI();
                                    if(currentClassId === classId) renderMainContent();
                                });
                            }
                            if (!requestUnsubscribers[classId] && classData.teacherId === uid) {
                                const reqQuery = query(collection(db, 'classes', classId, 'coTeacherRequests'), where('status', '==', 'pending'));
                                requestUnsubscribers[classId] = onSnapshot(reqQuery, reqSnap => {
                                    coTeacherRequests[classId] = reqSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                                    updateGlobalUI();
                                    if(currentClassId === classId) renderMainContent();
                                });
                            }
                        }
                    }
                });
                updateGlobalUI();
            };

            const q1 = query(collection(db, 'classes'), where('teacherId', '==', uid));
            const q2 = query(collection(db, 'classes'), where('studentIds', 'array-contains', uid));
            const q3 = query(collection(db, 'classes'), where('teacherIds', 'array-contains', uid));
            
            unsubscribes.push(onSnapshot(q1, processSnapshot));
            unsubscribes.push(onSnapshot(q2, processSnapshot));
            unsubscribes.push(onSnapshot(q3, processSnapshot));
        }

        async function selectClass(id) {
            currentClassId = id;
            currentClassView = 'overview';
            currentRoster = null;
            if (id) {
                await fetchRosterData(allLoadedClasses[id]);
                checkAndClearHandsOnSchedule(allLoadedClasses[id], classQueues[id] || []);
            }
            renderMainContent();
            updateGlobalUI();
        }

        function checkAndClearHandsOnSchedule(cls, queue) {
            if (!cls || !cls.schedule?.disableAt || queue.length === 0) return;
            
            const now = new Date();
            const [hour, minute] = cls.schedule.disableAt.split(':');
            const disableTimeToday = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hour, minute, 0);

            if (now > disableTimeToday) {
                const clearedKey = `cleared_${cls.id}_${now.toISOString().split('T')[0]}`;
                if (!sessionStorage.getItem(clearedKey)) {
                    lowerAllHands(cls.id);
                    sessionStorage.setItem(clearedKey, 'true');
                }
            }
        }

        async function fetchRosterData(data) {
            if (!data) return;
            const ids = [data.teacherId, ...(data.teacherIds || []), ...(data.studentIds || [])].filter(Boolean);
            if (ids.length === 0) { 
                currentRoster = { owner: {}, coTeachers: [], students: [] }; 
                return; 
            }
            
            const users = {};
            for (let i = 0; i < ids.length; i += 10) {
                const batchIds = ids.slice(i, i + 10);
                const q = query(collection(db, 'users'), where(FieldPath.documentId(), 'in', batchIds));
                const userDocs = await getDocs(q);
                userDocs.forEach(doc => { users[doc.id] = doc.data(); });
            }

            currentRoster = {
                owner: { id: data.teacherId, ...(users[data.teacherId] || {}) },
                coTeachers: (data.teacherIds || []).map(id => ({ id, ...(users[id] || {}) })),
                students: (data.studentIds || []).map(id => ({ id, ...(users[id] || {}) }))
            };
        }

        // --- Action Functions ---
        const generateCode = () => Math.random().toString(36).substring(2, 10).toUpperCase();

        async function createNewClass(name) {
            await addDoc(collection(db, 'classes'), {
                name, teacherId: currentUser.uid, teacherIds: [], studentIds: [],
                studentInviteCode: generateCode(), teacherInviteCode: generateCode(),
                handRaisingEnabled: true, schedule: { enableAt: '', disableAt: '' },
                createdAt: serverTimestamp()
            });
            hideModal();
        }

        async function joinClass(code) {
            const qStudent = query(collection(db, 'classes'), where('studentInviteCode', '==', code));
            const qTeacher = query(collection(db, 'classes'), where('teacherInviteCode', '==', code));
            const [studentSnap, teacherSnap] = await Promise.all([getDocs(qStudent), getDocs(qTeacher)]);
            const classDoc = studentSnap.docs[0] || teacherSnap.docs[0];

            if (!classDoc) {
                showModal(TPL.messageModal('Error', 'Invalid class code.', 'red'));
                return;
            }

            const classId = classDoc.id;
            const classData = classDoc.data();
            const isMember = (classData.studentIds || []).includes(currentUser.uid) || (classData.teacherIds || []).includes(currentUser.uid) || classData.teacherId === currentUser.uid;

            if (isMember) {
                showModal(TPL.messageModal('Already Enrolled', `You are already a member of ${classData.name}.`, 'yellow'));
                return;
            }

            if (!studentSnap.empty) {
                await updateDoc(doc(db, 'classes', classId), { studentIds: arrayUnion(currentUser.uid) });
                hideModal();
                showModal(TPL.messageModal('Success', `Successfully joined class: ${classData.name}!`, 'green'));
            } else if (!teacherSnap.empty) {
                if (userData.role !== 'teacher') {
                    showModal(TPL.messageModal('Role Mismatch', 'This is a co-teacher invite, but you have a student account.', 'red'));
                    return;
                }
                await addDoc(collection(db, 'classes', classId, 'coTeacherRequests'), {
                    requesterId: currentUser.uid, requesterName: userData.username, requesterEmail: currentUser.email,
                    status: 'pending', createdAt: serverTimestamp()
                });
                hideModal();
                showModal(TPL.messageModal('Request Sent', `Your request to co-teach ${classData.name} has been sent.`, 'blue'));
            }
        }
        
        async function handleSaveSchedule(id, enable, disable) {
             await updateDoc(doc(db, 'classes', id), { schedule: { enableAt: enable, disableAt: disable } });
             showModal(TPL.messageModal('Success', 'Schedule saved!', 'green'));
        }

        async function raiseHand(id, q) { await addDoc(collection(db, 'classes', id, 'raisedHands'), { studentId: currentUser.uid, studentName: userData.username, studentPhotoURL: currentUser.photoURL || '', question: q || '', raisedAt: serverTimestamp() }); hideModal(); }
        async function lowerHand(id, studentId) { const handQuery = query(collection(db, 'classes', id, 'raisedHands'), where('studentId', '==', studentId)); const handDocs = await getDocs(handQuery); const batch = writeBatch(db); handDocs.forEach(d => batch.delete(d.ref)); await batch.commit(); }
        async function lowerAllHands(id) { const handsCollection = collection(db, 'classes', id, 'raisedHands'); const snapshot = await getDocs(handsCollection); const batch = writeBatch(db); snapshot.docs.forEach(d => batch.delete(d.ref)); await batch.commit(); }
        async function toggleHandRaising(id, status) { await updateDoc(doc(db, 'classes', id), { handRaisingEnabled: status }); }
        async function resetInviteCode(id, type) { const field = type === 'student' ? 'studentInviteCode' : 'teacherInviteCode'; await updateDoc(doc(db, 'classes', id), { [field]: generateCode() }); }
        async function respondToCoTeacherRequest(classId, requestId, response) { const requestRef = doc(db, 'classes', classId, 'coTeacherRequests', requestId); await updateDoc(requestRef, { status: response }); if (response === 'approved') { const requestDoc = await getDoc(requestRef); const requesterId = requestDoc.data().requesterId; await updateDoc(doc(db, 'classes', classId), { teacherIds: arrayUnion(requesterId) }); } }
        async function deleteSchedule(id) { await updateDoc(doc(db, 'classes', id), { 'schedule.enableAt': '', 'schedule.disableAt': '' }); }
        async function removeUserFromClass(id, userId) { const data = allLoadedClasses[id]; if ((data.teacherIds || []).includes(userId)) { await updateDoc(doc(db, 'classes', id), { teacherIds: arrayRemove(userId) }); } else if ((data.studentIds || []).includes(userId)) { await updateDoc(doc(db, 'classes', id), { studentIds: arrayRemove(userId) }); } await fetchRosterData(allLoadedClasses[id]); renderMainContent(); }
        async function handleDeleteClass(id) { const batch = writeBatch(db); const handsSnapshot = await getDocs(collection(db, 'classes', id, 'raisedHands')); handsSnapshot.docs.forEach(d => batch.delete(d.ref)); const requestsSnapshot = await getDocs(collection(db, 'classes', id, 'coTeacherRequests')); requestsSnapshot.docs.forEach(d => batch.delete(d.ref)); batch.delete(doc(db, 'classes', id)); await batch.commit(); hideModal(); selectClass(null); }
        async function importGoogleClass(googleCourseId, googleCourseName) { /* Your Google Classroom import logic here */ }
        
        // --- UI Rendering ---

        function updateProfileUI(user, data) {
            document.querySelectorAll('#user-profile-pic, #user-profile-pic-menu').forEach(el => {
                if(user.photoURL) { el.src = user.photoURL; el.classList.remove('hidden'); } else {el.classList.add('hidden');}
            });
            document.querySelectorAll('#user-profile-initial, #user-profile-initial-menu').forEach(el => {
                if(!user.photoURL) { el.textContent = data.username.charAt(0).toUpperCase(); el.classList.remove('hidden'); } else {el.classList.add('hidden');}
            });
            userProfileMenu.innerHTML = TPL.userProfileMenu(user, data);
            document.getElementById('new-class-btn').classList.toggle('hidden', data.role !== 'teacher');
        }
        
        function updateGlobalUI() {
            let totalNotifications = 0;
            if (userData) {
                for (const id in allLoadedClasses) {
                    const cls = allLoadedClasses[id];
                    if (cls.teacherId === userData.uid || (cls.teacherIds || []).includes(userData.uid)) {
                        totalNotifications += (classQueues[id] || []).length;
                        if (cls.teacherId === userData.uid) {
                             totalNotifications += (coTeacherRequests[id] || []).length;
                        }
                    }
                }
            }
            document.title = totalNotifications > 0 ? `(${totalNotifications}) Notify | Dashboard` : 'Notify | Dashboard';
            renderClassList(Object.values(allLoadedClasses));
        }

        function renderClassList(classes) {
            document.getElementById('no-classes-sidebar').classList.toggle('hidden', classes.length > 0);
            classListEl.innerHTML = '';
            classes.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0)).forEach(cls => {
                const li = document.createElement('li');
                const isActive = currentClassId === cls.id;
                let notificationCount = 0;
                if(userData && (cls.teacherId === userData.uid || (cls.teacherIds || []).includes(userData.uid))) {
                    notificationCount += (classQueues[cls.id] || []).length;
                    if(cls.teacherId === userData.uid) {
                        notificationCount += (coTeacherRequests[cls.id] || []).length;
                    }
                }
                const badge = notificationCount > 0 ? `<span class="class-notification-badge">${notificationCount}</span>` : '';
                li.innerHTML = `<button data-class-id="${cls.id}" class="w-full text-left px-3 py-2.5 rounded-md font-medium text-sm transition-colors btn-bubbly relative flex justify-between items-center ${isActive ? 'bg-blue-100 text-blue-800 font-semibold' : 'text-gray-700 hover:bg-slate-100'}"><span>${escapeHtml(cls.name)}</span>${badge}</button>`;
                classListEl.appendChild(li);
            });
        }

        function renderMainContent() {
            if (currentClassId && allLoadedClasses[currentClassId]) {
                const cls = allLoadedClasses[currentClassId];
                const queue = classQueues[currentClassId] || [];
                const requests = coTeacherRequests[currentClassId] || [];
                const isOwner = cls.teacherId === userData.uid;
                const isCoTeacher = (cls.teacherIds || []).includes(userData.uid);
                const isTeacher = isOwner || isCoTeacher;
                mainContentArea.innerHTML = TPL.classView(cls, userData, isTeacher, isOwner, queue, requests, currentClassView, currentRoster);
            } else {
                mainContentArea.innerHTML = TPL.emptyState(userData);
            }
        }

        // --- Template Object ---
        const TPL = {
            userProfileMenu: (user, data) => `
                <div class="p-4 bg-gray-50 border-b border-gray-100 rounded-t-xl">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            ${user.photoURL ? `<img id="user-profile-pic-menu" class="h-12 w-12 rounded-full object-cover" src="${user.photoURL}" alt="">` : `<div id="user-profile-initial-menu" class="h-12 w-12 rounded-full flex items-center justify-center bg-gradient-to-br from-blue-600 to-indigo-700 text-white font-bold text-xl">${data.username.charAt(0).toUpperCase()}</div>`}
                        </div>
                        <div class="ml-3 min-w-0">
                            <p class="text-lg font-bold font-poppins text-gray-800 truncate">${escapeHtml(data.username)}</p>
                            <p class="text-sm text-gray-500 truncate">${escapeHtml(user.email)}</p>
                        </div>
                    </div>
                </div>
                <div class="py-1" role="none">
                    <a href="settings.html" class="font-medium text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100 flex items-center" role="menuitem"><i class="fa-solid fa-sliders w-5 h-5 mr-3 text-gray-400"></i>Settings</a>
                    <button id="logout-btn" class="w-full text-left font-medium text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100 flex items-center" role="menuitem"><i class="fa-solid fa-right-from-bracket w-5 h-5 mr-3 text-gray-400"></i>Logout</button>
                </div>`,
            emptyState: (user) => `<div class="h-full flex items-center justify-center text-center fade-enter-active"><div class="max-w-md"><svg class="w-12 h-12 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg><h2 class="mt-4 text-xl font-semibold font-poppins text-gray-700">Welcome, ${escapeHtml(user?.username||'')}!</h2><p class="mt-1 text-gray-500">Select a class from the sidebar or create/join a new one to get started.</p></div></div>`,
            messageModal: (title, message, color = 'blue') => { const c = {'blue':{i:'fa-circle-info',b:'bg-blue-600',t:'text-blue-700'},'green':{i:'fa-circle-check',b:'bg-green-600',t:'text-green-700'},'red':{i:'fa-triangle-exclamation',b:'bg-red-600',t:'text-red-700'},'yellow':{i:'fa-exclamation-triangle',b:'bg-yellow-600',t:'text-yellow-700'}}[color]||c['blue']; return `<div class="relative bg-white w-full max-w-sm p-6 rounded-xl shadow-xl pointer-events-auto text-center"><div class="flex flex-col items-center justify-center"><i class="fa-solid ${c.i} fa-3x ${c.t}"></i><h3 class="mt-4 text-xl font-bold text-gray-800 font-poppins">${escapeHtml(title)}</h3><p class="mt-2 text-gray-600">${escapeHtml(message)}</p></div><div class="mt-6"><button type="button" class="modal-close-btn px-6 py-2 ${c.b} text-white rounded-lg hover:opacity-90 transition-opacity btn-bubbly">OK</button></div></div>`; },
            createClassModal: () => `<div class="relative bg-white w-full max-w-md p-6 rounded-xl shadow-xl pointer-events-auto"><h3 class="text-xl font-semibold font-poppins text-gray-800">Create New Class</h3><form id="create-class-form" class="mt-4 space-y-4"><div><label for="new-class-name" class="block text-sm font-medium text-gray-700">Class Name</label><input type="text" id="new-class-name" required class="mt-1 block w-full app-input" placeholder="e.g., Period 3 Biology"></div><div class="flex justify-end space-x-3"><button type="button" class="modal-cancel-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 btn-bubbly">Cancel</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 btn-bubbly">Create</button></div></form></div>`,
            joinClassModal: () => `<div class="relative bg-white w-full max-w-md p-6 rounded-xl shadow-xl pointer-events-auto"><div class="text-center"><i class="fa-solid fa-link fa-3x text-green-600 mb-4"></i><h3 class="text-2xl font-bold text-gray-800 font-poppins">Join a Class</h3><p class="text-gray-500 mt-2">Enter the class code to join.</p></div><form id="join-class-form" class="mt-6 space-y-6"><div><label for="class-code-input" class="block text-sm font-medium text-gray-700 text-left mb-1">Class Code</label><input type="text" id="class-code-input" required class="block w-full app-input text-center font-bold tracking-widest uppercase text-lg" placeholder="e.g., ABC12345"></div><div class="flex justify-end space-x-3"><button type="button" class="modal-cancel-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 btn-bubbly">Cancel</button><button type="submit" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 btn-bubbly">Join Class</button></div></form></div>`,
            raiseHandModal: (id) => `<div class="relative bg-white w-full max-w-md p-6 rounded-xl shadow-xl pointer-events-auto"><h3 class="text-xl font-semibold font-poppins text-gray-800">Raise Your Hand</h3><form id="raise-hand-form" data-class-id="${id}" class="mt-4 space-y-4"><div><label for="hand-raise-question" class="block text-sm font-medium text-gray-700">Ask a question (optional)</label><textarea id="hand-raise-question" rows="3" class="mt-1 block w-full app-input" placeholder="Type your question here..."></textarea></div><div class="flex justify-end space-x-3"><button type="button" class="modal-cancel-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 btn-bubbly">Cancel</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 btn-bubbly">Confirm</button></div></form></div>`,
            deleteClassConfirmModal: (id, name) => `<div class="relative bg-white w-full max-w-md p-6 rounded-xl shadow-xl pointer-events-auto"><div class="text-center"><i class="fa-solid fa-triangle-exclamation fa-3x text-red-500 mb-4"></i><h3 class="text-xl font-semibold font-poppins text-gray-800">Delete Class</h3></div><p class="mt-4 text-gray-600 text-center">Are you sure you want to permanently delete <strong>${escapeHtml(name)}</strong>? This action cannot be undone.</p><div class="mt-6 flex justify-end space-x-3"><button class="modal-cancel-btn px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 btn-bubbly">Cancel</button><button id="confirm-delete-class-btn" data-class-id="${id}" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 btn-bubbly">Delete</button></div></div>`,
            inviteModal: (cls) => {
                const inviteLinkBase = `${window.location.origin}/invite.html?code=`;
                return `<div class="relative bg-white w-full max-w-lg p-6 rounded-xl shadow-xl pointer-events-auto">
                    <h3 class="text-xl font-semibold font-poppins text-gray-800 text-center">Invite Members to ${escapeHtml(cls.name)}</h3>
                    <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <h4 class="font-bold text-gray-700">Invite Students</h4>
                            <p class="text-xs text-gray-500 mt-1">Share this code or link with your students.</p>
                            <div class="mt-3 flex items-center space-x-2 bg-white p-2 rounded-md border">
                                <input type="text" readonly value="${inviteLinkBase}${cls.studentInviteCode}" class="text-sm w-full outline-none bg-transparent">
                                <button data-link="${inviteLinkBase}${cls.studentInviteCode}" class="copy-invite-link-btn flex-shrink-0 px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-xs font-semibold">Copy</button>
                            </div>
                            <button data-type="student" class="reset-invite-code-btn text-xs text-blue-600 hover:underline mt-2">Reset student code</button>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-lg">
                            <h4 class="font-bold text-gray-700">Invite Co-Teachers</h4>
                            <p class="text-xs text-gray-500 mt-1">Share with other teachers to co-manage.</p>
                             <div class="mt-3 flex items-center space-x-2 bg-white p-2 rounded-md border">
                                <input type="text" readonly value="${inviteLinkBase}${cls.teacherInviteCode}" class="text-sm w-full outline-none bg-transparent">
                                <button data-link="${inviteLinkBase}${cls.teacherInviteCode}" class="copy-invite-link-btn flex-shrink-0 px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded text-xs font-semibold">Copy</button>
                            </div>
                            <button data-type="teacher" class="reset-invite-code-btn text-xs text-blue-600 hover:underline mt-2">Reset teacher code</button>
                        </div>
                    </div>
                    <div class="mt-6 text-center"><button class="modal-close-btn text-sm text-gray-600 hover:text-gray-800">Close</button></div>
                </div>`;
            },
            classView: (cls, user, isTeacher, isOwner, queue, requests, view, roster) => {
                const timePicker = (id, label, value) => {
                    const [h24, m] = (value || '08:00').split(':').map(Number);
                    const period = h24 >= 12 ? 'PM' : 'AM';
                    let h12 = h24 % 12; if (h12 === 0) h12 = 12;
                    const timeString = `${String(h12).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                    return `<div><label class="block text-sm font-medium text-gray-600 mb-2">${label}</label><div class="flex items-center"><input type="text" id="${id}" value="${timeString}" class="app-input schedule-time-input"><div id="${id.replace('-input', '-period-selector')}" class="period-selector"><button type="button" data-value="AM" class="period-btn ${period === 'AM' ? 'active' : ''}">AM</button><button type="button" data-value="PM" class="period-btn ${period === 'PM' ? 'active' : ''}">PM</button></div></div></div>`;
                };
                
                const studentView = `<div class="fade-enter-active space-y-6"><div class="bg-white p-5 rounded-xl shadow-sm border"><h2 class="text-2xl font-bold font-poppins text-gray-800">${escapeHtml(cls.name)}</h2></div><div class="bg-white p-8 rounded-xl shadow-sm border text-center">${(()=>{const myHand=queue.find(h=>h.studentId===user.uid);const myQueuePosition=queue.findIndex(h=>h.studentId===user.uid)+1;if(!cls.handRaisingEnabled){return`<i class="fa-solid fa-hand fa-3x text-yellow-500"></i><h3 class="mt-4 text-xl font-bold font-poppins text-gray-700">Hand raising is disabled.</h3>`}else if(myHand){return`<i class="fa-solid fa-hand-back-fist fa-3x text-green-500 animate-pulse"></i><h3 class="mt-4 text-2xl font-bold font-poppins text-gray-800">Your hand is raised!</h3><p class="mt-1 text-lg text-gray-600">You are <span class="font-bold text-blue-600">#${myQueuePosition}</span> in the queue.</p>${myHand.question?`<p class="mt-2 text-gray-500 italic">"${escapeHtml(myHand.question)}"</p>`:''}<div class="mt-6"><button id="lower-hand-action-btn" class="px-8 py-3 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 btn-bubbly"><i class="fa-solid fa-hand-sparkles mr-2"></i> Lower My Hand</button></div>`}else{return`<i class="fa-solid fa-hand-point-up fa-3x text-blue-500"></i><h3 class="mt-4 text-2xl font-bold font-poppins text-gray-800">Have a Question?</h3><div class="mt-6"><button id="raise-hand-action-btn" class="px-8 py-4 bg-blue-600 text-white font-bold text-lg rounded-xl hover:bg-blue-700 btn-bubbly"><i class="fa-solid fa-hand mr-3"></i> Raise My Hand</button></div>`}})()}</div></div>`;
                
                if (!isTeacher) return studentView;

                // Teacher View
                const teacherViewContent = () => {
                    if (view === 'settings') return `
                        <div id="settings-panel" class="space-y-6 fade-enter-active">
                            ${isOwner ? `<div class="bg-white p-6 rounded-2xl shadow-sm border space-y-4">
                                <h3 class="text-xl font-bold text-gray-800 font-poppins">Class Name</h3>
                                <form id="change-class-name-form" class="space-y-2"><div class="flex items-center space-x-3"><input type="text" id="class-name-input" class="app-input flex-grow" value="${escapeHtml(cls.name)}"><button type="submit" class="px-5 py-2.5 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 btn-bubbly">Save</button></div></form>
                            </div>` : ''}
                            <div class="bg-white p-6 rounded-2xl shadow-sm border space-y-4">
                                <h3 class="text-xl font-bold text-gray-800 font-poppins">Scheduling</h3>
                                <div id="schedule-form" class="space-y-4">
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        ${timePicker('enable-time-input', 'Enable hands at', cls.schedule?.enableAt)}
                                        ${timePicker('disable-time-input', 'Disable hands at', cls.schedule?.disableAt)}
                                    </div>
                                    <div class="flex justify-end space-x-2">
                                        <button data-action="clear" class="schedule-action-btn px-4 py-2 bg-red-100 text-red-700 font-semibold rounded-lg hover:bg-red-200 btn-bubbly">Clear</button>
                                        <button data-action="save" class="schedule-action-btn px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 btn-bubbly">Save</button>
                                    </div>
                                </div>
                            </div>
                            ${isOwner ? `<div class="bg-white p-6 rounded-2xl shadow-sm border-2 border-dashed border-red-300">
                                <h4 class="text-lg font-bold text-red-700 font-poppins">Danger Zone</h4>
                                <div class="mt-4 flex justify-between items-center"><p class="text-sm text-gray-600 max-w-md">Permanently delete this class and all its data. This action is irreversible.</p><button id="delete-class-btn" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 btn-bubbly whitespace-nowrap">Delete Class</button></div>
                            </div>` : ''}
                        </div>`;
                    if (view === 'roster') return `
                        <div id="roster-panel" class="space-y-6 fade-enter-active">
                            <div class="bg-white p-6 rounded-2xl shadow-sm border"><h3 class="text-xl font-bold text-gray-800 font-poppins">Class Roster</h3></div>
                            <div class="bg-white p-6 rounded-2xl shadow-sm border">
                                <h4 class="text-lg font-semibold text-gray-800 mb-4 font-poppins">Co-Teachers</h4>
                                <ul class="space-y-3">
                                    <li class="flex items-center justify-between p-2"><div class="flex items-center"><span class="font-semibold text-gray-800">${escapeHtml(roster?.owner?.username || '...')}</span><span class="ml-3 text-xs font-bold uppercase bg-purple-100 text-purple-700 px-2 py-1 rounded-full">Owner</span></div></li>
                                    ${roster?.coTeachers?.map(t => `<li class="flex items-center justify-between p-2 rounded-lg hover:bg-slate-50"><span class="font-semibold text-gray-700">${escapeHtml(t.username)}</span>${isOwner ? `<button data-user-id="${t.id}" class="remove-user-btn text-xs text-red-500 hover:text-red-700 font-semibold">Remove</button>`: ''}</li>`).join('')}
                                </ul>
                            </div>
                            <div class="bg-white p-6 rounded-2xl shadow-sm border">
                                <h4 class="text-lg font-semibold text-gray-800 mb-4 font-poppins">Students (${roster?.students?.length || 0})</h4>
                                <ul class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar pr-2">
                                    ${roster?.students?.length > 0 ? roster.students.map(s => `<li class="flex items-center justify-between p-2 rounded-lg hover:bg-slate-50"><span class="text-gray-700">${escapeHtml(s.username)}</span><button data-user-id="${s.id}" class="remove-user-btn text-xs text-red-500 hover:text-red-700 font-semibold">Remove</button></li>`).join('') : '<p class="text-sm text-gray-500 p-2">No students have joined yet.</p>'}
                                </ul>
                            </div>
                        </div>`;
                    // Default to overview
                    return `
                        <div id="overview-panel" class="space-y-6 fade-enter-active">
                            ${(isOwner && requests.length > 0) ? `<div class="bg-white p-6 rounded-2xl shadow-sm border border-yellow-300"><h3 class="text-xl font-bold text-gray-800 font-poppins flex items-center"><i class="fa-solid fa-user-plus mr-3 text-yellow-500"></i>Co-Teacher Requests <span class="ml-3 bg-yellow-100 text-yellow-800 text-sm font-semibold px-3 py-1 rounded-full">${requests.length}</span></h3><ul class="mt-4 space-y-3">${requests.map(req => `<li class="bg-slate-50 p-4 rounded-lg flex items-center justify-between"><div class="flex-grow"><p class="font-semibold text-gray-800">${escapeHtml(req.requesterName)}</p><p class="text-sm text-gray-500">${escapeHtml(req.requesterEmail)}</p></div><div class="flex space-x-2"><button data-request-id="${req.id}" data-response="denied" class="respond-request-btn px-3 py-1.5 bg-red-100 text-red-700 text-sm font-semibold rounded-lg hover:bg-red-200 btn-bubbly">Deny</button><button data-request-id="${req.id}" data-response="approved" class="respond-request-btn px-3 py-1.5 bg-green-100 text-green-700 text-sm font-semibold rounded-lg hover:bg-green-200 btn-bubbly">Approve</button></div></li>`).join('')}</ul></div>` : ''}
                            <div class="bg-white p-6 rounded-2xl shadow-sm border"><h3 class="text-xl font-bold text-gray-800 font-poppins flex items-center"><i class="fa-solid fa-stream mr-3 text-blue-500"></i>Raised Hands Queue <span class="ml-3 bg-blue-100 text-blue-800 text-sm font-semibold px-3 py-1 rounded-full">${queue.length}</span></h3><div id="hand-raise-queue" class="mt-5">${queue.length>0?`<ul class="space-y-3">${queue.map((hand, index) => `<li class="bg-slate-50 p-4 rounded-lg flex items-start justify-between"><div class="flex items-start flex-grow"><div class="text-xl font-bold font-poppins text-blue-600 w-8 text-center pt-0.5">${index+1}</div><div class="ml-4"><p class="font-semibold text-gray-800">${escapeHtml(hand.studentName)}</p>${hand.question?`<p class="text-sm text-gray-600 mt-1.5 italic">"${escapeHtml(hand.question)}"</p>`:''}<p class="text-xs text-gray-400 mt-2.5">Raised at: ${new Date(hand.raisedAt?.toDate()).toLocaleTimeString()}</p></div></div><button data-student-id="${hand.studentId}" class="teacher-lower-hand-btn px-3 py-1.5 bg-slate-200 text-gray-700 text-sm font-semibold rounded-lg hover:bg-red-100 hover:text-red-700 btn-bubbly"><i class="fa-solid fa-hand-sparkles mr-2"></i> Lower</button></li>`).join('')}</ul>`:`<div class="text-center py-16"><i class="fa-solid fa-person-rays fa-3x text-slate-300"></i><p class="mt-4 text-gray-500">The queue is empty.</p></div>`}</div></div>
                        </div>`;
                };
                
                return `<div class="space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border">
                        <div class="flex flex-wrap justify-between items-center gap-4">
                            <h2 class="text-3xl font-bold text-gray-800 font-poppins">${escapeHtml(cls.name)}</h2>
                            <div class="flex items-center space-x-2">
                                <button id="invite-btn" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 btn-bubbly text-sm"><i class="fa-solid fa-user-plus mr-2"></i>Invite</button>
                                <div class="tooltip-container"><button id="toggle-hand-raising-btn" class="w-10 h-10 rounded-lg btn-bubbly flex items-center justify-center ${cls.handRaisingEnabled ?'bg-yellow-100 text-yellow-600 hover:bg-yellow-200':'bg-gray-200 text-gray-600 hover:bg-gray-300'}"><i class="fa-solid ${cls.handRaisingEnabled ?'fa-hand':'fa-hand-sparkles'}"></i></button><span class="tooltip-text">${cls.handRaisingEnabled ?'Pause Raising':'Resume Raising'}</span></div>
                                <div class="tooltip-container"><button id="lower-all-hands-btn" class="w-10 h-10 rounded-lg btn-bubbly flex items-center justify-center bg-red-100 text-red-600 hover:bg-red-200"><i class="fa-solid fa-hands-clapping"></i></button><span class="tooltip-text">Lower All Hands</span></div>
                                <div class="tooltip-container"><button data-view="roster" class="class-view-tab w-10 h-10 rounded-lg btn-bubbly flex items-center justify-center ${view === 'roster' ? 'bg-blue-100 text-blue-600' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}"><i class="fa-solid fa-users"></i></button><span class="tooltip-text">Roster</span></div>
                                <div class="tooltip-container"><button data-view="settings" class="class-view-tab w-10 h-10 rounded-lg btn-bubbly flex items-center justify-center ${view === 'settings' ? 'bg-blue-100 text-blue-600' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}"><i class="fa-solid fa-gear"></i></button><span class="tooltip-text">Settings</span></div>
                                ${view !== 'overview' ? `<div class="tooltip-container"><button data-view="overview" class="class-view-tab w-10 h-10 rounded-lg btn-bubbly flex items-center justify-center bg-gray-200 text-gray-600 hover:bg-gray-300"><i class="fa-solid fa-home"></i></button><span class="tooltip-text">Back to Overview</span></div>` : ''}
                            </div>
                        </div>
                    </div>
                    <div id="teacher-view-content">${teacherViewContent()}</div>
                </div>`;
            }
        };
        
        // --- Event Listeners ---
        document.body.addEventListener('click', async e => {
            const target = e.target.closest('button, a, [role="button"]');
            if (!target) { // Close profile menu if click is outside
                 if (!e.target.closest('#user-profile-menu') && !userProfileMenu.classList.contains('hidden')) {
                    userProfileMenu.classList.add('hidden');
                }
                return;
            };

            // Profile Menu
            if (target.id === 'user-profile-btn') userProfileMenu.classList.toggle('hidden');
            else if (!target.closest('#user-profile-menu')) userProfileMenu.classList.add('hidden');
            if(target.id === 'logout-btn') signOut(auth);
            
            // Sidebar & Modals
            if (target.closest('#class-list button')) selectClass(target.closest('#class-list button').dataset.classId);
            if(target.id === 'new-class-btn') showModal(TPL.createClassModal());
            if(target.id === 'join-class-btn-main') showModal(TPL.joinClassModal());
            if(target.classList.contains('modal-cancel-btn') || e.target.id === 'modal-backdrop' || target.classList.contains('modal-close-btn')) hideModal();
            
            // Class Actions
            if (!currentClassId && !['join-class-btn-main', 'new-class-btn'].includes(target.id)) return;

            if (target.id === 'raise-hand-action-btn') showModal(TPL.raiseHandModal(currentClassId));
            if (target.id === 'lower-hand-action-btn') lowerHand(currentClassId, currentUser.uid);
            if (target.matches('.teacher-lower-hand-btn')) lowerHand(currentClassId, target.dataset.studentId);
            if (target.id === 'lower-all-hands-btn') lowerAllHands(currentClassId);
            if (target.id === 'toggle-hand-raising-btn') toggleHandRaising(currentClassId, !allLoadedClasses[currentClassId].handRaisingEnabled);
            if (target.id === 'delete-class-btn') showModal(TPL.deleteClassConfirmModal(currentClassId, allLoadedClasses[currentClassId].name));
            if (target.id === 'confirm-delete-class-btn') handleDeleteClass(target.dataset.classId);
            if (target.id === 'invite-btn') showModal(TPL.inviteModal(allLoadedClasses[currentClassId]));
            if (target.matches('.reset-invite-code-btn')) resetInviteCode(currentClassId, target.dataset.type);
            if (target.matches('.copy-invite-link-btn')) { navigator.clipboard.writeText(target.dataset.link).then(() => { target.textContent = 'Copied!'; setTimeout(() => target.textContent = 'Copy', 2000); }); }
            if (target.matches('.remove-user-btn')) removeUserFromClass(currentClassId, target.dataset.userId);
            if (target.matches('.class-view-tab')) { currentClassView = target.dataset.view; renderMainContent(); }
            if (target.matches('.respond-request-btn')) respondToCoTeacherRequest(currentClassId, target.dataset.requestId, target.dataset.response);
            if (target.matches('.schedule-action-btn')) {
                if (target.dataset.action === 'save') {
                    const formatTime = (time, period) => { let [h, m] = time.split(':').map(Number); if (period === 'PM' && h !== 12) h += 12; if (period === 'AM' && h === 12) h = 0; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`; };
                    const enableTime = document.getElementById('enable-time-input').value; const enablePeriod = document.querySelector('#enable-time-input-period-selector .active').dataset.value;
                    const disableTime = document.getElementById('disable-time-input').value; const disablePeriod = document.querySelector('#disable-time-input-period-selector .active').dataset.value;
                    handleSaveSchedule(currentClassId, formatTime(enableTime, enablePeriod), formatTime(disableTime, disablePeriod));
                } else if (target.dataset.action === 'clear') { deleteSchedule(currentClassId); }
            }
            if(target.matches('.period-btn')) {
                const container = target.closest('.period-selector');
                container.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
                target.classList.add('active');
            }
        });

        document.body.addEventListener('submit', async e => {
            e.preventDefault();
            if(e.target.id === 'create-class-form') { const name = e.target.querySelector('#new-class-name').value.trim(); if(name) createNewClass(name); }
            if(e.target.id === 'join-class-form') { const code = e.target.querySelector('#class-code-input').value.trim().toUpperCase(); if(code) joinClass(code); }
            if(e.target.id === 'raise-hand-form') { const q = e.target.querySelector('#hand-raise-question').value.trim(); raiseHand(e.target.dataset.classId, q); }
            if(e.target.id === 'change-class-name-form') { const newName = e.target.querySelector('#class-name-input').value.trim(); if (newName && currentClassId) { await updateDoc(doc(db, 'classes', currentClassId), {name: newName}); showModal(TPL.messageModal('Success', 'Class name updated!', 'green'));} }
        });
    </script>
</body>
</html>

